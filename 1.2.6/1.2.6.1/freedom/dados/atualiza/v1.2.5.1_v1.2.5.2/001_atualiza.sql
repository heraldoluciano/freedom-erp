/* Server Version: LI-V6.3.4.4910 Firebird 1.5.  ODS Version: 10.1. */
SET NAMES NONE;

SET SQL DIALECT 3;

--CONNECT 'localhost:/opt/firebird/dados/desenv/freedom1.2.5.1.fdb' USER 'SYSDBA' PASSWORD '123654';

SET AUTODDL ON;

/* Alter UDF(Drop/Declare) */
/* Empty dependent procedure body before Function Alter (Drop/Create) */
/* AssignEmptyBody proc */
SET TERM ^ ;

ALTER PROCEDURE ATADICATENDIMENTOSP(ICODCONV INTEGER,
ICODTIPOATENDO INTEGER,
ICODATEND INTEGER,
ICODSETOR INTEGER,
VOBSATENDO VARCHAR(10000),
ICODEMP INTEGER,
ICODFILIAL INTEGER,
IDOC INTEGER)
 AS
 BEGIN EXIT; END
^

/* Empty dependent procedure body before Function Alter (Drop/Create) */
/* AssignEmptyBody proc */
ALTER PROCEDURE ATATENDIMENTOIUSP(IU CHAR(1),
CODEMP INTEGER,
CODFILIAL SMALLINT,
CODATENDO INTEGER,
CODEMPTO INTEGER,
CODFILIALTO SMALLINT,
CODTPATENDO INTEGER,
CODEMPAE INTEGER,
CODFILIALAE SMALLINT,
CODATEND INTEGER,
CODEMPSA INTEGER,
CODFILIALSA SMALLINT,
CODSETOR INTEGER,
DOCATENDO INTEGER,
DATAATENDO DATE,
DATAATENDOFIN DATE,
HORAATENDO TIME,
HORAATENDOFIN TIME,
OBSATENDO VARCHAR(10000),
CODEMPCL INTEGER,
CODFILIALCL SMALLINT,
CODCLI INTEGER,
CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
CODCONTR INTEGER,
CODITCONTR SMALLINT,
CODEMPIR INTEGER,
CODFILIALIR SMALLINT,
CODREC INTEGER,
NPARCITREC INTEGER,
CODEMPCH INTEGER,
CODFILIALCH SMALLINT,
CODCHAMADO INTEGER,
OBSINTERNO VARCHAR(10000),
CONCLUICHAMADO CHAR(1),
CODEMPEA INTEGER,
CODFILIALEA SMALLINT,
CODESPEC INTEGER,
CODEMPUS INTEGER,
CODFILIALUS SMALLINT,
IDUSU VARCHAR(128),
STATUSATENDO CHAR(2),
CODEMPTA INTEGER,
CODFILIALTA SMALLINT,
CODTAREFA INTEGER)
 AS
 BEGIN EXIT; END
^

/* Empty dependent procedure body before Function Alter (Drop/Create) */
/* AssignEmptyBody proc */
ALTER PROCEDURE SGINICONSP(ICODEMP INTEGER,
CIDUSU CHAR(8),
ICODFILIALSEL SMALLINT,
ICODTERM SMALLINT)
 RETURNS(SRET SMALLINT)
 AS
 BEGIN EXIT; END
^

/* Empty dependent procedure body before Function Alter (Drop/Create) */
/* AssignEmptyBody proc */
ALTER PROCEDURE SGRETINFOUSU(CODEMP INTEGER,
IDUSU VARCHAR(128))
 RETURNS(ANOCCUSU SMALLINT,
CODEMPCCUSU INTEGER,
CODFILIALCCUSU SMALLINT,
CODEMPUSU INTEGER,
CODFILIALUSU SMALLINT,
CODCCUSU CHAR(19),
IDUSUS CHAR(8),
ALMOXARIFE CHAR(1),
APROVARMA CHAR(2))
 AS
 BEGIN EXIT; END
^

/* Empty dependent procedure body before Function Alter (Drop/Create) */
/* AssignEmptyBody proc */
ALTER PROCEDURE ATADICATENDIMENTOCLISP(ICODTIPOATENDO INTEGER,
ICODATEND INTEGER,
ICODSETOR INTEGER,
ICODEMP INTEGER,
ICODFILIAL INTEGER,
IDOC INTEGER,
DATAATENDO DATE,
DATAATENDOFIN DATE,
HORAATENDO TIME,
HORAATENDOFIN TIME,
OBSATENDO VARCHAR(10000),
CODEMPCL INTEGER,
CODFILIALCL SMALLINT,
CODCLI INTEGER,
CODEMPCT INTEGER,
CODFILIALCT INTEGER,
CODCONTR INTEGER,
CODITCONTR INTEGER,
CODREC INTEGER,
NPARCITREC INTEGER,
CODEMPCH INTEGER,
CODFILIALCH SMALLINT,
CODCHAMADO INTEGER,
OBSINTERNO VARCHAR(10000),
CONCLUICHAMADO CHAR(1),
CODEMPEA INTEGER,
CODFILIALEA SMALLINT,
CODESPEC INTEGER)
 AS
 BEGIN EXIT; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER ATCONVENIADOTGAI
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER FNLIBCREDTGBI
 AS Declare variable I integer;
BEGIN I = 0; END
^

SET TERM ; ^

DROP EXTERNAL FUNCTION LOWER;

DECLARE EXTERNAL FUNCTION LOWER
CSTRING(255)
RETURNS CSTRING(255) FREE_IT
ENTRY_POINT 'IB_UDF_lower' MODULE_NAME 'ib_udf';

DROP EXTERNAL FUNCTION LTRIM;

DECLARE EXTERNAL FUNCTION LTRIM
CSTRING(255)
RETURNS CSTRING(255) FREE_IT
ENTRY_POINT 'IB_UDF_ltrim' MODULE_NAME 'ib_udf';

/* drop view for UDF alter */
DROP VIEW VWCUSTOPROJ01;

/* Empty dependent procedure body before Function Alter (Drop/Create) */
/* AssignEmptyBody proc */
SET TERM ^ ;

ALTER PROCEDURE EQRELINVPRODSP(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
CTIPOCUSTO CHAR(1),
ICODEMPGP INTEGER,
SCODFILIALGP SMALLINT,
CCODGRUP CHAR(14),
DDTESTOQ DATE,
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER)
 RETURNS(CODPROD INTEGER,
REFPROD VARCHAR(20),
DESCPROD CHAR(100),
CODGRUP CHAR(14),
SALDO NUMERIC(15,5),
CUSTO NUMERIC(15,5),
VLRESTOQ NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

/* Empty dependent procedure body before Function Alter (Drop/Create) */
/* AssignEmptyBody proc */
ALTER PROCEDURE EQRELPEPSSP(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
DTESTOQ DATE,
ICODEMPMC INTEGER,
SCODFILIALMC SMALLINT,
CCODMARCA CHAR(6),
ICODEMPGP INTEGER,
SCODFILIALGP SMALLINT,
CCODGRUP VARCHAR(14),
CTIPOCUSTO CHAR(1),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER)
 RETURNS(CODPROD INTEGER,
REFPROD VARCHAR(20),
DESCPROD CHAR(100),
SLDPROD NUMERIC(15,5),
CUSTOUNIT NUMERIC(15,5),
CUSTOTOT NUMERIC(15,5),
CODBARPROD CHAR(13),
CODFABPROD CHAR(15),
ATIVOPROD CHAR(1),
CODUNID CHAR(20),
TIPOPROD VARCHAR(2),
CODNCM VARCHAR(10),
EXTIPI CHAR(2),
COD_GEN CHAR(2),
CODSERV CHAR(5),
ALIQ_ICMS NUMERIC(9,2))
 AS
 BEGIN EXIT; END
^

/* Empty dependent procedure body before Function Alter (Drop/Create) */
/* AssignEmptyBody proc */
ALTER PROCEDURE FNSALDOPLANSP(ICODEMPPN INTEGER,
ICODFILIALPN INTEGER,
SCODPLANANT CHAR(13),
DDATAANT DATE,
DVLRANT NUMERIC(15,5),
SCODPLANATU CHAR(13),
DDATAATU DATE,
DVLRATU NUMERIC(15,5))
 RETURNS(SRETORNO CHAR(1))
 AS
 BEGIN EXIT; END
^

/* Empty dependent procedure body before Function Alter (Drop/Create) */
/* AssignEmptyBody proc */
ALTER PROCEDURE PPRELCUSTOSP(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
DTESTOQ DATE,
ICODEMPMC INTEGER,
SCODFILIALMC SMALLINT,
CCODMARCA CHAR(6),
ICODEMPGP INTEGER,
SCODFILIALGP SMALLINT,
CCODGRUP CHAR(14),
CTIPOCUSTO CHAR(1),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER)
 RETURNS(CODPROD INTEGER,
REFPROD VARCHAR(20),
DESCPROD CHAR(100),
TIPOPROD VARCHAR(2),
SLDPROD NUMERIC(15,5),
CUSTOUNIT NUMERIC(15,5),
CUSTOTOT NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

/* Empty dependent procedure body before Function Alter (Drop/Create) */
/* AssignEmptyBody proc */
ALTER PROCEDURE SGGRANTUSERSP AS
 BEGIN EXIT; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER EQGRUPOTGBU
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER EQLOTETGBU
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER EQPRODUTOTGBU
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER FNITPAGARTGBU
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER FNITRECEBERTGBU
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER FNPAGCHEQTGAU
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER FNRECEBERTGAI
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER VDVENDATGBI
 AS Declare variable I integer;
BEGIN I = 0; END
^

SET TERM ; ^

DROP EXTERNAL FUNCTION RTRIM;

DECLARE EXTERNAL FUNCTION RTRIM
CSTRING(255)
RETURNS CSTRING(255) FREE_IT
ENTRY_POINT 'IB_UDF_rtrim' MODULE_NAME 'ib_udf';

/* drop view (field) for UDF alter */
DROP VIEW EQCONFESTOQVW01;

/* Empty dependent trigger body before Function Alter (Drop/Create) */
SET TERM ^ ;

ALTER TRIGGER CPCOMPRATGBU
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER CPCOMPRATGAU
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER CPFORNECEDTGBI
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER CPFORNECEDTGBU
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER CPITCOMPRATGBU
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER LFITCOMPRATGAU
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER LFITVENDATGAU
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER TKCONTATOTGBI
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER TKCONTATOTGBU
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER VDCLIENTETGBI
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER VDCLIENTETGBU
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER VDITVENDATGAU
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER VDTRANSPTGBI
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER VDTRANSPTGBU
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER VDVENDATGBU
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Empty dependent trigger body before Function Alter (Drop/Create) */
ALTER TRIGGER VDVENDATGAU
 AS Declare variable I integer;
BEGIN I = 0; END
^

SET TERM ; ^

DROP EXTERNAL FUNCTION SUBSTR;

DECLARE EXTERNAL FUNCTION SUBSTR
CSTRING(255),SMALLINT,SMALLINT
RETURNS CSTRING(255) FREE_IT
ENTRY_POINT 'IB_UDF_substr' MODULE_NAME 'ib_udf';


/* Alter Field (Length): from 10 to 20... */
UPDATE RDB$FIELDS SET RDB$FIELD_LENGTH=20, RDB$CHARACTER_LENGTH=20
  WHERE RDB$FIELD_NAME=(SELECT RDB$FIELD_SOURCE FROM RDB$RELATION_FIELDS
  WHERE RDB$RELATION_NAME='FNCONTA' AND  RDB$FIELD_NAME='CONVCOBCONTA');

/* Alter Field (Length): from 15 to 20... */
UPDATE RDB$FIELDS SET RDB$FIELD_LENGTH=20, RDB$CHARACTER_LENGTH=20
  WHERE RDB$FIELD_NAME=(SELECT RDB$FIELD_SOURCE FROM RDB$RELATION_FIELDS
  WHERE RDB$RELATION_NAME='FNITMODBOLETO' AND  RDB$FIELD_NAME='CONVCOB');

/* Alter Field (Null / Not Null)... */
UPDATE RDB$RELATION_FIELDS SET RDB$NULL_FLAG = 1 WHERE RDB$FIELD_NAME='PERMITEAJUSTEITEST' AND RDB$RELATION_NAME='PPITESTRUTURA';

CREATE DOMAIN IBCXXX CHAR(1) DEFAULT 'N' NOT NULL;

UPDATE RDB$RELATION_FIELDS SET RDB$DEFAULT_SOURCE=
(SELECT RDB$DEFAULT_SOURCE FROM RDB$FIELDS where RDB$FIELD_NAME='IBCXXX'),
RDB$DEFAULT_VALUE=
(SELECT RDB$DEFAULT_VALUE FROM RDB$FIELDS where RDB$FIELD_NAME='IBCXXX')
WHERE RDB$FIELD_NAME='PERMITEAJUSTEITEST' AND RDB$RELATION_NAME='PPITESTRUTURA';

DROP DOMAIN IBCXXX;

UPDATE RDB$FIELDS SET RDB$DEFAULT_VALUE = NULL,
RDB$DEFAULT_SOURCE = '' WHERE RDB$FIELD_NAME =
(SELECT RDB$FIELD_SOURCE FROM RDB$RELATION_FIELDS
WHERE RDB$FIELD_NAME = 'PERMITEAJUSTEITEST' AND RDB$RELATION_NAME = 'PPITESTRUTURA');

/* Alter Field (Null / Not Null)... */
UPDATE RDB$RELATION_FIELDS SET RDB$NULL_FLAG = 1 WHERE RDB$FIELD_NAME='TIPOEXTERNO' AND RDB$RELATION_NAME='PPITESTRUTURA';

CREATE DOMAIN IBCXXX CHAR(1) DEFAULT 'E' NOT NULL;

UPDATE RDB$RELATION_FIELDS SET RDB$DEFAULT_SOURCE=
(SELECT RDB$DEFAULT_SOURCE FROM RDB$FIELDS where RDB$FIELD_NAME='IBCXXX'),
RDB$DEFAULT_VALUE=
(SELECT RDB$DEFAULT_VALUE FROM RDB$FIELDS where RDB$FIELD_NAME='IBCXXX')
WHERE RDB$FIELD_NAME='TIPOEXTERNO' AND RDB$RELATION_NAME='PPITESTRUTURA';

DROP DOMAIN IBCXXX;

UPDATE RDB$FIELDS SET RDB$DEFAULT_VALUE = NULL,
RDB$DEFAULT_SOURCE = '' WHERE RDB$FIELD_NAME =
(SELECT RDB$FIELD_SOURCE FROM RDB$RELATION_FIELDS
WHERE RDB$FIELD_NAME = 'TIPOEXTERNO' AND RDB$RELATION_NAME = 'PPITESTRUTURA');

/* Alter Field (Length): from 15 to 20... */
UPDATE RDB$FIELDS SET RDB$FIELD_LENGTH=20, RDB$CHARACTER_LENGTH=20
  WHERE RDB$FIELD_NAME=(SELECT RDB$FIELD_SOURCE FROM RDB$RELATION_FIELDS
  WHERE RDB$RELATION_NAME='SGITPREFERE6' AND  RDB$FIELD_NAME='CONVCOB');


ALTER TABLE FNCARTCOB ADD CONVCOB VARCHAR(20);

ALTER TABLE SGPREFERE1 ADD IDENTCLIBCO CHAR(1) DEFAULT 'D' NOT NULL;

Update Rdb$Relation_Fields set Rdb$Description =
'Identificação cliente (SIACC)- D - Documento - CPF/CNPJ / C - Código do cliente '
where Rdb$Relation_Name='SGPREFERE1' and Rdb$Field_Name='IDENTCLIBCO';

ALTER TABLE SGPREFERE1 ADD QTDDESC CHAR(1) DEFAULT 'N' NOT NULL;

ALTER TABLE SGPREFERE1 ADD LOCALSERV CHAR(1) DEFAULT 'P' NOT NULL;

ALTER TABLE SGPREFERE3 ADD LAYOUTFICHAAVAL VARCHAR(100);

ALTER TABLE VDCLIENTE ADD NCONTABCOCLI VARCHAR(20);

ALTER TABLE VDCLIENTE ADD IDENTCLIBCO CHAR(1) DEFAULT 'D' NOT NULL;

Update Rdb$Relation_Fields set Rdb$Description =
'Identificação cliente (SIACC)- D - Documento - CPF/CNPJ / C - Código do cliente '
where Rdb$Relation_Name='VDCLIENTE' and Rdb$Field_Name='IDENTCLIBCO';

ALTER TABLE VDCONTRATO ADD CODEMPMC INTEGER;

ALTER TABLE VDCONTRATO ADD CODFILIALMC SMALLINT;

ALTER TABLE VDCONTRATO ADD CODMODCONTR INTEGER;

ALTER TABLE VDITCONTRATO ADD FRANQUIAITCONTR CHAR(1) DEFAULT 'S' NOT NULL;

Update Rdb$Relation_Fields set Rdb$Description =
'Agregar quantidade ao valor da franquia (S/N).'
where Rdb$Relation_Name='VDITCONTRATO' and Rdb$Field_Name='FRANQUIAITCONTR';

ALTER TABLE VDVENDA ADD LOCALSERV CHAR(1) DEFAULT 'P' NOT NULL;

/* Create Table... */
CREATE TABLE CRAMBIENTEAVAL(CODEMP INTEGER NOT NULL,
CODFILIAL SMALLINT NOT NULL,
CODAMBAVAL INTEGER NOT NULL,
DESCAMBAVAL VARCHAR(50) NOT NULL,
SIGLAAMBAVAL VARCHAR(10) NOT NULL,
DTINS DATE DEFAULT 'now' NOT NULL,
HINS TIME DEFAULT 'now' NOT NULL,
IDUSUINS VARCHAR(128) DEFAULT USER NOT NULL,
DTALT DATE DEFAULT 'now' NOT NULL,
HALT TIME DEFAULT 'now' NOT NULL,
IDUSUALT VARCHAR(128) DEFAULT USER);


CREATE TABLE CRFICHAAVAL(CODEMP INTEGER NOT NULL,
CODFILIAL SMALLINT NOT NULL,
SEQFICHAAVAL INTEGER NOT NULL,
CODEMPCO INTEGER NOT NULL,
CODFILIALCO SMALLINT NOT NULL,
CODCTO INTEGER NOT NULL,
CODEMPMA INTEGER NOT NULL,
CODFILIALMA SMALLINT NOT NULL,
CODMOTAVAL INTEGER NOT NULL,
DTFICHAAVAL DATE DEFAULT 'now' NOT NULL,
LOCALFICHAAVAL CHAR(1) DEFAULT 'A',
FINALIFICHAAVAL CHAR(1) DEFAULT 'C',
PREDENTRFICHAAVAL CHAR(1) DEFAULT 'N' NOT NULL,
ANDARFICHAAVAL SMALLINT DEFAULT 0 NOT NULL,
COBERTFICHAAVAL CHAR(1) DEFAULT 'N' NOT NULL,
ESTRUTFICHAAVAL CHAR(1) DEFAULT 'N' NOT NULL,
OCUPADOFICHAAVAL CHAR(1) DEFAULT 'N' NOT NULL,
MOBILFICHAAVAL CHAR(1) DEFAULT 'M' NOT NULL,
JANELAFICHAAVAL CHAR(1) DEFAULT 'N' NOT NULL,
SACADAFICHAAVAL CHAR(1) DEFAULT 'N' NOT NULL,
OUTROSFICHAAVAL CHAR(1) DEFAULT 'N' NOT NULL,
OBSFICHAAVAL VARCHAR(1000),
DTINS DATE DEFAULT 'now' NOT NULL,
HINS TIME DEFAULT 'now' NOT NULL,
IDUSUINS VARCHAR(128) DEFAULT USER NOT NULL,
DTALT DATE DEFAULT 'now' NOT NULL,
HALT TIME DEFAULT 'now' NOT NULL,
IDUSUALT VARCHAR(128) DEFAULT USER);


CREATE TABLE CRFICHAORC(CODEMP INTEGER NOT NULL,
CODFILIAL INTEGER NOT NULL,
SEQFICHAAVAL INTEGER NOT NULL,
SEQITFICHAAVAL INTEGER NOT NULL,
CODEMPOR INTEGER NOT NULL,
CODFILIALOR INTEGER NOT NULL,
TIPOORC CHAR(1) NOT NULL,
CODORC INTEGER NOT NULL,
CODITORC INTEGER NOT NULL,
DTINS DATE DEFAULT 'now' NOT NULL,
HINS TIME DEFAULT 'now' NOT NULL,
IDUSUINS CHAR(8) DEFAULT USER NOT NULL,
DTALT DATE DEFAULT 'now',
HALT TIME DEFAULT 'now',
IDUSUALT CHAR(8) DEFAULT USER);


CREATE TABLE CRITFICHAAVAL(CODEMP INTEGER NOT NULL,
CODFILIAL SMALLINT NOT NULL,
SEQFICHAAVAL INTEGER NOT NULL,
SEQITFICHAAVAL INTEGER NOT NULL,
CODEMPAM INTEGER NOT NULL,
CODFILIALAM SMALLINT NOT NULL,
CODAMBAVAL INTEGER NOT NULL,
DESCITFICHAAVAL VARCHAR(50) NOT NULL,
CODEMPPD INTEGER NOT NULL,
CODFILIALPD SMALLINT NOT NULL,
CODPROD INTEGER NOT NULL,
ALTITFICHAAVAL NUMERIC(15,5) NOT NULL,
LARGITFICHAAVAL NUMERIC(15,5) NOT NULL,
DNMITFICHAAVAL NUMERIC(15,5) NOT NULL,
DTINS DATE DEFAULT 'now' NOT NULL,
HINS TIME DEFAULT 'now' NOT NULL,
IDUSUINS VARCHAR(128) DEFAULT USER NOT NULL,
DTALT DATE DEFAULT 'now' NOT NULL,
HALT TIME DEFAULT 'now' NOT NULL,
IDUSUALT VARCHAR(128) DEFAULT USER);


CREATE TABLE CRMOTIVOAVAL(CODEMP INTEGER NOT NULL,
CODFILIAL SMALLINT NOT NULL,
CODMOTAVAL INTEGER NOT NULL,
DESCMOTAVAL VARCHAR(50) NOT NULL,
DTINS DATE DEFAULT 'now' NOT NULL,
HINS TIME DEFAULT 'now' NOT NULL,
IDUSUINS VARCHAR(128) DEFAULT USER NOT NULL,
DTALT DATE DEFAULT 'now' NOT NULL,
HALT TIME DEFAULT 'now' NOT NULL,
IDUSUALT VARCHAR(128) DEFAULT USER);


CREATE TABLE VDMODCONTR(CODEMP INTEGER NOT NULL,
CODFILIAL SMALLINT NOT NULL,
CODMODCONTR INTEGER NOT NULL,
DESCMODCONTR CHAR(80) NOT NULL,
LAYOUTMODCONTR VARCHAR(100) NOT NULL,
TPMODCONTR CHAR(1) DEFAULT 'O' NOT NULL,
CODEMPBO INTEGER,
CODFILIALBO SMALLINT,
CODBANCO CHAR(3),
CODEMPCB INTEGER,
CODFILIALCB SMALLINT,
CODCARTCOB CHAR(3),
TEXTO1 VARCHAR(10000),
TEXTO2 VARCHAR(10000),
DTINS DATE DEFAULT 'now' NOT NULL,
HINS TIME DEFAULT 'now' NOT NULL,
IDUSUINS CHAR(8) DEFAULT USER NOT NULL,
DTALT DATE DEFAULT 'now',
HALT TIME DEFAULT 'now',
IDUSUALT CHAR(8) DEFAULT USER);



/* Create view: EQCONFESTOQVW01 (ViwData.CreateDependDef) */
CREATE VIEW EQCONFESTOQVW01(
CODEMP,
CODFILIAL,
ATIVOPROD,
DESCPROD,
CODPROD,
REFPROD,
SLDLIQPROD,
QTDINVP,
QTDITCOMPRA,
QTDFINALPRODOP,
QTDEXPITRMA,
QTDITVENDA,
SLDMOVPROD,
SLDLIQPRODAX)
 AS 
SELECT P.CODEMP, P.CODFILIAL, P.ATIVOPROD, P.DESCPROD,P.CODPROD,P.REFPROD,P.SLDLIQPROD,
    COALESCE((SELECT SUM(QTDINVP)  FROM EQINVPROD IT WHERE IT.CODEMPPD=P.CODEMP AND
       IT.CODFILIALPD=P.CODFILIAL AND IT.CODPROD=P.CODPROD ),0) QTDINVP,
   COALESCE((SELECT SUM(QTDITCOMPRA)  FROM CPITCOMPRA IC, CPCOMPRA C, EQTIPOMOV TM
       WHERE IC.CODEMPPD=P.CODEMP AND IC.CODFILIALPD=P.CODFILIAL AND
       IC.CODPROD=P.CODPROD AND  C.CODCOMPRA=IC.CODCOMPRA AND
       C.CODEMP=IC.CODEMP AND C.CODFILIAL=IC.CODFILIAL AND  TM.CODTIPOMOV=C.CODTIPOMOV AND
       TM.CODEMP=C.CODEMPTM AND TM.CODFILIAL=C.CODFILIALTM AND TM.ESTOQTIPOMOV='S' ),0) QTDITCOMPRA,
   COALESCE((SELECT SUM(QTDFINALPRODOP) FROM PPOP O, EQTIPOMOV TM
      WHERE O.CODEMPPD=P.CODEMP AND O.CODFILIALPD=P.CODFILIAL AND O.CODPROD=P.CODPROD AND
      TM.CODTIPOMOV=O.CODTIPOMOV AND TM.CODEMP=O.CODEMPTM AND
      TM.CODFILIAL=O.CODFILIALTM  AND TM.ESTOQTIPOMOV='S' ),0) QTDFINALPRODOP,
   COALESCE((SELECT SUM(QTDEXPITRMA) FROM EQRMA R, EQITRMA IR, EQTIPOMOV TM  WHERE IR.CODEMPPD=P.CODEMP AND
      IR.CODFILIALPD=P.CODFILIAL AND IR.CODPROD=P.CODPROD AND  R.CODRMA=IR.CODRMA AND
      R.CODEMP=IR.CODEMP AND R.CODFILIAL=IR.CODFILIAL AND
      TM.CODTIPOMOV=R.CODTIPOMOV AND TM.CODEMP=R.CODEMPTM AND
      TM.CODFILIAL=R.CODFILIALTM  AND TM.ESTOQTIPOMOV='S' ),0) QTDEXPITRMA,
   COALESCE((SELECT SUM(QTDITVENDA) FROM VDITVENDA IV, VDVENDA V, EQTIPOMOV TM
      WHERE IV.CODEMPPD=P.CODEMP AND IV.CODFILIALPD=P.CODFILIAL AND IV.CODPROD=P.CODPROD AND
      V.CODVENDA=IV.CODVENDA AND V.TIPOVENDA=IV.TIPOVENDA AND
      V.CODEMP=IV.CODEMP AND V.CODFILIAL=IV.CODFILIAL AND
      (NOT SUBSTR(V.STATUSVENDA,1,1)='C') AND TM.CODTIPOMOV=V.CODTIPOMOV AND
      TM.CODEMP=V.CODEMPTM AND TM.CODFILIAL=V.CODFILIALTM  AND TM.ESTOQTIPOMOV='S' ),0) QTDITVENDA,
   COALESCE((SELECT FIRST 1 M.SLDMOVPROD FROM EQMOVPROD M WHERE M.CODEMPPD=P.CODEMP AND
      M.CODFILIALPD=P.CODFILIAL AND  M.CODPROD=P.CODPROD
      ORDER BY M.DTMOVPROD DESC, M.CODMOVPROD DESC ),0) SLDMOVPROD,
   COALESCE((SELECT SUM(SP.SLDLIQPROD) FROM EQSALDOPROD SP WHERE SP.CODEMP=P.CODEMP AND
      SP.CODFILIAL=P.CODFILIAL AND SP.CODPROD=P.CODPROD),0) SLDLIQPRODAX
   FROM EQPRODUTO P
;

/* Create view: VWCUSTOPROJ01 (ViwData.CreateDependDef) */
CREATE VIEW VWCUSTOPROJ01(
CODEMP,
CODFILIAL,
CODCLI,
DATA,
DESCCUSTO,
CODCONTR,
CODITCONTR,
TPCONTR,
VLRPREVREC,
QTDCUSTO,
VLRCUSTO,
TIPOCUSTO)
 AS 
select ad.codemp, ad.codfilial, ad.codcli, ad.dataatendo ,cast('Hora trabalhada - ' || rtrim(ae.nomeatend)  as varchar(200)) as desccusto, ad.codcontr,ad.coditcontr, co.tpcontr ,ic.vlritcontr * ic.qtditcontr as vlrreceitaprev,
 ( ad.horaatendofin  - ad.horaatendo ) / 3600 as qtd , sa.custohoratrab as custo, 'M' as tipo
from
vditcontrato ic, atatendimento ad, atatendente ae, rhempregado em, rhempregadosal sa, vdcontrato co
where
ic.codemp=ad.codempct and ic.codfilial=ad.codfilialct and ic.codcontr=ad.codcontr and ic.coditcontr=ad.coditcontr and
co.codemp=ic.codemp and co.codfilial=ic.codfilial and co.codcontr=ic.codcontr and
ae.codemp=ad.codempae and ae.codfilial=ad.codfilialae and ae.codatend=ad.codatend and
em.codemp=ae.codempep and em.codfilial=ae.codfilialep and em.matempr=ae.matempr and
sa.codemp=em.codemp and sa.codfilial=em.codfilial and sa.matempr=em.matempr and sa.seqsal=
(
    select first 1 seqsal from rhempregadosal s1 where s1.codemp=em.codemp and
    s1.codfilial=em.codfilial and s1.matempr=em.matempr and
    s1.dtvigor < cast('today' as date) order by s1.dtvigor desc
)
-- Custos de outras despesas financeiras;
union
select sl.codemp, sl.codfilial, co.codcli, sl.datasublanca, cast(sl.histsublanca as varchar(200)) as desccusto, ic.codcontr, ic.coditcontr, co.tpcontr ,ic.vlritcontr * ic.qtditcontr as vlrreceitaprev,
1.00 as qtd, sl.vlrsublanca  as custo, 'F' as tipo
from
vditcontrato ic, vdcontrato co, fnsublanca sl, fnplanejamento pl
where
ic.codemp=sl.codempct and ic.codfilial=sl.codfilialct and ic.codcontr=sl.codcontr and ic.coditcontr=sl.coditcontr and
co.codemp=ic.codemp and co.codfilial=ic.codfilial and co.codcontr=ic.codcontr
and pl.codemp=sl.codemppn and pl.codfilial=sl.codfilialpn and pl.codplan=sl.codplan and pl.tipoplan='D'
union
--Custos de estoque
select ir.codemp, ir.codfilial, co.codcli, rma.dtaexprma, cast(pd.descprod as varchar(200)) as desccusto ,ic.codcontr, ic.coditcontr, co.tpcontr, ic.vlritcontr * ic.qtditcontr as vlrreceitaprev,
ir.qtdexpitrma as qtd, ir.precoitrma as custo, 'E' as tipo
from
vditcontrato ic, vdcontrato co, eqrma rma, eqitrma ir, eqproduto pd
where ic.codemp=rma.codempct and ic.codfilial=rma.codfilialct and ic.codcontr=rma.codcontr and ic.coditcontr=rma.coditcontr and
co.codemp=ic.codemp and co.codfilial=ic.codfilial and co.codcontr=ic.codcontr
and ir.codemp=rma.codemp and ir.codfilial=rma.codfilial and ir.codrma=rma.codrma and
pd.codemp=ir.codemppd and pd.codfilial=ir.codfilialpd and pd.codprod=ir.codprod and
ir.sitexpitrma='ET'
;

/* Alter View (Drop, Create)... */
/* Drop altered view: ATATENDIMENTOVW01 */
/* AssignEmptyBody proc */
SET TERM ^ ;

ALTER PROCEDURE VDCONTRATOTOTSP(CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
CODCONTR INTEGER,
CODITCONTR INTEGER,
CODEMPSC INTEGER,
CODFILIALSC SMALLINT,
CODCONTRSC INTEGER,
CODEMPTA INTEGER,
CODFILIALTA SMALLINT,
CODTAREFA INTEGER,
CODEMPST INTEGER,
CODFILIALST SMALLINT,
CODTAREFAST INTEGER,
DATAINI DATE,
DATAFIM DATE)
 RETURNS(TOTALPREVGERAL NUMERIC(15,5),
TOTALPREVPER NUMERIC(15,5),
TOTALGERAL NUMERIC(15,5),
TOTALCOBCLIGERAL NUMERIC(15,5),
TOTALANT NUMERIC(15,5),
TOTALCOBCLIANT NUMERIC(15,5),
TOTALPER NUMERIC(15,5),
TOTALCOBCLIPER NUMERIC(15,5),
SALDOANT NUMERIC(15,5),
SALDOPER NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

SET TERM ; ^

DROP VIEW ATATENDIMENTOVW06;

DROP VIEW ATATENDIMENTOVW03;

DROP VIEW ATATENDIMENTOVW08;

DROP VIEW ATATENDIMENTOVW02;

DROP VIEW ATATENDIMENTOVW04;

DROP VIEW ATATENDIMENTOVW01;

/* Create altered view: ATATENDIMENTOVW01 */
/* Create view: ATATENDIMENTOVW01 (ViwData.CreateDependDef) */
CREATE VIEW ATATENDIMENTOVW01(
CODEMP,
CODFILIAL,
CODATENDO,
CODEMPAE,
CODFILIALAE,
CODATEND,
NOMEATEND,
PARTPREMIATEND,
CODEMPEP,
CODFILIALEP,
MATEMPR,
COEMPEA,
CODFILIALEA,
CODESPEC,
DESCESPEC,
CODEMPCT,
CODFILIALCT,
CODCONTR,
DESCCONTR,
CODITCONTR,
CODEMPTA,
CODFILIALTA,
CODTAREFA,
TPCOBCONTR,
ANOATENDO,
MESATENDO,
QTDCONTR,
QTDITCONTR,
VLRITCONTR,
VLRITCONTREXCED,
DTINICIO,
STATUSATENDO,
RAZCLI,
NOMECLI,
CODCLI,
CODEMPCL,
CODFILIALCL,
CODEMPCH,
CODFILIALCH,
CODCHAMADO,
DESCCHAMADO,
CODEMPTO,
CODFILIALTO,
CODTPATENDO,
DESCTPATENDO,
OBSATENDO,
DATAATENDO,
DATAATENDOFIN,
HORAATENDO,
HORAATENDOFIN,
PGCOMIESPEC,
COBCLIESPEC,
CONTMETAESPEC,
MRELCOBESPEC,
BHESPEC,
TEMPOMINCOBESPEC,
TEMPOMAXCOBESPEC,
PERCCOMIESPEC,
TOTALMIN,
SITREVATENDO,
SITCONTR,
DESCSITCONTR,
DTPREVFIN,
TIPOATENDO,
DOCATENDO)
 AS 
select a.codemp, a.codfilial, a.codatendo
  , a.codempae, a.codfilialae, a.codatend, ate.nomeatend, ate.partpremiatend, ate.codempep, codfilialep, matempr
  , a.codempea, a.codfilialea, a.codespec, e.descespec
  , a.codempct, a.codfilialct, a.codcontr, ct.desccontr, a.coditcontr 
  , a.codempta, a.codfilialta, a.codtarefa, ct.tpcobcontr
  , extract(year from a.dataatendo) anoatendo, extract(month from a.dataatendo) mesatendo
  , ( select sum(qtditcontr) from vditcontrato ics 
     where ics.codemp=a.codempct and ics.codfilial=a.codfilialct 
     and ics.codcontr=a.codcontr and ics.franquiaitcontr='S') qtdcontr 
  , ict.qtditcontr, ict.vlritcontr, ict.vlritcontrexced, ct.dtinicio
  , a.statusatendo, c.razcli, c.nomecli, c.codcli, c.codemp, c.codfilial
  , a.codempch, a.codfilialch, a.codchamado, ch.descchamado
  , a.codempto, a.codfilialto, a.codtpatendo, ta.desctpatendo
  , a.obsatendo, a.dataatendo, a.dataatendofin, a.horaatendo, a.horaatendofin
  , e.pgcomiespec, e.cobcliespec, e.contmetaespec, e.mrelcobespec, e.bhespec
  , e.tempomincobespec, e.tempomaxcobespec, e.perccomiespec, ((a.horaatendofin-a.horaatendo) / 60) TOTALMIN
  , a.sitrevatendo
  , ct.sitcontr, ct.descsitcontr, ct.dtprevfin, ta.tipoatendo, a.docatendo
from atatendente ate, atespecatend e, vdcliente c, attipoatendo ta, atatendimento a
left outer join crchamado ch on 
ch.codemp=a.codempch and ch.codfilial=a.codfilialch and ch.codchamado=a.codchamado 
left outer join vdcontrato ct on
ct.codemp=a.codempct and ct.codfilial=a.codfilialct and ct.codcontr=a.codcontr
left outer join vditcontrato ict on
ict.codemp=a.codempct and ict.codfilial=a.codfilialct and ict.codcontr=a.codcontr and ict.coditcontr=a.coditcontr
where ate.codemp=a.codempae and ate.codfilial=a.codfilialae and ate.codatend=a.codatend and
e.codemp=a.codempea and e.codfilial=a.codfilialea and e.codespec=a.codespec and 
c.codemp=a.codempcl and c.codfilial=a.codfilialcl and c.codcli=a.codcli and
ta.codemp=a.codempto and ta.codfilial=a.codfilialto and ta.codtpatendo=a.codtpatendo
;

/* Drop altered view: ATATENDIMENTOVW02 */
/* Create altered view: ATATENDIMENTOVW02 */
/* Create view: ATATENDIMENTOVW02 (ViwData.CreateDependDef) */
CREATE VIEW ATATENDIMENTOVW02(
CODEMP,
CODFILIAL,
CODATENDO,
CODEMPAE,
CODFILIALAE,
CODATEND,
NOMEATEND,
PARTPREMIATEND,
CODEMPEP,
CODFILIALEP,
MATEMPR,
CODEMPEA,
CODFILIALEA,
CODESPEC,
DESCESPEC,
CODEMPCT,
CODFILIALCT,
CODCONTR,
CODITCONTR,
CODEMPTA,
CODFILIALTA,
CODTAREFA,
TPCOBCONTR,
ANOATENDO,
MESATENDO,
QTDCONTR,
QTDITCONTR,
VLRITCONTR,
VLRITCONTREXCED,
DTINICIO,
STATUSATENDO,
RAZCLI,
NOMECLI,
CODCLI,
CODEMPCL,
CODFILIALCL,
CODEMPCH,
CODFILIALCH,
CODCHAMADO,
DESCCHAMADO,
CODEMPTO,
CODFILIALTO,
CODTPATENDO,
DESCTPATENDO,
OBSATENDO,
DATAATENDO,
DATAATENDOFIN,
HORAATENDO,
HORAATENDOFIN,
PGCOMIESPEC,
COBCLIESPEC,
CONTMETAESPEC,
MRELCOBESPEC,
BHESPEC,
TEMPOMINCOBESPEC,
TEMPOMAXCOBESPEC,
PERCCOMIESPEC,
TOTALMIN,
TOTALGERAL,
TOTALMETA,
TOTALCOMIS,
TOTALCOBCLI,
TOTALBH,
SITREVATENDO,
TIPOATENDO,
DOCATENDO)
 AS 
select A.CODEMP, A.CODFILIAL, A.CODATENDO, 
A.CODEMPAE, A.CODFILIALAE, A.CODATEND, A.NOMEATEND, A.PARTPREMIATEND, A.CODEMPEP, CODFILIALEP, MATEMPR,
A.COEMPEA, A.CODFILIALEA, A.CODESPEC, A.DESCESPEC, 
 A.CODEMPCT, A.CODFILIALCT, A.CODCONTR,  A.CODITCONTR, A.CODEMPTA, A.CODFILIALTA, A.CODTAREFA, A.TPCOBCONTR,
 A.ANOATENDO, A.MESATENDO, A.QTDCONTR,
 A.QTDITCONTR, A.VLRITCONTR, A.VLRITCONTREXCED, A.DTINICIO,
 A.STATUSATENDO, A.RAZCLI, A.NOMECLI, A.CODCLI,
  A.CODEMPCL, A.CODFILIALCL, A.CODEMPCH, A.CODFILIALCH, A.CODCHAMADO, A.DESCCHAMADO,
  A.CODEMPTO, A.CODFILIALTO, A.CODTPATENDO,
   A.DESCTPATENDO, A.OBSATENDO, A.DATAATENDO, A.DATAATENDOFIN, A.HORAATENDO, A.HORAATENDOFIN,
    A.PGCOMIESPEC, A.COBCLIESPEC, A.CONTMETAESPEC, A.MRELCOBESPEC, A.BHESPEC, A.TEMPOMINCOBESPEC, A.TEMPOMAXCOBESPEC,
     A.PERCCOMIESPEC, A.TOTALMIN, 
  (a.totalmin) / 60  totalgeral, 
(( (case when a.contmetaespec='S' then (case when 
a.totalmin<a.tempomincobespec 
then a.tempomincobespec else 
(case when a.totalmin>a.tempomaxcobespec and a.tempomaxcobespec<>0 
then a.tempomaxcobespec else a.totalmin end) end)  else 0 end) 
)/60 ) totalmeta, 
(( (case when a.pgcomiespec='S' then (case when a.totalmin<a.tempomincobespec 
then a.tempomincobespec else 
(case when a.totalmin>a.tempomaxcobespec and a.tempomaxcobespec<>0 
then a.tempomaxcobespec else a.totalmin end) end)  else 0 end) 
)/60 ) totalcomis, 
(( (case when a.cobcliespec='S' and a.statusatendo<>'NC' then (case when a.totalmin<a.tempomincobespec 
then a.tempomincobespec else 
(case when a.totalmin>a.tempomaxcobespec and a.tempomaxcobespec<>0 
then a.tempomaxcobespec else a.totalmin end) end)  else 0 end) 
)/60 ) totalcobcli,
( (case when a.bhespec='S' then a.totalmin else 0 end)/60 ) totalbh,
a.sitrevatendo, a.tipoatendo, a.docatendo
from atatendimentovw01 a
;

/* Alter Index (Drop, Create)... */
--CONNECT 'localhost:/opt/firebird/dados/desenv/freedom1.2.5.1.fdb' USER 'SYSDBA' PASSWORD '123654';

DROP INDEX TKCONFEMAILIDX1;

CREATE UNIQUE INDEX TKCONFEMAILIDX1 ON TKCONFEMAIL(EMAILREMET,CODEMP,CODFILIAL);


/* Create Primary Key... */
ALTER TABLE CRAMBIENTEAVAL ADD CONSTRAINT CRAMBIENTEAVALPK PRIMARY KEY (CODAMBAVAL,CODFILIAL,CODEMP);

ALTER TABLE CRFICHAAVAL ADD CONSTRAINT CRFICHAAVALPK PRIMARY KEY (SEQFICHAAVAL,CODFILIAL,CODEMP);

ALTER TABLE CRFICHAORC ADD CONSTRAINT CRFICHAORCPK PRIMARY KEY (SEQFICHAAVAL,SEQITFICHAAVAL,CODFILIAL,CODEMP,CODORC,CODITORC,TIPOORC,CODFILIALOR,CODEMPOR);

ALTER TABLE CRITFICHAAVAL ADD CONSTRAINT CRITFICHAAVALPK PRIMARY KEY (SEQFICHAAVAL,SEQITFICHAAVAL,CODFILIAL,CODEMP);

ALTER TABLE CRMOTIVOAVAL ADD CONSTRAINT CRMOTIVOAVALPK PRIMARY KEY (CODMOTAVAL,CODFILIAL,CODEMP);

ALTER TABLE VDMODCONTR ADD CONSTRAINT VDMODCONTRPK PRIMARY KEY (CODMODCONTR,CODFILIAL,CODEMP);

/* Create Foreign Key... */
--CONNECT 'localhost:/opt/firebird/dados/desenv/freedom1.2.5.1.fdb' USER 'SYSDBA' PASSWORD '123654';

ALTER TABLE CRFICHAAVAL ADD CONSTRAINT CRFICHAAVALFKCRMO FOREIGN KEY (CODMOTAVAL,CODFILIALMA,CODEMPMA) REFERENCES CRMOTIVOAVAL(CODMOTAVAL,CODFILIAL,CODEMP);

ALTER TABLE CRFICHAAVAL ADD CONSTRAINT CRFICHAAVALFKTKCTO FOREIGN KEY (CODCTO,CODFILIALCO,CODEMP) REFERENCES TKCONTATO(CODCTO,CODFILIAL,CODEMP);

ALTER TABLE CRFICHAORC ADD CONSTRAINT CRFICHAORCFKCRITFI FOREIGN KEY (SEQFICHAAVAL,SEQITFICHAAVAL,CODFILIAL,CODEMP) REFERENCES CRITFICHAAVAL(SEQFICHAAVAL,SEQITFICHAAVAL,CODFILIAL,CODEMP) ON UPDATE CASCADE;

ALTER TABLE CRFICHAORC ADD CONSTRAINT CRFICHAORCFKVDORCA FOREIGN KEY (CODORC,CODITORC,TIPOORC,CODFILIALOR,CODEMPOR) REFERENCES VDITORCAMENTO(CODORC,CODITORC,TIPOORC,CODFILIAL,CODEMP);

ALTER TABLE CRITFICHAAVAL ADD CONSTRAINT CRITFICHAAVALFKAM FOREIGN KEY (CODAMBAVAL,CODFILIALAM,CODEMPAM) REFERENCES CRAMBIENTEAVAL(CODAMBAVAL,CODFILIAL,CODEMP);

ALTER TABLE CRITFICHAAVAL ADD CONSTRAINT CRITFICHAAVALFKPD FOREIGN KEY (CODPROD,CODFILIALPD,CODEMPPD) REFERENCES EQPRODUTO(CODPROD,CODFILIAL,CODEMP);

ALTER TABLE CRITFICHAAVAL ADD CONSTRAINT CRITFICHAAVALFKSQ FOREIGN KEY (SEQFICHAAVAL,CODFILIAL,CODEMP) REFERENCES CRFICHAAVAL(SEQFICHAAVAL,CODFILIAL,CODEMP);

ALTER TABLE VDCONTRATO ADD CONSTRAINT VDCONTRATOFKVDMODCONT FOREIGN KEY (CODMODCONTR,CODFILIALMC,CODEMPMC) REFERENCES VDMODCONTR(CODMODCONTR,CODFILIAL,CODEMP);

ALTER TABLE VDMODCONTR ADD CONSTRAINT VDMODCONTRFKCARTC FOREIGN KEY (CODCARTCOB,CODFILIALCB,CODEMPCB,CODBANCO,CODFILIALBO,CODEMPBO) REFERENCES FNCARTCOB(CODCARTCOB,CODFILIAL,CODEMP,CODBANCO,CODFILIALBO,CODEMPBO);

ALTER TABLE VDMODCONTR ADD CONSTRAINT VDMODCONTRFKFNBCO FOREIGN KEY (CODBANCO,CODFILIALBO,CODEMPBO) REFERENCES FNBANCO(CODBANCO,CODFILIAL,CODEMP);

/* Alter Procedure... */
/* Alter (ATADICATENDIMENTOCLISP) */
SET TERM ^ ;

ALTER PROCEDURE ATADICATENDIMENTOCLISP(ICODTIPOATENDO INTEGER,
ICODATEND INTEGER,
ICODSETOR INTEGER,
ICODEMP INTEGER,
ICODFILIAL INTEGER,
IDOC INTEGER,
DATAATENDO DATE,
DATAATENDOFIN DATE,
HORAATENDO TIME,
HORAATENDOFIN TIME,
OBSATENDO VARCHAR(10000),
CODEMPCL INTEGER,
CODFILIALCL SMALLINT,
CODCLI INTEGER,
CODEMPCT INTEGER,
CODFILIALCT INTEGER,
CODCONTR INTEGER,
CODITCONTR INTEGER,
CODREC INTEGER,
NPARCITREC INTEGER,
CODEMPCH INTEGER,
CODFILIALCH SMALLINT,
CODCHAMADO INTEGER,
OBSINTERNO VARCHAR(10000),
CONCLUICHAMADO CHAR(1),
CODEMPEA INTEGER,
CODFILIALEA SMALLINT,
CODESPEC INTEGER)
 AS
declare variable icodatendo integer;
declare variable ifilialatendo integer;
declare variable ifilialtipoatendo integer;
declare variable ifilialatend integer;
declare variable ifilialsetor integer;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATATENDIMENTO') INTO IFILIALATENDO;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATTIPOATENDO') INTO IFILIALTIPOATENDO;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATATENDENTE') INTO IFILIALATEND;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATSETOR') INTO IFILIALSETOR;
  SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALATENDO,'AT') INTO ICODATENDO;

  INSERT INTO ATATENDIMENTO (
    CODEMP,CODFILIAL,CODATENDO,CODEMPTO,
    CODFILIALTO,CODTPATENDO,CODEMPAE,
    CODFILIALAE,CODATEND,CODEMPSA,CODFILIALSA,
    CODSETAT,STATUSATENDO,IDUSU,CODEMPUS,CODFILIALUS,DOCATENDO, DATAATENDO,
    DATAATENDOFIN, HORAATENDO, HORAATENDOFIN, OBSATENDO, CODEMPCL, CODFILIALCL, CODCLI, CODEMPCT, CODFILIALCT,
    CODCONTR, CODITCONTR, CODEMPCH, CODFILIALCH, CODCHAMADO, obsinterno, CONCLUICHAMADO,
    CODEMPEA, CODFILIALEA, CODESPEC )

  VALUES
  (
    :ICODEMP,:IFILIALATENDO,:ICODATENDO,:ICODEMP,
    :IFILIALTIPOATENDO,:ICODTIPOATENDO,:ICODEMP,
    :IFILIALATEND,:ICODATEND,:ICODEMP,:IFILIALSETOR,
    :ICODSETOR,'AA',lower(USER),:ICODEMP,:ICODFILIAL,:IDOC,
    :DATAATENDO,:DATAATENDOFIN,:HORAATENDO,:HORAATENDOFIN,:OBSATENDO,:CODEMPCL,
    :CODFILIALCL,:CODCLI, :CODEMPCT, :CODFILIALCT, :CODCONTR, :CODITCONTR, :codempch,
    :codfilialch, :codchamado, :obsinterno, :CONCLUICHAMADO,
    :CODEMPEA, :CODFILIALEA, :CODESPEC
  );

  -- Caso o atendimento tenha vinculo com o contas a receber
  IF(CODREC IS NOT NULL AND NPARCITREC IS NOT NULL) THEN
  BEGIN
    INSERT INTO ATATENDIMENTOITREC (CODEMP,CODFILIAL,CODATENDO,CODEMPIR,CODFILIALIR,CODREC,NPARCITREC) VALUES
        (:ICODEMP,:ICODFILIAL,:ICODATENDO,:ICODEMP,:ICODFILIAL,:CODREC,:NPARCITREC);
  END



END
^

/* Alter (ATADICATENDIMENTOSP) */
ALTER PROCEDURE ATADICATENDIMENTOSP(ICODCONV INTEGER,
ICODTIPOATENDO INTEGER,
ICODATEND INTEGER,
ICODSETOR INTEGER,
VOBSATENDO VARCHAR(10000),
ICODEMP INTEGER,
ICODFILIAL INTEGER,
IDOC INTEGER)
 AS
DECLARE VARIABLE ICODATENDO INTEGER;
DECLARE VARIABLE IFILIALATENDO INTEGER;
DECLARE VARIABLE IFILIALCONV INTEGER;
DECLARE VARIABLE IFILIALTIPOATENDO INTEGER;
DECLARE VARIABLE IFILIALATEND INTEGER;
DECLARE VARIABLE IFILIALSETOR INTEGER;
DECLARE VARIABLE IFILIALPREF INTEGER;
DECLARE VARIABLE IFILIALVEND INTEGER;
DECLARE VARIABLE IFILIALORC INTEGER;
DECLARE VARIABLE ICODTPATENDOLEV INTEGER; /*TIPO DE ATENDIMENTO PARA LEVANTAMENTOS*/
DECLARE VARIABLE ICODORC INTEGER;
DECLARE VARIABLE ICODCLI INTEGER;
DECLARE VARIABLE ICODVEND INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATATENDIMENTO') INTO IFILIALATENDO;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATCONVENIADO') INTO IFILIALCONV;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATTIPOATENDO') INTO IFILIALTIPOATENDO;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATATENDENTE') INTO IFILIALATEND;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATSETOR') INTO IFILIALSETOR;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'VDORCAMENTO') INTO IFILIALORC;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'SGPREFERE2') INTO IFILIALPREF;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'VDVENDEDOR') INTO IFILIALVEND;
  SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALATENDO,'AT') INTO ICODATENDO;
  SELECT CODTPATENDO FROM SGPREFERE2 WHERE CODEMP=:ICODEMP AND CODFILIAL=:IFILIALPREF INTO ICODTPATENDOLEV;
  INSERT INTO ATATENDIMENTO (
    CODEMP,CODFILIAL,CODATENDO,CODCONV,
    CODEMPCV,CODFILIALCV,CODEMPTO,
    CODFILIALTO,CODTPATENDO,CODEMPAE,
    CODFILIALAE,CODATEND,CODEMPSA,CODFILIALSA,
    CODSETAT,STATUSATENDO,OBSATENDO,IDUSU,CODEMPUS,CODFILIALUS,DOCATENDO)
  VALUES
  (
    :ICODEMP,:IFILIALATENDO,:ICODATENDO,:ICODCONV,
    :ICODEMP,:IFILIALCONV,:ICODEMP,
    :IFILIALTIPOATENDO,:ICODTIPOATENDO,:ICODEMP,
    :IFILIALATEND,:ICODATEND,:ICODEMP,:IFILIALSETOR,
    :ICODSETOR,'AA',:VOBSATENDO,lower(USER),:ICODEMP,:ICODFILIAL,:IDOC
  );
/*  SELECT CODORC FROM ATATENDIMENTOORC WHERE CODEMP=:ICODEMP
    AND CODFILIAL=:IFILIALORC AND CODORC=:IDOC INTO ICODORC;*/
  IF (ICODTIPOATENDO = ICODTPATENDOLEV/* AND ICODORC IS NULL*/) THEN
  BEGIN
    SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALORC,'OC') INTO ICODORC;
    SELECT CODFILIALVD,CODVEND FROM SGPREFERE2 WHERE
      CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO IFILIALVEND,ICODVEND;
    INSERT INTO VDORCAMENTO (CODEMP,CODFILIAL,TIPOORC,CODORC,CODEMPCV,CODFILIALCV,CODCONV,
        DTORC,DTVENCORC,STATUSORC,CODEMPVD,CODFILIALVD,CODVEND)
      VALUES
      (
        :ICODEMP,:IFILIALORC,'O',:ICODORC,:ICODEMP,:IFILIALCONV,:ICODCONV,
        CAST ('today' AS DATE),CAST ('today' AS DATE),'OA',:ICODEMP,:IFILIALVEND,:ICODVEND
      );


    INSERT INTO ATATENDIMENTOORC (CODEMP,CODFILIAL,CODATENDO,CODEMPOC,CODFILIALOC,TIPOORC,CODORC)
      VALUES
        (:ICODEMP,:IFILIALORC,:ICODATENDO,:ICODEMP,:IFILIALORC,'O',:ICODORC);

    UPDATE ATATENDIMENTO SET DOCATENDO = :IDOC WHERE
      CODEMP=:ICODEMP AND CODFILIAL=:IFILIALATENDO AND CODATENDO=:ICODATENDO;
  END

END
^

/* Alter (ATATENDIMENTOIUSP) */
ALTER PROCEDURE ATATENDIMENTOIUSP(IU CHAR(1),
CODEMP INTEGER,
CODFILIAL SMALLINT,
CODATENDO INTEGER,
CODEMPTO INTEGER,
CODFILIALTO SMALLINT,
CODTPATENDO INTEGER,
CODEMPAE INTEGER,
CODFILIALAE SMALLINT,
CODATEND INTEGER,
CODEMPSA INTEGER,
CODFILIALSA SMALLINT,
CODSETOR INTEGER,
DOCATENDO INTEGER,
DATAATENDO DATE,
DATAATENDOFIN DATE,
HORAATENDO TIME,
HORAATENDOFIN TIME,
OBSATENDO VARCHAR(10000),
CODEMPCL INTEGER,
CODFILIALCL SMALLINT,
CODCLI INTEGER,
CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
CODCONTR INTEGER,
CODITCONTR SMALLINT,
CODEMPIR INTEGER,
CODFILIALIR SMALLINT,
CODREC INTEGER,
NPARCITREC INTEGER,
CODEMPCH INTEGER,
CODFILIALCH SMALLINT,
CODCHAMADO INTEGER,
OBSINTERNO VARCHAR(10000),
CONCLUICHAMADO CHAR(1),
CODEMPEA INTEGER,
CODFILIALEA SMALLINT,
CODESPEC INTEGER,
CODEMPUS INTEGER,
CODFILIALUS SMALLINT,
IDUSU VARCHAR(128),
STATUSATENDO CHAR(2),
CODEMPTA INTEGER,
CODFILIALTA SMALLINT,
CODTAREFA INTEGER)
 AS
declare variable horaatendors time;
declare variable horaatendofinrs time;
declare variable dataatendors date;
BEGIN

  DATAATENDORS = NULL;

  SELECT FIRST 1 A.DATAATENDO, A.HORAATENDO, A.HORAATENDOFIN
    FROM ATATENDIMENTO A
    WHERE A.CODEMP=:CODEMP AND A.CODFILIAL=:CODFILIAL AND
        A.CODEMPAE=:CODEMPAE AND A.CODFILIALAE=:CODFILIALAE AND
        A.CODATEND=:CODATEND AND A.CODATENDO<>:CODATENDO AND
        A.DATAATENDO=:DATAATENDO AND ( (A.HORAATENDO BETWEEN :HORAATENDO+1 AND :HORAATENDOFIN-1 )
        OR (A.HORAATENDOFIN BETWEEN :HORAATENDO+1 AND :HORAATENDOFIN-1 ) )
    INTO :DATAATENDORS, :HORAATENDORS, :HORAATENDOFINRS ;

  if (DATAATENDORS IS NOT NULL) then
  begin
     exception atatendimentoex02 'Jah existe(m) lancamento(s) em '||:dataatendors||' - h.: '||
        :horaatendors||' - '||:horaatendofinrs;
  end

  if (IU = 'I') then
  begin
     SELECT ISEQ FROM SPGERANUM(:CODEMP,:CODFILIAL,'AT') INTO :CODATENDO;
     STATUSATENDO = 'AA';
     INSERT INTO ATATENDIMENTO (
        CODEMP,CODFILIAL,CODATENDO,CODEMPTO,
        CODFILIALTO,CODTPATENDO,CODEMPAE,
        CODFILIALAE,CODATEND,CODEMPSA,CODFILIALSA,
        CODSETAT,STATUSATENDO,
        CODEMPUS,CODFILIALUS, IDUSU,
        DOCATENDO, DATAATENDO,
        DATAATENDOFIN, HORAATENDO, HORAATENDOFIN, OBSATENDO, CODEMPCL, CODFILIALCL, CODCLI, CODEMPCT, CODFILIALCT,
        CODCONTR, CODITCONTR, CODEMPCH, CODFILIALCH, CODCHAMADO, obsinterno, CONCLUICHAMADO,
        CODEMPEA, CODFILIALEA, CODESPEC , CODEMPTA, CODFILIALTA, CODTAREFA )

     VALUES (
        :CODEMP, :CODFILIAL, :CODATENDO,
        :CODEMPTO, :CODFILIALTO, :CODTPATENDO,
        :CODEMPAE, :CODFILIALAE,:CODATEND,
        :CODEMPSA,:CODFILIALSA, :CODSETOR,
        :STATUSATENDO ,
        :CODEMPUS, :CODFILIALUS, lower(:IDUSU),
        :DOCATENDO, :DATAATENDO, :DATAATENDOFIN, :HORAATENDO,
        :HORAATENDOFIN, :OBSATENDO,
        :CODEMPCL, :CODFILIALCL, :CODCLI,
        :CODEMPCT, :CODFILIALCT, :CODCONTR, :CODITCONTR,
        :CODEMPCH, :CODFILIALCH, :CODCHAMADO,
        :OBSINTERNO, :CONCLUICHAMADO,
        :CODEMPEA, :CODFILIALEA, :CODESPEC , :CODEMPTA, :CODFILIALTA, :CODTAREFA
     );
  -- Caso o atendimento tenha vinculo com o contas a receber
     if (CODREC IS NOT NULL AND NPARCITREC IS NOT NULL) then
     begin
        INSERT INTO ATATENDIMENTOITREC (CODEMP,CODFILIAL,CODATENDO,CODEMPIR,CODFILIALIR,CODREC,NPARCITREC) VALUES
                (:CODEMP,:CODFILIAL,:CODATENDO,:CODEMPIR,:CODFILIALIR,:CODREC,:NPARCITREC);
     end
  end
  else if (IU = 'U') then
  begin
        UPDATE ATATENDIMENTO SET
            CODATEND=:CODATEND, DATAATENDO=:DATAATENDO, HORAATENDO=:HORAATENDO, DATAATENDOFIN=:DATAATENDOFIN,
            HORAATENDOFIN=:HORAATENDOFIN, OBSATENDO=:OBSATENDO,CODEMPTO=:CODEMPTO, CODFILIALTO=:CODFILIALTO,
            CODTPATENDO=:CODTPATENDO,CODEMPSA=:CODEMPSA, CODFILIALSA=:CODFILIALSA, CODSETAT=:CODSETOR, CODEMPCH=:CODEMPCH,
            CODFILIALCH=:CODFILIALCH, CODCHAMADO=:CODCHAMADO, CODEMPCT=:CODEMPCT, CODFILIALCT=:CODFILIALCT,
            CODCONTR=:CODCONTR, CODITCONTR=:CODITCONTR, STATUSATENDO=:STATUSATENDO, OBSINTERNO=:OBSINTERNO,
            CONCLUICHAMADO=:CONCLUICHAMADO, CODEMPEA=:CODEMPEA, CODFILIALEA=:CODFILIALEA, CODESPEC=:CODESPEC,
            CODEMPTA=:CODEMPTA, CODFILIALTA=:CODFILIALTA, CODTAREFA=:CODTAREFA,
            CODEMPCL=:CODEMPCL, CODFILIALCL=:CODFILIALCL, CODCLI=:CODCLI
        WHERE
            CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL AND CODATENDO=:CODATENDO;
  end
END
^

/* Alter (EQRELINVPRODSP) */
ALTER PROCEDURE EQRELINVPRODSP(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
CTIPOCUSTO CHAR(1),
ICODEMPGP INTEGER,
SCODFILIALGP SMALLINT,
CCODGRUP CHAR(14),
DDTESTOQ DATE,
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER)
 RETURNS(CODPROD INTEGER,
REFPROD VARCHAR(20),
DESCPROD CHAR(100),
CODGRUP CHAR(14),
SALDO NUMERIC(15,5),
CUSTO NUMERIC(15,5),
VLRESTOQ NUMERIC(15,5))
 AS
declare variable cmultialmox char(1);
declare variable ncustompm numeric(15,5);
begin
  /* Relatório de estoque */
  SELECT CMULTIALMOX FROM SGRETMULTIALMOXSP(:ICODEMP) INTO :CMULTIALMOX;

  if (CCODGRUP IS NOT NULL) then
  begin
     CCODGRUP = rtrim(CCODGRUP);
     if (strlen(CCODGRUP)<14) then
        CCODGRUP = CCODGRUP || '%';
  end
  FOR SELECT P.CODPROD, P.REFPROD, P.DESCPROD, P.CODGRUP
    FROM EQPRODUTO P
    WHERE P.CODEMP=:ICODEMP AND P.CODFILIAL=:SCODFILIAL AND
          ( ( :CCODGRUP IS NULL ) OR
            (P.CODGRUP LIKE :CCODGRUP AND P.CODEMPGP=:ICODEMPGP AND
             P.CODFILIALGP=:SCODFILIALGP) )
    INTO :CODPROD, :REFPROD, :DESCPROD, :CODGRUP DO
  BEGIN
     SELECT NSALDO, NCUSTOMPM FROM EQMOVPRODSLDSP(null, null, null, :ICODEMP,
        :SCODFILIAL, :CODPROD, :DDTESTOQ, 0, 0,
        :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
       INTO :SALDO, :NCUSTOMPM;
     if (CTIPOCUSTO='M') then
        CUSTO = NCUSTOMPM;
     else
        SELECT NCUSTOPEPS FROM EQCALCPEPSSP(:ICODEMP, :SCODFILIAL, :CODPROD,
          :SALDO, :DDTESTOQ, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX)
        INTO :CUSTO;
     VLRESTOQ = CUSTO * SALDO;
     SUSPEND;
  END
end
^

/* Alter (EQRELPEPSSP) */
ALTER PROCEDURE EQRELPEPSSP(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
DTESTOQ DATE,
ICODEMPMC INTEGER,
SCODFILIALMC SMALLINT,
CCODMARCA CHAR(6),
ICODEMPGP INTEGER,
SCODFILIALGP SMALLINT,
CCODGRUP VARCHAR(14),
CTIPOCUSTO CHAR(1),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER)
 RETURNS(CODPROD INTEGER,
REFPROD VARCHAR(20),
DESCPROD CHAR(100),
SLDPROD NUMERIC(15,5),
CUSTOUNIT NUMERIC(15,5),
CUSTOTOT NUMERIC(15,5),
CODBARPROD CHAR(13),
CODFABPROD CHAR(15),
ATIVOPROD CHAR(1),
CODUNID CHAR(20),
TIPOPROD VARCHAR(2),
CODNCM VARCHAR(10),
EXTIPI CHAR(2),
COD_GEN CHAR(2),
CODSERV CHAR(5),
ALIQ_ICMS NUMERIC(9,2))
 AS
begin

  /* procedure text */

  if (icodempgp is not null) then
  begin
    if (strlen(rtrim(ccodgrup))<14) then
       ccodgrup = rtrim(ccodgrup)||'%';
  end

  if (ctipocusto is null) then
     ctipocusto = 'P';

  for select p.codprod,p.refprod,p.descprod, p.codbarprod
     , p.codfabprod, p.ativoprod, p.codunid, p.tipoprod
     , fc.codncm, fc.extipi
     , substring(fc.codncm from 1 for 2) cod_gen
     , fc.codserv,
      (select first 1 ifc.aliqfisc from lfitclfiscal ifc where ifc.codemp=fc.codemp and ifc.codfilial=fc.codfilial and
      ifc.geralfisc='S' and ifc.noufitfisc='S') aliq_icms

   from eqproduto p
   left outer join lfclfiscal fc
     on fc.codemp=p.codempfc and fc.codfilial=p.codfilialfc and fc.codfisc=p.codfisc
   where p.codemp = :icodemp and p.codfilial = :scodfilial and
   ( (:icodempmc is null) or (p.codempmc=:icodempmc and p.codfilialmc=:scodfilialmc and
      p.codmarca=:ccodmarca) ) and
   ((:icodempgp is null) or (p.codempgp=:icodempgp and p.codfilialgp=:scodfilialgp and
      p.codgrup like :ccodgrup) )
      order by p.codprod

   into :codprod, :refprod, :descprod, :codbarprod, :codfabprod
   , :ativoprod, :codunid, :tipoprod
   , :codncm, :extipi, :cod_gen, :codserv, :aliq_icms  do

  begin

     select sldprod, custounit, custotot from eqcustoprodsp(:icodemp,
        :scodfilial, :codprod, :dtestoq, :ctipocusto, :icodempax,
        :scodfilialax, :icodalmox, 'S')
       into :sldprod, :custounit, :custotot;
     suspend;

  end

end
^

/* Alter (FNSALDOPLANSP) */
ALTER PROCEDURE FNSALDOPLANSP(ICODEMPPN INTEGER,
ICODFILIALPN INTEGER,
SCODPLANANT CHAR(13),
DDATAANT DATE,
DVLRANT NUMERIC(15,5),
SCODPLANATU CHAR(13),
DDATAATU DATE,
DVLRATU NUMERIC(15,5))
 RETURNS(SRETORNO CHAR(1))
 AS
DECLARE VARIABLE sCodPlan CHAR(13);
  DECLARE VARIABLE dDataSl DATE;
  DECLARE VARIABLE dTmp DATE;
  DECLARE VARIABLE dSaldoSl NUMERIC(15, 5);
  DECLARE VARIABLE dSaldoSlAnt NUMERIC(15, 5);
  DECLARE VARIABLE IFILIALSALDO INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMPPN,'FNSALDOLANCA') INTO IFILIALSALDO;
  IF (dVlrAnt IS NULL) THEN
     dVlrAnt = 0;
  IF (dVlrAtu IS NULL) THEN
     dVlrAtu = 0;
  IF ((sCodPlanAnt IS NOT NULL) AND (rtrim(sCodPlanAnt) != '')) THEN
  BEGIN
    SELECT CODPLAN,DATASL,SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodPlanAnt
           AND DATASL =: dDataAnt AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
           AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO sCodPlan,dDataSl,dSaldoSl;
    IF ((sCodPlan = sCodPlanAnt) AND (dDataSl = dDataAnt)) THEN
    BEGIN
      UPDATE FNSALDOLANCA SET SALDOSL =:dSaldoSl-:dVlrAnt WHERE CODPLAN=:sCodPlanAnt
             AND DATASL =:dDataAnt AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
             AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN;
      FOR SELECT DATASL,SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodplanAnt
          AND DATASL >:dDataAnt AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
          AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO :dTmp,:dSaldoSlAnt DO
      BEGIN
         if (:dSaldoSlAnt IS NULL) THEN
            dSaldoSlAnt = 0;
         UPDATE FNSALDOLANCA SET SALDOSL = :dSaldoSlAnt-:dVlrAnt WHERE CODPLAN=:sCodplanAnt
                AND DATASL =:dTmp AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
                AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN;
        SUSPEND;
      END
    END
    ELSE
    BEGIN
      SELECT SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodPlanAnt
             AND DATASL<:dDataAnt AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
             AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO dSaldoSlAnt;
      IF (dSaldoSlAnt IS NULL) THEN
          dSaldoSlAnt = 0;
      INSERT INTO FNSALDOLANCA (CODEMP,CODFILIAL,CODPLAN,CODFILIALPN,CODEMPPN,DATASL,PREVSL,SALDOSL)
             VALUES (
                    :ICODEMPPN,:IFILIALSALDO,:sCodPlanAnt,:ICODEMPPN,:ICODFILIALPN,:dDataAnt,0,:dSaldoSlAnt-:dVlrAnt
             );
      FOR SELECT DATASL,SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodplanAnt
                 AND DATASL >:dDataAnt AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
                 AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO :dTmp,:dSaldoSlAnt DO
      BEGIN
        if (:dSaldoSlAnt IS NULL) THEN
           dSaldoSlAnt = 0;
        UPDATE FNSALDOLANCA SET SALDOSL = :dSaldoSlAnt-:dVlrAnt WHERE CODPLAN=:sCodplanAnt
               AND DATASL =:dTmp AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
               AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN;
        SUSPEND;
      END
    END
  END
  IF ( (sCodPlanAtu IS NOT NULL) AND (rtrim(sCodPlanAtu) != '')) THEN
  BEGIN
    SELECT CODPLAN,DATASL,SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodPlanAtu
           AND DATASL =: dDataAtu AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
  AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO sCodPlan,dDataSl,dSaldoSl;
    IF ((sCodPlan = sCodPlanAtu) AND (dDataSl = dDataAtu)) THEN
    BEGIN
      UPDATE FNSALDOLANCA SET SALDOSL =:dSaldoSl+:dVlrAtu WHERE CODPLAN=:sCodPlanAtu
             AND DATASL =:dDataAtu AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
             AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN;
      FOR SELECT DATASL,SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodplanAtu
                 AND DATASL >:dDataAtu AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
                 AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO :dTmp,:dSaldoSlAnt DO
      BEGIN
        if (:dSaldoSlAnt IS NULL) THEN
           dSaldoSlAnt = 0;
        UPDATE FNSALDOLANCA SET SALDOSL = :dSaldoSlAnt+:dVlrAtu WHERE CODPLAN=:sCodplanAtu
               AND DATASL =:dTmp AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
               AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN;
        SUSPEND;
      END
    END
    ELSE
    BEGIN
      SELECT SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodPlanAtu
             AND DATASL<:dDataAtu AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
             AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO dSaldoSlAnt;
      IF (dSaldoSlAnt IS NULL) THEN
          dSaldoSlAnt = 0;
      INSERT INTO FNSALDOLANCA (CODEMP,CODFILIAL,CODPLAN,CODEMPPN,CODFILIALPN,DATASL,PREVSL,SALDOSL)
             VALUES (
                    :ICODEMPPN,:IFILIALSALDO,:sCodPlanAtu,:ICODEMPPN,:ICODFILIALPN,:dDataAtu,0,:dSaldoSlAnt+:dVlrAtu
             );
      FOR SELECT DATASL,SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodplanAtu
                 AND DATASL >:dDataAtu AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
                 AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO :dTmp,:dSaldoSlAnt DO
      BEGIN
        if (:dSaldoSlAnt IS NULL) THEN
           dSaldoSlAnt = 0;
        UPDATE FNSALDOLANCA SET SALDOSL = :dSaldoSlAnt+:dVlrAtu WHERE CODPLAN=:sCodplanAtu
               AND DATASL =:dTmp AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
               AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN;
        SUSPEND;
      END
    END
  END
  SUSPEND;
END
^

/* empty dependent procedure body */
/* Clear: LFGERALFITCOMPRASP for: LFBUSCAFISCALSP02 */
/* AssignEmptyBody proc */
ALTER PROCEDURE LFGERALFITCOMPRASP(CODEMP INTEGER,
CODFILIAL SMALLINT,
CODCOMPRA INTEGER,
CODITCOMPRA SMALLINT)
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: LFGERALFITVENDASP for: LFBUSCAFISCALSP02 */
/* AssignEmptyBody proc */
ALTER PROCEDURE LFGERALFITVENDASP(CODEMP INTEGER,
CODFILIAL SMALLINT,
CODVENDA INTEGER,
TIPOVENDA CHAR(2),
CODITVENDA SMALLINT)
 AS
 BEGIN EXIT; END
^

/* Alter (LFBUSCAFISCALSP02) */
ALTER PROCEDURE LFBUSCAFISCALSP02(CODEMP INTEGER,
CODFILIAL SMALLINT,
CODVENDA INTEGER,
TIPOVENDA CHAR(1),
CODITVENDA SMALLINT,
CODCOMPRA INTEGER,
CODITCOMPRA SMALLINT)
 RETURNS(VLRBASEPIS NUMERIC(15,5),
VLRBASECOFINS NUMERIC(15,5),
VLRPIS NUMERIC(15,5),
VLRCOFINS NUMERIC(15,5),
VLRIR NUMERIC(15,5),
VLRCSOCIAL NUMERIC(15,5),
VLRIPIIT NUMERIC(15,5))
 AS
declare variable codempif integer;
declare variable codfilialif smallint;
declare variable codfisc char(13);
declare variable coditfisc integer;
declare variable codsittribpis char(2);
declare variable codsittribcof char(2);
declare variable vlrpisunidtrib numeric(15,5);
declare variable vlrcofunidtrib numeric(15,5);
declare variable vlrprodit numeric(15,5);
declare variable aliqpis numeric(6,2);
declare variable qtdit numeric(15,5);
declare variable aliqcofins numeric(6,2);
declare variable aliqir numeric(15,5);
declare variable aliqcsocial numeric(15,5);
declare variable vlrliqit numeric(15,5);
declare variable vlrfreteit numeric(15,5);
declare variable vlrdescit numeric(15,5);
begin

    -- Busca de regra de classificação fiscal da venda
    if(codvenda is not null and codcompra is null) then
    begin

        select li.codsittribpis,li.codsittribcof,iv.vlrproditvenda,li.aliqpisfisc,li.vlrpisunidtrib,
        iv.qtditvenda,li.aliqcofinsfisc,coalesce(li.aliqirfisc,fi.percirfilial),coalesce(li.aliqcsocialfisc, fi.perccsocialfilial),
        iv.vlrliqitvenda, coalesce(iv.vlripiitvenda,0) vlripiitvenda, coalesce(iv.vlrfreteitvenda,0) vlrfreteitvenda,
        coalesce(iv.vlrdescitvenda,0) vlrdescitvenda
        from vditvenda iv left outer join lfitclfiscal li on
        li.codemp=iv.codempif and li.codfilial=iv.codfilialif and li.codfisc=iv.codfisc and li.coditfisc=iv.coditfisc
        left outer join sgfilial fi on
        fi.codemp=iv.codemp and fi.codfilial=iv.codfilial
        where
        iv.codemp=:codemp and iv.codfilial=:codfilial and iv.codvenda=:codvenda and iv.tipovenda=:tipovenda and iv.coditvenda=:coditvenda
        into
        :CODSITTRIBPIS,:CODSITTRIBCOF,:VLRPRODIT,:ALIQPIS,:VLRPISUNIDTRIB,:QTDIT,
        :ALIQCOFINS,:ALIQIR,:ALIQCSOCIAL,:VLRLIQIT,:VLRIPIIT, :VLRFRETEIT, :VLRDESCIT;
    end
    -- Busca de regra de classificação fiscal da compra
    else if(codvenda is null and codcompra is not null) then
    begin

       select li.codsittribpis,li.codsittribcof,ic.vlrproditcompra,li.aliqpisfisc,li.vlrpisunidtrib,
        ic.qtditcompra,li.aliqcofinsfisc,coalesce(li.aliqirfisc,fi.percirfilial),coalesce(li.aliqcsocialfisc, fi.perccsocialfilial),
        ic.vlrliqitcompra, coalesce(ic.vlripiitcompra,0) vlripiit, coalesce(ic.vlrfreteitcompra,0) vlrfreteit,
        coalesce(ic.vlrdescitcompra,0) vlrdescit
        from cpitcompra ic left outer join lfitclfiscal li on
        li.codemp=ic.codempif and li.codfilial=ic.codfilialif and li.codfisc=ic.codfisc and li.coditfisc=ic.coditfisc
        left outer join sgfilial fi on
        fi.codemp=ic.codemp and fi.codfilial=ic.codfilial
        where
        ic.codemp=:codemp and ic.codfilial=:codfilial and ic.codcompra=:codcompra and ic.coditcompra=:coditcompra
        into
        :CODSITTRIBPIS,:CODSITTRIBCOF,:VLRPRODIT,:ALIQPIS,:VLRPISUNIDTRIB,:QTDIT,
        :ALIQCOFINS,:ALIQIR,:ALIQCSOCIAL,:VLRLIQIT,:VLRIPIIT, :VLRFRETEIT, :VLRDESCIT;

    end

    -- Definição do PIS

    if(:CODSITTRIBPIS in ('01','02','99')) then -- PIS Tributado pela alíquota
    begin
        vlrbasepis = :vlrprodit - :vlrdescit; -- (Base do PIS = Valor total dos produtos - Implementar situações distintas futuramente)
        vlrpis = (vlrbasepis * aliqpis) / 100;
    end
    else if (:CODSITTRIBPIS in ('03')) then -- PIS Tributado pela quantidade
    begin
        vlrpis = qtdit * vlrpisunidtrib;
    end

    -- Definição do COFINS

    if(:CODSITTRIBCOF in ('01','02','99')) then -- COFINS Tributado pela alíquota
    begin
        vlrbasecofins = :vlrprodit - :vlrdescit; -- (Base do COFINS = Valor total dos produtos - Implementar situações distintas futuramente)
        vlrcofins = (vlrbasecofins * aliqcofins) / 100;
    end
    else if (:CODSITTRIBPIS in ('03')) then -- COFINS Tributado pela quantidade
    begin
        vlrcofins = qtdit * vlrcofunidtrib;
    end

    -- Definição do IR

    vlrir = ((:VLRLIQIT + :VLRIPIIT + :VLRFRETEIT) * aliqir) / 100;

    -- Definição da CSocial

    vlrcsocial = ((:VLRLIQIT + :VLRIPIIT + :VLRFRETEIT) * aliqcsocial) / 100;

  suspend;
end
^

/* Alter (LFGERALFITCOMPRASP) */
ALTER PROCEDURE LFGERALFITCOMPRASP(CODEMP INTEGER,
CODFILIAL SMALLINT,
CODCOMPRA INTEGER,
CODITCOMPRA SMALLINT)
 AS
declare variable temitem char(1);
declare variable codempsp integer;
declare variable codfilialsp smallint;
declare variable impsittribpis char(2);
declare variable codsittribpis char(2);
declare variable aliqpisfisc numeric(15,5);
declare variable vlrbasepis numeric(15,5);
declare variable vlrpis numeric(15,5);
declare variable vlrpisunidtrib numeric(15,5);
declare variable codempsc integer;
declare variable codfilialsc smallint;
declare variable impsittribcof char(2);
declare variable codsittribcof char(2);
declare variable aliqcofins numeric(15,5);
declare variable vlrbasecofins numeric(15,5);
declare variable vlrcofins numeric(15,5);
declare variable vlrcofunidtrib numeric(15,5);
declare variable vlrbaseicmsstitcompra numeric(15,5);
declare variable vlricmsstitcompra numeric(15,5);
declare variable codempsi integer;
declare variable codfilialsi smallint;
declare variable impsittribipi char(2);
declare variable codsittribipi char(2);
declare variable vlripiunidtrib numeric(15,5);
declare variable modbcicms smallint;
declare variable modbcicmsst smallint;
declare variable redfisc numeric(9,2);
declare variable aliqfisc integer;
declare variable vlrir numeric(15,5);
declare variable vlrcsocial numeric(15,5);
declare variable uffor char(2);
declare variable percicmsst numeric(15,5);
declare variable codempif integer;
declare variable codfilialif smallint;
declare variable codfisc char(13);
declare variable coditfisc integer;
declare variable codnat char(4);
declare variable codtrattrib char(2);
declare variable origfisc char(1);
begin

    -- Inserindo informações fiscais na tabela LFITCOMPRA

    select 'S'
    from lfitcompra
    where codemp=:codemp and codfilial=:codfilial and codcompra=:codcompra and coditcompra=:coditcompra
    into :temitem;

    select
    li.codempsp,li.codfilialsp,li.impsittribpis,li.codsittribpis,li.aliqpisfisc,bf.vlrbasepis,bf.vlrpis,li.vlrpisunidtrib,
    li.codempsc,li.codfilialsc,li.impsittribcof,li.codsittribcof,li.aliqcofinsfisc,bf.vlrbasecofins,bf.vlrcofins,li.vlrcofunidtrib,
    li.codempsi,li.codfilialsi,li.impsittribipi,li.codsittribipi,li.vlripiunidtrib,
    li.modbcicms,li.modbcicmsst,li.redfisc,li.aliqfisc,bf.vlrir,bf.vlrcsocial, li.codtrattrib, li.origfisc, ic.vlrbaseicmsstitcompra, ic.vlricmsstitcompra
    from lfbuscafiscalsp02(:CODEMP,:CODFILIAL,null,null,null,:codcompra,:coditcompra) bf
    left outer join cpitcompra ic on ic.codemp=:CODEMP and ic.codfilial=:CODFILIAL and ic.codcompra=:codcompra and ic.coditcompra=:coditcompra
    left outer join lfitclfiscal li on li.codemp=ic.codempif and li.codfilial=ic.codfilialif and li.codfisc=ic.codfisc and li.coditfisc=ic.coditfisc
    into
    :CODEMPSP,:CODFILIALSP,:IMPSITTRIBPIS,:CODSITTRIBPIS,:ALIQPISFISC,:VLRBASEPIS,:VLRPIS,:VLRPISUNIDTRIB,
    :CODEMPSC,:CODFILIALSC,:IMPSITTRIBCOF,:CODSITTRIBCOF,:ALIQCOFINS,:VLRBASECOFINS,:VLRCOFINS,:VLRCOFUNIDTRIB,
    :CODEMPSI,:CODFILIALSI,:IMPSITTRIBIPI,:CODSITTRIBIPI,:VLRIPIUNIDTRIB,
    :MODBCICMS,:MODBCICMSST,:REDFISC,:ALIQFISC,:VLRIR,:VLRCSOCIAL,:codtrattrib,:origfisc, :VLRBASEICMSSTITCOMPRA, :VLRICMSSTITCOMPRA;

    -- Buscando estado do fornecedor
    select coalesce(fr.siglauf,fr.uffor), ic.codempif, ic.codfilialif, ic.codfisc, ic.coditfisc, ic.codnat from cpforneced fr, cpcompra cp
    left outer join cpitcompra ic on ic.codemp=cp.codemp and ic.codfilial=cp.codfilial and ic.codcompra=cp.codcompra and ic.coditcompra=:coditcompra
    where cp.codemp=:codemp and cp.codfilial=:codfilial and cp.codcompra=:codcompra and
    fr.codemp=cp.codempfr and fr.codfilial=cp.codfilialfr and fr.codfor=cp.codfor
    into uffor,codempif, codfilialif, codfisc, coditfisc, codnat;

    -- Buscando aliquota do ICMS ST da tabela de classificação fiscal
    select coalesce(ic.aliqfiscintra,0) from lfitclfiscal ic
    where ic.codemp=:codempif and ic.codfilial=:codfilialif and ic.codfisc=:codfisc and ic.coditfisc=:coditfisc
    into PERCICMSST;

    -- Buscando aliquota do ICMS ST da tabela de alíquotas (caso não encontre na busca naterior)
    if (percicmsst = 0) then
    begin
        select coalesce(PERCICMSINTRA,0) from lfbuscaicmssp (:codnat,:uffor,:codemp,:codfilial)
        into PERCICMSST;
    end

    if(:TEMITEM='S') then
    begin
            update lfitcompra set codempsp=:CODEMPSP,codfilialsp=:CODFILIALSP,impsittribpis=:IMPSITTRIBPIS,
            codsittribpis=:CODSITTRIBPIS,aliqpis=:ALIQPISFISC,vlrbasepis=:VLRBASEPIS,vlrpis=:VLRPIS,vlrpisunidtrib=:VLRPISUNIDTRIB,
            codempsc=:CODEMPSC,codfilialsc=:CODFILIALSC,impsittribcof=:IMPSITTRIBCOF,codsittribcof=:CODSITTRIBCOF,aliqcofins=:ALIQCOFINS,
            vlrbasecofins=:VLRBASECOFINS,vlrcofins=:VLRCOFINS,vlrcofunidtrib=:VLRCOFUNIDTRIB,
            codempsi=:CODEMPSI,codfilialsi=:CODFILIALSI,impsittribipi=:IMPSITTRIBIPI,codsittribipi=:CODSITTRIBIPI,vlripiunidtrib=:VLRIPIUNIDTRIB,
            modbcicms=:MODBCICMS,modbcicmsst=:MODBCICMSST,aliqredbcicms=:REDFISC,aliqredbcicmsst=:REDFISC,aliqicmsst=:percicmsst,
            vlrir=:VLRIR,vlrcsocial=:VLRCSOCIAL, vlrbaseicmsstitcompra=:vlrbaseicmsstitcompra, vlricmsstitcompra=:vlricmsstitcompra
            where codemp=:codemp and codfilial=:codfilial and codcompra=:codcompra and coditcompra=:coditcompra;
    end
    else
    begin
        insert into lfitcompra (codemp,codfilial,codcompra,coditcompra,
            codempsp,codfilialsp,impsittribpis,codsittribpis,aliqpis,vlrbasepis,vlrpis,vlrpisunidtrib,
            codempsc,codfilialsc,impsittribcof,codsittribcof,aliqcofins,vlrbasecofins,vlrcofins,vlrcofunidtrib,
            codempsi,codfilialsi,impsittribipi,codsittribipi,vlripiunidtrib,
            modbcicms,modbcicmsst,aliqredbcicms,aliqredbcicmsst,aliqicmsst,vlrir,vlrcsocial,codtrattrib,origfisc,
            vlrbaseicmsstitcompra, vlricmsstitcompra)
        values(:CODEMP,:CODFILIAL,:CODcompra,:CODITcompra,
        :CODEMPSP,:CODFILIALSP,:IMPSITTRIBPIS,:CODSITTRIBPIS,:ALIQPISFISC,:VLRBASEPIS,:VLRPIS,:VLRPISUNIDTRIB,
        :CODEMPSC,:CODFILIALSC,:IMPSITTRIBCOF,:CODSITTRIBCOF,:ALIQCOFINS,:VLRBASECOFINS,:VLRCOFINS,:VLRCOFUNIDTRIB,
        :CODEMPSI,:CODFILIALSI,:IMPSITTRIBIPI,:CODSITTRIBIPI,:VLRIPIUNIDTRIB,
        :MODBCICMS,:MODBCICMSST,:REDFISC,:REDFISC,:percicmsst,:VLRIR,:VLRCSOCIAL, :codtrattrib, :origfisc,
        :VLRBASEICMSSTITCOMPRA, :VLRICMSSTITCOMPRA );

    end
  suspend;
end
^

/* Alter (LFGERALFITVENDASP) */
ALTER PROCEDURE LFGERALFITVENDASP(CODEMP INTEGER,
CODFILIAL SMALLINT,
CODVENDA INTEGER,
TIPOVENDA CHAR(2),
CODITVENDA SMALLINT)
 AS
declare variable temitem char(1);
declare variable codempsp integer;
declare variable codfilialsp smallint;
declare variable impsittribpis char(2);
declare variable codsittribpis char(2);
declare variable aliqpisfisc numeric(15,5);
declare variable vlrbasepis numeric(15,5);
declare variable vlrpis numeric(15,5);
declare variable vlrpisunidtrib numeric(15,5);
declare variable codempsc integer;
declare variable codfilialsc smallint;
declare variable impsittribcof char(2);
declare variable codsittribcof char(2);
declare variable aliqcofins numeric(15,5);
declare variable vlrbasecofins numeric(15,5);
declare variable vlrcofins numeric(15,5);
declare variable vlrcofunidtrib numeric(15,5);
declare variable codempsi integer;
declare variable codfilialsi smallint;
declare variable impsittribipi char(2);
declare variable codsittribipi char(2);
declare variable vlripiunidtrib numeric(15,5);
declare variable modbcicms smallint;
declare variable modbcicmsst smallint;
declare variable redfisc numeric(9,2);
declare variable aliqfisc integer;
declare variable vlrir numeric(15,5);
declare variable vlrcsocial numeric(15,5);
declare variable ufcli char(2);
declare variable percicmsst numeric(15,5);
declare variable codempif integer;
declare variable codfilialif smallint;
declare variable codfisc char(13);
declare variable coditfisc integer;
declare variable codnat char(4);
begin

    -- Inserindo informações fiscais na tabela LFITVENDA

    select 'S'
    from lfitvenda
    where codemp=:codemp and codfilial=:codfilial and codvenda=:codvenda and tipovenda=:tipovenda and coditvenda=:coditvenda
    into :temitem;

    select
    li.codempsp,li.codfilialsp,li.impsittribpis,li.codsittribpis,li.aliqpisfisc,bf.vlrbasepis,bf.vlrpis,li.vlrpisunidtrib,
    li.codempsc,li.codfilialsc,li.impsittribcof,li.codsittribcof,li.aliqcofinsfisc,bf.vlrbasecofins,bf.vlrcofins,li.vlrcofunidtrib,
    li.codempsi,li.codfilialsi,li.impsittribipi,li.codsittribipi,li.vlripiunidtrib,
    li.modbcicms,li.modbcicmsst,li.redfisc,li.aliqfisc,bf.vlrir,bf.vlrcsocial
    from lfbuscafiscalsp02(:CODEMP,:CODFILIAL,:CODVENDA,:TIPOVENDA,:CODITVENDA, null, null) bf
    left outer join vditvenda iv on iv.codemp=:CODEMP and iv.codfilial=:CODFILIAL and iv.codvenda=:CODVENDA and iv.tipovenda=:TIPOVENDA and iv.coditvenda=:CODITVENDA
    left outer join lfitclfiscal li on li.codemp=iv.codempif and li.codfilial=iv.codfilialif and li.codfisc=iv.codfisc and li.coditfisc=iv.coditfisc
    into
    :CODEMPSP,:CODFILIALSP,:IMPSITTRIBPIS,:CODSITTRIBPIS,:ALIQPISFISC,:VLRBASEPIS,:VLRPIS,:VLRPISUNIDTRIB,
    :CODEMPSC,:CODFILIALSC,:IMPSITTRIBCOF,:CODSITTRIBCOF,:ALIQCOFINS,:VLRBASECOFINS,:VLRCOFINS,:VLRCOFUNIDTRIB,
    :CODEMPSI,:CODFILIALSI,:IMPSITTRIBIPI,:CODSITTRIBIPI,:VLRIPIUNIDTRIB,
    :MODBCICMS,:MODBCICMSST,:REDFISC,:ALIQFISC,:VLRIR,:VLRCSOCIAL;


    -- Buscando estado do cliente
    select coalesce(cl.siglauf,cl.ufcli), iv.codempif, iv.codfilialif, iv.codfisc, iv.coditfisc, iv.codnat from vdcliente cl, vdvenda vd
    left outer join vditvenda iv on iv.codemp=vd.codemp and iv.codfilial=vd.codfilial and iv.codvenda=vd.codvenda and iv.tipovenda=vd.tipovenda and iv.coditvenda=:coditvenda
    where vd.codemp=:codemp and vd.codfilial=:codfilial and vd.codvenda=:codvenda and vd.tipovenda=:tipovenda and
    cl.codemp=vd.codempcl and cl.codfilial=vd.codfilialcl and cl.codcli=vd.codcli
    into ufcli,codempif, codfilialif, codfisc, coditfisc, codnat;

    -- Buscando aliquota do ICMS ST da tabela de classificação fiscal
    select coalesce(ic.aliqfiscintra,0) from lfitclfiscal ic
    where ic.codemp=:codempif and ic.codfilial=:codfilialif and ic.codfisc=:codfisc and ic.coditfisc=:coditfisc
    into PERCICMSST;

    -- Buscando aliquota do ICMS ST da tabela de alíquotas (caso não encontre na busca naterior)
    if (percicmsst = 0) then
    begin
        select coalesce(PERCICMSINTRA,0) from lfbuscaicmssp (:codnat,:ufcli,:codemp,:codfilial)
        into PERCICMSST;
    end

    if(:TEMITEM='S') then
    begin
            update lfitvenda set codempsp=:CODEMPSP,codfilialsp=:CODFILIALSP,impsittribpis=:IMPSITTRIBPIS,
            codsittribpis=:CODSITTRIBPIS,aliqpis=:ALIQPISFISC,vlrbasepis=:VLRBASEPIS,vlrpis=:VLRPIS,vlrpisunidtrib=:VLRPISUNIDTRIB,
            codempsc=:CODEMPSC,codfilialsc=:CODFILIALSC,impsittribcof=:IMPSITTRIBCOF,codsittribcof=:CODSITTRIBCOF,aliqcofins=:ALIQCOFINS,
            vlrbasecofins=:VLRBASECOFINS,vlrcofins=:VLRCOFINS,vlrcofunidtrib=:VLRCOFUNIDTRIB,
            codempsi=:CODEMPSI,codfilialsi=:CODFILIALSI,impsittribipi=:IMPSITTRIBIPI,codsittribipi=:CODSITTRIBIPI,vlripiunidtrib=:VLRIPIUNIDTRIB,
            modbcicms=:MODBCICMS,modbcicmsst=:MODBCICMSST,aliqredbcicms=:REDFISC,aliqredbcicmsst=:REDFISC,aliqicmsst=:percicmsst,
            vlrir=:VLRIR,vlrcsocial=:VLRCSOCIAL
            where codemp=:codemp and codfilial=:codfilial and codvenda=:codvenda and tipovenda=:tipovenda and coditvenda=:coditvenda;
    end
    else
    begin
        insert into lfitvenda (codemp,codfilial,codvenda,tipovenda,coditvenda,
            codempsp,codfilialsp,impsittribpis,codsittribpis,aliqpis,vlrbasepis,vlrpis,vlrpisunidtrib,
            codempsc,codfilialsc,impsittribcof,codsittribcof,aliqcofins,vlrbasecofins,vlrcofins,vlrcofunidtrib,
            codempsi,codfilialsi,impsittribipi,codsittribipi,vlripiunidtrib,
            modbcicms,modbcicmsst,aliqredbcicms,aliqredbcicmsst,aliqicmsst,vlrir,vlrcsocial)
        values(:CODEMP,:CODFILIAL,:CODVENDA,:TIPOVENDA,:CODITVENDA,
        :CODEMPSP,:CODFILIALSP,:IMPSITTRIBPIS,:CODSITTRIBPIS,:ALIQPISFISC,:VLRBASEPIS,:VLRPIS,:VLRPISUNIDTRIB,
        :CODEMPSC,:CODFILIALSC,:IMPSITTRIBCOF,:CODSITTRIBCOF,:ALIQCOFINS,:VLRBASECOFINS,:VLRCOFINS,:VLRCOFUNIDTRIB,
        :CODEMPSI,:CODFILIALSI,:IMPSITTRIBIPI,:CODSITTRIBIPI,:VLRIPIUNIDTRIB,
        :MODBCICMS,:MODBCICMSST,:REDFISC,:REDFISC,:percicmsst,:VLRIR,:VLRCSOCIAL);

    end

  suspend;
end
^

/* Alter (PPRELCUSTOSP) */
ALTER PROCEDURE PPRELCUSTOSP(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
DTESTOQ DATE,
ICODEMPMC INTEGER,
SCODFILIALMC SMALLINT,
CCODMARCA CHAR(6),
ICODEMPGP INTEGER,
SCODFILIALGP SMALLINT,
CCODGRUP CHAR(14),
CTIPOCUSTO CHAR(1),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER)
 RETURNS(CODPROD INTEGER,
REFPROD VARCHAR(20),
DESCPROD CHAR(100),
TIPOPROD VARCHAR(2),
SLDPROD NUMERIC(15,5),
CUSTOUNIT NUMERIC(15,5),
CUSTOTOT NUMERIC(15,5))
 AS
begin
  /* Procedure Text */
  IF (ICODEMPGP IS NOT NULL) THEN
  BEGIN
    IF (STRLEN(RTRIM(CCODGRUP))<14) THEN
       CCODGRUP = RTRIM(CCODGRUP)||'%';
  END
  IF (CTIPOCUSTO IS NULL) then
     CTIPOCUSTO = 'P';

  FOR SELECT P.CODPROD,P.REFPROD,P.DESCPROD, P.TIPOPROD
   FROM EQPRODUTO P
   WHERE P.CODEMP = :ICODEMP AND P.CODFILIAL = :SCODFILIAL AND
   ( (:ICODEMPMC IS NULL) OR (P.CODEMPMC=:ICODEMPMC AND P.CODFILIALMC=:SCODFILIALMC AND
      P.CODMARCA=:CCODMARCA) ) AND
   ((:ICODEMPGP IS NULL) OR (P.CODEMPGP=:ICODEMPGP AND P.CODFILIALGP=:SCODFILIALGP AND
      P.CODGRUP LIKE :CCODGRUP) )
   INTO :CODPROD, :REFPROD, :DESCPROD, :TIPOPROD  DO
  BEGIN
     SELECT CUSTOUNIT,SLDPROD FROM PPCUSTOPRODSP(:ICODEMP,
        :SCODFILIAL, :CODPROD, :DTESTOQ, :CTIPOCUSTO, :ICODEMPAX,
        :SCODFILIALAX, :ICODALMOX, 'N')
       INTO :CUSTOUNIT, :SLDPROD;
     CUSTOTOT = CUSTOUNIT * SLDPROD;
     SUSPEND;
  END
end
^

/* empty dependent procedure body */
/* Clear: SGATUALIZABDSP for: SGGRANTUSERSP */
/* AssignEmptyBody proc */
ALTER PROCEDURE SGATUALIZABDSP(ICODEMP INTEGER)
 AS
 BEGIN EXIT; END
^

/* Alter (SGGRANTUSERSP) */
ALTER PROCEDURE SGGRANTUSERSP AS
DECLARE VARIABLE CIDGRPUSU CHAR(8);
DECLARE VARIABLE CIDUSU CHAR(8);
DECLARE VARIABLE CSQL VARCHAR(200);
begin
  FOR SELECT DISTINCT IDGRPUSU, IDUSU FROM SGUSUARIO
     INTO :CIDGRPUSU, :CIDUSU DO
  BEGIN
      CSQL = 'GRANT '||RTRIM(CIDGRPUSU)||' TO USER '||RTRIM(CIDUSU);
      EXECUTE STATEMENT CSQL;
  END
  suspend;
end
^

/* Alter (SGINICONSP) */
ALTER PROCEDURE SGINICONSP(ICODEMP INTEGER,
CIDUSU CHAR(8),
ICODFILIALSEL SMALLINT,
ICODTERM SMALLINT)
 RETURNS(SRET SMALLINT)
 AS
DECLARE VARIABLE ICONECTADO INTEGER;
DECLARE VARIABLE ICODFILIALSELCX SMALLINT;
DECLARE VARIABLE ICODEMPTMP INTEGER;
DECLARE VARIABLE ICODFILIAL SMALLINT;
begin
  /* Procedure para inicialização da conexão com o banco de dados */
  SRET = 0;
  if (ICODEMP IS NULL) then
     ICODEMP = 99;
  /*CTEMP = printLog('Vai verificar o usuário');*/
  CIDUSU = lower(CIDUSU);
  IF ( CIDUSU='sysdba' ) THEN
  BEGIN
/*     CTEMP = printLog('Usuário sysdba');*/

     SELECT CODEMP FROM SGEMPRESA WHERE CODEMP=:ICODEMP INTO :ICODEMPTMP;
     IF (ICODEMPTMP IS NULL) THEN
        EXECUTE PROCEDURE SGATUALIZABDSP(:ICODEMP);
  END
  SELECT CODFILIAL FROM SGUSUARIO WHERE IDUSU=:cIdUsu AND
      CODEMP=:ICODEMP  INTO :iCodFilial;
/*  CTEMP = printLog('O usuário é = '||cIdUsu); */

/*  CTEMP = printLog('Contador de usuários '||cIdUsu); */

  if (iCodFilial is null) then
    EXCEPTION SGCONEXAOEX02;

  if (iCodFilialSel is not null) then
  begin
      SRET = 1;
      SELECT CONECTADO, CODFILIALSEL FROM SGCONEXAO
        WHERE NRCONEXAO=CURRENT_CONNECTION INTO :iConectado, iCodFilialSelCX;
      if (iConectado is null) then
          INSERT INTO SGCONEXAO (NRCONEXAO, CODEMP,CODFILIAL,IDUSU,CODFILIALSEL,CONECTADO,CODTERM)
            VALUES (CURRENT_CONNECTION, :iCodemp, :iCodfilial, :cIdusu, :iCodfilialSel, 1, :iCodTerm);
      else
      begin
          if (iConectado<=0) then
             UPDATE SGCONEXAO SET CONECTADO=1, CODFILIALSEL=:iCodfilialSel, CODTERM = :iCodTerm,
               CODEMP=:iCodemp, CODFILIAL=:iCodfilial , IDUSU=:cIdUsu
               WHERE NRCONEXAO=CURRENT_CONNECTION;
          else
          begin
             if (not (iCodfilialSelCX=iCodfilialSel) ) then
                EXCEPTION SGCONEXAOEX01;
             else
                UPDATE SGCONEXAO SET CONECTADO=CONECTADO+1, CODTERM = :iCodTerm,
                   CODEMP=:iCodemp, CODFILIAL=:iCodfilial, IDUSU=:cIdUsu
                WHERE NRCONEXAO=CURRENT_CONNECTION;
          end
      end 
  end
  suspend;
end
^

/* empty dependent procedure body */
/* Clear: CPADICFORSP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE CPADICFORSP(CODEMP INTEGER,
CODFILIAL INTEGER,
CODFILIALCL INTEGER,
CODCLI INTEGER)
 RETURNS(CODFOR INTEGER)
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: CPADICITCOMPRAPEDSP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE CPADICITCOMPRAPEDSP(CODEMP INTEGER,
CODFILIAL SMALLINT,
CODCOMPRA INTEGER,
CODEMPPC INTEGER,
CODFILIALPC SMALLINT,
CODCOMPRAPC INTEGER,
CODITCOMPRAPC INTEGER,
TPAGRUP CHAR(1),
QTDITCOMPRA FLOAT,
VLRDESCITCOMPRA NUMERIC(15,5),
PRECOITCOMPRA NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: CPGERAENTRADASP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE CPGERAENTRADASP(CODEMP INTEGER,
CODFILIAL INTEGER,
CODFILIALVD INTEGER,
TIPOVENDA CHAR(1),
CODVENDA INTEGER,
CITEM CHAR(1))
 RETURNS(CODCOMPRA INTEGER)
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: CPGERAITENTRADASP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE CPGERAITENTRADASP(CODEMP INTEGER,
CODFILIAL INTEGER,
CODCOMPRA INTEGER,
CODFILIALVD INTEGER,
TIPOVENDA CHAR(1),
CODVENDA INTEGER,
CODITVENDA INTEGER,
QTDIT INTEGER)
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: CRTOTAL01ISP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE CRTOTAL01ISP(CODEMP INTEGER,
CODFILIAL INTEGER)
 RETURNS(SEQTOT INTEGER)
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: EQGERARMAOSSP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE EQGERARMAOSSP(CODEMPRM INTEGER,
CODFILIALRM INTEGER,
TICKET INTEGER,
CODITRECMERC SMALLINT)
 RETURNS(CODRMA INTEGER)
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: EQGERARMASP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE EQGERARMASP(CODEMPOP INTEGER,
CODFILIALOP INTEGER,
CODOP INTEGER,
SEQOP SMALLINT)
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: EQMOVPRODSEQSP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE EQMOVPRODSEQSP(ICODEMP INTEGER)
 RETURNS(SCODFILIAL SMALLINT,
ICODMOVPROD INTEGER)
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: FNADICLANCASP01 for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE FNADICLANCASP01(ICODREC INTEGER,
INPARCITREC INTEGER,
PDVITREC CHAR(1),
SNUMCONTA CHAR(10),
ICODEMPCA INTEGER,
ICODFILIALCA INTEGER,
ICODCLI INTEGER,
ICODEMPCL INTEGER,
ICODFILIALCL INTEGER,
SCODPLAN CHAR(13),
ICODEMPPN INTEGER,
ICODFILIALPN INTEGER,
IANOCC INTEGER,
SCODCC CHAR(19),
ICODEMPCC INTEGER,
ICODFILIALCC INTEGER,
DDTCOMPITREC DATE,
DDTPAGOITREC DATE,
SDOCLANCAITREC VARCHAR(15),
SOBSITREC CHAR(250),
DVLRPAGOITREC NUMERIC(15,5),
ICODEMP INTEGER,
ICODFILIAL SMALLINT,
DVLRPAGOJUROS NUMERIC(15,5),
DVLRDESC NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: FNADICLANCASP02 for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE FNADICLANCASP02(ICODPAG INTEGER,
INPARCPAG INTEGER,
SNUMCONTA CHAR(10),
ICODEMPCA INTEGER,
ICODFILIALCA INTEGER,
ICODFOR INTEGER,
ICODEMPFR INTEGER,
ICODFILIALFR INTEGER,
SCODPLAN CHAR(13),
ICODEMPPN INTEGER,
ICODFILIALPN INTEGER,
IANOCC INTEGER,
SCODCC CHAR(19),
ICODEMPCC INTEGER,
ICODFILIALCC INTEGER,
DDTCOMPITPAG DATE,
DDTPAGOITPAG DATE,
SDOCLANCAITPAG VARCHAR(15),
SOBSITPAG CHAR(250),
DVLRPAGOITPAG NUMERIC(15,5),
ICODEMP INTEGER,
ICODFILIAL SMALLINT,
DVLRJUROSPAG NUMERIC(15,5),
DVLRDESC NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: FNADICPAGARSP01 for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE FNADICPAGARSP01(CODCOMPRA INTEGER,
ICODEMPPG INTEGER,
ICODFILIALPG SMALLINT,
CODPLANOPAG INTEGER,
ICODEMPFR INTEGER,
ICODFILIALFR SMALLINT,
CODFOR INTEGER,
VLRLIQCOMPRA NUMERIC(18,2),
DTSAIDACOMPRA DATE,
DTCOMPCOMPRA DATE,
DOCCOMPRA INTEGER,
ICODEMPBO INTEGER,
ICODFILIALBO SMALLINT,
CODBANCO CHAR(3),
FLAG CHAR(1),
ICODEMP INTEGER,
ICODFILIAL SMALLINT,
CODEMPTC INTEGER,
CODFILIALTC SMALLINT,
CODTIPOCOB INTEGER,
CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
NUMCONTA CHAR(10),
CODEMPCC INTEGER,
CODFILIALCC SMALLINT,
ANOCC SMALLINT,
CODCC CHAR(19),
CODEMPPN INTEGER,
CODFILIALPN SMALLINT,
CODPLAN CHAR(13),
OBSPAG VARCHAR(250))
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: FNADICPAGARSP02 for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE FNADICPAGARSP02(CODEMPOC INTEGER,
CODFILIALOC SMALLINT,
CODORDCP INTEGER,
CODEMPPP INTEGER,
CODFILIALPP SMALLINT,
CODPLANOPAG INTEGER,
CODEMPFR INTEGER,
CODFILIALFR SMALLINT,
CODFOR INTEGER,
OBSPAG VARCHAR(2000))
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: FNADICRECEBERSP01 for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE FNADICRECEBERSP01(TIPOVENDA CHAR(1),
CODVENDA INTEGER,
CODEMPTC INTEGER,
CODFILIALTC INTEGER,
CODTIPOCOB INTEGER,
CODEMPPG INTEGER,
CODFILIALPG SMALLINT,
CODPLANOPAG INTEGER,
CODEMPCL INTEGER,
CODFILIALCL SMALLINT,
CODCLI INTEGER,
CODEMPVD INTEGER,
CODFILIALVD SMALLINT,
CODVEND INTEGER,
VLRLIQVENDA NUMERIC(15,5),
DTVENDA DATE,
DTCOMP DATE,
VLRCOMISVENDA NUMERIC(15,5),
DOCVENDA INTEGER,
CODEMPBO INTEGER,
CODFILIALBO SMALLINT,
CODBANCO CHAR(3),
CODEMP INTEGER,
CODFILIAL SMALLINT,
CODEMPCB INTEGER,
CODFILIALCB SMALLINT,
CODCARTCOB CHAR(3),
CODEMPCA INTEGER,
CODFILIALCA SMALLINT,
NUMCONTA CHAR(10),
FLAG CHAR(1),
OBSREC VARCHAR(250),
VLRBASECOMIS NUMERIC(15,5),
VLRRETENSAOISS NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: FNCHECAPGTOATRASOSP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE FNCHECAPGTOATRASOSP(ICODCLI INTEGER,
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 RETURNS(SRETORNO CHAR(1))
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: FNCHECAPGTOSP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE FNCHECAPGTOSP(ICODCLI INTEGER,
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 RETURNS(SRETORNO CHAR(1))
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: FNLIBCREDSP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE FNLIBCREDSP(CODEMPVD INTEGER,
CODFILIALVD INTEGER,
TIPOVENDA CHAR(1),
CODVENDA INTEGER,
CODCLI INTEGER,
CODEMPCL INTEGER,
CODFILIALCL INTEGER,
VLRVENDA NUMERIC(15,5),
VLRADIC NUMERIC(15,2),
CODITEM INTEGER)
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: LFNOVODOCSP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE LFNOVODOCSP(SSERIE CHAR(4),
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 RETURNS(DOC INTEGER)
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: PVFECHAVENDASP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE PVFECHAVENDASP(ICODEMP INTEGER,
ICODFILIAL SMALLINT,
NVALOR NUMERIC(15,5),
ITERM INTEGER,
DDTAMOV DATE,
CIDUSU CHAR(8))
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: PVSANGRIASP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE PVSANGRIASP(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
NVALOR NUMERIC(18,3),
ICODCAIXA INTEGER,
DDTAMOV DATE,
CIDUSU CHAR(8))
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: PVSUPRIMENTOSP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE PVSUPRIMENTOSP(ICODEMP INTEGER,
ICODFILIAL SMALLINT,
NVALOR NUMERIC(18,3),
ITERM INTEGER,
DDTAMOV DATE,
CIDUSU CHAR(8))
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: SGAGENTEUIDSP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE SGAGENTEUIDSP(CIUD CHAR(1),
ICODEMP INTEGER,
CTIPOAGE CHAR(5),
ICODAGE INTEGER,
CDESCAGE CHAR(50))
 RETURNS(CODEMP INTEGER,
CODFILIAL SMALLINT,
TIPOAGE CHAR(5),
CODAGE INTEGER)
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: SGCALCVENCSP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE SGCALCVENCSP(CODEMP INTEGER,
DTBASE DATE,
DTVENC DATE,
REGRVCTO CHAR(1),
RVSAB CHAR(1),
RVDOM CHAR(1),
RVFER CHAR(1),
RVDIA CHAR(1),
DIAVCTO SMALLINT,
DIASVCTO SMALLINT)
 RETURNS(DTVENCRET DATE)
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: SGRETMULTIALMOXSP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE SGRETMULTIALMOXSP(ICODEMP INTEGER)
 RETURNS(CMULTIALMOX CHAR(1))
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: SGRETMULTICOMISSP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE SGRETMULTICOMISSP(ICODEMP INTEGER,
CODEMPTM INTEGER,
CODFILIALTM SMALLINT,
CODTIPOMOV INTEGER)
 RETURNS(CMULTICOMIS CHAR(1))
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: SGSETAGENDASP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE SGSETAGENDASP(CODAGD INTEGER,
CODEMP INTEGER,
DTAINIAGD DATE,
HRINIAGD TIME,
DTAFIMAGD DATE,
HRFIMAGD TIME,
ASSUNTOAGD CHAR(50),
DESCAGD VARCHAR(10000),
CODFILIALTA SMALLINT,
CODTIPOAGD INTEGER,
PRIORAGD SMALLINT,
CODAGE INTEGER,
TIPOAGE CHAR(5),
CODFILIALAE SMALLINT,
CODAGEEMIT INTEGER,
TIPOAGEEMIT CHAR(5),
CAAGD CHAR(2),
SITAGD CHAR(2),
RESOLUCAOMOTIVO VARCHAR(10000),
CODAGDAR INTEGER,
DIATODO CHAR(1))
 RETURNS(IRET INTEGER)
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: TKCONTCLISP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE TKCONTCLISP(CODEMP INTEGER,
CODFILIAL INTEGER,
CODCTO INTEGER,
CODFILIALTI INTEGER,
CODTIPOCLI INTEGER,
CODFILIALCC INTEGER,
CODCLASCLI INTEGER,
CODFILIALSR INTEGER,
CODSETOR INTEGER)
 RETURNS(IRET INTEGER)
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: TKGERACAMPANHACTO for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE TKGERACAMPANHACTO(TIPOCTO CHAR(1),
CODEMPCA INTEGER,
CODFILIALCA SMALLINT,
CODCAMP CHAR(13),
CODEMPCO INTEGER,
CODFILIALCO SMALLINT,
CODCTO INTEGER,
CODEMPAT INTEGER,
CODFILIALAT SMALLINT,
CODATIV INTEGER,
SITHISTTK CHAR(2),
DESCHISTTK VARCHAR(1000))
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: TKSETHISTSP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE TKSETHISTSP(CODHISTTK INTEGER,
CODEMP INTEGER,
CODFILIALCO INTEGER,
CODCTO INTEGER,
CODFILIALCL INTEGER,
CODCLI INTEGER,
DESCHISTTK VARCHAR(10000),
CODFILIALAE INTEGER,
CODATEND INTEGER,
SITHISTTK CHAR(2),
DATAHISTTK DATE,
TIPOHISTTK CHAR(1))
 RETURNS(IRET INTEGER)
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: VDADICCOMISSAOSP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE VDADICCOMISSAOSP(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
ICODREC INTEGER,
INPARCITREC INTEGER,
NVLRVENDACOMI NUMERIC(15,5),
NVLRCOMI NUMERIC(15,5),
DDATACOMI DATE,
DDTCOMPCOMI DATE,
DDTVENCCOMI DATE,
CTIPOCOMI CHAR(1),
CODEMPVD INTEGER,
CODFILIALVD SMALLINT,
CODVEND INTEGER)
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: VDADICITEMPDVSP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE VDADICITEMPDVSP(CODVENDA INTEGER,
CODEMP INTEGER,
CODFILIAL CHAR(8),
CODPROD INTEGER,
CODEMPPD INTEGER,
CODFILIALPD INTEGER,
QTDITVENDA NUMERIC(9,5),
VLRPRECOITVENDA NUMERIC(18,5),
VLRDESCITVENDA NUMERIC(18,5),
PERCDESCITVENDA NUMERIC(15,5),
VLRCOMISITVENDA NUMERIC(15,5),
PERCCOMISITVENDA NUMERIC(15,5),
SCODLOTE VARCHAR(20),
CODEMPLE INTEGER,
CODFILIALLE SMALLINT,
CODFILIALCV SMALLINT,
CODCONV INTEGER)
 RETURNS(CODITVENDA INTEGER,
PERCICMSITVENDA NUMERIC(9,2),
VLRBASEICMSITVENDA NUMERIC(18,3),
VLRICMSITVENDA NUMERIC(18,3),
VLRLIQITVENDA NUMERIC(18,3),
TIPOFISC CHAR(2))
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: VDADICITVENDAORCSP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE VDADICITVENDAORCSP(FILIALATUAL INTEGER,
ICODVENDA INTEGER,
ICODORC INTEGER,
ICODITORC INTEGER,
ICODFILIAL SMALLINT,
ICODEMP INTEGER,
STIPOVENDA CHAR(10),
TPAGRUP CHAR(1),
IQTDITVENDA NUMERIC(15,5),
VLRDESCITVENDA NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: VDADICVENDAORCSP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE VDADICVENDAORCSP(ICODORC INTEGER,
ICODFILIAL SMALLINT,
ICODEMP INTEGER,
STIPOVENDA CHAR(10),
NEWCODVENDA INTEGER)
 RETURNS(IRET INTEGER)
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: VDBAIXACOMISSAOSP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE VDBAIXACOMISSAOSP(STIPO CHAR(1),
DINI DATE,
DFIM DATE,
ICODVEND INTEGER,
ICODEMPVD INTEGER,
ICODFILIALVD SMALLINT,
SCODCONTA CHAR(10),
ICODEMPCA INTEGER,
ICODFILIALCA SMALLINT,
SCODPLAN CHAR(13),
ICODEMPPN INTEGER,
ICODFILIALPN SMALLINT,
DDATA DATE,
IDOC INTEGER,
DVLR NUMERIC(15,5),
SOBS CHAR(50),
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: VDBUSCAPRECOSP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE VDBUSCAPRECOSP(ICODPROD INTEGER,
ICODCLI INTEGER,
ICODEMPCL INTEGER,
ICODFILIALCL SMALLINT,
ICODPLANOPAG INTEGER,
ICODEMPPG INTEGER,
ICODFILIALPG SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPTM INTEGER,
ICODFILIALTM SMALLINT,
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 RETURNS(PRECO NUMERIC(14,5))
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: VDCOPIAORCSP for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE VDCOPIAORCSP(CODEMP INTEGER,
CODFILIAL INTEGER,
CODORC INTEGER,
CODFILIALCL INTEGER,
CODCLI INTEGER)
 RETURNS(IRET INTEGER)
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: VDRETULTVDCLIPROD for: SGRETFILIAL */
/* AssignEmptyBody proc */
ALTER PROCEDURE VDRETULTVDCLIPROD(ICODEMP INTEGER,
ICODCLI INTEGER,
ICODFILIALVD SMALLINT,
ICODVEND INTEGER,
DTINI DATE,
DTFIM DATE,
CODEMPTIPOCL INTEGER,
CODFILIALTIPOCL SMALLINT,
CODTIPOCLI INTEGER)
 RETURNS(RAZCLI_RET CHAR(50),
CODCLI_RET INTEGER,
DESCPROD_RET CHAR(50),
CODPROD_RET INTEGER,
DTEMITVENDA_RET DATE,
DOCVENDA_RET INTEGER,
SERIE_RET CHAR(4),
PRECOVENDA_RET NUMERIC(15,4))
 AS
 BEGIN EXIT; END
^

/* Alter (SGRETFILIAL) */
ALTER PROCEDURE SGRETFILIAL(ICODEMP INTEGER,
SNOMETAB CHAR(30))
 RETURNS(ICODFILIAL SMALLINT)
 AS
DECLARE VARIABLE SEHME CHAR(1);
begin
  SELECT USOMEOBJ FROM SGOBJETO WHERE TIPOOBJ='TB' AND IDOBJ=:SNOMETAB AND CODEMP=:ICODEMP
    INTO sEhME;
  IF (sEhME = 'N') THEN
  BEGIN
    SELECT CODFILIALSEL FROM SGCONEXAO WHERE CODEMP=:ICODEMP AND
      NRCONEXAO=CURRENT_CONNECTION AND CONECTADO > 0 INTO ICODFILIAL;
  END
  ELSE
  BEGIN
    SELECT FL.CODFILIAL FROM SGFILIAL FL WHERE
      FL.CODEMP = :ICODEMP AND FL.MZFILIAL='S'
      INTO ICODFILIAL;
    IF (ICODFILIAL IS NULL) THEN
      EXCEPTION SGFILIALEX01;
  END
  IF (ICODFILIAL IS NULL) THEN
  BEGIN
    EXCEPTION SGFILIALEX02;
  END
  SUSPEND;
end
^

/* Alter (SGRETINFOUSU) */
ALTER PROCEDURE SGRETINFOUSU(CODEMP INTEGER,
IDUSU VARCHAR(128))
 RETURNS(ANOCCUSU SMALLINT,
CODEMPCCUSU INTEGER,
CODFILIALCCUSU SMALLINT,
CODEMPUSU INTEGER,
CODFILIALUSU SMALLINT,
CODCCUSU CHAR(19),
IDUSUS CHAR(8),
ALMOXARIFE CHAR(1),
APROVARMA CHAR(2))
 AS
begin
    select icodfilial from sgretfilial(:codemp, 'SGUSUARIO') into :codfilialusu;
    codempusu=:codemp;
    select first 1 u.codempcc, u.codfilialcc, u.anocc, u.codcc,
       u.idusu, u.almoxarifeusu, u.aprovrmausu
    from sgusuario u where lower(u.idusu)=lower(:idusu) and u.codemp=:codemp and u.codfilial=:codfilialusu
    into :codempccusu, :codfilialccusu, :anoccusu, :codccusu,
    :idusus, :almoxarife, :aprovarma;

    suspend;
end
^

/* empty dependent procedure body */
/* Clear: EQMOVPRODIUDSP for: SGRETMULTIALMOXSP */
/* AssignEmptyBody proc */
ALTER PROCEDURE EQMOVPRODIUDSP(CIUD CHAR(1),
ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
SEQSUBPROD SMALLINT)
 AS
 BEGIN EXIT; END
^

/* Alter (SGRETMULTIALMOXSP) */
ALTER PROCEDURE SGRETMULTIALMOXSP(ICODEMP INTEGER)
 RETURNS(CMULTIALMOX CHAR(1))
 AS
DECLARE VARIABLE SCODFILIALPF SMALLINT;
begin
  /* Procedure Text */
  SELECT RF.ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'SGPREFERE1') RF
     INTO :SCODFILIALPF;
  SELECT MULTIALMOX FROM SGPREFERE1 WHERE CODEMP=:ICODEMP AND
     CODFILIAL=:SCODFILIALPF
     INTO :CMULTIALMOX;

/* Condição que evita null no valor do flag */
  CMULTIALMOX = coalesce(CMULTIALMOX,'N');

  suspend;
end
^

/* empty dependent procedure body */
/* Clear: VDGERACOMISSAOSP for: SGRETMULTICOMISSP */
/* AssignEmptyBody proc */
ALTER PROCEDURE VDGERACOMISSAOSP(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
ICODREC INTEGER,
INPARCITREC INTEGER,
NVLRCOMIITREC NUMERIC(15,5),
DDTVENCITREC DATE)
 AS
 BEGIN EXIT; END
^

/* Alter (SGRETMULTICOMISSP) */
ALTER PROCEDURE SGRETMULTICOMISSP(ICODEMP INTEGER,
CODEMPTM INTEGER,
CODFILIALTM SMALLINT,
CODTIPOMOV INTEGER)
 RETURNS(CMULTICOMIS CHAR(1))
 AS
declare variable scodfilialpf smallint;
declare variable cmulticomistm char(1);
begin
    select rf.icodfilial from sgretfilial(:icodemp, 'SGPREFERE1') rf
        into :scodfilialpf;

    /* Verifica se o mecanismo de multiplos comissionados está habilitado nas preferências gerais */

    select pf.multicomis from sgprefere1 pf
        where pf.codemp=:icodemp and pf.codfilial=:scodfilialpf
    into :cmulticomis;

    /* Caso esteja habilitado nas preferências, verifica se o tipo de movimento suporta multiplos comissionados */
    if(:cmulticomis = 'S') then
    begin

        select tm.mcomistipomov from eqtipomov tm
            where tm.codemp=:codemptm and tm.codfilial=:codfilialtm and tm.codtipomov=:codtipomov
        into :cmulticomistm;

        if(:cmulticomis is null or :cmulticomistm='N') then
        begin
            cmulticomis = 'N';
        end

    end

  cmulticomis = coalesce(cmulticomis,'N');

  suspend;
end
^

/* Alter (SGRETVERSAO) */
ALTER PROCEDURE SGRETVERSAO RETURNS(VERSAO VARCHAR(30))
 AS
begin
    versao = '1.2.5.2 (30/07/2012)';
    suspend;
end
^

/* Alter (SGSETAGENDASP) */
ALTER PROCEDURE SGSETAGENDASP(CODAGD INTEGER,
CODEMP INTEGER,
DTAINIAGD DATE,
HRINIAGD TIME,
DTAFIMAGD DATE,
HRFIMAGD TIME,
ASSUNTOAGD CHAR(50),
DESCAGD VARCHAR(10000),
CODFILIALTA SMALLINT,
CODTIPOAGD INTEGER,
PRIORAGD SMALLINT,
CODAGE INTEGER,
TIPOAGE CHAR(5),
CODFILIALAE SMALLINT,
CODAGEEMIT INTEGER,
TIPOAGEEMIT CHAR(5),
CAAGD CHAR(2),
SITAGD CHAR(2),
RESOLUCAOMOTIVO VARCHAR(10000),
CODAGDAR INTEGER,
DIATODO CHAR(1))
 RETURNS(IRET INTEGER)
 AS
DECLARE VARIABLE IFILIALAGD INTEGER;
begin
  select ICODFILIAL from SGRETFILIAL(:CODEMP,'SGAGENDA') INTO IFILIALAGD;
  IF (CODAGD = 0) THEN
  BEGIN

    SELECT ISEQ FROM SPGERANUM(:CODEMP,:IFILIALAGD,'AG') INTO CODAGD;

    if(codagdar is not null ) then  -- Agendamento vinculado (repetição)
    begin
        insert into sgagenda (
            codemp, codfilial, codage, tipoage, codagd,
            dataagd, dtainiagd, hriniagd, dtafimagd, hrfimagd,
            assuntoagd, descagd, codempta, codfilialta, codtipoagd, prioragd, sitagd,
            codempae, codfilialae, codageemit, tipoageemit, caagd, resolucaomotivo,
            codempar,codfilialar,codagear,tipoagear,codagdar,diatodo)
        values (
            :codemp, :ifilialagd, :codage, :tipoage, :codagd,
            cast('today' as date), :dtainiagd, :hriniagd, :dtafimagd, :hrfimagd,
            :assuntoagd, :descagd, :codemp, :codfilialta, :codtipoagd, :prioragd, :sitagd,
            :codemp, :codfilialae, :codageemit, :tipoageemit, :caagd, :resolucaomotivo,
            :codemp,:ifilialagd,:codage,:tipoage,:codagdar,:diatodo
        );
    end
    else -- Agendamento simples, sem vínvulo (repetição)
    begin
        insert into sgagenda (
            CODEMP,CODFILIAL,CODAGE,TIPOAGE,CODAGD,
            DATAAGD,DTAINIAGD,HRINIAGD,DTAFIMAGD,HRFIMAGD,
            ASSUNTOAGD,DESCAGD,CODEMPTA,CODFILIALTA,CODTIPOAGD,PRIORAGD,SITAGD,
            CODEMPAE,CODFILIALAE,CODAGEEMIT,TIPOAGEEMIT,CAAGD, RESOLUCAOMOTIVO, DIATODO)
        values (
            :CODEMP,:IFILIALAGD,:CODAGE,:TIPOAGE,:CODAGD,
            CAST('today' AS DATE),:DTAINIAGD,:HRINIAGD,:DTAFIMAGD,:HRFIMAGD,
            :ASSUNTOAGD,:DESCAGD,:CODEMP,:CODFILIALTA,:CODTIPOAGD,:PRIORAGD,:SITAGD,
            :CODEMP,:CODFILIALAE,:CODAGEEMIT,:TIPOAGEEMIT,:CAAGD, :RESOLUCAOMOTIVO,:DIATODO

        );
    end
  end
  else
    update sgagenda set
      DTAINIAGD=:DTAINIAGD,HRINIAGD=:HRINIAGD,
      DTAFIMAGD=:DTAFIMAGD,HRFIMAGD=:HRFIMAGD,
      ASSUNTOAGD=:ASSUNTOAGD,DESCAGD=:DESCAGD,
      CODEMPTA=:CODEMP,CODFILIALTA=:CODFILIALTA,CODTIPOAGD=:CODTIPOAGD,
      PRIORAGD=:PRIORAGD,CAAGD=:CAAGD,
      SITAGD=:SITAGD,
      RESOLUCAOMOTIVO=:RESOLUCAOMOTIVO,
      codage=:codage, diatodo=:diatodo
      WHERE CODEMP=:CODEMP AND CODFILIAL=:IFILIALAGD
      AND CODAGD=:CODAGD AND TIPOAGE=:TIPOAGE;
  IRET = CODAGD;
  SUSPEND;
END
^

/* Alter (TKCONTCLISP) */
ALTER PROCEDURE TKCONTCLISP(CODEMP INTEGER,
CODFILIAL INTEGER,
CODCTO INTEGER,
CODFILIALTI INTEGER,
CODTIPOCLI INTEGER,
CODFILIALCC INTEGER,
CODCLASCLI INTEGER,
CODFILIALSR INTEGER,
CODSETOR INTEGER)
 RETURNS(IRET INTEGER)
 AS
DECLARE VARIABLE ICODCLI INTEGER;
DECLARE VARIABLE IFILIALCLI INTEGER;
BEGIN
  SELECT MAX(CODCLI)+1 FROM VDCLIENTE WHERE CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL INTO ICODCLI;
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP, 'VDCLIENTE') INTO IFILIALCLI;
  
  INSERT INTO VDCLIENTE (CODEMP,CODFILIAL,CODCLI,RAZCLI,CODEMPCC,CODFILIALCC,CODCLASCLI,
  CODEMPVD,CODFILIALVD,CODVEND,CODEMPSR,CODFILIALSR,CODSETOR,NOMECLI,CODEMPTI,CODFILIALTI,
  CODTIPOCLI,DATACLI,PESSOACLI,ATIVOCLI,CNPJCLI,INSCCLI,CPFCLI,RGCLI,ENDCLI,NUMCLI,
  COMPLCLI,BAIRCLI,CIDCLI,UFCLI,CEPCLI,FONECLI,FAXCLI,EMAILCLI,CONTCLI,CTOCLI,
  CODPAIS, SIGLAUF, CODMUNIC)
    SELECT :CODEMP,:IFILIALCLI,:ICODCLI,RAZCTO,:CODEMP,:CODFILIALCC,:CODCLASCLI,
    CODEMPVD,CODFILIALVD,CODVEND,:CODEMP,:CODFILIALSR,:CODSETOR,NOMECTO,:CODEMP,:CODFILIALTI,
    :CODTIPOCLI,DATACTO,PESSOACTO,ATIVOCTO,CNPJCTO,INSCCTO,CPFCTO,RGCTO,ENDCTO,NUMCTO,
    COMPLCTO,BAIRCTO,CIDCTO,UFCTO,CEPCTO,FONECTO,FAXCTO,EMAILCTO,CONTCTO,'O',
    CODPAIS, SIGLAUF, CODMUNIC
  FROM TKCONTATO WHERE
    CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL AND CODCTO=:CODCTO;
    
  INSERT INTO TKCONTCLI (CODEMPCTO, CODFILIALCTO, CODCTO, CODEMPCLI, CODFILIALCLI, CODCLI)
    VALUES (:CODEMP, :CODFILIAL, :CODCTO, :CODEMP, :IFILIALCLI, :ICODCLI);
  IRET = ICODCLI;
  
  SUSPEND;
END
^

/* Alter (TKGERACAMPANHACTO) */
ALTER PROCEDURE TKGERACAMPANHACTO(TIPOCTO CHAR(1),
CODEMPCA INTEGER,
CODFILIALCA SMALLINT,
CODCAMP CHAR(13),
CODEMPCO INTEGER,
CODFILIALCO SMALLINT,
CODCTO INTEGER,
CODEMPAT INTEGER,
CODFILIALAT SMALLINT,
CODATIV INTEGER,
SITHISTTK CHAR(2),
DESCHISTTK VARCHAR(1000))
 AS
declare variable seqcampcto integer; /* Código do contato pra validação. */
declare variable seqsitcamp integer;
declare variable codfilialhi smallint;
declare variable codhisttk integer;
declare variable codempae integer;
declare variable codfilialae smallint;
declare variable codatend integer; /* Código do atendente. */
declare variable codempus integer;
declare variable codfilialus smallint;
declare variable idusu char(8); /* Id do usuário */
begin

    select icodfilial from sgretfilial(:codempca,'TKHISTORICO') into codfilialhi;
    select iseq from spgeranum(:codempca,:codfilialhi,'HI') into codhisttk;
    select codempusu, codfilialusu, idusus from sgretinfousu(:codempca, user) where codempusu=:codempca into
            :codempus, :codfilialus, :idusu;

    select codemp, codfilial, codatend from atatendente
            where codempus=:codempus and codfilialus=:codfilialus and idusu=:idusu
    into codempae, codfilialae, codatend;

    if(:codatend is null) then
    begin
        exception TKGERACAMANHACTO01 ' - ID: ' || idusu || ' - User: '|| user ;
    end

    -- Verifica se o contato já foi vinculado à campanha

    if ( tipocto = 'O' ) then 
    begin 
    	select seqcampcto from tkcampanhacto cc
	        where cc.codemp=:codempca and cc.codfilial=:codfilialca and cc.codcamp=:codcamp
            	and cc.codempco=:codempco and cc.codfilialco=:codfilialco and cc.codcto=:codcto
    	into :seqcampcto;
    end
    else
    begin
    	select seqcampcto from tkcampanhacto cc
	        where cc.codemp=:codempca and cc.codfilial=:codfilialca and cc.codcamp=:codcamp
            	and cc.codempcl=:codempco and cc.codfilialcl=:codfilialco and cc.codcli=:codcto
    	into :seqcampcto;
    end

    if( (:seqcampcto is null) or (:seqcampcto=0) ) then
    begin
        seqcampcto = 1;
        if ( tipocto = 'O' ) then 
        begin
	        insert into tkcampanhacto (codemp, codfilial, codcamp, seqcampcto, codempco, codfilialco, codcto)
		        values(:codempca, :codfilialca, :codcamp, :seqcampcto, :codempco, :codfilialco, :codcto);
        end
        else 
        begin
	        insert into tkcampanhacto (codemp, codfilial, codcamp, seqcampcto, codempcl, codfilialcl, codcli)
		        values(:codempca, :codfilialca, :codcamp, :seqcampcto, :codempco, :codfilialco, :codcto);
        end
    end
    else
    begin
    	seqsitcamp = 0;
        select max(sc.seqsitcamp) from tksitcamp sc
	            where sc.codemp=:codempca and sc.codfilial=:codfilialca and 
	            	sc.codcamp=:codcamp and sc.tipocto=:tipocto 
			        into :seqsitcamp;

        if(:seqsitcamp is null) then
        begin
            seqsitcamp = 0;
        end

        seqsitcamp = seqsitcamp + 1;

        if ( tipocto = 'O' ) then 
        begin 
	        insert into tksitcamp (codemp,codfilial,codcamp,codempco,codfilialco,codcto,seqsitcamp,
	                codempav,codfilialav,codativ, tipocto)
		        values (:codempca,:codfilialca,:codcamp,:codempco,:codfilialco,:codcto,:seqsitcamp,
	                :codempat,:codfilialat ,:codativ, :tipocto );
	    end
	    else
	    begin
	        insert into tksitcamp (codemp,codfilial,codcamp,codempcl,codfilialcl,codcli,seqsitcamp,
	                codempav,codfilialav,codativ, tipocto)
		        values (:codempca,:codfilialca,:codcamp,:codempco,:codfilialco,:codcto,:seqsitcamp,
	                :codempat,:codfilialat ,:codativ, :tipocto );
	    end
    end

    -- Inserindo histórico
    
	if ( tipocto = 'O' ) then 
	begin 
	    insert into tkhistorico (codemp, codfilial,codhisttk,horahisttk,datahisttk,
                         codempco,codfilialco,codcto,deschisttk,codempae,codfilialae,codatend,
                         sithisttk,tipohisttk, tipocto)
    		values (:codempca,:codfilialhi,:codhisttk,cast('now' as time),cast('now' as date),
            		  :codempco,:codfilialco,:codcto,:deschisttk,:codempae,:codfilialae,:codatend,
              			:sithisttk,'C', :tipocto);
    end
    else
    begin
	    insert into tkhistorico (codemp, codfilial,codhisttk,horahisttk,datahisttk,
                         codempcl,codfilialcl,codcli,deschisttk,codempae,codfilialae,codatend,
                         sithisttk,tipohisttk, tipocto)
    		values (:codempca,:codfilialhi,:codhisttk,cast('now' as time),cast('now' as date),
            		  :codempco,:codfilialco,:codcto,:deschisttk,:codempae,:codfilialae,:codatend,
              			:sithisttk,'C', :tipocto);
    end
   

end
^

/* Alter (TKSETHISTSP) */
ALTER PROCEDURE TKSETHISTSP(CODHISTTK INTEGER,
CODEMP INTEGER,
CODFILIALCO INTEGER,
CODCTO INTEGER,
CODFILIALCL INTEGER,
CODCLI INTEGER,
DESCHISTTK VARCHAR(10000),
CODFILIALAE INTEGER,
CODATEND INTEGER,
SITHISTTK CHAR(2),
DATAHISTTK DATE,
TIPOHISTTK CHAR(1))
 RETURNS(IRET INTEGER)
 AS
DECLARE VARIABLE IFILIALHIST INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'TKHISTORICO') INTO IFILIALHIST;
  IF (TIPOHISTTK = '') THEN
  BEGIN
    TIPOHISTTK = 'H';
  END
  IF (CODHISTTK = 0) THEN
  BEGIN
    SELECT ISEQ FROM SPGERANUM(:CODEMP,:IFILIALHIST,'HI') INTO CODHISTTK;
    INSERT INTO TKHISTORICO(CODEMP,CODFILIAL,CODHISTTK,DATAHISTTK,HORAHISTTK,CODEMPCO,CODFILIALCO,
      CODCTO,CODEMPCL,CODFILIALCL,CODCLI,DESCHISTTK,CODEMPAE,CODFILIALAE,CODATEND,SITHISTTK,TIPOHISTTK)
      VALUES (:CODEMP,:IFILIALHIST,:CODHISTTK,:DATAHISTTK,CAST('now' AS TIME),:CODEMP,:CODFILIALCO,
      :CODCTO,:CODEMP,:CODFILIALCL,:CODCLI,:DESCHISTTK,:CODEMP,:CODFILIALAE,:CODATEND,:SITHISTTK,:TIPOHISTTK);
  END
  ELSE
  BEGIN
    UPDATE TKHISTORICO SET DATAHISTTK=:DATAHISTTK,CODEMPCO=:CODEMP,CODFILIALCO=:CODFILIALCO,
      CODCTO=:CODCTO,CODEMPCL=:CODEMP,CODFILIALCL=:CODFILIALCL,
      CODCLI=:CODCLI,DESCHISTTK=:DESCHISTTK,CODEMPAE=:CODEMP,
      CODFILIALAE=:CODFILIALAE,CODATEND=:CODATEND,SITHISTTK=:SITHISTTK,TIPOHISTTK=:TIPOHISTTK
      WHERE CODEMP=:CODEMP AND CODFILIAL=:IFILIALHIST AND CODHISTTK=:CODHISTTK;
    /*IF (NOT SITHISTTK IN ('AG')) THEN
      DELETE FROM SGAGENDA WHERE OBJORIGAGD='HISTO' AND CODEMPCH=:CODEMP AND
        CODFILIALCH=:IFILIALHIST AND CODCHAVE=:CODHISTTK; */
  END
  SUSPEND;
END
^

/* empty dependent procedure body */
/* Clear: VDESTORNACOMISSAOSP for: VDADICCOMISSAOSP */
/* AssignEmptyBody proc */
ALTER PROCEDURE VDESTORNACOMISSAOSP(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
ICODVEND INTEGER,
DINI DATE,
DFIM DATE,
CORDEM CHAR(1))
 AS
 BEGIN EXIT; END
^

/* Alter (VDADICCOMISSAOSP) */
ALTER PROCEDURE VDADICCOMISSAOSP(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
ICODREC INTEGER,
INPARCITREC INTEGER,
NVLRVENDACOMI NUMERIC(15,5),
NVLRCOMI NUMERIC(15,5),
DDATACOMI DATE,
DDTCOMPCOMI DATE,
DDTVENCCOMI DATE,
CTIPOCOMI CHAR(1),
CODEMPVD INTEGER,
CODFILIALVD SMALLINT,
CODVEND INTEGER)
 AS
declare variable scodfilialcs smallint;
declare variable icodcomi integer;
declare variable cstatuscomi char(2);
begin

    -- Se o valor for nulo ou 0 deve deletar a comissão já gerada
    if ( (nvlrcomi is null) or  (nvlrcomi=0) ) then
    begin

        delete from vdcomissao co
        where co.codemprc=:icodemp and co.codfilialrc=:scodfilial and co.codrec=:icodrec and co.nparcitrec=:inparcitrec and
        co.tipocomi=:ctipocomi and codempvd=:codempvd and codfilialvd=:codfilialvd and codvend=:codvend;

    end
    -- Caso seja um estorno de comissão
    else if (nvlrcomi<0) then
    begin

        -- Buscando a filial da tabela de comissões
        select icodfilial from sgretfilial(:icodemp,'VDCOMISSAO') into :scodfilialcs;

        -- Buscando novo numero para
        select max(codcomi) from vdcomissao where codemp=:icodemp and codfilialvd = :scodfilialcs into icodcomi;

        if (:icodcomi is null) then
            icodcomi = 1;
        else
            icodcomi = icodcomi + 1;

        -- Inserindo na tabela de comissões
        insert into vdcomissao (
            codemp, codfilial, codcomi, codempRc, codfilialrc, codrec, nparcitrec, vlrvendacomi, vlrcomi, datacomi,
            dtcompcomi, dtvenccomi, statuscomi, tipocomi, codempvd, codfilialvd, codvend )
        values (
            :icodemp, :scodfilialcs, :icodcomi, :icodemp, :scodfilial, :icodrec, :inparcitrec, :nvlrvendacomi, :nvlrcomi, :ddatacomi,
            :ddtcompcomi, :ddtvenccomi, 'CE', :ctipocomi, :codempvd, :codfilialvd,:codvend
            );

        -- Transforma o valor da comissão em positivo e programa para o proximo pagto.
        nvlrcomi = nvlrcomi * -1;

        insert into vdcomissao (
            codemp, codfilial, codcomi, codemprc, codfilialrc, codrec, nparcitrec,
            vlrvendacomi, vlrcomi, datacomi, dtcompcomi,  dtvenccomi, statuscomi, tipocomi, codempvd, codfilialvd, codvend )
        values (
            :icodemp, :scodfilialcs, :icodcomi, :icodemp, :scodfilial, :icodrec, :inparcitrec,
            :nvlrvendacomi, :nvlrcomi, :ddatacomi, :ddtcompcomi, :ddtvenccomi, 'C1', :ctipocomi, :codempvd,:codfilialvd,:codvend
            );

    end
    else
    begin

        if (ctipocomi='F') then
            cstatuscomi = 'C2';
        else
            cstatuscomi = 'C1';

        -- Buscando a filial da tabela de comissões
        select icodfilial from sgretfilial( :icodemp, 'VDCOMISSAO') into :scodfilialcs;

        -- Buscando o código da comissão já existente
        select codcomi from vdcomissao
        where codemp=:icodemp and codfilialrc=:scodfilial and codrec=:icodrec and nparcitrec=:inparcitrec and
        tipocomi=:ctipocomi and codempvd=:codempvd and codfilialvd=:codfilialvd and codvend=:codvend
        into :icodcomi;

        -- Caso já não exista a comissão deve inserir
        if (icodcomi is null) then
        begin
            --Buscando um novo código
            select max(codcomi) from vdcomissao where codemp=:icodemp and codfilial = :scodfilialcs into icodcomi;

            if (:icodcomi is null) then
                icodcomi = 1;
            else
                icodcomi = icodcomi + 1;

            -- Inserindo na tabela de comissões
            insert into vdcomissao( codemp, codfilial, codcomi, codemprc, codfilialrc, codrec, nparcitrec,
            vlrvendacomi, vlrcomi, datacomi, dtcompcomi, dtvenccomi, statuscomi, tipocomi, codempvd, codfilialvd, codvend)
            values (
                :icodemp, :scodfilialcs, :icodcomi, :icodemp, :scodfilial, :icodrec, :inparcitrec,
                :nvlrvendacomi, :nvlrcomi, :ddatacomi, :ddtcompcomi, :ddtvenccomi, :cstatuscomi, :ctipocomi, :codempvd, :codfilialvd, :codvend
            );

        end
        -- Se encontrou a comissão atualiza
        else
        begin

            update vdcomissao set vlrvendacomi=:nvlrvendacomi, vlrcomi=:nvlrcomi, datacomi=:ddatacomi,
            dtvenccomi=:ddtvenccomi, statuscomi=:cstatuscomi
            where codemp=:icodemp and codfilial=:scodfilialcs and codcomi=:icodcomi and codempvd=:codempvd and
            codfilialvd=:codfilialvd and codvend=:codvend and statuscomi!='CP' ;

        end

    end
    suspend;
end
^

/* Alter (VDADICITEMPDVSP) */
ALTER PROCEDURE VDADICITEMPDVSP(CODVENDA INTEGER,
CODEMP INTEGER,
CODFILIAL CHAR(8),
CODPROD INTEGER,
CODEMPPD INTEGER,
CODFILIALPD INTEGER,
QTDITVENDA NUMERIC(9,5),
VLRPRECOITVENDA NUMERIC(18,5),
VLRDESCITVENDA NUMERIC(18,5),
PERCDESCITVENDA NUMERIC(15,5),
VLRCOMISITVENDA NUMERIC(15,5),
PERCCOMISITVENDA NUMERIC(15,5),
SCODLOTE VARCHAR(20),
CODEMPLE INTEGER,
CODFILIALLE SMALLINT,
CODFILIALCV SMALLINT,
CODCONV INTEGER)
 RETURNS(CODITVENDA INTEGER,
PERCICMSITVENDA NUMERIC(9,2),
VLRBASEICMSITVENDA NUMERIC(18,3),
VLRICMSITVENDA NUMERIC(18,3),
VLRLIQITVENDA NUMERIC(18,3),
TIPOFISC CHAR(2))
 AS
declare variable icodfilialnt smallint;
declare variable icodcli integer;
declare variable icodfilialcl integer;
declare variable icodtipomov integer;
declare variable icodfilialtm integer;
declare variable scodnat char(4);
declare variable sorigfisc char(1);
declare variable scodtrattrib char(2);
declare variable icodfilialtt smallint;
declare variable icodfilialme smallint;
declare variable icodmens smallint;
declare variable percipiitvenda numeric(9,2);
declare variable vlrbaseipiitvenda numeric(15,5);
declare variable vlripiitvenda numeric(15,5);
declare variable vlrproditvenda numeric(15,5);
declare variable srefprod varchar(20);
declare variable obsitorc varchar(500);
declare variable ufcli char(2);
declare variable ufflag char(1);
declare variable percred numeric(9,2);
begin

  SELECT MAX(CODITVENDA)+1 FROM VDITVENDA WHERE CODVENDA=:CODVENDA
    AND CODFILIAL=:CODFILIAL AND CODEMP=:CODEMP INTO CODITVENDA;

  IF (CODITVENDA IS NULL) THEN
    CODITVENDA = 1;

/*Informações da Venda.:*/

  SELECT V.CODCLI,V.CODFILIALCL,C.UFCLI,V.CODTIPOMOV,V.CODFILIALTM FROM VDVENDA V, VDCLIENTE C
    WHERE V.CODEMP=:CODEMP AND V.CODFILIAL=:CODFILIAL
    AND V.CODVENDA=:CODVENDA AND V.TIPOVENDA='E' AND
    C.CODCLI=V.CODCLI AND C.CODEMP=V.CODEMPCL AND
    C.CODFILIAL=V.CODFILIALCL INTO ICODCLI,ICODFILIALCL,UFCLI,ICODTIPOMOV,ICODFILIALTM;


  UFFLAG = 'N';

  SELECT 'S' FROM SGFILIAL  WHERE CODEMP=:CODEMP
    AND CODFILIAL=:CODFILIAL AND UFFILIAL=:UFCLI INTO UFFLAG;


  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'LFNATOPER') INTO ICODFILIALNT;
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'LFTRATTRIB') INTO ICODFILIALTT;
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'LFMENSAGEM') INTO ICODFILIALME;

  SELECT C.ALIQIPIFISC
      FROM EQPRODUTO P, LFITCLFISCAL C
         WHERE P.CODPROD=:CODPROD AND P.CODFILIAL=:CODFILIALPD
         AND P.CODEMP=:CODEMPPD AND C.CODFISC=P.CODFISC AND C.CODFILIAL=P.CODFILIALFC and
         C.geralfisc='S'
         AND C.CODEMP=P.CODEMPFC INTO PERCIPIITVENDA;

  SELECT CODNAT FROM
      LFBUSCANATSP(:CODFILIAL,:CODEMP,:CODFILIALPD,
                   :CODPROD,:CODEMP,:ICODFILIALCL,
                   :ICODCLI,NULL,NULL,NULL,:ICODFILIALTM,:ICODTIPOMOV,null)
      INTO SCODNAT;

  IF (SCODNAT IS NULL) THEN
      EXCEPTION VDITVENDAEX03;

  SELECT TIPOFISC,REDFISC,CODTRATTRIB,ORIGFISC,CODMENS,ALIQFISC FROM
      LFBUSCAFISCALSP(:CODEMP,:CODFILIALPD,:CODPROD,
                      :CODEMP,:ICODFILIALCL,:ICODCLI,
                      :CODEMP,:ICODTIPOMOV,:ICODFILIALTM, 'VD',:SCODNAT,null,null,null,null)
      INTO TIPOFISC,PERCRED,SCODTRATTRIB,SORIGFISC,ICODMENS,PERCICMSITVENDA;

  VLRPRODITVENDA = (QTDITVENDA*VLRPRECOITVENDA);
  VLRBASEIPIITVENDA = 0;
  VLRBASEICMSITVENDA = 0;
  VLRICMSITVENDA = 0;
  VLRIPIITVENDA = 0;
  IF (PERCIPIITVENDA IS NULL) THEN
     PERCIPIITVENDA = 0;

  IF ( TIPOFISC = 'II') THEN
  BEGIN
    PERCICMSITVENDA = 0;
    VLRICMSITVENDA = 0;
    VLRBASEICMSITVENDA = 0;
    PERCIPIITVENDA = 0;
    VLRIPIITVENDA = 0;
    VLRBASEIPIITVENDA = 0;
  END
  ELSE IF ( TIPOFISC = 'FF') THEN
  BEGIN
    PERCICMSITVENDA = 0;
    VLRICMSITVENDA = 0;
    VLRBASEICMSITVENDA = 0;
    PERCIPIITVENDA = 0;
    VLRIPIITVENDA = 0;
    VLRBASEIPIITVENDA = 0;
  END
  ELSE IF ( TIPOFISC = 'NN') THEN
  BEGIN
    PERCICMSITVENDA = 0;
    VLRICMSITVENDA = 0;
    VLRBASEICMSITVENDA = 0;
    PERCIPIITVENDA = 0;
    VLRIPIITVENDA = 0;
    VLRBASEIPIITVENDA = 0;
  END
  ELSE IF ( TIPOFISC = 'TT') THEN
  BEGIN
    IF (PERCICMSITVENDA = 0 OR PERCICMSITVENDA IS NULL) THEN
      SELECT PERCICMS FROM LFBUSCAICMSSP (:SCODNAT,:UFCLI,:CODEMP,:CODFILIAL) INTO PERCICMSITVENDA;
    IF (PERCRED IS NULL) THEN
      PERCRED = 0;
    VLRBASEICMSITVENDA = (VLRPRODITVENDA-VLRDESCITVENDA) - ((VLRPRODITVENDA-VLRDESCITVENDA)*(PERCRED/100));
    VLRBASEIPIITVENDA = VLRPRODITVENDA-VLRDESCITVENDA;
    VLRICMSITVENDA = VLRBASEICMSITVENDA*(PERCICMSITVENDA/100);
    VLRIPIITVENDA = VLRBASEIPIITVENDA*(PERCIPIITVENDA/100);
  END
  VLRLIQITVENDA= VLRPRODITVENDA+VLRIPIITVENDA-VLRDESCITVENDA;
  INSERT INTO VDITVENDA (
     CODEMP,CODFILIAL,TIPOVENDA,CODVENDA,CODITVENDA,
     CODEMPNT,CODFILIALNT,CODNAT,
     CODEMPPD,CODFILIALPD,CODPROD,
     CODEMPLE,CODFILIALLE,CODLOTE,
     QTDITVENDA,PRECOITVENDA,PERCDESCITVENDA,VLRDESCITVENDA,
     VLRCOMISITVENDA,PERCCOMISITVENDA,
     PERCICMSITVENDA,VLRBASEICMSITVENDA,VLRICMSITVENDA,
     PERCIPIITVENDA,VLRBASEIPIITVENDA,VLRIPIITVENDA,VLRLIQITVENDA,
     VLRPRODITVENDA,REFPROD,ORIGFISC,
     CODEMPTT,CODFILIALTT,CODTRATTRIB,TIPOFISC,
     CODEMPME,CODFILIALME,CODMENS,OBSITVENDA,
     CODEMPCV,CODFILIALCV,CODCONV) VALUES (
     :CODEMP,:CODFILIAL,'E',:CODVENDA,:CODITVENDA,
     :CODEMP,:ICODFILIALNT,:SCODNAT,
     :CODEMPPD,:CODFILIALPD,:CODPROD,
     :CODEMPLE,:CODFILIALLE,:SCODLOTE,
     :QTDITVENDA,:VLRPRECOITVENDA,:PERCDESCITVENDA,:VLRDESCITVENDA,
     :VLRCOMISITVENDA,:PERCCOMISITVENDA,
     :PERCICMSITVENDA,:VLRBASEICMSITVENDA,:VLRICMSITVENDA,
     :PERCIPIITVENDA,:VLRBASEIPIITVENDA,:VLRIPIITVENDA,:VLRLIQITVENDA,
     :VLRPRODITVENDA,:SREFPROD,:SORIGFISC,
     :CODEMP,:ICODFILIALTT,:SCODTRATTRIB,:TIPOFISC,
     :CODEMP,:ICODFILIALME,:ICODMENS,:OBSITORC,
     :CODEMP, :CODFILIALCV,:CODCONV);
  SUSPEND;
END
^

/* Alter (VDADICITVENDAORCSP) */
ALTER PROCEDURE VDADICITVENDAORCSP(FILIALATUAL INTEGER,
ICODVENDA INTEGER,
ICODORC INTEGER,
ICODITORC INTEGER,
ICODFILIAL SMALLINT,
ICODEMP INTEGER,
STIPOVENDA CHAR(10),
TPAGRUP CHAR(1),
IQTDITVENDA NUMERIC(15,5),
VLRDESCITVENDA NUMERIC(15,5))
 AS
declare variable icoditvenda integer;
declare variable icodfilialnt smallint;
declare variable codempax integer;
declare variable codfilialax integer;
declare variable codalmox integer;
declare variable icodcli integer;
declare variable icodfilialtm integer;
declare variable icodtipomov integer;
declare variable icodfilialcl integer;
declare variable scodnat char(4);
declare variable icodfilialle smallint;
declare variable scodlote varchar(20);
declare variable tipofisc char(2);
declare variable sorigfisc char(1);
declare variable scodtrattrib char(2);
declare variable icodfilialtt smallint;
declare variable icodfilialme smallint;
declare variable icodmens smallint;
declare variable percicmsitvenda numeric(15,5);
declare variable vlrbaseicmsitvenda numeric(15,5);
declare variable vlricmsitvenda numeric(15,5);
declare variable percipiitvenda numeric(15,5);
declare variable vlrbaseipiitvenda numeric(15,5);
declare variable vlripiitvenda numeric(15,5);
declare variable icodprod integer;
declare variable icodfilialpd integer;
declare variable vlrprecoitvenda numeric(15,5);
declare variable percdescitvenda numeric(15,5);
declare variable vlrliqitvenda numeric(15,5);
declare variable vlrproditvenda numeric(15,5);
declare variable obsitorc varchar(500);
declare variable ufcli char(2);
declare variable ufflag char(1);
declare variable percred numeric(15,5);
declare variable cloteprod char(1);
declare variable perccomisitvenda numeric(15,5);
declare variable geracomis char(1);
declare variable vlrcomisitvenda numeric(15,5);
declare variable codempif integer;
declare variable codfilialif smallint;
declare variable codfisc char(13);
declare variable coditfisc integer;
declare variable percissitvenda numeric(15,5);
declare variable vlrbaseissitvenda numeric(15,5);
declare variable vlrissitvenda numeric(15,5);
declare variable vlrisentasitvenda numeric(15,5);
declare variable vlroutrasitvenda numeric(15,5);
declare variable tipost char(2);
declare variable vlrbaseicmsstitvenda numeric(15,5);
declare variable vlricmsstitvenda numeric(15,5);
declare variable margemvlagritvenda numeric(15,5);
declare variable srefprod varchar(20);
declare variable stipoprod varchar(2);
declare variable percicmsst numeric(15,5);
declare variable vlrbaseicmsbrutitvenda numeric(15,5);
declare variable tpredicms char(1);
declare variable redbaseicmsst char(1);
declare variable qtditorc numeric(15,5);
begin
-- Inicialização de variaveis

    UFFLAG = 'N';

    select icodfilial from sgretfilial(:ICODEMP,'LFNATOPER') into ICODFILIALNT;
    select icodfilial from sgretfilial(:ICODEMP,'LFTRATTRIB') into ICODFILIALTT;
    select icodfilial from sgretfilial(:ICODEMP,'LFMENSAGEM') into ICODFILIALME;

    select vd.codfilialtm,vd.codtipomov from vdvenda vd where codvenda=:ICODVENDA and codfilial=:ICODFILIAL and codemp=:ICODEMP and tipovenda=:STIPOVENDA
    into ICODFILIALTM,ICODTIPOMOV;

-- Verifica se deve gerar comissão para a venda

    select geracomisvendaorc from sgprefere1 where codemp=:ICODEMP and codfilial=:ICODFILIAL into GERACOMIS;

-- Busca sequencia de numeração do ítem de venda

    select coalesce(max(coditvenda),0)+1 from vditvenda where codvenda=:ICODVENDA and codfilial=:ICODFILIAL and codemp=:ICODEMP and tipovenda=:STIPOVENDA
    into ICODITVENDA;

-- Informações do Orcamento

    select codcli,codfilialcl from vdorcamento where codemp=:ICODEMP and codfilial=:ICODFILIAL and codorc=:ICODORC into ICODCLI,ICODFILIALCL;

-- Informações do item de orçamento

    select it.codemppd, it.codfilialpd,it.codprod,it.precoitorc,it.percdescitorc,it.vlrliqitorc,it.vlrproditorc,it.refprod,it.obsitorc,
    it.codempax,it.codfilialax,it.codalmox,it.codlote,pd.cloteprod,pd.comisprod,pd.tipoprod, it.perccomisitorc, it.vlrcomisitorc, it.qtditorc
    from vditorcamento it, eqproduto pd
    where it.coditorc=:ICODITORC and it.codorc=:ICODORC and it.codfilial=:ICODFILIAL and it.codemp=:ICODEMP and
    pd.codemp=it.codemppd and pd.codfilial=it.codfilialpd and pd.codprod=it.codprod
    into ICODEMP,ICODFILIALPD,ICODPROD,VLRPRECOITVENDA,PERCDESCITVENDA,VLRLIQITVENDA,VLRPRODITVENDA,SREFPROD,OBSITORC,
    CODEMPAX,CODFILIALAX,CODALMOX,SCODLOTE,CLOTEPROD,perccomisitvenda,STIPOPROD,perccomisitvenda,vlrcomisitvenda, :qtditorc;

    -- Informações fiscais para a venda

    select coalesce(c.siglauf,c.ufcli)
    from vdorcamento o, vdcliente c
    where o.codorc=:ICODORC and o.codfilial=:ICODFILIAL and o.codemp=:ICODEMP and
    c.codcli=o.codcli and c.codfilial=o.codfilialcl and c.codemp=o.codempcl
    into ufcli;

    -- Busca informações fiscais para o ítem de venda (sem natureza da operação deve retornar apenas o coditfisc)

    select codempif,codfilialif,codfisc,coditfisc
    from lfbuscafiscalsp(:ICODEMP,:ICODFILIALPD,:ICODPROD,:ICODEMP,:ICODFILIALCL,:ICODCLI,:ICODEMP,:ICODFILIALTM,
    :ICODTIPOMOV, 'VD',null,null,null,null,null)
    into CODEMPIF,CODFILIALIF,CODFISC,CODITFISC;

-- Verifica se a venda é para outro estado

    select codnat from lfbuscanatsp(:FILIALATUAL,:ICODEMP,:ICODFILIALPD,:ICODPROD,:ICODEMP,:ICODFILIALCL,
    :ICODCLI,NULL,NULL,NULL,:ICODFILIALTM,:ICODTIPOMOV,:coditfisc)
    into SCODNAT;
    
    if (SCODNAT IS NULL) then
    begin
        exception vditvendaex03 :SREFPROD; -- NÃO FOI POSSÍVEL ENCONTRAR A NATUREZA DA OPERAÇÃO PARA O ÍTEM
    end

-- Busca informações fiscais para o ítem de venda (já sabe o coditfisc)

    select tipofisc,redfisc,codtrattrib,origfisc,codmens,aliqfisc,codempif,codfilialif,codfisc,coditfisc,tipost,
    margemvlagr,aliqipifisc,aliqfiscintra,tpredicmsfisc,redbasest,aliqiss
    from lfbuscafiscalsp(:ICODEMP,:ICODFILIALPD,:ICODPROD,:ICODEMP,:ICODFILIALCL,:ICODCLI,:ICODEMP,:ICODFILIALTM,
    :ICODTIPOMOV, 'VD',:scodnat,:codempif,:codfilialif,:codfisc,:coditfisc)
    into TIPOFISC,PERCRED,SCODTRATTRIB,SORIGFISC,ICODMENS,PERCICMSITVENDA,CODEMPIF,CODFILIALIF,CODFISC,CODITFISC,TIPOST,MARGEMVLAGRITVENDA,
    PERCIPIITVENDA,PERCICMSST, tpredicms, redbaseicmsst, PERCISSITVENDA;

-- Busca lote, caso seja necessário

    if (CLOTEPROD = 'S' and SCODLOTE is null) then
    begin
        select first 1 l.codlote from eqlote l
        where l.codprod=:ICODPROD and l.codfilial=:ICODFILIALPD and l.codemp=:ICODEMP and
        l.venctolote = ( select min(venctolote) from eqlote ls where ls.codprod=l.codprod and ls.codfilial=l.codfilial and ls.codemp=L.codemp and
                         ls.sldliqlote>=:IQTDITVENDA ) and
        l.sldliqlote>=:IQTDITVENDA
        into SCODLOTE;

        ICODFILIALLE = ICODFILIALPD;
    end
    
-- Inicializando valores

    VLRPRODITVENDA = VLRPRECOITVENDA * :IQTDITVENDA;
     if (:iqtditvenda<>:qtditorc) then
    begin
       VLRDESCITVENDA = (:VLRDESCITVENDA/:QTDITORC*:IQTDITVENDA);
    end
    VLRLIQITVENDA = VLRPRODITVENDA - :VLRDESCITVENDA;
    VLRBASEIPIITVENDA = 0;
    VLRBASEICMSITVENDA = 0;
    VLRICMSITVENDA = 0;
    VLRIPIITVENDA = 0;

    if (PERCICMSITVENDA = 0 or PERCICMSITVENDA is null) then
    begin
        select coalesce(PERCICMS,0) from lfbuscaicmssp (:SCODNAT,:UFCLI,:ICODEMP,:ICODFILIAL) into PERCICMSST;
    end

    if (PERCRED is null) then
    begin
        PERCRED = 0;
    end

    if(percred>0) then
    begin
        if(:tpredicms='B') then
        begin
            VLRBASEICMSITVENDA = (:VLRPRODITVENDA - :VLRDESCITVENDA) - ( (VLRPRODITVENDA - :VLRDESCITVENDA) * ( PERCRED / 100 ) );
            VLRICMSITVENDA = VLRBASEICMSITVENDA * ( PERCICMSITVENDA / 100 );
        end
        else if(:tpredicms='V') then
        begin
            VLRBASEICMSITVENDA = (:VLRPRODITVENDA - :VLRDESCITVENDA);
            VLRICMSITVENDA = (VLRBASEICMSITVENDA * ( PERCICMSITVENDA / 100 )) -  ( (VLRBASEICMSITVENDA * ( PERCICMSITVENDA / 100 ) * ( PERCRED / 100 ) )) ;
        end
    end
    else
    begin
        VLRBASEICMSITVENDA = :VLRPRODITVENDA - :VLRDESCITVENDA;
        VLRICMSITVENDA = VLRBASEICMSITVENDA * ( PERCICMSITVENDA / 100 );
    end

    VLRBASEIPIITVENDA = :VLRPRODITVENDA - :VLRDESCITVENDA;
    VLRBASEICMSBRUTITVENDA = :VLRPRODITVENDA - :VLRDESCITVENDA;
    VLRIPIITVENDA = VLRBASEIPIITVENDA * ( PERCIPIITVENDA / 100 );

-- **** Calculo dos tributos ***

-- Verifica se é um serviço (Calculo do ISS);

    if (:STIPOPROD = 'S') then
    begin
    -- Carregando aliquota do ISS
    -- Bloco comentado, pois já buscou o percentual do iss através da procedure.
   --     select percissfilial from sgfilial where codemp=:ICODEMP and codfilial=:ICODFILIAL
   --     into PERCISSITVENDA;

    -- Calculando e computando base e valor do ISS;
        if (:PERCISSITVENDA != 0) then
        begin
            VLRBASEISSITVENDA = :VLRLIQITVENDA;
            VLRISSITVENDA = :VLRBASEISSITVENDA * (:PERCISSITVENDA/100);
        end
    end
    else -- Se o item vendido não for SERVIÇO zera ISS
        VLRBASEISSITVENDA = 0;

    -- Se produto for isento de ICMS
    if (:TIPOFISC = 'II') then
    begin
        VLRISENTASITVENDA = :VLRLIQITVENDA;
        VLRBASEICMSITVENDA = 0;
        PERCICMSITVENDA = 0;
        VLRICMSITVENDA = 0;
        VLROUTRASITVENDA = 0;
    end
    -- Se produto for de Substituição Tributária
    else if (:TIPOFISC = 'FF') then
    begin
        if (:TIPOST = 'SI' ) then -- Contribuinte Substituído
        begin
            VLROUTRASITVENDA = :VLRLIQITVENDA;
            VLRBASEICMSITVENDA = 0;
            PERCICMSITVENDA = 0;
            VLRICMSITVENDA = 0;
            VLRISENTASITVENDA = 0;
        end
        else if (:TIPOST = 'SU' ) then -- Contribuinte Substituto
        begin

            if( (:PERCICMSST is null) or (:PERCICMSST=0) ) then
            begin
                select coalesce(PERCICMSINTRA,0) from lfbuscaicmssp (:SCODNAT,:UFCLI,:ICODEMP,:ICODFILIAL)
                into PERCICMSST;
            end

            if(percred>0 and redbaseicmsst='S') then
            begin
            -- Quando há redução na base do icms st , deve usar o valor da base do icms proprio como parametro
               vlrbaseicmsstitvenda = (  (coalesce(margemvlagritvenda,0) + 100) / 100 )  * (  (coalesce(vlrbaseicmsitvenda,0) ) + (coalesce(vlripiitvenda,0)) );
            end
            else
            begin
                -- Quando não há redução na base do icms st deve usar o valor da base bruto (rem redução)
                vlrbaseicmsstitvenda = (  (coalesce(margemvlagritvenda,0) + 100) / 100 )  * (  (coalesce(vlrbaseicmsbrutitvenda,0) ) + (coalesce(vlripiitvenda,0)) );
            end

            VLROUTRASITVENDA = 0;
            VLRISENTASITVENDA = 0;
            VLRICMSSTITVENDA = ( (:VLRBASEICMSSTITVENDA * :PERCICMSST) / 100 ) - (:VLRICMSITVENDA) ;

        end
    end

    -- Se produto não for tributado e não isento

    else if (:TIPOFISC = 'NN') then
    begin
        VLROUTRASITVENDA = :VLRLIQITVENDA;
        VLRBASEICMSITVENDA = 0;
        PERCICMSITVENDA = 0;
        VLRICMSITVENDA = 0;
        VLRISENTASITVENDA = 0;
    end

    -- Se produto for tributado integralmente

    else if (:TIPOFISC = 'TT') then
    begin
        VLROUTRASITVENDA = 0;
        VLRISENTASITVENDA = 0;
    end

    -- Inserindo dados na tabela de ítens de venda

    if ( TPAGRUP <> 'F' ) then
    begin

        insert into vditvenda (codemp,codfilial,codvenda,tipovenda,coditvenda,codempnt,codfilialnt,codnat,codemppd,
        codfilialpd,codprod,codemple,codfilialle,codlote,qtditvenda,precoitvenda,percdescitvenda,vlrdescitvenda,
        percicmsitvenda,vlrbaseicmsitvenda,vlricmsitvenda,percipiitvenda,vlrbaseipiitvenda,vlripiitvenda,vlrliqitvenda,
        vlrproditvenda,refprod,origfisc,codemptt,codfilialtt,codtrattrib,tipofisc,codempme,codfilialme,codmens,obsitvenda,
        codempax,codfilialax,codalmox,perccomisitvenda,vlrcomisitvenda,codempif,codfilialif,codfisc,coditfisc,percissitvenda,
        vlrbaseissitvenda,vlrissitvenda,vlrisentasitvenda,vlroutrasitvenda,tipost,vlrbaseicmsstitvenda,vlricmsstitvenda,
        margemvlagritvenda,vlrbaseicmsbrutitvenda)
        values (:ICODEMP,:ICODFILIAL,:ICODVENDA,:STIPOVENDA,:ICODITVENDA,:ICODEMP,
        :ICODFILIALNT,:SCODNAT,:ICODEMP,:ICODFILIALPD,:ICODPROD,:ICODEMP,:ICODFILIALPD,:SCODLOTE,:IQTDITVENDA,
        :VLRPRECOITVENDA,:PERCDESCITVENDA,:VLRDESCITVENDA,:PERCICMSITVENDA,:VLRBASEICMSITVENDA,:VLRICMSITVENDA,
        :PERCIPIITVENDA,:VLRBASEIPIITVENDA,:VLRIPIITVENDA,:VLRLIQITVENDA,:VLRPRODITVENDA,:SREFPROD,:SORIGFISC,
        :ICODEMP,:ICODFILIALTT,:SCODTRATTRIB,:TIPOFISC,:ICODEMP,:ICODFILIALME,:ICODMENS,:OBSITORC,
        :CODEMPAX,:CODFILIALAX,:CODALMOX,:perccomisitvenda,:vlrcomisitvenda,:CODEMPIF,:CODFILIALIF,:CODFISC,:CODITFISC,
        :PERCISSITVENDA,:VLRBASEISSITVENDA,:VLRISSITVENDA,:VLRISENTASITVENDA,:VLROUTRASITVENDA,:TIPOST,
        :VLRBASEICMSSTITVENDA,:VLRICMSSTITVENDA,:MARGEMVLAGRITVENDA,:vlrbaseicmsbrutitvenda);
    end

-- Atualizando informações de vínculo

    execute procedure vdupvendaorcsp(:ICODEMP,:ICODFILIAL,:ICODORC,:ICODITORC,:ICODFILIAL,:ICODVENDA,:ICODITVENDA,:STIPOVENDA);

end
^

/* Alter (VDADICVENDAORCSP) */
ALTER PROCEDURE VDADICVENDAORCSP(ICODORC INTEGER,
ICODFILIAL SMALLINT,
ICODEMP INTEGER,
STIPOVENDA CHAR(10),
NEWCODVENDA INTEGER)
 RETURNS(IRET INTEGER)
 AS
declare variable icodvenda integer;
declare variable ifilialvd smallint;
declare variable icodtipomov integer;
declare variable ifilialtm smallint;
declare variable sserie char(4);
declare variable ifilialse smallint;
declare variable sstatusvenda char(2);
declare variable dperccomvend numeric(9,2);
declare variable icodvend integer;
declare variable icodfilialvd integer;
declare variable icodcli integer;
declare variable icodfilialcl integer;
declare variable icodplanopag integer;
declare variable icodfilialpg integer;
declare variable usapedseq char(1);
declare variable iconta integer;
declare variable icodclcomis integer;
declare variable icodfilialcm integer;
declare variable vlrdescorc numeric(15,5);
BEGIN

/*Cod. Tipo Mov e Sequencia:*/
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'EQTIPOMOV') INTO IFILIALTM;
  SELECT COUNT(P.TIPOPROD) FROM EQPRODUTO P, VDITORCAMENTO I WHERE
    P.CODPROD=I.CODPROD AND P.CODFILIAL=I.CODFILIALPD AND P.CODEMP=I.CODEMPPD
    AND P.TIPOPROD = 'S' AND I.CODORC=:ICODORC
    AND I.CODFILIAL=:ICODFILIAL AND I.CODEMP=:ICODEMP INTO ICONTA;
    
  IF (ICONTA > 0) THEN
    SELECT CODTIPOMOV4,USAPEDSEQ FROM SGPREFERE1
      WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
      INTO ICODTIPOMOV,USAPEDSEQ;
  IF (ICODTIPOMOV IS NULL) THEN  /* CASO AINDA O IF DE CIMA NAO TENHA PREECHIDO... */
    SELECT CODTIPOMOV3,USAPEDSEQ FROM SGPREFERE1
      WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
      INTO ICODTIPOMOV,USAPEDSEQ;

/*Informações basicas:*/

  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'VDVENDA') INTO IFILIALVD;
  IF (USAPEDSEQ='S') THEN
    SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALVD,'VD') INTO ICODVENDA;
  ELSE
    IF ((:NEWCODVENDA > 0) AND (:NEWCODVENDA IS NOT NULL)) THEN
      ICODVENDA = :NEWCODVENDA;
    ELSE
      SELECT MAX(CODVENDA)+1 FROM VDVENDA
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:IFILIALVD
        INTO ICODVENDA;

/*Serie:*/
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'LFSERIE') INTO IFILIALSE;
  SELECT SERIE FROM EQTIPOMOV WHERE CODEMP=:ICODEMP AND CODFILIAL=:IFILIALTM AND CODTIPOMOV=:ICODTIPOMOV INTO SSERIE;

/*Status:*/
  SSTATUSVENDA = 'P1';

/*Busca no orçamento:*/
  SELECT O.CODFILIALVD,O.CODVEND,O.CODFILIALCL,O.CODCLI,O.CODFILIALPG,
    O.CODPLANOPAG,VE.PERCCOMVEND,O.CODCLCOMIS,O.CODFILIALCM, o.vlrdescorc
    FROM VDORCAMENTO O, VDVENDEDOR VE WHERE O.CODORC=:ICODORC
    AND O.CODFILIAL=:ICODFILIAL AND O.CODEMP=:ICODEMP
    AND VE.CODEMP=O.CODEMP AND VE.CODFILIAL=O.CODFILIALVD
    AND VE.CODVEND=O.CODVEND INTO
           :ICODFILIALVD,:ICODVEND,:ICODFILIALCL,:ICODCLI,
           :ICODFILIALPG,:ICODPLANOPAG,DPERCCOMVEND,:ICODCLCOMIS,:ICODFILIALCM,:vlrdescorc;

  INSERT INTO VDVENDA (
    CODEMP,CODFILIAL,CODVENDA,TIPOVENDA,CODEMPVD,CODFILIALVD,CODVEND,CODEMPCL,CODFILIALCL,CODCLI,
    CODEMPPG,CODFILIALPG,CODPLANOPAG,CODEMPSE,CODFILIALSE,SERIE,CODEMPTM,CODFILIALTM,CODTIPOMOV,
    DTSAIDAVENDA,DTEMITVENDA,STATUSVENDA,PERCCOMISVENDA,CODCLCOMIS,CODFILIALCM,CODEMPCM,vlrdescvenda)
    VALUES (
    :ICODEMP,:IFILIALVD,:ICODVENDA,:STIPOVENDA,:ICODEMP,:ICODFILIALVD,:ICODVEND,:ICODEMP,:ICODFILIALCL,:ICODCLI,
    :ICODEMP,:ICODFILIALPG,:ICODPLANOPAG,:ICODEMP,:IFILIALSE,:SSERIE,:ICODEMP,:IFILIALTM,:ICODTIPOMOV,
    CAST('today' AS DATE),CAST('today' AS DATE),:SSTATUSVENDA,:DPERCCOMVEND,:ICODCLCOMIS,:ICODFILIALCM,:ICODEMP,:VLRDESCORC );

  IRET = ICODVENDA;

  SUSPEND;
END
^

/* Alter (VDBAIXACOMISSAOSP) */
ALTER PROCEDURE VDBAIXACOMISSAOSP(STIPO CHAR(1),
DINI DATE,
DFIM DATE,
ICODVEND INTEGER,
ICODEMPVD INTEGER,
ICODFILIALVD SMALLINT,
SCODCONTA CHAR(10),
ICODEMPCA INTEGER,
ICODFILIALCA SMALLINT,
SCODPLAN CHAR(13),
ICODEMPPN INTEGER,
ICODFILIALPN SMALLINT,
DDATA DATE,
IDOC INTEGER,
DVLR NUMERIC(15,5),
SOBS CHAR(50),
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 AS
declare variable icodpcomi integer;
declare variable icodcomi integer;
declare variable icodempcomi integer;
declare variable icodfilialcomi integer;
declare variable cflag char(1);
declare variable ifilialpcomi integer;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNPAGTOCOMI') INTO IFILIALPCOMI;
  SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALPCOMI,'CI') INTO ICODPCOMI;
  INSERT INTO FNPAGTOCOMI(CODEMP,CODFILIAL,CODPCOMI,CODEMPCA,CODFILIALCA,NUMCONTA,CODEMPPN,CODFILIALPN,CODPLAN,DTCOMPPCOMI,DATAPCOMI,DOCPCOMI,VLRPCOMI,OBSPCOMI)
         VALUES (
                :ICODEMP,:IFILIALPCOMI,:iCodPComi,:ICODEMPCA,:ICODFILIALCA,:sCodConta,:ICODEMPPN,:ICODFILIALPN,:sCodPlan,:dData,:dData,:iDoc,:dVlr,:sObs
         );
  FOR SELECT C.CODCOMI,C.CODEMP,C.CODFILIAL,C.FLAG FROM VDCOMISSAO C,FNRECEBER R WHERE R.CODVEND=:iCodVend
               AND R.CODEMPVD=:ICODEMPVD AND R.CODFILIALVD=:ICODFILIALVD
               AND C.CODREC=R.CODREC AND C.CODEMPRC=R.CODEMP AND C.CODFILIALRC=R.CODFILIAL
               AND ( (:STIPO='E') OR  (C.DTVENCCOMI BETWEEN :dIni AND :dFim) )
               AND ( (:STIPO='V') OR  (C.DATACOMI BETWEEN :dIni AND :dFim) )
               AND STATUSCOMI='C2'
               AND R.CODEMP=:ICODEMP AND R.CODFILIAL=:ICODFILIAL
               INTO :iCodComi,:iCodEmpComi,:iCodFilialComi,:cFLAG DO
  BEGIN
     UPDATE VDCOMISSAO SET VLRPAGOCOMI=VLRAPAGCOMI, CODPCOMI=:iCodPComi,CODEMPCI=:ICODEMP,
        CODFILIALCI=:IFILIALPCOMI,STATUSCOMI='CP',DTPAGTOCOMI=:dData,FLAG=:cFLAG
      WHERE CODCOMI=:iCodComi AND CODEMP=:iCodEmpComi AND CODFILIAL=:iCodFilialComi;
  END
END
^

/* empty dependent procedure body */
/* Clear: ATBUSCAPRECOSP for: VDBUSCAPRECOSP */
/* AssignEmptyBody proc */
ALTER PROCEDURE ATBUSCAPRECOSP(ICODPROD INTEGER,
ICODCONV INTEGER,
ICODEMPCV INTEGER,
ICODFILIALCV SMALLINT,
ICODPLANOPAG INTEGER,
ICODEMPPG INTEGER,
ICODFILIALPG SMALLINT,
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 RETURNS(PRECO NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: VDADICITORCRECMERCSP for: VDBUSCAPRECOSP */
/* AssignEmptyBody proc */
ALTER PROCEDURE VDADICITORCRECMERCSP(CODEMP INTEGER,
CODFILIAL SMALLINT,
TICKET INTEGER,
CODEMPOC INTEGER,
CODFILIALOC SMALLINT,
CODORC INTEGER,
COMPONENTES CHAR(1),
SERVICOS CHAR(1),
NOVOS CHAR(1))
 AS
 BEGIN EXIT; END
^

/* Alter (VDBUSCAPRECOSP) */
ALTER PROCEDURE VDBUSCAPRECOSP(ICODPROD INTEGER,
ICODCLI INTEGER,
ICODEMPCL INTEGER,
ICODFILIALCL SMALLINT,
ICODPLANOPAG INTEGER,
ICODEMPPG INTEGER,
ICODFILIALPG SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPTM INTEGER,
ICODFILIALTM SMALLINT,
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 RETURNS(PRECO NUMERIC(14,5))
 AS
declare variable icodtab integer;
declare variable icodemptab integer;
declare variable icodfilialtab smallint;
declare variable icodclascli integer;
declare variable icodempclascli integer;
declare variable icodfilialclascli smallint;
declare variable percdesccli numeric(3,2);
declare variable desccli char(1);
declare variable arredpreco smallint;
declare variable codfilialpf integer;
declare variable centavos decimal(2,2);
declare variable codfilialprecoprod smallint;
begin
    -- Buscando código da filial de preferencias
    select icodfilial from sgretfilial(:icodemp,'SGFILIAL') into :codfilialpf;

   -- Buscando código da filial da tabela vdprecoprod
    select icodfilial from sgretfilial(:icodemp,'VDPRECOPROD') into :codfilialprecoprod;

    -- Buscando preferencias de arredondamento;
    select coalesce(arredpreco, 0)
    from sgprefere1 p1
    where p1.codemp=:icodemp and p1.codfilial=:codfilialpf
    into :arredpreco;

    -- Buscando tabela de preços do tipo de movimento;
    select codtab, codemptb, codfilialtb
    from eqtipomov
    where codtipomov=:icodtipomov and codemp=:icodemptm and codfilial=:icodfilialtm
    into :icodtab, :icodemptab, :icodfilialtab;

    -- Buscando informações do cliente;
    select codclascli, codempcc, codfilialcc, coalesce(percdesccli,0) percdesccli
    from vdcliente
    where codcli=:icodcli and codemp=:icodempcl and codfilial=:icodfilialcl
    into :icodclascli, :icodempclascli, icodfilialclascli, :percdesccli;

    -- Buscando preço da tabela de preços utilizando todos os filtros
    select precoprod from vdprecoprod pp
    where pp.codprod=:icodprod and pp.codplanopag=:icodplanopag and pp.codemppg=:icodemppg and pp.codfilialpg=:icodfilialpg
    and pp.codtab=:icodtab and pp.codemptb=:icodemptab and pp.codfilialtb=:icodfilialtab
    and pp.codclascli=:icodclascli and pp.codempcc=:icodempclascli and pp.codfilialcc=:icodfilialclascli
    and pp.codemp=:icodemp and pp.codfilial=:codfilialprecoprod
    into :preco;

    --Se não encontrou um preço de tabela usando todos os filtros, deve retirar o filtro de classificação do cliente
    if ((preco is null) or (preco = 0)) then
    begin
        select max(pp.precoprod) from vdprecoprod pp
        where pp.codprod=:icodprod and pp.codplanopag=:icodplanopag and pp.codemppg=:icodemppg
        and pp.codfilialpg=:icodfilialpg and pp.codtab=:icodtab and pp.codemptb=:icodemptab
        and pp.codfilialtb=:icodfilialtab and pp.codclascli is null
        and pp.codemp=:icodemp and pp.codfilial=:icodfilial
        into :preco;
    end

    --Se ainda não conseguiu pagar o preco, deve utilizar o preço base do produto aplicando o desconto especial do cliente se houver
    if ((preco is null) or (preco = 0)) then
    begin

        select coalesce(pd.precobaseprod,0), coalesce(pd.desccli,'N') from eqproduto pd
        where pd.codprod=:icodprod and pd.codemp=:icodemp and pd.codfilial=:icodfilial
        into :preco, :desccli;

        -- Verifica se o cliente possui desconto especial e o produto permite este desconto...
        if( percdesccli >0 and 'S' = :desccli ) then
        begin

            preco = :preco - (:preco * (:percdesccli / 100)) ;

        end

    end

    if( :arredpreco > 0 ) then
    begin

        -- capturando valor dos centavos
        centavos = ( cast(:preco as decimal(15,2)) - truncate(preco) ) * 10;

        -- se o valor em centavos é maior ou igual ao parametro de arredondamento (arredondar para cima)
        if(:centavos >= :arredpreco) then
        begin
            preco = truncate(preco) + 1;
        end
        else
        begin
            preco = truncate(preco);
        end

    end

    suspend;

end
^

/* Alter (VDCONTRATOTOTSP) */
ALTER PROCEDURE VDCONTRATOTOTSP(CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
CODCONTR INTEGER,
CODITCONTR INTEGER,
CODEMPSC INTEGER,
CODFILIALSC SMALLINT,
CODCONTRSC INTEGER,
CODEMPTA INTEGER,
CODFILIALTA SMALLINT,
CODTAREFA INTEGER,
CODEMPST INTEGER,
CODFILIALST SMALLINT,
CODTAREFAST INTEGER,
DATAINI DATE,
DATAFIM DATE)
 RETURNS(TOTALPREVGERAL NUMERIC(15,5),
TOTALPREVPER NUMERIC(15,5),
TOTALGERAL NUMERIC(15,5),
TOTALCOBCLIGERAL NUMERIC(15,5),
TOTALANT NUMERIC(15,5),
TOTALCOBCLIANT NUMERIC(15,5),
TOTALPER NUMERIC(15,5),
TOTALCOBCLIPER NUMERIC(15,5),
SALDOANT NUMERIC(15,5),
SALDOPER NUMERIC(15,5))
 AS
begin
  if (:codcontrsc is not null) then
  begin
     codempct = codempsc;
     codfilialct = codfilialsc;
     codcontr = codcontrsc;
  end
  if (:codtarefast is not null) then
  begin
     codempta = codempst;
     codfilialta = codfilialst;
     codtarefa = codtarefast;
  end
  select sum(a.totalgeral), sum(a.totalcobcli)
   from atatendimentovw02 a
    left outer join crtarefa ta
      on ta.codemp=a.codempta and ta.codfilial=a.codfilialta and ta.codtarefa=a.codtarefa
    left outer join crtarefa st
      on st.codempta=ta.codemp and st.codfilialta=ta.codemp and st.codtarefata=ta.codtarefa
    where a.codempct=:codempct and a.codfilialct=:codfilialct and a.codcontr=:codcontr and
    (:coditcontr is null or a.coditcontr=:coditcontr) and
    (
       (:codtarefa is null) or
       (st.codtarefa is null and ta.codemp=:codempta and ta.codfilial=:codfilialta and ta.codtarefa=:codtarefa ) or
       (st.codtarefa is not null and st.codempta=:codempta and st.codfilialta=:codfilialta and st.codtarefata=:codtarefa )
    )
  into :totalgeral,  :totalcobcligeral;

  select sum(a.totalgeral), sum(a.totalcobcli)
   from atatendimentovw02 a
    left outer join crtarefa ta
      on ta.codemp=a.codempta and ta.codfilial=a.codfilialta and ta.codtarefa=a.codtarefa
    left outer join crtarefa st
      on st.codempta=ta.codemp and st.codfilialta=ta.codemp and st.codtarefata=ta.codtarefa
    where a.codempct=:codempct and a.codfilialct=:codfilialct and a.codcontr=:codcontr and
    (:coditcontr is null or a.coditcontr=:coditcontr) and
      a.dataatendo between :dataini and :datafim and
    (
       (:codtarefa is null) or
       (st.codtarefa is null and ta.codemp=:codempta and ta.codfilial=:codfilialta and ta.codtarefa=:codtarefa ) or
       (st.codtarefa is not null and st.codempta=:codempta and st.codfilialta=:codfilialta and st.codtarefata=:codtarefa )
    )
  into :totalper,  :totalcobcliper;

  select sum(a.totalgeral), sum(a.totalcobcli)
   from atatendimentovw02 a
    left outer join crtarefa ta
     on ta.codemp=a.codempta and ta.codfilial=a.codfilialta and ta.codtarefa=a.codtarefa
    left outer join crtarefa st
      on st.codempta=ta.codemp and st.codfilialta=ta.codemp and st.codtarefata=ta.codtarefa
    where a.codempct=:codempct and a.codfilialct=:codfilialct and a.codcontr=:codcontr and
    (:coditcontr is null or a.coditcontr=:coditcontr) and
     a.dataatendo < :dataini and
    (
       (:codtarefa is null) or
       (st.codtarefa is null and ta.codemp=:codempta and ta.codfilial=:codfilialta and ta.codtarefa=:codtarefa ) or
       (st.codtarefa is not null and st.codempta=:codempta and st.codfilialta=:codfilialta and st.codtarefata=:codtarefa )
    )
  into :totalant,  :totalcobcliant;

  select sum(coalesce(st.tempodectarefa, ta.tempodectarefa) )
    from crtarefa ta
    left outer join crtarefa st
      on st.codempta=ta.codemp and st.codfilialta=ta.codemp and st.codtarefata=ta.codtarefa
    where ta.codempct=:codempct and ta.codfilialct=:codfilialct and ta.codcontr=:codcontr and
    (:coditcontr is null or ta.coditcontr=:coditcontr) and
    (
       (:codtarefa is null) or
       (st.codtarefa is null and ta.codemp=:codempta and ta.codfilial=:codfilialta and ta.codtarefa=:codtarefa ) or
       (st.codtarefa is not null and st.codempta=:codempta and st.codfilialta=:codfilialta and st.codtarefata=:codtarefa )
    )
  into totalprevgeral;

  select sum(tp.tempodectarefa)
   from crtarefa ttp, crtarefaper tp
    left outer join crtarefa ta
      on ta.codemp=ttp.codempta and ta.codfilial=ttp.codfilialta and ta.codtarefa=ttp.codtarefa
    left outer join crtarefa st
      on st.codempta=ta.codemp and st.codfilialta=ta.codemp and st.codtarefata=ta.codtarefa
    where ttp.codemp=tp.codemp and ttp.codfilial=tp.codfilial and ttp.codtarefa=tp.codtarefa and
      ttp.codempct=:codempct and ttp.codfilialct=:codfilialct and ttp.codcontr=:codcontr and
    (:coditcontr is null or ttp.coditcontr=:coditcontr) and
      tp.dtiniper>=:dataini and tp.dtfimper<=:datafim and
    (
       (:codtarefa is null) or
       (st.codtarefa is null and ta.codemp=:codempta and ta.codfilial=:codfilialta and ta.codtarefa=:codtarefa ) or
       (st.codtarefa is not null and st.codempta=:codempta and st.codfilialta=:codfilialta and st.codtarefata=:codtarefa )
    )
  into :totalprevper;

  if (totalgeral is null) then
      totalgeral = 0;
  if (totalcobcligeral is null) then
      totalcobcligeral = 0;
  if (totalant is null) then
      totalant = 0;
  if (totalcobcliant is null) then
      totalcobcliant = 0;
  if (totalper is null) then
      totalper = 0;
  if (totalcobcliper is null) then
      totalcobcliper = 0;
  saldoant = totalprevgeral - totalcobcliant;
  saldoper = totalprevper - totalcobcliper;

  suspend;
end
^

/* Alter (VDCOPIAORCSP) */
ALTER PROCEDURE VDCOPIAORCSP(CODEMP INTEGER,
CODFILIAL INTEGER,
CODORC INTEGER,
CODFILIALCL INTEGER,
CODCLI INTEGER)
 RETURNS(IRET INTEGER)
 AS
declare variable icodorc integer;
declare variable icodfilialpf integer;
declare variable cusaorcseq char(1);
declare variable vlrprodorc decimal(15,5);
declare variable percdescorc decimal(9,2);
declare variable vlrdescorc decimal(15,5);
declare variable vlradicorc decimal(15,5);
declare variable vlrdescitorc decimal(15,5);
declare variable vlrliqorc decimal(15,5);
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP, 'SGPREFERE1')
    INTO :ICODFILIALPF;
  SELECT USAORCSEQ FROM SGPREFERE1 P
     WHERE P.CODEMP=:CODEMP AND P.CODFILIAL=:ICODFILIALPF
     INTO :CUSAORCSEQ;
  IF (CUSAORCSEQ='S') THEN
  BEGIN
     SELECT ISEQ FROM SPGERANUM(:CODEMP,:CODFILIAL,'OC') INTO ICODORC;
  END
  ELSE
  BEGIN
     SELECT COALESCE(MAX(O.CODORC),0)+1 FROM VDORCAMENTO O
       WHERE O.CODEMP=:CODEMP AND O.CODFILIAL=:CODFILIAL AND
       O.TIPOORC='O' INTO ICODORC;
  END

  INSERT INTO VDORCAMENTO (CODEMP, CODFILIAL, TIPOORC, CODORC,
    CODEMPAE, CODFILIALAE, CODATEND, CODEMPCV, CODFILIALCV, CODCONV,
    DTORC, DTVENCORC, OBSORC, CODPLANOPAG, CODFILIALPG,
    CODEMPPG, TXT01, CODEMPVD, CODFILIALVD, CODVEND, CODEMPCL, CODFILIALCL,
    CODCLI, CODTPCONV, CODFILIALTC, CODEMPTC, PRAZOENTORC, statusorc)
    SELECT CODEMP, CODFILIAL, 'O', :ICODORC, CODEMPAE, CODFILIALAE,
      CODATEND, CODEMPCV, CODFILIALCV, CODCONV, DTORC, DTVENCORC,
      OBSORC, CODPLANOPAG, CODFILIALPG, CODEMPPG, TXT01, CODEMPVD,
      CODFILIALVD, CODVEND, :CODEMP, :CODFILIALCL, :CODCLI, CODTPCONV,
      CODFILIALTC, CODEMPTC, PRAZOENTORC, '*' FROM VDORCAMENTO WHERE
      CODORC=:CODORC AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL;

  INSERT INTO VDITORCAMENTO (CODEMP, CODFILIAL, TIPOORC, CODORC, CODITORC,
    CODEMPPD, CODFILIALPD, CODPROD, QTDITORC, PRECOITORC, PERCDESCITORC,
    VLRDESCITORC, VLRLIQITORC, VLRPRODITORC, REFPROD, NUMAUTORIZORC, ACEITEITORC,
    APROVITORC, EMITITORC, VENCAUTORIZORC, STRDESCITORC, OBSITORC,
    CODEMPAX, CODFILIALAX, CODALMOX)
    SELECT CODEMP, CODFILIAL, TIPOORC, :ICODORC, CODITORC,
      CODEMPPD, CODFILIALPD, CODPROD, QTDITORC, PRECOITORC, PERCDESCITORC,
      VLRDESCITORC, VLRLIQITORC, VLRPRODITORC, REFPROD, null, 'N',
      'N', 'N', VENCAUTORIZORC, STRDESCITORC, OBSITORC,
      CODEMPAX, CODFILIALAX, CODALMOX
      FROM VDITORCAMENTO
      WHERE CODORC=:CODORC AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL;

  SELECT VLRPRODORC, PERCDESCORC,VLRDESCORC,VLRADICORC,VLRDESCITORC,VLRLIQORC
      FROM VDORCAMENTO WHERE CODORC=:CODORC AND CODEMP=:CODEMP AND
      CODFILIAL=:CODFILIAL
      INTO :VLRPRODORC, :PERCDESCORC, :VLRDESCORC, :VLRADICORC, :VLRDESCITORC, :VLRLIQORC;

  UPDATE VDORCAMENTO SET VLRPRODORC=:VLRPRODORC, PERCDESCORC=:PERCDESCORC,
     VLRDESCORC=:VLRDESCORC, VLRADICORC=:VLRADICORC,
     VLRDESCITORC=:VLRDESCITORC, VLRLIQORC=:VLRLIQORC
     WHERE CODORC=:ICODORC AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL;

  IRET = ICODORC;
  SUSPEND;
END
^

/* Alter (VDESTORNACOMISSAOSP) */
ALTER PROCEDURE VDESTORNACOMISSAOSP(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
ICODVEND INTEGER,
DINI DATE,
DFIM DATE,
CORDEM CHAR(1))
 AS
declare variable icodcomi integer;
declare variable icodemprc integer;
declare variable scodfilialrc smallint;
declare variable icodrec integer;
declare variable inparcitrec integer;
declare variable nvlrvendacomi numeric(15,5);
declare variable nvlrcomi numeric(15,5);
declare variable ddatacomi date;
declare variable ddtcompcomi date;
declare variable ddtvenccomi date;
declare variable ctipocomi char(1);
declare variable cstatuscomi char(2);
declare variable datual date;
declare variable cstatusitrec char(2);
declare variable ddtvencitrec date;
begin
  /* Procedure Text */
  DATUAL = CAST( 'now' AS DATE);
  FOR SELECT C.CODCOMI,C.CODEMPRC, C.CODFILIALRC , C.CODREC, C.NPARCITREC,
      C.VLRVENDACOMI, C.VLRCOMI, C.DATACOMI , C.DTCOMPCOMI, C.DTVENCCOMI,
      C.TIPOCOMI, C.STATUSCOMI , IR.STATUSITREC, IR.DTVENCITREC
    FROM VDCOMISSAO C, FNITRECEBER IR, FNRECEBER R
    WHERE C.CODEMP=:ICODEMP AND C.CODFILIAL=:SCODFILIAL AND
       IR.CODEMP=C.CODEMPRC AND IR.CODFILIAL=C.CODFILIALRC AND
       IR.CODREC=C.CODREC AND IR.NPARCITREC=C.NPARCITREC AND
       R.CODEMP=C.CODEMPRC AND R.CODFILIAL=C.CODFILIALRC AND
       R.CODREC=C.CODREC AND R.CODEMPVD=:ICODEMPVD AND
       R.CODFILIALVD=:SCODFILIALVD AND R.CODVEND=:ICODVEND AND
       ( (:CORDEM = 'V')  OR (C.DATACOMI BETWEEN :DINI AND :DFIM) ) AND
       ( (:CORDEM = 'E')  OR (C.DTVENCCOMI BETWEEN :DINI AND :DFIM) ) AND
       C.STATUSCOMI IN ('C2','CP') AND
       IR.STATUSITREC NOT IN ('RP') AND
       NOT EXISTS(SELECT * FROM VDCOMISSAO C2 /* Sub-select para verificar a */
          /* existencia de estorno anterior. */
         WHERE C2.CODEMPRC=C.CODEMPRC AND C2.CODFILIALRC=C.CODFILIALRC AND
         C2.CODREC=C.CODREC AND C2.NPARCITREC=C.NPARCITREC AND
         C2.TIPOCOMI=C.TIPOCOMI AND C2.STATUSCOMI IN ('CE') )
    INTO :ICODCOMI, :ICODEMPRC, :SCODFILIALRC, :ICODREC, :INPARCITREC, :NVLRVENDACOMI,
      :NVLRCOMI, :DDATACOMI, :DDTCOMPCOMI, :DDTVENCCOMI, :CTIPOCOMI, :CSTATUSCOMI, :CSTATUSITREC,
      :DDTVENCITREC
  DO
  BEGIN
     IF ( (DATUAL>DDTVENCITREC) AND (CSTATUSCOMI='C2') ) THEN
     /* Caso a data atual seja maior que a data de vencimento e a */
     /* comissão não esteja paga, passa o status da comissão para não */
     /* liberada. */
     BEGIN
        UPDATE VDCOMISSAO SET STATUSCOMI='C1'
          WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL AND
            CODCOMI=:ICODCOMI;
     END
     ELSE IF ( (DATUAL>DDTVENCITREC) AND (CSTATUSCOMI='CP') ) THEN
     /* Caso a comissão esteja paga e a parcela esteja vencida, */
     /* gera um estorno da comissão. */
     BEGIN
        NVLRCOMI = NVLRCOMI * -1; /* Transforma o valor da comissão em negativo */
        /* para gerar estorno */
        EXECUTE PROCEDURE vdadiccomissaosp(:ICODEMPRC,:SCODFILIALRC,:ICODREC,
          :INPARCITREC, :NVLRVENDACOMI, :NVLRCOMI, :DDATACOMI , :DDTCOMPCOMI, :DDTVENCITREC,
          :CTIPOCOMI, :icodempvd, :scodfilialvd, : icodvend );
     END
  END
  suspend;
end
^

/* empty dependent procedure body */
/* Clear: FNITRECEBERSP01 for: VDGERACOMISSAOSP */
/* AssignEmptyBody proc */
ALTER PROCEDURE FNITRECEBERSP01(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
ICODREC INTEGER,
NVLRPARCREC NUMERIC(15,5),
NVLRCOMIREC NUMERIC(15,5),
INROPARCREC INTEGER,
CCLASCOMIS CHAR(1))
 AS
 BEGIN EXIT; END
^

/* Alter (VDGERACOMISSAOSP) */
ALTER PROCEDURE VDGERACOMISSAOSP(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
ICODREC INTEGER,
INPARCITREC INTEGER,
NVLRCOMIITREC NUMERIC(15,5),
DDTVENCITREC DATE)
 AS
declare variable icodempva integer;
declare variable scodfilialva smallint;
declare variable ctipovenda char(3);
declare variable icodvenda integer;
declare variable icodempcm integer;
declare variable scodfilialcm smallint;
declare variable icodclcomis integer;
declare variable nvlrvendacomi numeric(15,5);
declare variable ddatacomi date;
declare variable ddtcompcomi date;
declare variable npercfatclcomis numeric(9,2);
declare variable npercpgtoclcomis numeric(9,2);
declare variable ctipocomi char(1);
declare variable nvlrcomi numeric(15,5);
declare variable i integer;
declare variable icodemptm integer;
declare variable scodfilialtm smallint;
declare variable icodtipomov integer;
declare variable cmulticomis char(1);
declare variable icodempvd integer; /* Código da empresa do comissionado principal */
declare variable scodfilialvd smallint; /* Código da filial do comissionado principal */
declare variable icodvend integer; /* Código do comissionado principal */
declare variable nperccomisvendadic numeric(15,2); /* Percentual de comissão para cada comissionado adicional */
declare variable nvlrcomiadic numeric(15,5); /* Valor total da comissão para os comissionados adicionais. */
declare variable icodempvdadic integer; /* Código da empresa do comissionado adicional */
declare variable scodfilialvdadic smallint; /* Código da filial do comissionado adicional */
declare variable icodvendadic integer; /* Código do comissionado adicional */
declare variable nvlrcomiparc numeric(15,5); /* Valor da comissão por vendedor parcial. */
begin
    /* Gera as comissões a pagar na tabela VDCOMISSAO */


    nvlrcomiadic = 0;

    select r.codempva, r.codfilialva, r.tipovenda, r.codvenda,
        v.codempcm, v.codfilialcm, v.codclcomis, ( v.vlrprodvenda - v.vlrdescvenda ),
        v.dtemitvenda, v.dtcompvenda, cm.percfatclcomis, cm.percpgtoclcomis,
        v.codemptm, v.codfilialtm, v.codtipomov,
        v.codempvd, v.codfilialvd, v.codvend
        from fnreceber r, vdvenda v, vdclcomis cm
        where r.codemp=:icodemp and r.codfilial=:scodfilial and r.codrec=:icodrec
            and v.codemp=r.codempva and v.codfilial=r.codfilialva and v.tipovenda=r.tipovenda
            and v.codvenda=r.codvenda and cm.codemp=v.codempcm and cm.codfilial=v.codfilialcm
            and cm.codclcomis=v.codclcomis
    into :icodempva, :scodfilialva, :ctipovenda, :icodvenda,
         :icodempcm, :scodfilialcm, :icodclcomis, :nvlrvendacomi,
         :ddatacomi, :ddtcompcomi, :npercfatclcomis, :npercpgtoclcomis,
         :icodemptm, :scodfilialtm, :icodtipomov,
         :icodempvd, :scodfilialvd, :icodvend ;

    /*Verifica se deve utilizar mecanismo de multiplos comissionados*/

    select cmulticomis from sgretmulticomissp(:icodemp, :icodemptm, :scodfilialtm, :icodtipomov)
        into cmulticomis;

    if(cmulticomis = 'S') then
    begin

        /*Implementação do mecanismo de multiplos comissionados*/
        
        for select vc.codempvd, vc.codfilialvd, vc.codvend, vc.percvc
            from vdvendacomis vc
            where vc.codemp=:icodempva and vc.codfilial=:scodfilialva and vc.codvenda=:icodvenda
                and vc.tipovenda=:ctipovenda and vc.codvend is not null
        into :icodempvdadic, :scodfilialvdadic, :icodvendadic, :nperccomisvendadic do
        begin

            /* Calcula o valor da comissão proporcional para cada comissionado adicional*/

            nvlrcomi = cast( ( nvlrcomiitrec * nperccomisvendadic / 100 ) as numeric(15,5));
            I = 1;
            while (:I<=2) do
            begin
                if (I=1) then
                    begin
                        ctipocomi='F';
                        nvlrcomiparc = cast( ( nvlrcomi * npercfatclcomis / 100 ) as NUMERIC(15, 5));
                    end
                else
                    begin
                        ctipocomi='R';
                        nvlrcomiparc = cast( (nvlrcomi * npercpgtoclcomis / 100 ) as NUMERIC(15, 5));
                    end
                execute procedure vdadiccomissaosp(:iCodEmp, :sCodFilial, :iCodRec, :iNParcItRec,
                    :nVlrVendaComi, :nvlrcomiparc, :dDataComi, :dDtCompComi, :dDtVencItRec, cTipoComi,:icodempvdadic, :scodfilialvdadic, :icodvendadic );
                I=I+1;
                /*Acumula as comissões adicionais para posteriormente descontar do valor principal*/
                nvlrcomiadic = nvlrcomiadic + nvlrcomiparc;

           /*     exception vdcomissaoex02 'rodou procedure para o vendedor:' || cast(:icodempvdadic as char(2)) || '-' || cast(:scodfilialvdadic as char(2)) || '-' || cast(:icodvendadic as char(2)) || '-' || ' - nvlrcomiadic:' || cast(nvlrcomiadic as char(20));*/

            end

        end

    end

    /*Comissionamento do vendedor principal*/

    I = 1;
    while (:I<=2) do
        begin
            if (I=1) then
                begin
                    ctipocomi='F';
                    nvlrcomi = cast( ( (nvlrcomiitrec - nvlrcomiadic ) * nPercFatClComis / 100 ) as numeric(15, 5) );
                end
            else
                begin
                    ctipocomi='R';
                    nvlrcomi = cast( ( (nvlrcomiitrec - nvlrcomiadic ) * nPercPgtoClComis / 100 ) as numeric(15, 5));
                end
/*
                exception vdcomissaoex01 ''
                || cast(:icodempvd as char(2)) || '-' || cast(:scodfilialvd as char(2)) || '-' || cast(:icodvend as char(2))
                || 'nvlrcomi:' || cast(:nvlrcomi as char(20))
                || 'nvlrvendacomi:' || cast(:nvlrvendacomi as char(20));
  */
            execute procedure vdadiccomissaosp(:icodemp, :scodfilial, :icodrec, :inparcitrec,
                :nvlrvendacomi, :nvlrcomi, :ddatacomi, :ddtcompcomi, :ddtvencitrec, ctipocomi, :icodempvd, :scodfilialvd, :icodvend );


            I=I+1;
        end

        suspend;
end
^

/* Alter (VDRETULTVDCLIPROD) */
ALTER PROCEDURE VDRETULTVDCLIPROD(ICODEMP INTEGER,
ICODCLI INTEGER,
ICODFILIALVD SMALLINT,
ICODVEND INTEGER,
DTINI DATE,
DTFIM DATE,
CODEMPTIPOCL INTEGER,
CODFILIALTIPOCL SMALLINT,
CODTIPOCLI INTEGER)
 RETURNS(RAZCLI_RET CHAR(50),
CODCLI_RET INTEGER,
DESCPROD_RET CHAR(50),
CODPROD_RET INTEGER,
DTEMITVENDA_RET DATE,
DOCVENDA_RET INTEGER,
SERIE_RET CHAR(4),
PRECOVENDA_RET NUMERIC(15,4))
 AS
declare variable icodfilial smallint;
declare variable icodprod integer;
begin

    select icodfilial from sgretfilial(:ICODEMP,'VDVENDA') into :ICODFILIAL;

    for select v.codcli,iv.codprod
        from vdvenda v, vdcliente cl, vditvenda iv
        where
            iv.codemp=v.codemp and iv.codfilial=v.codfilial
            and iv.tipovenda=v.TIPOVENDA and iv.codvenda=v.codvenda
            and v.codemp=:ICODEMP and v.codfilial=:ICODFILIAL
            and (v.codcli=:ICODCLI or :ICODCLI is null)
            and (v.codvend=:ICODVEND or :ICODVEND is null )
            and v.dtemitvenda between :DTINI and :DTFIM
            and cl.codemp=v.codempcl and cl.codfilial=v.codfilialcl and cl.codcli=v.codcli
            and (cl.codtipocli=:codtipocli or :codtipocli is null)
        group by v.codcli,iv.codprod into :ICODCLI,:ICODPROD
    do
    begin
        select first 1 c.razcli, c.codcli, p.descprod, iv.codprod, v.dtemitvenda, v.docvenda, v.serie,
            (iv.vlrliqitvenda/(case when iv.qtditvenda=0 then 1 else iv.qtditvenda end)) precovenda
        from vdcliente c, vdvenda v, vditvenda iv, eqproduto p
        where
            c.codemp=v.codempcl and c.codfilial=v.codfilialcl and c.codcli=v.codcli
            and c.codemp=v.codempcl and c.codfilial=v.codfilialcl and iv.codemp=v.codemp
            and iv.codfilial=v.codfilial and iv.tipovenda=v.tipovenda and iv.codvenda=v.codvenda
            and p.codemp=iv.codemppd and p.codfilial=iv.codfilialpd and p.codprod=iv.codprod
            and v.codempvd=:ICODEMP and v.codfilialvd=:ICODFILIALVD and (v.codvend=:ICODVEND or :ICODVEND is null )
            and v.dtemitvenda between :DTINI and :DTFIM and c.codcli=:ICODCLI and p.codprod=:ICODPROD
            order by v.dtemitvenda desc
            into :RAZCLI_RET, :CODCLI_RET, :DESCPROD_RET, :CODPROD_RET, :DTEMITVENDA_RET, :DOCVENDA_RET, :SERIE_RET,
                 :PRECOVENDA_RET;
            suspend;
    end
end
^

/* Restore procedure body: ATBUSCAPRECOSP */
ALTER PROCEDURE ATBUSCAPRECOSP(ICODPROD INTEGER,
ICODCONV INTEGER,
ICODEMPCV INTEGER,
ICODFILIALCV SMALLINT,
ICODPLANOPAG INTEGER,
ICODEMPPG INTEGER,
ICODFILIALPG SMALLINT,
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 RETURNS(PRECO NUMERIC(15,5))
 AS
DECLARE VARIABLE iCodTipoMov INTEGER;
  DECLARE VARIABLE iCodEmpTM INTEGER;
  DECLARE VARIABLE iCodFilialTM INTEGER;
  DECLARE VARIABLE iCodCli INTEGER;
  DECLARE VARIABLE iCodEmpCli INTEGER;
  DECLARE VARIABLE iCodFilialCli INTEGER;
BEGIN
  SELECT CODTIPOMOV2,CODEMPT2,CODFILIALT2 FROM SGPREFERE1 WHERE CODEMP=:ICODEMP
         AND CODFILIAL=:ICODFILIAL INTO iCodTipoMov,iCodEmpTM,iCodFilialTM;
  SELECT CODCLI,CODEMPCL,CODFILIALCL FROM ATCONVENIADO WHERE CODCONV=:ICODCONV
         AND CODEMP=:ICODEMPCV AND CODFILIAL=:ICODFILIALCV INTO iCodCli,iCodEmpCli,iCodFilialCli;

  SELECT PRECO FROM VDBUSCAPRECOSP(:ICODPROD,:iCodCli,:iCodEmpCli,:iCodFilialCli,:ICODPLANOPAG,:ICODEMPPG,
    :ICODFILIALPG,:iCodTipoMov,:iCodEmpTM,:iCodFilialTM,:ICODEMP,:ICODFILIAL) INTO PRECO;

  SUSPEND;
END
^

/* Restore procedure body: CPADICFORSP */
ALTER PROCEDURE CPADICFORSP(CODEMP INTEGER,
CODFILIAL INTEGER,
CODFILIALCL INTEGER,
CODCLI INTEGER)
 RETURNS(CODFOR INTEGER)
 AS
DECLARE VARIABLE CODTIPOFOR INTEGER;
DECLARE VARIABLE CODFILIALTF INTEGER;
DECLARE VARIABLE CODFILIALFR INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'CPFORNECED') INTO CODFILIALFR;
  SELECT P.CODTIPOFOR,P.CODFILIALTF FROM SGPREFERE1 P WHERE P.CODEMP=:CODEMP
    AND P.CODFILIAL=:CODFILIAL INTO CODTIPOFOR,CODFILIALTF;
  SELECT MAX(CODFOR)+1 FROM CPFORNECED WHERE CODEMP=:CODEMP
    AND CODFILIAL=:CODFILIALFR INTO CODFOR;
  INSERT INTO CPFORNECED (CODEMP,CODFILIAL,CODFOR,RAZFOR,CODEMPTF,CODFILIALTF,
                        CODTIPOFOR,CODEMPBO,CODFILIALBO,CODBANCO,NOMEFOR,
                        DATAFOR,ATIVOFOR,PESSOAFOR,CNPJFOR,CPFFOR,INSCFOR,
                        RGFOR,ENDFOR,NUMFOR,COMPLFOR,BAIRFOR,CEPFOR,CIDFOR,
                        UFFOR,CONTFOR,FONEFOR,FAXFOR,AGENCIAFOR,CONTAFOR,
                        EMAILFOR,OBSFOR,CELFOR,CLIFOR)
                 SELECT :CODEMP,:CODFILIALFR,:CODFOR,RAZCLI,:CODEMP,:CODFILIALTF,
                        :CODTIPOFOR,NULL,NULL,NULL,NOMECLI,
                        DATACLI,ATIVOCLI,PESSOACLI,CNPJCLI,CPFCLI,INSCCLI,
                        RGCLI,ENDCLI,NUMCLI,COMPLCLI,BAIRCLI,CEPCLI,CIDCLI,
                        UFCLI,CONTCLI,FONECLI,FAXCLI,NULL,NULL,
                        EMAILCLI,OBSCLI,CELCLI,'C' FROM VDCLIENTE WHERE
                        CODCLI=:CODCLI AND CODFILIAL=:CODFILIALCL AND
                        CODEMP=:CODEMP;
  SUSPEND;
END
^

/* Restore procedure body: CPADICITCOMPRAPEDSP */
ALTER PROCEDURE CPADICITCOMPRAPEDSP(CODEMP INTEGER,
CODFILIAL SMALLINT,
CODCOMPRA INTEGER,
CODEMPPC INTEGER,
CODFILIALPC SMALLINT,
CODCOMPRAPC INTEGER,
CODITCOMPRAPC INTEGER,
TPAGRUP CHAR(1),
QTDITCOMPRA FLOAT,
VLRDESCITCOMPRA NUMERIC(15,5),
PRECOITCOMPRA NUMERIC(15,5))
 AS
declare variable codemptm integer;
declare variable codfilialtm smallint;
declare variable codtipomov integer;
declare variable codempfr integer;
declare variable codfilialfr smallint;
declare variable codfor integer;
declare variable coditcompra integer;
declare variable codemppd integer;
declare variable codfilialpd smallint;
declare variable codprod integer;
declare variable refprod varchar(20);
declare variable percdescitcompra numeric(15,5);
declare variable vlrliqitcompra numeric(15,5);
declare variable codempax integer;
declare variable codfilialax smallint;
declare variable codalmox integer;
declare variable codlote varchar(20);
declare variable cloteprod char(1);
declare variable uffor char(2);
declare variable codempnt integer;
declare variable codfilialnt smallint;
declare variable codnat char(4);
declare variable tipofisc char(2);
declare variable percred numeric(9,2);
declare variable codtrattrib char(2);
declare variable origfisc char(1);
declare variable codmens smallint;
declare variable percicmsitcompra numeric(9,2);
declare variable codempif integer;
declare variable codfilialif smallint;
declare variable codfisc char(13);
declare variable coditfisc integer;
declare variable tipost char(2);
declare variable margemvlagr numeric(15,5);
declare variable percipiitcompra numeric(9,2);
declare variable percicmsst numeric(9,2);
declare variable tpredicms char(1);
declare variable redbaseicmsst char(1);
declare variable vlrproditcompra numeric(15,5);
declare variable vlrbaseipiitcompra numeric(15,5);
declare variable vlripiitcompra numeric(15,5);
declare variable vlrbaseicmsitcompra numeric(15,5);
declare variable vlricmsitcompra numeric(15,5);
declare variable vlrbaseicmsbrutitcompra numeric(15,5);
declare variable vlrisentasitcompra numeric(15,5);
declare variable vlroutrasitcompra numeric(15,5);
declare variable vlrbaseicmsstitcompra numeric(15,5);
declare variable vlricmsstitcompra numeric(15,5);
begin

-- Inicialização de variaveis

    select icodfilial from sgretfilial(:codemp, 'LFNATOPER') into :codfilialnt;

    select cp.codemptm, cp.codfilialtm, cp.codtipomov, cp.codempfr,  cp.codfilialfr, cp.codfor, coalesce(fr.siglauf, fr.uffor) uffor
    from cpcompra cp, cpforneced fr
    where cp.codcompra=:codcompra and cp.codfilial=:codfilial and cp.codemp=:codemp and
    fr.codemp=cp.codempfr and fr.codfilial=cp.codfilialfr and fr.codfor=cp.codfor
    into :codemptm, :codfilialtm, :codtipomov, :codempfr, :codfilialfr, :codfor, :uffor ;

-- Busca sequencia de numeração do ítem de compra

    select coalesce(max(coditcompra),0)+1 from cpitcompra where codcompra=:codcompra and codfilial=:codfilial and codemp=:codemp
    into :coditcompra;

-- Informações do item do pedido de compra

    select it.codemppd, it.codfilialpd, it.codprod, it.percdescitcompra, it.vlrliqitcompra, it.vlrproditcompra, it.refprod,
    it.codempax, it.codfilialax, it.codalmox, it.codlote, pd.cloteprod
    from cpitcompra it, eqproduto pd
    where it.coditcompra=:coditcomprapc and it.codcompra=:codcomprapc and it.codfilial=:codfilialpc and it.codemp=:codemppc
    and pd.codemp=it.codemppd and pd.codfilial=it.codfilialpd and pd.codprod=it.codprod
    into :codemppd, :codfilialpd, :codprod, :percdescitcompra, :vlrliqitcompra, :vlrproditcompra, :refprod,
    :codempax, :codfilialax, :codalmox, :codlote, :cloteprod;

-- Buscando a natureza de operação para o ítem de compra

    select codnat from lfbuscanatsp(:codfilial, :codemp, :codfilialpd, :codprod, null, null, null, :codempfr, :codfilialfr, :codfor,
    :codfilialtm, :codtipomov, null)
    into :codnat;
    
    if (:codnat is null) then
    begin
        exception cpitcompraex04 ' produto:' || :refprod; -- NÃO FOI POSSÍVEL ENCONTRAR A NATUREZA DA OPERAÇÃO PARA O ÍTEM
    end

-- Busca informações fiscais para o ítem de compra

    select tipofisc,redfisc,codtrattrib,origfisc,codmens,aliqfisc,codempif,codfilialif,codfisc,coditfisc,tipost,margemvlagr,
    aliqipifisc,aliqfiscintra,tpredicmsfisc,redbasest
    from lfbuscafiscalsp(:codemppd, :codfilialpd, :codprod, :codempfr,:codfilialfr, :codfor,
    :codemptm, :codfilialtm, :codtipomov, 'CP', :codnat,null,null,null,null)
    into :tipofisc, :percred, :codtrattrib, :origfisc, :codmens, :percicmsitcompra, :codempif, :codfilialif, :codfisc, :coditfisc, :tipost,
    :margemvlagr, :percipiitcompra, :percicmsst, :tpredicms, :redbaseicmsst;
    
-- Inicializando valores

    vlrproditcompra = :precoitcompra * :qtditcompra;
    vlrliqitcompra = :vlrproditcompra - :vlrdescitcompra;
    vlrbaseipiitcompra = 0;
    vlrbaseicmsitcompra = 0;
    vlricmsitcompra = 0;
    vlripiitcompra = 0;

    if (:percicmsitcompra = 0 or :percicmsitcompra is null) then
    begin
        select coalesce(percicms, 0) from lfbuscaicmssp (:codnat, :uffor,:codemp, :codfilial) into :percicmsst;
    end

    if (:percred is null) then
    begin
        percred = 0;
    end

    if(percred>0) then
    begin
        if(:tpredicms='B') then
        begin
            vlrbaseicmsitcompra = (:vlrproditcompra - :vlrdescitcompra) - ( (:vlrproditcompra - :vlrdescitcompra) * ( :percred / 100 ) );
        end
        else if(:tpredicms='V') then
        begin
            vlricmsitcompra = (:vlrbaseicmsitcompra * ( :percicmsitcompra / 100 )) -  ( (:vlrbaseicmsitcompra * ( :percicmsitcompra / 100 ) * ( :percred / 100 ) )) ;
        end
    end
    else
    begin
        vlrbaseicmsitcompra = :vlrproditcompra - :vlrdescitcompra;
        vlricmsitcompra = :vlrbaseicmsitcompra * ( :percicmsitcompra / 100 );
    end

    vlrbaseipiitcompra = :vlrproditcompra - :vlrdescitcompra;
    vlrbaseicmsbrutitcompra = :vlrproditcompra - :vlrdescitcompra;
    vlripiitcompra = :vlrbaseipiitcompra * ( :percipiitcompra / 100 );

-- **** Calculo dos tributos ***

    -- Se produto for isento de ICMS
    if (:tipofisc = 'II') then
    begin
        vlrisentasitcompra = :vlrliqitcompra;
        vlrbaseicmsitcompra = 0;
        percicmsitcompra = 0;
        vlricmsitcompra = 0;
        vlroutrasitcompra = 0;
    end
    -- Se produto for de Substituição Tributária
    else if (:tipofisc = 'FF') then
    begin
        if (:tipost = 'SI' ) then -- Contribuinte Substituído
        begin
            vlroutrasitcompra = :vlrliqitcompra;
            vlrbaseicmsitcompra = 0;
            percicmsitcompra = 0;
            vlricmsitcompra = 0;
            vlrisentasitcompra = 0;
        end
        else if (:tipost = 'SU' ) then -- Contribuinte Substituto
        begin

            if( (:percicmsst is null) or (:percicmsst=0) ) then
            begin
                select coalesce(percicmsintra,0) from lfbuscaicmssp (:codnat,:uffor,:codemp,:codfilial)
                into :percicmsst;
            end

            if(percred>0 and redbaseicmsst='S') then
            begin
            -- Quando há redução na base do icms st , deve usar o valor da base do icms proprio como parametro
               vlrbaseicmsstitcompra = (  (coalesce(:margemvlagr,0) + 100) / 100 )  * (  (coalesce(:vlrbaseicmsitcompra,0) ) + (coalesce(:vlripiitcompra,0)) );
            end
            else
            begin
                -- Quando não há redução na base do icms st deve usar o valor da base bruto (rem redução)
                vlrbaseicmsstitcompra = (  (coalesce(:margemvlagr,0) + 100) / 100 )  * (  (coalesce(:vlrbaseicmsbrutitcompra,0) ) + (coalesce(:vlripiitcompra,0)) );
            end

            vlroutrasitcompra = 0;
            vlrisentasitcompra = 0;
            vlricmsstitcompra = ( (:vlrbaseicmsstitcompra * :percicmsst) / 100 ) - (:vlricmsitcompra) ;

        end
    end

    -- Se produto não for tributado e não isento

    else if (:tipofisc = 'NN') then
    begin
        vlroutrasitcompra = :vlrliqitcompra;
        vlrbaseicmsitcompra = 0;
        percicmsitcompra = 0;
        vlricmsitcompra = 0;
        vlrisentasitcompra = 0;
    end

    -- Se produto for tributado integralmente

    else if (:tipofisc = 'TT') then
    begin
        vlroutrasitcompra = 0;
        vlrisentasitcompra = 0;
    end

    -- Inserindo dados na tabela de ítens de compra

    if ( :tpagrup <> 'F' ) then
    begin

        insert into cpitcompra (codemp, codfilial, codcompra, coditcompra, codempnt, codfilialnt, codnat, codemppd,
        codfilialpd, codprod, codemple, codfilialle, codlote, qtditcompra, precoitcompra, percdescitcompra,vlrdescitcompra,
        percicmsitcompra,vlrbaseicmsitcompra,vlricmsitcompra,percipiitcompra,vlrbaseipiitcompra,vlripiitcompra,vlrliqitcompra,
        vlrproditcompra,refprod, codempax,codfilialax,codalmox, codempif,codfilialif,codfisc,coditfisc,vlrisentasitcompra, vlroutrasitcompra)
        values (:codemp, :codfilial, :codcompra, :coditcompra, :codemp, :codfilialnt, :codnat, :codemp,:codfilialpd, :codprod,
        :codemp, :codfilialpd, :codlote, :qtditcompra, :precoitcompra,:percdescitcompra,:vlrdescitcompra,:percicmsitcompra,:vlrbaseicmsitcompra,
        :vlricmsitcompra, :percipiitcompra, :vlrbaseipiitcompra, :vlripiitcompra, :vlrliqitcompra,:vlrproditcompra,:refprod,
        :codempax, :codfilialax, :codalmox, :codempif, :codfilialif, :codfisc, :coditfisc, :vlrisentasitcompra,:vlroutrasitcompra
        );
    end

-- Atualizando informações de vínculo

    execute procedure cpupcomprapedsp(:codemp, :codfilial,:codcompra, :coditcompra, :codemppc, :codfilialpc, :codcomprapc, :coditcomprapc);

end
^

/* Restore procedure body: CPGERAENTRADASP */
ALTER PROCEDURE CPGERAENTRADASP(CODEMP INTEGER,
CODFILIAL INTEGER,
CODFILIALVD INTEGER,
TIPOVENDA CHAR(1),
CODVENDA INTEGER,
CITEM CHAR(1))
 RETURNS(CODCOMPRA INTEGER)
 AS
DECLARE VARIABLE STATUSVENDA CHAR(2);
DECLARE VARIABLE CODCLI INTEGER;
DECLARE VARIABLE CODFILIALCL INTEGER;
DECLARE VARIABLE CODFILIALCP INTEGER;
DECLARE VARIABLE CODTIPOMOV INTEGER;
DECLARE VARIABLE CODFILIALTM INTEGER;
DECLARE VARIABLE SERIE INTEGER;
DECLARE VARIABLE CODFILIALSE INTEGER;
DECLARE VARIABLE DOC INTEGER;
DECLARE VARIABLE CODFOR INTEGER;
DECLARE VARIABLE CODFILIALFR INTEGER;
DECLARE VARIABLE CODITVENDA INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'CPFORNECED') INTO CODFILIALFR;
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'CPCOMPRA') INTO CODFILIALCP;
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'VDCLINTE') INTO CODFILIALCL;

  SELECT ISEQ FROM SPGERANUM(:CODEMP,:CODFILIAL,'CP') INTO CODCOMPRA;

  SELECT CODCLI,CODFILIALCL,STATUSVENDA FROM VDVENDA WHERE CODVENDA=:CODVENDA AND TIPOVENDA=:TIPOVENDA
    AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL INTO CODCLI,CODFILIALCL,STATUSVENDA;
  IF (SUBSTRING (STATUSVENDA FROM 1 FOR 1) = 'C') THEN
    EXCEPTION VDVENDAEX05;
  
  SELECT CODFOR FROM CPADICFORSP(:CODEMP,:CODFILIAL,:CODFILIALCL,:CODCLI) INTO CODFOR;

  SELECT P.CODTIPOMOV5,P.CODFILIALT5,
    T.SERIE,T.CODFILIALSE FROM SGPREFERE1 P, EQTIPOMOV T WHERE P.CODEMP=:CODEMP
    AND P.CODFILIAL=:CODFILIAL AND T.CODTIPOMOV=P.CODTIPOMOV5 AND
    T.CODEMP=P.CODEMPT5 AND T.CODFILIAL=P.CODFILIALT5
    INTO CODTIPOMOV,CODFILIALTM,SERIE,CODFILIALSE;

  SELECT * FROM LFNOVODOCSP(:SERIE,:CODEMP,:CODFILIALSE) INTO DOC;

  INSERT INTO CPCOMPRA (CODEMP,CODFILIAL,CODCOMPRA,CODEMPPG,CODFILIALPG,CODPLANOPAG,
                        CODEMPFR,CODFILIALFR,CODFOR,CODEMPSE,CODFILIALSE,SERIE,
                        CODEMPTM,CODFILIALTM,CODTIPOMOV,DOCCOMPRA,DTENTCOMPRA,DTEMITCOMPRA)
                 SELECT :CODEMP,:CODFILIAL,:CODCOMPRA,CODEMPPG,CODFILIALPG,CODPLANOPAG,
                        :CODEMP,:CODFILIALFR,:CODFOR,:CODEMP,:CODFILIALSE,:SERIE,
                        CODEMP,:CODFILIALTM,:CODTIPOMOV,:DOC,DTSAIDAVENDA,DTEMITVENDA FROM
                        VDVENDA WHERE CODEMP=:CODEMP AND CODFILIAL=:CODFILIALVD AND
                        CODVENDA=:CODVENDA AND TIPOVENDA=:TIPOVENDA;
  IF (CITEM = 'S') THEN
    EXECUTE PROCEDURE CPGERAITENTRADASP(:CODEMP,:CODFILIALCP,:CODCOMPRA,:CODFILIALVD,:TIPOVENDA,:CODVENDA,NULL,NULL);
    
  UPDATE VDVENDA SET STATUSVENDA='DV' WHERE TIPOVENDA=:TIPOVENDA AND CODVENDA=:CODVENDA
    AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIALVD;
  
  SUSPEND;
END
^

/* Restore procedure body: CPGERAITENTRADASP */
ALTER PROCEDURE CPGERAITENTRADASP(CODEMP INTEGER,
CODFILIAL INTEGER,
CODCOMPRA INTEGER,
CODFILIALVD INTEGER,
TIPOVENDA CHAR(1),
CODVENDA INTEGER,
CODITVENDA INTEGER,
QTDIT INTEGER)
 AS
declare variable coditcompra integer;
declare variable codfilialtm integer;
declare variable codtipomov integer;
declare variable codfilialfr integer;
declare variable codfor integer;
declare variable codnat char(4);
declare variable codfilialnt integer;
declare variable percicmsitcompra numeric(9,2);
declare variable codfilialpd integer;
declare variable codprod integer;
declare variable codfilialle integer;
declare variable codlote varchar(20);
declare variable qtditvenda numeric(18,3);
declare variable qtddevitvenda numeric(18,3);
declare variable precoitvenda numeric(18,3);
declare variable percdescitvenda numeric(15,5);
declare variable vlrdescitvenda numeric(18,3);
declare variable percicmsitvenda numeric(9,2);
declare variable vlrbaseicmsitvenda numeric(18,3);
declare variable vlricmsitvenda numeric(18,3);
declare variable percipiitvenda numeric(9,2);
declare variable vlrbaseipiitvenda numeric(18,3);
declare variable vlripiitvenda numeric(18,3);
declare variable vlrliqitvenda numeric(18,3);
declare variable vlradicitvenda numeric(18,3);
declare variable vlrfreteitvenda numeric(18,3);
declare variable vlrisentasitvenda numeric(18,3);
declare variable vlroutrasitvenda numeric(18,3);
declare variable vlrproditvenda numeric(18,3);
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'LFNATOPER') INTO CODFILIALNT;
  SELECT CODFOR,CODFILIALFR,CODTIPOMOV,CODFILIALTM FROM CPCOMPRA WHERE CODCOMPRA=:CODCOMPRA
    AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL INTO
    :CODFOR,:CODFILIALFR,:CODTIPOMOV,:CODFILIALTM;
  FOR SELECT CODITVENDA,CODFILIALPD,CODPROD,CODFILIALLE,CODLOTE,
             QTDITVENDA,PRECOITVENDA,PERCDESCITVENDA,VLRDESCITVENDA,PERCICMSITVENDA,
             VLRBASEICMSITVENDA,VLRICMSITVENDA,PERCIPIITVENDA,VLRBASEIPIITVENDA,
             VLRIPIITVENDA,VLRLIQITVENDA,VLRADICITVENDA,VLRFRETEITVENDA,VLRISENTASITVENDA,
             VLROUTRASITVENDA,VLRPRODITVENDA,VLRPRODITVENDA FROM VDITVENDA WHERE
             CODEMP=:CODEMP AND CODFILIAL=:CODFILIALVD AND CODVENDA=:CODVENDA AND TIPOVENDA=:TIPOVENDA AND
             (:CODITVENDA IS NULL OR CODITVENDA=:CODITVENDA)
             ORDER BY CODITVENDA INTO CODITCOMPRA,CODFILIALPD,CODPROD,CODFILIALLE,CODLOTE,
             QTDITVENDA,PRECOITVENDA,PERCDESCITVENDA,VLRDESCITVENDA,PERCICMSITVENDA,
             VLRBASEICMSITVENDA,VLRICMSITVENDA,PERCIPIITVENDA,VLRBASEIPIITVENDA,
             VLRIPIITVENDA,VLRLIQITVENDA,VLRADICITVENDA,VLRFRETEITVENDA,VLRISENTASITVENDA,
             VLROUTRASITVENDA,VLRPRODITVENDA,VLRPRODITVENDA DO
  BEGIN
      IF (QTDIT IS NULL) THEN
        QTDIT = QTDITVENDA;
      SELECT SUM(QTDDEV) FROM CPCOMPRAVENDA WHERE TIPOVENDA=:TIPOVENDA
        AND CODVENDA=:CODVENDA AND CODITVENDA=:CODITVENDA
        AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL INTO QTDDEVITVENDA;
      IF (QTDIT > QTDITVENDA OR QTDIT+QTDDEVITVENDA > QTDITVENDA) THEN
        EXCEPTION VDVENDAEX01 'O ITEM: '||CAST(CODITVENDA AS CHAR(3))||' DO PEDIDO: '||
          CAST(CODVENDA AS CHAR(6))||' JA FOI DEVOLVIDO!';
        
      SELECT CODNAT FROM LFBUSCANATSP (:CODFILIAL,:CODEMP,:CODFILIALPD,:CODPROD,NULL,NULL,NULL,
                                   :CODEMP,:CODFILIALFR,:CODFOR,:CODFILIALTM,:CODTIPOMOV,null) INTO CODNAT;

      INSERT INTO CPITCOMPRA (CODEMP,CODFILIAL,CODCOMPRA,CODITCOMPRA,CODEMPPD,CODFILIALPD,CODPROD,
                              CODEMPLE,CODFILIALLE,CODLOTE,CODEMPNT,CODFILIALNT,CODNAT,QTDITCOMPRA,
                              PRECOITCOMPRA,PERCDESCITCOMPRA,VLRDESCITCOMPRA,PERCICMSITCOMPRA,
                              VLRBASEICMSITCOMPRA,VLRICMSITCOMPRA,PERCIPIITCOMPRA,VLRBASEIPIITCOMPRA,
                              VLRIPIITCOMPRA,VLRLIQITCOMPRA,VLRADICITCOMPRA,VLRFRETEITCOMPRA,
                              VLRISENTASITCOMPRA,VLROUTRASITCOMPRA,VLRPRODITCOMPRA,CUSTOITCOMPRA)
                       VALUES (:CODEMP,:CODFILIAL,:CODCOMPRA,:CODITCOMPRA,:CODEMP,:CODFILIALPD,:CODPROD,
                              :CODEMP,:CODFILIALLE,:CODLOTE,:CODEMP,:CODFILIALNT,:CODNAT,:QTDIT,
                              :PRECOITVENDA,:PERCDESCITVENDA,:VLRDESCITVENDA,:PERCICMSITVENDA,
                              :VLRBASEICMSITVENDA,:VLRICMSITVENDA,:PERCIPIITVENDA,:VLRBASEIPIITVENDA,
                              :VLRIPIITVENDA,:VLRLIQITVENDA,:VLRADICITVENDA,:VLRFRETEITVENDA,
                              :VLRISENTASITVENDA,:VLROUTRASITVENDA,:VLRPRODITVENDA,:VLRPRODITVENDA);

      INSERT INTO CPCOMPRAVENDA(CODEMP,CODFILIAL,CODCOMPRA,CODITCOMPRA,CODEMPVD,
                                CODFILIALVD,TIPOVENDA,CODVENDA,CODITVENDA,QTDDEV)
                       VALUES (:CODEMP,:CODFILIAL,:CODCOMPRA,:CODITCOMPRA,:CODEMP,
                               :CODFILIALVD,:TIPOVENDA,:CODVENDA,:CODITCOMPRA,:QTDIT);
  END
  SUSPEND;
END
^

/* Restore procedure body: CRTOTAL01ISP */
ALTER PROCEDURE CRTOTAL01ISP(CODEMP INTEGER,
CODFILIAL INTEGER)
 RETURNS(SEQTOT INTEGER)
 AS
declare variable codfilialtt smallint;
begin
  select icodfilial from sgretfilial(:codemp, 'CRTOTAL')
    into :codfilialtt;
  select iseq from spgeranum(:codemp, :codfilialtt, 'TT')
    into :seqtot;
  insert into crtotal (codemp, codfilial, seqtot)
    values(:codemp, :codfilialtt, :seqtot);
  suspend;
end
^

/* Restore procedure body: EQGERARMAOSSP */
ALTER PROCEDURE EQGERARMAOSSP(CODEMPRM INTEGER,
CODFILIALRM INTEGER,
TICKET INTEGER,
CODITRECMERC SMALLINT)
 RETURNS(CODRMA INTEGER)
 AS
declare variable coditos smallint;
declare variable idusu1 char(8);
declare variable codfilialrma smallint;
declare variable codfilialpd smallint;
declare variable coditrma integer;
declare variable refprod varchar(20);
declare variable codtipomov1 integer;
declare variable codccusu1 char(19);
declare variable codfilialccusu1 smallint;
declare variable codfilialtm1 smallint;
declare variable codfilialtm smallint;
declare variable codemppd integer;
declare variable codprod integer;
declare variable codfilialle smallint;
declare variable custompmit numeric(15,5);
declare variable codlote varchar(20);
declare variable codalmox integer;
declare variable qtd numeric(15,2);
declare variable codfilialax smallint;
declare variable codfilialusu1 smallint;
declare variable anoccusu1 smallint;
declare variable statusaprovrmager char(2) = 'PE';
declare variable statusrmager char(2);
declare variable qtdaprov numeric(15,5) = 0;
begin


    -- buscando centro de custo do usuário atual
    select codfilialusu,codfilialccusu,codccusu,anoccusu,idusus
    from sgretinfousu(:codemprm, user)
    into :CODFILIALUSU1,:CODFILIALCCUSU1,:CODCCUSU1,:ANOCCUSU1,:IDUSU1;

    -- Buscando filial da rma
    SELECT ICODFILIAL FROM sgretfilial(:CODEMPRM,'EQRMA')
    into :codfilialrma;

    -- Buscando filial do lote
    SELECT ICODFILIAL FROM sgretfilial(:CODEMPRM,'EQLOTE')
    into :codfilialle;

    -- Buscando filial do tipo de movimento
    SELECT ICODFILIAL FROM sgretfilial(:CODEMPRM,'EQTIPOMOV')
    into :codfilialtm;

    -- buscando tipo de movimento para RMA
    select codfilialt8,codtipomov8 from sgprefere1
    where codemp=:codemprm and codfilial=:codfilialrm
    into :codfilialtm1,:codtipomov1;

    -- Buscado a situação pardrão para RMA
    select coalesce(SITRMAOP,'PE') from sgprefere5 where codemp=:codemprm and
    codfilial=(select icodfilial from sgretfilial(:codemprm,'SGPREFERE5'))
    into :statusrmager;

    if(:statusrmager is null) then
    begin
       statusrmager = 'PE';
    end

    -- Carregando quantidade aprovada...
    QTDAPROV = 0;
    STATUSAPROVRMAGER = 'PE';

    -- Buscando código novo código de RMA.
    select coalesce((max(codrma)+1),1) from
    eqrma where codemp=:codemprm and codfilial=:codfilialrma
    into :codrma;

    -- Inserindo nova RMA
    insert into eqrma (codemp,codfilial,codrma,
                     codempuu,codfilialuu,idusu,
                     codempua,codfilialua,idusuaprov,
                     codempue,codfilialue,idusuexp,
                     codemptm,codfilialtm,codtipomov,
                     codempcc,codfilialcc,anocc,codcc,
                     dtareqrma,dtaaprovrma,dtaexprma,
                     sitrma,sitaprovrma,sitexprma,
                     codempos,codfilialos,ticket,coditrecmerc,motivorma)
                     values
                     (:codemprm,:codfilialrma,:codrma,
                      :codemprm, :codfilialusu1,:idusu1,
                      null,null,null,
                      null,null,null,
                      :codemprm, :codfilialtm1, :codtipomov1,
                      :codemprm,:codfilialccusu1,:anoccusu1,:codccusu1,
                      cast('now' AS DATE),null,null,
                      :STATUSRMAGER,:STATUSAPROVRMAGER,'PE',
                      :codemprm,:codfilialrm,:ticket,:coditrecmerc,
                      'REQUISIÇÃO GERADA PARA ATENDIMENTO À OS:'|| :ticket
    );

    -- Loop nos itens de Ordem de Serviço.

    for select os.coditrecmerc, os.coditos, os.codemppd, os.codfilialpd, os.refprodpd, os.codprodpd, os.qtditos,
    (select ncustompm from eqprodutosp01(os.codemppd, os.codfilialpd, os.codprodpd,null,null,null)) custompmit
    from eqitrecmercitos os
    where os.codemp=:codemprm and os.codfilial=:codfilialrm and os.ticket=:ticket
--    and ( (os.coditrecmerc=:coditrecmerc) or (:coditrecmerc is null) )
    and os.gerarma='S'
    into :coditrecmerc, :coditos, :codemppd, :codfilialpd, :refprod, :codprod, :qtd, :custompmit
    do

    begin

       select coalesce((max(coditrma)+1),1) from eqitrma
       where codemp=:codemprm and codfilial=:codfilialrma and codrma=:codrma
       into :coditrma;

       if(:statusrmager='AF') then
       begin
         STATUSAPROVRMAGER = 'AT';
         QTDAPROV = :qtd;
       end

       insert into eqitrma (CODEMP,CODFILIAL,CODRMA,CODITRMA,
                            CODEMPPD,CODFILIALPD,CODPROD,REFPROD,
                            QTDITRMA,QTDAPROVITRMA,QTDEXPITRMA,PRECOITRMA,
                            CODEMPLE,CODFILIALLE,CODLOTE,
                            CODEMPAX,CODFILIALAX,CODALMOX,
                            SITITRMA,SITAPROVITRMA,SITEXPITRMA,
                            CODEMPOS,CODFILIALOS,TICKET,CODITRECMERC,CODITOS
                            )
                            values
                            (:codemprm,:codfilialrma,:codrma, :coditrma,
                            :codemprm,:codfilialpd,
                            :codprod, :refprod, :qtd, :qtdaprov, 0, :custompmit, :codemprm,
                            :codfilialle,:codlote,
                            :codemprm,:codfilialax,:codalmox,
                            :statusrmager,:statusaprovrmager,'PE',
                            :codemprm, :codfilialrm, :ticket, :coditrecmerc,:coditos
                            );

        update eqitrecmercitos os set os.gerarma='N', os.statusitos='EC'
        where os.codemp=:codemprm and os.codfilial=:codfilialrm and os.ticket=:ticket
        and os.coditrecmerc=:coditrecmerc and os.coditos=:coditos;

        suspend;

   end
end
^

/* Restore procedure body: EQGERARMASP */
ALTER PROCEDURE EQGERARMASP(CODEMPOP INTEGER,
CODFILIALOP INTEGER,
CODOP INTEGER,
SEQOP SMALLINT)
 AS
declare variable seqof smallint;
declare variable idusu1 char(8);
declare variable seqitop integer;
declare variable coditrma integer;
declare variable refprod varchar(20);
declare variable codrma integer;
declare variable codtipomov1 integer;
declare variable codccusu1 char(19);
declare variable codfilialccusu1 smallint;
declare variable codfilialpd smallint;
declare variable codfilialtm1 smallint;
declare variable codprod integer;
declare variable codfilialle smallint;
declare variable custompmit numeric(15,5);
declare variable codlote varchar(20);
declare variable codalmox integer;
declare variable qtd numeric(15,2);
declare variable codfilialax smallint;
declare variable codfilialusu1 smallint;
declare variable anoccusu1 smallint;
declare variable statusaprovrmager char(2) = 'PE';
declare variable statusrmager char(2);
declare variable codfilialfase smallint;
declare variable qtdaprov numeric(15,5) = 0;
declare variable codfase integer;
declare variable codempos integer;
declare variable codfilialos smallint;
declare variable ticket integer;
declare variable coditrecmerc integer;
declare variable coditos integer;
begin

    -- Buscando informações do usuário
    select codfilialusu,codfilialccusu,codccusu,anoccusu,idusus
    from sgretinfousu(:codempop, user)
    into :CODFILIALUSU1,:CODFILIALCCUSU1,:CODCCUSU1,:ANOCCUSU1,:IDUSU1;

    -- Buscando preferencias de tipo de movimento para OP
    select codfilialt8,codtipomov8
    from sgprefere1 where codemp=:CODEMPOP and codfilial=(select icodfilial from sgretfilial(:CODEMPOP, 'SGPREFERE1'))
    into :CODFILIALTM1,:CODTIPOMOV1;

    --Buscando informações da OP.
    select op.codempos, op.codfilialos, op.ticket, op.coditrecmerc, op.coditos
    from  ppop op
    where op.codemp=:codempop and op.codfilial=:codfilialop and op.codop=:codop and op.seqop=:seqop
    into :codempos, :codfilialos, :ticket, :coditrecmerc, :coditos;

    -- Buscando preferencias para geração de RMA
    select coalesce(SITRMAOP,'PE') from sgprefere5 where codemp=:CODEMPOP and
    codfilial=(select icodfilial from sgretfilial(:CODEMPOP,'SGPREFERE5'))
    into :STATUSRMAGER;

    QTDAPROV = 0;
    STATUSAPROVRMAGER = 'PE';

    for select codfilialfs,codfase,seqof from ppopfase opf
        where opf.codemp=:CODEMPOP and opf.codfilial=:CODFILIALOP and
        opf.codop=:CODOP and  opf.seqop=:SEQOP and
        (select count(1) from ppitop it
        where it.codemp=:CODEMPOP and it.codfilial=:CODFILIALOP and
        it.codempfs=opf.codempfs and it.codfilialfs=opf.codfilialfs and
        it.codfase=opf.codfase and it.gerarma='S' and
        it.codop=:CODOP and it.seqop=:SEQOP) > 0
        into :codfilialfase,:codfase,:SEQOF do
    begin
        select coalesce((max(codrma)+1),1)
        from eqrma
        where codemp=:CODEMPOP and codfilial=:CODFILIALOP into :CODRMA;

        insert into eqrma (codemp,codfilial,codrma,
                     codempuu,codfilialuu,idusu,
                     codempua,codfilialua,idusuaprov,
                     codempue,codfilialue,idusuexp,
                     codemptm,codfilialtm,codtipomov,
                     codempcc,codfilialcc,anocc,codcc,
                     dtareqrma,dtaaprovrma,dtaexprma,
                     sitrma,sitaprovrma,sitexprma,
                     codempof,codfilialof,codop,seqop,seqof,
                     motivorma, codempos, codfilialos, ticket, coditrecmerc)
                     values
                     (:CODEMPOP,(SELECT ICODFILIAL FROM sgretfilial(:CODEMPOP,'EQRMA')),:CODRMA,
                      :CODEMPOP, :CODFILIALUSU1,:IDUSU1,
                      null,null,null,
                      null,null,null,
                      :CODEMPOP,(SELECT ICODFILIAL FROM sgretfilial(:CODEMPOP,'EQTIPOMOV')),
                      :CODTIPOMOV1,
                      :CODEMPOP,:CODFILIALCCUSU1,:ANOCCUSU1,:CODCCUSU1,
                      cast('now' AS DATE),null,null,
                      :STATUSRMAGER,:STATUSAPROVRMAGER,'PE',
                      :CODEMPOP,:CODFILIALOP,:CODOP,:SEQOP,:SEQOF,
                      'REQUISIÇÃO GERADA PARA ATENDIMENTO À OP:'||:CODOP||' SEQ:'||:SEQOP||' - FASE:'||:CODFASE,
                      :codempos, :codfilialos, :ticket, :coditrecmerc
        );

        for select it.seqitop,it.codfilialpd,it.codprod,it.refprod,it.qtditop-coalesce(it.qtdcopiaitop,0),it.codfilialle,it.codlote,
            (select ncustompm from eqprodutosp01(it.codemppd,it.codfilialpd,it.codprod,null,null,null)),
            (SELECT CODFILIALAX FROM EQPRODUTO WHERE CODEMP=it.codemppd and codfilial=it.codfilialpd and codprod=it.codprod),
            (SELECT CODALMOX FROM EQPRODUTO WHERE CODEMP=it.codemppd and codfilial=it.codfilialpd and codprod=it.codprod)
            from ppitop it, eqproduto pd
            where
            pd.codemp=it.codemppd and pd.codfilial=it.codfilialpd and pd.codprod=it.codprod
            and it.codemp=:CODEMPOP and it.codfilial=:CODFILIALOP
            and it.codop=:CODOP and it.seqop=:SEQOP and it.codempfs=:CODEMPOP
            and it.codfilialfs=:CODFILIALFASE
            and it.codfase = :CODFASE and it.gerarma='S'
            and (('S'=(select ratauto from sgprefere5 where codemp=it.codemp and codfilial=it.codfilial))
            and (it.qtditop-coalesce(it.qtdcopiaitop, 0))<=(SELECT L.SLDLOTE FROM EQLOTE L
                                                            WHERE L.CODEMP=it.codemple AND L.CODFILIAL=it.codfilialle AND
                                                            L.CODPROD=it.codprod AND L.CODLOTE=it.codlote)
            or pd.cloteprod = 'N'
                                                            )
            into :SEQITOP, :CODFILIALPD,:CODPROD,:REFPROD,:QTD,
            :CODFILIALLE,:CODLOTE,:CUSTOMPMIT,:CODFILIALAX,:CODALMOX  DO
        begin
            select coalesce((max(coditrma)+1),1) from eqitrma
            where codemp=:CODEMPOP and codfilial=:CODFILIALOP and
            codrma=:CODRMA into :coditrma;

            if(:STATUSRMAGER='AF')then
            begin
                STATUSAPROVRMAGER = 'AT';
                QTDAPROV = :QTD;
            end

            insert into eqitrma (CODEMP,CODFILIAL,CODRMA,CODITRMA,
                            CODEMPPD,CODFILIALPD,CODPROD,REFPROD,
                            QTDITRMA,QTDAPROVITRMA,QTDEXPITRMA,PRECOITRMA,
                            CODEMPLE,CODFILIALLE,CODLOTE,
                            CODEMPAX,CODFILIALAX,CODALMOX,
                            SITITRMA,SITAPROVITRMA,SITEXPITRMA,
                            codempos, codfilialos, ticket, coditrecmerc, coditos
                            )
                            values
                            (:CODEMPOP,(SELECT ICODFILIAL FROM sgretfilial(:CODEMPOP,'EQITRMA')),:CODRMA,
                            :coditrma,
                            :CODEMPOP,(SELECT ICODFILIAL FROM sgretfilial(:CODEMPOP,'EQPRODUTO')),
                            :CODPROD,:REFPROD,:QTD,:QTDAPROV,0,:CUSTOMPMIT,:CODEMPOP,(SELECT ICODFILIAL FROM sgretfilial(:CODEMPOP,'EQLOTE')),:CODLOTE,
                            :CODEMPOP,:CODFILIALAX,:CODALMOX,
                            :STATUSRMAGER,:STATUSAPROVRMAGER,'PE',
                            :codempop, :codfilialos, :ticket, :coditrecmerc, :coditos
                            );

            update ppitop it set it.gerarma='N' where it.CODEMP=:CODEMPOP AND
                it.CODFILIAL=:CODFILIALOP AND
                it.codop=:CODOP and it.seqop=:SEQOP and it.seqitop=:seqitop;

        end

    end

    suspend;

end
^

/* Restore procedure body: EQMOVPRODIUDSP */
ALTER PROCEDURE EQMOVPRODIUDSP(CIUD CHAR(1),
ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
SEQSUBPROD SMALLINT)
 AS
declare variable cmultialmox char(1);
begin
  /* Procedure que controle INSERT, UPDATE E DELETE da tabela eqmovprod */

  /* Linha incluida para passar como parâmetro se é multi almoxarifado
      Como o objetivo de evitar I/O
  */
  SELECT CMULTIALMOX FROM SGRETMULTIALMOXSP(:ICODEMPPD) INTO :CMULTIALMOX;
  
  if (CIUD='I') then /* SE FOR INSERT */
     execute procedure EQMOVPRODISP( ICODEMPPD, SCODFILIALPD, ICODPROD,
         ICODEMPLE, SCODFILIALLE, CCODLOTE, ICODEMPTM, SCODFILIALTM, ICODTIPOMOV,
         ICODEMPIV, SCODFILIALIV, ICODINVPROD, ICODEMPCP, SCODFILIALCP, ICODCOMPRA,
         SCODITCOMPRA, ICODEMPVD, SCODFILIALVD, CTIPOVENDA, ICODVENDA, SCODITVENDA,
         ICODEMPRM, SCODFILIALRM, ICODRMA, SCODITRMA,
         ICODEMPOP, SCODFILIALOP, ICODOP, SSEQOP, sseqentop,
         ICODEMPNT, SCODFILIALNT,
         CCODNAT, DDTMOVPROD, IDOCMOVPROD, CFLAG, NQTDMOVPROD, NPRECOMOVPROD,
         ICODEMPAX, SCODFILIALAX, ICODALMOX, CMULTIALMOX, :seqsubprod);
  else if (CIUD='U') then
     execute procedure EQMOVPRODUSP( ICODEMPPD, SCODFILIALPD, ICODPROD,
         ICODEMPLE, SCODFILIALLE, CCODLOTE, ICODEMPTM, SCODFILIALTM, ICODTIPOMOV,
         ICODEMPIV, SCODFILIALIV, ICODINVPROD, ICODEMPCP, SCODFILIALCP, ICODCOMPRA,
         SCODITCOMPRA, ICODEMPVD, SCODFILIALVD, CTIPOVENDA, ICODVENDA, SCODITVENDA,
         ICODEMPRM, SCODFILIALRM, ICODRMA, SCODITRMA,
         ICODEMPOP, SCODFILIALOP, ICODOP, SSEQOP, sseqentop,
         ICODEMPNT, SCODFILIALNT,
         CCODNAT, DDTMOVPROD, IDOCMOVPROD, CFLAG, NQTDMOVPROD, NPRECOMOVPROD,
         ICODEMPAX, SCODFILIALAX, ICODALMOX, CMULTIALMOX,:seqsubprod);
  else if (CIUD='D') then
     execute procedure EQMOVPRODDSP( ICODEMPPD, SCODFILIALPD, ICODPROD, ICODEMPIV,
         SCODFILIALIV, ICODINVPROD, ICODEMPCP, SCODFILIALCP, ICODCOMPRA, SCODITCOMPRA,
         ICODEMPVD, SCODFILIALVD, CTIPOVENDA, ICODVENDA, SCODITVENDA,
         ICODEMPRM, SCODFILIALRM, ICODRMA, SCODITRMA,
         ICODEMPOP, SCODFILIALOP, ICODOP, SSEQOP, sseqentop,
         DDTMOVPROD, ICODEMPAX, SCODFILIALAX, ICODALMOX, CMULTIALMOX, :seqsubprod );
--  suspend;
end
^

/* Restore procedure body: EQMOVPRODSEQSP */
ALTER PROCEDURE EQMOVPRODSEQSP(ICODEMP INTEGER)
 RETURNS(SCODFILIAL SMALLINT,
ICODMOVPROD INTEGER)
 AS
begin
  /* Busca o código sequencial da tabela eqmovprod */
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP, 'EQMOVPROD') INTO :SCODFILIAL ;
  SELECT ISEQ FROM SPGERANUM(:ICODEMP, :SCODFILIAL, 'MP' ) INTO :ICODMOVPROD ;
  suspend;
end
^

/* Restore procedure body: FNADICLANCASP01 */
ALTER PROCEDURE FNADICLANCASP01(ICODREC INTEGER,
INPARCITREC INTEGER,
PDVITREC CHAR(1),
SNUMCONTA CHAR(10),
ICODEMPCA INTEGER,
ICODFILIALCA INTEGER,
ICODCLI INTEGER,
ICODEMPCL INTEGER,
ICODFILIALCL INTEGER,
SCODPLAN CHAR(13),
ICODEMPPN INTEGER,
ICODFILIALPN INTEGER,
IANOCC INTEGER,
SCODCC CHAR(19),
ICODEMPCC INTEGER,
ICODFILIALCC INTEGER,
DDTCOMPITREC DATE,
DDTPAGOITREC DATE,
SDOCLANCAITREC VARCHAR(15),
SOBSITREC CHAR(250),
DVLRPAGOITREC NUMERIC(15,5),
ICODEMP INTEGER,
ICODFILIAL SMALLINT,
DVLRPAGOJUROS NUMERIC(15,5),
DVLRDESC NUMERIC(15,5))
 AS
declare variable icodlanca integer;
declare variable scodplanconta char(13);
declare variable icodemppconta integer;
declare variable icodfilialpconta integer;
declare variable cflag char(1);
declare variable ifiliallanca integer;
declare variable tipolanca char(1);
declare variable codempjr integer;
declare variable codfilialjr smallint;
declare variable codplanjr char(13);
declare variable codempdc integer;
declare variable codfilialdc smallint;
declare variable codplandc char(13);
declare variable codsublanca smallint = 1;
BEGIN
    SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNLANCA') INTO IFILIALLANCA;

    SELECT CODPLAN,CODEMPPN,CODFILIALPN FROM FNCONTA WHERE NUMCONTA = :SNUMCONTA
        AND CODEMP=:ICODEMPCA AND CODFILIAL=:ICODFILIALCA INTO :sCodPlanConta,:iCodEmpPConta,:iCodFilialPConta;

    SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALLANCA,'LA') INTO ICODLANCA;

    SELECT FLAG FROM FNRECEBER WHERE CODREC=:ICODREC
        AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO :cFlag;

    SELECT CODEMPJR,CODFILIALJR,CODPLANJR,CODEMPDC,CODFILIALDC,CODPLANDC FROM SGPREFERE1
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
        INTO :CODEMPJR,:CODFILIALJR,:CODPLANJR,:CODEMPDC,:CODFILIALDC,:CODPLANDC;


    IF (ICODCLI IS NULL) THEN
        TIPOLANCA = 'A';
    ELSE
        TIPOLANCA = 'C';

    if ( (DVLRPAGOJUROS IS NULL) OR (:CODPLANJR IS NULL)  ) then
        DVLRPAGOJUROS = 0;
    else
        DVLRPAGOITREC = DVLRPAGOITREC - DVLRPAGOJUROS;

    if (DVLRDESC IS NULL  OR (:CODPLANDC IS NULL) ) then
        DVLRDESC = 0;
    else
        DVLRPAGOITREC = DVLRPAGOITREC + DVLRDESC;


    INSERT INTO FNLANCA (TIPOLANCA,CODEMP,CODFILIAL,CODLANCA,CODEMPRC,CODFILIALRC,CODREC,NPARCITREC,CODEMPPN,CODFILIALPN,CODPLAN, 
        DTCOMPLANCA, DATALANCA, DOCLANCA,HISTBLANCA,DTPREVLANCA,VLRLANCA,FLAG,CODEMPCL,CODFILIALCL,CODCLI,PDVITREC)
        VALUES (:TIPOLANCA,:ICODEMP,:IFILIALLANCA,:iCodLanca,:ICODEMP,:ICODFILIAL,:ICODREC,:iNParcItRec,:iCodEmpPConta,:iCodFilialPConta,
                :sCodPlanConta,:dDtCompItRec, :dDtPagoItRec,:sDocLancaItRec,:sObsItRec,:dDtPagoItRec,0,:cFlag,:ICODEMPCL,:ICODFILIALCL,:ICODCLI,:PDVITREC
        );

    INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPCL,CODFILIALCL,CODCLI,CODEMPPN,CODFILIALPN,CODPLAN,
                CODEMPRC, CODFILIALRC, CODREC, NPARCITREC,
    			CODEMPCC, CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA, DTCOMPSUBLANCA, DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,FLAG)
        VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPCL,:ICODFILIALCL,:ICODCLI,:ICODEMPPN,:ICODFILIALPN,:SCODPLAN,
        		:ICODEMP, :ICODFILIAL, :ICODREC, :INPARCITREC,
                :ICODEMPCC,:ICODFILIALCC,:IANOCC,:SCODCC,'S',:dDtCompItRec,:dDtPagoItRec,:dDtPagoItRec,:dVlrPagoItRec*-1,:cFlag
        );

    -- Lançamento dos juros em conta distinta.

    IF(DVLRPAGOJUROS > 0) THEN
    BEGIN

        CODSUBLANCA = CODSUBLANCA + 1;

        INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPCL,CODFILIALCL,CODCLI,CODEMPPN,CODFILIALPN,CODPLAN,
                 CODEMPRC, CODFILIALRC, CODREC, NPARCITREC,
                  CODEMPCC, CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DTCOMPSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,FLAG, TIPOSUBLANCA)
        VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPCL,:ICODFILIALCL,:ICODCLI,:CODEMPJR,:CODFILIALJR,:CODPLANJR,
        		:ICODEMP, :ICODFILIAL, :ICODREC, :INPARCITREC,
                :ICODEMPCC, :ICODFILIALCC,:IANOCC,:SCODCC,'S',:dDtCompItRec,:dDtPagoItRec,:dDtPagoItRec,:DVLRPAGOJUROS*-1,:cFlag, 'J'
        );

    END

    -- Lançamento do desconto em conta distinta.

    IF(DVLRDESC > 0) THEN
    BEGIN

        CODSUBLANCA = CODSUBLANCA + 1;

        INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPCL,CODFILIALCL,CODCLI,CODEMPPN,CODFILIALPN,CODPLAN,
             CODEMPRC, CODFILIALRC, CODREC, NPARCITREC,
             CODEMPCC, CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DTCOMPSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,FLAG, TIPOSUBLANCA)
        VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPCL,:ICODFILIALCL,:ICODCLI,:CODEMPDC,:CODFILIALDC,:CODPLANDC,
       		:ICODEMP, :ICODFILIAL, :ICODREC, :INPARCITREC,
             :ICODEMPCC, :ICODFILIALCC,:IANOCC,:SCODCC,'S',:dDtCompItRec,:dDtPagoItRec,:dDtPagoItRec,:DVLRDESC,:cFlag, 'D'
        );

    END


END
^

/* Restore procedure body: FNADICLANCASP02 */
ALTER PROCEDURE FNADICLANCASP02(ICODPAG INTEGER,
INPARCPAG INTEGER,
SNUMCONTA CHAR(10),
ICODEMPCA INTEGER,
ICODFILIALCA INTEGER,
ICODFOR INTEGER,
ICODEMPFR INTEGER,
ICODFILIALFR INTEGER,
SCODPLAN CHAR(13),
ICODEMPPN INTEGER,
ICODFILIALPN INTEGER,
IANOCC INTEGER,
SCODCC CHAR(19),
ICODEMPCC INTEGER,
ICODFILIALCC INTEGER,
DDTCOMPITPAG DATE,
DDTPAGOITPAG DATE,
SDOCLANCAITPAG VARCHAR(15),
SOBSITPAG CHAR(250),
DVLRPAGOITPAG NUMERIC(15,5),
ICODEMP INTEGER,
ICODFILIAL SMALLINT,
DVLRJUROSPAG NUMERIC(15,5),
DVLRDESC NUMERIC(15,5))
 AS
declare variable icodlanca integer;
declare variable scodplanconta char(13);
declare variable icodemppconta integer;
declare variable icodfilialpconta integer;
declare variable cflag char(1);
declare variable ifiliallanca integer;
declare variable tipolanca char(1);
declare variable codempjp integer;
declare variable codfilialjp smallint;
declare variable codplanjp char(13);
declare variable codempdr integer;
declare variable codfilialdr smallint;
declare variable codplandr char(13);
declare variable codsublanca smallint = 1;
BEGIN

    SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNLANCA')
    INTO IFILIALLANCA;

    SELECT CODPLAN,CODEMP,CODFILIAL FROM FNCONTA
    WHERE NUMCONTA=:sNumConta AND CODEMP=:ICODEMPCA AND CODFILIAL=:ICODFILIALCA
    INTO :sCodPlanConta,:iCodEmpPConta,:iCodFilialPConta;

    SELECT ISEQ FROM SPGERANUM(:iCODEMP,:IFILIALLANCA,'LA')
    INTO :iCodLanca;

    SELECT FLAG FROM FNPAGAR
    WHERE CODPAG=:iCodPag AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
    INTO :cFlag;

    SELECT CODEMPJP,CODFILIALJP,CODPLANJP,CODEMPDR,CODFILIALDR,CODPLANDR
    FROM SGPREFERE1
    WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
    INTO :CODEMPJP,:CODFILIALJP,:CODPLANJP,:CODEMPDR,:CODFILIALDR,:CODPLANDR;

    IF (ICODFOR IS NULL) THEN
        TIPOLANCA = 'A';
      ELSE
        TIPOLANCA = 'F';

    if ( (DVLRJUROSPAG IS NULL) OR (:CODPLANJP IS NULL)  ) then
        DVLRJUROSPAG = 0;
    else
        DVLRPAGOITPAG = DVLRPAGOITPAG - DVLRJUROSPAG;

    if (DVLRDESC IS NULL  OR (:CODPLANDR IS NULL) ) then
        DVLRDESC = 0;
    else
        DVLRPAGOITPAG = DVLRPAGOITPAG + DVLRDESC;

    INSERT INTO FNLANCA (TIPOLANCA,CODEMP,CODFILIAL,CODLANCA,CODEMPPG,CODFILIALPG,CODPAG,
                         NPARCPAG,CODEMPPN,CODFILIALPN,CODPLAN,DTCOMPLANCA,DATALANCA,DOCLANCA,
                         HISTBLANCA,DTPREVLANCA,VLRLANCA,FLAG, CODEMPFR, CODFILIALFR, CODFOR)
         VALUES (:TIPOLANCA,:ICODEMP,:IFILIALLANCA,:iCodLanca,:ICODEMP,:ICODFILIAL,:iCodPag,
                 :iNParcPag,:iCodEmpPConta,:iCodFilialPConta,:sCodPlanConta, :dDtCompItPag, :dDtPagoItPag,:sDocLancaItPag,
                 :sObsItPag,:dDtPagoItPag,0,:cFlag, :ICODEMPFR, :ICODFILIALFR, :ICODFOR
         );

    INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPFR,CODFILIALFR,CODFOR,CODEMPPN,CODFILIALPN, CODPLAN,
    	CODEMPPG, CODFILIALPG, CODPAG, NPARCPAG,
    	CODEMPCC,CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DTCOMPSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,FLAG)
        VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPFR,:ICODFILIALFR,:ICODFOR,:ICODEMPPN,:ICODFILIALPN, :sCodplan,
        :ICODEMP,:ICODFILIAL,:iCodPag, :iNParcPag,
        :ICODEMPCC,:ICODFILIALCC,:IANOCC,:SCODCC,'E',:dDtCompItPag,:dDtPagoItPag,:dDtPagoItPag,:dVlrPagoItPag,:cFlag);

    -- Lançamento dos juros em conta distinta.

    IF(DVLRJUROSPAG >0) THEN
    BEGIN

        CODSUBLANCA = CODSUBLANCA + 1;

        INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPFR,CODFILIALFR,CODFOR,
             CODEMPPN,CODFILIALPN,CODPLAN,CODEMPCC,CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DTCOMPSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,
             CODEMPPG, CODFILIALPG, CODPAG, NPARCPAG, FLAG, TIPOSUBLANCA)
            VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPFR,:ICODFILIALFR,:ICODFOR,
            :CODEMPJP,:CODFILIALJP,:CODPLANJP,:ICODEMPCC,:ICODFILIALCC,:IANOCC,:SCODCC,'E',:dDtCompItPag,:dDtPagoItPag,:dDtPagoItPag,:DVLRJUROSPAG,
            :ICODEMP, :ICODFILIAL, :iCodPag, :iNParcPag,:cFlag, 'J');

    END

    -- Lançamento de desconto em conta distinta.

    IF(DVLRDESC >0) THEN
    BEGIN

        CODSUBLANCA = CODSUBLANCA + 1;

        INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPFR,CODFILIALFR,CODFOR,
        CODEMPPN,CODFILIALPN,CODPLAN,CODEMPCC,CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DTCOMPSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,
        	  CODEMPPG, CODFILIALPG, CODPAG, NPARCPAG, FLAG, TIPOSUBLANCA)
            VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPFR,:ICODFILIALFR,:ICODFOR,
             :CODEMPDR,:CODFILIALDR,:CODPLANDR,:ICODEMPCC,:ICODFILIALCC,:IANOCC,:SCODCC,'E',:dDtCompItPag,:dDtPagoItPag,:dDtPagoItPag,:DVLRDESC*-1,
             :ICODEMP, :ICODFILIAL, :iCodPag, :iNParcPag, :cFlag, 'D');

    END

END
^

/* Restore procedure body: FNADICPAGARSP01 */
ALTER PROCEDURE FNADICPAGARSP01(CODCOMPRA INTEGER,
ICODEMPPG INTEGER,
ICODFILIALPG SMALLINT,
CODPLANOPAG INTEGER,
ICODEMPFR INTEGER,
ICODFILIALFR SMALLINT,
CODFOR INTEGER,
VLRLIQCOMPRA NUMERIC(18,2),
DTSAIDACOMPRA DATE,
DTCOMPCOMPRA DATE,
DOCCOMPRA INTEGER,
ICODEMPBO INTEGER,
ICODFILIALBO SMALLINT,
CODBANCO CHAR(3),
FLAG CHAR(1),
ICODEMP INTEGER,
ICODFILIAL SMALLINT,
CODEMPTC INTEGER,
CODFILIALTC SMALLINT,
CODTIPOCOB INTEGER,
CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
NUMCONTA CHAR(10),
CODEMPCC INTEGER,
CODFILIALCC SMALLINT,
ANOCC SMALLINT,
CODCC CHAR(19),
CODEMPPN INTEGER,
CODFILIALPN SMALLINT,
CODPLAN CHAR(13),
OBSPAG VARCHAR(250))
 AS
declare variable icodpagar integer;
declare variable ifilialpagar integer;
declare variable numparcs integer;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNPAGAR') INTO IFILIALPAGAR;
  SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALPAGAR,'PA') INTO ICODPAGAR;
  SELECT COALESCE(PARCPLANOPAG,0) FROM FNPLANOPAG WHERE CODEMP=:icodemppg AND CODFILIAL=:icodfilialpg AND codplanopag=:codplanopag
  INTO NUMPARCS;

  IF(numparcs>0) THEN
  BEGIN
      INSERT INTO FNPAGAR (CODEMP,CODFILIAL,CODPAG,CODPLANOPAG,CODEMPPG,CODFILIALPG,CODFOR,CODEMPFR,
                          CODFILIALFR,CODCOMPRA,CODEMPCP,CODFILIALCP,VLRPAG,
                          VLRDESCPAG,VLRMULTAPAG,VLRJUROSPAG,VLRPARCPAG,VLRPAGOPAG,
                          VLRAPAGPAG,DATAPAG, DTCOMPPAG, STATUSPAG,DOCPAG,CODBANCO,CODEMPBO,CODFILIALBO,FLAG,
                          CODEMPTC, CODFILIALTC, CODTIPOCOB,
                          codempca, codfilialca,  numconta, codempcc, codfilialcc, anocc, codcc, codemppn, codfilialpn, codplan, obspag)
                          VALUES (
                                 :ICODEMP,:IFILIALPAGAR,:ICODPAGAR,:CodPlanoPag,:ICODEMPPG,:ICODFILIALPG,:CodFor,:ICODEMPFR,
                                 :ICODFILIALFR,:CodCompra,:ICODEMP,:ICODFILIAL,:VlrLiqCompra,
                                 0,0,0,:VlrLiqCompra,0,:VlrLiqCompra,:dtSaidaCompra, :DTCOMPCOMPRA, 'P1',:DocCompra,
                                 :CodBanco,:ICODEMPBO,:ICODFILIALBO,:FLAG,
                                 :CODEMPTC, :CODFILIALTC, :CODTIPOCOB,
                                 :codempct, :codfilialct, :numconta, :codempcc, :codfilialcc, :anocc, :codcc, :codemppn, :codfilialpn, :codplan, :obspag
                          );
   END
END
^

/* Restore procedure body: FNADICPAGARSP02 */
ALTER PROCEDURE FNADICPAGARSP02(CODEMPOC INTEGER,
CODFILIALOC SMALLINT,
CODORDCP INTEGER,
CODEMPPP INTEGER,
CODFILIALPP SMALLINT,
CODPLANOPAG INTEGER,
CODEMPFR INTEGER,
CODFILIALFR SMALLINT,
CODFOR INTEGER,
OBSPAG VARCHAR(2000))
 AS
declare variable codpag integer;
declare variable codfilialpag integer;
declare variable numparcs integer;
declare variable valor decimal(15,5);
declare variable data date;

BEGIN     
    
    -- Buscando filial para tabela FNPAGAR
    select icodfilial from sgretfilial( :codemppp, 'FNPAGAR' ) into :codfilialpag;

    -- Gerando código do pagamento
    select iseq from spgeranum( :codemppp, :codfilialpag, 'PA') into :codpag;

    -- Consultando número de parcelas do plano de pagamento
    select coalesce( parcplanopag, 0 ) from fnplanopag
        where codemp=:codemppp and codfilial=:codfilialpp and codplanopag=:codplanopag
        into :numparcs;

    -- Limpando empenhos anteriores
    delete from fnpagar pg where pg.codempoc=:codempoc and pg.codfilialoc=:codfilialoc and pg.codordcp=:codordcp;

    -- Precorre tabela de previsões de entrega para gerar os empenhos no contas a pagar.
    for select pe.dtitpe data, sum(( io.vlrliqapitordcp/io.qtdapitordcp ) * cast(pe.qtditpe-pe.qtditentpe as decimal(8,2))) valor
        from cpitordcompra io, cpitordcomprape pe
        where
            io.codemp=:codempoc and io.codfilial=:codfilialoc and io.codordcp=:codordcp and
            pe.codemp=io.codemp and pe.codfilial=io.codfilial and pe.codordcp=io.codordcp and pe.coditordcp=io.coditordcp and
            (pe.qtditpe-pe.qtditentpe) >0
        group by pe.dtitpe
        order by pe.dtitpe
        into data, :valor

        do begin
                    
            -- Se existirem parcelas a gerar.

            if( numparcs>0 ) then
            begin

                insert into fnpagar (
                    codemp, codfilial, codpag,
                    codemppg, codfilialpg, codplanopag,
                    codempfr, codfilialfr, codfor,
                    codempoc, codfilialoc, codordcp,
                    vlrpag, vlrparcpag, vlrapagpag,
                    datapag, dtcomppag, statuspag, docpag, obspag )
                values (
                    :codempoc, :codfilialpag, :codpag,
                    :codemppp, :codfilialpp, :codplanopag,
                    :codempfr, :codfilialfr, :codfor,
                    :codempoc, :codfilialoc, :codordcp,
                    :valor, :valor, :valor,
                    :data, :data, 'P1', :codordcp, substring(:obspag from 1 for 250)
                );

                 -- Gerando código do pagamento
                 select iseq from spgeranum( :codemppp, :codfilialpag, 'PA') into :codpag;

            end
     end

END
^

/* Restore procedure body: FNADICRECEBERSP01 */
ALTER PROCEDURE FNADICRECEBERSP01(TIPOVENDA CHAR(1),
CODVENDA INTEGER,
CODEMPTC INTEGER,
CODFILIALTC INTEGER,
CODTIPOCOB INTEGER,
CODEMPPG INTEGER,
CODFILIALPG SMALLINT,
CODPLANOPAG INTEGER,
CODEMPCL INTEGER,
CODFILIALCL SMALLINT,
CODCLI INTEGER,
CODEMPVD INTEGER,
CODFILIALVD SMALLINT,
CODVEND INTEGER,
VLRLIQVENDA NUMERIC(15,5),
DTVENDA DATE,
DTCOMP DATE,
VLRCOMISVENDA NUMERIC(15,5),
DOCVENDA INTEGER,
CODEMPBO INTEGER,
CODFILIALBO SMALLINT,
CODBANCO CHAR(3),
CODEMP INTEGER,
CODFILIAL SMALLINT,
CODEMPCB INTEGER,
CODFILIALCB SMALLINT,
CODCARTCOB CHAR(3),
CODEMPCA INTEGER,
CODFILIALCA SMALLINT,
NUMCONTA CHAR(10),
FLAG CHAR(1),
OBSREC VARCHAR(250),
VLRBASECOMIS NUMERIC(15,5),
VLRRETENSAOISS NUMERIC(15,5))
 AS
declare variable codrec integer;
declare variable codfilialrc smallint;
declare variable parcplanopag integer;
BEGIN
  SELECT R.CODREC,R.CODFILIAL FROM FNRECEBER R
     WHERE R.CODEMPVA=:CODEMP AND R.CODFILIALVA=:CODFILIAL AND
       R.TIPOVENDA=:TIPOVENDA AND R.CODVENDA=:CODVENDA
     INTO :CODREC,:CODFILIALRC;
  SELECT PARCPLANOPAG FROM FNPLANOPAG WHERE CODEMP=:CODEMPPG AND
     CODFILIAL=:CODFILIALPG AND CODPLANOPAG=:CODPLANOPAG
     INTO :PARCPLANOPAG;

  IF ( (CODREC IS NULL) AND (PARCPLANOPAG>0) ) THEN
  BEGIN
     SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'FNRECEBER') INTO :CODFILIALRC;
     SELECT ISEQ FROM SPGERANUM(:CODEMP,:CODFILIALRC,'RC') INTO :CODREC;

     -- Caso haja retensão de ISS deve
     if(coalesce(:vlrretensaoiss,0)>0) then
     begin
        vlrliqvenda = vlrliqvenda - vlrretensaoiss;
     end

     INSERT INTO FNRECEBER (CODEMP,CODFILIAL,CODREC, CODTIPOCOB, CODEMPTC, CODFILIALTC,
              CODPLANOPAG,CODEMPPG,CODFILIALPG,CODCLI,
              CODEMPCL,CODFILIALCL,CODVEND,CODEMPVD,CODFILIALVD,TIPOVENDA,CODVENDA,
              CODEMPVA,CODFILIALVA,VLRREC,
              VLRDESCREC,VLRMULTAREC,VLRJUROSREC,VLRPARCREC,VLRPAGOREC,
              VLRAPAGREC,DATAREC, DTCOMPREC, STATUSREC,VLRCOMIREC,DOCREC,CODBANCO,CODEMPBO,CODFILIALBO,
              CODEMPCB, CODFILIALCB, CODCARTCOB, CODEMPCA, CODFILIALCA, NUMCONTA,
              FLAG, OBSREC, vlrbasecomis)
              VALUES (
                     :CODEMP, :CODFILIALRC, :CODREC, :CODTIPOCOB, :CODEMPTC, :CODFILIALTC,
                     :CodPlanoPag, :CODEMPPG, :CODFILIALPG, :CodCli,
                     :CODEMPCL, :CODFILIALCL, :CodVend, :CODEMPVD, :CODFILIALVD, :TIPOVENDA, :CodVenda,
                     :CODEMP, :CODFILIAL, :VlrLiqVenda,
                     0,0,0,:VlrLiqVenda,0,:VlrLiqVenda,:dtVenda, :dtComp, 'R1',
                     :VlrComisVenda,:DocVenda,:CodBanco,:CODEMPBO,:CODFILIALBO,
                     :CODEMPCB, :CODFILIALCB, :CODCARTCOB, 
                     :CODEMPCA, :CODFILIALCA, :NUMCONTA,
                     :FLAG, :OBSREC,:vlrbasecomis
              );
  END
  ELSE IF (CODREC IS NOT NULL) THEN
  BEGIN
    IF (PARCPLANOPAG>0) THEN
    BEGIN
        UPDATE FNRECEBER SET ALTUSUREC='N',
              CODTIPOCOB=:CODTIPOCOB, CODEMPTC=:CODEMPTC, CODFILIALTC=:CODFILIALTC,
              CODPLANOPAG=:CodPlanoPag, CODEMPPG=:CODEMPPG, CODFILIALPG=:CODFILIALPG,
              CODCLI=:CodCli, CODEMPCL=:CODEMPCL, CODFILIALCL=:CODFILIALCL,
              CODVEND=:CodVend, CODEMPVD=:CODEMPVD, CODFILIALVD=:CODFILIALVD,
              VLRREC=:VlrLiqVenda, VLRDESCREC=0, VLRMULTAREC=0, VLRJUROSREC=0,
              VLRPARCREC=:VlrLiqVenda, VLRPAGOREC=0, VLRAPAGREC=:VlrLiqVenda,
              DATAREC=:dtVenda, VLRCOMIREC=:VlrComisVenda,
              /* STATUSREC='R1' */
              DOCREC=:DocVenda, 
              CODEMPBO=:CODEMPBO, CODFILIALBO=:CODFILIALBO, CODBANCO=:CODBANCO,
              CODEMPCB=:CODEMPCB, CODFILIALCB=:CODFILIALCB, CODCARTCOB=:CODCARTCOB,
              CODEMPCA=:CODEMPCA, CODFILIALCA=:CODFILIALCA, NUMCONTA=:NUMCONTA,
              FLAG=:FLAG, vlrbasecomis=:vlrbasecomis
             WHERE CODREC=:CODREC AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIALRC;

        UPDATE FNITRECEBER SET ALTUSUITREC='S', /* Atualiza os itens de contas a */
         /* receber para ajustar automaticamente os valores no cabeçalho */
              CODEMPBO=:CODEMPBO, CODFILIALBO=:CODFILIALBO, CODBANCO=:CODBANCO,
              CODEMPCB=:CODEMPCB, CODFILIALCB=:CODFILIALCB, CODCARTCOB=:CODCARTCOB,
              CODEMPCA=:CODEMPCA, CODFILIALCA=:CODFILIALCA, NUMCONTA=:NUMCONTA
             WHERE CODREC=:CODREC AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIALRC;
     END
     ELSE
     BEGIN
         DELETE FROM FNRECEBER WHERE CODREC=:CODREC AND CODEMP=:CODEMP AND
            CODFILIAL=:CODFILIALRC;
     END
   END

END
^

/* Restore procedure body: FNCHECAPGTOATRASOSP */
ALTER PROCEDURE FNCHECAPGTOATRASOSP(ICODCLI INTEGER,
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 RETURNS(SRETORNO CHAR(1))
 AS
declare variable ilinhas integer;
declare variable ifilialreceber integer;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNRECEBER') INTO IFILIALRECEBER;
  SELECT COUNT(*) FROM FNITRECEBER IT WHERE CODREC
         IN (
            SELECT CODREC FROM FNRECEBER REC WHERE REC.CODCLI = :iCodCli
                   AND REC.CODEMPCL=:ICODEMP AND REC.CODFILIALCL=:ICODFILIAL
                   AND REC.CODREC = IT.CODREC
                   AND CODEMP=IT.CODEMP AND CODFILIAL=IT.CODFILIAL
         )
         AND STATUSITREC != 'RP' AND IT.dtvencitrec < cast('today' as date)
         AND IT.CODEMP=:ICODEMP AND IT.CODFILIAL=:IFILIALRECEBER INTO iLinhas;
  IF (iLinhas > 0) THEN
    sRetorno = 'S';
  ELSE
    sRetorno = 'N';
  SUSPEND;
END
^

/* Restore procedure body: FNCHECAPGTOSP */
ALTER PROCEDURE FNCHECAPGTOSP(ICODCLI INTEGER,
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 RETURNS(SRETORNO CHAR(1))
 AS
DECLARE VARIABLE iLinhas INTEGER;
DECLARE VARIABLE IFILIALRECEBER INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNRECEBER') INTO IFILIALRECEBER;
  SELECT COUNT(*) FROM FNITRECEBER IT WHERE CODREC
         IN (
            SELECT CODREC FROM FNRECEBER REC WHERE REC.CODCLI = :iCodCli
                   AND REC.CODEMPCL=:ICODEMP AND REC.CODFILIALCL=:ICODFILIAL
                   AND REC.CODREC = IT.CODREC
                   AND CODEMP=IT.CODEMP AND CODFILIAL=IT.CODFILIAL
         )
         AND STATUSITREC != 'RP'
         AND IT.CODEMP=:ICODEMP AND IT.CODFILIAL=:IFILIALRECEBER INTO iLinhas;
  IF (iLinhas > 0) THEN
    sRetorno = 'N';
  ELSE
    sRetorno = 'S';
  SUSPEND;
END
^

/* Restore procedure body: FNITRECEBERSP01 */
ALTER PROCEDURE FNITRECEBERSP01(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
ICODREC INTEGER,
NVLRPARCREC NUMERIC(15,5),
NVLRCOMIREC NUMERIC(15,5),
INROPARCREC INTEGER,
CCLASCOMIS CHAR(1))
 AS
declare variable inparcitrec integer;
declare variable nvlrparcitrec numeric(15,5);
declare variable nperc numeric(10,6);
declare variable nvlrcomiitrec numeric(15,5);
declare variable nresto numeric(15,5);
declare variable dvencitrec date;
begin
    -- Procedure que atualiza a comissão na tabela ITRECEBER
    nResto = nVlrComiRec;

    for select nparcitrec, vlrparcitrec, dtvencitrec from fnitreceber
    where codemp=:icodemp and codfilial=:scodfilial and codrec=:icodrec
    order by nparcitrec
    into :inparcitrec , :nvlrparcitrec, :dvencitrec do

    begin
        nperc = nvlrparcitrec / nvlrparcrec;
        nvlrcomiitrec = cast( (nvlrcomirec * nperc) as numeric(15, 5) );
        nresto = nresto - nvlrcomiitrec;

        if (inparcitrec=inroparcrec) then
        begin
            nvlrcomiitrec = nvlrcomiitrec + nresto;
        end

        update fnitreceber ir set vlrcomiitrec=:nvlrcomiitrec where codemp=:icodemp and codfilial=:scodfilial
        and codrec=:icodrec and nparcitrec=:inparcitrec;

        if (cclascomis='S') then
            execute procedure vdgeracomissaosp(:icodemp, :scodfilial, :icodrec, :inparcitrec, :nvlrcomiitrec, :dvencitrec);
    end
    suspend;
end
^

/* Restore procedure body: FNLIBCREDSP */
ALTER PROCEDURE FNLIBCREDSP(CODEMPVD INTEGER,
CODFILIALVD INTEGER,
TIPOVENDA CHAR(1),
CODVENDA INTEGER,
CODCLI INTEGER,
CODEMPCL INTEGER,
CODFILIALCL INTEGER,
VLRVENDA NUMERIC(15,5),
VLRADIC NUMERIC(15,2),
CODITEM INTEGER)
 AS
declare variable prefcred char(1);
declare variable codfilial integer;
declare variable vlrcredito numeric(15,5);
declare variable ecf char(1);
declare variable vlraberto numeric(15,5);
declare variable agrup char(1);
declare variable codempclip integer;
declare variable codfilialclip smallint;
declare variable codclip integer;
declare variable vlrdif numeric(15,2);
declare variable vlrautorizado numeric(15,2);
declare variable vlrpedidoant numeric(15,2);
declare variable vlrautorizadotot numeric(15,2);
begin
    select icodfilial from sgretfilial(:codempcl,'FNLIBCRED') into codfilial;
    select prefcred,lcredglobal from sgprefere1 where codemp=:codempcl and codfilial=:codfilial into prefcred, agrup;

    select first 1 cx.ecfcaixa from pvcaixa cx, sgconexao con, sgestacao est
        where est.codemp=con.codemp and est.codfilial=con.codfilial
            and est.codest=con.codterm AND cx.codfilialet=est.codfilial
            and cx.codempet=est.codemp AND cx.codest=est.codest
            and con.nrconexao=current_connection and conectado > 0
    into ecf;

    if (prefcred = 'N' or ecf='S') then /* Não verificar */
        exit;
    else if (prefcred = 'L') then /*Liberar se não ultrapassar o crédito pré aprovado */
        begin

             if( :coditem is not null and :vlradic is not null  ) then
             begin
                select vi.vlrproditvenda from vditvenda vi where vi.codemp=:codempvd
                and vi.codfilial=:codfilialvd and vi.codvenda=:codvenda
                and vi.tipovenda=:tipovenda and vi.coditvenda=:coditem into :vlrdif;
             end

            vlrvenda = coalesce(vlrvenda,0) + ( coalesce(vlradic,0) - coalesce(:vlrdif,0) );

            /* busca informações do cliente principal */
            select cli.codemppq, cli.codfilialpq, cli.codpesq
                from vdcliente cli
                where cli.codemp=:codempcl and cli.codfilial=:codfilialcl and cli.codcli=:codcli
            into codempclip, codfilialclip, codclip;

            if(agrup = 'S') then /* Verifica se deve agrupar despesas dos sub-clientes */
            begin
                /* BUSCA DE VALORES EM ABERTO */
                select coalesce(sum( (coalesce(it.vlrparcitrec,0)) - (coalesce(it.vlrpagoitrec,0)) ),0)
                    from fnreceber r, vdvenda v,fnitreceber it, vdcliente cl
                    where cl.codemppq=:codempclip and cl.codfilialpq=:codfilialclip and cl.codpesq=:codclip
                        and r.codempcl=cl.codemp and r.codfilialcl=cl.codfilial and r.codcli=cl.codcli
                        and (r.codempvd!=:codempvd or r.codfilialvd!=:codfilialvd or R.codvenda!=:codvenda or R.tipovenda!=:tipovenda) /* não deve contar com a venda atual */
                        and v.codemp=r.codempvd and v.codfilial=v.codfilialvd and v.codvenda=r.codvenda and v.tipovenda=r.tipovenda
                        and it.codemp=r.codemp and it.codfilial=r.codfilial and it.codrec=r.codrec and it.statusitrec not in ('RP')
                into vlraberto;

                /* BUSCA VALOR AUTORIZADO/LIBERADO */
                vlrautorizadotot = 0;
                for select lc.vlrautorizlcred,lc.vlrvendacred
                    from fnlibcred lc
                    where lc.codemp=:codempvd and lc.codfilial=:codfilialvd
                        and lc.codfilialvd=:codfilialvd and lc.codempcl=:codempcl
                        and lc.codfilialcl=:codfilialcl and lc.tipovenda=:tipovenda
                        and lc.codvenda=:codvenda and lc.dtavctolcred >= cast('today' as date)
                into :vlrautorizado, :vlrpedidoant do
                begin
                    vlrautorizadotot = :vlrautorizadotot + :vlrautorizado;
                end

                /* BUSCA DE LIMITE */
                select sum(coalesce(tc.vlrtpcred,0))
                    from fntipocred tc, vdcliente cl
                    where cl.codemppq=:codempclip and cl.codfilial=:codfilialcl and cl.codpesq=:codclip
                        and tc.codtpcred=cl.codtpcred and tc.codemp=cl.codemptr and tc.codfilial=cl.codfilialtr
                        and cast('today' as date) <= cl.dtvenctotr
                into vlrcredito;

                /* VALOR DO CREDITO É A SOMA DO CREDITO PRÉ-FIXADO + O VALOR LIBERADO PARA O PEDIDO*/
                vlrcredito = vlrcredito + vlrautorizadotot;

            end
            else /* Caso não deva agrupar as despesas dos sub-clientes */
            begin

                /* BUSCA DE VALORES EM ABERTO */

                select coalesce(sum( (coalesce(it.vlrparcitrec,0)) - (coalesce(it.vlrpagoitrec,0)) ),0)
                    from fnreceber r, vdvenda v,fnitreceber it, vdcliente cl
                    where cl.codemp=:codempvd and cl.codfilial=:codfilialvd and cl.codcli=:codcli
                        and r.codempcl=cl.codemp and r.codfilialcl=cl.codfilial and r.codcli=cl.codcli
                        and (r.codempvd!=:codempvd or r.codfilialvd!=:codfilialvd or R.codvenda!=:codvenda or R.tipovenda!=:tipovenda) /* não deve contar com a venda atual */
                        and v.codemp=r.codempvd and v.codfilial=v.codfilialvd and v.codvenda=r.codvenda and v.tipovenda=r.tipovenda
                        and it.codemp=r.codemp and it.codfilial=r.codfilial and it.codrec=r.codrec and it.statusitrec not in ('RP')
                into vlraberto;

                /* BUSCA VALOR AUTORIZADO/LIBERADO */
                vlrautorizadotot = 0;
                for select lc.vlrautorizlcred,lc.vlrvendacred
                    from fnlibcred lc
                    where lc.codemp=:codempvd and lc.codfilial=:codfilialvd
                        and lc.codfilialvd=:codfilialvd and lc.codempcl=:codempcl
                        and lc.codfilialcl=:codfilialcl and lc.tipovenda=:tipovenda
                        and lc.codvenda=:codvenda and lc.dtavctolcred >= cast('today' as date)
                into :vlrautorizado, :vlrpedidoant do
                begin
                    vlrautorizadotot = :vlrautorizadotot + :vlrautorizado;
                end

                /* BUSCA DE LIMITE */
                select coalesce(tc.vlrtpcred,0)
                    from fntipocred tc, vdcliente cl
                    where cl.codcli=:codcli and cl.codemp=:codempcl
                        and cl.codfilial=:codfilialcl AND tc.codtpcred=cl.codtpcred
                        and tc.codemp=cl.codemptr and tc.codfilial=cl.codfilialtr
                        and cast('today' as date) <= cl.dtvenctotr
                into vlrcredito;
                
                /* VALOR DO CREDITO É A SOMA DO CREDITO PRÉ-FIXADO + O VALOR LIBERADO PARA O PEDIDO*/
                vlrcredito = vlrcredito + vlrautorizadotot;

            end

            /* CASO JÁ EXISTA UM VALOR AUTORIZADO E O VALOR DO PEDIDO NÃO AUMENTOU, NÃO DEVE BLOQUEAR A VENDA*/
            if(vlrautorizadotot>0 and vlrpedidoant>=vlrvenda) then
            begin
                exit;
            end
            else if (vlrcredito > 0) then
                begin
                    if ( (vlrvenda + vlraberto ) <= vlrcredito) then
                        exit;
                    else
                        exception vdvendaex04 'VENDA:' || cast(vlrvenda as char(15)) || 'AB.: ' || cast(vlraberto as char(15)) || 'CRED.:' || cast(vlrcredito as char(15));
                        /*Valor pre-aprovado insuficiente*/
                end
        end
    suspend;
end
^

/* Restore procedure body: LFNOVODOCSP */
ALTER PROCEDURE LFNOVODOCSP(SSERIE CHAR(4),
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 RETURNS(DOC INTEGER)
 AS
declare variable iseqserie integer;
declare variable icodfilialss smallint;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP, 'LFSEQSERIE')
     INTO :ICODFILIALSS;
  DOC = NULL;
  /* Utiliza o número sequencial do documento da tabela LFSERIE,
    para retrocompatibilidade */
  SELECT COALESCE(SS.DOCSERIE,S.SERIE) DOCSERIE, SS.SEQSERIE
     FROM LFSERIE S
     LEFT OUTER JOIN LFSEQSERIE SS
     ON SS.CODEMP=S.CODEMP AND
        SS.CODFILIAL=S.CODFILIAL AND SS.SERIE=S.SERIE AND
        SS.CODEMPSS=:ICODEMP AND SS.CODFILIALSS=:ICODFILIALSS
     WHERE S.SERIE=:SSERIE AND S.CODEMP=:ICODEMP AND
        S.CODFILIAL=:ICODFILIAL AND SS.ATIVSERIE='S'
     INTO :DOC, :ISEQSERIE;
  IF (:ISEQSERIE IS NULL) THEN
  BEGIN
     IF (:DOC IS NULL) THEN
        DOC = 0;
     DOC = DOC + 1;
     SELECT MAX(SEQSERIE) FROM LFSEQSERIE SS
        WHERE SS.CODEMP=:ICODEMP AND SS.CODFILIAL=:ICODFILIAL AND
            SS.CODEMPSS=:ICODEMP AND SS.CODFILIALSS=:ICODFILIALSS AND
            SS.SERIE=:SSERIE INTO :ISEQSERIE;
     IF (:ISEQSERIE IS NULL) THEN
         ISEQSERIE = 1;
     INSERT INTO LFSEQSERIE (CODEMP, CODFILIAL, SERIE,
         CODEMPSS, CODFILIALSS, SEQSERIE, DOCSERIE)
     VALUES (:ICODEMP, :ICODFILIAL, :SSERIE,
         :ICODEMP, :ICODFILIALSS, :ISEQSERIE, :DOC);
  END
  ELSE
  BEGIN
    DOC = DOC + 1;
  END
  UPDATE LFSEQSERIE SET DOCSERIE=:DOC
     WHERE SERIE=:SSERIE AND CODEMP=:ICODEMP AND
     CODFILIAL=:ICODFILIAL AND CODEMPSS=:ICODEMP AND
     CODFILIALSS=:ICODFILIALSS AND SEQSERIE=:ISEQSERIE;
  SUSPEND;
END
^

/* Restore procedure body: PVFECHAVENDASP */
ALTER PROCEDURE PVFECHAVENDASP(ICODEMP INTEGER,
ICODFILIAL SMALLINT,
NVALOR NUMERIC(15,5),
ITERM INTEGER,
DDTAMOV DATE,
CIDUSU CHAR(8))
 AS
DECLARE VARIABLE ICODMOVCAIXA INTEGER;
DECLARE VARIABLE IFILIALUSU SMALLINT;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'SGUSUARIO') INTO IFILIALUSU;
  /*SELECT ISEQ FROM SPGERANUM(:ICODEMP,:ICODFILIAL,'MC') INTO ICODMOVCAIXA;*/
  SELECT INROMOV FROM PVSEQMOVCAIXASP(:ICODEMP, :ICODFILIAL, :ITERM , :DDTAMOV) INTO :ICODMOVCAIXA;
  INSERT INTO PVMOVCAIXA (CODEMP,CODFILIAL,CODCAIXA,DTAMOV,NROMOV,TIPOMOV,VLRMOV,CODEMPUS,CODFILIALUS,IDUSU)
         VALUES (
                :ICODEMP,:ICODFILIAL,:ITERM,:DDTAMOV,
                :ICODMOVCAIXA,'V',:NVALOR,:ICODEMP,:IFILIALUSU,:CIDUSU
         );
  SUSPEND;
END
^

/* Restore procedure body: PVSANGRIASP */
ALTER PROCEDURE PVSANGRIASP(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
NVALOR NUMERIC(18,3),
ICODCAIXA INTEGER,
DDTAMOV DATE,
CIDUSU CHAR(8))
 AS
DECLARE VARIABLE ICODMOVCAIXA INTEGER;
DECLARE VARIABLE IFILIALUSU INTEGER;
BEGIN
  if (NVALOR IS NULL) then
     NVALOR = 0;
  SELECT INROMOV FROM PVSEQMOVCAIXASP(:ICODEMP, :SCODFILIAL, :ICODCAIXA, :DDTAMOV) INTO :ICODMOVCAIXA;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'SGUSUARIO') INTO IFILIALUSU;
  INSERT INTO PVMOVCAIXA (CODEMP,CODFILIAL,CODCAIXA,DTAMOV,NROMOV,TIPOMOV,VLRMOV,CODEMPUS,CODFILIALUS,IDUSU)
         VALUES (
                :ICODEMP,:SCODFILIAL,:ICODCAIXA,:DDTAMOV,
                :ICODMOVCAIXA,'S',:NVALOR*-1,:ICODEMP,:IFILIALUSU,:CIDUSU
         );
  SUSPEND;
END
^

/* Restore procedure body: PVSUPRIMENTOSP */
ALTER PROCEDURE PVSUPRIMENTOSP(ICODEMP INTEGER,
ICODFILIAL SMALLINT,
NVALOR NUMERIC(18,3),
ITERM INTEGER,
DDTAMOV DATE,
CIDUSU CHAR(8))
 AS
DECLARE VARIABLE ICODMOVCAIXA INTEGER;
DECLARE VARIABLE IFILIALUSU INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'SGUSUARIO') INTO IFILIALUSU;
  SELECT INROMOV FROM PVSEQMOVCAIXASP(:ICODEMP, :IFILIALUSU, :ITERM, :DDTAMOV) INTO :ICODMOVCAIXA;
  INSERT INTO PVMOVCAIXA (CODEMP,CODFILIAL,CODCAIXA,DTAMOV,NROMOV,TIPOMOV,VLRMOV,CODEMPUS,CODFILIALUS,IDUSU)
         VALUES (
                :ICODEMP,:ICODFILIAL,:ITERM,:DDTAMOV,
                :ICODMOVCAIXA,'U',:NVALOR,:ICODEMP,:IFILIALUSU,:CIDUSU
         );
  SUSPEND;
END
^

/* Restore procedure body: SGAGENTEUIDSP */
ALTER PROCEDURE SGAGENTEUIDSP(CIUD CHAR(1),
ICODEMP INTEGER,
CTIPOAGE CHAR(5),
ICODAGE INTEGER,
CDESCAGE CHAR(50))
 RETURNS(CODEMP INTEGER,
CODFILIAL SMALLINT,
TIPOAGE CHAR(5),
CODAGE INTEGER)
 AS
begin
  /* Procedure para inserir, atualizar e deletar AGENTES */
  CODEMP = ICODEMP;
  TIPOAGE = CTIPOAGE;
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP, 'SGAGENTE') INTO :CODFILIAL;
  if (CIUD='I') then
     SELECT CODAGE FROM SGAGENTEISP(:CODEMP, :CODFILIAL, :TIPOAGE, :CDESCAGE)
        INTO :CODAGE;
  else if (CIUD='U') then
     SELECT CODAGE FROM SGAGENTEUSP(:CODEMP, :CODFILIAL, :TIPOAGE, :ICODAGE, :CDESCAGE)
        INTO :CODAGE;
  else if (CIUD='D') then
  begin
     DELETE FROM SGAGENTE WHERE CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL AND
        TIPOAGE=:TIPOAGE AND CODAGE=:ICODAGE;
     CODAGE=:ICODAGE;
  end
  suspend;
end
^

/* Restore procedure body: SGATUALIZABDSP */
ALTER PROCEDURE SGATUALIZABDSP(ICODEMP INTEGER)
 AS
DECLARE VARIABLE ICODEMPTMP INTEGER;
begin
  if (ICODEMP IS NULL) then
     ICODEMP = 99;
  /*CTEMP = printLog('Entrou no atualizabdsp '||cast(ICODEMP AS CHAR(10)));*/

  EXECUTE PROCEDURE SGDADOSINISP(:ICODEMP);
  EXECUTE PROCEDURE SGGRANTUSERSP ;
  FOR SELECT CODEMP FROM SGEMPRESA INTO :ICODEMPTMP DO
  BEGIN
     EXECUTE PROCEDURE SGOBJETOINSTBSP(:ICODEMPTMP);
     EXECUTE PROCEDURE SGGRANTADMSP(:ICODEMPTMP);
  END
  suspend;
end
^

/* Restore procedure body: SGCALCVENCSP */
ALTER PROCEDURE SGCALCVENCSP(CODEMP INTEGER,
DTBASE DATE,
DTVENC DATE,
REGRVCTO CHAR(1),
RVSAB CHAR(1),
RVDOM CHAR(1),
RVFER CHAR(1),
RVDIA CHAR(1),
DIAVCTO SMALLINT,
DIASVCTO SMALLINT)
 RETURNS(DTVENCRET DATE)
 AS
declare variable maxloop smallint;
declare variable curloop smallint;
declare variable dttemp date;
declare variable valorinc smallint;
declare variable codfilial smallint;
declare variable curloop02 smallint;
begin
  DTVENCRET = DTVENC;

  -- Busca o codigo da filial que será utilizado em duas regras
  if ( (REGRVCTO<>'N') and (RVFER = 'S') ) then
  begin
     SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'SGFERIADO') INTO :CODFILIAL;
  end

  -- Logica pra dia fixo
  if ( RVDIA = 'F' ) then
  begin
     MAXLOOP = 2;
     CURLOOP = 1;
     while ( CURLOOP<MAXLOOP ) do
     begin
        DTTEMP = DTVENCRET + ( 1 - EXTRACT(DAY FROM DTVENCRET) );
        DTTEMP = DTTEMP + DIAVCTO - 1;
        -- Objetivo do loop é voltar quando o dia fixo for no final do mês.
        while ( ( ( extract( month from DTVENCRET ) ) < ( extract( month from DTTEMP ) ) ) or
                ( ( extract( year from DTVENCRET ) ) < ( extract( year from DTTEMP ) ) ) ) do
        begin
           DTTEMP = DTTEMP - 1;
        end
        DTVENCRET = DTTEMP;
        if ( DTVENCRET<DTBASE ) then
        begin
           DTVENCRET = addmonth(DTVENCRET,1);
        end
        else
        begin
           break;
        end
        CURLOOP = CURLOOP + 1;
     end
  end
  -- Logica para ajustar dias uteis
  else if ( RVDIA = 'U' ) then
  begin
     while ( ( extract(month from DTVENCRET)<=extract(month from DTBASE) ) and
             ( extract(year from DTVENCRET)<=extract(year from DTBASE ) ) and
             ( DIASVCTO>0 ) ) do
     begin
        DTVENCRET = addmonth(DTVENCRET,1);
     end
     DTTEMP = DTVENCRET + ( 1 - EXTRACT(DAY FROM DTVENCRET) );
     DTVENCRET = DTTEMP;
     if (DIAVCTO<28) then -- Se for menor que dia 28 calcula o dia útil
     begin                -- Caso contrário vai será o último dia útil.
        CURLOOP02 = 1;
        while (CURLOOP02<12) do
        begin
           CURLOOP = 1;
           MAXLOOP = DIAVCTO;
           while ( CURLOOP < MAXLOOP )  do
           begin
              DTTEMP = null;
              if (RVFER='S') then
              begin
                 SELECT DATAFER FROM SGFERIADO F
                   WHERE F.CODEMP=:CODEMP AND F.CODFILIAL=:CODFILIAL AND
                     F.DATAFER=:DTVENCRET AND F.BANCFER='S'
                       INTO :DTTEMP;
              end
              if ( ( (extract( weekday from DTVENCRET )=0) and (RVDOM='S')  ) or
                   ( (extract( weekday from DTVENCRET )=6) and (RVSAB='S')  ) or
                   ( (RVFER='S') and (DTVENCRET=DTTEMP) ) ) then
              begin
                 DTVENCRET = DTVENCRET + 1;
              end
              else
              begin

                 DTVENCRET = DTVENCRET + 1;
                 CURLOOP = CURLOOP + 1;
              end
           end
           if (DTVENCRET<=DTBASE) then
           begin
              DTTEMP = DTVENCRET + ( 1 - EXTRACT(DAY FROM DTVENCRET) );
              DTVENCRET = DTTEMP;
              while ( ( extract(month from DTVENCRET)<=extract(month from DTBASE) ) and
                  ( extract(year from DTVENCRET)<=extract(year from DTBASE ) ) ) do
              begin
                 DTVENCRET = addmonth(DTVENCRET,1);
              end
           end
           else
           begin
              break;
           end
           CURLOOP02 = CURLOOP02 + 1;
        end
     end
     else
     begin
        DTTEMP = addmonth(DTVENCRET,1);
        DTVENCRET = DTTEMP - 1;
     end
  end

--  if (extract(month from dtvencret)=8) then
--  begin
--     exception fnreceberex02 'VENCIMENTO: '||CAST(dtvencret AS CHAR(10))||'REGRAVCTO = ' || REGRVCTO || 'REGRA DIA '|| RVDIA;

--  end


  -- Logica para ajustar finais de semana e feriados
  if ( (REGRVCTO<>'N') ) then
  begin
     MAXLOOP = 30;
     CURLOOP = 1;
     if ( REGRVCTO='A' ) then
     begin
        VALORINC = -1;
     end
     else
     begin
        VALORINC = 1;
     end
     while (CURLOOP<MAXLOOP) do
     begin
        if ( ( (extract( weekday from dtvencret )=0) and (RVDOM='S')  ) or
             ( (extract( weekday from dtvencret )=6) and (RVSAB='S')  ) ) then
        begin
           DTVENCRET = DTVENCRET + VALORINC;
        end
        else if (RVFER='S') then
        begin
           DTTEMP = NULL;
           SELECT DATAFER FROM SGFERIADO F
             WHERE F.CODEMP=:CODEMP AND F.CODFILIAL=:CODFILIAL AND
               F.DATAFER=:DTVENCRET AND F.BANCFER='S'
                 INTO :DTTEMP;
           if ( (DTTEMP IS NOT NULL) AND (DTTEMP=DTVENCRET) ) then
           begin
             DTVENCRET = DTVENCRET + VALORINC;
           end
           else
           begin
             break;
           end
        end
        else
        begin
           break;
        end
        CURLOOP = CURLOOP + 1;
     end
  end
  suspend;
end
^

/* Restore procedure body: VDADICITORCRECMERCSP */
ALTER PROCEDURE VDADICITORCRECMERCSP(CODEMP INTEGER,
CODFILIAL SMALLINT,
TICKET INTEGER,
CODEMPOC INTEGER,
CODFILIALOC SMALLINT,
CODORC INTEGER,
COMPONENTES CHAR(1),
SERVICOS CHAR(1),
NOVOS CHAR(1))
 AS
declare variable codemppd integer;
declare variable codfilialpd integer;
declare variable codprod integer;
declare variable coditos integer;
declare variable coditorc integer;
declare variable codprodant integer;
declare variable coditrecmerc integer;
declare variable refprod varchar(20);
declare variable codemptm integer;
declare variable codfilialtm smallint;
declare variable codtipomov integer;
declare variable codempax integer;
declare variable codfilialax smallint;
declare variable codalmox integer;
declare variable precoitorc numeric(15,5);
declare variable qtditorc numeric(15,5);
declare variable codempcl integer;
declare variable codfilialcl smallint;
declare variable codcli integer;
declare variable codemppg integer;
declare variable codfilialpg smallint;
declare variable codplanopag integer;
declare variable gerachamado char(1);
declare variable obsitorc varchar(10000);
declare variable descprod char(100);
declare variable vlrliqitorc numeric(15,5);
declare variable vlrproditorc numeric(15,5);
declare variable usaprecopecaserv char(1);
declare variable codprodpeca integer;
declare variable garantia char(1);
declare variable codprodir integer;
declare variable refprodir varchar(20);
begin
    
    -- Buscando preferencias do GMS
    select coalesce(p8.usaprecopecaserv,'N') from sgprefere8 p8
    where p8.codemp=:codemp and p8.codfilial=:codfilial
    into :usaprecopecaserv;

    -- Buscando informações do orçamento
    select codempcl, codfilialcl, codcli, codemppg, codfilialpg, codplanopag, codemptm, codfilialtm, codtipomov
    from vdorcamento
    where codemp=:codempoc and codfilial=:codfilialoc and codorc=:codorc and tipoorc='O'
    into :codempcl, :codfilialcl, :codcli, :codemppg, :codfilialpg, :codplanopag, :codemptm, :codfilialtm, :codtipomov;

    -- Sendo um orçamento para peças e mão-de-obra
    -- Deve gerar orçamento dos ítens de suplemento
    for select ir.codemppd, ir.codfilialpd, ir.codprodpd, ir.refprodpd, ir.coditrecmerc, ir.coditos, ir.qtditos,
        ir.gerachamado, pd.descprod, irm.codprod, irm.garantia, irm.codprod codprodir, irm.refprod refprodir
        from eqitrecmercitos ir, eqitrecmerc irm, eqproduto pd
        where
        irm.codemp=ir.codemp and irm.codfilial=ir.codfilial and irm.ticket=ir.ticket and irm.coditrecmerc=ir.coditrecmerc
        and pd.codemp=irm.codemppd and pd.codfilial=irm.codfilialpd and irm.codprod=pd.codprod
        and ir.codemp=:codemp and ir.codfilial=:codfilial and ir.ticket=:ticket and
        -- Filtrando componentes e serviços
        (
           (ir.gerarma=:componentes and ir.gerarma='S') or
           (ir.gerachamado=:servicos and ir.gerachamado='S') or
           (ir.geranovo=:novos and ir.geranovo='S')
        )

        into :codemppd, :codfilialpd, :codprod, :refprod, :coditrecmerc, :coditos, :qtditorc,
             :gerachamado, :descprod, :codprodpeca, :garantia, :codprodir, :refprodir
        do
        begin

--            if(:codprod <> :codprodant or :codprodant is null) then
--            begin

                -- Verifica se é serviço, sendo serviço insere a descriçao do produto
                -- consertado na descrição auxiliar do item de orçamento
                if(:gerachamado=:servicos and :gerachamado='S') then
                begin
                    if( 'N' = :garantia ) then
                    begin
                        obsitorc = :refprodir || ' - ' || :descprod;
                    end
                    else
                    begin
                        obsitorc = :refprodir || ' - ' || :descprod || '[G]';
                    end

                end

                --Buscando código do item de orçamento
                select coalesce(max(coditorc)+1,1) from vditorcamento io
                where io.codemp=:codempoc and io.codfilial=:codfilialoc and io.codorc=:codorc and io.tipoorc='O'
                into :coditorc;

                -- Buscando preço de venda
                -- Se não está em garantia...

                if('N' = :garantia) then
                begin
                    -- Se o preço é basedo na peca, deve buscar o preço da peça
                    if(usaprecopecaserv='S') then
                    begin
                        select preco from vdbuscaprecosp(:codprodpeca,:codcli,:codempcl,:codfilialcl,
                        :codplanopag,:codemppg,:codfilialpg,:codtipomov,:codemptm,:codfilialtm,:codemp,:codfilial)
                        into :precoitorc;
                    end
                    else
                    begin
                        select preco from vdbuscaprecosp(:codprod,:codcli,:codempcl,:codfilialcl,
                        :codplanopag,:codemppg,:codfilialpg,:codtipomov,:codemptm,:codfilialtm,:codemp,:codfilial)
                        into :precoitorc;
                    end
                end
                else
                begin

                    precoitorc = 0.00;

                end

                -- Buscando informações do produto
                select pd.codempax, pd.codfilialax, pd.codalmox, pd.refprod from eqproduto pd
                where pd.codemp=:codemppd and pd.codfilial=:codfilialpd and pd.codprod=:codprod
                into :codempax, :codfilialax, :codalmox, :refprod;

                vlrproditorc = :qtditorc * :precoitorc;
                vlrliqitorc = vlrproditorc;

                -- Inserir itens
                insert into vditorcamento (
                codemp, codfilial, codorc, tipoorc, coditorc,
                codemppd, codfilialpd, codprod, refprod,
                qtditorc, precoitorc, codempax, codfilialax, codalmox, obsitorc, vlrproditorc, vlrliqitorc, sitproditorc)
                values (:codempoc, :codfilialoc, :codorc, 'O', :coditorc,
                :codemppd, :codfilialpd, :codprod, :refprod,
                :qtditorc, :precoitorc, :codempax, :codfilialax, :codalmox, :obsitorc, :vlrproditorc, :vlrliqitorc,
                'PE') ;

                -- Inserindo vínculo entre item de orçamento e ordem de serviço

                insert into eqitrecmercitositorc(codemp, codfilial, ticket, coditrecmerc, coditos, codempoc, codfilialoc, codorc, coditorc, tipoorc)
                values(:codemp,:codfilial,:ticket,:coditrecmerc,:coditos, :codempoc,:codfilialoc,:codorc,:coditorc,'O');

                codprodant = codprod;

--            end
        end

        -- Atualizando o status da ordem de serviço
        update eqrecmerc rm set rm.status = 'EO'
        where rm.codemp=:codemp and rm.codfilial=:codfilial and rm.ticket=:ticket;

end
^

/* Create Trigger... */
CREATE TRIGGER CRFICHAAVALTGBU FOR CRFICHAAVAL
ACTIVE BEFORE UPDATE POSITION 0 
as
begin
  new.DTALT=cast('now' AS DATE);
  new.IDUSUALT=user;
  new.HALT = cast('now' AS TIME);
end
^

CREATE TRIGGER CRMOTIVOAVALTGBU FOR CRMOTIVOAVAL
ACTIVE BEFORE UPDATE POSITION 0 
as
begin
  new.DTALT=cast('now' AS DATE);
  new.IDUSUALT=user;
  new.HALT = cast('now' AS TIME);
end
^

CREATE TRIGGER VDITCONTRATOTGBU FOR VDITCONTRATO
ACTIVE BEFORE UPDATE POSITION 0 
AS
begin
  new.DTALT=cast('now' AS DATE);
  new.IDUSUALT=USER;
  new.HALT = cast('now' AS TIME);
end
^


/* Create Views... */
/* Create view: ATATENDIMENTOVW03 (ViwData.CreateDependDef) */
SET TERM ; ^

CREATE VIEW ATATENDIMENTOVW03(
CODEMP,
CODFILIAL,
CODATENDO,
CODEMPAE,
CODFILIALAE,
CODATEND,
NOMEATEND,
PARTPREMIATEND,
CODEMPEP,
CODFILIALEP,
MATEMPR,
NOMEEMPR,
DATAATENDO,
HORAATENDO,
HORAATENDOFIN,
CODEMPTO,
CODFILIALTO,
CODTURNO,
DESCTURNO,
CODEMPEA,
CODFILIALEA,
CODESPEC,
DESCESPEC,
PERCCOMIESPEC,
CODEMPCT,
CODFILIALCT,
CODCONTR,
CODITCONTR,
CODEMPTA,
CODFILIALTA,
CODTAREFA,
TPCOBCONTR,
ANOATENDO,
MESATENDO,
HORASEXPED,
TOTALCOMIS,
TOTALMIN,
TOTALGERAL,
TOTALBH,
SITREVATENDO,
TIPOATENDO,
DOCATENDO)
 AS 
select a.codemp, a.codfilial, a.codatendo, 
	a.codempae, a.codfilialae, a.codatend, a.nomeatend, a.partpremiatend,
 	a.codempep, a.codfilialep, a.matempr, e.nomeempr,
 	a.dataatendo, a.horaatendo, a.horaatendofin,
	e.codempto, e.codfilialto, e.codturno, t.descturno,
    a.codempea, a.codfilialea, a.codespec, a.descespec, a.perccomiespec,
    a.codempct, a.codfilialct, a.codcontr, a.coditcontr,
    a.codempta, a.codfilialta, a.codtarefa, 
    a.tpcobcontr,
    a.anoatendo, a.mesatendo, 
    x.horasexped, a.totalcomis, a.totalmin, a.totalgeral,
    ( a.totalbh * ( 1 +  
       ((case when extract(weekday from a.dataatendo)=6 then t.percbhtbsabturno 
          when extract(weekday from a.dataatendo)=0 then t.percbhtbdomturno
          when coalesce(f.trabfer,'N')='S' then t.percbhtbferturno
          else 0 end
       )/100 ) )
    ) totalbh,
    a.sitrevatendo, a.tipoatendo, a.docatendo
	from atatendimentovw02 a
	left outer join rhempregado e on
	e.codemp=a.codempep and e.codfilial=a.codfilialep and e.matempr=a.matempr
	left outer join rhturno t on
	t.codemp=e.codempto and t.codfilial=e.codfilialto and t.codturno=e.codturno
	left outer join rhexpedmes x on
	x.codemp=e.codempto and x.codfilial=e.codfilialto and x.codturno=e.codturno and 
	x.anoexped=extract(year from a.dataatendo) and x.mesexped=extract(month from a.dataatendo)
	left outer join sgferiado f on
	f.codemp=a.codemp and f.codfilial=a.codfilial and f.datafer=a.dataatendo
;

/* Create view: ATATENDIMENTOVW04 (ViwData.CreateDependDef) */
CREATE VIEW ATATENDIMENTOVW04(
DATAATENDO,
CODEMPCT,
CODFILIALCT,
CODCONTR,
CODITCONTR,
ANOATENDO,
MESATENDO,
TOTALHORASTRAB)
 AS 
select a.dataatendo, a.codempct, a.codfilialct, a.codcontr, a.coditcontr, a.anoatendo, a.mesatendo, sum(totalmin)/60 totalhorastrab
from atatendimentovw01 a
group by a.dataatendo, a.codempct, a.codfilialct, a.codcontr, a.coditcontr, a.anoatendo, a.mesatendo
;

/* Create view: ATATENDIMENTOVW06 (ViwData.CreateDependDef) */
CREATE VIEW ATATENDIMENTOVW06(
CODEMP,
CODFILIAL,
CODATENDO,
CODEMPAE,
CODFILIALAE,
CODATEND,
NOMEATEND,
CODEMPEP,
CODFILIALEP,
MATEMPR,
NOMEEMPR,
DATAATENDO,
HORAATENDO,
HORAATENDOFIN,
CODEMPTO,
CODFILIALTO,
CODTURNO,
DESCTURNO,
CODEMPEA,
CODFILIALEA,
CODESPEC,
DESCESPEC,
PERCCOMIESPEC,
CODEMPCT,
CODFILIALCT,
CODCONTR,
CODITCONTR,
TPCOBCONTR,
ANOATENDO,
MESATENDO,
HORASEXPED,
TOTALCOMIS,
TOTALGERAL,
TOTALBH,
TOTALHORASTRAB,
VLRLIQITVENDA,
SITREVATENDO)
 AS 
select a.codemp, a.codfilial, a.codatendo, a.codempae, a.codfilialae, a.codatend, 
a.nomeatend, a.codempep, a.codfilialep, a.matempr, a.nomeempr, a.dataatendo, 
a.horaatendo, a.horaatendofin, a.codempto, a.codfilialto, a.codturno, a.descturno,
a.codempea, a.codfilialea, a.codespec, a.descespec, perccomiespec,
a.codempct, a.codfilialct, a.codcontr, a.coditcontr, a.tpcobcontr,
a.anoatendo, a.mesatendo, 
a.horasexped, a.totalcomis, a.totalgeral, a.totalbh,
 ( case when a.tpcobcontr='ES' then ( select s1.totalhorastrab from atatendimentovw04 s1
        where s1.codempct=a.codempct and s1.codfilialct=a.codfilialct and 
        s1.codcontr=a.codcontr and s1.coditcontr=a.coditcontr ) 
   else ( select s1.totalhorastrab from atatendimentovw04 s1
        where s1.codempct=a.codempct and s1.codfilialct=a.codfilialct and 
        s1.codcontr=a.codcontr and s1.coditcontr=a.coditcontr and 
        s1.anoatendo=a.anoatendo and s1.mesatendo=a.mesatendo ) end) totalhorastrab, 
  ( case when a.tpcobcontr='ES' then ( select s2.vlrliqitvenda from atatendimentovw05 s2
        where s2.codempct=a.codempct and s2.codfilialct=a.codfilialct and 
         s2.codcontr=a.codcontr and s2.coditcontr=a.coditcontr)
        else ( select s2.vlrliqitvenda from atatendimentovw05 s2
        where s2.codempct=a.codempct and s2.codfilialct=a.codfilialct and 
         s2.codcontr=a.codcontr and s2.coditcontr=a.coditcontr and
         a.dataatendo between s2.dtiniapura and s2.dtfinapura) end ) vlrliqitvenda,
   a.sitrevatendo
from atatendimentovw03 a
;

/* Create view: ATATENDIMENTOVW08 (ViwData.CreateDependDef) */
CREATE VIEW ATATENDIMENTOVW08(
DATAATENDO,
DTFINCONTR,
CODEMPAE,
CODFILIALAE,
CODATEND,
NOMEATEND,
CODEMPCT,
CODFILIALCT,
CODCONTR,
CODITCONTR,
DESCCONTR,
DESCITCONTR,
TPCOBCONTR,
SITCONTR,
TOTALCOMIS)
 AS 
select a.dataatendo, fn.dtfincontr, a.codempae, a.codfilialae, a.codatend, a.nomeatend,
a.codempct, a.codfilialct, a.codcontr, a.coditcontr, ct.desccontr, ic.descitcontr,
ct.tpcobcontr, ct.sitcontr,
sum(a.totalcomis) totalcomis
from atatendimentovw02 a, vditcontrato ic,  vdcontrato ct
left outer join vdfincontr fn
on fn.codemp=ct.codemp and fn.codfilial=ct.codfilial and
fn.codcontr=ct.codcontr
where ct.codemp=a.codempct and ct.codfilial=a.codfilialct and ct.codcontr=a.codcontr and
ic.codemp=a.codempct and ic.codfilial=a.codfilialct and ic.codcontr=a.codcontr and
ic.coditcontr=a.coditcontr and ct.recebcontr='S' and
( (ct.tpcobcontr='ES' and fn.dtfincontr is not null) or (ct.tpcobcontr='ME') )
group by a.dataatendo, fn.dtfincontr, a.codempae, a.codfilialae, a.codatend, a.nomeatend,
a.codempct, a.codfilialct, a.codcontr, a.coditcontr, ct.desccontr, ic.descitcontr,
ct.tpcobcontr, ct.sitcontr
;


/* Alter exist trigger... */
DROP TRIGGER ATCONVENIADOTGAI;

SET TERM ^ ;

CREATE TRIGGER ATCONVENIADOTGAI FOR ATCONVENIADO
ACTIVE AFTER INSERT POSITION 0 
as
declare variable ICODATEND INTEGER;
declare variable ICODATENDO INTEGER;
declare variable ICODSETOR INTEGER;
DECLARE VARIABLE IFILIALATEND INTEGER;
DECLARE VARIABLE IFILIALPREF INTEGER;
DECLARE VARIABLE IFILIALUSU INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(new.CODEMP,'ATATENDENTE') INTO IFILIALATEND;
  SELECT ICODFILIAL FROM SGRETFILIAL(new.CODEMP,'SGPREFERE2') INTO IFILIALPREF;
  SELECT ICODFILIAL FROM SGRETFILIAL(new.CODEMP,'SGUSUARIO') INTO IFILIALUSU;
  SELECT CODATEND FROM ATATENDENTE
    WHERE CODEMP=new.CODEMP AND CODFILIAL=:IFILIALATEND
    AND IDUSU=LOWER(USER) AND CODEMPUS=new.CODEMP AND CODFILIALUS=:IFILIALUSU
    INTO ICODATEND;
  SELECT CODSETAT,CODTPATENDO2 FROM SGPREFERE2
    WHERE CODEMP=new.CODEMP AND CODFILIAL=:IFILIALPREF
    INTO ICODSETOR,ICODATENDO;
  EXECUTE PROCEDURE ATADICATENDIMENTOSP(
    new.CODCONV,:ICODATENDO,:ICODATEND,
    ICODSETOR,NULL,new.CODEMP,:IFILIALUSU,new.CODCONV
  );
end
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER CPCOMPRATGAU;

SET TERM ^ ;

CREATE TRIGGER CPCOMPRATGAU FOR CPCOMPRA
ACTIVE AFTER UPDATE POSITION 0 
AS
  DECLARE VARIABLE iCodPag INTEGER;
  DECLARE VARIABLE dVLR NUMERIC(15, 5);
  DECLARE VARIABLE IFILIALPAG INTEGER;
  DECLARE VARIABLE TIPOMOV CHAR(2);        
  DECLARE VARIABLE ICODITEM SMALLINT;
  DECLARE VARIABLE VLRITEM NUMERIC(15, 5);  
  DECLARE VARIABLE QTDITEM NUMERIC(15, 5);
  DECLARE VARIABLE PERCITFRETE NUMERIC(15, 5);
  DECLARE VARIABLE VLRITFRETE NUMERIC(15, 5);
  DECLARE VARIABLE PERCITADIC NUMERIC(15, 5);
  DECLARE VARIABLE VLRITADIC NUMERIC(15, 5);
  DECLARE VARIABLE SCODFILIALP1 SMALLINT;
  DECLARE VARIABLE GERAPAGEMIS CHAR(1);
  DECLARE VARIABLE DTBASE DATE;
BEGIN
  IF ( not ( (new.EMMANUT='S') or ( (old.EMMANUT='S') and (old.EMMANUT IS NOT NULL) )) ) THEN
  BEGIN
      SELECT ICODFILIAL FROM SGRETFILIAL(new.CODEMP,'SGPREFERE1') INTO :SCODFILIALP1;
      SELECT P1.GERAPAGEMIS FROM SGPREFERE1 P1 WHERE  P1.CODEMP=new.CODEMP AND
         P1.CODFILIAL=:SCODFILIALP1 INTO :GERAPAGEMIS;
      IF (GERAPAGEMIS IS NULL) THEN
      BEGIN
        GERAPAGEMIS = 'N';
      END
      IF (GERAPAGEMIS='S') THEN
      BEGIN
        DTBASE = new.DTEMITCOMPRA;
      END
      ELSE
      BEGIN
        DTBASE = new.DTENTCOMPRA;
      END
      SELECT ICODFILIAL FROM SGRETFILIAL(new.CODEMP,'FNPAGAR') INTO IFILIALPAG;
      SELECT CODPAG FROM FNPAGAR WHERE CODCOMPRA=new.CODCOMPRA
             AND CODEMP=new.CODEMP AND CODFILIAL = :IFILIALPAG INTO iCodPag;
      SELECT TIPOMOV FROM EQTIPOMOV WHERE CODTIPOMOV=new.CODTIPOMOV
             AND CODEMP=new.CODEMPTM AND CODFILIAL=new.CODFILIALTM INTO TIPOMOV;
      IF ((NOT TIPOMOV IN ('DV','TR')) AND (
         (iCodPag IS NULL) OR (
         (new.CODPLANOPAG != old.CODPLANOPAG) OR
         (new.CODFOR != old.CODFOR) OR
         (new.VLRLIQCOMPRA != old.VLRLIQCOMPRA) OR
         (new.DTENTCOMPRA != old.DTENTCOMPRA) OR
         (new.DTEMITCOMPRA != old.DTEMITCOMPRA) OR
         (new.DOCCOMPRA != old.DOCCOMPRA) OR
         (new.CODBANCO != old.CODBANCO)))) THEN
      BEGIN
        dVLR = new.VLRLIQCOMPRA;
        IF ((new.STATUSCOMPRA IN ('P2','C2')) AND (old.STATUSCOMPRA IN ('P1','C1'))) THEN
        BEGIN
          DELETE FROM FNPAGAR WHERE CODCOMPRA=old.CODCOMPRA AND CODEMP=old.CODEMP AND CODFILIAL=:IFILIALPAG;
          IF (dVlr > 0) THEN
            EXECUTE PROCEDURE FNADICPAGARSP01(new.CODCOMPRA,new.CODEMPPG,new.CODFILIALPG,
               new.CODPLANOPAG,new.CODEMPFR,new.CODFILIALFR,new.CODFOR,:dVLR,
               :DTBASE, new.DTCOMPCOMPRA, new.DOCCOMPRA,new.CODEMPBO,new.CODFILIALBO,new.CODBANCO,
               new.FLAG,new.CODEMP,new.CODFILIAL, new.CODEMPTC, new.CODFILIALTC, new.CODTIPOCOB,
               new.codempct, new.codfilialct, new.numconta, new.codempcc,  new.codfilialcc, new.anocc, new.codcc, new.codemppn, new.codfilialpn, new.codplan, new.obspag );
        END
        ELSE IF ((new.STATUSCOMPRA IN ('P2','C2')) AND (old.STATUSCOMPRA IN ('P2','C2'))) THEN
        BEGIN
          DELETE FROM FNPAGAR WHERE CODCOMPRA=old.CODCOMPRA AND CODEMP=old.CODEMP AND CODFILIAL = old.CODFILIAL;
          IF (dVlr > 0) THEN
            EXECUTE PROCEDURE FNADICPAGARSP01(new.CODCOMPRA,new.CODEMPPG,new.CODFILIALPG,new.CODPLANOPAG,
               new.CODEMPFR,new.CODFILIALFR,new.CODFOR,:dVLR,:DTBASE , new.DTCOMPCOMPRA, new.DOCCOMPRA,
               new.CODEMPBO,new.CODFILIALBO,new.CODBANCO,new.FLAG,new.CODEMP,new.CODFILIAL,
               new.CODEMPTC, new.CODFILIALTC, new.CODTIPOCOB,
               new.codempct, new.codfilialct, new.numconta, new.codempcc,  new.codfilialcc, new.anocc, new.codcc, new.codemppn, new.codfilialpn, new.codplan, new.obspag );
        END
        ELSE IF ((new.STATUSCOMPRA IN ('P3','C3')) AND (old.STATUSCOMPRA IN ('P3','C3'))) THEN
        BEGIN
          DELETE FROM FNPAGAR WHERE CODCOMPRA=old.CODCOMPRA AND CODEMP=old.CODEMP AND CODFILIAL = :IFILIALPAG;
          IF (dVlr > 0) THEN
            EXECUTE PROCEDURE FNADICPAGARSP01(new.CODCOMPRA, new.CODEMPPG, new.CODFILIALPG, new.CODPLANOPAG,
               new.CODEMPFR, new.CODFILIALFR, new.CODFOR, :dVLR, :DTBASE, new.DTCOMPCOMPRA, new.DOCCOMPRA,
               new.CODEMPBO, new.CODFILIALBO, new.CODBANCO, new.FLAG, new.CODEMP, new.CODFILIAL,
               new.CODEMPTC, new.CODFILIALTC, new.CODTIPOCOB,
               new.codempct, new.codfilialct, new.numconta, new.codempcc,  new.codfilialcc, new.anocc, new.codcc, new.codemppn, new.codfilialpn, new.codplan, new.obspag);
        END
      END
    /**
     Movimento do estoque
    **/
    /* Avisa os itens que a data de saida foi alterada */
      IF ( (new.DTENTCOMPRA != old.DTENTCOMPRA) OR
           (new.DTEMITCOMPRA != old.DTEMITCOMPRA) OR
           (new.DOCCOMPRA != old.DOCCOMPRA) OR
           (new.CODTIPOMOV != old.CODTIPOMOV) )  THEN
        UPDATE CPITCOMPRA SET CODITCOMPRA=CODITCOMPRA WHERE
             CODCOMPRA = old.CODCOMPRA AND CODEMP=old.CODEMP AND CODFILIAL=old.CODFILIAL;

      IF ( new.codimp is null and (((new.VLRFRETECOMPRA > 0) AND ( NOT new.VLRFRETECOMPRA = old.VLRFRETECOMPRA)) or ((new.vlradiccompra > 0) AND ( NOT new.vlradiccompra = old.vlradiccompra)))  ) THEN
      BEGIN
          FOR SELECT IT.CODITCOMPRA, IT.VLRLIQITCOMPRA, IT.QTDITCOMPRA FROM CPITCOMPRA IT
              WHERE IT.CODEMP=new.CODEMP AND IT.CODFILIAL=new.CODFILIAL AND IT.CODCOMPRA=new.CODCOMPRA
              INTO :ICODITEM, :VLRITEM, :QTDITEM
              DO
              BEGIN

                  IF ( (new.vlrfretecompra > 0) AND ( NOT new.vlrfretecompra = old.vlrfretecompra)  ) THEN
                  begin
                      PERCITFRETE = :VLRITEM / (old.VLRLIQCOMPRA / 100);
                      VLRITFRETE =  (:PERCITFRETE * (new.VLRFRETECOMPRA / 100)) / COALESCE(:QTDITEM, 1);

                      UPDATE CPITCOMPRA CIT
                          SET VLRFRETEITCOMPRA=:VLRITFRETE
                            WHERE CIT.CODEMP=new.CODEMP AND CIT.CODFILIAL=new.CODFILIAL
                                AND CIT.CODCOMPRA=new.CODCOMPRA AND CIT.CODITCOMPRA=:ICODITEM;
                  end
                  IF ( (new.vlradiccompra > 0) AND ( NOT new.vlradiccompra = old.vlradiccompra)  ) THEN
                  begin
                      PERCITADIC = :VLRITEM / (old.VLRLIQCOMPRA / 100);
                      VLRITADIC =  (:PERCITADIC * (new.VLRADICCOMPRA / 100)) / COALESCE(:QTDITEM, 1);
                      UPDATE CPITCOMPRA CIT
                          SET VLRADICITCOMPRA=:VLRITADIC
                            WHERE CIT.CODEMP=new.CODEMP AND CIT.CODFILIAL=new.CODFILIAL
                                AND CIT.CODCOMPRA=new.CODCOMPRA AND CIT.CODITCOMPRA=:ICODITEM;

                  end


              END
        END
          IF ((substr(new.STATUSCOMPRA,1,1)='X') AND (substr(old.STATUSCOMPRA,1,1) IN ('P','C'))) THEN
          BEGIN
              UPDATE CPITCOMPRA SET QTDITCOMPRACANC=QTDITCOMPRA, QTDITCOMPRA=0 WHERE CODCOMPRA=new.CODCOMPRA AND CODEMP=new.CODEMP
              AND CODFILIAL=new.CODFILIAL;
              DELETE FROM FNPAGAR WHERE CODCOMPRA=new.CODCOMPRA AND CODEMP=new.CODEMP
              AND CODFILIAL=new.CODFILIAL;
          END

        -- Atualização do status do recebimento da mercadoria quando a nota for emitida.
        if( old.statuscompra!='ET' and new.statuscompra='ET') then
        begin
            
           update eqrecmerc rm set rm.status='NE'
           where rm.codemp=new.codemp and rm.codfilial=new.codfilial
           and rm.ticket in
           (
            select ticket
            from eqitrecmercitcp rm
            where rm.codempcp=new.codemp and rm.codfilialcp=new.codfilial
            and rm.codcompra=new.codcompra
           );

        end

    END
END
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER CPCOMPRATGBU;

SET TERM ^ ;

CREATE TRIGGER CPCOMPRATGBU FOR CPCOMPRA
ACTIVE BEFORE UPDATE POSITION 0 
AS
  DECLARE VARIABLE dVlrPagar NUMERIC(15, 5);
  DECLARE VARIABLE sStatusPag CHAR(2);
  DECLARE VARIABLE IFILIALTIPOMOV INTEGER;
  DECLARE VARIABLE IFILIALPAG INTEGER;
  DECLARE VARIABLE CSEQNFTIPOMOV CHAR(1);
BEGIN
  IF (new.EMMANUT IS NULL) THEN
     new.EMMANUT='N';
  if (new.BLOQCOMPRA IS NULL) then
     new.BLOQCOMPRA='N';
  IF ( not ( (new.EMMANUT='S') or ( (old.EMMANUT='S') and (old.EMMANUT is not null)) ) ) THEN
  BEGIN
      if ( (old.BLOQCOMPRA IS NOT NULL AND old.BLOQCOMPRA='S') or (new.BLOQCOMPRA='S') ) then
         EXCEPTION CPCOMPRAEX04 'ESTA COMPRA ESTÁ BLOQUEADA!!!';
      new.DTALT=cast('now' AS DATE);
      new.IDUSUALT=USER;
      new.HALT = cast('now' AS TIME);
      if ( (new.DTCOMPCOMPRA IS NULL) OR (new.DTEMITCOMPRA<>old.DTEMITCOMPRA) )  then
         new.DTCOMPCOMPRA = new.DTEMITCOMPRA;
      SELECT ICODFILIAL FROM SGRETFILIAL(new.CODEMP,'EQTIPOMOV') INTO IFILIALTIPOMOV;
      SELECT ICODFILIAL FROM SGRETFILIAL(new.CODEMP,'FNPAGAR') INTO IFILIALPAG;
      SELECT T.FISCALTIPOMOV, T.SEQNFTIPOMOV FROM EQTIPOMOV T WHERE T.CODTIPOMOV=new.CODTIPOMOV
             AND T.CODEMP=new.CODEMP AND T.CODFILIAL = :IFILIALTIPOMOV INTO new.FLAG, :CSEQNFTIPOMOV;
      IF (old.IMPNOTACOMPRA IS NULL) THEN
         new.IMPNOTACOMPRA = 'N';
      IF ( (CSEQNFTIPOMOV IS NOT NULL) AND (CSEQNFTIPOMOV='S') ) THEN
      BEGIN
         IF  (new.IMPNOTACOMPRA='N') THEN
         BEGIN
            SELECT DOC FROM LFNOVODOCSP(new.Serie,new.CODEMPSE,new.CODFILIALSE) INTO new.DocCompra;
            new.IMPNOTACOMPRA = 'S';
         END
         ELSE IF (old.DOCCOMPRA != new.DOCCOMPRA) THEN
         BEGIN
            new.DOCCOMPRA = old.DOCCOMPRA;
         END
      END

      IF ( new.FLAG <> 'S') THEN
      BEGIN
        new.FLAG = 'N';
      END
      IF (new.VLRDESCCOMPRA IS NULL) THEN
        new.VLRDESCCOMPRA = 0;
      IF (new.VLRADICCOMPRA IS NULL) THEN
        new.VLRADICCOMPRA = 0;
      IF (new.VLRFRETECOMPRA IS NULL) THEN
        new.VLRFRETECOMPRA = 0;
      IF (old.STATUSCOMPRA = 'P1')  THEN
      BEGIN
        IF (new.STATUSCOMPRA = 'C1') THEN
        BEGIN
          new.STATUSCOMPRA = 'C2';
        END
      END
      ELSE IF ((old.STATUSCOMPRA IN ('P4','C4')) AND (new.STATUSCOMPRA IN ('P4','C4'))) THEN
      BEGIN
        EXCEPTION CPCOMPRAEX03;
      END
      ELSE IF ((old.STATUSCOMPRA IN ('P2','C2')) AND (new.STATUSCOMPRA IN ('P3','C3'))) THEN
      BEGIN
        SELECT STATUSPAG,VLRPARCPAG FROM FNPAGAR WHERE CODCOMPRA=new.CODCOMPRA
             AND CODEMP=new.CODEMP AND CODFILIAL = :IFILIALPAG INTO :sStatusPag,:dVlrPagar;
        IF ((sStatusPag = 'PD') AND (new.VLRLIQCOMPRA != :dVlrPagar)) THEN
          EXCEPTION CPCOMPRAEX04;
      END
       IF ((substr(old.STATUSCOMPRA,1,1) IN ('P','C')) AND (substr(new.STATUSCOMPRA,1,1)='X')) THEN
      BEGIN
           new.vlrdescitcompra = 0;
           new.vlrprodcompra = 0;
           new.vlrbaseicmscompra = 0;
           new.vlricmscompra = 0;
           new.vlrisentascompra = 0;
           new.vlroutrascompra = 0;
           new.vlrbaseipicompra = 0;
           new.vlripicompra = 0;
           new.vlrliqcompra = 0;
           new.vlripicompra = 0;
      END

  END
    -- Atualizando o status do documento fiscal para 02 - Documento cancelado, quando nota for cancelado pelo sistema.
  IF (substr(new.statuscompra,1,1) = 'X' and new.sitdoc!='02') THEN
  begin
    new.sitdoc = '02';
  end

  if(old.chavenfecompra is null and new.chavenfecompra is not null) then
  begin
    new.emmanut = 'N';
  end

END
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER CPFORNECEDTGBI;

SET TERM ^ ;

CREATE TRIGGER CPFORNECEDTGBI FOR CPFORNECED
ACTIVE BEFORE INSERT POSITION 0 
AS
    declare variable nomemunicfor CHAR(30);
    declare variable geracodunif char(1);
    declare variable codunifcod integer;
    declare variable filialpref smallint;

begin

    /*Atualização do campo cidade e estado (temporário para retro-compatibilidade)*/

    if(new.codmunic is not null) then
    begin
        select substr(mun.nomemunic,1,30) from sgmunicipio mun
            where mun.codpais=new.codpais and mun.siglauf=new.siglauf and mun.codmunic=new.codmunic
                into :nomemunicfor;
        if (nomemunicfor is not null) then new.cidfor = nomemunicfor;
    end

    if(new.siglauf is not null) then
    begin
        new.uffor=new.siglauf;
    end

    /* Fim da atualização do campo cidade e estado*/

    -- Geração de código unificador (SGUNIFCOD)

    select icodfilial from sgretfilial(new.codemp,'SGPREFERE1') into filialpref;
    select geracodunif from sgprefere1 where codemp=new.codemp and codfilial=:filialpref into :geracodunif;

    if(:geracodunif = 'S') then
    begin

        select (coalesce(max(codunifcod),0)+1) from sgunifcod where codemp=new.codemp and codfilial=new.codfilial
        into :codunifcod;

        insert into sgunifcod (codemp, codfilial, codunifcod, tipounifcod, descunifcod)
        values (new.codemp, new.codfilial, :codunifcod, 'F', new.razfor);
        new.codempuc=new.codemp;
        new.codfilialuc=new.codfilial;
        new.codunifcod=:codunifcod;

    end

end
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER CPFORNECEDTGBU;

SET TERM ^ ;

CREATE TRIGGER CPFORNECEDTGBU FOR CPFORNECED
ACTIVE BEFORE UPDATE POSITION 0 
as
  declare variable nomemunicfor CHAR(30);
begin
    new.DTALT=cast('now' AS DATE);
    new.IDUSUALT=USER;
    new.HALT = cast('now' AS TIME);

    /*Atualização do campo cidade e estado (temporário para retro-compatibilidade)*/

    if(old.codmunic != new.codmunic) then
    begin
        select substr(mun.nomemunic,1,30) from sgmunicipio mun
            where mun.codpais=new.codpais and mun.siglauf=new.siglauf and mun.codmunic=new.codmunic
                into :nomemunicfor;
        if (nomemunicfor is not null) then new.cidfor = nomemunicfor;
    end

    if(new.siglauf is not null) then
    begin
        new.uffor=new.siglauf;
    end

    /* Fim da atualização do campo cidade */

end
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER CPITCOMPRATGBU;

SET TERM ^ ;

CREATE TRIGGER CPITCOMPRATGBU FOR CPITCOMPRA
ACTIVE BEFORE UPDATE POSITION 0 
as

declare variable srefprod varchar(20);
declare variable sadicfrete char(1);
declare variable sadicadic char(1);
declare variable habcustocompra char(1);
declare variable vlritcusto numeric(15, 5);
declare variable statuscompra char(2);
declare variable calctrib char(1);

begin

    if ( not ( (new.emmanut='S') or ( (old.emmanut='S') and (old.emmanut is not null) )) ) then
    begin

        if ( new.vlrbaseicmsstitcompra is null ) then new.vlrbaseicmsstitcompra=0;
        if (new.vlricmsstitcompra is null ) then new.vlricmsstitcompra=0;
        
        
        -- Atulizando log de alteração
        new.dtalt = cast('today' as date);
        new.idusualt = user;
        new.halt = cast('now' as time);

        -- Não permite a alteração do produto
        if (new.codprod != old.codprod) then
        begin
            exception cpitcompraex01;
        end

        -- Não permite a alteração do lote
        if (new.codlote != old.codlote) then
        begin
            exception cpitcompraex02;
        end

        -- Se o código do almoxarifado estiver nulo, preenche como almoxarifado padrão do produto
        if (new.codalmox is null) then
        begin
            select codempax, codfilialax, codalmox from eqproduto
            where codemp=new.codemppd and codfilial=new.codfilialpd and codprod=new.codprod
            into new.codempax, new.codfilialax, new.codalmox;
        end

        -- Não permite a troca de almoxarifado
        if ( old.codalmox is not null and old.codalmox != new.codalmox ) then
        begin
            exception eqalmox01;
        end

        -- Busca referência do produto
        select refprod from eqproduto
        where codprod=new.codprod and codemp=new.codemppd and codfilial=new.codfilialpd
        into srefprod;

        -- Busca informações no cabeçalho da compra
        select adicfretecompra, adicadiccompra, statuscompra
        from cpcompra where
        codemp=new.codemp and codfilial=new.codfilial and codcompra=new.codcompra
        into :sadicfrete, :sadicadic, :statuscompra;

        /* Caso a nota não seja cancelada */
        if ((substr(:statuscompra,1,1)<>'X')) then
        begin

            vlritcusto = new.vlrliqitcompra/new.qtditcompra;

            -- Buscando informações das preferencias gerais
            select p.custocompra from sgprefere1 p
            where p.codemp=new.codemp and p.codfilial=new.codfilial
            into :habcustocompra;

            --Buscando informações da compra
            select cp.calctrib from cpcompra cp
            where cp.codemp=new.codemp and cp.codfilial=new.codfilial and cp.codcompra=new.codcompra
            into :calctrib;

            if (('N' = habcustocompra) or (new.custoitcompra is null)) then
            begin
                select nvlrcusto
                from cpcomprasp01 (new.codemp, new.codfilial, new.qtditcompra, new.vlrliqitcompra, new.vlricmsitcompra)
                into new.custoitcompra;
            end

            --  Atualizado a referencia do produto
            if (new.refprod is null) then
            begin
                new.refprod = srefprod;
            end

            -- Adicionando o frete ao valor de custo do item
            if (:sadicfrete = 'S' ) then
            begin
                vlritcusto = vlritcusto + new.vlrfreteitcompra;
            end

            -- Adiconando valores adicionais ao custo do item
            if (:sadicadic = 'S') then
            begin
                vlritcusto = vlritcusto + new.vlradicitcompra;
            end

            new.custoitcompra=:vlritcusto;

            -- Buscando e carregando retenção de tributos
            if(calctrib='S') then
            begin
                select coalesce(bc.vlrbasefunrural,0), coalesce(bc.aliqfunrural,0), coalesce(bc.vlrfunrural,0), bc.codempif, bc.codfilialif, bc.codfisc, bc.coditfisc
                from lfbuscatribcompra(new.codemp, new.codfilial, new.codcompra, new.codemppd, new.codfilialpd, new.codprod, new.vlrliqitcompra) bc
                into new.vlrbasefunruralitcompra, new.aliqfunruralitcompra, new.vlrfunruralitcompra,
                new.codempif, new.codfilialif, new.codfisc, new.coditfisc;
            end

            -- Descontando o valor do funrual do valor liquido do ítem
            if( new.vlrfunruralitcompra > 0 ) then
            begin
                new.vlrliqitcompra = new.vlrliqitcompra - new.vlrfunruralitcompra;
            end

        end
    end
end
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER EQGRUPOTGBU;

SET TERM ^ ;

CREATE TRIGGER EQGRUPOTGBU FOR EQGRUPO
ACTIVE BEFORE UPDATE POSITION 0 
as
begin
  new.DTALT=cast('now' AS DATE);
  new.IDUSUALT=USER;
  new.HALT = cast('now' AS TIME);
  if (new.ESTNEGGRUP IS NULL) then
     new.ESTNEGGRUP = 'N';
  if (new.ESTLOTNEGGRUP IS NULL) then
     new.ESTLOTNEGGRUP = 'N';
  if ( (old.ESTNEGGRUP IS NULL) OR (old.ESTNEGGRUP!=new.ESTNEGGRUP) ) then
     UPDATE EQGRUPO SET ESTNEGGRUP=new.ESTNEGGRUP
         WHERE CODEMP=new.CODEMP AND CODFILIAL=new.CODFILIAL AND
           CODGRUP!=new.CODGRUP AND CODGRUP LIKE RTRIM(new.CODGRUP)||'%';
  if ( (old.ESTLOTNEGGRUP IS NULL) OR (old.ESTLOTNEGGRUP!=new.ESTLOTNEGGRUP) ) then
     UPDATE EQGRUPO SET ESTLOTNEGGRUP=new.ESTLOTNEGGRUP
         WHERE CODEMP=new.CODEMP AND CODFILIAL=new.CODFILIAL AND
           CODGRUP!=new.CODGRUP AND CODGRUP LIKE RTRIM(new.CODGRUP)||'%';
  /* Trigger Text */
end
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER EQLOTETGBU;

SET TERM ^ ;

CREATE TRIGGER EQLOTETGBU FOR EQLOTE
ACTIVE BEFORE UPDATE POSITION 0 
as
  DECLARE VARIABLE ICODFILIAL INTEGER;
  DECLARE VARIABLE CESTLOTNEG CHAR(1);
  DECLARE VARIABLE CESTNEGGRUP CHAR(1);
  DECLARE VARIABLE CESTLOTNEGGRUP CHAR(1);
begin
  SELECT ICODFILIAL FROM SGRETFILIAL(new.CODEMP,'SGPREFERE1') INTO :iCodFilial;
  SELECT ESTLOTNEG,ESTNEGGRUP FROM SGPREFERE1 WHERE CODEMP=new.CODEMP AND CODFILIAL=:iCodFilial
     INTO :cEstLotNeg, :cEstNegGrup;
  new.DTALT=cast('now' AS DATE);
  new.IDUSUALT=USER;
  new.HALT = cast('now' AS TIME);
  if (new.SLDLOTE is null) then
     new.SLDLOTE = 0;
  if (new.SLDRESLOTE is null) then
     new.SLDRESLOTE = 0;
  if (new.SLDCONSIGLOTE is null) then
     new.SLDCONSIGLOTE = 0;
  new.SLDLIQLOTE = new.SLDLOTE-new.SLDRESLOTE-new.SLDCONSIGLOTE;
  if (cEstNegGrup is null) then
      cEstNegGrup ='N';
  if (cEstLotNeg Is null) then
      cEstLotNeg = 'N';

  if ( new.SLDLOTE < 0) then
  begin
     if (cEstNegGrup = 'S') then
     begin
        SELECT G.ESTLOTNEGGRUP FROM EQGRUPO G, EQPRODUTO P
          WHERE P.CODEMP=new.CODEMP AND P.CODFILIAL=new.CODFILIAL AND
            P.CODPROD=new.CODPROD AND G.CODEMP=P.CODEMPGP AND
            G.CODFILIAL=P.CODFILIALGP AND G.CODGRUP=P.CODGRUP
          INTO :cEstLotNegGrup;
        if (cEstLotNegGrup is null) then
           cEstLotNegGrup = 'N';
        if (cEstLotNegGrup='N') then
           EXCEPTION EQLOTEEX01 'O LOTE '||rtrim(new.CODLOTE)||
              ' NÃO POSSUI SALDO P/COMPL. A OPERAÇÃO';
     end
     else if (cEstLotNeg='N') then
           EXCEPTION EQLOTEEX01 'O LOTE '||rtrim(new.CODLOTE)||
              ' NÃO POSSUI SALDO P/COMPL. A OPERAÇÃO';
  end
end
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER EQPRODUTOTGBU;

SET TERM ^ ;

CREATE TRIGGER EQPRODUTOTGBU FOR EQPRODUTO
ACTIVE BEFORE UPDATE POSITION 0 
as
  DECLARE VARIABLE ICODFILIAL INTEGER;
  DECLARE VARIABLE CESTNEG CHAR(1);
  DECLARE VARIABLE CESTNEGGRUPPREF CHAR(1);
  DECLARE VARIABLE CESTNEGGRUP CHAR(1);
  DECLARE VARIABLE ICODPROD INTEGER;
begin
  SELECT ICODFILIAL FROM SGRETFILIAL(new.CODEMP,'SGPREFERE1') INTO :iCodFilial;
  SELECT ESTNEG, ESTNEGGRUP FROM SGPREFERE1
     WHERE CODEMP=new.CODEMP AND CODFILIAL=:iCodFilial
     INTO :cEstNeg, :cEstNegGrupPref;
  new.DTALT=cast('now' AS DATE);
  new.IDUSUALT=USER;
  new.HALT = cast('now' AS TIME);
  if (new.SLDPROD is null) then
     new.SLDPROD = 0;
  if (new.SLDRESPROD is null) then
     new.SLDRESPROD = 0;
  if (new.SLDCONSIGPROD is null) then
     new.SLDCONSIGPROD = 0;
  new.SLDLIQPROD = new.SLDPROD-new.SLDRESPROD-new.SLDCONSIGPROD;
  if (cEstNeg Is null) then
      cEstNeg = 'N';
  if (cEstNegGrupPref is null) then
      cEstNegGrupPref = 'N';
  if ((new.SLDPROD < 0) AND (new.TIPOPROD='P') ) THEN
  begin
    if (cEstNegGrupPref = 'S') then
    begin
       SELECT ESTNEGGRUP FROM EQGRUPO
         WHERE CODEMP=new.CODEMPGP AND CODFILIAL=new.CODFILIALGP AND
            CODGRUP=new.CODGRUP INTO :CESTNEGGRUP;
       if (cEstNegGrup is null) then
          cEstNegGrup = 'N';
       if (cEstNegGrup='N') then
          EXCEPTION EQPRODUTOEX01 'O PROD. '||rtrim(cast(new.CODPROD as char(10)))
            ||'-'||substring(new.DESCPROD from 1 for 20)||
          ' NÃO POSSUI SALDO P/COMPL. A OPERAÇÃO';
    end
    else if (cEstNeg='N') then
          EXCEPTION EQPRODUTOEX01 'O PROD. '||rtrim(cast(new.CODPROD as char(10)))
            ||'-'||substring(new.DESCPROD from 1 for 20)||
          ' NÃO POSSUI SALDO P/COMPL. A OPERAÇÃO';
  end
  if ( new.REFPROD != old.REFPROD ) then
  begin
     SELECT FIRST 1 CODPROD FROM EQMOVPROD WHERE CODEMPPD=new.CODEMP AND
        CODFILIALPD=new.CODFILIAL AND CODPROD=new.CODPROD
          INTO :ICODPROD;
     if ( (ICODPROD IS NOT NULL) AND (ICODPROD=new.CODPROD) ) then
        EXCEPTION EQPRODUTOEX01 'REFERÊNCIA NÃO PODE SER ALTERADA. PRODUTO POSSUI MOVIMENTO!';
     else
        UPDATE EQCODALTPROD SET REFPROD=new.REFPROD WHERE CODEMP=new.CODEMP AND
          CODFILIAL=new.CODFILIAL AND CODPROD=new.CODPROD;
  end
end
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER FNITPAGARTGBU;

SET TERM ^ ;

CREATE TRIGGER FNITPAGARTGBU FOR FNITPAGAR
ACTIVE BEFORE UPDATE POSITION 0 
AS
  DECLARE VARIABLE IFILIALPAG INTEGER;
  DECLARE VARIABLE ICODFOR INTEGER;
  DECLARE VARIABLE ICODEMPFR INTEGER;
  DECLARE VARIABLE ICODFILIALFR INTEGER;
  DECLARE VARIABLE CODEMPLC INTEGER;
  DECLARE VARIABLE CODFILIALLC SMALLINT;
  DECLARE VARIABLE CODLANCA INTEGER;
  DECLARE VARIABLE COUNTLANCA INTEGER;
  DECLARE VARIABLE VLRLANCA NUMERIC(15,5);
BEGIN

  new.DTALT=cast('now' AS DATE);
  new.IDUSUALT=USER;
  new.HALT = cast('now' AS TIME);

  IF ( new.EMMANUT IS NULL ) THEN
  BEGIN
      new.EMMANUT = 'N';
  END

  IF ( not ( (new.EMMANUT='S') or ( (old.EMMANUT='S') and (old.EMMANUT is not null)) ) ) THEN
  BEGIN

     if ( (old.edititpag='S') or (new.edititpag is null) ) then
     begin
         new.edititpag = 'N';
     end

     SELECT ICODFILIAL FROM SGRETFILIAL(new.CODEMP,'FNPAGAR') INTO IFILIALPAG;
     IF ((old.STATUSITPAG IN ('PP','PL') )  AND (new.STATUSITPAG='P1') ) THEN
     BEGIN

       IF ( (old.MULTIBAIXA IS NULL) OR (old.MULTIBAIXA='N') ) THEN
       BEGIN        
          DELETE FROM FNSUBLANCA WHERE CODPAG=new.CODPAG AND NPARCPAG=new.NPARCPAG AND 
              CODEMPPG=new.CODEMP AND CODFILIALPG = new.CODFILIAL;
          DELETE FROM FNLANCA WHERE CODPAG=new.CODPAG AND NPARCPAG=new.NPARCPAG AND 
              CODEMPPG=new.CODEMP AND CODFILIALPG = new.CODFILIAL;
       END
       ELSE 
       BEGIN
          SELECT CODEMP, CODFILIAL, CODLANCA FROM FNSUBLANCA
             WHERE CODPAG=new.CODPAG AND NPARCPAG=new.NPARCPAG AND 
                CODEMPPG=new.CODEMP AND CODFILIALPG = new.CODFILIAL 
             INTO :CODEMPLC, :CODFILIALLC, :CODLANCA;
          DELETE FROM FNSUBLANCA WHERE CODPAG=new.CODPAG AND NPARCPAG=new.NPARCPAG AND 
             CODEMPPG=new.CODEMP AND CODFILIALPG = new.CODFILIAL; 
          SELECT VLRLANCA FROM FNLANCA
             WHERE CODEMP=:CODEMPLC AND CODFILIAL=:CODFILIALLC AND CODLANCA=:CODLANCA
             INTO :VLRLANCA;
          IF (:VLRLANCA=0) THEN 
          BEGIN
             DELETE FROM FNLANCA 
             WHERE CODEMP=:CODEMPLC AND CODFILIAL=:CODFILIALLC AND CODLANCA=:CODLANCA;
          END 
       END

       new.VLRPAGOITPAG = 0;
       new.DTPAGOITPAG = NULL;

     END
     ELSE IF ( (old.STATUSITPAG='P1') AND ( new.STATUSITPAG='CP' ) ) THEN
     BEGIN
        IF ( (new.OBSITPAG IS NULL) OR (rtrim(new.OBSITPAG)='') ) THEN
        BEGIN
           EXCEPTION FNITPAGAREX01;
        END
        new.VLRCANCITPAG = new.VLRAPAGITPAG;
        new.VLRPARCITPAG = 0;
        new.VLRDESCITPAG = 0;
        new.VLRJUROSITPAG = 0;
        new.VLRDEVITPAG = 0;
        new.VLRITPAG = 0;
     END

     SELECT ICODFILIAL FROM SGRETFILIAL(new.CODEMP,'FNSUBLANCA') INTO :CODFILIALLC;
     SELECT COUNT (CODLANCA) FROM FNSUBLANCA WHERE CODPAG=new.CODPAG AND NPARCPAG=new.NPARCPAG
           AND CODEMPPG= new.CODEMP AND CODFILIALPG=new.CODFILIAL
           AND CODEMP=new.CODEMP AND CODFILIAL = :CODFILIALLC INTO :COUNTLANCA;

     new.VLRITPAG = new.VLRPARCITPAG - new.VLRDESCITPAG - new.VLRDEVITPAG + new.VLRJUROSITPAG + new.VLRMULTAITPAG + new.VLRADICITPAG;

     IF ( new.STATUSITPAG = 'P1' ) THEN
     BEGIN
         new.VLRAPAGITPAG = new.VLRITPAG - new.VLRPAGOITPAG;
     END
  
     if( :countlanca <= 1 ) then
     begin
         if (new.VLRAPAGITPAG < 0) then /* se o valor a pagar for menor que zero */
           new.VLRAPAGITPAG = 0;  /* então valor a pagar será zero */
         if ( (new.VLRAPAGITPAG=0) AND (new.VLRITPAG>0) ) then /* se o valor a pagar for igual a zero e existir valor na parcela*/
           new.STATUSITPAG = 'PP';  /* então o status será PP(pagamento completo) */
         else if ( (new.VLRPAGOITPAG>0) AND (new.VLRITPAG>0) ) then /* caso contrário e o valor pago maior que zero e existir valor na parcela*/
           new.STATUSITPAG = 'PL'; /*  então o status será PL(pagamento parcial) */
     end

     IF ((old.STATUSITPAG='P1' AND new.STATUSITPAG in ('PP','PL')) OR
            (old.STATUSITPAG in ('PL') AND new.STATUSITPAG in ('PP','PL') AND new.VLRPAGOITPAG > 0) ) THEN
     BEGIN
       /* faz o lançamento */
       SELECT CODFOR,CODEMPFR,CODFILIALFR FROM FNPAGAR WHERE CODEMP=new.CODEMP AND CODFILIAL=new.CODFILIAL AND CODPAG=new.CODPAG
         INTO ICODFOR,ICODEMPFR,ICODFILIALFR;

       if ( (new.multibaixa = 'N') and ((new.edititpag is null) or (new.edititpag='N') ) ) THEN
       BEGIN
           EXECUTE PROCEDURE FNADICLANCASP02(new.CodPag,new.NParcPag,new.NumConta,new.CODEMPCA,new.CODFILIALCA,:ICODFOR,:ICODEMPFR,:ICODFILIALFR,
                              new.CodPlan,new.CODEMPPN,new.CODFILIALPN,new.AnoCC,new.CodCC,new.CODEMPCC,new.CODFILIALCC, new.DTCOMPITPAG,
                              new.DtPagoItPag,new.DocLancaItPag,new.ObsItPag,new.VlrPagoItPag,new.CODEMP,new.CODFILIAL,new.vlrjurositpag,new.vlrdescitpag);
       END

       /* Altera o valor pago e o valor a pagar */
       if ((new.edititpag is null) or (new.edititpag='N')) then
       begin
           new.VLRPAGOITPAG = new.VLRPAGOITPAG + old.VLRPAGOITPAG;
       end

       new.VLRAPAGITPAG = new.VLRITPAG - new.VLRPAGOITPAG;

       if (new.VLRAPAGITPAG < 0) then /* se o valor a pagar for menor que zero */
         new.VLRAPAGITPAG = 0;  /* então valor a pagar será zero */

       if (new.VLRAPAGITPAG=0) then /* se o valor a pagar for igual a zero */
         new.STATUSITPAG = 'PP';  /* então o status será PP(pagamento completo) */
       else if (new.VLRPAGOITPAG>0) then /* caso contrário e o valor pago maior que zero */
         new.STATUSITPAG = 'PL'; /*  então o status será PL(pagamento parcial) */

     END
     ELSE IF (new.VLRPAGOITPAG < 0 )THEN
     BEGIN
         new.VLRPAGOITPAG = new.VLRPAGOITPAG * -1;
         new.VLRAPAGITPAG = new.VLRAPAGITPAG + new.VLRPAGOITPAG;
         new.VLRPAGOITPAG = old.VLRPAGOITPAG - new.VLRPAGOITPAG;
     END
     ELSE IF ((old.STATUSITPAG='PP') AND (new.STATUSITPAG='PP')) THEN
     BEGIN
        EXCEPTION FNPAGAREX01;
     END

     if (new.edititpag='S') then
     begin
        new.edititpag='N';
     end

   END
   
   
END
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER FNITRECEBERTGBU;

SET TERM ^ ;

CREATE TRIGGER FNITRECEBERTGBU FOR FNITRECEBER
ACTIVE BEFORE UPDATE POSITION 0 
AS

  DECLARE VARIABLE SCODFILIALPF SMALLINT;
  DECLARE VARIABLE CCOMISPDUPL CHAR(1);
  DECLARE VARIABLE NVLRPARCREC NUMERIC(15, 5);
  DECLARE VARIABLE NVLRCOMIREC NUMERIC(15, 5);
  DECLARE VARIABLE ESTITRECALTDTVENC CHAR(1);
  DECLARE VARIABLE AUTOBAIXAPARC CHAR(1);
  declare variable seqnossonumero int;
  DECLARE VARIABLE CODFILIALLC SMALLINT;
  DECLARE VARIABLE COUNTLANCA INTEGER;
BEGIN
  IF (new.EMMANUT IS NULL) THEN   /* Evita flag de manutenÃ§Ã£o nulo */
     new.EMMANUT='N';

  IF ( new.ALTUSUITREC IS NULL ) THEN /* Para nÃ£o permitir flag de usuÃ¡rio nulo */
     new.ALTUSUITREC = 'S';

  IF ( not ( (new.EMMANUT='S') or ( (old.EMMANUT='S') and (old.EMMANUT is not null)) ) ) THEN
  BEGIN
     new.DTALT=cast('now' AS DATE);
     new.IDUSUALT=USER;
     new.HALT = cast('now' AS TIME);

     IF ( (new.DTPAGOITREC is not null) AND (new.DTLIQITREC is null) ) THEN
     BEGIN
        new.DTLIQITREC = new.DTPAGOITREC;
     END

     SELECT ESTITRECALTDTVENC FROM SGPREFERE1 WHERE CODEMP=new.CODEMP AND CODFILIAL=new.CODFILIAL INTO :ESTITRECALTDTVENC;
     SELECT ITPP.AUTOBAIXAPARC FROM FNPARCPAG ITPP, FNRECEBER R
       WHERE ITPP.CODEMP=R.CODFILIALPG AND ITPP.CODFILIAL=R.CODFILIALPG AND ITPP.CODPLANOPAG=R.CODPLANOPAG AND
         ITPP.NROPARCPAG=new.NPARCITREC AND
          R.CODEMP=new.CODEMP AND R.CODFILIAL=new.CODFILIAL AND R.CODREC=new.CODREC
       INTO :AUTOBAIXAPARC;

     IF  ( ( (old.STATUSITREC IN ('RP','RL') )  AND (new.STATUSITREC IN ('R1', 'RR')) ) OR
           ( (ESTITRECALTDTVENC='S') AND (AUTOBAIXAPARC='S') AND
             (old.DTVENCITREC<>new.DTVENCITREC) ) ) THEN
     BEGIN
       IF(new.STATUSITREC != 'RR')THEN
       BEGIN
        new.STATUSITREC = 'R1';
       END
       new.VLRPAGOITREC = 0;
     END
     ELSE IF ( (old.STATUSITREC='R1') AND ( new.STATUSITREC='CR' ) ) THEN
     BEGIN
        IF ( (new.OBSITREC IS NULL) OR (rtrim(new.OBSITREC)='') ) THEN
        BEGIN
           EXCEPTION FNITRECEBEREX02;
        END
        new.VLRCANCITREC = new.VLRAPAGITREC;
        new.VLRPARCITREC = 0;
        new.VLRDESCITREC = 0;
        new.VLRJUROSITREC = 0;
        new.VLRDEVITREC = 0;
        new.VLRITREC = 0;
     END

     SELECT ICODFILIAL FROM SGRETFILIAL(new.CODEMP,'FNSUBLANCA') INTO :CODFILIALLC;
     SELECT COUNT (CODLANCA) FROM FNSUBLANCA WHERE CODREC=new.CODREC AND NPARCITREC=new.NPARCITREC
              AND CODEMPRC= new.CODEMP AND CODFILIALRC=new.CODFILIAL
              AND CODEMP=new.CODEMP AND CODFILIAL = :CODFILIALLC INTO :COUNTLANCA;

     new.VLRITREC = new.VLRPARCITREC - new.VLRDESCITREC - new.VLRDEVITREC + new.VLRJUROSITREC + new.VLRMULTAITREC;
     new.VLRAPAGITREC = new.VLRITREC - new.VLRPAGOITREC;
     if (new.VLRAPAGITREC < 0 or new.VLRAPAGITREC is null ) then /* se o valor a pagar for maior que zero */
        new.VLRAPAGITREC = 0;  /* entÃ£o valor a pagar serÃ¡ zero */

     if(:countlanca <= 1)then
     begin
        if ( (new.VLRAPAGITREC=0) AND (new.STATUSITREC<>'CR') ) then /* se o valor a pagar for igual a zero */
            new.STATUSITREC = 'RP';  /* entÃ£o o status serÃ¡ RP(pagamento completo) */
        else if (new.VLRPAGOITREC>0) then /* caso contrÃ¡rio e o valor pago maior que zero */
            new.STATUSITREC = 'RL'; /*  entÃ£o o status serÃ¡ RL(pagamento parcial) */
     end
     /*
       Esta seÃ§Ã£o Ã© destinada e ajustar as comissÃµes conforme os valores de parcelas
       caso o preferÃªncias esteja ajustado para isso.
     */
     IF ( (new.VLRPARCITREC!=old.VLRPARCITREC) AND (new.VLRPARCITREC!=0) ) THEN
     BEGIN
        SELECT ICODFILIAL FROM SGRETFILIAL(new.CODEMP,'SGPREFERE1') INTO :SCODFILIALPF;
        SELECT P1.COMISPDUPL  FROM SGPREFERE1 P1
            WHERE P1.CODEMP=new.CODEMP AND P1.CODFILIAL=:SCODFILIALPF INTO :CCOMISPDUPL;
        IF (CCOMISPDUPL='S') THEN
        BEGIN
           SELECT V.VLRLIQVENDA, R.VLRCOMIREC FROM FNRECEBER R, VDVENDA V
             WHERE R.CODEMP=new.CODEMP AND R.CODFILIAL=new.CODFILIAL AND
                 R.CODREC=new.CODREC AND V.CODEMP=R.CODEMPVA AND V.CODFILIAL=R.CODFILIALVA AND
                 V.TIPOVENDA=R.TIPOVENDA AND V.CODVENDA=R.CODVENDA INTO :NVLRPARCREC, :NVLRCOMIREC;
           IF (NVLRPARCREC!=0) THEN
             new.VLRCOMIITREC = cast( new.VLRPARCITREC * :NVLRCOMIREC / :NVLRPARCREC as NUMERIC(15, 5) );
        END
     END
     IF ((old.IMPRECIBOITREC='N') AND (new.IMPRECIBOITREC='S') AND (new.RECIBOITREC IS NULL)) THEN
     BEGIN
        SELECT ISEQ FROM SPGERANUM(new.CODEMP,new.CODFILIAL,'RB') INTO new.RECIBOITREC;
     END
     /*AlteraÃ§Ã£o das datas de entrada e saida do estado de 'em cobranÃ§a'*/
     IF (new.RECEMCOB='S') THEN
     BEGIN
       new.DTINIEMCOB=CURRENT_DATE;
       new.DTFIMEMCOB=NULL;
     END
     ELSE IF (new.RECEMCOB='N') THEN
     BEGIN
       new.DTFIMEMCOB=CURRENT_DATE;
     END
     if(new.dtprevitrec is null) then
       new.dtprevitrec = new.dtvencitrec;

    --Buscando sequencial caso informaÃ§Ãµes de banco e carteira tenham sido alteradas...

       if ( (old.codbanco is null or old.codcartcob is null or old.numconta is null )
             or
            (new.codbanco != old.codbanco or new.codcartcob != old.codcartcob or new.numconta != old.numconta)
             and
            (new.codbanco is not null and new.codcartcob is not null and new.numconta is not null ) ) then

       begin

           seqnossonumero = 0;

          select seqnossonumero
          from fngeraseqnossonumero( new.codempbo, new.codfilialbo, new.codbanco, new.codempcb, new.codfilialcb, new.codcartcob, new.codempca, new.codfilialca, new.numconta)
          into :seqnossonumero;

          if (:seqnossonumero is not null and :seqnossonumero >0 ) then
          begin
             new.seqnossonumero = :seqnossonumero;
          end

       end
   end
end
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER FNLIBCREDTGBI;

SET TERM ^ ;

CREATE TRIGGER FNLIBCREDTGBI FOR FNLIBCRED
ACTIVE BEFORE INSERT POSITION 0 
AS
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(new.CODEMP,'SGUSUARIO') INTO new.CODFILIALUS;
  new.CODEMPUS = new.CODEMP;
  new.IDUSU=lower(USER);
END
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER FNPAGCHEQTGAU;

SET TERM ^ ;

CREATE TRIGGER FNPAGCHEQTGAU FOR FNPAGCHEQ
ACTIVE AFTER UPDATE POSITION 0 
as
    declare variable codfilialch smallint;
    declare variable contacheq char(10);
    declare variable codempcb int;
    declare variable codfilialcb smallint;
    declare variable contabaixa char(10);
    declare variable codemppn int;
    declare variable codfilialpn smallint;
    declare variable codplan char(13);
    declare variable tipocheq char(2);
    declare variable dtvenctocheq date;
    declare variable vlrcheq decimal(15,5);
    declare variable vlrapagitpag decimal(15,5);
    declare variable vlrbaixa decimal(15,5);
    declare variable dtcompitpag date;
    declare variable statusitpagar char(2);
    declare variable codempla int;
    declare variable codfilialla smallint;
    declare variable codlancatransf int;
    declare variable codemppnorig int;
    declare variable codfilialpnorig smallint;
    declare variable codplanorig char(13);
    declare variable codemppntransf int;
    declare variable codfilialpntransf smallint;
    declare variable codplantransf char(13);
    declare variable numcheq int;
    declare variable dtcompcheq date;
    declare variable vlrlanca decimal(15,5);
    declare variable icont int;
    declare variable obsitpag varchar(250);
    declare variable histblanca varchar(250);
    declare variable snumcheque varchar(15);
    declare variable sdoccompra varchar(50);
    declare variable nomefavcheq varchar(50);

begin

    -- Busca informações do cheque
    select ch.tipocheq, ch.contacheq, ch.dtvenctocheq, ch.vlrcheq, ch.numcheq, ch.dtcompcheq, ch.nomefavcheq
    from fncheque ch
    where ch.codemp=new.codempch and ch.codfilial=new.codfilialch and ch.seqcheq=new.seqcheq
    into :tipocheq, :contacheq, :dtvenctocheq, :vlrcheq, :numcheq, :dtcompcheq, :nomefavcheq;

    -- Baixa de título na emissão do cheque
    if(coalesce(old.baixa,'N')='N' and new.baixa='S') then
    begin

        -- Buscando filial da tabela de contas
        select icodfilial from sgretfilial(new.codemp,'FNCONTA') into :codfilialch;

        -- Se o cheque é de pagamento de fornecedores, deverá dar baixa no título para a conta de controle de cheques.
        if('PF' = :tipocheq) then
        begin

            -- Busca conta para a baixa
            select cv.codempcv, cv.codfilialcv, cv.numcontacv
            from fncontavinculada cv
            where cv.codemp=new.codempch and cv.codfilial=:codfilialch and cv.numconta=:contacheq
            into :codempcb, :codfilialcb, :contabaixa;

            -- Busca informações do planejamento
            select ip.vlrapagitpag, coalesce(ip.codemppn,p1.codemppc), coalesce(ip.codfilialpn,p1.codfilialpc),
            coalesce(ip.codplan,p1.codplanpc), coalesce(ip.obsitpag,'')
            from fnitpagar ip, fnpagar pg, sgprefere1 p1
            where ip.codemp=new.codemp and ip.codfilial=new.codfilial and ip.codpag=new.codpag and ip.nparcpag=new.nparcpag
            and p1.codemp=new.codemp and p1.codfilial=new.codfilial
            and pg.codemp=ip.codemp and pg.codfilial=ip.codfilial and pg.codpag=ip.codpag
            into :vlrapagitpag, :codemppn, :codfilialpn, :codplan, :obsitpag;

            -- Calculando valor e status da baixa de acordo com o valor do cheque.
            if(:vlrcheq >= :vlrapagitpag) then
            begin
                vlrbaixa = :vlrapagitpag;
                statusitpagar = 'PP';

            end
            else
            begin
                vlrbaixa = :vlrcheq;
                statusitpagar = 'PL';
            end


            if(:obsitpag='') then
            begin
                obsitpag = 'PGTO C/CHEQUE NRO:' || :numcheq;
            end
            else
            begin
                obsitpag = rtrim(obsitpag) || ' / ' || 'PGTO C/CHEQUE NRO:' || :numcheq;
            end

            -- Realizando a baixa
            update fnitpagar ip set
            ip.numconta=:contabaixa, ip.codempca=:codempcb, ip.codfilialca=:codfilialcb,
            ip.codplan=:codplan, ip.codemppn=:codemppn, ip.codfilialpn=:codfilialpn,
            ip.dtpagoitpag=:dtvenctocheq, ip.vlrpagoitpag=:vlrbaixa,
            ip.statusitpag=:statusitpagar, obsitpag=:obsitpag, multibaixa='N'
            where ip.codpag=new.codpag and ip.nparcpag=new.nparcpag and ip.codemp=new.codemp and ip.codfilial=new.codfilial;
        end
   end

    -- Transferencia de baixa na compensação do cheque
    if(coalesce(old.transfere,'N')='N' and new.transfere='S') then
    begin
        icont = 0;
        for
            select
            la.codemp, la.codfilial, la.codemppn, la.codfilialpn, la.codplan, la.vlrlanca, pg.dtcompitpag, coalesce(p.docpag,'') || '/' || coalesce(pg.nparcpag,'')
            from fnlanca la, fnitpagar pg, fnpagcheq pc, fnpagar p
            where pc.codemp=pg.codemp and pc.codfilial=pg.codfilial and pc.codpag=pg.codpag and pc.nparcpag=pg.nparcpag and
            la.codemppg=pg.codemp and la.codfilialpg=pg.codfilial and la.codpag=pg.codpag and la.nparcpag=pg.nparcpag
            and pc.codemp=new.codemp and pc.codfilial=new.codfilial and pc.codpag=new.codpag and pc.nparcpag=new.nparcpag
            and p.codemp=pg.codemp and p.codfilial=pg.codfilial and p.codpag=pg.codpag
            into :codempla, :codfilialla, :codemppnorig, :codfilialpnorig, :codplanorig, :vlrlanca, :dtcompitpag, :sdoccompra


        do
        begin

             icont = :icont + 1;

            -- Buscando código do novo lançamento
            select iseq from spgeranum(:codempla, :codfilialla, 'LA' ) into :codlancatransf;

            -- Buscando conta planejamento da compensação.
            select ct.codemppn, ct.codfilialpn, ct.codplan
            from fncontavinculada cv, fnconta ct, fnconta ctv
            where ct.codemp=cv.codemp and ct.codfilial=cv.codfilial and ct.numconta=cv.numconta
            and ctv.codemppn=:codemppnorig and ctv.codfilialpn=:codfilialpnorig and ctv.codplan=:codplanorig
            and cv.codempcv=ctv.codemp and cv.codfilialcv=ctv.codfilial and cv.numcontacv=ctv.numconta and cv.contacheque='S'
            into :codemppntransf, :codfilialpntransf, codplantransf;

            -- Montando histórico...
            snumcheque = rtrim(coalesce(cast(:numcheq as char(15)),'0'));
            histblanca = 'CH CP [' || :snumcheque || '] NF ' || :sdoccompra || ' ' || coalesce(:nomefavcheq,'');

            -- Inserir lançamento na primeira passada....

            if(:icont=1) then
            begin

                -- Inserindo lançamento de transferência...
                insert into fnlanca (
                    tipolanca, codemp, codfilial, codlanca,
                    codemppn, codfilialpn, codplan, dtcomplanca,
                    datalanca, doclanca, histblanca, transflanca, vlrlanca )
                values (
                      'A', :codempla, :codfilialla, :codlancatransf,
                  :codemppntransf, :codfilialpntransf, :codplantransf, :dtcompitpag, 
                  :dtcompcheq, :snumcheque, :histblanca, 'S', 0);

            end

            -- Inserindo sub-lançamento de transferência...

            insert into fnsublanca (
                codemp, codfilial, codlanca, codsublanca,
                codemppn, codfilialpn, codplan, dtcompsublanca,
                datasublanca, vlrsublanca, histsublanca)
            values (
                :codempla, :codfilialla, :codlancatransf, :icont,
                :codemppnorig, :codfilialpnorig, :codplanorig, :dtcompitpag,
                :dtcompcheq, :vlrlanca * -1 , :histblanca );

        end

    end
end
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER FNRECEBERTGAI;

SET TERM ^ ;

CREATE TRIGGER FNRECEBERTGAI FOR FNRECEBER
ACTIVE AFTER INSERT POSITION 0 
AS
  DECLARE VARIABLE NPARCREC INTEGER;
  DECLARE VARIABLE CODFILIALPP SMALLINT;
  DECLARE VARIABLE CODFILIALPN SMALLINT;
  DECLARE VARIABLE CODPLAN CHAR(13);
  DECLARE VARIABLE CODCC CHAR(19);
  DECLARE VARIABLE ANOCC SMALLINT;
  DECLARE VARIABLE CODFILIALCC SMALLINT;
  DECLARE VARIABLE CODFILIALIR SMALLINT;
  DECLARE VARIABLE CODFILIALCL SMALLINT;
  DECLARE VARIABLE ATIVOCLI CHAR(1);
  DECLARE VARIABLE NUMRESTR INTEGER;
  DECLARE VARIABLE CODFILIALCA SMALLINT;
  DECLARE VARIABLE CODEMPCA INTEGER;
  DECLARE VARIABLE NUMCONTA CHAR(10);
  declare variable docvenda integer;
  declare variable serievenda char(4);

BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(NEW.CODEMP,'VDCLIENTE') INTO CODFILIALCL;
  SELECT C.ATIVOCLI  FROM VDCLIENTE C WHERE C.CODEMP=NEW.CODEMP AND
     C.CODFILIAL=:CODFILIALCL AND C.CODCLI=NEW.CODCLI INTO :ATIVOCLI;
  IF (ATIVOCLI<>'S') THEN
  BEGIN
     EXCEPTION FNRECEBEREX01;
  END
  SELECT COUNT(*) FROM FNRESTRICAO R, FNTIPORESTR TR
    WHERE R.CODEMP=NEW.CODEMP AND R.CODFILIAL=:CODFILIALCL AND
      R.CODCLI=NEW.CODCLI AND R.SITRESTR IN ('I') AND
      TR.CODEMP=R.CODEMPTR AND TR.CODFILIAL=R.CODFILIALTR AND
      TR.CODTPRESTR=R.CODTPRESTR AND TR.BLOQTPRESTR='S'
      INTO :NUMRESTR;
  IF ( (NUMRESTR IS NOT NULL) AND (NUMRESTR>0) ) THEN
  BEGIN
     IF (NUMRESTR=1) THEN
     BEGIN
        EXCEPTION FNRECEBEREX02 'Cliente possui '||RTRIM(CAST(NUMRESTR AS CHAR(10)))||' restrição!';
     END
     ELSE
     BEGIN
        EXCEPTION FNRECEBEREX02 'Cliente possui '||RTRIM(CAST(NUMRESTR AS CHAR(10)))||' restrições!';
     END
  END
  SELECT ICODFILIAL FROM SGRETFILIAL(NEW.CODEMP,'FNPLANOPAG') INTO CODFILIALPP;
  SELECT ICODFILIAL FROM SGRETFILIAL(NEW.CODEMP,'FNPLANEJAMENTO') INTO CODFILIALPN;
  SELECT ICODFILIAL FROM SGRETFILIAL(NEW.CODEMP,'FNCENTROCUSTO') INTO CODFILIALCC;
  SELECT ICODFILIAL FROM SGRETFILIAL(NEW.CODEMP,'FNITRECEBER') INTO CODFILIALIR;

  if(new.codvenda is not null and new.numconta is null) then
  begin
    select codempca,codfilialca,numconta, vd.docvenda, vd.serie from vdvenda vd
    where codemp=new.codempva and codfilial=new.codfilialva and codvenda=new.codvenda and tipovenda=new.tipovenda
    into :codempca, :codfilialca, :numconta, :docvenda, :serievenda;
  end
  else
  begin
    codempca = new.codempca;
    codfilialca = new.codfilialca;
    numconta = new.numconta;
  end

  if (new.codvenda is not null and :docvenda is null) then
  begin
    select vd.docvenda, vd.serie from vdvenda vd
    where codemp=new.codempva and codfilial=new.codfilialva and codvenda=new.codvenda and tipovenda=new.tipovenda
    into :docvenda, :serievenda;
  end
  
  SELECT I FROM fngeraitrecebersp01('S',new.CODEMP,
    new.CODFILIAL, new.CODREC, new.CODEMPPG, new.CODFILIALPG, new.CODPLANOPAG,
    new.VLRREC, new.DATAREC, new.DTCOMPREC, new.FLAG, new.CODEMPBO, new.CODFILIALBO,
    new.CODBANCO, new.CODEMPTC, new.CODFILIALTC, new.CODTIPOCOB,
    new.CODEMPCB, new.CODFILIALCB, new.CODCARTCOB,
    new.VLRCOMIREC, new.OBSREC, :codempca, :codfilialca, :numconta,
    new.codemppn, new.codfilialpn, new.codplan, new.codempcc,  new.codfilialcc, new.anocc, new.codcc, new.vlrbasecomis
    ) INTO :NPARCREC;

/* Se a parcela do plano de pagamento tiver marcado para autobaixa, então é realizada a baixa automática. */
  FOR SELECT PP.NUMCONTA,PP.CODFILIALCA,PP.CODEMPCA, PP.CODPLAN,PP.CODFILIALPN,PP.CODCC,PP.ANOCC,PP.CODFILIALCC,PC.NROPARCPAG
      FROM FNPARCPAG PC, FNPLANOPAG PP
      WHERE
        PP.CODEMP=NEW.CODEMP AND PP.CODFILIAL=:CODFILIALPP AND PP.CODPLANOPAG=NEW.CODPLANOPAG AND
        PC.CODEMP=PP.CODEMP AND PC.CODFILIAL=PP.CODFILIAL AND PC.CODPLANOPAG=PP.CODPLANOPAG AND
        PC.AUTOBAIXAPARC='S'
      INTO NUMCONTA,CODFILIALCA,CODEMPCA, CODPLAN,CODFILIALPN,CODCC,ANOCC,CODFILIALCC,NPARCREC
  DO
  BEGIN
    UPDATE FNITRECEBER SET
      NUMCONTA=:NUMCONTA,
      CODEMPCA=:CODEMPCA,
      CODFILIALCA=:CODFILIALCA,
      NUMCONTA=:NUMCONTA,
      CODPLAN=:CODPLAN,
      CODEMPPN=NEW.CODEMP,
      CODFILIALPN=:CODFILIALPN,
      ANOCC=:ANOCC,
      CODCC=:CODCC,
      CODEMPCC=NEW.CODEMP,
      CODFILIALCC=:CODFILIALCC,
      DOCLANCAITREC= :docvenda || '/' || :nparcrec,
--      DOCLANCAITREC='AUTO',
      DTPAGOITREC=NEW.DATAREC,
      VLRPAGOITREC=VLRPARCITREC - coalesce(vlrdescitrec,0),
--      VLRDESCITREC=0,
      VLRJUROSITREC=0,
      OBSITREC='BAIXA AUTOMÁTICA' || ' REF. DOC: ' || :serievenda || '-' || :docvenda,
      STATUSITREC='RP'
      WHERE CODREC=NEW.CODREC AND CODEMP=NEW.CODEMP AND CODFILIAL=:CODFILIALIR AND
      NPARCITREC=:NPARCREC;
  END
END
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER LFITCOMPRATGAU;

SET TERM ^ ;

CREATE TRIGGER LFITCOMPRATGAU FOR LFITCOMPRA
ACTIVE AFTER UPDATE POSITION 0 
as
    declare variable cstatus char (2);
    declare variable nvlrbasepis numeric(15, 5);
    declare variable nvlrbasecofins numeric(15, 5);
    declare variable nvlrpis numeric(15, 5);
    declare variable nvlrcofins numeric(15, 5);

    declare variable ovlrbasepis numeric(15, 5);
    declare variable ovlrbasecofins numeric(15, 5);
    declare variable ovlrpis numeric(15, 5);
    declare variable ovlrcofins numeric(15, 5);

    declare variable ovlrbaseii numeric(15, 5);
    declare variable ovlrii numeric(15, 5);

    declare variable vlricmsdiferido numeric(15, 5);
    declare variable vlricmsdevido numeric(15, 5);
    declare variable vlricmscredpresum numeric(15, 5);

begin
    -- Inicialização de variáveis (new)
    if (new.vlrbasepis is null) then nvlrbasepis = 0; else nvlrbasepis = new.vlrbasepis;
    if (new.vlrbasecofins is null) then nvlrbasecofins = 0; else nvlrbasecofins = new.vlrbasepis;
    if (new.vlrpis is null) then nvlrpis = 0; else nvlrpis = new.vlrpis;
    if (new.vlrcofins is null) then nvlrcofins = 0; else nvlrcofins = new.vlrcofins;

    -- Inicialização de variáveis (old)
    if (old.vlrbasepis is null) then ovlrbasepis = 0; else ovlrbasepis = old.vlrbasepis;
    if (old.vlrbasecofins is null) then ovlrbasecofins = 0; else ovlrbasecofins = old.vlrbasepis;
    if (old.vlrpis is null) then ovlrpis = 0; else ovlrpis = old.vlrpis;
    if (old.vlrcofins is null) then ovlrcofins = 0; else ovlrcofins = old.vlrcofins;
    if (old.vlrbaseii is null) then ovlrbaseii = 0; else ovlrbaseii = old.vlrbaseii;
    if (old.vlrii is null) then ovlrii = 0; else ovlrii = old.vlrii;

    if (old.vlricmsdiferido is null) then vlricmsdiferido = 0; else vlricmsdiferido = old.vlricmsdiferido;
    if (old.vlricmsdevido is null) then vlricmsdevido = 0; else vlricmsdevido = old.vlricmsdevido;
    if (old.vlricmscredpresum is null) then vlricmscredpresum = 0; else vlricmscredpresum = old.vlricmscredpresum;


    if ( not ( (new.emmanut='S') or ( (old.emmanut='S') and (old.emmanut is not null) ) ) ) then
    begin
        select cp.statuscompra from cpcompra cp
        where cp.codcompra = new.codcompra and cp.codemp=new.codemp and cp.codfilial = new.codfilial
        into :cstatus;

        if (substr(:cstatus,1,1)!='X') then
        begin
            update cpcompra cp set
            cp.vlrbasepiscompra = cp.vlrbasepiscompra - :ovlrbasepis + :nvlrbasepis,
            cp.vlrpiscompra = vlrpiscompra - :ovlrpis + :nvlrpis,
            cp.vlrbasecofinscompra = vlrbasecofinscompra - :ovlrbasecofins + :nvlrbasecofins,
            cp.vlrcofinscompra= vlrcofinscompra - :ovlrcofins + :nvlrcofins,
            cp.vlrbaseiicompra= vlrbaseiicompra - :ovlrbaseii + new.vlrbaseii,
            cp.vlriicompra= vlriicompra - :ovlrii + new.vlrii,
            cp.vlricmsdiferido= vlricmsdiferido - :vlricmsdiferido + new.vlricmsdiferido,
            cp.vlricmsdevido= vlricmsdevido - :vlricmsdevido + new.vlricmsdevido,
            cp.vlricmscredpresum = vlricmscredpresum - :vlricmscredpresum + new.vlricmscredpresum
            where codcompra=new.codcompra and codemp=new.codemp and codfilial=new.codfilial;
        end
    end
end
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER LFITVENDATGAU;

SET TERM ^ ;

CREATE TRIGGER LFITVENDATGAU FOR LFITVENDA
ACTIVE AFTER UPDATE POSITION 0 
as
    declare variable cstatus char (2);
    declare variable nvlrbasepis numeric(15, 5);
    declare variable nvlrbasecofins numeric(15, 5);
    declare variable nvlrpis numeric(15, 5);
    declare variable nvlrcofins numeric(15, 5);

    declare variable ovlrbasepis numeric(15, 5);
    declare variable ovlrbasecofins numeric(15, 5);
    declare variable ovlrpis numeric(15, 5);
    declare variable ovlrcofins numeric(15, 5);

begin
    -- Inicialização de variáveis (new)
    if (new.vlrbasepis is null) then nvlrbasepis = 0; else nvlrbasepis = new.vlrbasepis;
    if (new.vlrbasecofins is null) then nvlrbasecofins = 0; else nvlrbasecofins = new.vlrbasepis;
    if (new.vlrpis is null) then nvlrpis = 0; else nvlrpis = new.vlrpis;
    if (new.vlrcofins is null) then nvlrcofins = 0; else nvlrcofins = new.vlrcofins;

    -- Inicialização de variáveis (old)
    if (old.vlrbasepis is null) then ovlrbasepis = 0; else ovlrbasepis = old.vlrbasepis;
    if (old.vlrbasecofins is null) then ovlrbasecofins = 0; else ovlrbasecofins = old.vlrbasepis;
    if (old.vlrpis is null) then ovlrpis = 0; else ovlrpis = old.vlrpis;
    if (old.vlrcofins is null) then ovlrcofins = 0; else ovlrcofins = old.vlrcofins;

    if ( not ( (new.emmanut='S') or ( (old.emmanut='S') and (old.emmanut is not null) ) ) ) then
    begin
        select vd.statusvenda from vdvenda vd
        where vd.codvenda = new.codvenda and VD.tipovenda = new.tipovenda
        and vd.codemp=new.codemp and vd.codfilial = new.codfilial
        into :cstatus;

        if (substr(:cstatus,1,1)!='C') then
        begin
            update vdvenda vd set
            vd.vlrbasepisvenda = vd.vlrbasepisvenda - :ovlrbasepis + :nvlrbasepis,
            vd.vlrpisvenda = vlrpisvenda - :ovlrpis + :nvlrpis,
            vd.vlrbasecofinsvenda = vlrbasecofinsvenda - :ovlrbasecofins + :nvlrbasecofins,
            vd.vlrcofinsvenda= vlrcofinsvenda - :ovlrcofins + :nvlrcofins
            where codvenda=new.codvenda and tipovenda=new.tipovenda and codemp=new.codemp and codfilial=new.codfilial;
        end
    end

end
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER TKCONTATOTGBI;

SET TERM ^ ;

CREATE TRIGGER TKCONTATOTGBI FOR TKCONTATO
ACTIVE BEFORE INSERT POSITION 0 
AS
    declare variable nomemuniccto CHAR(30);
begin

    /*Atualização do campo cidade e estado (temporário para retro-compatibilidade)*/

    if(new.codmunic is not null) then
    begin
        select substr(mun.nomemunic,1,30) from sgmunicipio mun
            where mun.codpais=new.codpais and mun.siglauf=new.siglauf and mun.codmunic=new.codmunic
                into :nomemuniccto;
        if (nomemuniccto is not null) then new.cidcto = nomemuniccto;
    end

    if(new.siglauf is not null) then
    begin
        new.ufcto=new.siglauf;
    end

    /* Fim da atualização do campo cidade e estado*/

end
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER TKCONTATOTGBU;

SET TERM ^ ;

CREATE TRIGGER TKCONTATOTGBU FOR TKCONTATO
ACTIVE BEFORE UPDATE POSITION 0 
as
  declare variable nomemuniccto CHAR(30);
begin
  new.DTALT=cast('now' AS DATE);
  new.IDUSUALT=USER;
  new.HALT = cast('now' AS TIME);

   /*Atualização do campo cidade e estado (temporário para retro-compatibilidade)*/

    if(old.codmunic != new.codmunic) then
    begin
        select substr(mun.nomemunic,1,30) from sgmunicipio mun
            where mun.codpais=new.codpais and mun.siglauf=new.siglauf and mun.codmunic=new.codmunic
                into :nomemuniccto;
        if (nomemuniccto is not null) then new.cidcto = nomemuniccto;
    end

    if(new.siglauf is not null) then
    begin
        new.ufcto=new.siglauf;
    end

    /* Fim da atualização do campo cidade */

end
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER VDCLIENTETGBI;

SET TERM ^ ;

CREATE TRIGGER VDCLIENTETGBI FOR VDCLIENTE
ACTIVE BEFORE INSERT POSITION 0 
as
    declare variable nomemuniccli CHAR(30);
    declare variable nomemunicent CHAR(30);
    declare variable nomemuniccob CHAR(30);
    declare variable filialpref smallint;
    declare variable geracodunif CHAR(1);
    declare variable codunifcod integer;
begin

    if (new.codpesq is null) then
    begin
        new.codemppq = new.codemp;
        new.codfilialpq = new.codfilial;
        new.codpesq = new.codcli;
    end

    -- Atualização do campo cidade e estado (temporário para retro-compatibilidade)

    if(new.codmunic is not null) then
    begin
        select substr(mun.nomemunic,1,30) from sgmunicipio mun
            where mun.codpais=new.codpais and mun.siglauf=new.siglauf and mun.codmunic=new.codmunic
                into :nomemuniccli;
        if (nomemuniccli is not null) then new.cidcli = nomemuniccli;
    end

    if(new.siglauf is not null) then
    begin
        new.ufcli=new.siglauf;
    end

    if(new.codmunicent is not null) then
    begin
        select substr(mun.nomemunic,1,30) from sgmunicipio mun
            where mun.codpais=new.codpaisent and mun.siglauf=new.siglaufent and mun.codmunic=new.codmunicent
                into :nomemunicent;

        if (nomemunicent is not null) then new.cident = nomemunicent;
    end

    if(new.siglaufent is not null) then
    begin
        new.ufent=new.siglaufent;
    end

    if(new.codmuniccob is not null) then
    begin
        select substr(mun.nomemunic,1,30) from sgmunicipio mun
            where mun.codpais=new.codpaiscob and mun.siglauf=new.siglaufcob and mun.codmunic=new.codmuniccob
                into :nomemuniccob;

        if (nomemuniccob is not null) then new.cidcob = nomemuniccob;
    end

    if(new.siglaufcob is not null) then
    begin
        new.ufcob=new.siglaufcob;
    end

    -- Fim da atualização do campo cidade e estado

    -- Geração de código unificador (SGUNIFCOD)

    select icodfilial from sgretfilial(new.codemp,'SGPREFERE1') into filialpref;
    select geracodunif from sgprefere1 where codemp=new.codemp and codfilial=:filialpref into :geracodunif;
    
    if(:geracodunif = 'S') then
    begin

        select (coalesce(max(codunifcod),0)+1) from sgunifcod where codemp=new.codemp and codfilial=new.codfilial
        into :codunifcod;

        insert into sgunifcod (codemp, codfilial, codunifcod, tipounifcod, descunifcod)
        values (new.codemp, new.codfilial, :codunifcod, 'C', new.razcli);
        new.codempuc=new.codemp;
        new.codfilialuc=new.codfilial;
        new.codunifcod=:codunifcod;

    end
end
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER VDCLIENTETGBU;

SET TERM ^ ;

CREATE TRIGGER VDCLIENTETGBU FOR VDCLIENTE
ACTIVE BEFORE UPDATE POSITION 0 
as
    declare variable nomemuniccli CHAR(30);
    declare variable nomemunicent CHAR(30);
    declare variable nomemuniccob CHAR(30);
    declare variable filialpref smallint;
    declare variable geracodunif char(1);
    declare variable codunifcod integer;

begin
    new.DTALT=cast('now' AS DATE);
    new.IDUSUALT=user;
    new.HALT = cast('now' AS TIME);

    if (new.codpesq is null) then
    begin
        new.codemppq = new.codemp;
        new.codfilialpq = new.codfilial;
        new.codpesq = new.codcli;
    end

    /*Atualização do campo cidade e estado (temporário para retro-compatibilidade)*/

    if ( ((old.codmunic is null) and (new.codmunic is not null)) or
         (old.codmunic<>new.codmunic) ) then
    begin
        select substr(mun.nomemunic,1,30) from sgmunicipio mun
            where mun.codpais=new.codpais and mun.siglauf=new.siglauf and mun.codmunic=new.codmunic
                into :nomemuniccli;
        if (nomemuniccli is not null) then new.cidcli = nomemuniccli;
    end

    if(new.siglauf is not null) then
    begin
        new.ufcli=new.siglauf;
    end

    if(old.codmunicent != new.codmunicent) then
    begin
        select substr(mun.nomemunic,1,30) from sgmunicipio mun
            where mun.codpais=new.codpaisent and mun.siglauf=new.siglaufent and mun.codmunic=new.codmunicent
                into :nomemunicent;

        if (nomemunicent is not null) then new.cident = nomemunicent;
    end

    if(new.siglaufent is not null) then
    begin
        new.ufent=new.siglaufent;
    end

    if(old.codmuniccob != new.codmuniccob) then
    begin
        select substr(mun.nomemunic,1,30) from sgmunicipio mun
            where mun.codpais=new.codpaiscob and mun.siglauf=new.siglaufcob and mun.codmunic=new.codmuniccob
                into :nomemuniccob;

        if (nomemuniccob is not null) then new.cidcob = nomemuniccob;
    end

    if(new.siglaufcob is not null) then
    begin
        new.ufcob=new.siglaufcob;
    end

    /* Fim da atualização do campo cidade */

    -- Geração de código unificador (SGUNIFCOD)

    if (new.codunifcod is null) then
    begin
      select icodfilial from sgretfilial(new.codemp,'SGPREFERE1') into filialpref;
      select geracodunif from sgprefere1 where codemp=new.codemp and codfilial=:filialpref into :geracodunif;
    
      if( :geracodunif = 'S' ) then
      begin

         select (coalesce(max(codunifcod),0)+1) from sgunifcod where codemp=new.codemp and codfilial=new.codfilial
         into :codunifcod;

         insert into sgunifcod (codemp, codfilial, codunifcod, tipounifcod, descunifcod)
         values (new.codemp, new.codfilial, :codunifcod, 'C', new.razcli);

         new.codempuc=new.codemp;
         new.codfilialuc=new.codfilial;
         new.codunifcod=:codunifcod;

       end
    end

end
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER VDITVENDATGAU;

SET TERM ^ ;

CREATE TRIGGER VDITVENDATGAU FOR VDITVENDA
ACTIVE AFTER UPDATE POSITION 0 
AS
  DECLARE VARIABLE DDTVENDA DATE;
  DECLARE VARIABLE CFLAG CHAR(1);
  DECLARE VARIABLE IDOCVENDA INTEGER;
  DECLARE VARIABLE ICODEMPTM INTEGER;
  DECLARE VARIABLE SCODFILIALTM SMALLINT;
  DECLARE VARIABLE ICODTIPOMOV INTEGER;
  DECLARE VARIABLE CSTATUS CHAR(2);
  DECLARE VARIABLE CTIPOPROD varCHAR(2);
  DECLARE VARIABLE NPRECO NUMERIC(15, 5);
  DECLARE VARIABLE visualizalucr CHAR(1);
  DECLARE VARIABLE custopeps NUMERIC(15, 5);
  DECLARE VARIABLE custompm NUMERIC(15, 5);
  DECLARE VARIABLE custouc NUMERIC(15, 5);

BEGIN
  
  select visualizalucr from sgprefere1 where codemp=new.codemp and codfilial = new.codfilial
    into :visualizalucr;

  IF ( not ( (new.EMMANUT='S') or ( (old.EMMANUT='S') and (old.EMMANUT IS NOT NULL) ) ) ) THEN
  BEGIN
      SELECT VD.DTEMITVENDA,VD.DOCVENDA,VD.STATUSVENDA,VD.FLAG,
             VD.CODEMPTM, VD.CODFILIALTM, VD.CODTIPOMOV
        FROM VDVENDA VD
        WHERE VD.CODVENDA = new.CODVENDA AND VD.TIPOVENDA = new.TIPOVENDA
            AND VD.CODEMP=new.CODEMP AND VD.CODFILIAL = new.CODFILIAL
        INTO :DDTVENDA, :IDOCVENDA, :CSTATUS, :CFLAG, :ICODEMPTM,
          :SCODFILIALTM, :ICODTIPOMOV;
      SELECT TIPOPROD FROM EQPRODUTO WHERE CODPROD=old.CODPROD
             AND CODEMP=old.CODEMPPD AND CODFILIAL = old.CODFILIALPD
         INTO CTIPOPROD;
      if (substr(:CSTATUS,1,1)!='C') then
      BEGIN
        UPDATE VDVENDA SET VLRDESCITVENDA = VLRDESCITVENDA -old.VLRDESCITVENDA + new.VLRDESCITVENDA,
               VLRPRODVENDA = VLRPRODVENDA - old.VLRPRODITVENDA + new.VLRPRODITVENDA,
               VLRBASEICMSVENDA = VLRBASEICMSVENDA - old.VLRBASEICMSITVENDA + new.VLRBASEICMSITVENDA,
               VLRICMSVENDA = VLRICMSVENDA -old.VLRICMSITVENDA + new.VLRICMSITVENDA,
               VLRISENTASVENDA = VLRISENTASVENDA - old.VLRISENTASITVENDA + new.VLRISENTASITVENDA,
               VLROUTRASVENDA = VLROUTRASVENDA - old.VLROUTRASITVENDA + new.VLROUTRASITVENDA,
               VLRBASEIPIVENDA = VLRBASEIPIVENDA - old.VLRBASEIPIITVENDA + new.VLRBASEIPIITVENDA,
               VLRIPIVENDA = VLRIPIVENDA - old.VLRIPIITVENDA + new.VLRIPIITVENDA,
               VLRLIQVENDA = VLRLIQVENDA - old.VLRLIQITVENDA + new.VLRLIQITVENDA,
               VLRCOMISVENDA = VLRCOMISVENDA - old.VLRCOMISITVENDA + new.VLRCOMISITVENDA,
               VLRBASEISSVENDA = VLRBASEISSVENDA - old.VLRBASEISSITVENDA + new.VLRBASEISSITVENDA,
               VLRISSVENDA = VLRISSVENDA - old.VLRISSITVENDA + new.VLRISSITVENDA,
               VLRBASEICMSSTVENDA = VLRBASEICMSSTVENDA - OLD.vlrbaseicmsstitvenda + NEW.vlrbaseicmsstitvenda,
               VLRICMSSTVENDA = VLRICMSSTVENDA - OLD.vlricmsstitvenda + NEW.vlricmsstitvenda,
               vlrbasecomis = vlrbasecomis - old.vlrbasecomisitvenda + new.vlrbasecomisitvenda
               WHERE CODVENDA=new.CODVENDA AND TIPOVENDA=new.TIPOVENDA
               AND CODEMP=new.CODEMP AND CODFILIAL=new.CODFILIAL;
        
        IF (SUBSTR(CSTATUS,1,1) = 'P') THEN
          CSTATUS = 'PV';
        ELSE IF (SUBSTR(CSTATUS,1,1) = 'V') THEN
          CSTATUS = 'VD';
      END
      IF (new.QTDITVENDA = 0) THEN
         NPRECO = new.PRECOITVENDA;
      ELSE
         NPRECO = new.VLRLIQITVENDA/new.QTDITVENDA;
      EXECUTE PROCEDURE EQMOVPRODIUDSP('U',new.CODEMPPD, new.CODFILIALPD, new.CODPROD,
        new.CODEMPLE, new.CODFILIALLE, new.CODLOTE, :ICODEMPTM,
        :SCODFILIALTM, :ICODTIPOMOV, null, null, null ,null, null,
        null, null, new.CODEMP, new.CODFILIAL, new.TIPOVENDA, new.CODVENDA,
        new.CODITVENDA, null, null, null, null,null,null,null, null, null,
        new.CODEMPNT, new.CODFILIALNT,
        new.CODNAT, :DDTVENDA, :IDOCVENDA, :CFLAG, new.QTDITVENDA, :NPRECO,
        new.CODEMPAX, new.CODFILIALAX, new.CODALMOX, null);


       if( visualizalucr = 'S' ) then
       begin

            -- Busca do custo da ultima compra;
            select custounit from eqcustoprodsp(new.codemppd, new.codfilialpd, new.codprod,
                new.dtins,'U',new.codempax, new.codfilialax, new.codalmox,'N')
            into :custouc;

            -- Busca do custo médio (MPM)
            select custounit from eqcustoprodsp(new.codemppd, new.codfilialpd, new.codprod,
                new.dtins,'M',new.codempax, new.codfilialax, new.codalmox,'N')
            into :custompm;

            -- Busca do custo peps
            select custounit from eqcustoprodsp(new.codemppd, new.codfilialpd, new.codprod,
                new.dtins,'P',new.codempax, new.codfilialax, new.codalmox,'N')
            into :custopeps;

            -- Atualizando registro na tabela de custos de item de venda

            update vditcustovenda icv set vlrprecoultcp=:custouc, vlrcustompm=:custompm, vlrcustopeps=:custopeps
                where icv.codemp=new.codemp and icv.codfilial=new.codfilial and icv.codvenda=new.codvenda
                and icv.tipovenda=new.tipovenda and icv.coditvenda=new.coditvenda;

       end

        -- Executa procedure para atualização de tabela de vinculo para numeros de serie
        execute procedure vditvendaseriesp('U', old.codemp, old.codfilial, old.codvenda, old.tipovenda, old.coditvenda, old.codemppd, old.codfilialpd, old.codprod, new.numserietmp, new.qtditvenda);


        -- Atualizando registros na tabela de informações fiscais complementares (LFITVENDA)
        if(new.coditfisc is not null) then
        begin
            execute procedure lfgeralfitvendasp(
            new.codemp, new.codfilial, new.codvenda, new.tipovenda, new.coditvenda);
        end

        -- Atualizando informações referentes à devolução
        execute procedure cpgeradevolucaosp (
        new.codempcp,new.codfilialcp, new.codcompra, new.coditcompra, new.codemp, new.codfilial,
        new.codvenda, new.coditvenda, new.tipovenda, new.qtditvenda);


   END
END
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER VDTRANSPTGBI;

SET TERM ^ ;

CREATE TRIGGER VDTRANSPTGBI FOR VDTRANSP
ACTIVE BEFORE INSERT POSITION 0 
AS
    declare variable nomemunictran CHAR(30);
    declare variable geracodunif char(1);
    declare variable filialpref smallint;
    declare variable codunifcod integer;
begin

    /*Atualização do campo cidade e estado (temporário para retro-compatibilidade)*/

    if(new.codmunic is not null) then
    begin
        select substr(mun.nomemunic,1,30) from sgmunicipio mun
            where mun.codpais=new.codpais and mun.siglauf=new.siglauf and mun.codmunic=new.codmunic
                into :nomemunictran;
        if (nomemunictran is not null) then new.cidtran = nomemunictran;
    end

    if(new.siglauf is not null) then
    begin
        new.uftran=new.siglauf;
    end

    /* Fim da atualização do campo cidade e estado*/

    -- Geração de código unificador (SGUNIFCOD)

    select icodfilial from sgretfilial(new.codemp,'SGPREFERE1') into filialpref;
    select geracodunif from sgprefere1 where codemp=new.codemp and codfilial=:filialpref into :geracodunif;
    
    if(:geracodunif = 'S') then
    begin

        select (coalesce(max(codunifcod),0)+1) from sgunifcod where codemp=new.codemp and codfilial=new.codfilial
        into :codunifcod;

        insert into sgunifcod (codemp, codfilial, codunifcod, tipounifcod, descunifcod)
        values (new.codemp, new.codfilial, :codunifcod, 'T', new.raztran);
        new.codempuc=new.codemp;
        new.codfilialuc=new.codfilial;
        new.codunifcod=:codunifcod;

    end

end
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER VDTRANSPTGBU;

SET TERM ^ ;

CREATE TRIGGER VDTRANSPTGBU FOR VDTRANSP
ACTIVE BEFORE UPDATE POSITION 0 
as
    declare variable nomemunictran CHAR(30);
begin
    new.DTALT=cast('now' AS DATE);
    new.IDUSUALT=USER;
    new.HALT = cast('now' AS TIME);

    /*Atualização do campo cidade e estado (temporário para retro-compatibilidade)*/

    if(old.codmunic != new.codmunic) then
    begin
        select substr(mun.nomemunic,1,30) from sgmunicipio mun
            where mun.codpais=new.codpais and mun.siglauf=new.siglauf and mun.codmunic=new.codmunic
                into :nomemunictran;
        if (nomemunictran is not null) then new.cidtran = nomemunictran;
    end

    if(new.siglauf is not null) then
    begin
        new.uftran=new.siglauf;
    end

    /* Fim da atualização do campo cidade */


end
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER VDVENDATGAU;

SET TERM ^ ;

CREATE TRIGGER VDVENDATGAU FOR VDVENDA
ACTIVE AFTER UPDATE POSITION 0 
as
    declare variable icodrec integer;
    declare variable scodfilialrc smallint;
    declare variable icoditvenda integer;
    declare variable percred numeric(15,5);
    declare variable percit numeric(15,5);
    declare variable percicmsitvenda numeric(15,5);
    declare variable percipiitvenda numeric(15,5);
    declare variable tipofisc char(2);
    declare variable vlrdescitvenda numeric(15, 5);
    declare variable vlrbaseipiitvenda numeric(15, 5);
    declare variable vlrbaseicmsitvenda numeric(15, 5);
    declare variable vlrbaseicmsfreteitvenda numeric(15, 5);
    declare variable vlripiitvenda numeric(15, 5);
    declare variable vlrproditvenda numeric(15, 5);
    declare variable vlrliqitvenda numeric(15, 5);
    declare variable vlricmsitvenda numeric(15, 5);
    declare variable vlricmsfreteitvenda numeric(15, 5);
    declare variable tipomov char(2);
    declare variable vlrmfintipomov char(1);
    declare variable vlrtmp numeric(15, 5);
    declare variable qtditvenda numeric(15,5);
    declare variable nvlrparcrec numeric(15, 5);
    declare variable nvlrcomirec numeric(15, 5);
    declare variable percitfrete numeric(15, 5);
    declare variable vlritfrete numeric(15, 5);
    declare variable snroparcrec smallint;
    declare variable codempif integer;
    declare variable codfilialif smallint;
    declare variable codfisc char(13);
    declare variable coditfisc integer;
    declare variable dtrec date;
    declare variable gerarecemis char(1);
    declare variable tpredicms char(1);
    declare variable redbasefrete char(1);
    declare variable vlrretensaoiss numeric(15, 5);

    begin

        if ( not ( (new.emmanut='S') or ( (old.emmanut='S') and (old.emmanut is not null) )) ) then
        begin

        -- buscando preferências
        select gerarecemis from sgprefere1 p1 where p1.codemp=new.codemp and p1.codfilial=new.codfilial
        into :gerarecemis;

        -- Se foi dado desconto ou alterado o valor do frete da venda

        if ((not new.vlrdescvenda = old.vlrdescvenda) or (not new.vlrfretevenda = old.vlrfretevenda) ) then
        begin

            -- distribuindo o desconto e frete csocial e ir:

            for select coditvenda,percicmsitvenda,vlrdescitvenda,
                vlrliqitvenda,vlrproditvenda,qtditvenda,codempif,codfilialif,codfisc,coditfisc
                from vditvenda
                where codemp=new.codemp and codfilial=new.codfilial and codvenda=new.codvenda and tipovenda=new.tipovenda
                into icoditvenda,percicmsitvenda,
                vlrdescitvenda,vlrliqitvenda,vlrproditvenda,qtditvenda,codempif,codfilialif,codfisc,coditfisc
            do
            begin

                -- distribuição do desconto
                percit = 0;
                if (new.vlrprodvenda > 0 and not new.vlrdescitvenda > 0 and new.vlrdescvenda > 0) then
                begin
                    percit = (100*vlrproditvenda) / new.vlrprodvenda;
                    vlrdescitvenda = (new.vlrdescvenda  * percit) / 100;
                end

                -- distribuição do frete
                if ( new.vlrfretevenda > 0 and ( not new.vlrfretevenda = old.vlrfretevenda) ) then
                begin
                    percitfrete = :vlrproditvenda / new.vlrprodvenda ;
                    vlritfrete =  :percitfrete * new.vlrfretevenda ;
                end

                -- busca informações fiscais.:
                select first 1 i.redfisc, i.aliqipifisc, i.tipofisc, i.tpredicmsfisc, i.redbasefrete
                from lfitclfiscal i
                where i.codemp=:codempif and i.codfilial=:codfilialif and i.codfisc=:codfisc and i.coditfisc=:coditfisc
                into percred, percipiitvenda, tipofisc, tpredicms, redbasefrete;

                if (percred is null) then
                    percred = 0;

                if (percipiitvenda is null) then
                    percipiitvenda = 0;

                if (percicmsitvenda is null) then
                    percicmsitvenda = 0;

                vlrliqitvenda = vlrproditvenda - vlrdescitvenda;
                vlrbaseipiitvenda = 0;
                vlrbaseicmsitvenda = 0;
                vlricmsitvenda = 0;
                vlripiitvenda = 0;

                if (qtditvenda > 0) then
                begin
                    vlrtmp = vlrliqitvenda/qtditvenda;
                    vlrdescitvenda = vlrproditvenda - (vlrtmp*qtditvenda);
                    vlrliqitvenda = vlrproditvenda - vlrdescitvenda;
                end

                if ( tipofisc = 'II' ) then -- Isento de ICMS
                begin
                    percicmsitvenda = 0;
                    vlricmsitvenda = 0;
                    vlrbaseicmsfreteitvenda = 0;
                    vlrbaseicmsitvenda = 0;
                    percipiitvenda = 0;
                    vlripiitvenda = 0;
                    vlrbaseipiitvenda = 0;
                end
                else if ( tipofisc = 'FF' ) then -- Substituição tributária do icms
                begin
                    vlrbaseicmsitvenda = vlrliqitvenda - (vlrproditvenda*(percred/100));
                    vlricmsitvenda = vlrbaseicmsitvenda*(percicmsitvenda/100);
                    vlrbaseipiitvenda = vlrliqitvenda;
                    vlripiitvenda = vlrbaseipiitvenda*(percipiitvenda/100);
                end
                else if ( tipofisc = 'NN') then -- Não insidência do icms
                begin
                    percicmsitvenda = 0;
                    vlricmsitvenda = 0;
                    vlrbaseicmsitvenda = 0;
                    vlrbaseicmsfreteitvenda = 0;
                    percipiitvenda = 0;
                    vlripiitvenda = 0;
                    vlrbaseipiitvenda = 0;
                end
                else if ( tipofisc = 'TT') then -- Tributado integralmente o icms
                begin

                    vlrbaseicmsitvenda = vlrliqitvenda;
                    vlrbaseicmsfreteitvenda = vlritfrete;

                    if(percred>0) then
                    begin
                        if(:tpredicms='B') then
                        begin
                            --Se deve reduzir a base do icms do frete...

                            if(:redbasefrete='S' and vlritfrete>0) then
                            begin
                                vlrbaseicmsfreteitvenda = vlritfrete - ( vlritfrete *(percred/100) );
                                vlricmsfreteitvenda = vlrbaseicmsfreteitvenda*(percicmsitvenda/100);
                            end
                            else
                            begin
                                vlrbaseicmsfreteitvenda = vlritfrete;
                            end

                            --vlrbaseicmsitvenda = vlrliqitvenda - (vlrproditvenda*(percred/100));
                            -- Revisao 12/07/2010 - Robson Sanchez
                            -- Foram separados os calculos de ICMS do frete e da venda.
                            -- Em virtude disso a formacao da base de calculo nao pode ser sobre o valor liquido,
                            -- pois o valor liquido pode conter valor adicional de frete, causando duplicacao de impostos.

                            vlrbaseicmsitvenda = (vlrproditvenda + vlripiitvenda - vlrdescitvenda)*(1-(percred/100));

                            vlricmsitvenda = vlrbaseicmsitvenda*(percicmsitvenda/100);

                        end
                        else if(:tpredicms='V') then
                        begin
                            vlricmsitvenda = ( vlrbaseicmsitvenda*(percicmsitvenda/100) );
                            vlricmsitvenda = vlricmsitvenda - ( vlricmsitvenda * (percred/100) );

                            vlricmsfreteitvenda = vlrbaseicmsfreteitvenda*(percicmsitvenda/100);
                            vlricmsfreteitvenda = vlricmsfreteitvenda - ( vlricmsfreteitvenda * (percred/100) );

                        end
                    end
                    else
                    begin
                        vlricmsitvenda = vlrbaseicmsitvenda*(percicmsitvenda/100);
                        vlricmsfreteitvenda = vlrbaseicmsfreteitvenda*(percicmsitvenda/100);
                    end

                    vlrbaseipiitvenda = vlrliqitvenda;
                    vlripiitvenda = vlrbaseipiitvenda*(percipiitvenda/100);

                end

                -- atualizando tabela de ítens
                update vditvenda set
                vlrbaseicmsitvenda = :vlrbaseicmsitvenda, vlrbaseipiitvenda = :vlrbaseipiitvenda,
                vlricmsitvenda = :vlricmsitvenda, vlripiitvenda = :vlripiitvenda,
                vlrdescitvenda = :vlrdescitvenda, vlrliqitvenda = :vlrliqitvenda,
                vlrfreteitvenda = :vlritfrete
                where
                codemp=new.codemp and codfilial=new.codfilial and codvenda=new.codvenda and
                coditvenda=:icoditvenda and tipovenda=new.tipovenda;

                -- Atualizando tabela de tributos referente ao frete
                if(new.vlrfretevenda != old.vlrfretevenda) then
                begin
                    update lfitvenda set
                    vlrbaseicmsfreteitvenda = :vlrbaseicmsfreteitvenda,
                    vlricmsfreteitvenda = :vlricmsfreteitvenda
                    where
                    codemp=new.codemp and codfilial=new.codfilial and codvenda=new.codvenda and
                    coditvenda=:icoditvenda and tipovenda=new.tipovenda;
                end

            end
        end


    -- Busca informações do tipo de movimento da venda
    select tipomov, vlrmfintipomov
    from eqtipomov
    where codtipomov=new.codtipomov and codemp=new.codemptm and codfilial=new.codfilialtm
    into tipomov, vlrmfintipomov;

    -- Busca informações do contas a receber da venda
    select codrec
    from fnreceber
    where codvenda=new.codvenda and tipovenda=new.tipovenda and codemp=new.codemp and codfilialva=new.codfilial
    into icodrec;

    -- Verifica de
    if ((not tipomov in ('DV','TR')) and ((icodrec is null) or ((new.codplanopag != old.codplanopag) or
        (new.codcli != old.codcli) or (new.codvend != old.codvend) or (new.vlrliqvenda != old.vlrliqvenda) or
        (new.dtemitvenda != old.dtemitvenda) or (new.docvenda != old.docvenda) or (new.codbanco != old.codbanco)))) then

    begin

        if(gerarecemis = 'S') then
        begin
            dtrec = new.dtemitvenda;
        end
        else
        begin
            dtrec = new.dtsaidavenda;
        end


        -- Verica se deve haver retensão de ISS

        select sum(coalesce(iv.vlrissitvenda,0))
        from vditvenda iv left outer join lfitclfiscal cf on
        cf.codemp=iv.codempif and cf.codfilial=iv.codfilialif and cf.codfisc=iv.codfisc and cf.coditfisc=iv.coditfisc and cf.retensaoiss='S'
        where iv.codemp=new.codemp and iv.codfilial=new.codfilial and iv.codvenda=new.codvenda and iv.tipovenda=new.tipovenda
        and iv.vlrissitvenda>0
        into :vlrretensaoiss;

        if(:vlrretensaoiss is null) then
        begin
            vlrretensaoiss = 0;
        end

        -- De pedido para Venda
        if ((substr(old.statusvenda,1,1) = 'P') and (substr(new.statusvenda,1,1) = 'V' ) or
        ( (not new.vlrcomisvenda=old.vlrcomisvenda ) and (not new.statusvenda in ('P1','V1') ) ) ) then

        begin
           if (new.vlrliqvenda > 0) then
           begin

              execute procedure fnadicrecebersp01(
                   new.tipovenda, new.codvenda,
                   new.codemptc, new.codfilialtc, new.codtipocob,
                   new.codemppg,new.codfilialpg,new.codplanopag,
                   new.codempcl,new.codfilialcl,new.codcli,
                   new.codempvd,new.codfilialvd,new.codvend,
                   new.vlrliqvenda,dtrec, new.dtcompvenda, new.vlrcomisvenda,new.docvenda,
                   new.codempbo,new.codfilialbo,new.codbanco,
                   new.codemp,new.codfilial,
                   new.codempcb, new.codfilialcb, new.codcartcob, 
                   new.codempca, new.codfilialca, new.numconta,
                   new.flag, new.obsrec, new.vlrbasecomis, :vlrretensaoiss);
           end
           else
           begin
               delete from fnreceber where codvenda = new.codvenda and tipovenda=new.tipovenda and codemp=new.codemp and codfilialva = new.codfilial;
           end
        end
        -- De pedido ou venda aberto mudou para finalizado
        if ((new.statusvenda in ('P2','V2')) and (old.statusvenda in ('P1','V1'))) then
        begin
           if (new.vlrliqvenda > 0) then
               execute procedure fnadicrecebersp01(
                   new.tipovenda, new.codvenda,
                   new.codemptc, new.codfilialtc, new.codtipocob,
                   new.codemppg,new.codfilialpg,new.codplanopag,
                   new.codempcl,new.codfilialcl,new.codcli,
                   new.codempvd,new.codfilialvd,new.codvend,
                   new.vlrliqvenda,new.dtsaidavenda, new.dtcompvenda, new.vlrcomisvenda,new.docvenda,
                   new.codempbo,new.codfilialbo,new.codbanco,
                   new.codemp,new.codfilial,
                   new.codempcb, new.codfilialcb, new.codcartcob, 
                   new.codempca, new.codfilialca, new.numconta,
                   new.flag, new.obsrec, new.vlrbasecomis, :vlrretensaoiss);
           else
           begin
               delete from fnreceber where codvenda = new.codvenda and tipovenda=new.tipovenda and codemp=new.codemp and codfilialva = new.codfilial;
           end
        end
        -- De pedido fechado para venda fechada ou venda fechada para pedido fechado, ou sem alteração (em processo de fechamento)
        else if ((new.statusvenda in ('P2','V2')) and (old.statusvenda in ('P2','V2'))) then
        begin
           if (new.vlrliqvenda > 0) then
               execute procedure fnadicrecebersp01(
                   new.tipovenda, new.codvenda,
                   new.codemptc, new.codfilialtc, new.codtipocob,
                   new.codemppg,new.codfilialpg,new.codplanopag,
                   new.codempcl,new.codfilialcl,new.codcli,
                   new.codempvd,new.codfilialvd,new.codvend,
                   new.vlrliqvenda,new.dtsaidavenda, new.dtcompvenda, new.vlrcomisvenda,new.docvenda,
                   new.codempbo,new.codfilialbo,new.codbanco,
                   new.codemp,new.codfilial,
                   new.codempcb, new.codfilialcb, new.codcartcob, 
                   new.codempca, new.codfilialca, new.numconta,
                   new.flag, new.obsrec, new.vlrbasecomis, :vlrretensaoiss);
           else
           begin
                delete from fnreceber where codvenda = new.codvenda and tipovenda=new.tipovenda and codemp=new.codemp and codfilialva = new.codfilial;
           end
        end
        -- De pedido emitido para venda emitida ou venda emitida para pedido emitido, ou sem alteração
        else if ((new.statusvenda in ('P3','V3')) and (old.statusvenda in ('P3','V3'))) then
        begin
           if (new.vlrliqvenda > 0) then
               execute procedure fnadicrecebersp01(
                   new.tipovenda, new.codvenda,
                   new.codemptc, new.codfilialtc, new.codtipocob,
                   new.codemppg,new.codfilialpg,new.codplanopag,
                   new.codempcl,new.codfilialcl,new.codcli,
                   new.codempvd,new.codfilialvd,new.codvend,
                   new.vlrliqvenda,new.dtsaidavenda, new.dtcompvenda, new.vlrcomisvenda,new.docvenda,
                   new.codempbo,new.codfilialbo,new.codbanco,
                   new.codemp,new.codfilial,
                   new.codempcb, new.codfilialcb, new.codcartcob,
                   new.codempca, new.codfilialca, new.numconta,
                   new.flag, new.obsrec, new.vlrbasecomis, :vlrretensaoiss);
           else
           begin
               delete from fnreceber where codvenda = new.codvenda and tipovenda=new.tipovenda and codemp=new.codemp and codfilialva = new.codfilial;
           end
        end
      end
      if (old.vlrcomisvenda != new.vlrcomisvenda) then
      begin
          update fnreceber set vlrcomirec=new.vlrcomisvenda
          where codvenda=new.codvenda and tipovenda=new.tipovenda and codempvd=new.codemp and
                codfilialvd=new.codfilial;
      end
      else if (old.codclcomis != new.codclcomis) then
      begin
          select r.codfilial,r.codrec,r.vlrparcrec,r.vlrcomirec,r.nroparcrec
              from fnreceber r
              where r.codvenda=new.codvenda and r.tipovenda=new.tipovenda
              and r.codempva=new.codemp and r.codfilialva=new.codfilial
              into :scodfilialrc, :icodrec, :nvlrparcrec, :nvlrcomirec, :snroparcrec;
          execute procedure fnitrecebersp01(new.codemp,:scodfilialrc,:icodrec,
                :nvlrparcrec,:nvlrcomirec,:snroparcrec,'S');
      end

      /**
        testa valor das parcelas x valor da venda
      **/
      if ((old.statusvenda in ('P2','V2')) and (new.statusvenda in ('P3','V3')) and (vlrmfintipomov<>'S') ) then
      begin
        select vlrparcrec from fnreceber
            where codvenda=new.codvenda and tipovenda=new.tipovenda
            and codempva=new.codemp and codfilialva = new.codfilial
            into :nvlrparcrec;

       if (new.vlrliqvenda-:vlrretensaoiss != :nvlrparcrec) then
        begin
            exception vdvendaex06;
        end

      end

      -- Caso a data ou o tipo de movimento tenham sido alterados, deve disparar o trigger da vditvenda
    if ( (new.dtsaidavenda != old.dtsaidavenda) or (new.codtipomov!=old.codtipomov) or ( new.docvenda != old.docvenda )  ) then
    begin
        -- Update necessário para disparar o trigger da tabela vditvenda
        update vditvenda set coditvenda=coditvenda
        where codvenda = old.codvenda and tipovenda = old.tipovenda and codemp=old.codemp and codfilial=old.codfilial;
    end
    else if ((substr(new.statusvenda,1,1)='C') and (substr(old.statusvenda,1,1) in ('P','V'))) then
    begin

        delete from vdvendaorc where codemp=new.codemp and codfilial=new.codfilial and
        codvenda=new.codvenda and tipovenda=new.tipovenda;

        update vditvenda set qtditvendacanc=qtditvenda, qtditvenda=0 where codvenda=new.codvenda and tipovenda=new.tipovenda and
        codemp=new.codemp and codfilial=new.codfilial;

        delete from fnreceber where codvenda=new.codvenda and tipovenda=new.tipovenda and
        codemp=new.codemp and codfilialva=new.codfilial;

      end
      -- Verificação se existem registros na tabela eqmovserie com o mesmo código de venda
	  -- caso existam registros, os mesmos devem ser atualizados para o novo documento de venda,
	  -- para que sejam listados no módulo GMS Consulta Mov. Série, com o documento correto de saída.
	  -- antes desta alteração havia apenas a inserção de registros na tabela eqmovserie com número
	  -- de documento de pedido, não sendo atualizado após o pedido se transforme em PV PS PR PD
	  if (old.docvenda<>new.docvenda) then 
	  begin
	     update eqmovserie eqm set eqm.docmovserie=new.docvenda 
	        where eqm.codempvd=new.codemp and eqm.codfilialvd=new.codfilial and 
	          eqm.tipovenda=new.tipovenda and eqm.codvenda=new.codvenda and eqm.docmovserie<>new.docvenda;
	  end

   end

end
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER VDVENDATGBI;

SET TERM ^ ;

CREATE TRIGGER VDVENDATGBI FOR VDVENDA
ACTIVE BEFORE INSERT POSITION 0 
AS
  DECLARE VARIABLE sTipoMov CHAR(2);
BEGIN
  EXECUTE PROCEDURE VDCLIENTEATIVOSP(new.CODEMPCL, new.CODFILIALCL, new.CODCLI);
/*  EXECUTE PROCEDURE FNLIBCREDSP(new.CODVENDA,new.CODCLI,new.CODEMPCL,new.CODFILIALCL,null); */
  IF (new.VLRPRODVENDA IS NULL) THEN new.VLRPRODVENDA = 0;
  IF (new.VLRDESCVENDA IS NULL) THEN new.VLRDESCVENDA = 0;
  IF (new.VLRDESCITVENDA IS NULL) THEN new.VLRDESCITVENDA = 0;
  IF (new.VLRVENDA IS NULL) THEN new.VLRVENDA = 0;
  IF (new.VLRBASEICMSVENDA IS NULL) THEN new.VLRBASEICMSVENDA = 0;
  IF (new.VLRICMSVENDA IS NULL) THEN new.VLRICMSVENDA = 0;
  IF (new.VLRPISVENDA IS NULL) THEN new.VLRPISVENDA = 0;
  IF (new.VLRIRVENDA IS NULL) THEN new.VLRIRVENDA = 0;
  IF (new.VLRCSOCIALVENDA IS NULL) THEN new.VLRCSOCIALVENDA = 0;
  IF (new.VLRISENTASVENDA IS NULL) THEN new.VLRISENTASVENDA = 0;
  IF (new.VLROUTRASVENDA IS NULL) THEN new.VLROUTRASVENDA = 0;
  IF (new.VLRBASEIPIVENDA IS NULL) THEN new.VLRBASEIPIVENDA = 0;
  IF (new.VLRIPIVENDA IS NULL) THEN new.VLRIPIVENDA = 0;
  IF (new.VLRLIQVENDA IS NULL) THEN new.VLRLIQVENDA = 0;
  IF (new.VLRCOMISVENDA IS NULL) THEN new.VLRCOMISVENDA = 0;
  IF (new.VLRFRETEVENDA IS NULL) THEN new.VLRFRETEVENDA = 0;
  IF (new.VLRADICVENDA IS NULL) THEN new.VLRADICVENDA = 0;
  IF (new.TIPOVENDA IS NULL) THEN new.TIPOVENDA = 'V';
  IF (new.VLRBASEISSVENDA IS NULL) THEN new.VLRBASEISSVENDA = 0;
  IF (new.VLRISSVENDA IS NULL) THEN new.VLRISSVENDA = 0;
  IF (new.VLRPISVENDA IS NULL) THEN new.VLRPISVENDA = 0;
  IF (new.VLRIRVENDA IS NULL) THEN new.VLRIRVENDA = 0;
  IF (new.VLRCSOCIALVENDA IS NULL) THEN new.VLRCSOCIALVENDA = 0;
  IF (new.vlrbasepisvenda IS NULL) THEN new.vlrbasepisvenda = 0;
  IF (new.vlrbasecofinsvenda IS NULL) THEN new.vlrbasecofinsvenda = 0;
  IF (new.vlrpisvenda IS NULL) THEN new.vlrpisvenda = 0;
  IF (new.vlrcofinsvenda IS NULL) THEN new.vlrcofinsvenda = 0;
  IF (new.vlrbasecomis IS NULL) THEN new.vlrbasecomis = 0;
  if (new.sitdoc is null) then new.sitdoc='00';
  if (new.dtcompvenda is null) then new.dtcompvenda=new.dtemitvenda;

  IF (new.CODCAIXA IS NULL) THEN
    SELECT CODTERM FROM SGRETCAIXA INTO new.CODCAIXA;
  SELECT ICODFILIAL FROM SGRETFILIAL(new.CODEMP,'PVCAIXA') INTO new.CODFILIALCX;
  new.CODEMPCX = new.CODEMP;
  IF (NOT new.tipovenda = 'E') THEN -- Se for ECF não precisa buscar o DOC, porque o DOC é o numero do cupom.
      SELECT DOC FROM LFNOVODOCSP(new.Serie,new.CODEMPSE,new.CODFILIALSE) INTO new.DocVenda;
  SELECT TIPOMOV,FISCALTIPOMOV FROM EQTIPOMOV WHERE CODTIPOMOV=new.CODTIPOMOV
         AND CODEMP=new.CODEMP AND CODFILIAL = new.CODFILIALTM INTO sTipoMov,new.FLAG;
  IF ( new.FLAG <> 'S') THEN
  BEGIN
     new.FLAG = 'N';
  END
  if ((new.STATUSVENDA is null) OR (RTRIM(new.STATUSVENDA) = '*')) then
  BEGIN
     IF (sTipoMov = 'VD') THEN new.STATUSVENDA = 'V1';
     ELSE new.STATUSVENDA = 'P1';
  END
END
^

/* Alter exist trigger... */
SET TERM ; ^

DROP TRIGGER VDVENDATGBU;

SET TERM ^ ;

CREATE TRIGGER VDVENDATGBU FOR VDVENDA
ACTIVE BEFORE UPDATE POSITION 0 
AS
  DECLARE VARIABLE ICODFILIAL INTEGER;
  DECLARE VARIABLE ICODITVENDA INTEGER;
  DECLARE VARIABLE iCodTipoMov INTEGER;
  DECLARE VARIABLE sSerie CHAR(4);
  DECLARE VARIABLE credicmssimples CHAR(1);
  DECLARE VARIABLE iCodFilialPref smallint;
  DECLARE VARIABLE dDesc NUMERIC(15, 5);
  DECLARE VARIABLE PERCPISFILIAL NUMERIC(9,2);
  DECLARE VARIABLE PERCCOFINSFILIAL NUMERIC(9,2);
  DECLARE VARIABLE PERCIRFILIAL NUMERIC(9,2);
  DECLARE VARIABLE PERCCSOCIALFILIAL NUMERIC(9,2);
  DECLARE VARIABLE PERCSIMPLESFILIAL NUMERIC(9,2);
  DECLARE VARIABLE VLRPRODITVENDA NUMERIC(15, 5);
  DECLARE VARIABLE QTDITVENDA NUMERIC(9,2);
  DECLARE VARIABLE VLRCOMISITVENDA NUMERIC(15, 5);
  DECLARE VARIABLE VLRDESCITVENDA NUMERIC(15, 5);
  DECLARE VARIABLE PERCCOMISITVENDA NUMERIC(9,2);
  DECLARE VARIABLE SIMPLESFILIAL CHAR(1);
  DECLARE VARIABLE SIMPLESCLI CHAR(1);
  DECLARE VARIABLE PESSOACLI CHAR(1);          
  DECLARE VARIABLE NVLRFRETE NUMERIC(15,5);
  DECLARE VARIABLE CADICFRETEVD CHAR(1);
  DECLARE VARIABLE PERCIT NUMERIC(9,2);
  DECLARE VARIABLE RETENSAOIMP CHAR(1);

BEGIN

  retensaoimp = 'N';

  IF (new.EMMANUT IS NULL) THEN
     new.EMMANUT='N';
  if (new.BLOQVENDA IS NULL) then
     new.BLOQVENDA='N';
  IF ( not ( (new.EMMANUT='S') or ( (old.EMMANUT='S') and (old.EMMANUT is not null)) ) ) THEN
  BEGIN
      if ( ( (old.BLOQVENDA IS  NULL) OR (old.BLOQVENDA='N') ) AND (new.BLOQVENDA='S') )  then
      begin
          new.DTALT=cast('now' AS DATE);
          new.IDUSUALT=user;
          new.HALT=cast('now' AS TIME);
      end
      IF ( (new.DTCOMPVENDA is null) or (old.DTEMITVENDA<>new.DTEMITVENDA)  ) THEN
         new.DTCOMPVENDA=new.DTEMITVENDA;

      SELECT ICODFILIAL FROM SGRETFILIAL(new.CODEMP, 'SGPREFERE1') INTO iCodFilialPref;
      EXECUTE PROCEDURE VDCLIENTEATIVOSP(new.CODEMPCL, new.CODFILIALCL, new.CODCLI);

      if ( (old.BLOQVENDA IS NOT NULL AND old.BLOQVENDA='S') or (new.BLOQVENDA='S') and old.chavenfevenda=new.chavenfevenda) then
         EXCEPTION VDVENDAEX05 'ESTA VENDA ESTÁ BLOQUEADA!!!';


      new.DTALT=cast('now' AS DATE);
      new.IDUSUALT=user;
      new.HALT=cast('now' AS TIME);
      SELECT CODFILIALSEL FROM SGCONEXAO WHERE NRCONEXAO=CURRENT_CONNECTION AND
          CONECTADO > 0 INTO ICODFILIAL;
      IF (substr(old.STATUSVENDA,1,1) = 'C' and old.chavenfevenda=new.chavenfevenda ) THEN
        EXCEPTION VDVENDAEX05;
      IF (substr(old.STATUSVENDA,1,1) = 'D' and old.chavenfevenda=new.chavenfevenda) THEN
        EXCEPTION VDVENDAEX05 'ESTA VENDA FOI DEVOLVIDA!';
      IF ((SUBSTR(old.STATUSVENDA,1,1) = 'P') AND (SUBSTR(new.STATUSVENDA,1,1) = 'V' ) AND new.IMPNOTAVENDA = 'N') THEN
      BEGIN
        SELECT T2.CODTIPOMOV, T2.SERIE FROM EQTIPOMOV T2, EQTIPOMOV T WHERE T2.CODEMP=T.CODEMPTM
               AND T2.CODFILIAL=T.CODFILIALTM AND T2.CODTIPOMOV = T.CODTIPOMOVTM
               AND T.CODEMP=new.CODEMPTM AND T.CODFILIAL=new.CODFILIALTM AND T.CODTIPOMOV=new.CODTIPOMOV
               INTO :iCodTipoMov, :sSerie;
        IF (iCodTipoMov IS NULL) THEN
          SELECT T.CODTIPOMOV, T.SERIE FROM SGPREFERE1 P, EQTIPOMOV T WHERE P.CODEMPTM=T.CODEMP AND
                 P.CODFILIALTM=T.CODFILIAL AND P.CODTIPOMOV = T.CODTIPOMOV
                 AND P.CODEMP=new.CODEMP AND P.CODFILIAL = :iCodFilialPref INTO :iCodTipoMov, :sSerie;
        new.CODTIPOMOV = :iCodTipoMov;
        new.SERIE = :sSerie;
        IF ( ( not (old.IMPNOTAVENDA = 'S') ) AND ( not (new.IMPNOTAVENDA = 'S') ) ) THEN
        BEGIN
            SELECT DOC FROM LFNOVODOCSP(new.Serie,new.CODEMPSE,new.CODFILIALSE) INTO new.DocVenda;
            new.IMPNOTAVENDA = 'S';
        END
      END
      SELECT FISCALTIPOMOV FROM EQTIPOMOV WHERE CODTIPOMOV=new.CODTIPOMOV
             AND CODEMP=new.CODEMP AND CODFILIAL = new.codfilialtm INTO new.FLAG;
      IF (new.FLAG<>'S') THEN
        new.FLAG = 'N';
      SELECT VLRFRETEVD, ADICFRETEVD FROM VDFRETEVD WHERE CODVENDA=old.CODVENDA AND TIPOVENDA=old.TIPOVENDA AND ADICFRETEVD = 'S'
             AND CODEMP=old.CODEMP AND CODFILIAL = old.codfilial INTO new.VLRFRETEVENDA, :CADICFRETEVD;
      IF (new.VLRDESCVENDA IS NULL) THEN
        new.VLRDESCVENDA = 0;
      IF (new.VLRDESCITVENDA IS NULL) THEN
        new.VLRDESCITVENDA = 0;
      IF (new.VLRADICVENDA IS NULL) THEN
        new.VLRADICVENDA = 0;
      IF (new.VLRFRETEVENDA IS NULL) THEN
        new.VLRFRETEVENDA = 0;
      IF (new.VLRPRODVENDA IS NULL) THEN
        new.VLRPRODVENDA = 0;
      IF (new.VLRIPIVENDA IS NULL) THEN
        new.VLRIPIVENDA = 0;
      IF (new.VLRBASEICMSVENDA IS NULL) THEN
        new.VLRBASEICMSVENDA = 0;
      IF (new.VLRDESCITVENDA > 0) THEN
        dDesc = new.VLRDESCITVENDA;
      ELSE
        dDesc = new.VLRDESCVENDA;
      IF (new.VLRBASEICMSSTVENDA IS NULL) THEN
        new.VLRBASEICMSSTVENDA = 0;
      IF (new.VLRICMSSTVENDA IS NULL) THEN
        new.VLRICMSSTVENDA = 0;

      SELECT C.SIMPLESCLI,C.PESSOACLI FROM VDCLIENTE C WHERE C.CODCLI=new.CODCLI AND
        C.CODFILIAL=new.CODFILIALCL AND C.CODEMP=new.CODEMPCL INTO SIMPLESCLI,PESSOACLI;
      SELECT SIMPLESFILIAL,PERCPISFILIAL,PERCCOFINSFILIAL,PERCIRFILIAL,PERCCSOCIALFILIAL,coalesce(PERCSIMPLESFILIAL,0)
        FROM SGFILIAL WHERE CODEMP=new.CODEMP AND CODFILIAL=:ICODFILIAL
        INTO SIMPLESFILIAL,PERCPISFILIAL,PERCCOFINSFILIAL,PERCIRFILIAL,PERCCSOCIALFILIAL,PERCSIMPLESFILIAL;
      IF (SIMPLESFILIAL = 'N') THEN
      BEGIN
        new.VLRIRVENDA = (new.vlrliqvenda/100)*PERCIRFILIAL;
        new.VLRCSOCIALVENDA = (new.vlrliqvenda/100)*PERCCSOCIALFILIAL;
      END
      ELSE
      BEGIN
        new.VLRIRVENDA = 0;
        new.VLRCSOCIALVENDA = 0;

        /*Verifica se deve destacar crédito de icms (simples)*/
        select p1.credicmssimples,p1.retensaoimp from sgprefere1 p1 where p1.codemp=new.codemp and p1.codfilial=:icodfilialpref
        into credicmssimples,retensaoimp;

        if(credicmssimples='S') then
        begin
            new.vlricmssimples = (new.vlrprodvenda/100) * percsimplesfilial ;
            new.percicmssimples = percsimplesfilial;
        end

      END
      if (CADICFRETEVD = 'S') then
         NVLRFRETE = new.VLRFRETEVENDA;
      else
         NVLRFRETE = 0;

      new.VLRLIQVENDA = coalesce(new.VLRPRODVENDA,0)
                      - coalesce(dDesc,0)
                      + coalesce(new.VLRADICVENDA,0)
                      + coalesce(:NVLRFRETE,0)
                      + coalesce(new.VLRIPIVENDA,0)
                      + coalesce(new.vlricmsstvenda,0);

      if (SIMPLESCLI = 'N' AND PESSOACLI = 'J' AND RETENSAOIMP = 'S') then
      begin
        new.VLRLIQVENDA =
             cast(
                (coalesce(new.VLRLIQVENDA,0)) -
                (case when new.calcpisvenda='S' then coalesce(new.vlrpisvenda,0) else 0 end) -
                (case when new.calccofinsvenda='S' then coalesce(new.vlrcofinsvenda,0) else 0 end) -
                (case when new.calcirvenda='S' then coalesce(new.vlrirvenda,0) else 0 end) -
                (case when new.calccsocialvenda='S' then coalesce(new.vlrcsocialvenda,0) else 0 end)
            as numeric(15, 5));
      end

      IF ((substr(old.STATUSVENDA,1,1) IN ('P','V')) AND (substr(new.STATUSVENDA,1,1)='C')) THEN
      BEGIN
          new.VLRDESCITVENDA = 0;
          new.VLRPRODVENDA = 0;
          new.VLRBASEICMSVENDA = 0;
          new.VLRICMSVENDA = 0;
          new.VLRISENTASVENDA = 0;
          new.VLROUTRASVENDA = 0;
          new.VLRBASEIPIVENDA = 0;
          new.VLRIPIVENDA = 0;
          new.VLRLIQVENDA = 0;
          new.VLRCOMISVENDA = 0;
          new.VLRISSVENDA = 0;
          new.VLRBASEISSVENDA = 0;
          new.vlrpisvenda = 0;
          new.vlrcofinsvenda = 0;
          new.vlrirvenda = 0;
          new.vlrcsocialvenda =0;
          new.vlrbaseicmsstvenda=0;
          new.vlricmsstvenda=0;
      END
    /**
       COMISSAO
    **/
      IF ((NOT NEW.VLRCOMISVENDA IS NULL) AND
          (NEW.VLRLIQVENDA > 0) AND
          ((NOT NEW.VLRDESCVENDA = OLD.VLRDESCVENDA) OR (NOT NEW.PERCMCOMISVENDA = OLD.PERCMCOMISVENDA))) then
      BEGIN
        /* Distribuindo a comissao: */
        FOR SELECT CODITVENDA,VLRPRODITVENDA,QTDITVENDA,coalesce(VLRCOMISITVENDA,0),coalesce(vlrdescitvenda,0),
            coalesce(iv.perccomisitvenda,0)
            FROM VDITVENDA IV
            WHERE CODEMP=new.CODEMP AND CODFILIAL=new.CODFILIAL AND CODVENDA=new.CODVENDA and tipovenda=new.tipovenda
            INTO ICODITVENDA,VLRPRODITVENDA,QTDITVENDA,VLRCOMISITVENDA,VLRDESCITVENDA,PERCCOMISITVENDA DO
        BEGIN
          /* Calculo do item.: */
          /* INCLUIDO PARA DISTRIBUIR A COMISSAO MENOS O DESCONTO PROPORCIONALMENTE*/
          PERCIT = 0;
          IF (new.VLRPRODVENDA > 0 AND NOT new.VLRDESCITVENDA > 0 AND new.VLRDESCVENDA > 0) THEN
          BEGIN
            PERCIT = (100*VLRPRODITVENDA) / new.VLRPRODVENDA;
            VLRDESCITVENDA = (new.VLRDESCVENDA  * PERCIT) / 100;
          END
          IF (new.VLRPRODVENDA > 0 AND new.PERCMCOMISVENDA > 0) THEN
          BEGIN
            PERCCOMISITVENDA = new.PERCMCOMISVENDA;
            /* Retira.. */
            new.VLRCOMISVENDA = new.VLRCOMISVENDA - VLRCOMISITVENDA;
            /* Atualiza.. */
            VLRCOMISITVENDA = ((VLRPRODITVENDA - VLRDESCITVENDA) * PERCCOMISITVENDA) / 100;
            /* Adiciona.. */
            new.VLRCOMISVENDA = new.VLRCOMISVENDA + VLRCOMISITVENDA;
          END
          ELSE IF (new.PERCMCOMISVENDA=0) then
          BEGIN
              VLRCOMISITVENDA = 0;
              PERCCOMISITVENDA = 0;
              new.VLRCOMISVENDA = 0;
          END
          UPDATE VDITVENDA SET VLRCOMISITVENDA=:VLRCOMISITVENDA,PERCCOMISITVENDA=:PERCCOMISITVENDA
          WHERE CODITVENDA=:ICODITVENDA AND CODVENDA=new.CODVENDA AND TIPOVENDA=new.TIPOVENDA AND CODEMP=new.CODEMP AND CODFILIAL=new.CODFILIAL;
        END
      END
      /* Calcula o percentual medio da comissao */
      ELSE IF (new.PERCMCOMISVENDA = old.PERCMCOMISVENDA AND new.VLRLIQVENDA > 0) THEN
      begin
        -- new.PERCMCOMISVENDA = (new.VLRCOMISVENDA/new.VLRLIQVENDA)*100.000;
	-- Modificado, pois causava divergencia em vendas geradas a partir de orçamentos.
	if ((new.vlrprodvenda-new.vlrdescvenda)>0) then
	begin
		new.PERCMCOMISVENDA = (new.VLRCOMISVENDA/(new.vlrprodvenda-new.vlrdescvenda)) * 100;
	end
	else
	begin
		new.PERCMCOMISVENDA = 0;
	end
      end

      IF (new.STATUSVENDA = 'V4') THEN
      BEGIN
        new.IMPNOTAVENDA = 'S';
        new.STATUSVENDA = 'V3';
      END
      IF ((new.IMPNOTAVENDA = 'S') AND (old.IMPNOTAVENDA = 'S')) THEN
      BEGIN
        new.DOCVENDA = old.DOCVENDA;
      END
  END

  -- Atualizando o status do documento fiscal para 02 - Documento cancelado, quando nota for cancelado pelo sistema.
  IF (substr(new.STATUSVENDA,1,1) = 'C' and new.sitdoc!='02') THEN
  begin
    new.sitdoc = '02';
  end

  if(old.chavenfevenda is null and new.chavenfevenda is not null) then
  begin
    new.emmanut = 'N';
  end


END
^

/* Alter Procedure... */
/* Alter (ATADICATENDIMENTOCLISP) */
ALTER PROCEDURE ATADICATENDIMENTOCLISP(ICODTIPOATENDO INTEGER,
ICODATEND INTEGER,
ICODSETOR INTEGER,
ICODEMP INTEGER,
ICODFILIAL INTEGER,
IDOC INTEGER,
DATAATENDO DATE,
DATAATENDOFIN DATE,
HORAATENDO TIME,
HORAATENDOFIN TIME,
OBSATENDO VARCHAR(10000),
CODEMPCL INTEGER,
CODFILIALCL SMALLINT,
CODCLI INTEGER,
CODEMPCT INTEGER,
CODFILIALCT INTEGER,
CODCONTR INTEGER,
CODITCONTR INTEGER,
CODREC INTEGER,
NPARCITREC INTEGER,
CODEMPCH INTEGER,
CODFILIALCH SMALLINT,
CODCHAMADO INTEGER,
OBSINTERNO VARCHAR(10000),
CONCLUICHAMADO CHAR(1),
CODEMPEA INTEGER,
CODFILIALEA SMALLINT,
CODESPEC INTEGER)
 AS
declare variable icodatendo integer;
declare variable ifilialatendo integer;
declare variable ifilialtipoatendo integer;
declare variable ifilialatend integer;
declare variable ifilialsetor integer;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATATENDIMENTO') INTO IFILIALATENDO;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATTIPOATENDO') INTO IFILIALTIPOATENDO;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATATENDENTE') INTO IFILIALATEND;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATSETOR') INTO IFILIALSETOR;
  SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALATENDO,'AT') INTO ICODATENDO;

  INSERT INTO ATATENDIMENTO (
    CODEMP,CODFILIAL,CODATENDO,CODEMPTO,
    CODFILIALTO,CODTPATENDO,CODEMPAE,
    CODFILIALAE,CODATEND,CODEMPSA,CODFILIALSA,
    CODSETAT,STATUSATENDO,IDUSU,CODEMPUS,CODFILIALUS,DOCATENDO, DATAATENDO,
    DATAATENDOFIN, HORAATENDO, HORAATENDOFIN, OBSATENDO, CODEMPCL, CODFILIALCL, CODCLI, CODEMPCT, CODFILIALCT,
    CODCONTR, CODITCONTR, CODEMPCH, CODFILIALCH, CODCHAMADO, obsinterno, CONCLUICHAMADO,
    CODEMPEA, CODFILIALEA, CODESPEC )

  VALUES
  (
    :ICODEMP,:IFILIALATENDO,:ICODATENDO,:ICODEMP,
    :IFILIALTIPOATENDO,:ICODTIPOATENDO,:ICODEMP,
    :IFILIALATEND,:ICODATEND,:ICODEMP,:IFILIALSETOR,
    :ICODSETOR,'AA',lower(USER),:ICODEMP,:ICODFILIAL,:IDOC,
    :DATAATENDO,:DATAATENDOFIN,:HORAATENDO,:HORAATENDOFIN,:OBSATENDO,:CODEMPCL,
    :CODFILIALCL,:CODCLI, :CODEMPCT, :CODFILIALCT, :CODCONTR, :CODITCONTR, :codempch,
    :codfilialch, :codchamado, :obsinterno, :CONCLUICHAMADO,
    :CODEMPEA, :CODFILIALEA, :CODESPEC
  );

  -- Caso o atendimento tenha vinculo com o contas a receber
  IF(CODREC IS NOT NULL AND NPARCITREC IS NOT NULL) THEN
  BEGIN
    INSERT INTO ATATENDIMENTOITREC (CODEMP,CODFILIAL,CODATENDO,CODEMPIR,CODFILIALIR,CODREC,NPARCITREC) VALUES
        (:ICODEMP,:ICODFILIAL,:ICODATENDO,:ICODEMP,:ICODFILIAL,:CODREC,:NPARCITREC);
  END



END
^

/* Alter (ATADICATENDIMENTOSP) */
ALTER PROCEDURE ATADICATENDIMENTOSP(ICODCONV INTEGER,
ICODTIPOATENDO INTEGER,
ICODATEND INTEGER,
ICODSETOR INTEGER,
VOBSATENDO VARCHAR(10000),
ICODEMP INTEGER,
ICODFILIAL INTEGER,
IDOC INTEGER)
 AS
DECLARE VARIABLE ICODATENDO INTEGER;
DECLARE VARIABLE IFILIALATENDO INTEGER;
DECLARE VARIABLE IFILIALCONV INTEGER;
DECLARE VARIABLE IFILIALTIPOATENDO INTEGER;
DECLARE VARIABLE IFILIALATEND INTEGER;
DECLARE VARIABLE IFILIALSETOR INTEGER;
DECLARE VARIABLE IFILIALPREF INTEGER;
DECLARE VARIABLE IFILIALVEND INTEGER;
DECLARE VARIABLE IFILIALORC INTEGER;
DECLARE VARIABLE ICODTPATENDOLEV INTEGER; /*TIPO DE ATENDIMENTO PARA LEVANTAMENTOS*/
DECLARE VARIABLE ICODORC INTEGER;
DECLARE VARIABLE ICODCLI INTEGER;
DECLARE VARIABLE ICODVEND INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATATENDIMENTO') INTO IFILIALATENDO;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATCONVENIADO') INTO IFILIALCONV;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATTIPOATENDO') INTO IFILIALTIPOATENDO;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATATENDENTE') INTO IFILIALATEND;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATSETOR') INTO IFILIALSETOR;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'VDORCAMENTO') INTO IFILIALORC;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'SGPREFERE2') INTO IFILIALPREF;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'VDVENDEDOR') INTO IFILIALVEND;
  SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALATENDO,'AT') INTO ICODATENDO;
  SELECT CODTPATENDO FROM SGPREFERE2 WHERE CODEMP=:ICODEMP AND CODFILIAL=:IFILIALPREF INTO ICODTPATENDOLEV;
  INSERT INTO ATATENDIMENTO (
    CODEMP,CODFILIAL,CODATENDO,CODCONV,
    CODEMPCV,CODFILIALCV,CODEMPTO,
    CODFILIALTO,CODTPATENDO,CODEMPAE,
    CODFILIALAE,CODATEND,CODEMPSA,CODFILIALSA,
    CODSETAT,STATUSATENDO,OBSATENDO,IDUSU,CODEMPUS,CODFILIALUS,DOCATENDO)
  VALUES
  (
    :ICODEMP,:IFILIALATENDO,:ICODATENDO,:ICODCONV,
    :ICODEMP,:IFILIALCONV,:ICODEMP,
    :IFILIALTIPOATENDO,:ICODTIPOATENDO,:ICODEMP,
    :IFILIALATEND,:ICODATEND,:ICODEMP,:IFILIALSETOR,
    :ICODSETOR,'AA',:VOBSATENDO,lower(USER),:ICODEMP,:ICODFILIAL,:IDOC
  );
/*  SELECT CODORC FROM ATATENDIMENTOORC WHERE CODEMP=:ICODEMP
    AND CODFILIAL=:IFILIALORC AND CODORC=:IDOC INTO ICODORC;*/
  IF (ICODTIPOATENDO = ICODTPATENDOLEV/* AND ICODORC IS NULL*/) THEN
  BEGIN
    SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALORC,'OC') INTO ICODORC;
    SELECT CODFILIALVD,CODVEND FROM SGPREFERE2 WHERE
      CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO IFILIALVEND,ICODVEND;
    INSERT INTO VDORCAMENTO (CODEMP,CODFILIAL,TIPOORC,CODORC,CODEMPCV,CODFILIALCV,CODCONV,
        DTORC,DTVENCORC,STATUSORC,CODEMPVD,CODFILIALVD,CODVEND)
      VALUES
      (
        :ICODEMP,:IFILIALORC,'O',:ICODORC,:ICODEMP,:IFILIALCONV,:ICODCONV,
        CAST ('today' AS DATE),CAST ('today' AS DATE),'OA',:ICODEMP,:IFILIALVEND,:ICODVEND
      );


    INSERT INTO ATATENDIMENTOORC (CODEMP,CODFILIAL,CODATENDO,CODEMPOC,CODFILIALOC,TIPOORC,CODORC)
      VALUES
        (:ICODEMP,:IFILIALORC,:ICODATENDO,:ICODEMP,:IFILIALORC,'O',:ICODORC);

    UPDATE ATATENDIMENTO SET DOCATENDO = :IDOC WHERE
      CODEMP=:ICODEMP AND CODFILIAL=:IFILIALATENDO AND CODATENDO=:ICODATENDO;
  END

END
^

/* Alter (ATATENDIMENTOIUSP) */
ALTER PROCEDURE ATATENDIMENTOIUSP(IU CHAR(1),
CODEMP INTEGER,
CODFILIAL SMALLINT,
CODATENDO INTEGER,
CODEMPTO INTEGER,
CODFILIALTO SMALLINT,
CODTPATENDO INTEGER,
CODEMPAE INTEGER,
CODFILIALAE SMALLINT,
CODATEND INTEGER,
CODEMPSA INTEGER,
CODFILIALSA SMALLINT,
CODSETOR INTEGER,
DOCATENDO INTEGER,
DATAATENDO DATE,
DATAATENDOFIN DATE,
HORAATENDO TIME,
HORAATENDOFIN TIME,
OBSATENDO VARCHAR(10000),
CODEMPCL INTEGER,
CODFILIALCL SMALLINT,
CODCLI INTEGER,
CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
CODCONTR INTEGER,
CODITCONTR SMALLINT,
CODEMPIR INTEGER,
CODFILIALIR SMALLINT,
CODREC INTEGER,
NPARCITREC INTEGER,
CODEMPCH INTEGER,
CODFILIALCH SMALLINT,
CODCHAMADO INTEGER,
OBSINTERNO VARCHAR(10000),
CONCLUICHAMADO CHAR(1),
CODEMPEA INTEGER,
CODFILIALEA SMALLINT,
CODESPEC INTEGER,
CODEMPUS INTEGER,
CODFILIALUS SMALLINT,
IDUSU VARCHAR(128),
STATUSATENDO CHAR(2),
CODEMPTA INTEGER,
CODFILIALTA SMALLINT,
CODTAREFA INTEGER)
 AS
declare variable horaatendors time;
declare variable horaatendofinrs time;
declare variable dataatendors date;
BEGIN

  DATAATENDORS = NULL;

  SELECT FIRST 1 A.DATAATENDO, A.HORAATENDO, A.HORAATENDOFIN
    FROM ATATENDIMENTO A
    WHERE A.CODEMP=:CODEMP AND A.CODFILIAL=:CODFILIAL AND
        A.CODEMPAE=:CODEMPAE AND A.CODFILIALAE=:CODFILIALAE AND
        A.CODATEND=:CODATEND AND A.CODATENDO<>:CODATENDO AND
        A.DATAATENDO=:DATAATENDO AND ( (A.HORAATENDO BETWEEN :HORAATENDO+1 AND :HORAATENDOFIN-1 )
        OR (A.HORAATENDOFIN BETWEEN :HORAATENDO+1 AND :HORAATENDOFIN-1 ) )
    INTO :DATAATENDORS, :HORAATENDORS, :HORAATENDOFINRS ;

  if (DATAATENDORS IS NOT NULL) then
  begin
     exception atatendimentoex02 'Jah existe(m) lancamento(s) em '||:dataatendors||' - h.: '||
        :horaatendors||' - '||:horaatendofinrs;
  end

  if (IU = 'I') then
  begin
     SELECT ISEQ FROM SPGERANUM(:CODEMP,:CODFILIAL,'AT') INTO :CODATENDO;
     STATUSATENDO = 'AA';
     INSERT INTO ATATENDIMENTO (
        CODEMP,CODFILIAL,CODATENDO,CODEMPTO,
        CODFILIALTO,CODTPATENDO,CODEMPAE,
        CODFILIALAE,CODATEND,CODEMPSA,CODFILIALSA,
        CODSETAT,STATUSATENDO,
        CODEMPUS,CODFILIALUS, IDUSU,
        DOCATENDO, DATAATENDO,
        DATAATENDOFIN, HORAATENDO, HORAATENDOFIN, OBSATENDO, CODEMPCL, CODFILIALCL, CODCLI, CODEMPCT, CODFILIALCT,
        CODCONTR, CODITCONTR, CODEMPCH, CODFILIALCH, CODCHAMADO, obsinterno, CONCLUICHAMADO,
        CODEMPEA, CODFILIALEA, CODESPEC , CODEMPTA, CODFILIALTA, CODTAREFA )

     VALUES (
        :CODEMP, :CODFILIAL, :CODATENDO,
        :CODEMPTO, :CODFILIALTO, :CODTPATENDO,
        :CODEMPAE, :CODFILIALAE,:CODATEND,
        :CODEMPSA,:CODFILIALSA, :CODSETOR,
        :STATUSATENDO ,
        :CODEMPUS, :CODFILIALUS, lower(:IDUSU),
        :DOCATENDO, :DATAATENDO, :DATAATENDOFIN, :HORAATENDO,
        :HORAATENDOFIN, :OBSATENDO,
        :CODEMPCL, :CODFILIALCL, :CODCLI,
        :CODEMPCT, :CODFILIALCT, :CODCONTR, :CODITCONTR,
        :CODEMPCH, :CODFILIALCH, :CODCHAMADO,
        :OBSINTERNO, :CONCLUICHAMADO,
        :CODEMPEA, :CODFILIALEA, :CODESPEC , :CODEMPTA, :CODFILIALTA, :CODTAREFA
     );
  -- Caso o atendimento tenha vinculo com o contas a receber
     if (CODREC IS NOT NULL AND NPARCITREC IS NOT NULL) then
     begin
        INSERT INTO ATATENDIMENTOITREC (CODEMP,CODFILIAL,CODATENDO,CODEMPIR,CODFILIALIR,CODREC,NPARCITREC) VALUES
                (:CODEMP,:CODFILIAL,:CODATENDO,:CODEMPIR,:CODFILIALIR,:CODREC,:NPARCITREC);
     end
  end
  else if (IU = 'U') then
  begin
        UPDATE ATATENDIMENTO SET
            CODATEND=:CODATEND, DATAATENDO=:DATAATENDO, HORAATENDO=:HORAATENDO, DATAATENDOFIN=:DATAATENDOFIN,
            HORAATENDOFIN=:HORAATENDOFIN, OBSATENDO=:OBSATENDO,CODEMPTO=:CODEMPTO, CODFILIALTO=:CODFILIALTO,
            CODTPATENDO=:CODTPATENDO,CODEMPSA=:CODEMPSA, CODFILIALSA=:CODFILIALSA, CODSETAT=:CODSETOR, CODEMPCH=:CODEMPCH,
            CODFILIALCH=:CODFILIALCH, CODCHAMADO=:CODCHAMADO, CODEMPCT=:CODEMPCT, CODFILIALCT=:CODFILIALCT,
            CODCONTR=:CODCONTR, CODITCONTR=:CODITCONTR, STATUSATENDO=:STATUSATENDO, OBSINTERNO=:OBSINTERNO,
            CONCLUICHAMADO=:CONCLUICHAMADO, CODEMPEA=:CODEMPEA, CODFILIALEA=:CODFILIALEA, CODESPEC=:CODESPEC,
            CODEMPTA=:CODEMPTA, CODFILIALTA=:CODFILIALTA, CODTAREFA=:CODTAREFA,
            CODEMPCL=:CODEMPCL, CODFILIALCL=:CODFILIALCL, CODCLI=:CODCLI
        WHERE
            CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL AND CODATENDO=:CODATENDO;
  end
END
^

/* Alter (ATBUSCAPRECOSP) */
ALTER PROCEDURE ATBUSCAPRECOSP(ICODPROD INTEGER,
ICODCONV INTEGER,
ICODEMPCV INTEGER,
ICODFILIALCV SMALLINT,
ICODPLANOPAG INTEGER,
ICODEMPPG INTEGER,
ICODFILIALPG SMALLINT,
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 RETURNS(PRECO NUMERIC(15,5))
 AS
DECLARE VARIABLE iCodTipoMov INTEGER;
  DECLARE VARIABLE iCodEmpTM INTEGER;
  DECLARE VARIABLE iCodFilialTM INTEGER;
  DECLARE VARIABLE iCodCli INTEGER;
  DECLARE VARIABLE iCodEmpCli INTEGER;
  DECLARE VARIABLE iCodFilialCli INTEGER;
BEGIN
  SELECT CODTIPOMOV2,CODEMPT2,CODFILIALT2 FROM SGPREFERE1 WHERE CODEMP=:ICODEMP
         AND CODFILIAL=:ICODFILIAL INTO iCodTipoMov,iCodEmpTM,iCodFilialTM;
  SELECT CODCLI,CODEMPCL,CODFILIALCL FROM ATCONVENIADO WHERE CODCONV=:ICODCONV
         AND CODEMP=:ICODEMPCV AND CODFILIAL=:ICODFILIALCV INTO iCodCli,iCodEmpCli,iCodFilialCli;

  SELECT PRECO FROM VDBUSCAPRECOSP(:ICODPROD,:iCodCli,:iCodEmpCli,:iCodFilialCli,:ICODPLANOPAG,:ICODEMPPG,
    :ICODFILIALPG,:iCodTipoMov,:iCodEmpTM,:iCodFilialTM,:ICODEMP,:ICODFILIAL) INTO PRECO;

  SUSPEND;
END
^

/* Alter (CPADICFORSP) */
ALTER PROCEDURE CPADICFORSP(CODEMP INTEGER,
CODFILIAL INTEGER,
CODFILIALCL INTEGER,
CODCLI INTEGER)
 RETURNS(CODFOR INTEGER)
 AS
DECLARE VARIABLE CODTIPOFOR INTEGER;
DECLARE VARIABLE CODFILIALTF INTEGER;
DECLARE VARIABLE CODFILIALFR INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'CPFORNECED') INTO CODFILIALFR;
  SELECT P.CODTIPOFOR,P.CODFILIALTF FROM SGPREFERE1 P WHERE P.CODEMP=:CODEMP
    AND P.CODFILIAL=:CODFILIAL INTO CODTIPOFOR,CODFILIALTF;
  SELECT MAX(CODFOR)+1 FROM CPFORNECED WHERE CODEMP=:CODEMP
    AND CODFILIAL=:CODFILIALFR INTO CODFOR;
  INSERT INTO CPFORNECED (CODEMP,CODFILIAL,CODFOR,RAZFOR,CODEMPTF,CODFILIALTF,
                        CODTIPOFOR,CODEMPBO,CODFILIALBO,CODBANCO,NOMEFOR,
                        DATAFOR,ATIVOFOR,PESSOAFOR,CNPJFOR,CPFFOR,INSCFOR,
                        RGFOR,ENDFOR,NUMFOR,COMPLFOR,BAIRFOR,CEPFOR,CIDFOR,
                        UFFOR,CONTFOR,FONEFOR,FAXFOR,AGENCIAFOR,CONTAFOR,
                        EMAILFOR,OBSFOR,CELFOR,CLIFOR)
                 SELECT :CODEMP,:CODFILIALFR,:CODFOR,RAZCLI,:CODEMP,:CODFILIALTF,
                        :CODTIPOFOR,NULL,NULL,NULL,NOMECLI,
                        DATACLI,ATIVOCLI,PESSOACLI,CNPJCLI,CPFCLI,INSCCLI,
                        RGCLI,ENDCLI,NUMCLI,COMPLCLI,BAIRCLI,CEPCLI,CIDCLI,
                        UFCLI,CONTCLI,FONECLI,FAXCLI,NULL,NULL,
                        EMAILCLI,OBSCLI,CELCLI,'C' FROM VDCLIENTE WHERE
                        CODCLI=:CODCLI AND CODFILIAL=:CODFILIALCL AND
                        CODEMP=:CODEMP;
  SUSPEND;
END
^

/* Alter (CPADICITCOMPRAPEDSP) */
ALTER PROCEDURE CPADICITCOMPRAPEDSP(CODEMP INTEGER,
CODFILIAL SMALLINT,
CODCOMPRA INTEGER,
CODEMPPC INTEGER,
CODFILIALPC SMALLINT,
CODCOMPRAPC INTEGER,
CODITCOMPRAPC INTEGER,
TPAGRUP CHAR(1),
QTDITCOMPRA FLOAT,
VLRDESCITCOMPRA NUMERIC(15,5),
PRECOITCOMPRA NUMERIC(15,5))
 AS
declare variable codemptm integer;
declare variable codfilialtm smallint;
declare variable codtipomov integer;
declare variable codempfr integer;
declare variable codfilialfr smallint;
declare variable codfor integer;
declare variable coditcompra integer;
declare variable codemppd integer;
declare variable codfilialpd smallint;
declare variable codprod integer;
declare variable refprod varchar(20);
declare variable percdescitcompra numeric(15,5);
declare variable vlrliqitcompra numeric(15,5);
declare variable codempax integer;
declare variable codfilialax smallint;
declare variable codalmox integer;
declare variable codlote varchar(20);
declare variable cloteprod char(1);
declare variable uffor char(2);
declare variable codempnt integer;
declare variable codfilialnt smallint;
declare variable codnat char(4);
declare variable tipofisc char(2);
declare variable percred numeric(9,2);
declare variable codtrattrib char(2);
declare variable origfisc char(1);
declare variable codmens smallint;
declare variable percicmsitcompra numeric(9,2);
declare variable codempif integer;
declare variable codfilialif smallint;
declare variable codfisc char(13);
declare variable coditfisc integer;
declare variable tipost char(2);
declare variable margemvlagr numeric(15,5);
declare variable percipiitcompra numeric(9,2);
declare variable percicmsst numeric(9,2);
declare variable tpredicms char(1);
declare variable redbaseicmsst char(1);
declare variable vlrproditcompra numeric(15,5);
declare variable vlrbaseipiitcompra numeric(15,5);
declare variable vlripiitcompra numeric(15,5);
declare variable vlrbaseicmsitcompra numeric(15,5);
declare variable vlricmsitcompra numeric(15,5);
declare variable vlrbaseicmsbrutitcompra numeric(15,5);
declare variable vlrisentasitcompra numeric(15,5);
declare variable vlroutrasitcompra numeric(15,5);
declare variable vlrbaseicmsstitcompra numeric(15,5);
declare variable vlricmsstitcompra numeric(15,5);
begin

-- Inicialização de variaveis

    select icodfilial from sgretfilial(:codemp, 'LFNATOPER') into :codfilialnt;

    select cp.codemptm, cp.codfilialtm, cp.codtipomov, cp.codempfr,  cp.codfilialfr, cp.codfor, coalesce(fr.siglauf, fr.uffor) uffor
    from cpcompra cp, cpforneced fr
    where cp.codcompra=:codcompra and cp.codfilial=:codfilial and cp.codemp=:codemp and
    fr.codemp=cp.codempfr and fr.codfilial=cp.codfilialfr and fr.codfor=cp.codfor
    into :codemptm, :codfilialtm, :codtipomov, :codempfr, :codfilialfr, :codfor, :uffor ;

-- Busca sequencia de numeração do ítem de compra

    select coalesce(max(coditcompra),0)+1 from cpitcompra where codcompra=:codcompra and codfilial=:codfilial and codemp=:codemp
    into :coditcompra;

-- Informações do item do pedido de compra

    select it.codemppd, it.codfilialpd, it.codprod, it.percdescitcompra, it.vlrliqitcompra, it.vlrproditcompra, it.refprod,
    it.codempax, it.codfilialax, it.codalmox, it.codlote, pd.cloteprod
    from cpitcompra it, eqproduto pd
    where it.coditcompra=:coditcomprapc and it.codcompra=:codcomprapc and it.codfilial=:codfilialpc and it.codemp=:codemppc
    and pd.codemp=it.codemppd and pd.codfilial=it.codfilialpd and pd.codprod=it.codprod
    into :codemppd, :codfilialpd, :codprod, :percdescitcompra, :vlrliqitcompra, :vlrproditcompra, :refprod,
    :codempax, :codfilialax, :codalmox, :codlote, :cloteprod;

-- Buscando a natureza de operação para o ítem de compra

    select codnat from lfbuscanatsp(:codfilial, :codemp, :codfilialpd, :codprod, null, null, null, :codempfr, :codfilialfr, :codfor,
    :codfilialtm, :codtipomov, null)
    into :codnat;
    
    if (:codnat is null) then
    begin
        exception cpitcompraex04 ' produto:' || :refprod; -- NÃO FOI POSSÍVEL ENCONTRAR A NATUREZA DA OPERAÇÃO PARA O ÍTEM
    end

-- Busca informações fiscais para o ítem de compra

    select tipofisc,redfisc,codtrattrib,origfisc,codmens,aliqfisc,codempif,codfilialif,codfisc,coditfisc,tipost,margemvlagr,
    aliqipifisc,aliqfiscintra,tpredicmsfisc,redbasest
    from lfbuscafiscalsp(:codemppd, :codfilialpd, :codprod, :codempfr,:codfilialfr, :codfor,
    :codemptm, :codfilialtm, :codtipomov, 'CP', :codnat,null,null,null,null)
    into :tipofisc, :percred, :codtrattrib, :origfisc, :codmens, :percicmsitcompra, :codempif, :codfilialif, :codfisc, :coditfisc, :tipost,
    :margemvlagr, :percipiitcompra, :percicmsst, :tpredicms, :redbaseicmsst;
    
-- Inicializando valores

    vlrproditcompra = :precoitcompra * :qtditcompra;
    vlrliqitcompra = :vlrproditcompra - :vlrdescitcompra;
    vlrbaseipiitcompra = 0;
    vlrbaseicmsitcompra = 0;
    vlricmsitcompra = 0;
    vlripiitcompra = 0;

    if (:percicmsitcompra = 0 or :percicmsitcompra is null) then
    begin
        select coalesce(percicms, 0) from lfbuscaicmssp (:codnat, :uffor,:codemp, :codfilial) into :percicmsst;
    end

    if (:percred is null) then
    begin
        percred = 0;
    end

    if(percred>0) then
    begin
        if(:tpredicms='B') then
        begin
            vlrbaseicmsitcompra = (:vlrproditcompra - :vlrdescitcompra) - ( (:vlrproditcompra - :vlrdescitcompra) * ( :percred / 100 ) );
        end
        else if(:tpredicms='V') then
        begin
            vlricmsitcompra = (:vlrbaseicmsitcompra * ( :percicmsitcompra / 100 )) -  ( (:vlrbaseicmsitcompra * ( :percicmsitcompra / 100 ) * ( :percred / 100 ) )) ;
        end
    end
    else
    begin
        vlrbaseicmsitcompra = :vlrproditcompra - :vlrdescitcompra;
        vlricmsitcompra = :vlrbaseicmsitcompra * ( :percicmsitcompra / 100 );
    end

    vlrbaseipiitcompra = :vlrproditcompra - :vlrdescitcompra;
    vlrbaseicmsbrutitcompra = :vlrproditcompra - :vlrdescitcompra;
    vlripiitcompra = :vlrbaseipiitcompra * ( :percipiitcompra / 100 );

-- **** Calculo dos tributos ***

    -- Se produto for isento de ICMS
    if (:tipofisc = 'II') then
    begin
        vlrisentasitcompra = :vlrliqitcompra;
        vlrbaseicmsitcompra = 0;
        percicmsitcompra = 0;
        vlricmsitcompra = 0;
        vlroutrasitcompra = 0;
    end
    -- Se produto for de Substituição Tributária
    else if (:tipofisc = 'FF') then
    begin
        if (:tipost = 'SI' ) then -- Contribuinte Substituído
        begin
            vlroutrasitcompra = :vlrliqitcompra;
            vlrbaseicmsitcompra = 0;
            percicmsitcompra = 0;
            vlricmsitcompra = 0;
            vlrisentasitcompra = 0;
        end
        else if (:tipost = 'SU' ) then -- Contribuinte Substituto
        begin

            if( (:percicmsst is null) or (:percicmsst=0) ) then
            begin
                select coalesce(percicmsintra,0) from lfbuscaicmssp (:codnat,:uffor,:codemp,:codfilial)
                into :percicmsst;
            end

            if(percred>0 and redbaseicmsst='S') then
            begin
            -- Quando há redução na base do icms st , deve usar o valor da base do icms proprio como parametro
               vlrbaseicmsstitcompra = (  (coalesce(:margemvlagr,0) + 100) / 100 )  * (  (coalesce(:vlrbaseicmsitcompra,0) ) + (coalesce(:vlripiitcompra,0)) );
            end
            else
            begin
                -- Quando não há redução na base do icms st deve usar o valor da base bruto (rem redução)
                vlrbaseicmsstitcompra = (  (coalesce(:margemvlagr,0) + 100) / 100 )  * (  (coalesce(:vlrbaseicmsbrutitcompra,0) ) + (coalesce(:vlripiitcompra,0)) );
            end

            vlroutrasitcompra = 0;
            vlrisentasitcompra = 0;
            vlricmsstitcompra = ( (:vlrbaseicmsstitcompra * :percicmsst) / 100 ) - (:vlricmsitcompra) ;

        end
    end

    -- Se produto não for tributado e não isento

    else if (:tipofisc = 'NN') then
    begin
        vlroutrasitcompra = :vlrliqitcompra;
        vlrbaseicmsitcompra = 0;
        percicmsitcompra = 0;
        vlricmsitcompra = 0;
        vlrisentasitcompra = 0;
    end

    -- Se produto for tributado integralmente

    else if (:tipofisc = 'TT') then
    begin
        vlroutrasitcompra = 0;
        vlrisentasitcompra = 0;
    end

    -- Inserindo dados na tabela de ítens de compra

    if ( :tpagrup <> 'F' ) then
    begin

        insert into cpitcompra (codemp, codfilial, codcompra, coditcompra, codempnt, codfilialnt, codnat, codemppd,
        codfilialpd, codprod, codemple, codfilialle, codlote, qtditcompra, precoitcompra, percdescitcompra,vlrdescitcompra,
        percicmsitcompra,vlrbaseicmsitcompra,vlricmsitcompra,percipiitcompra,vlrbaseipiitcompra,vlripiitcompra,vlrliqitcompra,
        vlrproditcompra,refprod, codempax,codfilialax,codalmox, codempif,codfilialif,codfisc,coditfisc,vlrisentasitcompra, vlroutrasitcompra)
        values (:codemp, :codfilial, :codcompra, :coditcompra, :codemp, :codfilialnt, :codnat, :codemp,:codfilialpd, :codprod,
        :codemp, :codfilialpd, :codlote, :qtditcompra, :precoitcompra,:percdescitcompra,:vlrdescitcompra,:percicmsitcompra,:vlrbaseicmsitcompra,
        :vlricmsitcompra, :percipiitcompra, :vlrbaseipiitcompra, :vlripiitcompra, :vlrliqitcompra,:vlrproditcompra,:refprod,
        :codempax, :codfilialax, :codalmox, :codempif, :codfilialif, :codfisc, :coditfisc, :vlrisentasitcompra,:vlroutrasitcompra
        );
    end

-- Atualizando informações de vínculo

    execute procedure cpupcomprapedsp(:codemp, :codfilial,:codcompra, :coditcompra, :codemppc, :codfilialpc, :codcomprapc, :coditcomprapc);

end
^

/* Alter (CPGERAENTRADASP) */
ALTER PROCEDURE CPGERAENTRADASP(CODEMP INTEGER,
CODFILIAL INTEGER,
CODFILIALVD INTEGER,
TIPOVENDA CHAR(1),
CODVENDA INTEGER,
CITEM CHAR(1))
 RETURNS(CODCOMPRA INTEGER)
 AS
DECLARE VARIABLE STATUSVENDA CHAR(2);
DECLARE VARIABLE CODCLI INTEGER;
DECLARE VARIABLE CODFILIALCL INTEGER;
DECLARE VARIABLE CODFILIALCP INTEGER;
DECLARE VARIABLE CODTIPOMOV INTEGER;
DECLARE VARIABLE CODFILIALTM INTEGER;
DECLARE VARIABLE SERIE INTEGER;
DECLARE VARIABLE CODFILIALSE INTEGER;
DECLARE VARIABLE DOC INTEGER;
DECLARE VARIABLE CODFOR INTEGER;
DECLARE VARIABLE CODFILIALFR INTEGER;
DECLARE VARIABLE CODITVENDA INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'CPFORNECED') INTO CODFILIALFR;
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'CPCOMPRA') INTO CODFILIALCP;
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'VDCLINTE') INTO CODFILIALCL;

  SELECT ISEQ FROM SPGERANUM(:CODEMP,:CODFILIAL,'CP') INTO CODCOMPRA;

  SELECT CODCLI,CODFILIALCL,STATUSVENDA FROM VDVENDA WHERE CODVENDA=:CODVENDA AND TIPOVENDA=:TIPOVENDA
    AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL INTO CODCLI,CODFILIALCL,STATUSVENDA;
  IF (SUBSTRING (STATUSVENDA FROM 1 FOR 1) = 'C') THEN
    EXCEPTION VDVENDAEX05;
  
  SELECT CODFOR FROM CPADICFORSP(:CODEMP,:CODFILIAL,:CODFILIALCL,:CODCLI) INTO CODFOR;

  SELECT P.CODTIPOMOV5,P.CODFILIALT5,
    T.SERIE,T.CODFILIALSE FROM SGPREFERE1 P, EQTIPOMOV T WHERE P.CODEMP=:CODEMP
    AND P.CODFILIAL=:CODFILIAL AND T.CODTIPOMOV=P.CODTIPOMOV5 AND
    T.CODEMP=P.CODEMPT5 AND T.CODFILIAL=P.CODFILIALT5
    INTO CODTIPOMOV,CODFILIALTM,SERIE,CODFILIALSE;

  SELECT * FROM LFNOVODOCSP(:SERIE,:CODEMP,:CODFILIALSE) INTO DOC;

  INSERT INTO CPCOMPRA (CODEMP,CODFILIAL,CODCOMPRA,CODEMPPG,CODFILIALPG,CODPLANOPAG,
                        CODEMPFR,CODFILIALFR,CODFOR,CODEMPSE,CODFILIALSE,SERIE,
                        CODEMPTM,CODFILIALTM,CODTIPOMOV,DOCCOMPRA,DTENTCOMPRA,DTEMITCOMPRA)
                 SELECT :CODEMP,:CODFILIAL,:CODCOMPRA,CODEMPPG,CODFILIALPG,CODPLANOPAG,
                        :CODEMP,:CODFILIALFR,:CODFOR,:CODEMP,:CODFILIALSE,:SERIE,
                        CODEMP,:CODFILIALTM,:CODTIPOMOV,:DOC,DTSAIDAVENDA,DTEMITVENDA FROM
                        VDVENDA WHERE CODEMP=:CODEMP AND CODFILIAL=:CODFILIALVD AND
                        CODVENDA=:CODVENDA AND TIPOVENDA=:TIPOVENDA;
  IF (CITEM = 'S') THEN
    EXECUTE PROCEDURE CPGERAITENTRADASP(:CODEMP,:CODFILIALCP,:CODCOMPRA,:CODFILIALVD,:TIPOVENDA,:CODVENDA,NULL,NULL);
    
  UPDATE VDVENDA SET STATUSVENDA='DV' WHERE TIPOVENDA=:TIPOVENDA AND CODVENDA=:CODVENDA
    AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIALVD;
  
  SUSPEND;
END
^

/* Alter (CPGERAITENTRADASP) */
ALTER PROCEDURE CPGERAITENTRADASP(CODEMP INTEGER,
CODFILIAL INTEGER,
CODCOMPRA INTEGER,
CODFILIALVD INTEGER,
TIPOVENDA CHAR(1),
CODVENDA INTEGER,
CODITVENDA INTEGER,
QTDIT INTEGER)
 AS
declare variable coditcompra integer;
declare variable codfilialtm integer;
declare variable codtipomov integer;
declare variable codfilialfr integer;
declare variable codfor integer;
declare variable codnat char(4);
declare variable codfilialnt integer;
declare variable percicmsitcompra numeric(9,2);
declare variable codfilialpd integer;
declare variable codprod integer;
declare variable codfilialle integer;
declare variable codlote varchar(20);
declare variable qtditvenda numeric(18,3);
declare variable qtddevitvenda numeric(18,3);
declare variable precoitvenda numeric(18,3);
declare variable percdescitvenda numeric(15,5);
declare variable vlrdescitvenda numeric(18,3);
declare variable percicmsitvenda numeric(9,2);
declare variable vlrbaseicmsitvenda numeric(18,3);
declare variable vlricmsitvenda numeric(18,3);
declare variable percipiitvenda numeric(9,2);
declare variable vlrbaseipiitvenda numeric(18,3);
declare variable vlripiitvenda numeric(18,3);
declare variable vlrliqitvenda numeric(18,3);
declare variable vlradicitvenda numeric(18,3);
declare variable vlrfreteitvenda numeric(18,3);
declare variable vlrisentasitvenda numeric(18,3);
declare variable vlroutrasitvenda numeric(18,3);
declare variable vlrproditvenda numeric(18,3);
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'LFNATOPER') INTO CODFILIALNT;
  SELECT CODFOR,CODFILIALFR,CODTIPOMOV,CODFILIALTM FROM CPCOMPRA WHERE CODCOMPRA=:CODCOMPRA
    AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL INTO
    :CODFOR,:CODFILIALFR,:CODTIPOMOV,:CODFILIALTM;
  FOR SELECT CODITVENDA,CODFILIALPD,CODPROD,CODFILIALLE,CODLOTE,
             QTDITVENDA,PRECOITVENDA,PERCDESCITVENDA,VLRDESCITVENDA,PERCICMSITVENDA,
             VLRBASEICMSITVENDA,VLRICMSITVENDA,PERCIPIITVENDA,VLRBASEIPIITVENDA,
             VLRIPIITVENDA,VLRLIQITVENDA,VLRADICITVENDA,VLRFRETEITVENDA,VLRISENTASITVENDA,
             VLROUTRASITVENDA,VLRPRODITVENDA,VLRPRODITVENDA FROM VDITVENDA WHERE
             CODEMP=:CODEMP AND CODFILIAL=:CODFILIALVD AND CODVENDA=:CODVENDA AND TIPOVENDA=:TIPOVENDA AND
             (:CODITVENDA IS NULL OR CODITVENDA=:CODITVENDA)
             ORDER BY CODITVENDA INTO CODITCOMPRA,CODFILIALPD,CODPROD,CODFILIALLE,CODLOTE,
             QTDITVENDA,PRECOITVENDA,PERCDESCITVENDA,VLRDESCITVENDA,PERCICMSITVENDA,
             VLRBASEICMSITVENDA,VLRICMSITVENDA,PERCIPIITVENDA,VLRBASEIPIITVENDA,
             VLRIPIITVENDA,VLRLIQITVENDA,VLRADICITVENDA,VLRFRETEITVENDA,VLRISENTASITVENDA,
             VLROUTRASITVENDA,VLRPRODITVENDA,VLRPRODITVENDA DO
  BEGIN
      IF (QTDIT IS NULL) THEN
        QTDIT = QTDITVENDA;
      SELECT SUM(QTDDEV) FROM CPCOMPRAVENDA WHERE TIPOVENDA=:TIPOVENDA
        AND CODVENDA=:CODVENDA AND CODITVENDA=:CODITVENDA
        AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL INTO QTDDEVITVENDA;
      IF (QTDIT > QTDITVENDA OR QTDIT+QTDDEVITVENDA > QTDITVENDA) THEN
        EXCEPTION VDVENDAEX01 'O ITEM: '||CAST(CODITVENDA AS CHAR(3))||' DO PEDIDO: '||
          CAST(CODVENDA AS CHAR(6))||' JA FOI DEVOLVIDO!';
        
      SELECT CODNAT FROM LFBUSCANATSP (:CODFILIAL,:CODEMP,:CODFILIALPD,:CODPROD,NULL,NULL,NULL,
                                   :CODEMP,:CODFILIALFR,:CODFOR,:CODFILIALTM,:CODTIPOMOV,null) INTO CODNAT;

      INSERT INTO CPITCOMPRA (CODEMP,CODFILIAL,CODCOMPRA,CODITCOMPRA,CODEMPPD,CODFILIALPD,CODPROD,
                              CODEMPLE,CODFILIALLE,CODLOTE,CODEMPNT,CODFILIALNT,CODNAT,QTDITCOMPRA,
                              PRECOITCOMPRA,PERCDESCITCOMPRA,VLRDESCITCOMPRA,PERCICMSITCOMPRA,
                              VLRBASEICMSITCOMPRA,VLRICMSITCOMPRA,PERCIPIITCOMPRA,VLRBASEIPIITCOMPRA,
                              VLRIPIITCOMPRA,VLRLIQITCOMPRA,VLRADICITCOMPRA,VLRFRETEITCOMPRA,
                              VLRISENTASITCOMPRA,VLROUTRASITCOMPRA,VLRPRODITCOMPRA,CUSTOITCOMPRA)
                       VALUES (:CODEMP,:CODFILIAL,:CODCOMPRA,:CODITCOMPRA,:CODEMP,:CODFILIALPD,:CODPROD,
                              :CODEMP,:CODFILIALLE,:CODLOTE,:CODEMP,:CODFILIALNT,:CODNAT,:QTDIT,
                              :PRECOITVENDA,:PERCDESCITVENDA,:VLRDESCITVENDA,:PERCICMSITVENDA,
                              :VLRBASEICMSITVENDA,:VLRICMSITVENDA,:PERCIPIITVENDA,:VLRBASEIPIITVENDA,
                              :VLRIPIITVENDA,:VLRLIQITVENDA,:VLRADICITVENDA,:VLRFRETEITVENDA,
                              :VLRISENTASITVENDA,:VLROUTRASITVENDA,:VLRPRODITVENDA,:VLRPRODITVENDA);

      INSERT INTO CPCOMPRAVENDA(CODEMP,CODFILIAL,CODCOMPRA,CODITCOMPRA,CODEMPVD,
                                CODFILIALVD,TIPOVENDA,CODVENDA,CODITVENDA,QTDDEV)
                       VALUES (:CODEMP,:CODFILIAL,:CODCOMPRA,:CODITCOMPRA,:CODEMP,
                               :CODFILIALVD,:TIPOVENDA,:CODVENDA,:CODITCOMPRA,:QTDIT);
  END
  SUSPEND;
END
^

/* Alter (CRTOTAL01ISP) */
ALTER PROCEDURE CRTOTAL01ISP(CODEMP INTEGER,
CODFILIAL INTEGER)
 RETURNS(SEQTOT INTEGER)
 AS
declare variable codfilialtt smallint;
begin
  select icodfilial from sgretfilial(:codemp, 'CRTOTAL')
    into :codfilialtt;
  select iseq from spgeranum(:codemp, :codfilialtt, 'TT')
    into :seqtot;
  insert into crtotal (codemp, codfilial, seqtot)
    values(:codemp, :codfilialtt, :seqtot);
  suspend;
end
^

/* Alter (EQGERARMAOSSP) */
ALTER PROCEDURE EQGERARMAOSSP(CODEMPRM INTEGER,
CODFILIALRM INTEGER,
TICKET INTEGER,
CODITRECMERC SMALLINT)
 RETURNS(CODRMA INTEGER)
 AS
declare variable coditos smallint;
declare variable idusu1 char(8);
declare variable codfilialrma smallint;
declare variable codfilialpd smallint;
declare variable coditrma integer;
declare variable refprod varchar(20);
declare variable codtipomov1 integer;
declare variable codccusu1 char(19);
declare variable codfilialccusu1 smallint;
declare variable codfilialtm1 smallint;
declare variable codfilialtm smallint;
declare variable codemppd integer;
declare variable codprod integer;
declare variable codfilialle smallint;
declare variable custompmit numeric(15,5);
declare variable codlote varchar(20);
declare variable codalmox integer;
declare variable qtd numeric(15,2);
declare variable codfilialax smallint;
declare variable codfilialusu1 smallint;
declare variable anoccusu1 smallint;
declare variable statusaprovrmager char(2) = 'PE';
declare variable statusrmager char(2);
declare variable qtdaprov numeric(15,5) = 0;
begin


    -- buscando centro de custo do usuário atual
    select codfilialusu,codfilialccusu,codccusu,anoccusu,idusus
    from sgretinfousu(:codemprm, user)
    into :CODFILIALUSU1,:CODFILIALCCUSU1,:CODCCUSU1,:ANOCCUSU1,:IDUSU1;

    -- Buscando filial da rma
    SELECT ICODFILIAL FROM sgretfilial(:CODEMPRM,'EQRMA')
    into :codfilialrma;

    -- Buscando filial do lote
    SELECT ICODFILIAL FROM sgretfilial(:CODEMPRM,'EQLOTE')
    into :codfilialle;

    -- Buscando filial do tipo de movimento
    SELECT ICODFILIAL FROM sgretfilial(:CODEMPRM,'EQTIPOMOV')
    into :codfilialtm;

    -- buscando tipo de movimento para RMA
    select codfilialt8,codtipomov8 from sgprefere1
    where codemp=:codemprm and codfilial=:codfilialrm
    into :codfilialtm1,:codtipomov1;

    -- Buscado a situação pardrão para RMA
    select coalesce(SITRMAOP,'PE') from sgprefere5 where codemp=:codemprm and
    codfilial=(select icodfilial from sgretfilial(:codemprm,'SGPREFERE5'))
    into :statusrmager;

    if(:statusrmager is null) then
    begin
       statusrmager = 'PE';
    end

    -- Carregando quantidade aprovada...
    QTDAPROV = 0;
    STATUSAPROVRMAGER = 'PE';

    -- Buscando código novo código de RMA.
    select coalesce((max(codrma)+1),1) from
    eqrma where codemp=:codemprm and codfilial=:codfilialrma
    into :codrma;

    -- Inserindo nova RMA
    insert into eqrma (codemp,codfilial,codrma,
                     codempuu,codfilialuu,idusu,
                     codempua,codfilialua,idusuaprov,
                     codempue,codfilialue,idusuexp,
                     codemptm,codfilialtm,codtipomov,
                     codempcc,codfilialcc,anocc,codcc,
                     dtareqrma,dtaaprovrma,dtaexprma,
                     sitrma,sitaprovrma,sitexprma,
                     codempos,codfilialos,ticket,coditrecmerc,motivorma)
                     values
                     (:codemprm,:codfilialrma,:codrma,
                      :codemprm, :codfilialusu1,:idusu1,
                      null,null,null,
                      null,null,null,
                      :codemprm, :codfilialtm1, :codtipomov1,
                      :codemprm,:codfilialccusu1,:anoccusu1,:codccusu1,
                      cast('now' AS DATE),null,null,
                      :STATUSRMAGER,:STATUSAPROVRMAGER,'PE',
                      :codemprm,:codfilialrm,:ticket,:coditrecmerc,
                      'REQUISIÇÃO GERADA PARA ATENDIMENTO À OS:'|| :ticket
    );

    -- Loop nos itens de Ordem de Serviço.

    for select os.coditrecmerc, os.coditos, os.codemppd, os.codfilialpd, os.refprodpd, os.codprodpd, os.qtditos,
    (select ncustompm from eqprodutosp01(os.codemppd, os.codfilialpd, os.codprodpd,null,null,null)) custompmit
    from eqitrecmercitos os
    where os.codemp=:codemprm and os.codfilial=:codfilialrm and os.ticket=:ticket
--    and ( (os.coditrecmerc=:coditrecmerc) or (:coditrecmerc is null) )
    and os.gerarma='S'
    into :coditrecmerc, :coditos, :codemppd, :codfilialpd, :refprod, :codprod, :qtd, :custompmit
    do

    begin

       select coalesce((max(coditrma)+1),1) from eqitrma
       where codemp=:codemprm and codfilial=:codfilialrma and codrma=:codrma
       into :coditrma;

       if(:statusrmager='AF') then
       begin
         STATUSAPROVRMAGER = 'AT';
         QTDAPROV = :qtd;
       end

       insert into eqitrma (CODEMP,CODFILIAL,CODRMA,CODITRMA,
                            CODEMPPD,CODFILIALPD,CODPROD,REFPROD,
                            QTDITRMA,QTDAPROVITRMA,QTDEXPITRMA,PRECOITRMA,
                            CODEMPLE,CODFILIALLE,CODLOTE,
                            CODEMPAX,CODFILIALAX,CODALMOX,
                            SITITRMA,SITAPROVITRMA,SITEXPITRMA,
                            CODEMPOS,CODFILIALOS,TICKET,CODITRECMERC,CODITOS
                            )
                            values
                            (:codemprm,:codfilialrma,:codrma, :coditrma,
                            :codemprm,:codfilialpd,
                            :codprod, :refprod, :qtd, :qtdaprov, 0, :custompmit, :codemprm,
                            :codfilialle,:codlote,
                            :codemprm,:codfilialax,:codalmox,
                            :statusrmager,:statusaprovrmager,'PE',
                            :codemprm, :codfilialrm, :ticket, :coditrecmerc,:coditos
                            );

        update eqitrecmercitos os set os.gerarma='N', os.statusitos='EC'
        where os.codemp=:codemprm and os.codfilial=:codfilialrm and os.ticket=:ticket
        and os.coditrecmerc=:coditrecmerc and os.coditos=:coditos;

        suspend;

   end
end
^

/* empty dependent procedure body */
/* Clear: PPGERAOP for: EQGERARMASP */
/* AssignEmptyBody proc */
ALTER PROCEDURE PPGERAOP(TIPOPROCESS CHAR(1),
CODEMPOP INTEGER,
CODFILIALOP SMALLINT,
CODOP INTEGER,
SEQOP INTEGER,
CODEMPPD INTEGER,
CODFILIALPD SMALLINT,
CODPROD INTEGER,
CODEMPOC INTEGER,
CODFILIALOC SMALLINT,
CODORC INTEGER,
TIPOORC CHAR(1),
CODITORC SMALLINT,
QTDSUGPRODOP NUMERIC(15,5),
DTFABROP DATE,
SEQEST SMALLINT,
CODEMPET INTEGER,
CODFILIALET SMALLINT,
CODEST SMALLINT,
AGRUPDATAAPROV CHAR(1),
AGRUPDTFABROP CHAR(1),
AGRUPCODCLI CHAR(1),
CODEMPCL INTEGER,
CODFILIALCL SMALLINT,
CODCLI INTEGER,
DATAAPROV DATE,
CODEMPCP INTEGER,
CODFILIALCP SMALLINT,
CODCOMPRA INTEGER,
CODITCOMPRA SMALLINT,
JUSTFICQTDPROD VARCHAR(500),
CODEMPPDENTRADA INTEGER,
CODFILIALPDENTRADA SMALLINT,
CODPRODENTRADA INTEGER,
QTDENTRADA NUMERIC(15,5))
 RETURNS(CODOPRET INTEGER,
SEQOPRET SMALLINT)
 AS
 BEGIN EXIT; END
^

/* Alter (EQGERARMASP) */
ALTER PROCEDURE EQGERARMASP(CODEMPOP INTEGER,
CODFILIALOP INTEGER,
CODOP INTEGER,
SEQOP SMALLINT)
 AS
declare variable seqof smallint;
declare variable idusu1 char(8);
declare variable seqitop integer;
declare variable coditrma integer;
declare variable refprod varchar(20);
declare variable codrma integer;
declare variable codtipomov1 integer;
declare variable codccusu1 char(19);
declare variable codfilialccusu1 smallint;
declare variable codfilialpd smallint;
declare variable codfilialtm1 smallint;
declare variable codprod integer;
declare variable codfilialle smallint;
declare variable custompmit numeric(15,5);
declare variable codlote varchar(20);
declare variable codalmox integer;
declare variable qtd numeric(15,2);
declare variable codfilialax smallint;
declare variable codfilialusu1 smallint;
declare variable anoccusu1 smallint;
declare variable statusaprovrmager char(2) = 'PE';
declare variable statusrmager char(2);
declare variable codfilialfase smallint;
declare variable qtdaprov numeric(15,5) = 0;
declare variable codfase integer;
declare variable codempos integer;
declare variable codfilialos smallint;
declare variable ticket integer;
declare variable coditrecmerc integer;
declare variable coditos integer;
begin

    -- Buscando informações do usuário
    select codfilialusu,codfilialccusu,codccusu,anoccusu,idusus
    from sgretinfousu(:codempop, user)
    into :CODFILIALUSU1,:CODFILIALCCUSU1,:CODCCUSU1,:ANOCCUSU1,:IDUSU1;

    -- Buscando preferencias de tipo de movimento para OP
    select codfilialt8,codtipomov8
    from sgprefere1 where codemp=:CODEMPOP and codfilial=(select icodfilial from sgretfilial(:CODEMPOP, 'SGPREFERE1'))
    into :CODFILIALTM1,:CODTIPOMOV1;

    --Buscando informações da OP.
    select op.codempos, op.codfilialos, op.ticket, op.coditrecmerc, op.coditos
    from  ppop op
    where op.codemp=:codempop and op.codfilial=:codfilialop and op.codop=:codop and op.seqop=:seqop
    into :codempos, :codfilialos, :ticket, :coditrecmerc, :coditos;

    -- Buscando preferencias para geração de RMA
    select coalesce(SITRMAOP,'PE') from sgprefere5 where codemp=:CODEMPOP and
    codfilial=(select icodfilial from sgretfilial(:CODEMPOP,'SGPREFERE5'))
    into :STATUSRMAGER;

    QTDAPROV = 0;
    STATUSAPROVRMAGER = 'PE';

    for select codfilialfs,codfase,seqof from ppopfase opf
        where opf.codemp=:CODEMPOP and opf.codfilial=:CODFILIALOP and
        opf.codop=:CODOP and  opf.seqop=:SEQOP and
        (select count(1) from ppitop it
        where it.codemp=:CODEMPOP and it.codfilial=:CODFILIALOP and
        it.codempfs=opf.codempfs and it.codfilialfs=opf.codfilialfs and
        it.codfase=opf.codfase and it.gerarma='S' and
        it.codop=:CODOP and it.seqop=:SEQOP) > 0
        into :codfilialfase,:codfase,:SEQOF do
    begin
        select coalesce((max(codrma)+1),1)
        from eqrma
        where codemp=:CODEMPOP and codfilial=:CODFILIALOP into :CODRMA;

        insert into eqrma (codemp,codfilial,codrma,
                     codempuu,codfilialuu,idusu,
                     codempua,codfilialua,idusuaprov,
                     codempue,codfilialue,idusuexp,
                     codemptm,codfilialtm,codtipomov,
                     codempcc,codfilialcc,anocc,codcc,
                     dtareqrma,dtaaprovrma,dtaexprma,
                     sitrma,sitaprovrma,sitexprma,
                     codempof,codfilialof,codop,seqop,seqof,
                     motivorma, codempos, codfilialos, ticket, coditrecmerc)
                     values
                     (:CODEMPOP,(SELECT ICODFILIAL FROM sgretfilial(:CODEMPOP,'EQRMA')),:CODRMA,
                      :CODEMPOP, :CODFILIALUSU1,:IDUSU1,
                      null,null,null,
                      null,null,null,
                      :CODEMPOP,(SELECT ICODFILIAL FROM sgretfilial(:CODEMPOP,'EQTIPOMOV')),
                      :CODTIPOMOV1,
                      :CODEMPOP,:CODFILIALCCUSU1,:ANOCCUSU1,:CODCCUSU1,
                      cast('now' AS DATE),null,null,
                      :STATUSRMAGER,:STATUSAPROVRMAGER,'PE',
                      :CODEMPOP,:CODFILIALOP,:CODOP,:SEQOP,:SEQOF,
                      'REQUISIÇÃO GERADA PARA ATENDIMENTO À OP:'||:CODOP||' SEQ:'||:SEQOP||' - FASE:'||:CODFASE,
                      :codempos, :codfilialos, :ticket, :coditrecmerc
        );

        for select it.seqitop,it.codfilialpd,it.codprod,it.refprod,it.qtditop-coalesce(it.qtdcopiaitop,0),it.codfilialle,it.codlote,
            (select ncustompm from eqprodutosp01(it.codemppd,it.codfilialpd,it.codprod,null,null,null)),
            (SELECT CODFILIALAX FROM EQPRODUTO WHERE CODEMP=it.codemppd and codfilial=it.codfilialpd and codprod=it.codprod),
            (SELECT CODALMOX FROM EQPRODUTO WHERE CODEMP=it.codemppd and codfilial=it.codfilialpd and codprod=it.codprod)
            from ppitop it, eqproduto pd
            where
            pd.codemp=it.codemppd and pd.codfilial=it.codfilialpd and pd.codprod=it.codprod
            and it.codemp=:CODEMPOP and it.codfilial=:CODFILIALOP
            and it.codop=:CODOP and it.seqop=:SEQOP and it.codempfs=:CODEMPOP
            and it.codfilialfs=:CODFILIALFASE
            and it.codfase = :CODFASE and it.gerarma='S'
            and (('S'=(select ratauto from sgprefere5 where codemp=it.codemp and codfilial=it.codfilial))
            and (it.qtditop-coalesce(it.qtdcopiaitop, 0))<=(SELECT L.SLDLOTE FROM EQLOTE L
                                                            WHERE L.CODEMP=it.codemple AND L.CODFILIAL=it.codfilialle AND
                                                            L.CODPROD=it.codprod AND L.CODLOTE=it.codlote)
            or pd.cloteprod = 'N'
                                                            )
            into :SEQITOP, :CODFILIALPD,:CODPROD,:REFPROD,:QTD,
            :CODFILIALLE,:CODLOTE,:CUSTOMPMIT,:CODFILIALAX,:CODALMOX  DO
        begin
            select coalesce((max(coditrma)+1),1) from eqitrma
            where codemp=:CODEMPOP and codfilial=:CODFILIALOP and
            codrma=:CODRMA into :coditrma;

            if(:STATUSRMAGER='AF')then
            begin
                STATUSAPROVRMAGER = 'AT';
                QTDAPROV = :QTD;
            end

            insert into eqitrma (CODEMP,CODFILIAL,CODRMA,CODITRMA,
                            CODEMPPD,CODFILIALPD,CODPROD,REFPROD,
                            QTDITRMA,QTDAPROVITRMA,QTDEXPITRMA,PRECOITRMA,
                            CODEMPLE,CODFILIALLE,CODLOTE,
                            CODEMPAX,CODFILIALAX,CODALMOX,
                            SITITRMA,SITAPROVITRMA,SITEXPITRMA,
                            codempos, codfilialos, ticket, coditrecmerc, coditos
                            )
                            values
                            (:CODEMPOP,(SELECT ICODFILIAL FROM sgretfilial(:CODEMPOP,'EQITRMA')),:CODRMA,
                            :coditrma,
                            :CODEMPOP,(SELECT ICODFILIAL FROM sgretfilial(:CODEMPOP,'EQPRODUTO')),
                            :CODPROD,:REFPROD,:QTD,:QTDAPROV,0,:CUSTOMPMIT,:CODEMPOP,(SELECT ICODFILIAL FROM sgretfilial(:CODEMPOP,'EQLOTE')),:CODLOTE,
                            :CODEMPOP,:CODFILIALAX,:CODALMOX,
                            :STATUSRMAGER,:STATUSAPROVRMAGER,'PE',
                            :codempop, :codfilialos, :ticket, :coditrecmerc, :coditos
                            );

            update ppitop it set it.gerarma='N' where it.CODEMP=:CODEMPOP AND
                it.CODFILIAL=:CODFILIALOP AND
                it.codop=:CODOP and it.seqop=:SEQOP and it.seqitop=:seqitop;

        end

    end

    suspend;

end
^

/* Alter (EQMOVPRODIUDSP) */
ALTER PROCEDURE EQMOVPRODIUDSP(CIUD CHAR(1),
ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
SEQSUBPROD SMALLINT)
 AS
declare variable cmultialmox char(1);
begin
  /* Procedure que controle INSERT, UPDATE E DELETE da tabela eqmovprod */

  /* Linha incluida para passar como parâmetro se é multi almoxarifado
      Como o objetivo de evitar I/O
  */
  SELECT CMULTIALMOX FROM SGRETMULTIALMOXSP(:ICODEMPPD) INTO :CMULTIALMOX;
  
  if (CIUD='I') then /* SE FOR INSERT */
     execute procedure EQMOVPRODISP( ICODEMPPD, SCODFILIALPD, ICODPROD,
         ICODEMPLE, SCODFILIALLE, CCODLOTE, ICODEMPTM, SCODFILIALTM, ICODTIPOMOV,
         ICODEMPIV, SCODFILIALIV, ICODINVPROD, ICODEMPCP, SCODFILIALCP, ICODCOMPRA,
         SCODITCOMPRA, ICODEMPVD, SCODFILIALVD, CTIPOVENDA, ICODVENDA, SCODITVENDA,
         ICODEMPRM, SCODFILIALRM, ICODRMA, SCODITRMA,
         ICODEMPOP, SCODFILIALOP, ICODOP, SSEQOP, sseqentop,
         ICODEMPNT, SCODFILIALNT,
         CCODNAT, DDTMOVPROD, IDOCMOVPROD, CFLAG, NQTDMOVPROD, NPRECOMOVPROD,
         ICODEMPAX, SCODFILIALAX, ICODALMOX, CMULTIALMOX, :seqsubprod);
  else if (CIUD='U') then
     execute procedure EQMOVPRODUSP( ICODEMPPD, SCODFILIALPD, ICODPROD,
         ICODEMPLE, SCODFILIALLE, CCODLOTE, ICODEMPTM, SCODFILIALTM, ICODTIPOMOV,
         ICODEMPIV, SCODFILIALIV, ICODINVPROD, ICODEMPCP, SCODFILIALCP, ICODCOMPRA,
         SCODITCOMPRA, ICODEMPVD, SCODFILIALVD, CTIPOVENDA, ICODVENDA, SCODITVENDA,
         ICODEMPRM, SCODFILIALRM, ICODRMA, SCODITRMA,
         ICODEMPOP, SCODFILIALOP, ICODOP, SSEQOP, sseqentop,
         ICODEMPNT, SCODFILIALNT,
         CCODNAT, DDTMOVPROD, IDOCMOVPROD, CFLAG, NQTDMOVPROD, NPRECOMOVPROD,
         ICODEMPAX, SCODFILIALAX, ICODALMOX, CMULTIALMOX,:seqsubprod);
  else if (CIUD='D') then
     execute procedure EQMOVPRODDSP( ICODEMPPD, SCODFILIALPD, ICODPROD, ICODEMPIV,
         SCODFILIALIV, ICODINVPROD, ICODEMPCP, SCODFILIALCP, ICODCOMPRA, SCODITCOMPRA,
         ICODEMPVD, SCODFILIALVD, CTIPOVENDA, ICODVENDA, SCODITVENDA,
         ICODEMPRM, SCODFILIALRM, ICODRMA, SCODITRMA,
         ICODEMPOP, SCODFILIALOP, ICODOP, SSEQOP, sseqentop,
         DDTMOVPROD, ICODEMPAX, SCODFILIALAX, ICODALMOX, CMULTIALMOX, :seqsubprod );
--  suspend;
end
^

/* empty dependent procedure body */
/* Clear: EQMOVPRODISP for: EQMOVPRODSEQSP */
/* AssignEmptyBody proc */
ALTER PROCEDURE EQMOVPRODISP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD SMALLINT)
 AS
 BEGIN EXIT; END
^

/* Alter (EQMOVPRODSEQSP) */
ALTER PROCEDURE EQMOVPRODSEQSP(ICODEMP INTEGER)
 RETURNS(SCODFILIAL SMALLINT,
ICODMOVPROD INTEGER)
 AS
begin
  /* Busca o código sequencial da tabela eqmovprod */
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP, 'EQMOVPROD') INTO :SCODFILIAL ;
  SELECT ISEQ FROM SPGERANUM(:ICODEMP, :SCODFILIAL, 'MP' ) INTO :ICODMOVPROD ;
  suspend;
end
^

/* Alter (EQRELINVPRODSP) */
ALTER PROCEDURE EQRELINVPRODSP(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
CTIPOCUSTO CHAR(1),
ICODEMPGP INTEGER,
SCODFILIALGP SMALLINT,
CCODGRUP CHAR(14),
DDTESTOQ DATE,
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER)
 RETURNS(CODPROD INTEGER,
REFPROD VARCHAR(20),
DESCPROD CHAR(100),
CODGRUP CHAR(14),
SALDO NUMERIC(15,5),
CUSTO NUMERIC(15,5),
VLRESTOQ NUMERIC(15,5))
 AS
declare variable cmultialmox char(1);
declare variable ncustompm numeric(15,5);
begin
  /* Relatório de estoque */
  SELECT CMULTIALMOX FROM SGRETMULTIALMOXSP(:ICODEMP) INTO :CMULTIALMOX;

  if (CCODGRUP IS NOT NULL) then
  begin
     CCODGRUP = rtrim(CCODGRUP);
     if (strlen(CCODGRUP)<14) then
        CCODGRUP = CCODGRUP || '%';
  end
  FOR SELECT P.CODPROD, P.REFPROD, P.DESCPROD, P.CODGRUP
    FROM EQPRODUTO P
    WHERE P.CODEMP=:ICODEMP AND P.CODFILIAL=:SCODFILIAL AND
          ( ( :CCODGRUP IS NULL ) OR
            (P.CODGRUP LIKE :CCODGRUP AND P.CODEMPGP=:ICODEMPGP AND
             P.CODFILIALGP=:SCODFILIALGP) )
    INTO :CODPROD, :REFPROD, :DESCPROD, :CODGRUP DO
  BEGIN
     SELECT NSALDO, NCUSTOMPM FROM EQMOVPRODSLDSP(null, null, null, :ICODEMP,
        :SCODFILIAL, :CODPROD, :DDTESTOQ, 0, 0,
        :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
       INTO :SALDO, :NCUSTOMPM;
     if (CTIPOCUSTO='M') then
        CUSTO = NCUSTOMPM;
     else
        SELECT NCUSTOPEPS FROM EQCALCPEPSSP(:ICODEMP, :SCODFILIAL, :CODPROD,
          :SALDO, :DDTESTOQ, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX)
        INTO :CUSTO;
     VLRESTOQ = CUSTO * SALDO;
     SUSPEND;
  END
end
^

/* Alter (EQRELPEPSSP) */
ALTER PROCEDURE EQRELPEPSSP(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
DTESTOQ DATE,
ICODEMPMC INTEGER,
SCODFILIALMC SMALLINT,
CCODMARCA CHAR(6),
ICODEMPGP INTEGER,
SCODFILIALGP SMALLINT,
CCODGRUP VARCHAR(14),
CTIPOCUSTO CHAR(1),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER)
 RETURNS(CODPROD INTEGER,
REFPROD VARCHAR(20),
DESCPROD CHAR(100),
SLDPROD NUMERIC(15,5),
CUSTOUNIT NUMERIC(15,5),
CUSTOTOT NUMERIC(15,5),
CODBARPROD CHAR(13),
CODFABPROD CHAR(15),
ATIVOPROD CHAR(1),
CODUNID CHAR(20),
TIPOPROD VARCHAR(2),
CODNCM VARCHAR(10),
EXTIPI CHAR(2),
COD_GEN CHAR(2),
CODSERV CHAR(5),
ALIQ_ICMS NUMERIC(9,2))
 AS
begin

  /* procedure text */

  if (icodempgp is not null) then
  begin
    if (strlen(rtrim(ccodgrup))<14) then
       ccodgrup = rtrim(ccodgrup)||'%';
  end

  if (ctipocusto is null) then
     ctipocusto = 'P';

  for select p.codprod,p.refprod,p.descprod, p.codbarprod
     , p.codfabprod, p.ativoprod, p.codunid, p.tipoprod
     , fc.codncm, fc.extipi
     , substring(fc.codncm from 1 for 2) cod_gen
     , fc.codserv,
      (select first 1 ifc.aliqfisc from lfitclfiscal ifc where ifc.codemp=fc.codemp and ifc.codfilial=fc.codfilial and
      ifc.geralfisc='S' and ifc.noufitfisc='S') aliq_icms

   from eqproduto p
   left outer join lfclfiscal fc
     on fc.codemp=p.codempfc and fc.codfilial=p.codfilialfc and fc.codfisc=p.codfisc
   where p.codemp = :icodemp and p.codfilial = :scodfilial and
   ( (:icodempmc is null) or (p.codempmc=:icodempmc and p.codfilialmc=:scodfilialmc and
      p.codmarca=:ccodmarca) ) and
   ((:icodempgp is null) or (p.codempgp=:icodempgp and p.codfilialgp=:scodfilialgp and
      p.codgrup like :ccodgrup) )
      order by p.codprod

   into :codprod, :refprod, :descprod, :codbarprod, :codfabprod
   , :ativoprod, :codunid, :tipoprod
   , :codncm, :extipi, :cod_gen, :codserv, :aliq_icms  do

  begin

     select sldprod, custounit, custotot from eqcustoprodsp(:icodemp,
        :scodfilial, :codprod, :dtestoq, :ctipocusto, :icodempax,
        :scodfilialax, :icodalmox, 'S')
       into :sldprod, :custounit, :custotot;
     suspend;

  end

end
^

/* Alter (FNADICLANCASP01) */
ALTER PROCEDURE FNADICLANCASP01(ICODREC INTEGER,
INPARCITREC INTEGER,
PDVITREC CHAR(1),
SNUMCONTA CHAR(10),
ICODEMPCA INTEGER,
ICODFILIALCA INTEGER,
ICODCLI INTEGER,
ICODEMPCL INTEGER,
ICODFILIALCL INTEGER,
SCODPLAN CHAR(13),
ICODEMPPN INTEGER,
ICODFILIALPN INTEGER,
IANOCC INTEGER,
SCODCC CHAR(19),
ICODEMPCC INTEGER,
ICODFILIALCC INTEGER,
DDTCOMPITREC DATE,
DDTPAGOITREC DATE,
SDOCLANCAITREC VARCHAR(15),
SOBSITREC CHAR(250),
DVLRPAGOITREC NUMERIC(15,5),
ICODEMP INTEGER,
ICODFILIAL SMALLINT,
DVLRPAGOJUROS NUMERIC(15,5),
DVLRDESC NUMERIC(15,5))
 AS
declare variable icodlanca integer;
declare variable scodplanconta char(13);
declare variable icodemppconta integer;
declare variable icodfilialpconta integer;
declare variable cflag char(1);
declare variable ifiliallanca integer;
declare variable tipolanca char(1);
declare variable codempjr integer;
declare variable codfilialjr smallint;
declare variable codplanjr char(13);
declare variable codempdc integer;
declare variable codfilialdc smallint;
declare variable codplandc char(13);
declare variable codsublanca smallint = 1;
BEGIN
    SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNLANCA') INTO IFILIALLANCA;

    SELECT CODPLAN,CODEMPPN,CODFILIALPN FROM FNCONTA WHERE NUMCONTA = :SNUMCONTA
        AND CODEMP=:ICODEMPCA AND CODFILIAL=:ICODFILIALCA INTO :sCodPlanConta,:iCodEmpPConta,:iCodFilialPConta;

    SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALLANCA,'LA') INTO ICODLANCA;

    SELECT FLAG FROM FNRECEBER WHERE CODREC=:ICODREC
        AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO :cFlag;

    SELECT CODEMPJR,CODFILIALJR,CODPLANJR,CODEMPDC,CODFILIALDC,CODPLANDC FROM SGPREFERE1
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
        INTO :CODEMPJR,:CODFILIALJR,:CODPLANJR,:CODEMPDC,:CODFILIALDC,:CODPLANDC;


    IF (ICODCLI IS NULL) THEN
        TIPOLANCA = 'A';
    ELSE
        TIPOLANCA = 'C';

    if ( (DVLRPAGOJUROS IS NULL) OR (:CODPLANJR IS NULL)  ) then
        DVLRPAGOJUROS = 0;
    else
        DVLRPAGOITREC = DVLRPAGOITREC - DVLRPAGOJUROS;

    if (DVLRDESC IS NULL  OR (:CODPLANDC IS NULL) ) then
        DVLRDESC = 0;
    else
        DVLRPAGOITREC = DVLRPAGOITREC + DVLRDESC;


    INSERT INTO FNLANCA (TIPOLANCA,CODEMP,CODFILIAL,CODLANCA,CODEMPRC,CODFILIALRC,CODREC,NPARCITREC,CODEMPPN,CODFILIALPN,CODPLAN, 
        DTCOMPLANCA, DATALANCA, DOCLANCA,HISTBLANCA,DTPREVLANCA,VLRLANCA,FLAG,CODEMPCL,CODFILIALCL,CODCLI,PDVITREC)
        VALUES (:TIPOLANCA,:ICODEMP,:IFILIALLANCA,:iCodLanca,:ICODEMP,:ICODFILIAL,:ICODREC,:iNParcItRec,:iCodEmpPConta,:iCodFilialPConta,
                :sCodPlanConta,:dDtCompItRec, :dDtPagoItRec,:sDocLancaItRec,:sObsItRec,:dDtPagoItRec,0,:cFlag,:ICODEMPCL,:ICODFILIALCL,:ICODCLI,:PDVITREC
        );

    INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPCL,CODFILIALCL,CODCLI,CODEMPPN,CODFILIALPN,CODPLAN,
                CODEMPRC, CODFILIALRC, CODREC, NPARCITREC,
    			CODEMPCC, CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA, DTCOMPSUBLANCA, DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,FLAG)
        VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPCL,:ICODFILIALCL,:ICODCLI,:ICODEMPPN,:ICODFILIALPN,:SCODPLAN,
        		:ICODEMP, :ICODFILIAL, :ICODREC, :INPARCITREC,
                :ICODEMPCC,:ICODFILIALCC,:IANOCC,:SCODCC,'S',:dDtCompItRec,:dDtPagoItRec,:dDtPagoItRec,:dVlrPagoItRec*-1,:cFlag
        );

    -- Lançamento dos juros em conta distinta.

    IF(DVLRPAGOJUROS > 0) THEN
    BEGIN

        CODSUBLANCA = CODSUBLANCA + 1;

        INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPCL,CODFILIALCL,CODCLI,CODEMPPN,CODFILIALPN,CODPLAN,
                 CODEMPRC, CODFILIALRC, CODREC, NPARCITREC,
                  CODEMPCC, CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DTCOMPSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,FLAG, TIPOSUBLANCA)
        VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPCL,:ICODFILIALCL,:ICODCLI,:CODEMPJR,:CODFILIALJR,:CODPLANJR,
        		:ICODEMP, :ICODFILIAL, :ICODREC, :INPARCITREC,
                :ICODEMPCC, :ICODFILIALCC,:IANOCC,:SCODCC,'S',:dDtCompItRec,:dDtPagoItRec,:dDtPagoItRec,:DVLRPAGOJUROS*-1,:cFlag, 'J'
        );

    END

    -- Lançamento do desconto em conta distinta.

    IF(DVLRDESC > 0) THEN
    BEGIN

        CODSUBLANCA = CODSUBLANCA + 1;

        INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPCL,CODFILIALCL,CODCLI,CODEMPPN,CODFILIALPN,CODPLAN,
             CODEMPRC, CODFILIALRC, CODREC, NPARCITREC,
             CODEMPCC, CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DTCOMPSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,FLAG, TIPOSUBLANCA)
        VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPCL,:ICODFILIALCL,:ICODCLI,:CODEMPDC,:CODFILIALDC,:CODPLANDC,
       		:ICODEMP, :ICODFILIAL, :ICODREC, :INPARCITREC,
             :ICODEMPCC, :ICODFILIALCC,:IANOCC,:SCODCC,'S',:dDtCompItRec,:dDtPagoItRec,:dDtPagoItRec,:DVLRDESC,:cFlag, 'D'
        );

    END


END
^

/* Alter (FNADICLANCASP02) */
ALTER PROCEDURE FNADICLANCASP02(ICODPAG INTEGER,
INPARCPAG INTEGER,
SNUMCONTA CHAR(10),
ICODEMPCA INTEGER,
ICODFILIALCA INTEGER,
ICODFOR INTEGER,
ICODEMPFR INTEGER,
ICODFILIALFR INTEGER,
SCODPLAN CHAR(13),
ICODEMPPN INTEGER,
ICODFILIALPN INTEGER,
IANOCC INTEGER,
SCODCC CHAR(19),
ICODEMPCC INTEGER,
ICODFILIALCC INTEGER,
DDTCOMPITPAG DATE,
DDTPAGOITPAG DATE,
SDOCLANCAITPAG VARCHAR(15),
SOBSITPAG CHAR(250),
DVLRPAGOITPAG NUMERIC(15,5),
ICODEMP INTEGER,
ICODFILIAL SMALLINT,
DVLRJUROSPAG NUMERIC(15,5),
DVLRDESC NUMERIC(15,5))
 AS
declare variable icodlanca integer;
declare variable scodplanconta char(13);
declare variable icodemppconta integer;
declare variable icodfilialpconta integer;
declare variable cflag char(1);
declare variable ifiliallanca integer;
declare variable tipolanca char(1);
declare variable codempjp integer;
declare variable codfilialjp smallint;
declare variable codplanjp char(13);
declare variable codempdr integer;
declare variable codfilialdr smallint;
declare variable codplandr char(13);
declare variable codsublanca smallint = 1;
BEGIN

    SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNLANCA')
    INTO IFILIALLANCA;

    SELECT CODPLAN,CODEMP,CODFILIAL FROM FNCONTA
    WHERE NUMCONTA=:sNumConta AND CODEMP=:ICODEMPCA AND CODFILIAL=:ICODFILIALCA
    INTO :sCodPlanConta,:iCodEmpPConta,:iCodFilialPConta;

    SELECT ISEQ FROM SPGERANUM(:iCODEMP,:IFILIALLANCA,'LA')
    INTO :iCodLanca;

    SELECT FLAG FROM FNPAGAR
    WHERE CODPAG=:iCodPag AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
    INTO :cFlag;

    SELECT CODEMPJP,CODFILIALJP,CODPLANJP,CODEMPDR,CODFILIALDR,CODPLANDR
    FROM SGPREFERE1
    WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
    INTO :CODEMPJP,:CODFILIALJP,:CODPLANJP,:CODEMPDR,:CODFILIALDR,:CODPLANDR;

    IF (ICODFOR IS NULL) THEN
        TIPOLANCA = 'A';
      ELSE
        TIPOLANCA = 'F';

    if ( (DVLRJUROSPAG IS NULL) OR (:CODPLANJP IS NULL)  ) then
        DVLRJUROSPAG = 0;
    else
        DVLRPAGOITPAG = DVLRPAGOITPAG - DVLRJUROSPAG;

    if (DVLRDESC IS NULL  OR (:CODPLANDR IS NULL) ) then
        DVLRDESC = 0;
    else
        DVLRPAGOITPAG = DVLRPAGOITPAG + DVLRDESC;

    INSERT INTO FNLANCA (TIPOLANCA,CODEMP,CODFILIAL,CODLANCA,CODEMPPG,CODFILIALPG,CODPAG,
                         NPARCPAG,CODEMPPN,CODFILIALPN,CODPLAN,DTCOMPLANCA,DATALANCA,DOCLANCA,
                         HISTBLANCA,DTPREVLANCA,VLRLANCA,FLAG, CODEMPFR, CODFILIALFR, CODFOR)
         VALUES (:TIPOLANCA,:ICODEMP,:IFILIALLANCA,:iCodLanca,:ICODEMP,:ICODFILIAL,:iCodPag,
                 :iNParcPag,:iCodEmpPConta,:iCodFilialPConta,:sCodPlanConta, :dDtCompItPag, :dDtPagoItPag,:sDocLancaItPag,
                 :sObsItPag,:dDtPagoItPag,0,:cFlag, :ICODEMPFR, :ICODFILIALFR, :ICODFOR
         );

    INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPFR,CODFILIALFR,CODFOR,CODEMPPN,CODFILIALPN, CODPLAN,
    	CODEMPPG, CODFILIALPG, CODPAG, NPARCPAG,
    	CODEMPCC,CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DTCOMPSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,FLAG)
        VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPFR,:ICODFILIALFR,:ICODFOR,:ICODEMPPN,:ICODFILIALPN, :sCodplan,
        :ICODEMP,:ICODFILIAL,:iCodPag, :iNParcPag,
        :ICODEMPCC,:ICODFILIALCC,:IANOCC,:SCODCC,'E',:dDtCompItPag,:dDtPagoItPag,:dDtPagoItPag,:dVlrPagoItPag,:cFlag);

    -- Lançamento dos juros em conta distinta.

    IF(DVLRJUROSPAG >0) THEN
    BEGIN

        CODSUBLANCA = CODSUBLANCA + 1;

        INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPFR,CODFILIALFR,CODFOR,
             CODEMPPN,CODFILIALPN,CODPLAN,CODEMPCC,CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DTCOMPSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,
             CODEMPPG, CODFILIALPG, CODPAG, NPARCPAG, FLAG, TIPOSUBLANCA)
            VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPFR,:ICODFILIALFR,:ICODFOR,
            :CODEMPJP,:CODFILIALJP,:CODPLANJP,:ICODEMPCC,:ICODFILIALCC,:IANOCC,:SCODCC,'E',:dDtCompItPag,:dDtPagoItPag,:dDtPagoItPag,:DVLRJUROSPAG,
            :ICODEMP, :ICODFILIAL, :iCodPag, :iNParcPag,:cFlag, 'J');

    END

    -- Lançamento de desconto em conta distinta.

    IF(DVLRDESC >0) THEN
    BEGIN

        CODSUBLANCA = CODSUBLANCA + 1;

        INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPFR,CODFILIALFR,CODFOR,
        CODEMPPN,CODFILIALPN,CODPLAN,CODEMPCC,CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DTCOMPSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,
        	  CODEMPPG, CODFILIALPG, CODPAG, NPARCPAG, FLAG, TIPOSUBLANCA)
            VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPFR,:ICODFILIALFR,:ICODFOR,
             :CODEMPDR,:CODFILIALDR,:CODPLANDR,:ICODEMPCC,:ICODFILIALCC,:IANOCC,:SCODCC,'E',:dDtCompItPag,:dDtPagoItPag,:dDtPagoItPag,:DVLRDESC*-1,
             :ICODEMP, :ICODFILIAL, :iCodPag, :iNParcPag, :cFlag, 'D');

    END

END
^

/* Alter (FNADICPAGARSP01) */
ALTER PROCEDURE FNADICPAGARSP01(CODCOMPRA INTEGER,
ICODEMPPG INTEGER,
ICODFILIALPG SMALLINT,
CODPLANOPAG INTEGER,
ICODEMPFR INTEGER,
ICODFILIALFR SMALLINT,
CODFOR INTEGER,
VLRLIQCOMPRA NUMERIC(18,2),
DTSAIDACOMPRA DATE,
DTCOMPCOMPRA DATE,
DOCCOMPRA INTEGER,
ICODEMPBO INTEGER,
ICODFILIALBO SMALLINT,
CODBANCO CHAR(3),
FLAG CHAR(1),
ICODEMP INTEGER,
ICODFILIAL SMALLINT,
CODEMPTC INTEGER,
CODFILIALTC SMALLINT,
CODTIPOCOB INTEGER,
CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
NUMCONTA CHAR(10),
CODEMPCC INTEGER,
CODFILIALCC SMALLINT,
ANOCC SMALLINT,
CODCC CHAR(19),
CODEMPPN INTEGER,
CODFILIALPN SMALLINT,
CODPLAN CHAR(13),
OBSPAG VARCHAR(250))
 AS
declare variable icodpagar integer;
declare variable ifilialpagar integer;
declare variable numparcs integer;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNPAGAR') INTO IFILIALPAGAR;
  SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALPAGAR,'PA') INTO ICODPAGAR;
  SELECT COALESCE(PARCPLANOPAG,0) FROM FNPLANOPAG WHERE CODEMP=:icodemppg AND CODFILIAL=:icodfilialpg AND codplanopag=:codplanopag
  INTO NUMPARCS;

  IF(numparcs>0) THEN
  BEGIN
      INSERT INTO FNPAGAR (CODEMP,CODFILIAL,CODPAG,CODPLANOPAG,CODEMPPG,CODFILIALPG,CODFOR,CODEMPFR,
                          CODFILIALFR,CODCOMPRA,CODEMPCP,CODFILIALCP,VLRPAG,
                          VLRDESCPAG,VLRMULTAPAG,VLRJUROSPAG,VLRPARCPAG,VLRPAGOPAG,
                          VLRAPAGPAG,DATAPAG, DTCOMPPAG, STATUSPAG,DOCPAG,CODBANCO,CODEMPBO,CODFILIALBO,FLAG,
                          CODEMPTC, CODFILIALTC, CODTIPOCOB,
                          codempca, codfilialca,  numconta, codempcc, codfilialcc, anocc, codcc, codemppn, codfilialpn, codplan, obspag)
                          VALUES (
                                 :ICODEMP,:IFILIALPAGAR,:ICODPAGAR,:CodPlanoPag,:ICODEMPPG,:ICODFILIALPG,:CodFor,:ICODEMPFR,
                                 :ICODFILIALFR,:CodCompra,:ICODEMP,:ICODFILIAL,:VlrLiqCompra,
                                 0,0,0,:VlrLiqCompra,0,:VlrLiqCompra,:dtSaidaCompra, :DTCOMPCOMPRA, 'P1',:DocCompra,
                                 :CodBanco,:ICODEMPBO,:ICODFILIALBO,:FLAG,
                                 :CODEMPTC, :CODFILIALTC, :CODTIPOCOB,
                                 :codempct, :codfilialct, :numconta, :codempcc, :codfilialcc, :anocc, :codcc, :codemppn, :codfilialpn, :codplan, :obspag
                          );
   END
END
^

/* Alter (FNADICPAGARSP02) */
ALTER PROCEDURE FNADICPAGARSP02(CODEMPOC INTEGER,
CODFILIALOC SMALLINT,
CODORDCP INTEGER,
CODEMPPP INTEGER,
CODFILIALPP SMALLINT,
CODPLANOPAG INTEGER,
CODEMPFR INTEGER,
CODFILIALFR SMALLINT,
CODFOR INTEGER,
OBSPAG VARCHAR(2000))
 AS
declare variable codpag integer;
declare variable codfilialpag integer;
declare variable numparcs integer;
declare variable valor decimal(15,5);
declare variable data date;

BEGIN     
    
    -- Buscando filial para tabela FNPAGAR
    select icodfilial from sgretfilial( :codemppp, 'FNPAGAR' ) into :codfilialpag;

    -- Gerando código do pagamento
    select iseq from spgeranum( :codemppp, :codfilialpag, 'PA') into :codpag;

    -- Consultando número de parcelas do plano de pagamento
    select coalesce( parcplanopag, 0 ) from fnplanopag
        where codemp=:codemppp and codfilial=:codfilialpp and codplanopag=:codplanopag
        into :numparcs;

    -- Limpando empenhos anteriores
    delete from fnpagar pg where pg.codempoc=:codempoc and pg.codfilialoc=:codfilialoc and pg.codordcp=:codordcp;

    -- Precorre tabela de previsões de entrega para gerar os empenhos no contas a pagar.
    for select pe.dtitpe data, sum(( io.vlrliqapitordcp/io.qtdapitordcp ) * cast(pe.qtditpe-pe.qtditentpe as decimal(8,2))) valor
        from cpitordcompra io, cpitordcomprape pe
        where
            io.codemp=:codempoc and io.codfilial=:codfilialoc and io.codordcp=:codordcp and
            pe.codemp=io.codemp and pe.codfilial=io.codfilial and pe.codordcp=io.codordcp and pe.coditordcp=io.coditordcp and
            (pe.qtditpe-pe.qtditentpe) >0
        group by pe.dtitpe
        order by pe.dtitpe
        into data, :valor

        do begin
                    
            -- Se existirem parcelas a gerar.

            if( numparcs>0 ) then
            begin

                insert into fnpagar (
                    codemp, codfilial, codpag,
                    codemppg, codfilialpg, codplanopag,
                    codempfr, codfilialfr, codfor,
                    codempoc, codfilialoc, codordcp,
                    vlrpag, vlrparcpag, vlrapagpag,
                    datapag, dtcomppag, statuspag, docpag, obspag )
                values (
                    :codempoc, :codfilialpag, :codpag,
                    :codemppp, :codfilialpp, :codplanopag,
                    :codempfr, :codfilialfr, :codfor,
                    :codempoc, :codfilialoc, :codordcp,
                    :valor, :valor, :valor,
                    :data, :data, 'P1', :codordcp, substring(:obspag from 1 for 250)
                );

                 -- Gerando código do pagamento
                 select iseq from spgeranum( :codemppp, :codfilialpag, 'PA') into :codpag;

            end
     end

END
^

/* Alter (FNADICRECEBERSP01) */
ALTER PROCEDURE FNADICRECEBERSP01(TIPOVENDA CHAR(1),
CODVENDA INTEGER,
CODEMPTC INTEGER,
CODFILIALTC INTEGER,
CODTIPOCOB INTEGER,
CODEMPPG INTEGER,
CODFILIALPG SMALLINT,
CODPLANOPAG INTEGER,
CODEMPCL INTEGER,
CODFILIALCL SMALLINT,
CODCLI INTEGER,
CODEMPVD INTEGER,
CODFILIALVD SMALLINT,
CODVEND INTEGER,
VLRLIQVENDA NUMERIC(15,5),
DTVENDA DATE,
DTCOMP DATE,
VLRCOMISVENDA NUMERIC(15,5),
DOCVENDA INTEGER,
CODEMPBO INTEGER,
CODFILIALBO SMALLINT,
CODBANCO CHAR(3),
CODEMP INTEGER,
CODFILIAL SMALLINT,
CODEMPCB INTEGER,
CODFILIALCB SMALLINT,
CODCARTCOB CHAR(3),
CODEMPCA INTEGER,
CODFILIALCA SMALLINT,
NUMCONTA CHAR(10),
FLAG CHAR(1),
OBSREC VARCHAR(250),
VLRBASECOMIS NUMERIC(15,5),
VLRRETENSAOISS NUMERIC(15,5))
 AS
declare variable codrec integer;
declare variable codfilialrc smallint;
declare variable parcplanopag integer;
BEGIN
  SELECT R.CODREC,R.CODFILIAL FROM FNRECEBER R
     WHERE R.CODEMPVA=:CODEMP AND R.CODFILIALVA=:CODFILIAL AND
       R.TIPOVENDA=:TIPOVENDA AND R.CODVENDA=:CODVENDA
     INTO :CODREC,:CODFILIALRC;
  SELECT PARCPLANOPAG FROM FNPLANOPAG WHERE CODEMP=:CODEMPPG AND
     CODFILIAL=:CODFILIALPG AND CODPLANOPAG=:CODPLANOPAG
     INTO :PARCPLANOPAG;

  IF ( (CODREC IS NULL) AND (PARCPLANOPAG>0) ) THEN
  BEGIN
     SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'FNRECEBER') INTO :CODFILIALRC;
     SELECT ISEQ FROM SPGERANUM(:CODEMP,:CODFILIALRC,'RC') INTO :CODREC;

     -- Caso haja retensão de ISS deve
     if(coalesce(:vlrretensaoiss,0)>0) then
     begin
        vlrliqvenda = vlrliqvenda - vlrretensaoiss;
     end

     INSERT INTO FNRECEBER (CODEMP,CODFILIAL,CODREC, CODTIPOCOB, CODEMPTC, CODFILIALTC,
              CODPLANOPAG,CODEMPPG,CODFILIALPG,CODCLI,
              CODEMPCL,CODFILIALCL,CODVEND,CODEMPVD,CODFILIALVD,TIPOVENDA,CODVENDA,
              CODEMPVA,CODFILIALVA,VLRREC,
              VLRDESCREC,VLRMULTAREC,VLRJUROSREC,VLRPARCREC,VLRPAGOREC,
              VLRAPAGREC,DATAREC, DTCOMPREC, STATUSREC,VLRCOMIREC,DOCREC,CODBANCO,CODEMPBO,CODFILIALBO,
              CODEMPCB, CODFILIALCB, CODCARTCOB, CODEMPCA, CODFILIALCA, NUMCONTA,
              FLAG, OBSREC, vlrbasecomis)
              VALUES (
                     :CODEMP, :CODFILIALRC, :CODREC, :CODTIPOCOB, :CODEMPTC, :CODFILIALTC,
                     :CodPlanoPag, :CODEMPPG, :CODFILIALPG, :CodCli,
                     :CODEMPCL, :CODFILIALCL, :CodVend, :CODEMPVD, :CODFILIALVD, :TIPOVENDA, :CodVenda,
                     :CODEMP, :CODFILIAL, :VlrLiqVenda,
                     0,0,0,:VlrLiqVenda,0,:VlrLiqVenda,:dtVenda, :dtComp, 'R1',
                     :VlrComisVenda,:DocVenda,:CodBanco,:CODEMPBO,:CODFILIALBO,
                     :CODEMPCB, :CODFILIALCB, :CODCARTCOB, 
                     :CODEMPCA, :CODFILIALCA, :NUMCONTA,
                     :FLAG, :OBSREC,:vlrbasecomis
              );
  END
  ELSE IF (CODREC IS NOT NULL) THEN
  BEGIN
    IF (PARCPLANOPAG>0) THEN
    BEGIN
        UPDATE FNRECEBER SET ALTUSUREC='N',
              CODTIPOCOB=:CODTIPOCOB, CODEMPTC=:CODEMPTC, CODFILIALTC=:CODFILIALTC,
              CODPLANOPAG=:CodPlanoPag, CODEMPPG=:CODEMPPG, CODFILIALPG=:CODFILIALPG,
              CODCLI=:CodCli, CODEMPCL=:CODEMPCL, CODFILIALCL=:CODFILIALCL,
              CODVEND=:CodVend, CODEMPVD=:CODEMPVD, CODFILIALVD=:CODFILIALVD,
              VLRREC=:VlrLiqVenda, VLRDESCREC=0, VLRMULTAREC=0, VLRJUROSREC=0,
              VLRPARCREC=:VlrLiqVenda, VLRPAGOREC=0, VLRAPAGREC=:VlrLiqVenda,
              DATAREC=:dtVenda, VLRCOMIREC=:VlrComisVenda,
              /* STATUSREC='R1' */
              DOCREC=:DocVenda, 
              CODEMPBO=:CODEMPBO, CODFILIALBO=:CODFILIALBO, CODBANCO=:CODBANCO,
              CODEMPCB=:CODEMPCB, CODFILIALCB=:CODFILIALCB, CODCARTCOB=:CODCARTCOB,
              CODEMPCA=:CODEMPCA, CODFILIALCA=:CODFILIALCA, NUMCONTA=:NUMCONTA,
              FLAG=:FLAG, vlrbasecomis=:vlrbasecomis
             WHERE CODREC=:CODREC AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIALRC;

        UPDATE FNITRECEBER SET ALTUSUITREC='S', /* Atualiza os itens de contas a */
         /* receber para ajustar automaticamente os valores no cabeçalho */
              CODEMPBO=:CODEMPBO, CODFILIALBO=:CODFILIALBO, CODBANCO=:CODBANCO,
              CODEMPCB=:CODEMPCB, CODFILIALCB=:CODFILIALCB, CODCARTCOB=:CODCARTCOB,
              CODEMPCA=:CODEMPCA, CODFILIALCA=:CODFILIALCA, NUMCONTA=:NUMCONTA
             WHERE CODREC=:CODREC AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIALRC;
     END
     ELSE
     BEGIN
         DELETE FROM FNRECEBER WHERE CODREC=:CODREC AND CODEMP=:CODEMP AND
            CODFILIAL=:CODFILIALRC;
     END
   END

END
^

/* Alter (FNCHECAPGTOATRASOSP) */
ALTER PROCEDURE FNCHECAPGTOATRASOSP(ICODCLI INTEGER,
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 RETURNS(SRETORNO CHAR(1))
 AS
declare variable ilinhas integer;
declare variable ifilialreceber integer;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNRECEBER') INTO IFILIALRECEBER;
  SELECT COUNT(*) FROM FNITRECEBER IT WHERE CODREC
         IN (
            SELECT CODREC FROM FNRECEBER REC WHERE REC.CODCLI = :iCodCli
                   AND REC.CODEMPCL=:ICODEMP AND REC.CODFILIALCL=:ICODFILIAL
                   AND REC.CODREC = IT.CODREC
                   AND CODEMP=IT.CODEMP AND CODFILIAL=IT.CODFILIAL
         )
         AND STATUSITREC != 'RP' AND IT.dtvencitrec < cast('today' as date)
         AND IT.CODEMP=:ICODEMP AND IT.CODFILIAL=:IFILIALRECEBER INTO iLinhas;
  IF (iLinhas > 0) THEN
    sRetorno = 'S';
  ELSE
    sRetorno = 'N';
  SUSPEND;
END
^

/* Alter (FNCHECAPGTOSP) */
ALTER PROCEDURE FNCHECAPGTOSP(ICODCLI INTEGER,
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 RETURNS(SRETORNO CHAR(1))
 AS
DECLARE VARIABLE iLinhas INTEGER;
DECLARE VARIABLE IFILIALRECEBER INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNRECEBER') INTO IFILIALRECEBER;
  SELECT COUNT(*) FROM FNITRECEBER IT WHERE CODREC
         IN (
            SELECT CODREC FROM FNRECEBER REC WHERE REC.CODCLI = :iCodCli
                   AND REC.CODEMPCL=:ICODEMP AND REC.CODFILIALCL=:ICODFILIAL
                   AND REC.CODREC = IT.CODREC
                   AND CODEMP=IT.CODEMP AND CODFILIAL=IT.CODFILIAL
         )
         AND STATUSITREC != 'RP'
         AND IT.CODEMP=:ICODEMP AND IT.CODFILIAL=:IFILIALRECEBER INTO iLinhas;
  IF (iLinhas > 0) THEN
    sRetorno = 'N';
  ELSE
    sRetorno = 'S';
  SUSPEND;
END
^

/* Alter (FNITRECEBERSP01) */
ALTER PROCEDURE FNITRECEBERSP01(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
ICODREC INTEGER,
NVLRPARCREC NUMERIC(15,5),
NVLRCOMIREC NUMERIC(15,5),
INROPARCREC INTEGER,
CCLASCOMIS CHAR(1))
 AS
declare variable inparcitrec integer;
declare variable nvlrparcitrec numeric(15,5);
declare variable nperc numeric(10,6);
declare variable nvlrcomiitrec numeric(15,5);
declare variable nresto numeric(15,5);
declare variable dvencitrec date;
begin
    -- Procedure que atualiza a comissão na tabela ITRECEBER
    nResto = nVlrComiRec;

    for select nparcitrec, vlrparcitrec, dtvencitrec from fnitreceber
    where codemp=:icodemp and codfilial=:scodfilial and codrec=:icodrec
    order by nparcitrec
    into :inparcitrec , :nvlrparcitrec, :dvencitrec do

    begin
        nperc = nvlrparcitrec / nvlrparcrec;
        nvlrcomiitrec = cast( (nvlrcomirec * nperc) as numeric(15, 5) );
        nresto = nresto - nvlrcomiitrec;

        if (inparcitrec=inroparcrec) then
        begin
            nvlrcomiitrec = nvlrcomiitrec + nresto;
        end

        update fnitreceber ir set vlrcomiitrec=:nvlrcomiitrec where codemp=:icodemp and codfilial=:scodfilial
        and codrec=:icodrec and nparcitrec=:inparcitrec;

        if (cclascomis='S') then
            execute procedure vdgeracomissaosp(:icodemp, :scodfilial, :icodrec, :inparcitrec, :nvlrcomiitrec, :dvencitrec);
    end
    suspend;
end
^

/* Alter (FNLIBCREDSP) */
ALTER PROCEDURE FNLIBCREDSP(CODEMPVD INTEGER,
CODFILIALVD INTEGER,
TIPOVENDA CHAR(1),
CODVENDA INTEGER,
CODCLI INTEGER,
CODEMPCL INTEGER,
CODFILIALCL INTEGER,
VLRVENDA NUMERIC(15,5),
VLRADIC NUMERIC(15,2),
CODITEM INTEGER)
 AS
declare variable prefcred char(1);
declare variable codfilial integer;
declare variable vlrcredito numeric(15,5);
declare variable ecf char(1);
declare variable vlraberto numeric(15,5);
declare variable agrup char(1);
declare variable codempclip integer;
declare variable codfilialclip smallint;
declare variable codclip integer;
declare variable vlrdif numeric(15,2);
declare variable vlrautorizado numeric(15,2);
declare variable vlrpedidoant numeric(15,2);
declare variable vlrautorizadotot numeric(15,2);
begin
    select icodfilial from sgretfilial(:codempcl,'FNLIBCRED') into codfilial;
    select prefcred,lcredglobal from sgprefere1 where codemp=:codempcl and codfilial=:codfilial into prefcred, agrup;

    select first 1 cx.ecfcaixa from pvcaixa cx, sgconexao con, sgestacao est
        where est.codemp=con.codemp and est.codfilial=con.codfilial
            and est.codest=con.codterm AND cx.codfilialet=est.codfilial
            and cx.codempet=est.codemp AND cx.codest=est.codest
            and con.nrconexao=current_connection and conectado > 0
    into ecf;

    if (prefcred = 'N' or ecf='S') then /* Não verificar */
        exit;
    else if (prefcred = 'L') then /*Liberar se não ultrapassar o crédito pré aprovado */
        begin

             if( :coditem is not null and :vlradic is not null  ) then
             begin
                select vi.vlrproditvenda from vditvenda vi where vi.codemp=:codempvd
                and vi.codfilial=:codfilialvd and vi.codvenda=:codvenda
                and vi.tipovenda=:tipovenda and vi.coditvenda=:coditem into :vlrdif;
             end

            vlrvenda = coalesce(vlrvenda,0) + ( coalesce(vlradic,0) - coalesce(:vlrdif,0) );

            /* busca informações do cliente principal */
            select cli.codemppq, cli.codfilialpq, cli.codpesq
                from vdcliente cli
                where cli.codemp=:codempcl and cli.codfilial=:codfilialcl and cli.codcli=:codcli
            into codempclip, codfilialclip, codclip;

            if(agrup = 'S') then /* Verifica se deve agrupar despesas dos sub-clientes */
            begin
                /* BUSCA DE VALORES EM ABERTO */
                select coalesce(sum( (coalesce(it.vlrparcitrec,0)) - (coalesce(it.vlrpagoitrec,0)) ),0)
                    from fnreceber r, vdvenda v,fnitreceber it, vdcliente cl
                    where cl.codemppq=:codempclip and cl.codfilialpq=:codfilialclip and cl.codpesq=:codclip
                        and r.codempcl=cl.codemp and r.codfilialcl=cl.codfilial and r.codcli=cl.codcli
                        and (r.codempvd!=:codempvd or r.codfilialvd!=:codfilialvd or R.codvenda!=:codvenda or R.tipovenda!=:tipovenda) /* não deve contar com a venda atual */
                        and v.codemp=r.codempvd and v.codfilial=v.codfilialvd and v.codvenda=r.codvenda and v.tipovenda=r.tipovenda
                        and it.codemp=r.codemp and it.codfilial=r.codfilial and it.codrec=r.codrec and it.statusitrec not in ('RP')
                into vlraberto;

                /* BUSCA VALOR AUTORIZADO/LIBERADO */
                vlrautorizadotot = 0;
                for select lc.vlrautorizlcred,lc.vlrvendacred
                    from fnlibcred lc
                    where lc.codemp=:codempvd and lc.codfilial=:codfilialvd
                        and lc.codfilialvd=:codfilialvd and lc.codempcl=:codempcl
                        and lc.codfilialcl=:codfilialcl and lc.tipovenda=:tipovenda
                        and lc.codvenda=:codvenda and lc.dtavctolcred >= cast('today' as date)
                into :vlrautorizado, :vlrpedidoant do
                begin
                    vlrautorizadotot = :vlrautorizadotot + :vlrautorizado;
                end

                /* BUSCA DE LIMITE */
                select sum(coalesce(tc.vlrtpcred,0))
                    from fntipocred tc, vdcliente cl
                    where cl.codemppq=:codempclip and cl.codfilial=:codfilialcl and cl.codpesq=:codclip
                        and tc.codtpcred=cl.codtpcred and tc.codemp=cl.codemptr and tc.codfilial=cl.codfilialtr
                        and cast('today' as date) <= cl.dtvenctotr
                into vlrcredito;

                /* VALOR DO CREDITO É A SOMA DO CREDITO PRÉ-FIXADO + O VALOR LIBERADO PARA O PEDIDO*/
                vlrcredito = vlrcredito + vlrautorizadotot;

            end
            else /* Caso não deva agrupar as despesas dos sub-clientes */
            begin

                /* BUSCA DE VALORES EM ABERTO */

                select coalesce(sum( (coalesce(it.vlrparcitrec,0)) - (coalesce(it.vlrpagoitrec,0)) ),0)
                    from fnreceber r, vdvenda v,fnitreceber it, vdcliente cl
                    where cl.codemp=:codempvd and cl.codfilial=:codfilialvd and cl.codcli=:codcli
                        and r.codempcl=cl.codemp and r.codfilialcl=cl.codfilial and r.codcli=cl.codcli
                        and (r.codempvd!=:codempvd or r.codfilialvd!=:codfilialvd or R.codvenda!=:codvenda or R.tipovenda!=:tipovenda) /* não deve contar com a venda atual */
                        and v.codemp=r.codempvd and v.codfilial=v.codfilialvd and v.codvenda=r.codvenda and v.tipovenda=r.tipovenda
                        and it.codemp=r.codemp and it.codfilial=r.codfilial and it.codrec=r.codrec and it.statusitrec not in ('RP')
                into vlraberto;

                /* BUSCA VALOR AUTORIZADO/LIBERADO */
                vlrautorizadotot = 0;
                for select lc.vlrautorizlcred,lc.vlrvendacred
                    from fnlibcred lc
                    where lc.codemp=:codempvd and lc.codfilial=:codfilialvd
                        and lc.codfilialvd=:codfilialvd and lc.codempcl=:codempcl
                        and lc.codfilialcl=:codfilialcl and lc.tipovenda=:tipovenda
                        and lc.codvenda=:codvenda and lc.dtavctolcred >= cast('today' as date)
                into :vlrautorizado, :vlrpedidoant do
                begin
                    vlrautorizadotot = :vlrautorizadotot + :vlrautorizado;
                end

                /* BUSCA DE LIMITE */
                select coalesce(tc.vlrtpcred,0)
                    from fntipocred tc, vdcliente cl
                    where cl.codcli=:codcli and cl.codemp=:codempcl
                        and cl.codfilial=:codfilialcl AND tc.codtpcred=cl.codtpcred
                        and tc.codemp=cl.codemptr and tc.codfilial=cl.codfilialtr
                        and cast('today' as date) <= cl.dtvenctotr
                into vlrcredito;
                
                /* VALOR DO CREDITO É A SOMA DO CREDITO PRÉ-FIXADO + O VALOR LIBERADO PARA O PEDIDO*/
                vlrcredito = vlrcredito + vlrautorizadotot;

            end

            /* CASO JÁ EXISTA UM VALOR AUTORIZADO E O VALOR DO PEDIDO NÃO AUMENTOU, NÃO DEVE BLOQUEAR A VENDA*/
            if(vlrautorizadotot>0 and vlrpedidoant>=vlrvenda) then
            begin
                exit;
            end
            else if (vlrcredito > 0) then
                begin
                    if ( (vlrvenda + vlraberto ) <= vlrcredito) then
                        exit;
                    else
                        exception vdvendaex04 'VENDA:' || cast(vlrvenda as char(15)) || 'AB.: ' || cast(vlraberto as char(15)) || 'CRED.:' || cast(vlrcredito as char(15));
                        /*Valor pre-aprovado insuficiente*/
                end
        end
    suspend;
end
^

/* Alter (FNSALDOPLANSP) */
ALTER PROCEDURE FNSALDOPLANSP(ICODEMPPN INTEGER,
ICODFILIALPN INTEGER,
SCODPLANANT CHAR(13),
DDATAANT DATE,
DVLRANT NUMERIC(15,5),
SCODPLANATU CHAR(13),
DDATAATU DATE,
DVLRATU NUMERIC(15,5))
 RETURNS(SRETORNO CHAR(1))
 AS
DECLARE VARIABLE sCodPlan CHAR(13);
  DECLARE VARIABLE dDataSl DATE;
  DECLARE VARIABLE dTmp DATE;
  DECLARE VARIABLE dSaldoSl NUMERIC(15, 5);
  DECLARE VARIABLE dSaldoSlAnt NUMERIC(15, 5);
  DECLARE VARIABLE IFILIALSALDO INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMPPN,'FNSALDOLANCA') INTO IFILIALSALDO;
  IF (dVlrAnt IS NULL) THEN
     dVlrAnt = 0;
  IF (dVlrAtu IS NULL) THEN
     dVlrAtu = 0;
  IF ((sCodPlanAnt IS NOT NULL) AND (rtrim(sCodPlanAnt) != '')) THEN
  BEGIN
    SELECT CODPLAN,DATASL,SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodPlanAnt
           AND DATASL =: dDataAnt AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
           AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO sCodPlan,dDataSl,dSaldoSl;
    IF ((sCodPlan = sCodPlanAnt) AND (dDataSl = dDataAnt)) THEN
    BEGIN
      UPDATE FNSALDOLANCA SET SALDOSL =:dSaldoSl-:dVlrAnt WHERE CODPLAN=:sCodPlanAnt
             AND DATASL =:dDataAnt AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
             AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN;
      FOR SELECT DATASL,SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodplanAnt
          AND DATASL >:dDataAnt AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
          AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO :dTmp,:dSaldoSlAnt DO
      BEGIN
         if (:dSaldoSlAnt IS NULL) THEN
            dSaldoSlAnt = 0;
         UPDATE FNSALDOLANCA SET SALDOSL = :dSaldoSlAnt-:dVlrAnt WHERE CODPLAN=:sCodplanAnt
                AND DATASL =:dTmp AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
                AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN;
        SUSPEND;
      END
    END
    ELSE
    BEGIN
      SELECT SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodPlanAnt
             AND DATASL<:dDataAnt AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
             AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO dSaldoSlAnt;
      IF (dSaldoSlAnt IS NULL) THEN
          dSaldoSlAnt = 0;
      INSERT INTO FNSALDOLANCA (CODEMP,CODFILIAL,CODPLAN,CODFILIALPN,CODEMPPN,DATASL,PREVSL,SALDOSL)
             VALUES (
                    :ICODEMPPN,:IFILIALSALDO,:sCodPlanAnt,:ICODEMPPN,:ICODFILIALPN,:dDataAnt,0,:dSaldoSlAnt-:dVlrAnt
             );
      FOR SELECT DATASL,SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodplanAnt
                 AND DATASL >:dDataAnt AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
                 AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO :dTmp,:dSaldoSlAnt DO
      BEGIN
        if (:dSaldoSlAnt IS NULL) THEN
           dSaldoSlAnt = 0;
        UPDATE FNSALDOLANCA SET SALDOSL = :dSaldoSlAnt-:dVlrAnt WHERE CODPLAN=:sCodplanAnt
               AND DATASL =:dTmp AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
               AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN;
        SUSPEND;
      END
    END
  END
  IF ( (sCodPlanAtu IS NOT NULL) AND (rtrim(sCodPlanAtu) != '')) THEN
  BEGIN
    SELECT CODPLAN,DATASL,SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodPlanAtu
           AND DATASL =: dDataAtu AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
  AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO sCodPlan,dDataSl,dSaldoSl;
    IF ((sCodPlan = sCodPlanAtu) AND (dDataSl = dDataAtu)) THEN
    BEGIN
      UPDATE FNSALDOLANCA SET SALDOSL =:dSaldoSl+:dVlrAtu WHERE CODPLAN=:sCodPlanAtu
             AND DATASL =:dDataAtu AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
             AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN;
      FOR SELECT DATASL,SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodplanAtu
                 AND DATASL >:dDataAtu AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
                 AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO :dTmp,:dSaldoSlAnt DO
      BEGIN
        if (:dSaldoSlAnt IS NULL) THEN
           dSaldoSlAnt = 0;
        UPDATE FNSALDOLANCA SET SALDOSL = :dSaldoSlAnt+:dVlrAtu WHERE CODPLAN=:sCodplanAtu
               AND DATASL =:dTmp AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
               AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN;
        SUSPEND;
      END
    END
    ELSE
    BEGIN
      SELECT SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodPlanAtu
             AND DATASL<:dDataAtu AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
             AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO dSaldoSlAnt;
      IF (dSaldoSlAnt IS NULL) THEN
          dSaldoSlAnt = 0;
      INSERT INTO FNSALDOLANCA (CODEMP,CODFILIAL,CODPLAN,CODEMPPN,CODFILIALPN,DATASL,PREVSL,SALDOSL)
             VALUES (
                    :ICODEMPPN,:IFILIALSALDO,:sCodPlanAtu,:ICODEMPPN,:ICODFILIALPN,:dDataAtu,0,:dSaldoSlAnt+:dVlrAtu
             );
      FOR SELECT DATASL,SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodplanAtu
                 AND DATASL >:dDataAtu AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
                 AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO :dTmp,:dSaldoSlAnt DO
      BEGIN
        if (:dSaldoSlAnt IS NULL) THEN
           dSaldoSlAnt = 0;
        UPDATE FNSALDOLANCA SET SALDOSL = :dSaldoSlAnt+:dVlrAtu WHERE CODPLAN=:sCodplanAtu
               AND DATASL =:dTmp AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
               AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN;
        SUSPEND;
      END
    END
  END
  SUSPEND;
END
^

/* Alter (LFBUSCAFISCALSP02) */
ALTER PROCEDURE LFBUSCAFISCALSP02(CODEMP INTEGER,
CODFILIAL SMALLINT,
CODVENDA INTEGER,
TIPOVENDA CHAR(1),
CODITVENDA SMALLINT,
CODCOMPRA INTEGER,
CODITCOMPRA SMALLINT)
 RETURNS(VLRBASEPIS NUMERIC(15,5),
VLRBASECOFINS NUMERIC(15,5),
VLRPIS NUMERIC(15,5),
VLRCOFINS NUMERIC(15,5),
VLRIR NUMERIC(15,5),
VLRCSOCIAL NUMERIC(15,5),
VLRIPIIT NUMERIC(15,5))
 AS
declare variable codempif integer;
declare variable codfilialif smallint;
declare variable codfisc char(13);
declare variable coditfisc integer;
declare variable codsittribpis char(2);
declare variable codsittribcof char(2);
declare variable vlrpisunidtrib numeric(15,5);
declare variable vlrcofunidtrib numeric(15,5);
declare variable vlrprodit numeric(15,5);
declare variable aliqpis numeric(6,2);
declare variable qtdit numeric(15,5);
declare variable aliqcofins numeric(6,2);
declare variable aliqir numeric(15,5);
declare variable aliqcsocial numeric(15,5);
declare variable vlrliqit numeric(15,5);
declare variable vlrfreteit numeric(15,5);
declare variable vlrdescit numeric(15,5);
begin

    -- Busca de regra de classificação fiscal da venda
    if(codvenda is not null and codcompra is null) then
    begin

        select li.codsittribpis,li.codsittribcof,iv.vlrproditvenda,li.aliqpisfisc,li.vlrpisunidtrib,
        iv.qtditvenda,li.aliqcofinsfisc,coalesce(li.aliqirfisc,fi.percirfilial),coalesce(li.aliqcsocialfisc, fi.perccsocialfilial),
        iv.vlrliqitvenda, coalesce(iv.vlripiitvenda,0) vlripiitvenda, coalesce(iv.vlrfreteitvenda,0) vlrfreteitvenda,
        coalesce(iv.vlrdescitvenda,0) vlrdescitvenda
        from vditvenda iv left outer join lfitclfiscal li on
        li.codemp=iv.codempif and li.codfilial=iv.codfilialif and li.codfisc=iv.codfisc and li.coditfisc=iv.coditfisc
        left outer join sgfilial fi on
        fi.codemp=iv.codemp and fi.codfilial=iv.codfilial
        where
        iv.codemp=:codemp and iv.codfilial=:codfilial and iv.codvenda=:codvenda and iv.tipovenda=:tipovenda and iv.coditvenda=:coditvenda
        into
        :CODSITTRIBPIS,:CODSITTRIBCOF,:VLRPRODIT,:ALIQPIS,:VLRPISUNIDTRIB,:QTDIT,
        :ALIQCOFINS,:ALIQIR,:ALIQCSOCIAL,:VLRLIQIT,:VLRIPIIT, :VLRFRETEIT, :VLRDESCIT;
    end
    -- Busca de regra de classificação fiscal da compra
    else if(codvenda is null and codcompra is not null) then
    begin

       select li.codsittribpis,li.codsittribcof,ic.vlrproditcompra,li.aliqpisfisc,li.vlrpisunidtrib,
        ic.qtditcompra,li.aliqcofinsfisc,coalesce(li.aliqirfisc,fi.percirfilial),coalesce(li.aliqcsocialfisc, fi.perccsocialfilial),
        ic.vlrliqitcompra, coalesce(ic.vlripiitcompra,0) vlripiit, coalesce(ic.vlrfreteitcompra,0) vlrfreteit,
        coalesce(ic.vlrdescitcompra,0) vlrdescit
        from cpitcompra ic left outer join lfitclfiscal li on
        li.codemp=ic.codempif and li.codfilial=ic.codfilialif and li.codfisc=ic.codfisc and li.coditfisc=ic.coditfisc
        left outer join sgfilial fi on
        fi.codemp=ic.codemp and fi.codfilial=ic.codfilial
        where
        ic.codemp=:codemp and ic.codfilial=:codfilial and ic.codcompra=:codcompra and ic.coditcompra=:coditcompra
        into
        :CODSITTRIBPIS,:CODSITTRIBCOF,:VLRPRODIT,:ALIQPIS,:VLRPISUNIDTRIB,:QTDIT,
        :ALIQCOFINS,:ALIQIR,:ALIQCSOCIAL,:VLRLIQIT,:VLRIPIIT, :VLRFRETEIT, :VLRDESCIT;

    end

    -- Definição do PIS

    if(:CODSITTRIBPIS in ('01','02','99')) then -- PIS Tributado pela alíquota
    begin
        vlrbasepis = :vlrprodit - :vlrdescit; -- (Base do PIS = Valor total dos produtos - Implementar situações distintas futuramente)
        vlrpis = (vlrbasepis * aliqpis) / 100;
    end
    else if (:CODSITTRIBPIS in ('03')) then -- PIS Tributado pela quantidade
    begin
        vlrpis = qtdit * vlrpisunidtrib;
    end

    -- Definição do COFINS

    if(:CODSITTRIBCOF in ('01','02','99')) then -- COFINS Tributado pela alíquota
    begin
        vlrbasecofins = :vlrprodit - :vlrdescit; -- (Base do COFINS = Valor total dos produtos - Implementar situações distintas futuramente)
        vlrcofins = (vlrbasecofins * aliqcofins) / 100;
    end
    else if (:CODSITTRIBPIS in ('03')) then -- COFINS Tributado pela quantidade
    begin
        vlrcofins = qtdit * vlrcofunidtrib;
    end

    -- Definição do IR

    vlrir = ((:VLRLIQIT + :VLRIPIIT + :VLRFRETEIT) * aliqir) / 100;

    -- Definição da CSocial

    vlrcsocial = ((:VLRLIQIT + :VLRIPIIT + :VLRFRETEIT) * aliqcsocial) / 100;

  suspend;
end
^

/* Alter (LFGERALFITCOMPRASP) */
ALTER PROCEDURE LFGERALFITCOMPRASP(CODEMP INTEGER,
CODFILIAL SMALLINT,
CODCOMPRA INTEGER,
CODITCOMPRA SMALLINT)
 AS
declare variable temitem char(1);
declare variable codempsp integer;
declare variable codfilialsp smallint;
declare variable impsittribpis char(2);
declare variable codsittribpis char(2);
declare variable aliqpisfisc numeric(15,5);
declare variable vlrbasepis numeric(15,5);
declare variable vlrpis numeric(15,5);
declare variable vlrpisunidtrib numeric(15,5);
declare variable codempsc integer;
declare variable codfilialsc smallint;
declare variable impsittribcof char(2);
declare variable codsittribcof char(2);
declare variable aliqcofins numeric(15,5);
declare variable vlrbasecofins numeric(15,5);
declare variable vlrcofins numeric(15,5);
declare variable vlrcofunidtrib numeric(15,5);
declare variable vlrbaseicmsstitcompra numeric(15,5);
declare variable vlricmsstitcompra numeric(15,5);
declare variable codempsi integer;
declare variable codfilialsi smallint;
declare variable impsittribipi char(2);
declare variable codsittribipi char(2);
declare variable vlripiunidtrib numeric(15,5);
declare variable modbcicms smallint;
declare variable modbcicmsst smallint;
declare variable redfisc numeric(9,2);
declare variable aliqfisc integer;
declare variable vlrir numeric(15,5);
declare variable vlrcsocial numeric(15,5);
declare variable uffor char(2);
declare variable percicmsst numeric(15,5);
declare variable codempif integer;
declare variable codfilialif smallint;
declare variable codfisc char(13);
declare variable coditfisc integer;
declare variable codnat char(4);
declare variable codtrattrib char(2);
declare variable origfisc char(1);
begin

    -- Inserindo informações fiscais na tabela LFITCOMPRA

    select 'S'
    from lfitcompra
    where codemp=:codemp and codfilial=:codfilial and codcompra=:codcompra and coditcompra=:coditcompra
    into :temitem;

    select
    li.codempsp,li.codfilialsp,li.impsittribpis,li.codsittribpis,li.aliqpisfisc,bf.vlrbasepis,bf.vlrpis,li.vlrpisunidtrib,
    li.codempsc,li.codfilialsc,li.impsittribcof,li.codsittribcof,li.aliqcofinsfisc,bf.vlrbasecofins,bf.vlrcofins,li.vlrcofunidtrib,
    li.codempsi,li.codfilialsi,li.impsittribipi,li.codsittribipi,li.vlripiunidtrib,
    li.modbcicms,li.modbcicmsst,li.redfisc,li.aliqfisc,bf.vlrir,bf.vlrcsocial, li.codtrattrib, li.origfisc, ic.vlrbaseicmsstitcompra, ic.vlricmsstitcompra
    from lfbuscafiscalsp02(:CODEMP,:CODFILIAL,null,null,null,:codcompra,:coditcompra) bf
    left outer join cpitcompra ic on ic.codemp=:CODEMP and ic.codfilial=:CODFILIAL and ic.codcompra=:codcompra and ic.coditcompra=:coditcompra
    left outer join lfitclfiscal li on li.codemp=ic.codempif and li.codfilial=ic.codfilialif and li.codfisc=ic.codfisc and li.coditfisc=ic.coditfisc
    into
    :CODEMPSP,:CODFILIALSP,:IMPSITTRIBPIS,:CODSITTRIBPIS,:ALIQPISFISC,:VLRBASEPIS,:VLRPIS,:VLRPISUNIDTRIB,
    :CODEMPSC,:CODFILIALSC,:IMPSITTRIBCOF,:CODSITTRIBCOF,:ALIQCOFINS,:VLRBASECOFINS,:VLRCOFINS,:VLRCOFUNIDTRIB,
    :CODEMPSI,:CODFILIALSI,:IMPSITTRIBIPI,:CODSITTRIBIPI,:VLRIPIUNIDTRIB,
    :MODBCICMS,:MODBCICMSST,:REDFISC,:ALIQFISC,:VLRIR,:VLRCSOCIAL,:codtrattrib,:origfisc, :VLRBASEICMSSTITCOMPRA, :VLRICMSSTITCOMPRA;

    -- Buscando estado do fornecedor
    select coalesce(fr.siglauf,fr.uffor), ic.codempif, ic.codfilialif, ic.codfisc, ic.coditfisc, ic.codnat from cpforneced fr, cpcompra cp
    left outer join cpitcompra ic on ic.codemp=cp.codemp and ic.codfilial=cp.codfilial and ic.codcompra=cp.codcompra and ic.coditcompra=:coditcompra
    where cp.codemp=:codemp and cp.codfilial=:codfilial and cp.codcompra=:codcompra and
    fr.codemp=cp.codempfr and fr.codfilial=cp.codfilialfr and fr.codfor=cp.codfor
    into uffor,codempif, codfilialif, codfisc, coditfisc, codnat;

    -- Buscando aliquota do ICMS ST da tabela de classificação fiscal
    select coalesce(ic.aliqfiscintra,0) from lfitclfiscal ic
    where ic.codemp=:codempif and ic.codfilial=:codfilialif and ic.codfisc=:codfisc and ic.coditfisc=:coditfisc
    into PERCICMSST;

    -- Buscando aliquota do ICMS ST da tabela de alíquotas (caso não encontre na busca naterior)
    if (percicmsst = 0) then
    begin
        select coalesce(PERCICMSINTRA,0) from lfbuscaicmssp (:codnat,:uffor,:codemp,:codfilial)
        into PERCICMSST;
    end

    if(:TEMITEM='S') then
    begin
            update lfitcompra set codempsp=:CODEMPSP,codfilialsp=:CODFILIALSP,impsittribpis=:IMPSITTRIBPIS,
            codsittribpis=:CODSITTRIBPIS,aliqpis=:ALIQPISFISC,vlrbasepis=:VLRBASEPIS,vlrpis=:VLRPIS,vlrpisunidtrib=:VLRPISUNIDTRIB,
            codempsc=:CODEMPSC,codfilialsc=:CODFILIALSC,impsittribcof=:IMPSITTRIBCOF,codsittribcof=:CODSITTRIBCOF,aliqcofins=:ALIQCOFINS,
            vlrbasecofins=:VLRBASECOFINS,vlrcofins=:VLRCOFINS,vlrcofunidtrib=:VLRCOFUNIDTRIB,
            codempsi=:CODEMPSI,codfilialsi=:CODFILIALSI,impsittribipi=:IMPSITTRIBIPI,codsittribipi=:CODSITTRIBIPI,vlripiunidtrib=:VLRIPIUNIDTRIB,
            modbcicms=:MODBCICMS,modbcicmsst=:MODBCICMSST,aliqredbcicms=:REDFISC,aliqredbcicmsst=:REDFISC,aliqicmsst=:percicmsst,
            vlrir=:VLRIR,vlrcsocial=:VLRCSOCIAL, vlrbaseicmsstitcompra=:vlrbaseicmsstitcompra, vlricmsstitcompra=:vlricmsstitcompra
            where codemp=:codemp and codfilial=:codfilial and codcompra=:codcompra and coditcompra=:coditcompra;
    end
    else
    begin
        insert into lfitcompra (codemp,codfilial,codcompra,coditcompra,
            codempsp,codfilialsp,impsittribpis,codsittribpis,aliqpis,vlrbasepis,vlrpis,vlrpisunidtrib,
            codempsc,codfilialsc,impsittribcof,codsittribcof,aliqcofins,vlrbasecofins,vlrcofins,vlrcofunidtrib,
            codempsi,codfilialsi,impsittribipi,codsittribipi,vlripiunidtrib,
            modbcicms,modbcicmsst,aliqredbcicms,aliqredbcicmsst,aliqicmsst,vlrir,vlrcsocial,codtrattrib,origfisc,
            vlrbaseicmsstitcompra, vlricmsstitcompra)
        values(:CODEMP,:CODFILIAL,:CODcompra,:CODITcompra,
        :CODEMPSP,:CODFILIALSP,:IMPSITTRIBPIS,:CODSITTRIBPIS,:ALIQPISFISC,:VLRBASEPIS,:VLRPIS,:VLRPISUNIDTRIB,
        :CODEMPSC,:CODFILIALSC,:IMPSITTRIBCOF,:CODSITTRIBCOF,:ALIQCOFINS,:VLRBASECOFINS,:VLRCOFINS,:VLRCOFUNIDTRIB,
        :CODEMPSI,:CODFILIALSI,:IMPSITTRIBIPI,:CODSITTRIBIPI,:VLRIPIUNIDTRIB,
        :MODBCICMS,:MODBCICMSST,:REDFISC,:REDFISC,:percicmsst,:VLRIR,:VLRCSOCIAL, :codtrattrib, :origfisc,
        :VLRBASEICMSSTITCOMPRA, :VLRICMSSTITCOMPRA );

    end
  suspend;
end
^

/* Alter (LFGERALFITVENDASP) */
ALTER PROCEDURE LFGERALFITVENDASP(CODEMP INTEGER,
CODFILIAL SMALLINT,
CODVENDA INTEGER,
TIPOVENDA CHAR(2),
CODITVENDA SMALLINT)
 AS
declare variable temitem char(1);
declare variable codempsp integer;
declare variable codfilialsp smallint;
declare variable impsittribpis char(2);
declare variable codsittribpis char(2);
declare variable aliqpisfisc numeric(15,5);
declare variable vlrbasepis numeric(15,5);
declare variable vlrpis numeric(15,5);
declare variable vlrpisunidtrib numeric(15,5);
declare variable codempsc integer;
declare variable codfilialsc smallint;
declare variable impsittribcof char(2);
declare variable codsittribcof char(2);
declare variable aliqcofins numeric(15,5);
declare variable vlrbasecofins numeric(15,5);
declare variable vlrcofins numeric(15,5);
declare variable vlrcofunidtrib numeric(15,5);
declare variable codempsi integer;
declare variable codfilialsi smallint;
declare variable impsittribipi char(2);
declare variable codsittribipi char(2);
declare variable vlripiunidtrib numeric(15,5);
declare variable modbcicms smallint;
declare variable modbcicmsst smallint;
declare variable redfisc numeric(9,2);
declare variable aliqfisc integer;
declare variable vlrir numeric(15,5);
declare variable vlrcsocial numeric(15,5);
declare variable ufcli char(2);
declare variable percicmsst numeric(15,5);
declare variable codempif integer;
declare variable codfilialif smallint;
declare variable codfisc char(13);
declare variable coditfisc integer;
declare variable codnat char(4);
begin

    -- Inserindo informações fiscais na tabela LFITVENDA

    select 'S'
    from lfitvenda
    where codemp=:codemp and codfilial=:codfilial and codvenda=:codvenda and tipovenda=:tipovenda and coditvenda=:coditvenda
    into :temitem;

    select
    li.codempsp,li.codfilialsp,li.impsittribpis,li.codsittribpis,li.aliqpisfisc,bf.vlrbasepis,bf.vlrpis,li.vlrpisunidtrib,
    li.codempsc,li.codfilialsc,li.impsittribcof,li.codsittribcof,li.aliqcofinsfisc,bf.vlrbasecofins,bf.vlrcofins,li.vlrcofunidtrib,
    li.codempsi,li.codfilialsi,li.impsittribipi,li.codsittribipi,li.vlripiunidtrib,
    li.modbcicms,li.modbcicmsst,li.redfisc,li.aliqfisc,bf.vlrir,bf.vlrcsocial
    from lfbuscafiscalsp02(:CODEMP,:CODFILIAL,:CODVENDA,:TIPOVENDA,:CODITVENDA, null, null) bf
    left outer join vditvenda iv on iv.codemp=:CODEMP and iv.codfilial=:CODFILIAL and iv.codvenda=:CODVENDA and iv.tipovenda=:TIPOVENDA and iv.coditvenda=:CODITVENDA
    left outer join lfitclfiscal li on li.codemp=iv.codempif and li.codfilial=iv.codfilialif and li.codfisc=iv.codfisc and li.coditfisc=iv.coditfisc
    into
    :CODEMPSP,:CODFILIALSP,:IMPSITTRIBPIS,:CODSITTRIBPIS,:ALIQPISFISC,:VLRBASEPIS,:VLRPIS,:VLRPISUNIDTRIB,
    :CODEMPSC,:CODFILIALSC,:IMPSITTRIBCOF,:CODSITTRIBCOF,:ALIQCOFINS,:VLRBASECOFINS,:VLRCOFINS,:VLRCOFUNIDTRIB,
    :CODEMPSI,:CODFILIALSI,:IMPSITTRIBIPI,:CODSITTRIBIPI,:VLRIPIUNIDTRIB,
    :MODBCICMS,:MODBCICMSST,:REDFISC,:ALIQFISC,:VLRIR,:VLRCSOCIAL;


    -- Buscando estado do cliente
    select coalesce(cl.siglauf,cl.ufcli), iv.codempif, iv.codfilialif, iv.codfisc, iv.coditfisc, iv.codnat from vdcliente cl, vdvenda vd
    left outer join vditvenda iv on iv.codemp=vd.codemp and iv.codfilial=vd.codfilial and iv.codvenda=vd.codvenda and iv.tipovenda=vd.tipovenda and iv.coditvenda=:coditvenda
    where vd.codemp=:codemp and vd.codfilial=:codfilial and vd.codvenda=:codvenda and vd.tipovenda=:tipovenda and
    cl.codemp=vd.codempcl and cl.codfilial=vd.codfilialcl and cl.codcli=vd.codcli
    into ufcli,codempif, codfilialif, codfisc, coditfisc, codnat;

    -- Buscando aliquota do ICMS ST da tabela de classificação fiscal
    select coalesce(ic.aliqfiscintra,0) from lfitclfiscal ic
    where ic.codemp=:codempif and ic.codfilial=:codfilialif and ic.codfisc=:codfisc and ic.coditfisc=:coditfisc
    into PERCICMSST;

    -- Buscando aliquota do ICMS ST da tabela de alíquotas (caso não encontre na busca naterior)
    if (percicmsst = 0) then
    begin
        select coalesce(PERCICMSINTRA,0) from lfbuscaicmssp (:codnat,:ufcli,:codemp,:codfilial)
        into PERCICMSST;
    end

    if(:TEMITEM='S') then
    begin
            update lfitvenda set codempsp=:CODEMPSP,codfilialsp=:CODFILIALSP,impsittribpis=:IMPSITTRIBPIS,
            codsittribpis=:CODSITTRIBPIS,aliqpis=:ALIQPISFISC,vlrbasepis=:VLRBASEPIS,vlrpis=:VLRPIS,vlrpisunidtrib=:VLRPISUNIDTRIB,
            codempsc=:CODEMPSC,codfilialsc=:CODFILIALSC,impsittribcof=:IMPSITTRIBCOF,codsittribcof=:CODSITTRIBCOF,aliqcofins=:ALIQCOFINS,
            vlrbasecofins=:VLRBASECOFINS,vlrcofins=:VLRCOFINS,vlrcofunidtrib=:VLRCOFUNIDTRIB,
            codempsi=:CODEMPSI,codfilialsi=:CODFILIALSI,impsittribipi=:IMPSITTRIBIPI,codsittribipi=:CODSITTRIBIPI,vlripiunidtrib=:VLRIPIUNIDTRIB,
            modbcicms=:MODBCICMS,modbcicmsst=:MODBCICMSST,aliqredbcicms=:REDFISC,aliqredbcicmsst=:REDFISC,aliqicmsst=:percicmsst,
            vlrir=:VLRIR,vlrcsocial=:VLRCSOCIAL
            where codemp=:codemp and codfilial=:codfilial and codvenda=:codvenda and tipovenda=:tipovenda and coditvenda=:coditvenda;
    end
    else
    begin
        insert into lfitvenda (codemp,codfilial,codvenda,tipovenda,coditvenda,
            codempsp,codfilialsp,impsittribpis,codsittribpis,aliqpis,vlrbasepis,vlrpis,vlrpisunidtrib,
            codempsc,codfilialsc,impsittribcof,codsittribcof,aliqcofins,vlrbasecofins,vlrcofins,vlrcofunidtrib,
            codempsi,codfilialsi,impsittribipi,codsittribipi,vlripiunidtrib,
            modbcicms,modbcicmsst,aliqredbcicms,aliqredbcicmsst,aliqicmsst,vlrir,vlrcsocial)
        values(:CODEMP,:CODFILIAL,:CODVENDA,:TIPOVENDA,:CODITVENDA,
        :CODEMPSP,:CODFILIALSP,:IMPSITTRIBPIS,:CODSITTRIBPIS,:ALIQPISFISC,:VLRBASEPIS,:VLRPIS,:VLRPISUNIDTRIB,
        :CODEMPSC,:CODFILIALSC,:IMPSITTRIBCOF,:CODSITTRIBCOF,:ALIQCOFINS,:VLRBASECOFINS,:VLRCOFINS,:VLRCOFUNIDTRIB,
        :CODEMPSI,:CODFILIALSI,:IMPSITTRIBIPI,:CODSITTRIBIPI,:VLRIPIUNIDTRIB,
        :MODBCICMS,:MODBCICMSST,:REDFISC,:REDFISC,:percicmsst,:VLRIR,:VLRCSOCIAL);

    end

  suspend;
end
^

/* empty dependent procedure body */
/* Clear: CPADICCOMPRAPEDSP for: LFNOVODOCSP */
/* AssignEmptyBody proc */
ALTER PROCEDURE CPADICCOMPRAPEDSP(CODEMP INTEGER,
CODFILIAL SMALLINT,
CODCOMPRA INTEGER,
DOCCOMPRA INTEGER,
CODEMPTM INTEGER,
CODFILIALTM SMALLINT,
CODTIPOMOV INTEGER,
CODEMPFR INTEGER,
CODFILIALFR SMALLINT,
CODFOR INTEGER,
CODEMPPG INTEGER,
CODFILIALPG SMALLINT,
CODPLANOPAG INTEGER)
 RETURNS(IRET INTEGER)
 AS
 BEGIN EXIT; END
^

/* Alter (LFNOVODOCSP) */
ALTER PROCEDURE LFNOVODOCSP(SSERIE CHAR(4),
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 RETURNS(DOC INTEGER)
 AS
declare variable iseqserie integer;
declare variable icodfilialss smallint;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP, 'LFSEQSERIE')
     INTO :ICODFILIALSS;
  DOC = NULL;
  /* Utiliza o número sequencial do documento da tabela LFSERIE,
    para retrocompatibilidade */
  SELECT COALESCE(SS.DOCSERIE,S.SERIE) DOCSERIE, SS.SEQSERIE
     FROM LFSERIE S
     LEFT OUTER JOIN LFSEQSERIE SS
     ON SS.CODEMP=S.CODEMP AND
        SS.CODFILIAL=S.CODFILIAL AND SS.SERIE=S.SERIE AND
        SS.CODEMPSS=:ICODEMP AND SS.CODFILIALSS=:ICODFILIALSS
     WHERE S.SERIE=:SSERIE AND S.CODEMP=:ICODEMP AND
        S.CODFILIAL=:ICODFILIAL AND SS.ATIVSERIE='S'
     INTO :DOC, :ISEQSERIE;
  IF (:ISEQSERIE IS NULL) THEN
  BEGIN
     IF (:DOC IS NULL) THEN
        DOC = 0;
     DOC = DOC + 1;
     SELECT MAX(SEQSERIE) FROM LFSEQSERIE SS
        WHERE SS.CODEMP=:ICODEMP AND SS.CODFILIAL=:ICODFILIAL AND
            SS.CODEMPSS=:ICODEMP AND SS.CODFILIALSS=:ICODFILIALSS AND
            SS.SERIE=:SSERIE INTO :ISEQSERIE;
     IF (:ISEQSERIE IS NULL) THEN
         ISEQSERIE = 1;
     INSERT INTO LFSEQSERIE (CODEMP, CODFILIAL, SERIE,
         CODEMPSS, CODFILIALSS, SEQSERIE, DOCSERIE)
     VALUES (:ICODEMP, :ICODFILIAL, :SSERIE,
         :ICODEMP, :ICODFILIALSS, :ISEQSERIE, :DOC);
  END
  ELSE
  BEGIN
    DOC = DOC + 1;
  END
  UPDATE LFSEQSERIE SET DOCSERIE=:DOC
     WHERE SERIE=:SSERIE AND CODEMP=:ICODEMP AND
     CODFILIAL=:ICODFILIAL AND CODEMPSS=:ICODEMP AND
     CODFILIALSS=:ICODFILIALSS AND SEQSERIE=:ISEQSERIE;
  SUSPEND;
END
^

/* Alter (PPGERAOP) */
ALTER PROCEDURE PPGERAOP(TIPOPROCESS CHAR(1),
CODEMPOP INTEGER,
CODFILIALOP SMALLINT,
CODOP INTEGER,
SEQOP INTEGER,
CODEMPPD INTEGER,
CODFILIALPD SMALLINT,
CODPROD INTEGER,
CODEMPOC INTEGER,
CODFILIALOC SMALLINT,
CODORC INTEGER,
TIPOORC CHAR(1),
CODITORC SMALLINT,
QTDSUGPRODOP NUMERIC(15,5),
DTFABROP DATE,
SEQEST SMALLINT,
CODEMPET INTEGER,
CODFILIALET SMALLINT,
CODEST SMALLINT,
AGRUPDATAAPROV CHAR(1),
AGRUPDTFABROP CHAR(1),
AGRUPCODCLI CHAR(1),
CODEMPCL INTEGER,
CODFILIALCL SMALLINT,
CODCLI INTEGER,
DATAAPROV DATE,
CODEMPCP INTEGER,
CODFILIALCP SMALLINT,
CODCOMPRA INTEGER,
CODITCOMPRA SMALLINT,
JUSTFICQTDPROD VARCHAR(500),
CODEMPPDENTRADA INTEGER,
CODFILIALPDENTRADA SMALLINT,
CODPRODENTRADA INTEGER,
QTDENTRADA NUMERIC(15,5))
 RETURNS(CODOPRET INTEGER,
SEQOPRET SMALLINT)
 AS
declare variable codempax integer;
declare variable codfilialax smallint;
declare variable codalmox integer;
declare variable refprod varchar(20);
declare variable codemptm integer;
declare variable codfilialtm smallint;
declare variable codtipomov integer;
declare variable sitpadop char(2);
declare variable seqof smallint;
declare variable codempfs integer;
declare variable codfilialfs smallint;
declare variable codfase integer;
declare variable tempoefdias numeric(15,5);
declare variable tempoef numeric(15,5);
declare variable datafimprodant date;
declare variable hfimprodant time;
declare variable qtdfinalprodop numeric(15,5);
declare variable codtipomovtm integer;
declare variable sitpadopconv char(2);
declare variable codemprma integer;
declare variable codfilialrma smallint;
declare variable codrma integer;
declare variable coditrma smallint;
declare variable estdinamica char(1);
begin

    if(codop is null) then
    begin

        -- Busca novo código para a OP caso não venha no parâmetro.
        select coalesce(max(codop),0) + 1 from ppop where codemp=:codempop and codfilial=:codfilialop
        into :codop;

        -- Buscando informações do produto e estrutura.

        select pd.codempax, pd.codfilialax, pd.codalmox, pd.refprod, es.estdinamica from eqproduto pd, ppestrutura es
        where pd.codemp=:codemppd and pd.codfilial=:codfilialpd and pd.codprod=:codprod
        and es.codemp=pd.codemp and es.codfilial=pd.codfilial and es.codprod=pd.codprod and es.seqest=:seqest
        into :codempax, :codfilialax, :codalmox, :refprod, :estdinamica;

        -- Buscando tipo de movimento para OP.
        select p5.codemptm, p5.codfilialtm, p5.codtipomov, coalesce(tm.codtipomovtm,p5.codtipomov), p5.sitpadop, p5.sitpadopconv
        from sgprefere5 p5, eqtipomov tm
        where p5.codemp=:codempop and p5.codfilial=:codfilialop and
        tm.codemp=p5.codemptm and tm.codfilial=p5.codfilialtm and tm.codtipomov=p5.codtipomov
        into :codemptm, :codfilialtm, :codtipomov, :codtipomovtm, :sitpadop, :sitpadopconv;

        -- Inserindo OP
        seqop = 0;

        if(sitpadop='FN' and tipoprocess in ('D','A')) then
        begin
            qtdfinalprodop = :qtdsugprodop;
            codtipomov = :codtipomovtm;
        end
        else if(sitpadopconv='FN' and tipoprocess='C') then
        begin
            qtdfinalprodop = :qtdsugprodop;
            codtipomov = :codtipomovtm;
        end
        else
        begin
            qtdfinalprodop = 0;
        end

        insert into ppop  (codemp, codfilial, codop, seqop,
                           codemppd, codfilialpd, codprod, seqest, refprod,
                           codempax, codfilialax, codalmox,
                           dtemitop, dtfabrop,
                           qtdsugprodop, qtdprevprodop, qtdfinalprodop,
                           codemple, codfilialle, codlote,
                           codemptm, codfilialtm, codtipomov,
                           sitop, codempcp, codfilialcp, codcompra, coditcompra, justficqtdprod, estdinamica)
        values ( :codempop, :codfilialop, :codop, :seqop,
                 :codemppd, :codfilialpd, :codprod, :seqest, :refprod,
                 :codempax, :codfilialax, :codalmox,
                 cast('today' as date), :dtfabrop,
                 :qtdsugprodop, :qtdsugprodop, :qtdfinalprodop, null,null,null, 
                 :codemptm, :codfilialtm, :codtipomov, :sitpadop,
                 :codempcp, :codfilialcp, :codcompra, :coditcompra, :justficqtdprod, :estdinamica

        );

        -- Caso o status padrão da OP seja Finalizado
        if(:sitpadop='FN') then
        begin
            -- Inicializando variaveis
            datafimprodant = :dtfabrop;
            hfimprodant = cast('now' as time);

            -- Gerando RMAS

            execute procedure eqgerarmasp(:codempop,:codfilialop,:codop,:seqop);

            -- Finalizando Fases

            for select oe.codempfs, oe.codfilialfs, oe.codfase, oe.seqof
            from ppopfase oe, ppop op
            where oe.codemp=:codempop and oe.codfilial=:codfilialop and oe.codop=:codop and oe.seqop=:seqop and
            op.codemp=oe.codemp and op.codfilial=oe.codfilial and op.codop=oe.codop and op.seqop=oe.seqop
            order by oe.seqof
            into :codempfs, :codfilialfs, :codfase, :seqof do
            begin
                -- Buscando informações da fase
                select ef.tempoef from ppestrufase ef
                where ef.codemp=:codempfs and ef.codfilial=:codfilialfs and ef.codfase=:codfase and
                ef.codemp=:codemppd and ef.codfilial=:codfilialpd and ef.codprod=:codprod and ef.seqest=:seqest
                into :tempoef;

                tempoefdias = (tempoef/3600) / 24; -- de segundos para dias...

                update ppopfase oe set oe.sitfs=:sitpadop, oe.obsfs='Fase finalizada automaticamente',
                oe.datainiprodfs=:datafimprodant, oe.hiniprodfs=:hfimprodant,
                oe.datafimprodfs=:datafimprodant + :tempoefdias, oe.hfimprodfs=:hfimprodant + :tempoef
                where oe.codemp=:codempop and oe.codfilial=:codfilialop and oe.codop=:codop and oe.seqop=:seqop and
                oe.seqof=:seqof;

                -- Carregando variáveis para proximo registro
                datafimprodant = :datafimprodant + :tempoefdias;
                hfimprodant = :hfimprodant + :tempoef;

            end
        end

    end

    -- Caso o tipo de processamento seja Detalhado (uma OP por orçamento)
    if(tipoprocess='D') then
    begin

        -- Caso o código do orçamento e código da OP tenham sido informados (deve ocorrer no modo orçamento ou a partir da segunda passagem do modo agrupado...
        if( (codorc is not null) and (codop is not null) ) then
        begin
            insert into ppopitorc (codemp, codfilial, codop, seqop, codempoc, codfilialoc, tipoorc, codorc, coditorc, qtdprod)
            values(:codempop, :codfilialop, :codop, :seqop, :codempoc, :codfilialoc, :tipoorc, :codorc, :coditorc, :qtdsugprodop);

            -- Caso a OP seja gerada já finalizada... deve mudar o status do item de orçamento para produzido.
            if(sitpadop='FN') then
            begin
                update vditorcamento io set io.sitproditorc='PD'
                where io.codemp=:codempoc and io.codfilial=:codfilialoc and io.codorc=:codorc and io.coditorc=:coditorc and io.tipoorc=:tipoorc;
            end

        end
    end
    -- Caso o tipo de processamento seja Agrupado (uma OP para vários orçamentos)
    else if(tipoprocess='A') then
    begin

        for select pt.codemp,pt.codfilial, pt.codorc, pt.coditorc, pt.tipoorc, pt.dtfabrop, pt.qtdaprod
        from ppprocessaoptmp pt, vditorcamento io, vdorcamento oc
        where pt.codempet=:codempet and pt.codfilialet=:codfilialet and pt.codest=:codest
        and io.codemp=pt.codemp and io.codfilial=pt.codfilial and io.codorc=pt.codorc and io.coditorc=pt.coditorc and io.tipoorc=pt.tipoorc
        and oc.codemp=io.codemp and oc.codfilial=io.codfilial and oc.codorc=io.codorc and oc.tipoorc=io.tipoorc
        and (:agrupdataaprov='N' or io.dtaprovitorc=:dataaprov )
        and (:agrupdtfabrop='N' or pt.dtfabrop=:dtfabrop )
        and (:agrupcodcli='N' or (oc.codorc=:codcli and oc.codempcl=:codempcl and oc.codfilialcl=:codfilialcl) )
        and io.codemppd=:codemppd and io.codfilialpd=:codfilialpd and io.codprod=:codprod
        into :codempoc, :codfilialoc, :codorc, :coditorc, :tipoorc, :dtfabrop, :qtdsugprodop do
        begin

            insert into ppopitorc (codemp, codfilial, codop, seqop, codempoc, codfilialoc, tipoorc, codorc, coditorc, qtdprod)
            values(:codempop, :codfilialop, :codop, :seqop, :codempoc, :codfilialoc, :tipoorc, :codorc, :coditorc, :qtdsugprodop);

            -- Caso a OP seja gerada já finalizada... deve mudar o status do item de orçamento para produzido.
            if(sitpadop='FN') then
            begin
                update vditorcamento io set io.sitproditorc='PD'
                where io.codemp=:codempoc and io.codfilial=:codfilialoc and io.codorc=:codorc and io.coditorc=:coditorc and io.tipoorc=:tipoorc;
            end

        end
    end

    -- Carregando parametros de saída
    codopret = :codop;
    seqopret = :seqop;

    suspend;

end
^

/* Alter (PPRELCUSTOSP) */
ALTER PROCEDURE PPRELCUSTOSP(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
DTESTOQ DATE,
ICODEMPMC INTEGER,
SCODFILIALMC SMALLINT,
CCODMARCA CHAR(6),
ICODEMPGP INTEGER,
SCODFILIALGP SMALLINT,
CCODGRUP CHAR(14),
CTIPOCUSTO CHAR(1),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER)
 RETURNS(CODPROD INTEGER,
REFPROD VARCHAR(20),
DESCPROD CHAR(100),
TIPOPROD VARCHAR(2),
SLDPROD NUMERIC(15,5),
CUSTOUNIT NUMERIC(15,5),
CUSTOTOT NUMERIC(15,5))
 AS
begin
  /* Procedure Text */
  IF (ICODEMPGP IS NOT NULL) THEN
  BEGIN
    IF (STRLEN(RTRIM(CCODGRUP))<14) THEN
       CCODGRUP = RTRIM(CCODGRUP)||'%';
  END
  IF (CTIPOCUSTO IS NULL) then
     CTIPOCUSTO = 'P';

  FOR SELECT P.CODPROD,P.REFPROD,P.DESCPROD, P.TIPOPROD
   FROM EQPRODUTO P
   WHERE P.CODEMP = :ICODEMP AND P.CODFILIAL = :SCODFILIAL AND
   ( (:ICODEMPMC IS NULL) OR (P.CODEMPMC=:ICODEMPMC AND P.CODFILIALMC=:SCODFILIALMC AND
      P.CODMARCA=:CCODMARCA) ) AND
   ((:ICODEMPGP IS NULL) OR (P.CODEMPGP=:ICODEMPGP AND P.CODFILIALGP=:SCODFILIALGP AND
      P.CODGRUP LIKE :CCODGRUP) )
   INTO :CODPROD, :REFPROD, :DESCPROD, :TIPOPROD  DO
  BEGIN
     SELECT CUSTOUNIT,SLDPROD FROM PPCUSTOPRODSP(:ICODEMP,
        :SCODFILIAL, :CODPROD, :DTESTOQ, :CTIPOCUSTO, :ICODEMPAX,
        :SCODFILIALAX, :ICODALMOX, 'N')
       INTO :CUSTOUNIT, :SLDPROD;
     CUSTOTOT = CUSTOUNIT * SLDPROD;
     SUSPEND;
  END
end
^

/* Alter (PVFECHAVENDASP) */
ALTER PROCEDURE PVFECHAVENDASP(ICODEMP INTEGER,
ICODFILIAL SMALLINT,
NVALOR NUMERIC(15,5),
ITERM INTEGER,
DDTAMOV DATE,
CIDUSU CHAR(8))
 AS
DECLARE VARIABLE ICODMOVCAIXA INTEGER;
DECLARE VARIABLE IFILIALUSU SMALLINT;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'SGUSUARIO') INTO IFILIALUSU;
  /*SELECT ISEQ FROM SPGERANUM(:ICODEMP,:ICODFILIAL,'MC') INTO ICODMOVCAIXA;*/
  SELECT INROMOV FROM PVSEQMOVCAIXASP(:ICODEMP, :ICODFILIAL, :ITERM , :DDTAMOV) INTO :ICODMOVCAIXA;
  INSERT INTO PVMOVCAIXA (CODEMP,CODFILIAL,CODCAIXA,DTAMOV,NROMOV,TIPOMOV,VLRMOV,CODEMPUS,CODFILIALUS,IDUSU)
         VALUES (
                :ICODEMP,:ICODFILIAL,:ITERM,:DDTAMOV,
                :ICODMOVCAIXA,'V',:NVALOR,:ICODEMP,:IFILIALUSU,:CIDUSU
         );
  SUSPEND;
END
^

/* Alter (PVSANGRIASP) */
ALTER PROCEDURE PVSANGRIASP(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
NVALOR NUMERIC(18,3),
ICODCAIXA INTEGER,
DDTAMOV DATE,
CIDUSU CHAR(8))
 AS
DECLARE VARIABLE ICODMOVCAIXA INTEGER;
DECLARE VARIABLE IFILIALUSU INTEGER;
BEGIN
  if (NVALOR IS NULL) then
     NVALOR = 0;
  SELECT INROMOV FROM PVSEQMOVCAIXASP(:ICODEMP, :SCODFILIAL, :ICODCAIXA, :DDTAMOV) INTO :ICODMOVCAIXA;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'SGUSUARIO') INTO IFILIALUSU;
  INSERT INTO PVMOVCAIXA (CODEMP,CODFILIAL,CODCAIXA,DTAMOV,NROMOV,TIPOMOV,VLRMOV,CODEMPUS,CODFILIALUS,IDUSU)
         VALUES (
                :ICODEMP,:SCODFILIAL,:ICODCAIXA,:DDTAMOV,
                :ICODMOVCAIXA,'S',:NVALOR*-1,:ICODEMP,:IFILIALUSU,:CIDUSU
         );
  SUSPEND;
END
^

/* Alter (PVSUPRIMENTOSP) */
ALTER PROCEDURE PVSUPRIMENTOSP(ICODEMP INTEGER,
ICODFILIAL SMALLINT,
NVALOR NUMERIC(18,3),
ITERM INTEGER,
DDTAMOV DATE,
CIDUSU CHAR(8))
 AS
DECLARE VARIABLE ICODMOVCAIXA INTEGER;
DECLARE VARIABLE IFILIALUSU INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'SGUSUARIO') INTO IFILIALUSU;
  SELECT INROMOV FROM PVSEQMOVCAIXASP(:ICODEMP, :IFILIALUSU, :ITERM, :DDTAMOV) INTO :ICODMOVCAIXA;
  INSERT INTO PVMOVCAIXA (CODEMP,CODFILIAL,CODCAIXA,DTAMOV,NROMOV,TIPOMOV,VLRMOV,CODEMPUS,CODFILIALUS,IDUSU)
         VALUES (
                :ICODEMP,:ICODFILIAL,:ITERM,:DDTAMOV,
                :ICODMOVCAIXA,'U',:NVALOR,:ICODEMP,:IFILIALUSU,:CIDUSU
         );
  SUSPEND;
END
^

/* Alter (SGAGENTEUIDSP) */
ALTER PROCEDURE SGAGENTEUIDSP(CIUD CHAR(1),
ICODEMP INTEGER,
CTIPOAGE CHAR(5),
ICODAGE INTEGER,
CDESCAGE CHAR(50))
 RETURNS(CODEMP INTEGER,
CODFILIAL SMALLINT,
TIPOAGE CHAR(5),
CODAGE INTEGER)
 AS
begin
  /* Procedure para inserir, atualizar e deletar AGENTES */
  CODEMP = ICODEMP;
  TIPOAGE = CTIPOAGE;
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP, 'SGAGENTE') INTO :CODFILIAL;
  if (CIUD='I') then
     SELECT CODAGE FROM SGAGENTEISP(:CODEMP, :CODFILIAL, :TIPOAGE, :CDESCAGE)
        INTO :CODAGE;
  else if (CIUD='U') then
     SELECT CODAGE FROM SGAGENTEUSP(:CODEMP, :CODFILIAL, :TIPOAGE, :ICODAGE, :CDESCAGE)
        INTO :CODAGE;
  else if (CIUD='D') then
  begin
     DELETE FROM SGAGENTE WHERE CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL AND
        TIPOAGE=:TIPOAGE AND CODAGE=:ICODAGE;
     CODAGE=:ICODAGE;
  end
  suspend;
end
^

/* Alter (SGATUALIZABDSP) */
ALTER PROCEDURE SGATUALIZABDSP(ICODEMP INTEGER)
 AS
DECLARE VARIABLE ICODEMPTMP INTEGER;
begin
  if (ICODEMP IS NULL) then
     ICODEMP = 99;
  /*CTEMP = printLog('Entrou no atualizabdsp '||cast(ICODEMP AS CHAR(10)));*/

  EXECUTE PROCEDURE SGDADOSINISP(:ICODEMP);
  EXECUTE PROCEDURE SGGRANTUSERSP ;
  FOR SELECT CODEMP FROM SGEMPRESA INTO :ICODEMPTMP DO
  BEGIN
     EXECUTE PROCEDURE SGOBJETOINSTBSP(:ICODEMPTMP);
     EXECUTE PROCEDURE SGGRANTADMSP(:ICODEMPTMP);
  END
  suspend;
end
^

/* empty dependent procedure body */
/* Clear: FNGERAITRECEBERSP01 for: SGCALCVENCSP */
/* AssignEmptyBody proc */
ALTER PROCEDURE FNGERAITRECEBERSP01(CALTVLR CHAR(1),
ICODEMP INTEGER,
SCODFILIAL SMALLINT,
ICODREC INTEGER,
ICODEMPPG INTEGER,
SCODFILIALPG SMALLINT,
ICODPLANOPAG INTEGER,
NVLRREC NUMERIC(15,5),
DDATAREC DATE,
DDTCOMPREC DATE,
CFLAG CHAR(1),
ICODEMPBO INTEGER,
SCODFILIALBO SMALLINT,
CCODBANCO CHAR(3),
ICODEMPTC INTEGER,
SCODFILIALTC SMALLINT,
ICODTIPOCOB INTEGER,
ICODEMPCB INTEGER,
SCODFILIALCB SMALLINT,
CODCARTCOB CHAR(3),
NVLRCOMIREC NUMERIC(15,5),
OBSREC VARCHAR(250),
CODEMPCA INTEGER,
CODFILIALCA SMALLINT,
NUMCONTA CHAR(10),
CODEMPPN INTEGER,
CODFILIALPN SMALLINT,
CODPLAN CHAR(13),
CODEMPCC INTEGER,
CODFILIALCC SMALLINT,
ANOCC INTEGER,
CODCC CHAR(19),
VLRBASECOMIS NUMERIC(15,5))
 RETURNS(I INTEGER)
 AS
 BEGIN EXIT; END
^

/* Alter (SGCALCVENCSP) */
ALTER PROCEDURE SGCALCVENCSP(CODEMP INTEGER,
DTBASE DATE,
DTVENC DATE,
REGRVCTO CHAR(1),
RVSAB CHAR(1),
RVDOM CHAR(1),
RVFER CHAR(1),
RVDIA CHAR(1),
DIAVCTO SMALLINT,
DIASVCTO SMALLINT)
 RETURNS(DTVENCRET DATE)
 AS
declare variable maxloop smallint;
declare variable curloop smallint;
declare variable dttemp date;
declare variable valorinc smallint;
declare variable codfilial smallint;
declare variable curloop02 smallint;
begin
  DTVENCRET = DTVENC;

  -- Busca o codigo da filial que será utilizado em duas regras
  if ( (REGRVCTO<>'N') and (RVFER = 'S') ) then
  begin
     SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'SGFERIADO') INTO :CODFILIAL;
  end

  -- Logica pra dia fixo
  if ( RVDIA = 'F' ) then
  begin
     MAXLOOP = 2;
     CURLOOP = 1;
     while ( CURLOOP<MAXLOOP ) do
     begin
        DTTEMP = DTVENCRET + ( 1 - EXTRACT(DAY FROM DTVENCRET) );
        DTTEMP = DTTEMP + DIAVCTO - 1;
        -- Objetivo do loop é voltar quando o dia fixo for no final do mês.
        while ( ( ( extract( month from DTVENCRET ) ) < ( extract( month from DTTEMP ) ) ) or
                ( ( extract( year from DTVENCRET ) ) < ( extract( year from DTTEMP ) ) ) ) do
        begin
           DTTEMP = DTTEMP - 1;
        end
        DTVENCRET = DTTEMP;
        if ( DTVENCRET<DTBASE ) then
        begin
           DTVENCRET = addmonth(DTVENCRET,1);
        end
        else
        begin
           break;
        end
        CURLOOP = CURLOOP + 1;
     end
  end
  -- Logica para ajustar dias uteis
  else if ( RVDIA = 'U' ) then
  begin
     while ( ( extract(month from DTVENCRET)<=extract(month from DTBASE) ) and
             ( extract(year from DTVENCRET)<=extract(year from DTBASE ) ) and
             ( DIASVCTO>0 ) ) do
     begin
        DTVENCRET = addmonth(DTVENCRET,1);
     end
     DTTEMP = DTVENCRET + ( 1 - EXTRACT(DAY FROM DTVENCRET) );
     DTVENCRET = DTTEMP;
     if (DIAVCTO<28) then -- Se for menor que dia 28 calcula o dia útil
     begin                -- Caso contrário vai será o último dia útil.
        CURLOOP02 = 1;
        while (CURLOOP02<12) do
        begin
           CURLOOP = 1;
           MAXLOOP = DIAVCTO;
           while ( CURLOOP < MAXLOOP )  do
           begin
              DTTEMP = null;
              if (RVFER='S') then
              begin
                 SELECT DATAFER FROM SGFERIADO F
                   WHERE F.CODEMP=:CODEMP AND F.CODFILIAL=:CODFILIAL AND
                     F.DATAFER=:DTVENCRET AND F.BANCFER='S'
                       INTO :DTTEMP;
              end
              if ( ( (extract( weekday from DTVENCRET )=0) and (RVDOM='S')  ) or
                   ( (extract( weekday from DTVENCRET )=6) and (RVSAB='S')  ) or
                   ( (RVFER='S') and (DTVENCRET=DTTEMP) ) ) then
              begin
                 DTVENCRET = DTVENCRET + 1;
              end
              else
              begin

                 DTVENCRET = DTVENCRET + 1;
                 CURLOOP = CURLOOP + 1;
              end
           end
           if (DTVENCRET<=DTBASE) then
           begin
              DTTEMP = DTVENCRET + ( 1 - EXTRACT(DAY FROM DTVENCRET) );
              DTVENCRET = DTTEMP;
              while ( ( extract(month from DTVENCRET)<=extract(month from DTBASE) ) and
                  ( extract(year from DTVENCRET)<=extract(year from DTBASE ) ) ) do
              begin
                 DTVENCRET = addmonth(DTVENCRET,1);
              end
           end
           else
           begin
              break;
           end
           CURLOOP02 = CURLOOP02 + 1;
        end
     end
     else
     begin
        DTTEMP = addmonth(DTVENCRET,1);
        DTVENCRET = DTTEMP - 1;
     end
  end

--  if (extract(month from dtvencret)=8) then
--  begin
--     exception fnreceberex02 'VENCIMENTO: '||CAST(dtvencret AS CHAR(10))||'REGRAVCTO = ' || REGRVCTO || 'REGRA DIA '|| RVDIA;

--  end


  -- Logica para ajustar finais de semana e feriados
  if ( (REGRVCTO<>'N') ) then
  begin
     MAXLOOP = 30;
     CURLOOP = 1;
     if ( REGRVCTO='A' ) then
     begin
        VALORINC = -1;
     end
     else
     begin
        VALORINC = 1;
     end
     while (CURLOOP<MAXLOOP) do
     begin
        if ( ( (extract( weekday from dtvencret )=0) and (RVDOM='S')  ) or
             ( (extract( weekday from dtvencret )=6) and (RVSAB='S')  ) ) then
        begin
           DTVENCRET = DTVENCRET + VALORINC;
        end
        else if (RVFER='S') then
        begin
           DTTEMP = NULL;
           SELECT DATAFER FROM SGFERIADO F
             WHERE F.CODEMP=:CODEMP AND F.CODFILIAL=:CODFILIAL AND
               F.DATAFER=:DTVENCRET AND F.BANCFER='S'
                 INTO :DTTEMP;
           if ( (DTTEMP IS NOT NULL) AND (DTTEMP=DTVENCRET) ) then
           begin
             DTVENCRET = DTVENCRET + VALORINC;
           end
           else
           begin
             break;
           end
        end
        else
        begin
           break;
        end
        CURLOOP = CURLOOP + 1;
     end
  end
  suspend;
end
^

/* Alter (SGGRANTUSERSP) */
ALTER PROCEDURE SGGRANTUSERSP AS
DECLARE VARIABLE CIDGRPUSU CHAR(8);
DECLARE VARIABLE CIDUSU CHAR(8);
DECLARE VARIABLE CSQL VARCHAR(200);
begin
  FOR SELECT DISTINCT IDGRPUSU, IDUSU FROM SGUSUARIO
     INTO :CIDGRPUSU, :CIDUSU DO
  BEGIN
      CSQL = 'GRANT '||RTRIM(CIDGRPUSU)||' TO USER '||RTRIM(CIDUSU);
      EXECUTE STATEMENT CSQL;
  END
  suspend;
end
^

/* Alter (SGINICONSP) */
ALTER PROCEDURE SGINICONSP(ICODEMP INTEGER,
CIDUSU CHAR(8),
ICODFILIALSEL SMALLINT,
ICODTERM SMALLINT)
 RETURNS(SRET SMALLINT)
 AS
DECLARE VARIABLE ICONECTADO INTEGER;
DECLARE VARIABLE ICODFILIALSELCX SMALLINT;
DECLARE VARIABLE ICODEMPTMP INTEGER;
DECLARE VARIABLE ICODFILIAL SMALLINT;
begin
  /* Procedure para inicialização da conexão com o banco de dados */
  SRET = 0;
  if (ICODEMP IS NULL) then
     ICODEMP = 99;
  /*CTEMP = printLog('Vai verificar o usuário');*/
  CIDUSU = lower(CIDUSU);
  IF ( CIDUSU='sysdba' ) THEN
  BEGIN
/*     CTEMP = printLog('Usuário sysdba');*/

     SELECT CODEMP FROM SGEMPRESA WHERE CODEMP=:ICODEMP INTO :ICODEMPTMP;
     IF (ICODEMPTMP IS NULL) THEN
        EXECUTE PROCEDURE SGATUALIZABDSP(:ICODEMP);
  END
  SELECT CODFILIAL FROM SGUSUARIO WHERE IDUSU=:cIdUsu AND
      CODEMP=:ICODEMP  INTO :iCodFilial;
/*  CTEMP = printLog('O usuário é = '||cIdUsu); */

/*  CTEMP = printLog('Contador de usuários '||cIdUsu); */

  if (iCodFilial is null) then
    EXCEPTION SGCONEXAOEX02;

  if (iCodFilialSel is not null) then
  begin
      SRET = 1;
      SELECT CONECTADO, CODFILIALSEL FROM SGCONEXAO
        WHERE NRCONEXAO=CURRENT_CONNECTION INTO :iConectado, iCodFilialSelCX;
      if (iConectado is null) then
          INSERT INTO SGCONEXAO (NRCONEXAO, CODEMP,CODFILIAL,IDUSU,CODFILIALSEL,CONECTADO,CODTERM)
            VALUES (CURRENT_CONNECTION, :iCodemp, :iCodfilial, :cIdusu, :iCodfilialSel, 1, :iCodTerm);
      else
      begin
          if (iConectado<=0) then
             UPDATE SGCONEXAO SET CONECTADO=1, CODFILIALSEL=:iCodfilialSel, CODTERM = :iCodTerm,
               CODEMP=:iCodemp, CODFILIAL=:iCodfilial , IDUSU=:cIdUsu
               WHERE NRCONEXAO=CURRENT_CONNECTION;
          else
          begin
             if (not (iCodfilialSelCX=iCodfilialSel) ) then
                EXCEPTION SGCONEXAOEX01;
             else
                UPDATE SGCONEXAO SET CONECTADO=CONECTADO+1, CODTERM = :iCodTerm,
                   CODEMP=:iCodemp, CODFILIAL=:iCodfilial, IDUSU=:cIdUsu
                WHERE NRCONEXAO=CURRENT_CONNECTION;
          end
      end 
  end
  suspend;
end
^

/* Alter (SGRETFILIAL) */
ALTER PROCEDURE SGRETFILIAL(ICODEMP INTEGER,
SNOMETAB CHAR(30))
 RETURNS(ICODFILIAL SMALLINT)
 AS
DECLARE VARIABLE SEHME CHAR(1);
begin
  SELECT USOMEOBJ FROM SGOBJETO WHERE TIPOOBJ='TB' AND IDOBJ=:SNOMETAB AND CODEMP=:ICODEMP
    INTO sEhME;
  IF (sEhME = 'N') THEN
  BEGIN
    SELECT CODFILIALSEL FROM SGCONEXAO WHERE CODEMP=:ICODEMP AND
      NRCONEXAO=CURRENT_CONNECTION AND CONECTADO > 0 INTO ICODFILIAL;
  END
  ELSE
  BEGIN
    SELECT FL.CODFILIAL FROM SGFILIAL FL WHERE
      FL.CODEMP = :ICODEMP AND FL.MZFILIAL='S'
      INTO ICODFILIAL;
    IF (ICODFILIAL IS NULL) THEN
      EXCEPTION SGFILIALEX01;
  END
  IF (ICODFILIAL IS NULL) THEN
  BEGIN
    EXCEPTION SGFILIALEX02;
  END
  SUSPEND;
end
^

/* Alter (SGRETINFOUSU) */
ALTER PROCEDURE SGRETINFOUSU(CODEMP INTEGER,
IDUSU VARCHAR(128))
 RETURNS(ANOCCUSU SMALLINT,
CODEMPCCUSU INTEGER,
CODFILIALCCUSU SMALLINT,
CODEMPUSU INTEGER,
CODFILIALUSU SMALLINT,
CODCCUSU CHAR(19),
IDUSUS CHAR(8),
ALMOXARIFE CHAR(1),
APROVARMA CHAR(2))
 AS
begin
    select icodfilial from sgretfilial(:codemp, 'SGUSUARIO') into :codfilialusu;
    codempusu=:codemp;
    select first 1 u.codempcc, u.codfilialcc, u.anocc, u.codcc,
       u.idusu, u.almoxarifeusu, u.aprovrmausu
    from sgusuario u where lower(u.idusu)=lower(:idusu) and u.codemp=:codemp and u.codfilial=:codfilialusu
    into :codempccusu, :codfilialccusu, :anoccusu, :codccusu,
    :idusus, :almoxarife, :aprovarma;

    suspend;
end
^

/* Alter (SGRETMULTIALMOXSP) */
ALTER PROCEDURE SGRETMULTIALMOXSP(ICODEMP INTEGER)
 RETURNS(CMULTIALMOX CHAR(1))
 AS
DECLARE VARIABLE SCODFILIALPF SMALLINT;
begin
  /* Procedure Text */
  SELECT RF.ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'SGPREFERE1') RF
     INTO :SCODFILIALPF;
  SELECT MULTIALMOX FROM SGPREFERE1 WHERE CODEMP=:ICODEMP AND
     CODFILIAL=:SCODFILIALPF
     INTO :CMULTIALMOX;

/* Condição que evita null no valor do flag */
  CMULTIALMOX = coalesce(CMULTIALMOX,'N');

  suspend;
end
^

/* Alter (SGRETMULTICOMISSP) */
ALTER PROCEDURE SGRETMULTICOMISSP(ICODEMP INTEGER,
CODEMPTM INTEGER,
CODFILIALTM SMALLINT,
CODTIPOMOV INTEGER)
 RETURNS(CMULTICOMIS CHAR(1))
 AS
declare variable scodfilialpf smallint;
declare variable cmulticomistm char(1);
begin
    select rf.icodfilial from sgretfilial(:icodemp, 'SGPREFERE1') rf
        into :scodfilialpf;

    /* Verifica se o mecanismo de multiplos comissionados está habilitado nas preferências gerais */

    select pf.multicomis from sgprefere1 pf
        where pf.codemp=:icodemp and pf.codfilial=:scodfilialpf
    into :cmulticomis;

    /* Caso esteja habilitado nas preferências, verifica se o tipo de movimento suporta multiplos comissionados */
    if(:cmulticomis = 'S') then
    begin

        select tm.mcomistipomov from eqtipomov tm
            where tm.codemp=:codemptm and tm.codfilial=:codfilialtm and tm.codtipomov=:codtipomov
        into :cmulticomistm;

        if(:cmulticomis is null or :cmulticomistm='N') then
        begin
            cmulticomis = 'N';
        end

    end

  cmulticomis = coalesce(cmulticomis,'N');

  suspend;
end
^

/* Alter (SGRETVERSAO) */
ALTER PROCEDURE SGRETVERSAO RETURNS(VERSAO VARCHAR(30))
 AS
begin
    versao = '1.2.5.2 (30/07/2012)';
    suspend;
end
^

/* Alter (SGSETAGENDASP) */
ALTER PROCEDURE SGSETAGENDASP(CODAGD INTEGER,
CODEMP INTEGER,
DTAINIAGD DATE,
HRINIAGD TIME,
DTAFIMAGD DATE,
HRFIMAGD TIME,
ASSUNTOAGD CHAR(50),
DESCAGD VARCHAR(10000),
CODFILIALTA SMALLINT,
CODTIPOAGD INTEGER,
PRIORAGD SMALLINT,
CODAGE INTEGER,
TIPOAGE CHAR(5),
CODFILIALAE SMALLINT,
CODAGEEMIT INTEGER,
TIPOAGEEMIT CHAR(5),
CAAGD CHAR(2),
SITAGD CHAR(2),
RESOLUCAOMOTIVO VARCHAR(10000),
CODAGDAR INTEGER,
DIATODO CHAR(1))
 RETURNS(IRET INTEGER)
 AS
DECLARE VARIABLE IFILIALAGD INTEGER;
begin
  select ICODFILIAL from SGRETFILIAL(:CODEMP,'SGAGENDA') INTO IFILIALAGD;
  IF (CODAGD = 0) THEN
  BEGIN

    SELECT ISEQ FROM SPGERANUM(:CODEMP,:IFILIALAGD,'AG') INTO CODAGD;

    if(codagdar is not null ) then  -- Agendamento vinculado (repetição)
    begin
        insert into sgagenda (
            codemp, codfilial, codage, tipoage, codagd,
            dataagd, dtainiagd, hriniagd, dtafimagd, hrfimagd,
            assuntoagd, descagd, codempta, codfilialta, codtipoagd, prioragd, sitagd,
            codempae, codfilialae, codageemit, tipoageemit, caagd, resolucaomotivo,
            codempar,codfilialar,codagear,tipoagear,codagdar,diatodo)
        values (
            :codemp, :ifilialagd, :codage, :tipoage, :codagd,
            cast('today' as date), :dtainiagd, :hriniagd, :dtafimagd, :hrfimagd,
            :assuntoagd, :descagd, :codemp, :codfilialta, :codtipoagd, :prioragd, :sitagd,
            :codemp, :codfilialae, :codageemit, :tipoageemit, :caagd, :resolucaomotivo,
            :codemp,:ifilialagd,:codage,:tipoage,:codagdar,:diatodo
        );
    end
    else -- Agendamento simples, sem vínvulo (repetição)
    begin
        insert into sgagenda (
            CODEMP,CODFILIAL,CODAGE,TIPOAGE,CODAGD,
            DATAAGD,DTAINIAGD,HRINIAGD,DTAFIMAGD,HRFIMAGD,
            ASSUNTOAGD,DESCAGD,CODEMPTA,CODFILIALTA,CODTIPOAGD,PRIORAGD,SITAGD,
            CODEMPAE,CODFILIALAE,CODAGEEMIT,TIPOAGEEMIT,CAAGD, RESOLUCAOMOTIVO, DIATODO)
        values (
            :CODEMP,:IFILIALAGD,:CODAGE,:TIPOAGE,:CODAGD,
            CAST('today' AS DATE),:DTAINIAGD,:HRINIAGD,:DTAFIMAGD,:HRFIMAGD,
            :ASSUNTOAGD,:DESCAGD,:CODEMP,:CODFILIALTA,:CODTIPOAGD,:PRIORAGD,:SITAGD,
            :CODEMP,:CODFILIALAE,:CODAGEEMIT,:TIPOAGEEMIT,:CAAGD, :RESOLUCAOMOTIVO,:DIATODO

        );
    end
  end
  else
    update sgagenda set
      DTAINIAGD=:DTAINIAGD,HRINIAGD=:HRINIAGD,
      DTAFIMAGD=:DTAFIMAGD,HRFIMAGD=:HRFIMAGD,
      ASSUNTOAGD=:ASSUNTOAGD,DESCAGD=:DESCAGD,
      CODEMPTA=:CODEMP,CODFILIALTA=:CODFILIALTA,CODTIPOAGD=:CODTIPOAGD,
      PRIORAGD=:PRIORAGD,CAAGD=:CAAGD,
      SITAGD=:SITAGD,
      RESOLUCAOMOTIVO=:RESOLUCAOMOTIVO,
      codage=:codage, diatodo=:diatodo
      WHERE CODEMP=:CODEMP AND CODFILIAL=:IFILIALAGD
      AND CODAGD=:CODAGD AND TIPOAGE=:TIPOAGE;
  IRET = CODAGD;
  SUSPEND;
END
^

/* Alter (TKCONTCLISP) */
ALTER PROCEDURE TKCONTCLISP(CODEMP INTEGER,
CODFILIAL INTEGER,
CODCTO INTEGER,
CODFILIALTI INTEGER,
CODTIPOCLI INTEGER,
CODFILIALCC INTEGER,
CODCLASCLI INTEGER,
CODFILIALSR INTEGER,
CODSETOR INTEGER)
 RETURNS(IRET INTEGER)
 AS
DECLARE VARIABLE ICODCLI INTEGER;
DECLARE VARIABLE IFILIALCLI INTEGER;
BEGIN
  SELECT MAX(CODCLI)+1 FROM VDCLIENTE WHERE CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL INTO ICODCLI;
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP, 'VDCLIENTE') INTO IFILIALCLI;
  
  INSERT INTO VDCLIENTE (CODEMP,CODFILIAL,CODCLI,RAZCLI,CODEMPCC,CODFILIALCC,CODCLASCLI,
  CODEMPVD,CODFILIALVD,CODVEND,CODEMPSR,CODFILIALSR,CODSETOR,NOMECLI,CODEMPTI,CODFILIALTI,
  CODTIPOCLI,DATACLI,PESSOACLI,ATIVOCLI,CNPJCLI,INSCCLI,CPFCLI,RGCLI,ENDCLI,NUMCLI,
  COMPLCLI,BAIRCLI,CIDCLI,UFCLI,CEPCLI,FONECLI,FAXCLI,EMAILCLI,CONTCLI,CTOCLI,
  CODPAIS, SIGLAUF, CODMUNIC)
    SELECT :CODEMP,:IFILIALCLI,:ICODCLI,RAZCTO,:CODEMP,:CODFILIALCC,:CODCLASCLI,
    CODEMPVD,CODFILIALVD,CODVEND,:CODEMP,:CODFILIALSR,:CODSETOR,NOMECTO,:CODEMP,:CODFILIALTI,
    :CODTIPOCLI,DATACTO,PESSOACTO,ATIVOCTO,CNPJCTO,INSCCTO,CPFCTO,RGCTO,ENDCTO,NUMCTO,
    COMPLCTO,BAIRCTO,CIDCTO,UFCTO,CEPCTO,FONECTO,FAXCTO,EMAILCTO,CONTCTO,'O',
    CODPAIS, SIGLAUF, CODMUNIC
  FROM TKCONTATO WHERE
    CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL AND CODCTO=:CODCTO;
    
  INSERT INTO TKCONTCLI (CODEMPCTO, CODFILIALCTO, CODCTO, CODEMPCLI, CODFILIALCLI, CODCLI)
    VALUES (:CODEMP, :CODFILIAL, :CODCTO, :CODEMP, :IFILIALCLI, :ICODCLI);
  IRET = ICODCLI;
  
  SUSPEND;
END
^

/* Alter (TKGERACAMPANHACTO) */
ALTER PROCEDURE TKGERACAMPANHACTO(TIPOCTO CHAR(1),
CODEMPCA INTEGER,
CODFILIALCA SMALLINT,
CODCAMP CHAR(13),
CODEMPCO INTEGER,
CODFILIALCO SMALLINT,
CODCTO INTEGER,
CODEMPAT INTEGER,
CODFILIALAT SMALLINT,
CODATIV INTEGER,
SITHISTTK CHAR(2),
DESCHISTTK VARCHAR(1000))
 AS
declare variable seqcampcto integer; /* Código do contato pra validação. */
declare variable seqsitcamp integer;
declare variable codfilialhi smallint;
declare variable codhisttk integer;
declare variable codempae integer;
declare variable codfilialae smallint;
declare variable codatend integer; /* Código do atendente. */
declare variable codempus integer;
declare variable codfilialus smallint;
declare variable idusu char(8); /* Id do usuário */
begin

    select icodfilial from sgretfilial(:codempca,'TKHISTORICO') into codfilialhi;
    select iseq from spgeranum(:codempca,:codfilialhi,'HI') into codhisttk;
    select codempusu, codfilialusu, idusus from sgretinfousu(:codempca, user) where codempusu=:codempca into
            :codempus, :codfilialus, :idusu;

    select codemp, codfilial, codatend from atatendente
            where codempus=:codempus and codfilialus=:codfilialus and idusu=:idusu
    into codempae, codfilialae, codatend;

    if(:codatend is null) then
    begin
        exception TKGERACAMANHACTO01 ' - ID: ' || idusu || ' - User: '|| user ;
    end

    -- Verifica se o contato já foi vinculado à campanha

    if ( tipocto = 'O' ) then 
    begin 
    	select seqcampcto from tkcampanhacto cc
	        where cc.codemp=:codempca and cc.codfilial=:codfilialca and cc.codcamp=:codcamp
            	and cc.codempco=:codempco and cc.codfilialco=:codfilialco and cc.codcto=:codcto
    	into :seqcampcto;
    end
    else
    begin
    	select seqcampcto from tkcampanhacto cc
	        where cc.codemp=:codempca and cc.codfilial=:codfilialca and cc.codcamp=:codcamp
            	and cc.codempcl=:codempco and cc.codfilialcl=:codfilialco and cc.codcli=:codcto
    	into :seqcampcto;
    end

    if( (:seqcampcto is null) or (:seqcampcto=0) ) then
    begin
        seqcampcto = 1;
        if ( tipocto = 'O' ) then 
        begin
	        insert into tkcampanhacto (codemp, codfilial, codcamp, seqcampcto, codempco, codfilialco, codcto)
		        values(:codempca, :codfilialca, :codcamp, :seqcampcto, :codempco, :codfilialco, :codcto);
        end
        else 
        begin
	        insert into tkcampanhacto (codemp, codfilial, codcamp, seqcampcto, codempcl, codfilialcl, codcli)
		        values(:codempca, :codfilialca, :codcamp, :seqcampcto, :codempco, :codfilialco, :codcto);
        end
    end
    else
    begin
    	seqsitcamp = 0;
        select max(sc.seqsitcamp) from tksitcamp sc
	            where sc.codemp=:codempca and sc.codfilial=:codfilialca and 
	            	sc.codcamp=:codcamp and sc.tipocto=:tipocto 
			        into :seqsitcamp;

        if(:seqsitcamp is null) then
        begin
            seqsitcamp = 0;
        end

        seqsitcamp = seqsitcamp + 1;

        if ( tipocto = 'O' ) then 
        begin 
	        insert into tksitcamp (codemp,codfilial,codcamp,codempco,codfilialco,codcto,seqsitcamp,
	                codempav,codfilialav,codativ, tipocto)
		        values (:codempca,:codfilialca,:codcamp,:codempco,:codfilialco,:codcto,:seqsitcamp,
	                :codempat,:codfilialat ,:codativ, :tipocto );
	    end
	    else
	    begin
	        insert into tksitcamp (codemp,codfilial,codcamp,codempcl,codfilialcl,codcli,seqsitcamp,
	                codempav,codfilialav,codativ, tipocto)
		        values (:codempca,:codfilialca,:codcamp,:codempco,:codfilialco,:codcto,:seqsitcamp,
	                :codempat,:codfilialat ,:codativ, :tipocto );
	    end
    end

    -- Inserindo histórico
    
	if ( tipocto = 'O' ) then 
	begin 
	    insert into tkhistorico (codemp, codfilial,codhisttk,horahisttk,datahisttk,
                         codempco,codfilialco,codcto,deschisttk,codempae,codfilialae,codatend,
                         sithisttk,tipohisttk, tipocto)
    		values (:codempca,:codfilialhi,:codhisttk,cast('now' as time),cast('now' as date),
            		  :codempco,:codfilialco,:codcto,:deschisttk,:codempae,:codfilialae,:codatend,
              			:sithisttk,'C', :tipocto);
    end
    else
    begin
	    insert into tkhistorico (codemp, codfilial,codhisttk,horahisttk,datahisttk,
                         codempcl,codfilialcl,codcli,deschisttk,codempae,codfilialae,codatend,
                         sithisttk,tipohisttk, tipocto)
    		values (:codempca,:codfilialhi,:codhisttk,cast('now' as time),cast('now' as date),
            		  :codempco,:codfilialco,:codcto,:deschisttk,:codempae,:codfilialae,:codatend,
              			:sithisttk,'C', :tipocto);
    end
   

end
^

/* Alter (TKSETHISTSP) */
ALTER PROCEDURE TKSETHISTSP(CODHISTTK INTEGER,
CODEMP INTEGER,
CODFILIALCO INTEGER,
CODCTO INTEGER,
CODFILIALCL INTEGER,
CODCLI INTEGER,
DESCHISTTK VARCHAR(10000),
CODFILIALAE INTEGER,
CODATEND INTEGER,
SITHISTTK CHAR(2),
DATAHISTTK DATE,
TIPOHISTTK CHAR(1))
 RETURNS(IRET INTEGER)
 AS
DECLARE VARIABLE IFILIALHIST INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'TKHISTORICO') INTO IFILIALHIST;
  IF (TIPOHISTTK = '') THEN
  BEGIN
    TIPOHISTTK = 'H';
  END
  IF (CODHISTTK = 0) THEN
  BEGIN
    SELECT ISEQ FROM SPGERANUM(:CODEMP,:IFILIALHIST,'HI') INTO CODHISTTK;
    INSERT INTO TKHISTORICO(CODEMP,CODFILIAL,CODHISTTK,DATAHISTTK,HORAHISTTK,CODEMPCO,CODFILIALCO,
      CODCTO,CODEMPCL,CODFILIALCL,CODCLI,DESCHISTTK,CODEMPAE,CODFILIALAE,CODATEND,SITHISTTK,TIPOHISTTK)
      VALUES (:CODEMP,:IFILIALHIST,:CODHISTTK,:DATAHISTTK,CAST('now' AS TIME),:CODEMP,:CODFILIALCO,
      :CODCTO,:CODEMP,:CODFILIALCL,:CODCLI,:DESCHISTTK,:CODEMP,:CODFILIALAE,:CODATEND,:SITHISTTK,:TIPOHISTTK);
  END
  ELSE
  BEGIN
    UPDATE TKHISTORICO SET DATAHISTTK=:DATAHISTTK,CODEMPCO=:CODEMP,CODFILIALCO=:CODFILIALCO,
      CODCTO=:CODCTO,CODEMPCL=:CODEMP,CODFILIALCL=:CODFILIALCL,
      CODCLI=:CODCLI,DESCHISTTK=:DESCHISTTK,CODEMPAE=:CODEMP,
      CODFILIALAE=:CODFILIALAE,CODATEND=:CODATEND,SITHISTTK=:SITHISTTK,TIPOHISTTK=:TIPOHISTTK
      WHERE CODEMP=:CODEMP AND CODFILIAL=:IFILIALHIST AND CODHISTTK=:CODHISTTK;
    /*IF (NOT SITHISTTK IN ('AG')) THEN
      DELETE FROM SGAGENDA WHERE OBJORIGAGD='HISTO' AND CODEMPCH=:CODEMP AND
        CODFILIALCH=:IFILIALHIST AND CODCHAVE=:CODHISTTK; */
  END
  SUSPEND;
END
^

/* Alter (VDADICCOMISSAOSP) */
ALTER PROCEDURE VDADICCOMISSAOSP(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
ICODREC INTEGER,
INPARCITREC INTEGER,
NVLRVENDACOMI NUMERIC(15,5),
NVLRCOMI NUMERIC(15,5),
DDATACOMI DATE,
DDTCOMPCOMI DATE,
DDTVENCCOMI DATE,
CTIPOCOMI CHAR(1),
CODEMPVD INTEGER,
CODFILIALVD SMALLINT,
CODVEND INTEGER)
 AS
declare variable scodfilialcs smallint;
declare variable icodcomi integer;
declare variable cstatuscomi char(2);
begin

    -- Se o valor for nulo ou 0 deve deletar a comissão já gerada
    if ( (nvlrcomi is null) or  (nvlrcomi=0) ) then
    begin

        delete from vdcomissao co
        where co.codemprc=:icodemp and co.codfilialrc=:scodfilial and co.codrec=:icodrec and co.nparcitrec=:inparcitrec and
        co.tipocomi=:ctipocomi and codempvd=:codempvd and codfilialvd=:codfilialvd and codvend=:codvend;

    end
    -- Caso seja um estorno de comissão
    else if (nvlrcomi<0) then
    begin

        -- Buscando a filial da tabela de comissões
        select icodfilial from sgretfilial(:icodemp,'VDCOMISSAO') into :scodfilialcs;

        -- Buscando novo numero para
        select max(codcomi) from vdcomissao where codemp=:icodemp and codfilialvd = :scodfilialcs into icodcomi;

        if (:icodcomi is null) then
            icodcomi = 1;
        else
            icodcomi = icodcomi + 1;

        -- Inserindo na tabela de comissões
        insert into vdcomissao (
            codemp, codfilial, codcomi, codempRc, codfilialrc, codrec, nparcitrec, vlrvendacomi, vlrcomi, datacomi,
            dtcompcomi, dtvenccomi, statuscomi, tipocomi, codempvd, codfilialvd, codvend )
        values (
            :icodemp, :scodfilialcs, :icodcomi, :icodemp, :scodfilial, :icodrec, :inparcitrec, :nvlrvendacomi, :nvlrcomi, :ddatacomi,
            :ddtcompcomi, :ddtvenccomi, 'CE', :ctipocomi, :codempvd, :codfilialvd,:codvend
            );

        -- Transforma o valor da comissão em positivo e programa para o proximo pagto.
        nvlrcomi = nvlrcomi * -1;

        insert into vdcomissao (
            codemp, codfilial, codcomi, codemprc, codfilialrc, codrec, nparcitrec,
            vlrvendacomi, vlrcomi, datacomi, dtcompcomi,  dtvenccomi, statuscomi, tipocomi, codempvd, codfilialvd, codvend )
        values (
            :icodemp, :scodfilialcs, :icodcomi, :icodemp, :scodfilial, :icodrec, :inparcitrec,
            :nvlrvendacomi, :nvlrcomi, :ddatacomi, :ddtcompcomi, :ddtvenccomi, 'C1', :ctipocomi, :codempvd,:codfilialvd,:codvend
            );

    end
    else
    begin

        if (ctipocomi='F') then
            cstatuscomi = 'C2';
        else
            cstatuscomi = 'C1';

        -- Buscando a filial da tabela de comissões
        select icodfilial from sgretfilial( :icodemp, 'VDCOMISSAO') into :scodfilialcs;

        -- Buscando o código da comissão já existente
        select codcomi from vdcomissao
        where codemp=:icodemp and codfilialrc=:scodfilial and codrec=:icodrec and nparcitrec=:inparcitrec and
        tipocomi=:ctipocomi and codempvd=:codempvd and codfilialvd=:codfilialvd and codvend=:codvend
        into :icodcomi;

        -- Caso já não exista a comissão deve inserir
        if (icodcomi is null) then
        begin
            --Buscando um novo código
            select max(codcomi) from vdcomissao where codemp=:icodemp and codfilial = :scodfilialcs into icodcomi;

            if (:icodcomi is null) then
                icodcomi = 1;
            else
                icodcomi = icodcomi + 1;

            -- Inserindo na tabela de comissões
            insert into vdcomissao( codemp, codfilial, codcomi, codemprc, codfilialrc, codrec, nparcitrec,
            vlrvendacomi, vlrcomi, datacomi, dtcompcomi, dtvenccomi, statuscomi, tipocomi, codempvd, codfilialvd, codvend)
            values (
                :icodemp, :scodfilialcs, :icodcomi, :icodemp, :scodfilial, :icodrec, :inparcitrec,
                :nvlrvendacomi, :nvlrcomi, :ddatacomi, :ddtcompcomi, :ddtvenccomi, :cstatuscomi, :ctipocomi, :codempvd, :codfilialvd, :codvend
            );

        end
        -- Se encontrou a comissão atualiza
        else
        begin

            update vdcomissao set vlrvendacomi=:nvlrvendacomi, vlrcomi=:nvlrcomi, datacomi=:ddatacomi,
            dtvenccomi=:ddtvenccomi, statuscomi=:cstatuscomi
            where codemp=:icodemp and codfilial=:scodfilialcs and codcomi=:icodcomi and codempvd=:codempvd and
            codfilialvd=:codfilialvd and codvend=:codvend and statuscomi!='CP' ;

        end

    end
    suspend;
end
^

/* Alter (VDADICITEMPDVSP) */
ALTER PROCEDURE VDADICITEMPDVSP(CODVENDA INTEGER,
CODEMP INTEGER,
CODFILIAL CHAR(8),
CODPROD INTEGER,
CODEMPPD INTEGER,
CODFILIALPD INTEGER,
QTDITVENDA NUMERIC(9,5),
VLRPRECOITVENDA NUMERIC(18,5),
VLRDESCITVENDA NUMERIC(18,5),
PERCDESCITVENDA NUMERIC(15,5),
VLRCOMISITVENDA NUMERIC(15,5),
PERCCOMISITVENDA NUMERIC(15,5),
SCODLOTE VARCHAR(20),
CODEMPLE INTEGER,
CODFILIALLE SMALLINT,
CODFILIALCV SMALLINT,
CODCONV INTEGER)
 RETURNS(CODITVENDA INTEGER,
PERCICMSITVENDA NUMERIC(9,2),
VLRBASEICMSITVENDA NUMERIC(18,3),
VLRICMSITVENDA NUMERIC(18,3),
VLRLIQITVENDA NUMERIC(18,3),
TIPOFISC CHAR(2))
 AS
declare variable icodfilialnt smallint;
declare variable icodcli integer;
declare variable icodfilialcl integer;
declare variable icodtipomov integer;
declare variable icodfilialtm integer;
declare variable scodnat char(4);
declare variable sorigfisc char(1);
declare variable scodtrattrib char(2);
declare variable icodfilialtt smallint;
declare variable icodfilialme smallint;
declare variable icodmens smallint;
declare variable percipiitvenda numeric(9,2);
declare variable vlrbaseipiitvenda numeric(15,5);
declare variable vlripiitvenda numeric(15,5);
declare variable vlrproditvenda numeric(15,5);
declare variable srefprod varchar(20);
declare variable obsitorc varchar(500);
declare variable ufcli char(2);
declare variable ufflag char(1);
declare variable percred numeric(9,2);
begin

  SELECT MAX(CODITVENDA)+1 FROM VDITVENDA WHERE CODVENDA=:CODVENDA
    AND CODFILIAL=:CODFILIAL AND CODEMP=:CODEMP INTO CODITVENDA;

  IF (CODITVENDA IS NULL) THEN
    CODITVENDA = 1;

/*Informações da Venda.:*/

  SELECT V.CODCLI,V.CODFILIALCL,C.UFCLI,V.CODTIPOMOV,V.CODFILIALTM FROM VDVENDA V, VDCLIENTE C
    WHERE V.CODEMP=:CODEMP AND V.CODFILIAL=:CODFILIAL
    AND V.CODVENDA=:CODVENDA AND V.TIPOVENDA='E' AND
    C.CODCLI=V.CODCLI AND C.CODEMP=V.CODEMPCL AND
    C.CODFILIAL=V.CODFILIALCL INTO ICODCLI,ICODFILIALCL,UFCLI,ICODTIPOMOV,ICODFILIALTM;


  UFFLAG = 'N';

  SELECT 'S' FROM SGFILIAL  WHERE CODEMP=:CODEMP
    AND CODFILIAL=:CODFILIAL AND UFFILIAL=:UFCLI INTO UFFLAG;


  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'LFNATOPER') INTO ICODFILIALNT;
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'LFTRATTRIB') INTO ICODFILIALTT;
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'LFMENSAGEM') INTO ICODFILIALME;

  SELECT C.ALIQIPIFISC
      FROM EQPRODUTO P, LFITCLFISCAL C
         WHERE P.CODPROD=:CODPROD AND P.CODFILIAL=:CODFILIALPD
         AND P.CODEMP=:CODEMPPD AND C.CODFISC=P.CODFISC AND C.CODFILIAL=P.CODFILIALFC and
         C.geralfisc='S'
         AND C.CODEMP=P.CODEMPFC INTO PERCIPIITVENDA;

  SELECT CODNAT FROM
      LFBUSCANATSP(:CODFILIAL,:CODEMP,:CODFILIALPD,
                   :CODPROD,:CODEMP,:ICODFILIALCL,
                   :ICODCLI,NULL,NULL,NULL,:ICODFILIALTM,:ICODTIPOMOV,null)
      INTO SCODNAT;

  IF (SCODNAT IS NULL) THEN
      EXCEPTION VDITVENDAEX03;

  SELECT TIPOFISC,REDFISC,CODTRATTRIB,ORIGFISC,CODMENS,ALIQFISC FROM
      LFBUSCAFISCALSP(:CODEMP,:CODFILIALPD,:CODPROD,
                      :CODEMP,:ICODFILIALCL,:ICODCLI,
                      :CODEMP,:ICODTIPOMOV,:ICODFILIALTM, 'VD',:SCODNAT,null,null,null,null)
      INTO TIPOFISC,PERCRED,SCODTRATTRIB,SORIGFISC,ICODMENS,PERCICMSITVENDA;

  VLRPRODITVENDA = (QTDITVENDA*VLRPRECOITVENDA);
  VLRBASEIPIITVENDA = 0;
  VLRBASEICMSITVENDA = 0;
  VLRICMSITVENDA = 0;
  VLRIPIITVENDA = 0;
  IF (PERCIPIITVENDA IS NULL) THEN
     PERCIPIITVENDA = 0;

  IF ( TIPOFISC = 'II') THEN
  BEGIN
    PERCICMSITVENDA = 0;
    VLRICMSITVENDA = 0;
    VLRBASEICMSITVENDA = 0;
    PERCIPIITVENDA = 0;
    VLRIPIITVENDA = 0;
    VLRBASEIPIITVENDA = 0;
  END
  ELSE IF ( TIPOFISC = 'FF') THEN
  BEGIN
    PERCICMSITVENDA = 0;
    VLRICMSITVENDA = 0;
    VLRBASEICMSITVENDA = 0;
    PERCIPIITVENDA = 0;
    VLRIPIITVENDA = 0;
    VLRBASEIPIITVENDA = 0;
  END
  ELSE IF ( TIPOFISC = 'NN') THEN
  BEGIN
    PERCICMSITVENDA = 0;
    VLRICMSITVENDA = 0;
    VLRBASEICMSITVENDA = 0;
    PERCIPIITVENDA = 0;
    VLRIPIITVENDA = 0;
    VLRBASEIPIITVENDA = 0;
  END
  ELSE IF ( TIPOFISC = 'TT') THEN
  BEGIN
    IF (PERCICMSITVENDA = 0 OR PERCICMSITVENDA IS NULL) THEN
      SELECT PERCICMS FROM LFBUSCAICMSSP (:SCODNAT,:UFCLI,:CODEMP,:CODFILIAL) INTO PERCICMSITVENDA;
    IF (PERCRED IS NULL) THEN
      PERCRED = 0;
    VLRBASEICMSITVENDA = (VLRPRODITVENDA-VLRDESCITVENDA) - ((VLRPRODITVENDA-VLRDESCITVENDA)*(PERCRED/100));
    VLRBASEIPIITVENDA = VLRPRODITVENDA-VLRDESCITVENDA;
    VLRICMSITVENDA = VLRBASEICMSITVENDA*(PERCICMSITVENDA/100);
    VLRIPIITVENDA = VLRBASEIPIITVENDA*(PERCIPIITVENDA/100);
  END
  VLRLIQITVENDA= VLRPRODITVENDA+VLRIPIITVENDA-VLRDESCITVENDA;
  INSERT INTO VDITVENDA (
     CODEMP,CODFILIAL,TIPOVENDA,CODVENDA,CODITVENDA,
     CODEMPNT,CODFILIALNT,CODNAT,
     CODEMPPD,CODFILIALPD,CODPROD,
     CODEMPLE,CODFILIALLE,CODLOTE,
     QTDITVENDA,PRECOITVENDA,PERCDESCITVENDA,VLRDESCITVENDA,
     VLRCOMISITVENDA,PERCCOMISITVENDA,
     PERCICMSITVENDA,VLRBASEICMSITVENDA,VLRICMSITVENDA,
     PERCIPIITVENDA,VLRBASEIPIITVENDA,VLRIPIITVENDA,VLRLIQITVENDA,
     VLRPRODITVENDA,REFPROD,ORIGFISC,
     CODEMPTT,CODFILIALTT,CODTRATTRIB,TIPOFISC,
     CODEMPME,CODFILIALME,CODMENS,OBSITVENDA,
     CODEMPCV,CODFILIALCV,CODCONV) VALUES (
     :CODEMP,:CODFILIAL,'E',:CODVENDA,:CODITVENDA,
     :CODEMP,:ICODFILIALNT,:SCODNAT,
     :CODEMPPD,:CODFILIALPD,:CODPROD,
     :CODEMPLE,:CODFILIALLE,:SCODLOTE,
     :QTDITVENDA,:VLRPRECOITVENDA,:PERCDESCITVENDA,:VLRDESCITVENDA,
     :VLRCOMISITVENDA,:PERCCOMISITVENDA,
     :PERCICMSITVENDA,:VLRBASEICMSITVENDA,:VLRICMSITVENDA,
     :PERCIPIITVENDA,:VLRBASEIPIITVENDA,:VLRIPIITVENDA,:VLRLIQITVENDA,
     :VLRPRODITVENDA,:SREFPROD,:SORIGFISC,
     :CODEMP,:ICODFILIALTT,:SCODTRATTRIB,:TIPOFISC,
     :CODEMP,:ICODFILIALME,:ICODMENS,:OBSITORC,
     :CODEMP, :CODFILIALCV,:CODCONV);
  SUSPEND;
END
^

/* Alter (VDADICITORCRECMERCSP) */
ALTER PROCEDURE VDADICITORCRECMERCSP(CODEMP INTEGER,
CODFILIAL SMALLINT,
TICKET INTEGER,
CODEMPOC INTEGER,
CODFILIALOC SMALLINT,
CODORC INTEGER,
COMPONENTES CHAR(1),
SERVICOS CHAR(1),
NOVOS CHAR(1))
 AS
declare variable codemppd integer;
declare variable codfilialpd integer;
declare variable codprod integer;
declare variable coditos integer;
declare variable coditorc integer;
declare variable codprodant integer;
declare variable coditrecmerc integer;
declare variable refprod varchar(20);
declare variable codemptm integer;
declare variable codfilialtm smallint;
declare variable codtipomov integer;
declare variable codempax integer;
declare variable codfilialax smallint;
declare variable codalmox integer;
declare variable precoitorc numeric(15,5);
declare variable qtditorc numeric(15,5);
declare variable codempcl integer;
declare variable codfilialcl smallint;
declare variable codcli integer;
declare variable codemppg integer;
declare variable codfilialpg smallint;
declare variable codplanopag integer;
declare variable gerachamado char(1);
declare variable obsitorc varchar(10000);
declare variable descprod char(100);
declare variable vlrliqitorc numeric(15,5);
declare variable vlrproditorc numeric(15,5);
declare variable usaprecopecaserv char(1);
declare variable codprodpeca integer;
declare variable garantia char(1);
declare variable codprodir integer;
declare variable refprodir varchar(20);
begin
    
    -- Buscando preferencias do GMS
    select coalesce(p8.usaprecopecaserv,'N') from sgprefere8 p8
    where p8.codemp=:codemp and p8.codfilial=:codfilial
    into :usaprecopecaserv;

    -- Buscando informações do orçamento
    select codempcl, codfilialcl, codcli, codemppg, codfilialpg, codplanopag, codemptm, codfilialtm, codtipomov
    from vdorcamento
    where codemp=:codempoc and codfilial=:codfilialoc and codorc=:codorc and tipoorc='O'
    into :codempcl, :codfilialcl, :codcli, :codemppg, :codfilialpg, :codplanopag, :codemptm, :codfilialtm, :codtipomov;

    -- Sendo um orçamento para peças e mão-de-obra
    -- Deve gerar orçamento dos ítens de suplemento
    for select ir.codemppd, ir.codfilialpd, ir.codprodpd, ir.refprodpd, ir.coditrecmerc, ir.coditos, ir.qtditos,
        ir.gerachamado, pd.descprod, irm.codprod, irm.garantia, irm.codprod codprodir, irm.refprod refprodir
        from eqitrecmercitos ir, eqitrecmerc irm, eqproduto pd
        where
        irm.codemp=ir.codemp and irm.codfilial=ir.codfilial and irm.ticket=ir.ticket and irm.coditrecmerc=ir.coditrecmerc
        and pd.codemp=irm.codemppd and pd.codfilial=irm.codfilialpd and irm.codprod=pd.codprod
        and ir.codemp=:codemp and ir.codfilial=:codfilial and ir.ticket=:ticket and
        -- Filtrando componentes e serviços
        (
           (ir.gerarma=:componentes and ir.gerarma='S') or
           (ir.gerachamado=:servicos and ir.gerachamado='S') or
           (ir.geranovo=:novos and ir.geranovo='S')
        )

        into :codemppd, :codfilialpd, :codprod, :refprod, :coditrecmerc, :coditos, :qtditorc,
             :gerachamado, :descprod, :codprodpeca, :garantia, :codprodir, :refprodir
        do
        begin

--            if(:codprod <> :codprodant or :codprodant is null) then
--            begin

                -- Verifica se é serviço, sendo serviço insere a descriçao do produto
                -- consertado na descrição auxiliar do item de orçamento
                if(:gerachamado=:servicos and :gerachamado='S') then
                begin
                    if( 'N' = :garantia ) then
                    begin
                        obsitorc = :refprodir || ' - ' || :descprod;
                    end
                    else
                    begin
                        obsitorc = :refprodir || ' - ' || :descprod || '[G]';
                    end

                end

                --Buscando código do item de orçamento
                select coalesce(max(coditorc)+1,1) from vditorcamento io
                where io.codemp=:codempoc and io.codfilial=:codfilialoc and io.codorc=:codorc and io.tipoorc='O'
                into :coditorc;

                -- Buscando preço de venda
                -- Se não está em garantia...

                if('N' = :garantia) then
                begin
                    -- Se o preço é basedo na peca, deve buscar o preço da peça
                    if(usaprecopecaserv='S') then
                    begin
                        select preco from vdbuscaprecosp(:codprodpeca,:codcli,:codempcl,:codfilialcl,
                        :codplanopag,:codemppg,:codfilialpg,:codtipomov,:codemptm,:codfilialtm,:codemp,:codfilial)
                        into :precoitorc;
                    end
                    else
                    begin
                        select preco from vdbuscaprecosp(:codprod,:codcli,:codempcl,:codfilialcl,
                        :codplanopag,:codemppg,:codfilialpg,:codtipomov,:codemptm,:codfilialtm,:codemp,:codfilial)
                        into :precoitorc;
                    end
                end
                else
                begin

                    precoitorc = 0.00;

                end

                -- Buscando informações do produto
                select pd.codempax, pd.codfilialax, pd.codalmox, pd.refprod from eqproduto pd
                where pd.codemp=:codemppd and pd.codfilial=:codfilialpd and pd.codprod=:codprod
                into :codempax, :codfilialax, :codalmox, :refprod;

                vlrproditorc = :qtditorc * :precoitorc;
                vlrliqitorc = vlrproditorc;

                -- Inserir itens
                insert into vditorcamento (
                codemp, codfilial, codorc, tipoorc, coditorc,
                codemppd, codfilialpd, codprod, refprod,
                qtditorc, precoitorc, codempax, codfilialax, codalmox, obsitorc, vlrproditorc, vlrliqitorc, sitproditorc)
                values (:codempoc, :codfilialoc, :codorc, 'O', :coditorc,
                :codemppd, :codfilialpd, :codprod, :refprod,
                :qtditorc, :precoitorc, :codempax, :codfilialax, :codalmox, :obsitorc, :vlrproditorc, :vlrliqitorc,
                'PE') ;

                -- Inserindo vínculo entre item de orçamento e ordem de serviço

                insert into eqitrecmercitositorc(codemp, codfilial, ticket, coditrecmerc, coditos, codempoc, codfilialoc, codorc, coditorc, tipoorc)
                values(:codemp,:codfilial,:ticket,:coditrecmerc,:coditos, :codempoc,:codfilialoc,:codorc,:coditorc,'O');

                codprodant = codprod;

--            end
        end

        -- Atualizando o status da ordem de serviço
        update eqrecmerc rm set rm.status = 'EO'
        where rm.codemp=:codemp and rm.codfilial=:codfilial and rm.ticket=:ticket;

end
^

/* Alter (VDADICITVENDAORCSP) */
ALTER PROCEDURE VDADICITVENDAORCSP(FILIALATUAL INTEGER,
ICODVENDA INTEGER,
ICODORC INTEGER,
ICODITORC INTEGER,
ICODFILIAL SMALLINT,
ICODEMP INTEGER,
STIPOVENDA CHAR(10),
TPAGRUP CHAR(1),
IQTDITVENDA NUMERIC(15,5),
VLRDESCITVENDA NUMERIC(15,5))
 AS
declare variable icoditvenda integer;
declare variable icodfilialnt smallint;
declare variable codempax integer;
declare variable codfilialax integer;
declare variable codalmox integer;
declare variable icodcli integer;
declare variable icodfilialtm integer;
declare variable icodtipomov integer;
declare variable icodfilialcl integer;
declare variable scodnat char(4);
declare variable icodfilialle smallint;
declare variable scodlote varchar(20);
declare variable tipofisc char(2);
declare variable sorigfisc char(1);
declare variable scodtrattrib char(2);
declare variable icodfilialtt smallint;
declare variable icodfilialme smallint;
declare variable icodmens smallint;
declare variable percicmsitvenda numeric(15,5);
declare variable vlrbaseicmsitvenda numeric(15,5);
declare variable vlricmsitvenda numeric(15,5);
declare variable percipiitvenda numeric(15,5);
declare variable vlrbaseipiitvenda numeric(15,5);
declare variable vlripiitvenda numeric(15,5);
declare variable icodprod integer;
declare variable icodfilialpd integer;
declare variable vlrprecoitvenda numeric(15,5);
declare variable percdescitvenda numeric(15,5);
declare variable vlrliqitvenda numeric(15,5);
declare variable vlrproditvenda numeric(15,5);
declare variable obsitorc varchar(500);
declare variable ufcli char(2);
declare variable ufflag char(1);
declare variable percred numeric(15,5);
declare variable cloteprod char(1);
declare variable perccomisitvenda numeric(15,5);
declare variable geracomis char(1);
declare variable vlrcomisitvenda numeric(15,5);
declare variable codempif integer;
declare variable codfilialif smallint;
declare variable codfisc char(13);
declare variable coditfisc integer;
declare variable percissitvenda numeric(15,5);
declare variable vlrbaseissitvenda numeric(15,5);
declare variable vlrissitvenda numeric(15,5);
declare variable vlrisentasitvenda numeric(15,5);
declare variable vlroutrasitvenda numeric(15,5);
declare variable tipost char(2);
declare variable vlrbaseicmsstitvenda numeric(15,5);
declare variable vlricmsstitvenda numeric(15,5);
declare variable margemvlagritvenda numeric(15,5);
declare variable srefprod varchar(20);
declare variable stipoprod varchar(2);
declare variable percicmsst numeric(15,5);
declare variable vlrbaseicmsbrutitvenda numeric(15,5);
declare variable tpredicms char(1);
declare variable redbaseicmsst char(1);
declare variable qtditorc numeric(15,5);
begin
-- Inicialização de variaveis

    UFFLAG = 'N';

    select icodfilial from sgretfilial(:ICODEMP,'LFNATOPER') into ICODFILIALNT;
    select icodfilial from sgretfilial(:ICODEMP,'LFTRATTRIB') into ICODFILIALTT;
    select icodfilial from sgretfilial(:ICODEMP,'LFMENSAGEM') into ICODFILIALME;

    select vd.codfilialtm,vd.codtipomov from vdvenda vd where codvenda=:ICODVENDA and codfilial=:ICODFILIAL and codemp=:ICODEMP and tipovenda=:STIPOVENDA
    into ICODFILIALTM,ICODTIPOMOV;

-- Verifica se deve gerar comissão para a venda

    select geracomisvendaorc from sgprefere1 where codemp=:ICODEMP and codfilial=:ICODFILIAL into GERACOMIS;

-- Busca sequencia de numeração do ítem de venda

    select coalesce(max(coditvenda),0)+1 from vditvenda where codvenda=:ICODVENDA and codfilial=:ICODFILIAL and codemp=:ICODEMP and tipovenda=:STIPOVENDA
    into ICODITVENDA;

-- Informações do Orcamento

    select codcli,codfilialcl from vdorcamento where codemp=:ICODEMP and codfilial=:ICODFILIAL and codorc=:ICODORC into ICODCLI,ICODFILIALCL;

-- Informações do item de orçamento

    select it.codemppd, it.codfilialpd,it.codprod,it.precoitorc,it.percdescitorc,it.vlrliqitorc,it.vlrproditorc,it.refprod,it.obsitorc,
    it.codempax,it.codfilialax,it.codalmox,it.codlote,pd.cloteprod,pd.comisprod,pd.tipoprod, it.perccomisitorc, it.vlrcomisitorc, it.qtditorc
    from vditorcamento it, eqproduto pd
    where it.coditorc=:ICODITORC and it.codorc=:ICODORC and it.codfilial=:ICODFILIAL and it.codemp=:ICODEMP and
    pd.codemp=it.codemppd and pd.codfilial=it.codfilialpd and pd.codprod=it.codprod
    into ICODEMP,ICODFILIALPD,ICODPROD,VLRPRECOITVENDA,PERCDESCITVENDA,VLRLIQITVENDA,VLRPRODITVENDA,SREFPROD,OBSITORC,
    CODEMPAX,CODFILIALAX,CODALMOX,SCODLOTE,CLOTEPROD,perccomisitvenda,STIPOPROD,perccomisitvenda,vlrcomisitvenda, :qtditorc;

    -- Informações fiscais para a venda

    select coalesce(c.siglauf,c.ufcli)
    from vdorcamento o, vdcliente c
    where o.codorc=:ICODORC and o.codfilial=:ICODFILIAL and o.codemp=:ICODEMP and
    c.codcli=o.codcli and c.codfilial=o.codfilialcl and c.codemp=o.codempcl
    into ufcli;

    -- Busca informações fiscais para o ítem de venda (sem natureza da operação deve retornar apenas o coditfisc)

    select codempif,codfilialif,codfisc,coditfisc
    from lfbuscafiscalsp(:ICODEMP,:ICODFILIALPD,:ICODPROD,:ICODEMP,:ICODFILIALCL,:ICODCLI,:ICODEMP,:ICODFILIALTM,
    :ICODTIPOMOV, 'VD',null,null,null,null,null)
    into CODEMPIF,CODFILIALIF,CODFISC,CODITFISC;

-- Verifica se a venda é para outro estado

    select codnat from lfbuscanatsp(:FILIALATUAL,:ICODEMP,:ICODFILIALPD,:ICODPROD,:ICODEMP,:ICODFILIALCL,
    :ICODCLI,NULL,NULL,NULL,:ICODFILIALTM,:ICODTIPOMOV,:coditfisc)
    into SCODNAT;
    
    if (SCODNAT IS NULL) then
    begin
        exception vditvendaex03 :SREFPROD; -- NÃO FOI POSSÍVEL ENCONTRAR A NATUREZA DA OPERAÇÃO PARA O ÍTEM
    end

-- Busca informações fiscais para o ítem de venda (já sabe o coditfisc)

    select tipofisc,redfisc,codtrattrib,origfisc,codmens,aliqfisc,codempif,codfilialif,codfisc,coditfisc,tipost,
    margemvlagr,aliqipifisc,aliqfiscintra,tpredicmsfisc,redbasest,aliqiss
    from lfbuscafiscalsp(:ICODEMP,:ICODFILIALPD,:ICODPROD,:ICODEMP,:ICODFILIALCL,:ICODCLI,:ICODEMP,:ICODFILIALTM,
    :ICODTIPOMOV, 'VD',:scodnat,:codempif,:codfilialif,:codfisc,:coditfisc)
    into TIPOFISC,PERCRED,SCODTRATTRIB,SORIGFISC,ICODMENS,PERCICMSITVENDA,CODEMPIF,CODFILIALIF,CODFISC,CODITFISC,TIPOST,MARGEMVLAGRITVENDA,
    PERCIPIITVENDA,PERCICMSST, tpredicms, redbaseicmsst, PERCISSITVENDA;

-- Busca lote, caso seja necessário

    if (CLOTEPROD = 'S' and SCODLOTE is null) then
    begin
        select first 1 l.codlote from eqlote l
        where l.codprod=:ICODPROD and l.codfilial=:ICODFILIALPD and l.codemp=:ICODEMP and
        l.venctolote = ( select min(venctolote) from eqlote ls where ls.codprod=l.codprod and ls.codfilial=l.codfilial and ls.codemp=L.codemp and
                         ls.sldliqlote>=:IQTDITVENDA ) and
        l.sldliqlote>=:IQTDITVENDA
        into SCODLOTE;

        ICODFILIALLE = ICODFILIALPD;
    end
    
-- Inicializando valores

    VLRPRODITVENDA = VLRPRECOITVENDA * :IQTDITVENDA;
     if (:iqtditvenda<>:qtditorc) then
    begin
       VLRDESCITVENDA = (:VLRDESCITVENDA/:QTDITORC*:IQTDITVENDA);
    end
    VLRLIQITVENDA = VLRPRODITVENDA - :VLRDESCITVENDA;
    VLRBASEIPIITVENDA = 0;
    VLRBASEICMSITVENDA = 0;
    VLRICMSITVENDA = 0;
    VLRIPIITVENDA = 0;

    if (PERCICMSITVENDA = 0 or PERCICMSITVENDA is null) then
    begin
        select coalesce(PERCICMS,0) from lfbuscaicmssp (:SCODNAT,:UFCLI,:ICODEMP,:ICODFILIAL) into PERCICMSST;
    end

    if (PERCRED is null) then
    begin
        PERCRED = 0;
    end

    if(percred>0) then
    begin
        if(:tpredicms='B') then
        begin
            VLRBASEICMSITVENDA = (:VLRPRODITVENDA - :VLRDESCITVENDA) - ( (VLRPRODITVENDA - :VLRDESCITVENDA) * ( PERCRED / 100 ) );
            VLRICMSITVENDA = VLRBASEICMSITVENDA * ( PERCICMSITVENDA / 100 );
        end
        else if(:tpredicms='V') then
        begin
            VLRBASEICMSITVENDA = (:VLRPRODITVENDA - :VLRDESCITVENDA);
            VLRICMSITVENDA = (VLRBASEICMSITVENDA * ( PERCICMSITVENDA / 100 )) -  ( (VLRBASEICMSITVENDA * ( PERCICMSITVENDA / 100 ) * ( PERCRED / 100 ) )) ;
        end
    end
    else
    begin
        VLRBASEICMSITVENDA = :VLRPRODITVENDA - :VLRDESCITVENDA;
        VLRICMSITVENDA = VLRBASEICMSITVENDA * ( PERCICMSITVENDA / 100 );
    end

    VLRBASEIPIITVENDA = :VLRPRODITVENDA - :VLRDESCITVENDA;
    VLRBASEICMSBRUTITVENDA = :VLRPRODITVENDA - :VLRDESCITVENDA;
    VLRIPIITVENDA = VLRBASEIPIITVENDA * ( PERCIPIITVENDA / 100 );

-- **** Calculo dos tributos ***

-- Verifica se é um serviço (Calculo do ISS);

    if (:STIPOPROD = 'S') then
    begin
    -- Carregando aliquota do ISS
    -- Bloco comentado, pois já buscou o percentual do iss através da procedure.
   --     select percissfilial from sgfilial where codemp=:ICODEMP and codfilial=:ICODFILIAL
   --     into PERCISSITVENDA;

    -- Calculando e computando base e valor do ISS;
        if (:PERCISSITVENDA != 0) then
        begin
            VLRBASEISSITVENDA = :VLRLIQITVENDA;
            VLRISSITVENDA = :VLRBASEISSITVENDA * (:PERCISSITVENDA/100);
        end
    end
    else -- Se o item vendido não for SERVIÇO zera ISS
        VLRBASEISSITVENDA = 0;

    -- Se produto for isento de ICMS
    if (:TIPOFISC = 'II') then
    begin
        VLRISENTASITVENDA = :VLRLIQITVENDA;
        VLRBASEICMSITVENDA = 0;
        PERCICMSITVENDA = 0;
        VLRICMSITVENDA = 0;
        VLROUTRASITVENDA = 0;
    end
    -- Se produto for de Substituição Tributária
    else if (:TIPOFISC = 'FF') then
    begin
        if (:TIPOST = 'SI' ) then -- Contribuinte Substituído
        begin
            VLROUTRASITVENDA = :VLRLIQITVENDA;
            VLRBASEICMSITVENDA = 0;
            PERCICMSITVENDA = 0;
            VLRICMSITVENDA = 0;
            VLRISENTASITVENDA = 0;
        end
        else if (:TIPOST = 'SU' ) then -- Contribuinte Substituto
        begin

            if( (:PERCICMSST is null) or (:PERCICMSST=0) ) then
            begin
                select coalesce(PERCICMSINTRA,0) from lfbuscaicmssp (:SCODNAT,:UFCLI,:ICODEMP,:ICODFILIAL)
                into PERCICMSST;
            end

            if(percred>0 and redbaseicmsst='S') then
            begin
            -- Quando há redução na base do icms st , deve usar o valor da base do icms proprio como parametro
               vlrbaseicmsstitvenda = (  (coalesce(margemvlagritvenda,0) + 100) / 100 )  * (  (coalesce(vlrbaseicmsitvenda,0) ) + (coalesce(vlripiitvenda,0)) );
            end
            else
            begin
                -- Quando não há redução na base do icms st deve usar o valor da base bruto (rem redução)
                vlrbaseicmsstitvenda = (  (coalesce(margemvlagritvenda,0) + 100) / 100 )  * (  (coalesce(vlrbaseicmsbrutitvenda,0) ) + (coalesce(vlripiitvenda,0)) );
            end

            VLROUTRASITVENDA = 0;
            VLRISENTASITVENDA = 0;
            VLRICMSSTITVENDA = ( (:VLRBASEICMSSTITVENDA * :PERCICMSST) / 100 ) - (:VLRICMSITVENDA) ;

        end
    end

    -- Se produto não for tributado e não isento

    else if (:TIPOFISC = 'NN') then
    begin
        VLROUTRASITVENDA = :VLRLIQITVENDA;
        VLRBASEICMSITVENDA = 0;
        PERCICMSITVENDA = 0;
        VLRICMSITVENDA = 0;
        VLRISENTASITVENDA = 0;
    end

    -- Se produto for tributado integralmente

    else if (:TIPOFISC = 'TT') then
    begin
        VLROUTRASITVENDA = 0;
        VLRISENTASITVENDA = 0;
    end

    -- Inserindo dados na tabela de ítens de venda

    if ( TPAGRUP <> 'F' ) then
    begin

        insert into vditvenda (codemp,codfilial,codvenda,tipovenda,coditvenda,codempnt,codfilialnt,codnat,codemppd,
        codfilialpd,codprod,codemple,codfilialle,codlote,qtditvenda,precoitvenda,percdescitvenda,vlrdescitvenda,
        percicmsitvenda,vlrbaseicmsitvenda,vlricmsitvenda,percipiitvenda,vlrbaseipiitvenda,vlripiitvenda,vlrliqitvenda,
        vlrproditvenda,refprod,origfisc,codemptt,codfilialtt,codtrattrib,tipofisc,codempme,codfilialme,codmens,obsitvenda,
        codempax,codfilialax,codalmox,perccomisitvenda,vlrcomisitvenda,codempif,codfilialif,codfisc,coditfisc,percissitvenda,
        vlrbaseissitvenda,vlrissitvenda,vlrisentasitvenda,vlroutrasitvenda,tipost,vlrbaseicmsstitvenda,vlricmsstitvenda,
        margemvlagritvenda,vlrbaseicmsbrutitvenda)
        values (:ICODEMP,:ICODFILIAL,:ICODVENDA,:STIPOVENDA,:ICODITVENDA,:ICODEMP,
        :ICODFILIALNT,:SCODNAT,:ICODEMP,:ICODFILIALPD,:ICODPROD,:ICODEMP,:ICODFILIALPD,:SCODLOTE,:IQTDITVENDA,
        :VLRPRECOITVENDA,:PERCDESCITVENDA,:VLRDESCITVENDA,:PERCICMSITVENDA,:VLRBASEICMSITVENDA,:VLRICMSITVENDA,
        :PERCIPIITVENDA,:VLRBASEIPIITVENDA,:VLRIPIITVENDA,:VLRLIQITVENDA,:VLRPRODITVENDA,:SREFPROD,:SORIGFISC,
        :ICODEMP,:ICODFILIALTT,:SCODTRATTRIB,:TIPOFISC,:ICODEMP,:ICODFILIALME,:ICODMENS,:OBSITORC,
        :CODEMPAX,:CODFILIALAX,:CODALMOX,:perccomisitvenda,:vlrcomisitvenda,:CODEMPIF,:CODFILIALIF,:CODFISC,:CODITFISC,
        :PERCISSITVENDA,:VLRBASEISSITVENDA,:VLRISSITVENDA,:VLRISENTASITVENDA,:VLROUTRASITVENDA,:TIPOST,
        :VLRBASEICMSSTITVENDA,:VLRICMSSTITVENDA,:MARGEMVLAGRITVENDA,:vlrbaseicmsbrutitvenda);
    end

-- Atualizando informações de vínculo

    execute procedure vdupvendaorcsp(:ICODEMP,:ICODFILIAL,:ICODORC,:ICODITORC,:ICODFILIAL,:ICODVENDA,:ICODITVENDA,:STIPOVENDA);

end
^

/* Alter (VDADICVENDAORCSP) */
ALTER PROCEDURE VDADICVENDAORCSP(ICODORC INTEGER,
ICODFILIAL SMALLINT,
ICODEMP INTEGER,
STIPOVENDA CHAR(10),
NEWCODVENDA INTEGER)
 RETURNS(IRET INTEGER)
 AS
declare variable icodvenda integer;
declare variable ifilialvd smallint;
declare variable icodtipomov integer;
declare variable ifilialtm smallint;
declare variable sserie char(4);
declare variable ifilialse smallint;
declare variable sstatusvenda char(2);
declare variable dperccomvend numeric(9,2);
declare variable icodvend integer;
declare variable icodfilialvd integer;
declare variable icodcli integer;
declare variable icodfilialcl integer;
declare variable icodplanopag integer;
declare variable icodfilialpg integer;
declare variable usapedseq char(1);
declare variable iconta integer;
declare variable icodclcomis integer;
declare variable icodfilialcm integer;
declare variable vlrdescorc numeric(15,5);
BEGIN

/*Cod. Tipo Mov e Sequencia:*/
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'EQTIPOMOV') INTO IFILIALTM;
  SELECT COUNT(P.TIPOPROD) FROM EQPRODUTO P, VDITORCAMENTO I WHERE
    P.CODPROD=I.CODPROD AND P.CODFILIAL=I.CODFILIALPD AND P.CODEMP=I.CODEMPPD
    AND P.TIPOPROD = 'S' AND I.CODORC=:ICODORC
    AND I.CODFILIAL=:ICODFILIAL AND I.CODEMP=:ICODEMP INTO ICONTA;
    
  IF (ICONTA > 0) THEN
    SELECT CODTIPOMOV4,USAPEDSEQ FROM SGPREFERE1
      WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
      INTO ICODTIPOMOV,USAPEDSEQ;
  IF (ICODTIPOMOV IS NULL) THEN  /* CASO AINDA O IF DE CIMA NAO TENHA PREECHIDO... */
    SELECT CODTIPOMOV3,USAPEDSEQ FROM SGPREFERE1
      WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
      INTO ICODTIPOMOV,USAPEDSEQ;

/*Informações basicas:*/

  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'VDVENDA') INTO IFILIALVD;
  IF (USAPEDSEQ='S') THEN
    SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALVD,'VD') INTO ICODVENDA;
  ELSE
    IF ((:NEWCODVENDA > 0) AND (:NEWCODVENDA IS NOT NULL)) THEN
      ICODVENDA = :NEWCODVENDA;
    ELSE
      SELECT MAX(CODVENDA)+1 FROM VDVENDA
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:IFILIALVD
        INTO ICODVENDA;

/*Serie:*/
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'LFSERIE') INTO IFILIALSE;
  SELECT SERIE FROM EQTIPOMOV WHERE CODEMP=:ICODEMP AND CODFILIAL=:IFILIALTM AND CODTIPOMOV=:ICODTIPOMOV INTO SSERIE;

/*Status:*/
  SSTATUSVENDA = 'P1';

/*Busca no orçamento:*/
  SELECT O.CODFILIALVD,O.CODVEND,O.CODFILIALCL,O.CODCLI,O.CODFILIALPG,
    O.CODPLANOPAG,VE.PERCCOMVEND,O.CODCLCOMIS,O.CODFILIALCM, o.vlrdescorc
    FROM VDORCAMENTO O, VDVENDEDOR VE WHERE O.CODORC=:ICODORC
    AND O.CODFILIAL=:ICODFILIAL AND O.CODEMP=:ICODEMP
    AND VE.CODEMP=O.CODEMP AND VE.CODFILIAL=O.CODFILIALVD
    AND VE.CODVEND=O.CODVEND INTO
           :ICODFILIALVD,:ICODVEND,:ICODFILIALCL,:ICODCLI,
           :ICODFILIALPG,:ICODPLANOPAG,DPERCCOMVEND,:ICODCLCOMIS,:ICODFILIALCM,:vlrdescorc;

  INSERT INTO VDVENDA (
    CODEMP,CODFILIAL,CODVENDA,TIPOVENDA,CODEMPVD,CODFILIALVD,CODVEND,CODEMPCL,CODFILIALCL,CODCLI,
    CODEMPPG,CODFILIALPG,CODPLANOPAG,CODEMPSE,CODFILIALSE,SERIE,CODEMPTM,CODFILIALTM,CODTIPOMOV,
    DTSAIDAVENDA,DTEMITVENDA,STATUSVENDA,PERCCOMISVENDA,CODCLCOMIS,CODFILIALCM,CODEMPCM,vlrdescvenda)
    VALUES (
    :ICODEMP,:IFILIALVD,:ICODVENDA,:STIPOVENDA,:ICODEMP,:ICODFILIALVD,:ICODVEND,:ICODEMP,:ICODFILIALCL,:ICODCLI,
    :ICODEMP,:ICODFILIALPG,:ICODPLANOPAG,:ICODEMP,:IFILIALSE,:SSERIE,:ICODEMP,:IFILIALTM,:ICODTIPOMOV,
    CAST('today' AS DATE),CAST('today' AS DATE),:SSTATUSVENDA,:DPERCCOMVEND,:ICODCLCOMIS,:ICODFILIALCM,:ICODEMP,:VLRDESCORC );

  IRET = ICODVENDA;

  SUSPEND;
END
^

/* Alter (VDBAIXACOMISSAOSP) */
ALTER PROCEDURE VDBAIXACOMISSAOSP(STIPO CHAR(1),
DINI DATE,
DFIM DATE,
ICODVEND INTEGER,
ICODEMPVD INTEGER,
ICODFILIALVD SMALLINT,
SCODCONTA CHAR(10),
ICODEMPCA INTEGER,
ICODFILIALCA SMALLINT,
SCODPLAN CHAR(13),
ICODEMPPN INTEGER,
ICODFILIALPN SMALLINT,
DDATA DATE,
IDOC INTEGER,
DVLR NUMERIC(15,5),
SOBS CHAR(50),
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 AS
declare variable icodpcomi integer;
declare variable icodcomi integer;
declare variable icodempcomi integer;
declare variable icodfilialcomi integer;
declare variable cflag char(1);
declare variable ifilialpcomi integer;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNPAGTOCOMI') INTO IFILIALPCOMI;
  SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALPCOMI,'CI') INTO ICODPCOMI;
  INSERT INTO FNPAGTOCOMI(CODEMP,CODFILIAL,CODPCOMI,CODEMPCA,CODFILIALCA,NUMCONTA,CODEMPPN,CODFILIALPN,CODPLAN,DTCOMPPCOMI,DATAPCOMI,DOCPCOMI,VLRPCOMI,OBSPCOMI)
         VALUES (
                :ICODEMP,:IFILIALPCOMI,:iCodPComi,:ICODEMPCA,:ICODFILIALCA,:sCodConta,:ICODEMPPN,:ICODFILIALPN,:sCodPlan,:dData,:dData,:iDoc,:dVlr,:sObs
         );
  FOR SELECT C.CODCOMI,C.CODEMP,C.CODFILIAL,C.FLAG FROM VDCOMISSAO C,FNRECEBER R WHERE R.CODVEND=:iCodVend
               AND R.CODEMPVD=:ICODEMPVD AND R.CODFILIALVD=:ICODFILIALVD
               AND C.CODREC=R.CODREC AND C.CODEMPRC=R.CODEMP AND C.CODFILIALRC=R.CODFILIAL
               AND ( (:STIPO='E') OR  (C.DTVENCCOMI BETWEEN :dIni AND :dFim) )
               AND ( (:STIPO='V') OR  (C.DATACOMI BETWEEN :dIni AND :dFim) )
               AND STATUSCOMI='C2'
               AND R.CODEMP=:ICODEMP AND R.CODFILIAL=:ICODFILIAL
               INTO :iCodComi,:iCodEmpComi,:iCodFilialComi,:cFLAG DO
  BEGIN
     UPDATE VDCOMISSAO SET VLRPAGOCOMI=VLRAPAGCOMI, CODPCOMI=:iCodPComi,CODEMPCI=:ICODEMP,
        CODFILIALCI=:IFILIALPCOMI,STATUSCOMI='CP',DTPAGTOCOMI=:dData,FLAG=:cFLAG
      WHERE CODCOMI=:iCodComi AND CODEMP=:iCodEmpComi AND CODFILIAL=:iCodFilialComi;
  END
END
^

/* Alter (VDBUSCAPRECOSP) */
ALTER PROCEDURE VDBUSCAPRECOSP(ICODPROD INTEGER,
ICODCLI INTEGER,
ICODEMPCL INTEGER,
ICODFILIALCL SMALLINT,
ICODPLANOPAG INTEGER,
ICODEMPPG INTEGER,
ICODFILIALPG SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPTM INTEGER,
ICODFILIALTM SMALLINT,
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 RETURNS(PRECO NUMERIC(14,5))
 AS
declare variable icodtab integer;
declare variable icodemptab integer;
declare variable icodfilialtab smallint;
declare variable icodclascli integer;
declare variable icodempclascli integer;
declare variable icodfilialclascli smallint;
declare variable percdesccli numeric(3,2);
declare variable desccli char(1);
declare variable arredpreco smallint;
declare variable codfilialpf integer;
declare variable centavos decimal(2,2);
declare variable codfilialprecoprod smallint;
begin
    -- Buscando código da filial de preferencias
    select icodfilial from sgretfilial(:icodemp,'SGFILIAL') into :codfilialpf;

   -- Buscando código da filial da tabela vdprecoprod
    select icodfilial from sgretfilial(:icodemp,'VDPRECOPROD') into :codfilialprecoprod;

    -- Buscando preferencias de arredondamento;
    select coalesce(arredpreco, 0)
    from sgprefere1 p1
    where p1.codemp=:icodemp and p1.codfilial=:codfilialpf
    into :arredpreco;

    -- Buscando tabela de preços do tipo de movimento;
    select codtab, codemptb, codfilialtb
    from eqtipomov
    where codtipomov=:icodtipomov and codemp=:icodemptm and codfilial=:icodfilialtm
    into :icodtab, :icodemptab, :icodfilialtab;

    -- Buscando informações do cliente;
    select codclascli, codempcc, codfilialcc, coalesce(percdesccli,0) percdesccli
    from vdcliente
    where codcli=:icodcli and codemp=:icodempcl and codfilial=:icodfilialcl
    into :icodclascli, :icodempclascli, icodfilialclascli, :percdesccli;

    -- Buscando preço da tabela de preços utilizando todos os filtros
    select precoprod from vdprecoprod pp
    where pp.codprod=:icodprod and pp.codplanopag=:icodplanopag and pp.codemppg=:icodemppg and pp.codfilialpg=:icodfilialpg
    and pp.codtab=:icodtab and pp.codemptb=:icodemptab and pp.codfilialtb=:icodfilialtab
    and pp.codclascli=:icodclascli and pp.codempcc=:icodempclascli and pp.codfilialcc=:icodfilialclascli
    and pp.codemp=:icodemp and pp.codfilial=:codfilialprecoprod
    into :preco;

    --Se não encontrou um preço de tabela usando todos os filtros, deve retirar o filtro de classificação do cliente
    if ((preco is null) or (preco = 0)) then
    begin
        select max(pp.precoprod) from vdprecoprod pp
        where pp.codprod=:icodprod and pp.codplanopag=:icodplanopag and pp.codemppg=:icodemppg
        and pp.codfilialpg=:icodfilialpg and pp.codtab=:icodtab and pp.codemptb=:icodemptab
        and pp.codfilialtb=:icodfilialtab and pp.codclascli is null
        and pp.codemp=:icodemp and pp.codfilial=:icodfilial
        into :preco;
    end

    --Se ainda não conseguiu pagar o preco, deve utilizar o preço base do produto aplicando o desconto especial do cliente se houver
    if ((preco is null) or (preco = 0)) then
    begin

        select coalesce(pd.precobaseprod,0), coalesce(pd.desccli,'N') from eqproduto pd
        where pd.codprod=:icodprod and pd.codemp=:icodemp and pd.codfilial=:icodfilial
        into :preco, :desccli;

        -- Verifica se o cliente possui desconto especial e o produto permite este desconto...
        if( percdesccli >0 and 'S' = :desccli ) then
        begin

            preco = :preco - (:preco * (:percdesccli / 100)) ;

        end

    end

    if( :arredpreco > 0 ) then
    begin

        -- capturando valor dos centavos
        centavos = ( cast(:preco as decimal(15,2)) - truncate(preco) ) * 10;

        -- se o valor em centavos é maior ou igual ao parametro de arredondamento (arredondar para cima)
        if(:centavos >= :arredpreco) then
        begin
            preco = truncate(preco) + 1;
        end
        else
        begin
            preco = truncate(preco);
        end

    end

    suspend;

end
^

/* Alter (VDCONTRATOTOTSP) */
ALTER PROCEDURE VDCONTRATOTOTSP(CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
CODCONTR INTEGER,
CODITCONTR INTEGER,
CODEMPSC INTEGER,
CODFILIALSC SMALLINT,
CODCONTRSC INTEGER,
CODEMPTA INTEGER,
CODFILIALTA SMALLINT,
CODTAREFA INTEGER,
CODEMPST INTEGER,
CODFILIALST SMALLINT,
CODTAREFAST INTEGER,
DATAINI DATE,
DATAFIM DATE)
 RETURNS(TOTALPREVGERAL NUMERIC(15,5),
TOTALPREVPER NUMERIC(15,5),
TOTALGERAL NUMERIC(15,5),
TOTALCOBCLIGERAL NUMERIC(15,5),
TOTALANT NUMERIC(15,5),
TOTALCOBCLIANT NUMERIC(15,5),
TOTALPER NUMERIC(15,5),
TOTALCOBCLIPER NUMERIC(15,5),
SALDOANT NUMERIC(15,5),
SALDOPER NUMERIC(15,5))
 AS
begin
  if (:codcontrsc is not null) then
  begin
     codempct = codempsc;
     codfilialct = codfilialsc;
     codcontr = codcontrsc;
  end
  if (:codtarefast is not null) then
  begin
     codempta = codempst;
     codfilialta = codfilialst;
     codtarefa = codtarefast;
  end
  select sum(a.totalgeral), sum(a.totalcobcli)
   from atatendimentovw02 a
    left outer join crtarefa ta
      on ta.codemp=a.codempta and ta.codfilial=a.codfilialta and ta.codtarefa=a.codtarefa
    left outer join crtarefa st
      on st.codempta=ta.codemp and st.codfilialta=ta.codemp and st.codtarefata=ta.codtarefa
    where a.codempct=:codempct and a.codfilialct=:codfilialct and a.codcontr=:codcontr and
    (:coditcontr is null or a.coditcontr=:coditcontr) and
    (
       (:codtarefa is null) or
       (st.codtarefa is null and ta.codemp=:codempta and ta.codfilial=:codfilialta and ta.codtarefa=:codtarefa ) or
       (st.codtarefa is not null and st.codempta=:codempta and st.codfilialta=:codfilialta and st.codtarefata=:codtarefa )
    )
  into :totalgeral,  :totalcobcligeral;

  select sum(a.totalgeral), sum(a.totalcobcli)
   from atatendimentovw02 a
    left outer join crtarefa ta
      on ta.codemp=a.codempta and ta.codfilial=a.codfilialta and ta.codtarefa=a.codtarefa
    left outer join crtarefa st
      on st.codempta=ta.codemp and st.codfilialta=ta.codemp and st.codtarefata=ta.codtarefa
    where a.codempct=:codempct and a.codfilialct=:codfilialct and a.codcontr=:codcontr and
    (:coditcontr is null or a.coditcontr=:coditcontr) and
      a.dataatendo between :dataini and :datafim and
    (
       (:codtarefa is null) or
       (st.codtarefa is null and ta.codemp=:codempta and ta.codfilial=:codfilialta and ta.codtarefa=:codtarefa ) or
       (st.codtarefa is not null and st.codempta=:codempta and st.codfilialta=:codfilialta and st.codtarefata=:codtarefa )
    )
  into :totalper,  :totalcobcliper;

  select sum(a.totalgeral), sum(a.totalcobcli)
   from atatendimentovw02 a
    left outer join crtarefa ta
     on ta.codemp=a.codempta and ta.codfilial=a.codfilialta and ta.codtarefa=a.codtarefa
    left outer join crtarefa st
      on st.codempta=ta.codemp and st.codfilialta=ta.codemp and st.codtarefata=ta.codtarefa
    where a.codempct=:codempct and a.codfilialct=:codfilialct and a.codcontr=:codcontr and
    (:coditcontr is null or a.coditcontr=:coditcontr) and
     a.dataatendo < :dataini and
    (
       (:codtarefa is null) or
       (st.codtarefa is null and ta.codemp=:codempta and ta.codfilial=:codfilialta and ta.codtarefa=:codtarefa ) or
       (st.codtarefa is not null and st.codempta=:codempta and st.codfilialta=:codfilialta and st.codtarefata=:codtarefa )
    )
  into :totalant,  :totalcobcliant;

  select sum(coalesce(st.tempodectarefa, ta.tempodectarefa) )
    from crtarefa ta
    left outer join crtarefa st
      on st.codempta=ta.codemp and st.codfilialta=ta.codemp and st.codtarefata=ta.codtarefa
    where ta.codempct=:codempct and ta.codfilialct=:codfilialct and ta.codcontr=:codcontr and
    (:coditcontr is null or ta.coditcontr=:coditcontr) and
    (
       (:codtarefa is null) or
       (st.codtarefa is null and ta.codemp=:codempta and ta.codfilial=:codfilialta and ta.codtarefa=:codtarefa ) or
       (st.codtarefa is not null and st.codempta=:codempta and st.codfilialta=:codfilialta and st.codtarefata=:codtarefa )
    )
  into totalprevgeral;

  select sum(tp.tempodectarefa)
   from crtarefa ttp, crtarefaper tp
    left outer join crtarefa ta
      on ta.codemp=ttp.codempta and ta.codfilial=ttp.codfilialta and ta.codtarefa=ttp.codtarefa
    left outer join crtarefa st
      on st.codempta=ta.codemp and st.codfilialta=ta.codemp and st.codtarefata=ta.codtarefa
    where ttp.codemp=tp.codemp and ttp.codfilial=tp.codfilial and ttp.codtarefa=tp.codtarefa and
      ttp.codempct=:codempct and ttp.codfilialct=:codfilialct and ttp.codcontr=:codcontr and
    (:coditcontr is null or ttp.coditcontr=:coditcontr) and
      tp.dtiniper>=:dataini and tp.dtfimper<=:datafim and
    (
       (:codtarefa is null) or
       (st.codtarefa is null and ta.codemp=:codempta and ta.codfilial=:codfilialta and ta.codtarefa=:codtarefa ) or
       (st.codtarefa is not null and st.codempta=:codempta and st.codfilialta=:codfilialta and st.codtarefata=:codtarefa )
    )
  into :totalprevper;

  if (totalgeral is null) then
      totalgeral = 0;
  if (totalcobcligeral is null) then
      totalcobcligeral = 0;
  if (totalant is null) then
      totalant = 0;
  if (totalcobcliant is null) then
      totalcobcliant = 0;
  if (totalper is null) then
      totalper = 0;
  if (totalcobcliper is null) then
      totalcobcliper = 0;
  saldoant = totalprevgeral - totalcobcliant;
  saldoper = totalprevper - totalcobcliper;

  suspend;
end
^

/* Alter (VDCOPIAORCSP) */
ALTER PROCEDURE VDCOPIAORCSP(CODEMP INTEGER,
CODFILIAL INTEGER,
CODORC INTEGER,
CODFILIALCL INTEGER,
CODCLI INTEGER)
 RETURNS(IRET INTEGER)
 AS
declare variable icodorc integer;
declare variable icodfilialpf integer;
declare variable cusaorcseq char(1);
declare variable vlrprodorc decimal(15,5);
declare variable percdescorc decimal(9,2);
declare variable vlrdescorc decimal(15,5);
declare variable vlradicorc decimal(15,5);
declare variable vlrdescitorc decimal(15,5);
declare variable vlrliqorc decimal(15,5);
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP, 'SGPREFERE1')
    INTO :ICODFILIALPF;
  SELECT USAORCSEQ FROM SGPREFERE1 P
     WHERE P.CODEMP=:CODEMP AND P.CODFILIAL=:ICODFILIALPF
     INTO :CUSAORCSEQ;
  IF (CUSAORCSEQ='S') THEN
  BEGIN
     SELECT ISEQ FROM SPGERANUM(:CODEMP,:CODFILIAL,'OC') INTO ICODORC;
  END
  ELSE
  BEGIN
     SELECT COALESCE(MAX(O.CODORC),0)+1 FROM VDORCAMENTO O
       WHERE O.CODEMP=:CODEMP AND O.CODFILIAL=:CODFILIAL AND
       O.TIPOORC='O' INTO ICODORC;
  END

  INSERT INTO VDORCAMENTO (CODEMP, CODFILIAL, TIPOORC, CODORC,
    CODEMPAE, CODFILIALAE, CODATEND, CODEMPCV, CODFILIALCV, CODCONV,
    DTORC, DTVENCORC, OBSORC, CODPLANOPAG, CODFILIALPG,
    CODEMPPG, TXT01, CODEMPVD, CODFILIALVD, CODVEND, CODEMPCL, CODFILIALCL,
    CODCLI, CODTPCONV, CODFILIALTC, CODEMPTC, PRAZOENTORC, statusorc)
    SELECT CODEMP, CODFILIAL, 'O', :ICODORC, CODEMPAE, CODFILIALAE,
      CODATEND, CODEMPCV, CODFILIALCV, CODCONV, DTORC, DTVENCORC,
      OBSORC, CODPLANOPAG, CODFILIALPG, CODEMPPG, TXT01, CODEMPVD,
      CODFILIALVD, CODVEND, :CODEMP, :CODFILIALCL, :CODCLI, CODTPCONV,
      CODFILIALTC, CODEMPTC, PRAZOENTORC, '*' FROM VDORCAMENTO WHERE
      CODORC=:CODORC AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL;

  INSERT INTO VDITORCAMENTO (CODEMP, CODFILIAL, TIPOORC, CODORC, CODITORC,
    CODEMPPD, CODFILIALPD, CODPROD, QTDITORC, PRECOITORC, PERCDESCITORC,
    VLRDESCITORC, VLRLIQITORC, VLRPRODITORC, REFPROD, NUMAUTORIZORC, ACEITEITORC,
    APROVITORC, EMITITORC, VENCAUTORIZORC, STRDESCITORC, OBSITORC,
    CODEMPAX, CODFILIALAX, CODALMOX)
    SELECT CODEMP, CODFILIAL, TIPOORC, :ICODORC, CODITORC,
      CODEMPPD, CODFILIALPD, CODPROD, QTDITORC, PRECOITORC, PERCDESCITORC,
      VLRDESCITORC, VLRLIQITORC, VLRPRODITORC, REFPROD, null, 'N',
      'N', 'N', VENCAUTORIZORC, STRDESCITORC, OBSITORC,
      CODEMPAX, CODFILIALAX, CODALMOX
      FROM VDITORCAMENTO
      WHERE CODORC=:CODORC AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL;

  SELECT VLRPRODORC, PERCDESCORC,VLRDESCORC,VLRADICORC,VLRDESCITORC,VLRLIQORC
      FROM VDORCAMENTO WHERE CODORC=:CODORC AND CODEMP=:CODEMP AND
      CODFILIAL=:CODFILIAL
      INTO :VLRPRODORC, :PERCDESCORC, :VLRDESCORC, :VLRADICORC, :VLRDESCITORC, :VLRLIQORC;

  UPDATE VDORCAMENTO SET VLRPRODORC=:VLRPRODORC, PERCDESCORC=:PERCDESCORC,
     VLRDESCORC=:VLRDESCORC, VLRADICORC=:VLRADICORC,
     VLRDESCITORC=:VLRDESCITORC, VLRLIQORC=:VLRLIQORC
     WHERE CODORC=:ICODORC AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL;

  IRET = ICODORC;
  SUSPEND;
END
^

/* Alter (VDESTORNACOMISSAOSP) */
ALTER PROCEDURE VDESTORNACOMISSAOSP(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
ICODVEND INTEGER,
DINI DATE,
DFIM DATE,
CORDEM CHAR(1))
 AS
declare variable icodcomi integer;
declare variable icodemprc integer;
declare variable scodfilialrc smallint;
declare variable icodrec integer;
declare variable inparcitrec integer;
declare variable nvlrvendacomi numeric(15,5);
declare variable nvlrcomi numeric(15,5);
declare variable ddatacomi date;
declare variable ddtcompcomi date;
declare variable ddtvenccomi date;
declare variable ctipocomi char(1);
declare variable cstatuscomi char(2);
declare variable datual date;
declare variable cstatusitrec char(2);
declare variable ddtvencitrec date;
begin
  /* Procedure Text */
  DATUAL = CAST( 'now' AS DATE);
  FOR SELECT C.CODCOMI,C.CODEMPRC, C.CODFILIALRC , C.CODREC, C.NPARCITREC,
      C.VLRVENDACOMI, C.VLRCOMI, C.DATACOMI , C.DTCOMPCOMI, C.DTVENCCOMI,
      C.TIPOCOMI, C.STATUSCOMI , IR.STATUSITREC, IR.DTVENCITREC
    FROM VDCOMISSAO C, FNITRECEBER IR, FNRECEBER R
    WHERE C.CODEMP=:ICODEMP AND C.CODFILIAL=:SCODFILIAL AND
       IR.CODEMP=C.CODEMPRC AND IR.CODFILIAL=C.CODFILIALRC AND
       IR.CODREC=C.CODREC AND IR.NPARCITREC=C.NPARCITREC AND
       R.CODEMP=C.CODEMPRC AND R.CODFILIAL=C.CODFILIALRC AND
       R.CODREC=C.CODREC AND R.CODEMPVD=:ICODEMPVD AND
       R.CODFILIALVD=:SCODFILIALVD AND R.CODVEND=:ICODVEND AND
       ( (:CORDEM = 'V')  OR (C.DATACOMI BETWEEN :DINI AND :DFIM) ) AND
       ( (:CORDEM = 'E')  OR (C.DTVENCCOMI BETWEEN :DINI AND :DFIM) ) AND
       C.STATUSCOMI IN ('C2','CP') AND
       IR.STATUSITREC NOT IN ('RP') AND
       NOT EXISTS(SELECT * FROM VDCOMISSAO C2 /* Sub-select para verificar a */
          /* existencia de estorno anterior. */
         WHERE C2.CODEMPRC=C.CODEMPRC AND C2.CODFILIALRC=C.CODFILIALRC AND
         C2.CODREC=C.CODREC AND C2.NPARCITREC=C.NPARCITREC AND
         C2.TIPOCOMI=C.TIPOCOMI AND C2.STATUSCOMI IN ('CE') )
    INTO :ICODCOMI, :ICODEMPRC, :SCODFILIALRC, :ICODREC, :INPARCITREC, :NVLRVENDACOMI,
      :NVLRCOMI, :DDATACOMI, :DDTCOMPCOMI, :DDTVENCCOMI, :CTIPOCOMI, :CSTATUSCOMI, :CSTATUSITREC,
      :DDTVENCITREC
  DO
  BEGIN
     IF ( (DATUAL>DDTVENCITREC) AND (CSTATUSCOMI='C2') ) THEN
     /* Caso a data atual seja maior que a data de vencimento e a */
     /* comissão não esteja paga, passa o status da comissão para não */
     /* liberada. */
     BEGIN
        UPDATE VDCOMISSAO SET STATUSCOMI='C1'
          WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL AND
            CODCOMI=:ICODCOMI;
     END
     ELSE IF ( (DATUAL>DDTVENCITREC) AND (CSTATUSCOMI='CP') ) THEN
     /* Caso a comissão esteja paga e a parcela esteja vencida, */
     /* gera um estorno da comissão. */
     BEGIN
        NVLRCOMI = NVLRCOMI * -1; /* Transforma o valor da comissão em negativo */
        /* para gerar estorno */
        EXECUTE PROCEDURE vdadiccomissaosp(:ICODEMPRC,:SCODFILIALRC,:ICODREC,
          :INPARCITREC, :NVLRVENDACOMI, :NVLRCOMI, :DDATACOMI , :DDTCOMPCOMI, :DDTVENCITREC,
          :CTIPOCOMI, :icodempvd, :scodfilialvd, : icodvend );
     END
  END
  suspend;
end
^

/* Alter (VDGERACOMISSAOSP) */
ALTER PROCEDURE VDGERACOMISSAOSP(ICODEMP INTEGER,
SCODFILIAL SMALLINT,
ICODREC INTEGER,
INPARCITREC INTEGER,
NVLRCOMIITREC NUMERIC(15,5),
DDTVENCITREC DATE)
 AS
declare variable icodempva integer;
declare variable scodfilialva smallint;
declare variable ctipovenda char(3);
declare variable icodvenda integer;
declare variable icodempcm integer;
declare variable scodfilialcm smallint;
declare variable icodclcomis integer;
declare variable nvlrvendacomi numeric(15,5);
declare variable ddatacomi date;
declare variable ddtcompcomi date;
declare variable npercfatclcomis numeric(9,2);
declare variable npercpgtoclcomis numeric(9,2);
declare variable ctipocomi char(1);
declare variable nvlrcomi numeric(15,5);
declare variable i integer;
declare variable icodemptm integer;
declare variable scodfilialtm smallint;
declare variable icodtipomov integer;
declare variable cmulticomis char(1);
declare variable icodempvd integer; /* Código da empresa do comissionado principal */
declare variable scodfilialvd smallint; /* Código da filial do comissionado principal */
declare variable icodvend integer; /* Código do comissionado principal */
declare variable nperccomisvendadic numeric(15,2); /* Percentual de comissão para cada comissionado adicional */
declare variable nvlrcomiadic numeric(15,5); /* Valor total da comissão para os comissionados adicionais. */
declare variable icodempvdadic integer; /* Código da empresa do comissionado adicional */
declare variable scodfilialvdadic smallint; /* Código da filial do comissionado adicional */
declare variable icodvendadic integer; /* Código do comissionado adicional */
declare variable nvlrcomiparc numeric(15,5); /* Valor da comissão por vendedor parcial. */
begin
    /* Gera as comissões a pagar na tabela VDCOMISSAO */


    nvlrcomiadic = 0;

    select r.codempva, r.codfilialva, r.tipovenda, r.codvenda,
        v.codempcm, v.codfilialcm, v.codclcomis, ( v.vlrprodvenda - v.vlrdescvenda ),
        v.dtemitvenda, v.dtcompvenda, cm.percfatclcomis, cm.percpgtoclcomis,
        v.codemptm, v.codfilialtm, v.codtipomov,
        v.codempvd, v.codfilialvd, v.codvend
        from fnreceber r, vdvenda v, vdclcomis cm
        where r.codemp=:icodemp and r.codfilial=:scodfilial and r.codrec=:icodrec
            and v.codemp=r.codempva and v.codfilial=r.codfilialva and v.tipovenda=r.tipovenda
            and v.codvenda=r.codvenda and cm.codemp=v.codempcm and cm.codfilial=v.codfilialcm
            and cm.codclcomis=v.codclcomis
    into :icodempva, :scodfilialva, :ctipovenda, :icodvenda,
         :icodempcm, :scodfilialcm, :icodclcomis, :nvlrvendacomi,
         :ddatacomi, :ddtcompcomi, :npercfatclcomis, :npercpgtoclcomis,
         :icodemptm, :scodfilialtm, :icodtipomov,
         :icodempvd, :scodfilialvd, :icodvend ;

    /*Verifica se deve utilizar mecanismo de multiplos comissionados*/

    select cmulticomis from sgretmulticomissp(:icodemp, :icodemptm, :scodfilialtm, :icodtipomov)
        into cmulticomis;

    if(cmulticomis = 'S') then
    begin

        /*Implementação do mecanismo de multiplos comissionados*/
        
        for select vc.codempvd, vc.codfilialvd, vc.codvend, vc.percvc
            from vdvendacomis vc
            where vc.codemp=:icodempva and vc.codfilial=:scodfilialva and vc.codvenda=:icodvenda
                and vc.tipovenda=:ctipovenda and vc.codvend is not null
        into :icodempvdadic, :scodfilialvdadic, :icodvendadic, :nperccomisvendadic do
        begin

            /* Calcula o valor da comissão proporcional para cada comissionado adicional*/

            nvlrcomi = cast( ( nvlrcomiitrec * nperccomisvendadic / 100 ) as numeric(15,5));
            I = 1;
            while (:I<=2) do
            begin
                if (I=1) then
                    begin
                        ctipocomi='F';
                        nvlrcomiparc = cast( ( nvlrcomi * npercfatclcomis / 100 ) as NUMERIC(15, 5));
                    end
                else
                    begin
                        ctipocomi='R';
                        nvlrcomiparc = cast( (nvlrcomi * npercpgtoclcomis / 100 ) as NUMERIC(15, 5));
                    end
                execute procedure vdadiccomissaosp(:iCodEmp, :sCodFilial, :iCodRec, :iNParcItRec,
                    :nVlrVendaComi, :nvlrcomiparc, :dDataComi, :dDtCompComi, :dDtVencItRec, cTipoComi,:icodempvdadic, :scodfilialvdadic, :icodvendadic );
                I=I+1;
                /*Acumula as comissões adicionais para posteriormente descontar do valor principal*/
                nvlrcomiadic = nvlrcomiadic + nvlrcomiparc;

           /*     exception vdcomissaoex02 'rodou procedure para o vendedor:' || cast(:icodempvdadic as char(2)) || '-' || cast(:scodfilialvdadic as char(2)) || '-' || cast(:icodvendadic as char(2)) || '-' || ' - nvlrcomiadic:' || cast(nvlrcomiadic as char(20));*/

            end

        end

    end

    /*Comissionamento do vendedor principal*/

    I = 1;
    while (:I<=2) do
        begin
            if (I=1) then
                begin
                    ctipocomi='F';
                    nvlrcomi = cast( ( (nvlrcomiitrec - nvlrcomiadic ) * nPercFatClComis / 100 ) as numeric(15, 5) );
                end
            else
                begin
                    ctipocomi='R';
                    nvlrcomi = cast( ( (nvlrcomiitrec - nvlrcomiadic ) * nPercPgtoClComis / 100 ) as numeric(15, 5));
                end
/*
                exception vdcomissaoex01 ''
                || cast(:icodempvd as char(2)) || '-' || cast(:scodfilialvd as char(2)) || '-' || cast(:icodvend as char(2))
                || 'nvlrcomi:' || cast(:nvlrcomi as char(20))
                || 'nvlrvendacomi:' || cast(:nvlrvendacomi as char(20));
  */
            execute procedure vdadiccomissaosp(:icodemp, :scodfilial, :icodrec, :inparcitrec,
                :nvlrvendacomi, :nvlrcomi, :ddatacomi, :ddtcompcomi, :ddtvencitrec, ctipocomi, :icodempvd, :scodfilialvd, :icodvend );


            I=I+1;
        end

        suspend;
end
^

/* Alter (VDRETULTVDCLIPROD) */
ALTER PROCEDURE VDRETULTVDCLIPROD(ICODEMP INTEGER,
ICODCLI INTEGER,
ICODFILIALVD SMALLINT,
ICODVEND INTEGER,
DTINI DATE,
DTFIM DATE,
CODEMPTIPOCL INTEGER,
CODFILIALTIPOCL SMALLINT,
CODTIPOCLI INTEGER)
 RETURNS(RAZCLI_RET CHAR(50),
CODCLI_RET INTEGER,
DESCPROD_RET CHAR(50),
CODPROD_RET INTEGER,
DTEMITVENDA_RET DATE,
DOCVENDA_RET INTEGER,
SERIE_RET CHAR(4),
PRECOVENDA_RET NUMERIC(15,4))
 AS
declare variable icodfilial smallint;
declare variable icodprod integer;
begin

    select icodfilial from sgretfilial(:ICODEMP,'VDVENDA') into :ICODFILIAL;

    for select v.codcli,iv.codprod
        from vdvenda v, vdcliente cl, vditvenda iv
        where
            iv.codemp=v.codemp and iv.codfilial=v.codfilial
            and iv.tipovenda=v.TIPOVENDA and iv.codvenda=v.codvenda
            and v.codemp=:ICODEMP and v.codfilial=:ICODFILIAL
            and (v.codcli=:ICODCLI or :ICODCLI is null)
            and (v.codvend=:ICODVEND or :ICODVEND is null )
            and v.dtemitvenda between :DTINI and :DTFIM
            and cl.codemp=v.codempcl and cl.codfilial=v.codfilialcl and cl.codcli=v.codcli
            and (cl.codtipocli=:codtipocli or :codtipocli is null)
        group by v.codcli,iv.codprod into :ICODCLI,:ICODPROD
    do
    begin
        select first 1 c.razcli, c.codcli, p.descprod, iv.codprod, v.dtemitvenda, v.docvenda, v.serie,
            (iv.vlrliqitvenda/(case when iv.qtditvenda=0 then 1 else iv.qtditvenda end)) precovenda
        from vdcliente c, vdvenda v, vditvenda iv, eqproduto p
        where
            c.codemp=v.codempcl and c.codfilial=v.codfilialcl and c.codcli=v.codcli
            and c.codemp=v.codempcl and c.codfilial=v.codfilialcl and iv.codemp=v.codemp
            and iv.codfilial=v.codfilial and iv.tipovenda=v.tipovenda and iv.codvenda=v.codvenda
            and p.codemp=iv.codemppd and p.codfilial=iv.codfilialpd and p.codprod=iv.codprod
            and v.codempvd=:ICODEMP and v.codfilialvd=:ICODFILIALVD and (v.codvend=:ICODVEND or :ICODVEND is null )
            and v.dtemitvenda between :DTINI and :DTFIM and c.codcli=:ICODCLI and p.codprod=:ICODPROD
            order by v.dtemitvenda desc
            into :RAZCLI_RET, :CODCLI_RET, :DESCPROD_RET, :CODPROD_RET, :DTEMITVENDA_RET, :DOCVENDA_RET, :SERIE_RET,
                 :PRECOVENDA_RET;
            suspend;
    end
end
^

/* Restore procedure body: CPADICCOMPRAPEDSP */
ALTER PROCEDURE CPADICCOMPRAPEDSP(CODEMP INTEGER,
CODFILIAL SMALLINT,
CODCOMPRA INTEGER,
DOCCOMPRA INTEGER,
CODEMPTM INTEGER,
CODFILIALTM SMALLINT,
CODTIPOMOV INTEGER,
CODEMPFR INTEGER,
CODFILIALFR SMALLINT,
CODFOR INTEGER,
CODEMPPG INTEGER,
CODFILIALPG SMALLINT,
CODPLANOPAG INTEGER)
 RETURNS(IRET INTEGER)
 AS
declare variable codempse integer;
declare variable codfilialse smallint;
declare variable serie char(4);
declare variable statuscompra char(2);
begin

    --Buscando a série da compra
    select tm.codempse, tm.codfilialse, tm.serie
    from eqtipomov tm
    where tm.codemp=:codemptm and tm.codfilial=:codfilialtm and tm.codtipomov=:codtipomov
    into :codempse, :codfilialse, :serie;

    --Definição do status da compra
    statuscompra = 'P1';

    --Buscando doccompra
    select doc from lfnovodocsp(:serie, :codempse , :codfilialse) into doccompra;

    insert into cpcompra (
    codemp, codfilial, codcompra, codemppg, codfilialpg, codplanopag, codempfr, codfilialfr, codfor,
    codempse, codfilialse, serie, codemptm, codfilialtm, codtipomov, doccompra, dtentcompra, dtemitcompra, statuscompra, calctrib )
    values (
    :codemp, :codfilial, :codcompra, :codemppg, :codfilialpg, :codplanopag, :codempfr, :codfilialfr, :codfor,
    :codempse, :codfilialse, :serie, :codemptm, :codfilialtm, :codtipomov, :doccompra,
    cast('today' as date), cast('today' as date), :statuscompra, 'S' );

    iret = :codcompra;

    suspend;

end
^

/* Restore procedure body: EQMOVPRODISP */
ALTER PROCEDURE EQMOVPRODISP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD SMALLINT)
 AS
declare variable scodfilial smallint;
declare variable icodmovprod integer;
declare variable cestoqmovprod char(1);
declare variable ctipomovprod char(1);
declare variable nsldmovprod numeric(15,5);
declare variable ncustompmmovprod numeric(15,5);
declare variable soperador smallint;
declare variable nsldmovprodax numeric(15,5);
declare variable ncustompmmovprodax numeric(15,5);
begin
  /* Procedure de inserção na tabela eqmovprod */

  SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX FROM EQMOVPRODSLDSP(null, null, null, :ICODEMPPD,
     :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, :NPRECOMOVPROD, :NPRECOMOVPROD,
     :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX )
     INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX ;

  /* Verifica se haverá mudança de saldo*/
  SELECT NSALDO, NCUSTOMPM, CESTOQMOVPROD, CTIPOMOVPROD, SOPERADOR FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
      :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPROD)
      INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :CESTOQMOVPROD, :CTIPOMOVPROD, :SOPERADOR;

  if (CMULTIALMOX='N') then
  begin
     NSLDMOVPRODAX = NSLDMOVPROD;
     NCUSTOMPMMOVPRODAX = NCUSTOMPMMOVPROD;
  end
  else
  begin
      SELECT NSALDO, NCUSTOMPM FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
          :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPRODAX, :NSLDMOVPRODAX)
        INTO :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX;
  end

  SELECT SCODFILIAL, ICODMOVPROD FROM EQMOVPRODSEQSP(:ICODEMPPD)
     INTO :SCODFILIAL, :ICODMOVPROD;  /* encontra o próximo código e a filial*/

   INSERT INTO EQMOVPROD ( CODEMP, CODFILIAL, CODMOVPROD,
      CODEMPPD, CODFILIALPD , CODPROD , CODEMPLE ,
      CODFILIALLE , CODLOTE , CODEMPTM, CODFILIALTM,
      CODTIPOMOV, CODEMPIV , CODFILIALIV , CODINVPROD ,
      CODEMPCP , CODFILIALCP , CODCOMPRA , CODITCOMPRA , CODEMPVD ,
      CODFILIALVD , TIPOVENDA , CODVENDA , CODITVENDA , CODEMPRM ,
      CODFILIALRM , CODRMA , CODITRMA ,
      CODEMPOP, CODFILIALOP, CODOP, SEQOP, SEQENTOP,
      CODEMPNT , CODFILIALNT ,
      CODNAT , DTMOVPROD , DOCMOVPROD , FLAG , QTDMOVPROD ,
      PRECOMOVPROD, ESTOQMOVPROD, TIPOMOVPROD, SLDMOVPROD, CUSTOMPMMOVPROD,
      SLDMOVPRODAX, CUSTOMPMMOVPRODAX, CODEMPAX, CODFILIALAX, CODALMOX, seqsubprod )
   VALUES ( :ICODEMPPD, :SCODFILIAL, :ICODMOVPROD,
    :ICODEMPPD , :SCODFILIALPD , :ICODPROD , :ICODEMPLE ,
    :SCODFILIALLE , :CCODLOTE , :ICODEMPTM, :SCODFILIALTM,
    :ICODTIPOMOV, :ICODEMPIV , :SCODFILIALIV ,
    :ICODINVPROD , :ICODEMPCP , :SCODFILIALCP , :ICODCOMPRA ,
    :SCODITCOMPRA , :ICODEMPVD , :SCODFILIALVD , :CTIPOVENDA ,
    :ICODVENDA , :SCODITVENDA , :ICODEMPRM , :SCODFILIALRM ,
    :ICODRMA , :SCODITRMA , :ICODEMPOP, :SCODFILIALOP, :ICODOP, :SSEQOP, :sseqentop,
    :ICODEMPNT , :SCODFILIALNT , :CCODNAT ,
    :DDTMOVPROD , :IDOCMOVPROD , :CFLAG , :NQTDMOVPROD ,
    :NPRECOMOVPROD, :CESTOQMOVPROD, :CTIPOMOVPROD, :NSLDMOVPROD, :NCUSTOMPMMOVPROD,
    :NSLDMOVPRODAX,  :NCUSTOMPMMOVPRODAX, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :seqsubprod );

  /* REPROCESSAR ESTOQUE */

  SELECT NSLDPRC, NCUSTOMPMPRC, NSLDPRCAX, NCUSTOMPMPRCAX
    FROM EQMOVPRODPRCSLDSP( :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
     :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, null, :NSLDMOVPROD, :NCUSTOMPMMOVPROD,
     :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX,
     :CMULTIALMOX)
    INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX ;

 /* ATUALIZA O CUSTO NO CADASTRO DE PRODUTOS
   EXECUTE PROCEDURE EQMOVPRODATCUSTSP(:SOPERADOR, :ICODEMPPD, :SCODFILIAL,
    :ICODMOVPROD, :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, :NCUSTOMPMMOVPROD); 
 */


  suspend;
end
^

/* Restore procedure body: FNGERAITRECEBERSP01 */
ALTER PROCEDURE FNGERAITRECEBERSP01(CALTVLR CHAR(1),
ICODEMP INTEGER,
SCODFILIAL SMALLINT,
ICODREC INTEGER,
ICODEMPPG INTEGER,
SCODFILIALPG SMALLINT,
ICODPLANOPAG INTEGER,
NVLRREC NUMERIC(15,5),
DDATAREC DATE,
DDTCOMPREC DATE,
CFLAG CHAR(1),
ICODEMPBO INTEGER,
SCODFILIALBO SMALLINT,
CCODBANCO CHAR(3),
ICODEMPTC INTEGER,
SCODFILIALTC SMALLINT,
ICODTIPOCOB INTEGER,
ICODEMPCB INTEGER,
SCODFILIALCB SMALLINT,
CODCARTCOB CHAR(3),
NVLRCOMIREC NUMERIC(15,5),
OBSREC VARCHAR(250),
CODEMPCA INTEGER,
CODFILIALCA SMALLINT,
NUMCONTA CHAR(10),
CODEMPPN INTEGER,
CODFILIALPN SMALLINT,
CODPLAN CHAR(13),
CODEMPCC INTEGER,
CODFILIALCC SMALLINT,
ANOCC INTEGER,
CODCC CHAR(19),
VLRBASECOMIS NUMERIC(15,5))
 RETURNS(I INTEGER)
 AS
declare variable nperc numeric(15,5);
declare variable npercpag numeric(15,5);
declare variable nresto numeric(15,5);
declare variable inumparc integer;
declare variable idiaspag integer;
declare variable nrestocomi numeric(15,5);
declare variable nvlrcomiitrec numeric(15,5);
declare variable nvlritrec numeric(15,5);
declare variable regrvcto char(1);
declare variable rvsab char(1);
declare variable rvdom char(1);
declare variable rvfer char(1);
declare variable dtvencto date;
declare variable rvdia char(1);
declare variable dtbase date;
declare variable diavcto smallint;
declare variable casasdecfin smallint;
declare variable vlrbaseitcomis numeric(15,5);
declare variable restobasecomis numeric(15,5);
begin

    -- Inicializando variáveis

    i = 0;
    nperc = 100;
    nresto = nvlrrec;
    nrestocomi = nvlrcomirec;
    dtbase = ddatarec;
    vlrbaseitcomis = vlrbasecomis;
    restobasecomis = vlrbasecomis;

    -- Buscando preferencias

    select casasdecfin from sgprefere1 where codemp=:icodemp and codfilial=:scodfilial
    into casasdecfin;

    -- Buscanco informações do plano de pagamento
    select pp.parcplanopag, pp.regrvctoplanopag, pp.rvsabplanopag, pp.rvdomplanopag, pp.rvferplanopag, pp.rvdiaplanopag,
    pp.diavctoplanopag
    from fnplanopag pp
    where pp.codplanopag =:icodplanopag and pp.codemp=:icodemppg and pp.codfilial = :scodfilialpg
    into :inumparc, :regrvcto, :rvsab, :rvdom, :rvfer, :rvdia, :diavcto;

    -- Loop nas parcelas do plano de pagamento para geração dos itens do contas a receber

    for select percpag, diaspag from fnparcpag
    where codplanopag=:icodplanopag and codemp=:icodemppg and codfilial =:scodfilialpg
    order by diaspag
    into :npercpag, :idiaspag
    do begin
        i = i+1;

        -- Calculando valor da parcela
        select v.deretorno from arreddouble(cast(:nvlrrec * :npercpag as numeric(15, 5))/:nperc, :casasdecfin ) v
        into :nvlritrec;

        nresto = nresto - nvlritrec;

        if (i = inumparc) then
        begin
            nvlritrec = nvlritrec + nresto;
        end

        -- Calculando o valor da comissão a pagar na parcela.
        select v.deretorno from arreddouble(cast(:nvlrcomirec * :npercpag as numeric(15, 5))/:nperc,:casasdecfin) v
        into :nvlrcomiitrec;

        nrestocomi = nrestocomi - nvlrcomiitrec;

        if (i = inumparc) then
        begin
            nvlrcomiitrec = nvlrcomiitrec + nrestocomi;
        end

         -- Calculando o valor da base da comissão especial a pagar na parcela.
        select v.deretorno from arreddouble(cast(:vlrbasecomis * :npercpag as numeric(15, 5))/:nperc,:casasdecfin) v
        into :vlrbaseitcomis;

        restobasecomis = restobasecomis - vlrbaseitcomis;

        if (i = inumparc) then
        begin
            vlrbaseitcomis = vlrbaseitcomis + restobasecomis;
        end

        -- Definindo o vencimento da parcela
        select c.dtvencret from sgcalcvencsp(:icodemp, :dtbase, :ddatarec + :idiaspag, :regrvcto,
        :rvsab, :rvdom, :rvfer, :rvdia, :diavcto, :idiaspag ) c
        into :dtvencto;

        dtbase = dtvencto;

        -- Execuntado procedimento que insere registros na tabela fnitreceber

        execute procedure fnadicitrecebersp01 (
        :caltvlr, :icodemp,:scodfilial,:icodrec,:i,0,0,0,:nvlritrec,0, :ddatarec, :ddtcomprec, :dtvencto,'R1',:cflag,
        :icodempbo,:scodfilialbo, :ccodbanco, :icodemptc, :scodfilialtc, :icodtipocob,
        :icodempcb, :scodfilialcb, :codcartcob, :nvlrcomiitrec, :obsrec, :codempca,
        :codfilialca, :numconta, :codemppn, :codfilialpn, :codplan, :codempcc, :codfilialcc, :anocc, :codcc, :vlrbaseitcomis);


    end
    suspend;
end
^

SET TERM ; ^

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=1
 WHERE RDB$RELATION_NAME='FNCARTCOB' AND RDB$FIELD_NAME='CODEMPBO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=2
 WHERE RDB$RELATION_NAME='FNCARTCOB' AND RDB$FIELD_NAME='CODFILIALBO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=3
 WHERE RDB$RELATION_NAME='FNCARTCOB' AND RDB$FIELD_NAME='CODBANCO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=4
 WHERE RDB$RELATION_NAME='FNCARTCOB' AND RDB$FIELD_NAME='CODEMP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=5
 WHERE RDB$RELATION_NAME='FNCARTCOB' AND RDB$FIELD_NAME='CODFILIAL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=6
 WHERE RDB$RELATION_NAME='FNCARTCOB' AND RDB$FIELD_NAME='CODCARTCOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=7
 WHERE RDB$RELATION_NAME='FNCARTCOB' AND RDB$FIELD_NAME='VARIACAOCARTCOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=8
 WHERE RDB$RELATION_NAME='FNCARTCOB' AND RDB$FIELD_NAME='DESCCARTCOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=9
 WHERE RDB$RELATION_NAME='FNCARTCOB' AND RDB$FIELD_NAME='CARTCOBCNAB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=10
 WHERE RDB$RELATION_NAME='FNCARTCOB' AND RDB$FIELD_NAME='CODCARTCOBCNAB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=11
 WHERE RDB$RELATION_NAME='FNCARTCOB' AND RDB$FIELD_NAME='CONVCOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=12
 WHERE RDB$RELATION_NAME='FNCARTCOB' AND RDB$FIELD_NAME='DTINS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=13
 WHERE RDB$RELATION_NAME='FNCARTCOB' AND RDB$FIELD_NAME='HINS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=14
 WHERE RDB$RELATION_NAME='FNCARTCOB' AND RDB$FIELD_NAME='IDUSUINS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=15
 WHERE RDB$RELATION_NAME='FNCARTCOB' AND RDB$FIELD_NAME='DTALT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=16
 WHERE RDB$RELATION_NAME='FNCARTCOB' AND RDB$FIELD_NAME='HALT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=17
 WHERE RDB$RELATION_NAME='FNCARTCOB' AND RDB$FIELD_NAME='IDUSUALT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=1
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=2
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIAL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=3
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='USAREFPROD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=4
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODTIPOMOV';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=5
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPTM';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=6
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALTM';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=7
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='USAPEDSEQ';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=8
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='USAORCSEQ';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=9
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='FILTRO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=10
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='USALIQREL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=11
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='TIPOPRECOCUSTO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=12
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='ANOCENTROCUSTO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=13
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='OBSORCPAD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=14
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODTIPOMOV2';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=15
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALT2';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=16
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPT2';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=17
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CLASSORC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=18
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CLASSORCPD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=19
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='TITORCTXT01';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=20
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODTIPOMOV3';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=21
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALT3';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=22
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPT3';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=23
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='ORDNOTA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=24
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='SETORVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=25
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='PREFCRED';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=26
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='TIPOPREFCRED';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=27
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPMO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=28
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALMO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=29
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODMOEDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=30
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODTIPOMOV4';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=31
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALT4';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=32
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPT4';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=33
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='USACLASCOMIS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=34
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='PERCPRECOCUSTO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=35
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODGRUP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=36
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALGP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=37
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPGP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=38
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODMARCA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=39
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALMC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=40
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPMC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=41
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='RGCLIOBRIG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=42
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='TABFRETEVD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=43
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='TABADICVD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=44
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='TRAVATMNFVD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=45
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='TIPOVALIDORC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=46
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CLIMESMOCNPJ';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=47
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODTBJ';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=48
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPTJ';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=49
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALTJ';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=50
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CNPJOBRIGCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=51
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='JUROSPOSCALC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=52
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPFR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=53
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALFR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=54
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFOR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=55
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPTN';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=56
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALTN';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=57
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODTRAN';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=58
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPTF';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=59
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALTF';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=60
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODTIPOFOR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=61
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPT5';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=62
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALT5';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=63
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODTIPOMOV5';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=64
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='ESTLOTNEG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=65
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='ESTNEG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=66
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='NATVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=67
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='IPIVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=68
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CUSTOSICMS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=69
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPPG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=70
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALPG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=71
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODPLANOPAG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=72
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPTB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=73
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALTB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=74
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODTAB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=75
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPCE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=76
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALCE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=77
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODCLASCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=78
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CASASDEC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=79
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CASASDECFIN';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=80
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='COMISPDUPL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=81
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPT6';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=82
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALT6';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=83
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODTIPOMOV6';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=84
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='BLOQVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=85
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='BLOQCOMPRA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=86
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='VENDAMATPRIM';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=87
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='VENDAPATRIM';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=88
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='PEPSPROD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=89
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CNPJFOROBRIG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=90
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='INSCESTFOROBRIG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=91
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='BUSCAPRODSIMILAR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=92
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='MULTIALMOX';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=93
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPT8';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=94
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALT8';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=95
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODTIPOMOV8';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=96
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='ESTNEGGRUP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=97
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='USATABPE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=98
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='TAMDESCPROD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=99
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='DESCCOMPPED';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=100
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='OBSCLIVEND';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=101
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CONTESTOQ';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=102
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='DIASPEDT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=103
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='RECALCPCVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=104
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='RECALCPCORC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=105
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='USALAYOUTPED';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=106
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='VERIFALTPARCVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=107
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='BUSCACODPRODGEN';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=108
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='FILBUSCGENPROD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=109
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='FILBUSCGENREF';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=110
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='FILBUSCGENCODBAR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=111
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='FILBUSCGENCODFAB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=112
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='FILBUSCGENCODFOR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=113
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='BUSCAVLRULTCOMPRA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=114
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='ICMSVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=115
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='USAPRECOZERO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=116
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='USAIMGASSORC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=117
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='IMGASSORC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=118
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CONSISTCPFCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=119
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CONSISTEIECLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=120
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CONSISTEIEFOR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=121
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CONSISTECPFFOR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=122
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='USANOMEVENDORC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=123
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='SISCONTABIL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=124
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='ATBANCOIMPBOL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=125
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='TIPOCODBAR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=126
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='ADICORCOBSPED';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=127
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPMENSORC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=128
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALMENSORC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=129
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODMENSORC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=130
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CUSTOCOMPRA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=131
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='TABTRANSPCP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=132
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='TABTRANSPORC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=133
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='TABSOLCP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=134
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='ADICFRETEBASEICM';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=135
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='PRECOCPREL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=136
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='DESCORC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=137
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='MULTICOMIS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=138
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='USUATIVCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=139
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPHISTREC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=140
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALHISTREC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=141
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODHISTREC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=142
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPHISTPAG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=143
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALHISTPAG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=144
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODHISTPAG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=145
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPTC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=146
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALTC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=147
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODTIPOCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=148
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='ESTITRECALTDTVENC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=149
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='LCREDGLOBAL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=150
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='VDMANUTCOMOBRIG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=151
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CLASSPED';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=152
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='TIPOCLASSPED';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=153
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='USAIBGECLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=154
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='USAIBGEFOR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=155
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='USAIBGETRANSP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=156
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='SOMAVOLUMES';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=157
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='BUSCACEP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=158
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='URLWSCEP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=159
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CLASSCP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=160
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='LABELOBS01CP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=161
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='LABELOBS02CP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=162
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='LABELOBS03CP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=163
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='LABELOBS04CP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=164
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CONSISTEIEPF';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=165
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CREDICMSSIMPLES';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=166
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPMS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=167
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALMS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=168
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODMENSICMSSIMPLES';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=169
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='GERACOMISVENDAORC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=170
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='GERACODUNIF';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=171
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODTIPOMOV9';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=172
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALT9';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=173
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPT9';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=174
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPJP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=175
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALJP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=176
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODPLANJP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=177
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPJR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=178
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALJR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=179
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODPLANJR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=180
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPDR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=181
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALDR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=182
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODPLANDR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=183
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPDC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=184
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALDC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=185
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODPLANDC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=186
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='GERAPAGEMIS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=187
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='LANCAFINCONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=188
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='LANCARMACONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=189
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CASASDECPRE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=190
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='VISUALIZALUCR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=191
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CLASSNFE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=192
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='DIRNFE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=193
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='DIRNFELIN';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=194
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='FORMATODANFE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=195
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='AMBIENTENFE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=196
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='PROCEMINFE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=197
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='VERPROCNFE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=198
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='KEYLICNFE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=199
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='DTVENCTONFE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=200
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='INFADPRODNFE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=201
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPNF';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=202
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALNF';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=203
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMAILNF';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=204
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='EXIBEPARCOBSDANFE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=205
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='VERSAONFE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=206
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='REGIMETRIBNFE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=207
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='INFCPDEVOLUCAO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=208
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='INFVDREMESSA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=209
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='GERARECEMIS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=210
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='RETENSAOIMP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=211
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='TIPOCUSTOLUC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=212
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='TABIMPORTCP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=213
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='HABVLRTOTITORC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=214
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='USABUSCAGENPRODCP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=215
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='ADICOBSORCPED';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=216
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='USAPRECOCOT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=217
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='BLOQPRECOAPROV';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=218
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPFT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=219
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALFT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=220
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODTIPOFORFT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=221
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='USAPRECOCOMIS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=222
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='ESPECIALCOMIS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=223
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALTS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=224
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODTIPOMOVS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=225
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPTS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=226
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPSV';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=227
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALSV';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=228
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODPLANOPAGSV';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=229
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='ARREDPRECO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=230
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPPC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=231
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALPC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=232
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODPLANPC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=233
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='TPNOSSONUMERO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=234
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='IMPDOCBOL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=235
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='FECHACAIXA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=236
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='FECHACAIXAAUTO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=237
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='NUMDIGIDENTTIT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=238
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='KEYLICEFD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=239
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='DTVENCTOEFD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=240
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='REVALIDARLOTECOMPRA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=241
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='ENCORCPROD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=242
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPIM';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=243
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALIM';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=244
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODTIPOMOVIM';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=245
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='COMISSAODESCONTO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=246
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPHC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=247
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALHC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=248
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODHISTCNAB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=249
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='ALINHATELALANCA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=250
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='VENDACONSUM';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=251
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CVPROD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=252
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='VERIFPROD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=253
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='RMAPROD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=254
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='TIPOPROD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=255
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODEMPIG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=256
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODFILIALIG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=257
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='CODIMG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=258
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='OBSITVENDAPED';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=259
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='FATORCPARC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=260
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='APROVORCFATPARC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=261
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='BLOQSEQICP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=262
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='BLOQSEQIVD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=263
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='UTILORDCPINT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=264
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='KEYLICEPC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=265
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='DTVENCTOEPC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=266
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='IMPLOTENFE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=267
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='TOTCPSFRETE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=268
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='IDENTCLIBCO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=269
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='QTDDESC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=270
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='LOCALSERV';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=271
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='DTINS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=272
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='HINS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=273
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='IDUSUINS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=274
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='DTALT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=275
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='HALT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=276
 WHERE RDB$RELATION_NAME='SGPREFERE1' AND RDB$FIELD_NAME='IDUSUALT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=1
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODEMP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=2
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODFILIAL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=3
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='SMTPMAIL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=4
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='SMTPSSLMAIL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=5
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='SMTPAUTMAIL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=6
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='PORTAMAIL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=7
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='USERMAIL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=8
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='PASSMAIL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=9
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='ENDMAIL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=10
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='AUTOHORATEND';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=11
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODEMPCE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=12
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODFILIALCE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=13
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODATIVCE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=14
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODEMPTE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=15
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODFILIALTE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=16
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODATIVTE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=17
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='BLOQATENDCLIATRASO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=18
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='MOSTRACLIATRASO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=19
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODEMPNC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=20
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODFILIALNC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=21
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODEMAILNC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=22
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODEMPAO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=23
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODFILIALAO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=24
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODATENDO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=25
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODEMPMI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=26
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODFILIALMI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=27
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODMODELMI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=28
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODEMPME';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=29
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODFILIALME';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=30
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODMODELME';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=31
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODEMPFI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=32
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODFILIALFI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=33
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODMODELFI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=34
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODEMPFJ';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=35
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODFILIALFJ';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=36
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODMODELFJ';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=37
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODEMPAP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=38
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODFILIALAP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=39
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODMODELAP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=40
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODEMPEC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=41
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODFILIALEC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=42
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODEMAILEC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=43
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODEMPEA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=44
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODFILIALEA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=45
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODEMAILEA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=46
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODEMPT1';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=47
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODFILIALT1';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=48
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODTIPOCONT1';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=49
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODEMPCF';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=50
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODFILIALCF';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=51
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODCONFEMAIL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=52
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODEMPEN';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=53
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODFILIALEN';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=54
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='CODEMAILEN';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=55
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='EMAILNOTIF1';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=56
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='TEMPOMAXINT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=57
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='LANCAPONTOAF';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=58
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='TOLREGPONTO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=59
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='USACTOSEQ';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=60
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='LAYOUTFICHAAVAL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=61
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='DTINS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=62
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='HINS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=63
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='IDUSUINS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=64
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='DTALT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=65
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='HALT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=66
 WHERE RDB$RELATION_NAME='SGPREFERE3' AND RDB$FIELD_NAME='IDUSUALT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=1
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODEMP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=2
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODFILIAL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=3
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=4
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='RAZCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=5
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='NOMECLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=6
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODEMPCC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=7
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODFILIALCC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=8
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODCLASCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=9
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODEMPVD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=10
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODFILIALVD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=11
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODVEND';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=12
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODEMPTC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=13
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODFILIALTC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=14
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODTIPOCOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=15
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODEMPPG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=16
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODFILIALPG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=17
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODPLANOPAG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=18
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODEMPTN';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=19
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODFILIALTN';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=20
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODTRAN';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=21
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODEMPBO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=22
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODFILIALBO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=23
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODBANCO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=24
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODEMPSR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=25
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODFILIALSR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=26
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODSETOR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=27
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODEMPTI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=28
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODFILIALTI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=29
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODTIPOCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=30
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODTPCRED';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=31
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODFILIALTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=32
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODEMPTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=33
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODFISCCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=34
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODEMPFC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=35
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODFILIALFC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=36
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODEMPEC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=37
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODFILIALEC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=38
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODTBEC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=39
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODITTBEC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=40
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODEMPHP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=41
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODFILIALHP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=42
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODHIST';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=43
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODEMPCB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=44
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODFILIALCB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=45
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODCARTCOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=46
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='DATACLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=47
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='PESSOACLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=48
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='ATIVOCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=49
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CNPJCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=50
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='INSCCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=51
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CPFCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=52
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='RGCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=53
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='SSPCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=54
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='ENDCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=55
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='NUMCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=56
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='COMPLCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=57
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='BAIRCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=58
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CIDCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=59
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='UFCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=60
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CEPCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=61
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='DDDCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=62
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='FONECLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=63
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='RAMALCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=64
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='DDDFAXCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=65
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='FAXCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=66
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='EMAILCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=67
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='EMAILCOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=68
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='EMAILENT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=69
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='EMAILNFECLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=70
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CONTCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=71
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='ENDCOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=72
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='NUMCOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=73
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='COMPLCOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=74
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='BAIRCOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=75
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CIDCOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=76
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='UFCOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=77
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CEPCOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=78
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='DDDFONECOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=79
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='FONECOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=80
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='DDDFAXCOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=81
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='FAXCOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=82
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='ENDENT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=83
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='NUMENT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=84
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='COMPLENT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=85
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='BAIRENT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=86
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CIDENT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=87
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='UFENT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=88
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CEPENT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=89
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='DDDFONEENT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=90
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='FONEENT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=91
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='DDDFAXENT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=92
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='FAXENT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=93
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='OBSCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=94
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='AGENCIACLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=95
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='NCONTABCOCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=96
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODEMPPQ';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=97
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODFILIALPQ';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=98
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODPESQ';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=99
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='INCRACLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=100
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='DTINITR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=101
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='DTVENCTOTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=102
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='NIRFCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=103
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='SIMPLESCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=104
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='DDDCELCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=105
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CELCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=106
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='NATCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=107
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='UFNATCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=108
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='TEMPORESCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=109
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='APELIDOCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=110
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='SITECLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=111
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODCONTDEB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=112
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODCONTCRED';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=113
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODCLICONTAB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=114
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='FOTOCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=115
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='IMGASSCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=116
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODMUNIC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=117
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='SIGLAUF';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=118
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODPAIS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=119
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODMUNICENT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=120
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='SIGLAUFENT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=121
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODPAISENT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=122
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODMUNICCOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=123
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='SIGLAUFCOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=124
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODPAISCOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=125
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODEMPUC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=126
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODFILIALUC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=127
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODUNIFCOD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=128
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='SUFRAMACLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=129
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='PRODRURALCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=130
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CTOCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=131
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CODCNAE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=132
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='INSCMUNCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=133
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='PERCDESCCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=134
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CONTCLICOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=135
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='CONTCLIENT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=136
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='DESCIPI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=137
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='IDENTCLIBCO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=138
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='DTINS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=139
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='HINS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=140
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='IDUSUINS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=141
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='DTALT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=142
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='HALT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=143
 WHERE RDB$RELATION_NAME='VDCLIENTE' AND RDB$FIELD_NAME='IDUSUALT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=1
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='CODEMP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=2
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='CODFILIAL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=3
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='CODCONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=4
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='DESCCONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=5
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='MINUTACONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=6
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='CODEMPCL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=7
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='CODFILIALCL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=8
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='CODCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=9
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='DTINICIO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=10
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='DTFIM';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=11
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='TPCOBCONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=12
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='DIAVENCCONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=13
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='DIAFECHCONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=14
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='INDEXCONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=15
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='TPCONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=16
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='SITCONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=17
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='CODEMPMC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=18
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='CODFILIALMC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=19
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='CODMODCONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=20
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='DTPREVFIN';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=21
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='CODEMPSP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=22
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='CODFILIALSP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=23
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='CODCONTRSP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=24
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='DESCSITCONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=25
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='ATIVO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=26
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='RECEBCONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=27
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='CONTHSUBCONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=28
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='DTINS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=29
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='HINS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=30
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='IDUSUINS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=31
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='DTALT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=32
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='HALT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=33
 WHERE RDB$RELATION_NAME='VDCONTRATO' AND RDB$FIELD_NAME='IDUSUALT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=1
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='CODEMP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=2
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='CODFILIAL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=3
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='CODCONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=4
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='CODITCONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=5
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='DESCITCONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=6
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='CODEMPPD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=7
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='CODFILIALPD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=8
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='CODPROD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=9
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='QTDITCONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=10
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='VLRITCONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=11
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='CODEMPPE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=12
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='CODFILIALPE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=13
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='CODPRODPE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=14
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='VLRITCONTREXCED';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=15
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='INDEXITCONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=16
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='KEYLIC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=17
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='DTINS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=18
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='HINS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=19
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='IDUSUINS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=20
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='DTALT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=21
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='HALT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=22
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='IDUSUALT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=23
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='ACUMULOITCONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=24
 WHERE RDB$RELATION_NAME='VDITCONTRATO' AND RDB$FIELD_NAME='FRANQUIAITCONTR';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=1
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODEMP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=2
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODFILIAL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=3
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='TIPOVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=4
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=5
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODEMPVD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=6
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODFILIALVD';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=7
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODVEND';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=8
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODEMPCL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=9
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODFILIALCL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=10
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODCLI';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=11
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODEMPPG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=12
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODFILIALPG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=13
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODPLANOPAG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=14
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODEMPSE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=15
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODFILIALSE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=16
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='SERIE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=17
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODEMPTM';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=18
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODFILIALTM';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=19
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODTIPOMOV';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=20
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODEMPCX';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=21
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODFILIALCX';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=22
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODCAIXA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=23
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='DOCVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=24
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='DTSAIDAVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=25
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='DTEMITVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=26
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='DTCOMPVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=27
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODEMPRM';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=28
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODFILIALRM';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=29
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='TICKET';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=30
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRPRODVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=31
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='PERCDESCVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=32
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRDESCVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=33
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRDESCITVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=34
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=35
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRBASEICMSVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=36
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRICMSVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=37
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CALCICMSVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=38
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='IMPICMSVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=39
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRISENTASVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=40
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLROUTRASVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=41
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRBASEIPIVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=42
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRLIQVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=43
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='PERCCOMISVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=44
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRCOMISVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=45
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='STATUSVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=46
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRFRETEVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=47
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRADICVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=48
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRIPIVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=49
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CALCIPIVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=50
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='IMPIPIVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=51
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='OBSVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=52
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODEMPBO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=53
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODFILIALBO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=54
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODBANCO';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=55
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODEMPTC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=56
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODFILIALTC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=57
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODTIPOCOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=58
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRBASEISSVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=59
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRISSVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=60
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CALCISSVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=61
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='IMPIISSVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=62
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='IMPNOTAVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=63
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='FLAG';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=64
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODCLASCOMIS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=65
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRPISVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=66
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CALCPISVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=67
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='IMPPISVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=68
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRCOFINSVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=69
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CALCCOFINSVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=70
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='IMPCOFINSVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=71
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRIRVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=72
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CALCIRVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=73
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='IMPIRVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=74
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRCSOCIALVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=75
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CALCCSOCIALVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=76
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='IMPCSOCIALVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=77
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='PERCMCOMISVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=78
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODEMPCM';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=79
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODFILIALCM';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=80
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODCLCOMIS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=81
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODEMPCB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=82
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODFILIALCB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=83
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODCARTCOB';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=84
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='PEDCLIVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=85
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRICMSSTVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=86
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRBASEICMSSTVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=87
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='EMMANUT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=88
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='BLOQVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=89
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRICMSSIMPLES';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=90
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='PERCICMSSIMPLES';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=91
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRBASEPISVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=92
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRBASECOFINSVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=93
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='VLRBASECOMIS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=94
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CHAVENFEVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=95
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODEMPCA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=96
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODFILIALCA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=97
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='NUMCONTA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=98
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='OBSREC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=99
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='INFCOMPL';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=100
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='SITDOC';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=101
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='OBSNFE';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=102
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='DESCIPIVENDA';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=103
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODEMPOP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=104
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODFILIALOP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=105
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='SEQOP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=106
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='CODOP';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=107
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='LOCALSERV';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=108
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='DTINS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=109
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='HINS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=110
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='IDUSUINS';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=111
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='DTALT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=112
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='HALT';

UPDATE RDB$RELATION_FIELDS SET RDB$FIELD_POSITION=113
 WHERE RDB$RELATION_NAME='VDVENDA' AND RDB$FIELD_NAME='IDUSUALT';

/* Create(Add) Crant */
GRANT SELECT ON ATATENDIMENTOVW01 TO ADM;

GRANT SELECT ON ATATENDIMENTOVW02 TO ADM;

GRANT SELECT ON ATATENDIMENTOVW02 TO PROCEDURE VDCONTRATOTOTSP;

GRANT SELECT ON ATATENDIMENTOVW03 TO ADM;

GRANT SELECT ON ATATENDIMENTOVW04 TO ADM;

GRANT SELECT ON ATATENDIMENTOVW06 TO ADM;

GRANT SELECT ON ATATENDIMENTOVW08 TO ADM;

GRANT SELECT ON VWCUSTOPROJ01 TO ADM;



COMMIT WORK;
