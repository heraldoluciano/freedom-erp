/* Server Version: LI-V6.3.4.4910 Firebird 1.5.  ODS Version: 10.1. */
SET NAMES NONE;

SET SQL DIALECT 3;

--CONNECT 'localhost:/opt/firebird/dados/desenv/freedom1.2.6.0.fdb' USER 'SYSDBA' PASSWORD '123654' ROLE 'ADM';

SET AUTODDL ON;

ALTER TABLE CPITCOMPRA ADD TIPONFITCOMPRA CHAR(1) DEFAULT 'N';

ALTER TABLE EQPRODUTO ADD PRAZOREPO INTEGER;

ALTER TABLE FNITPAGAR ADD CODEMPCT INTEGER;

ALTER TABLE FNITPAGAR ADD CODFILIALCT SMALLINT;

ALTER TABLE FNITPAGAR ADD CODCONTR INTEGER;

ALTER TABLE FNITPAGAR ADD CODITCONTR SMALLINT;

ALTER TABLE FNITRECEBER ADD CODEMPCT INTEGER;

ALTER TABLE FNITRECEBER ADD CODFILIALCT SMALLINT;

ALTER TABLE FNITRECEBER ADD CODCONTR INTEGER;

ALTER TABLE FNITRECEBER ADD CODITCONTR SMALLINT;

ALTER TABLE LFSITTRIB ADD OPERACAO CHAR(1) DEFAULT 'S' NOT NULL;

Update Rdb$Relation_Fields set Rdb$Description =
'Operacao de (S) - Saida, (E) - Entrada'
where Rdb$Relation_Name='LFSITTRIB' and Rdb$Field_Name='OPERACAO';

ALTER TABLE SGPREFERE1 ADD NPERMITDTMAIOR CHAR(1) DEFAULT 'N' NOT NULL;

ALTER TABLE SGPREFERE1 ADD PERMITIMPORCANTAP CHAR(1) DEFAULT 'S' NOT NULL;

ALTER TABLE SGPREFERE1 ADD BLOQEDITORCAPOSAP CHAR(1) DEFAULT 'N' NOT NULL;

ALTER TABLE SGPREFERE1 ADD BLOQVDPORATRASO CHAR(1) DEFAULT 'N' NOT NULL;

ALTER TABLE SGPREFERE1 ADD NUMDIASBLOQVD SMALLINT DEFAULT 0 NOT NULL;

ALTER TABLE SGPREFERE3 ADD CODEMPOR INTEGER;

ALTER TABLE SGPREFERE3 ADD CODFILIALOR SMALLINT;

ALTER TABLE SGPREFERE3 ADD CODMODELOR INTEGER;

ALTER TABLE SGPREFERE3 ADD BLOQATENDIMENTO CHAR(1) NOT NULL;

ALTER TABLE SGPREFERE3 ADD PERIODOBLOQ INTEGER;

ALTER TABLE SGPREFERE8 ADD DETITEMPAINELSERV CHAR(1) DEFAULT 'N' NOT NULL;

ALTER TABLE VDCLIENTE ADD DDDCELENT CHAR(4);

ALTER TABLE VDCLIENTE ADD CELENT VARCHAR(9);

/* Create Table... */
CREATE TABLE SPNATOPER(CST CHAR(2) NOT NULL,
CODIGO VARCHAR(10) NOT NULL,
DESC_PROD VARCHAR(500) NOT NULL,
DT_INI DATE,
DT_FIM DATE,
NCM VARCHAR(1000),
NCM_EX VARCHAR(1000),
EX_IPI VARCHAR(1000),
UNID VARCHAR(250),
ALIQ_PIS DECIMAL(10,2),
ALIQ_COFIN DECIMAL(10,2),
EX_TAB_OPER_SEM_CSL VARCHAR(1000),
DTINS DATE DEFAULT 'now' NOT NULL,
HINS TIME DEFAULT 'now' NOT NULL,
IDUSUINS VARCHAR(128) DEFAULT USER NOT NULL,
DTALT DATE DEFAULT 'now' NOT NULL,
HALT TIME DEFAULT 'now' NOT NULL,
IDUSUALT VARCHAR(128) DEFAULT USER);


CREATE TABLE VDCONTRORC(CODEMP INTEGER NOT NULL,
CODFILIAL INTEGER NOT NULL,
CODCONTR INTEGER NOT NULL,
CODITCONTR INTEGER NOT NULL,
CODEMPOR INTEGER NOT NULL,
CODFILIALOR INTEGER NOT NULL,
TIPOORC CHAR(1) NOT NULL,
CODORC INTEGER NOT NULL,
CODITORC INTEGER NOT NULL,
DTINS DATE DEFAULT 'now' NOT NULL,
HINS TIME DEFAULT 'now' NOT NULL,
IDUSUINS CHAR(8) DEFAULT USER NOT NULL,
DTALT DATE DEFAULT 'now',
HALT TIME DEFAULT 'now',
IDUSUALT CHAR(8) DEFAULT USER);



/* Alter View (Drop, Create)... */
/* Drop altered view: ATATENDIMENTOVW01 */
/* AssignEmptyBody proc */
SET TERM ^ ;

ALTER PROCEDURE ATRESUMOATENDOSP01(CODEMPP INTEGER,
CODFILIALP SMALLINT,
CODCLIP INTEGER,
CODEMPCTP INTEGER,
CODFILIALCTP SMALLINT,
CODCONTRP INTEGER,
CODITCONTRP SMALLINT,
DTINIP DATE,
DTFIMP DATE)
 RETURNS(ANO SMALLINT,
MES SMALLINT,
CODEMPCL INTEGER,
CODFILIALCL SMALLINT,
CODCLI INTEGER,
CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
CODCONTR INTEGER,
QTDCONTR DECIMAL(15,5),
DTINICIO DATE,
VALOR DECIMAL(15,5),
VALOREXCEDENTE DECIMAL(15,5),
QTDITCONTR DECIMAL(15,5),
QTDHORAS DECIMAL(15,2),
MESCOB INTEGER,
SALDOMESCOB DECIMAL(15,5),
SALDOMES DECIMAL(15,5),
SALDOPERIODO DECIMAL(15,5),
EXCEDENTEMESCOB DECIMAL(15,5),
EXCEDENTEPERIODO DECIMAL(15,5),
EXCEDENTECOB DECIMAL(15,5),
VALOREXCEDENTECOB DECIMAL(15,5),
VALORTOTALCOB DECIMAL(15,5),
VALORCONTR DECIMAL(15,5),
EXCEDENTEMES DECIMAL(15,5),
TOTFRANQUIAMES DECIMAL(15,5))
 AS
 BEGIN EXIT; END
^

/* AssignEmptyBody proc */
ALTER PROCEDURE VDCONTRATOTOTSP(CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
CODCONTR INTEGER,
CODITCONTR INTEGER,
CODEMPSC INTEGER,
CODFILIALSC SMALLINT,
CODCONTRSC INTEGER,
CODEMPTA INTEGER,
CODFILIALTA SMALLINT,
CODTAREFA INTEGER,
CODEMPST INTEGER,
CODFILIALST SMALLINT,
CODTAREFAST INTEGER,
DATAINI DATE,
DATAFIM DATE)
 RETURNS(TOTALPREVGERAL NUMERIC(15,5),
TOTALPREVPER NUMERIC(15,5),
TOTALGERAL NUMERIC(15,5),
TOTALCOBCLIGERAL NUMERIC(15,5),
TOTALANT NUMERIC(15,5),
TOTALCOBCLIANT NUMERIC(15,5),
TOTALPER NUMERIC(15,5),
TOTALCOBCLIPER NUMERIC(15,5),
SALDOANT NUMERIC(15,5),
SALDOPER NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

SET TERM ; ^

DROP VIEW ATATENDIMENTOVW06;

DROP VIEW ATATENDIMENTOVW03;

DROP VIEW ATATENDIMENTOVW08;

DROP VIEW ATATENDIMENTOVW02;

DROP VIEW ATATENDIMENTOVW04;

DROP VIEW ATATENDIMENTOVW01;

/* Create altered view: ATATENDIMENTOVW01 */
/* Create view: ATATENDIMENTOVW01 (ViwData.CreateDependDef) */
CREATE VIEW ATATENDIMENTOVW01(
CODEMP,
CODFILIAL,
CODATENDO,
CODEMPAE,
CODFILIALAE,
CODATEND,
NOMEATEND,
PARTPREMIATEND,
CODEMPEP,
CODFILIALEP,
MATEMPR,
COEMPEA,
CODFILIALEA,
CODESPEC,
DESCESPEC,
CODEMPCT,
CODFILIALCT,
CODCONTR,
DESCCONTR,
CODITCONTR,
CODEMPTA,
CODFILIALTA,
CODTAREFA,
TPCOBCONTR,
ANOATENDO,
MESATENDO,
QTDCONTR,
QTDITCONTR,
VLRITCONTR,
VLRITCONTREXCED,
DTINICIO,
STATUSATENDO,
RAZCLI,
NOMECLI,
CODCLI,
CODEMPCL,
CODFILIALCL,
CODEMPCH,
CODFILIALCH,
CODCHAMADO,
DESCCHAMADO,
CODEMPTO,
CODFILIALTO,
CODTPATENDO,
DESCTPATENDO,
OBSATENDO,
DATAATENDO,
DATAATENDOFIN,
HORAATENDO,
HORAATENDOFIN,
PGCOMIESPEC,
COBCLIESPEC,
CONTMETAESPEC,
MRELCOBESPEC,
BHESPEC,
TEMPOMINCOBESPEC,
TEMPOMAXCOBESPEC,
PERCCOMIESPEC,
TOTALMIN,
SITREVATENDO,
SITCONTR,
DESCSITCONTR,
DTPREVFIN,
TIPOATENDO,
DOCATENDO,
CODEMPOC,
CODFILIALOC,
TIPOORC,
CODORC)
 AS 
select a.codemp, a.codfilial, a.codatendo
  , a.codempae, a.codfilialae, a.codatend, ate.nomeatend, ate.partpremiatend, ate.codempep, codfilialep, matempr
  , a.codempea, a.codfilialea, a.codespec, e.descespec
  , a.codempct, a.codfilialct, a.codcontr, ct.desccontr, a.coditcontr 
  , a.codempta, a.codfilialta, a.codtarefa, ct.tpcobcontr
  , extract(year from a.dataatendo) anoatendo, extract(month from a.dataatendo) mesatendo
  , ( select sum(qtditcontr) from vditcontrato ics 
     where ics.codemp=a.codempct and ics.codfilial=a.codfilialct 
     and ics.codcontr=a.codcontr and ics.franquiaitcontr='S') qtdcontr 
  , ict.qtditcontr, ict.vlritcontr, ict.vlritcontrexced, ct.dtinicio
  , a.statusatendo, c.razcli, c.nomecli, c.codcli, c.codemp, c.codfilial
  , a.codempch, a.codfilialch, a.codchamado, ch.descchamado
  , a.codempto, a.codfilialto, a.codtpatendo, ta.desctpatendo
  , a.obsatendo, a.dataatendo, a.dataatendofin, a.horaatendo, a.horaatendofin
  , e.pgcomiespec, e.cobcliespec, e.contmetaespec, e.mrelcobespec, e.bhespec
  , e.tempomincobespec, e.tempomaxcobespec, e.perccomiespec, ((a.horaatendofin-a.horaatendo) / 60) TOTALMIN
  , a.sitrevatendo
  , ct.sitcontr, ct.descsitcontr, ct.dtprevfin, ta.tipoatendo, a.docatendo, atc.codempoc, atc.codfilialoc, atc.tipoorc, atc.codorc
from atatendente ate, atespecatend e, vdcliente c, attipoatendo ta, atatendimento a
left outer join crchamado ch on 
ch.codemp=a.codempch and ch.codfilial=a.codfilialch and ch.codchamado=a.codchamado 
left outer join vdcontrato ct on
ct.codemp=a.codempct and ct.codfilial=a.codfilialct and ct.codcontr=a.codcontr
left outer join vditcontrato ict on
ict.codemp=a.codempct and ict.codfilial=a.codfilialct and ict.codcontr=a.codcontr and ict.coditcontr=a.coditcontr
left outer join atatendimentoorc atc on
atc.codemp=a.codemp and atc.codfilial=a.codfilial and atc.codatendo=a.codatendo
where ate.codemp=a.codempae and ate.codfilial=a.codfilialae and ate.codatend=a.codatend and
e.codemp=a.codempea and e.codfilial=a.codfilialea and e.codespec=a.codespec and 
c.codemp=a.codempcl and c.codfilial=a.codfilialcl and c.codcli=a.codcli and
ta.codemp=a.codempto and ta.codfilial=a.codfilialto and ta.codtpatendo=a.codtpatendo
;

/* Drop altered view: ATATENDIMENTOVW02 */
/* Create altered view: ATATENDIMENTOVW02 */
/* Create view: ATATENDIMENTOVW02 (ViwData.CreateDependDef) */
CREATE VIEW ATATENDIMENTOVW02(
CODEMP,
CODFILIAL,
CODATENDO,
CODEMPAE,
CODFILIALAE,
CODATEND,
NOMEATEND,
PARTPREMIATEND,
CODEMPEP,
CODFILIALEP,
MATEMPR,
CODEMPEA,
CODFILIALEA,
CODESPEC,
DESCESPEC,
CODEMPCT,
CODFILIALCT,
CODCONTR,
CODITCONTR,
CODEMPTA,
CODFILIALTA,
CODTAREFA,
TPCOBCONTR,
ANOATENDO,
MESATENDO,
QTDCONTR,
QTDITCONTR,
VLRITCONTR,
VLRITCONTREXCED,
DTINICIO,
STATUSATENDO,
RAZCLI,
NOMECLI,
CODCLI,
CODEMPCL,
CODFILIALCL,
CODEMPCH,
CODFILIALCH,
CODCHAMADO,
DESCCHAMADO,
CODEMPTO,
CODFILIALTO,
CODTPATENDO,
DESCTPATENDO,
OBSATENDO,
DATAATENDO,
DATAATENDOFIN,
HORAATENDO,
HORAATENDOFIN,
PGCOMIESPEC,
COBCLIESPEC,
CONTMETAESPEC,
MRELCOBESPEC,
BHESPEC,
TEMPOMINCOBESPEC,
TEMPOMAXCOBESPEC,
PERCCOMIESPEC,
TOTALMIN,
TOTALGERAL,
TOTALMETA,
TOTALCOMIS,
TOTALCOBCLI,
TOTALBH,
SITREVATENDO,
TIPOATENDO,
DOCATENDO,
CODEMPOC,
CODFILIALOC,
TIPOORC,
CODORC)
 AS 
select A.CODEMP, A.CODFILIAL, A.CODATENDO, 
A.CODEMPAE, A.CODFILIALAE, A.CODATEND, A.NOMEATEND, A.PARTPREMIATEND, A.CODEMPEP, CODFILIALEP, MATEMPR,
A.COEMPEA, A.CODFILIALEA, A.CODESPEC, A.DESCESPEC, 
 A.CODEMPCT, A.CODFILIALCT, A.CODCONTR,  A.CODITCONTR, A.CODEMPTA, A.CODFILIALTA, A.CODTAREFA, A.TPCOBCONTR,
 A.ANOATENDO, A.MESATENDO, A.QTDCONTR,
 A.QTDITCONTR, A.VLRITCONTR, A.VLRITCONTREXCED, A.DTINICIO,
 A.STATUSATENDO, A.RAZCLI, A.NOMECLI, A.CODCLI,
  A.CODEMPCL, A.CODFILIALCL, A.CODEMPCH, A.CODFILIALCH, A.CODCHAMADO, A.DESCCHAMADO,
  A.CODEMPTO, A.CODFILIALTO, A.CODTPATENDO,
   A.DESCTPATENDO, A.OBSATENDO, A.DATAATENDO, A.DATAATENDOFIN, A.HORAATENDO, A.HORAATENDOFIN,
    A.PGCOMIESPEC, A.COBCLIESPEC, A.CONTMETAESPEC, A.MRELCOBESPEC, A.BHESPEC, A.TEMPOMINCOBESPEC, A.TEMPOMAXCOBESPEC,
     A.PERCCOMIESPEC, A.TOTALMIN, 
  (a.totalmin) / 60  totalgeral, 
(( (case when a.contmetaespec='S' then (case when 
a.totalmin<a.tempomincobespec 
then a.tempomincobespec else 
(case when a.totalmin>a.tempomaxcobespec and a.tempomaxcobespec<>0 
then a.tempomaxcobespec else a.totalmin end) end)  else 0 end) 
)/60 ) totalmeta, 
(( (case when a.pgcomiespec='S' then (case when a.totalmin<a.tempomincobespec 
then a.tempomincobespec else 
(case when a.totalmin>a.tempomaxcobespec and a.tempomaxcobespec<>0 
then a.tempomaxcobespec else a.totalmin end) end)  else 0 end) 
)/60 ) totalcomis, 
(( (case when a.cobcliespec='S' and a.statusatendo<>'NC' then (case when a.totalmin<a.tempomincobespec 
then a.tempomincobespec else 
(case when a.totalmin>a.tempomaxcobespec and a.tempomaxcobespec<>0 
then a.tempomaxcobespec else a.totalmin end) end)  else 0 end) 
)/60 ) totalcobcli,
( (case when a.bhespec='S' then a.totalmin else 0 end)/60 ) totalbh,
a.sitrevatendo, a.tipoatendo, a.docatendo, a.codempoc, a.codfilialoc, a.tipoorc, a.codorc
from atatendimentovw01 a
;

/* Drop altered view: ATATENDIMENTOVW03 */
/* Create altered view: ATATENDIMENTOVW03 */
/* Create view: ATATENDIMENTOVW03 (ViwData.CreateDependDef) */
CREATE VIEW ATATENDIMENTOVW03(
CODEMP,
CODFILIAL,
CODATENDO,
CODEMPAE,
CODFILIALAE,
CODATEND,
NOMEATEND,
PARTPREMIATEND,
CODEMPEP,
CODFILIALEP,
MATEMPR,
NOMEEMPR,
DATAATENDO,
HORAATENDO,
HORAATENDOFIN,
CODEMPTO,
CODFILIALTO,
CODTURNO,
DESCTURNO,
CODEMPEA,
CODFILIALEA,
CODESPEC,
DESCESPEC,
PERCCOMIESPEC,
CODEMPCT,
CODFILIALCT,
CODCONTR,
CODITCONTR,
CODEMPTA,
CODFILIALTA,
CODTAREFA,
TPCOBCONTR,
ANOATENDO,
MESATENDO,
HORASEXPED,
TOTALCOMIS,
TOTALMIN,
TOTALGERAL,
TOTALBH,
SITREVATENDO,
TIPOATENDO,
DOCATENDO,
CODEMPOC,
CODFILIALOC,
TIPOORC,
CODORC)
 AS 
select a.codemp, a.codfilial, a.codatendo, 
    a.codempae, a.codfilialae, a.codatend, a.nomeatend, a.partpremiatend,
     a.codempep, a.codfilialep, a.matempr, e.nomeempr,
     a.dataatendo, a.horaatendo, a.horaatendofin,
    e.codempto, e.codfilialto, e.codturno, t.descturno,
    a.codempea, a.codfilialea, a.codespec, a.descespec, a.perccomiespec,
    a.codempct, a.codfilialct, a.codcontr, a.coditcontr,
    a.codempta, a.codfilialta, a.codtarefa, 
    a.tpcobcontr,
    a.anoatendo, a.mesatendo, 
    x.horasexped, a.totalcomis, a.totalmin, a.totalgeral,
    ( a.totalbh * ( 1 +  
       ((case when extract(weekday from a.dataatendo)=6 then t.percbhtbsabturno 
          when extract(weekday from a.dataatendo)=0 then t.percbhtbdomturno
          when coalesce(f.trabfer,'N')='S' then t.percbhtbferturno
          else 0 end
       )/100 ) )
    ) totalbh,
    a.sitrevatendo, a.tipoatendo, a.docatendo, a.codempoc, a.codfilialoc, a.tipoorc, a.codorc
    from atatendimentovw02 a
    left outer join rhempregado e on
    e.codemp=a.codempep and e.codfilial=a.codfilialep and e.matempr=a.matempr
    left outer join rhturno t on
    t.codemp=e.codempto and t.codfilial=e.codfilialto and t.codturno=e.codturno
    left outer join rhexpedmes x on
    x.codemp=e.codempto and x.codfilial=e.codfilialto and x.codturno=e.codturno and 
    x.anoexped=extract(year from a.dataatendo) and x.mesexped=extract(month from a.dataatendo)
    left outer join sgferiado f on
    f.codemp=a.codemp and f.codfilial=a.codfilial and f.datafer=a.dataatendo
;

/* Drop altered view: ATATENDIMENTOVW04 */
/* Create altered view: ATATENDIMENTOVW04 */
/* Create view: ATATENDIMENTOVW04 (ViwData.CreateDependDef) */
CREATE VIEW ATATENDIMENTOVW04(
DATAATENDO,
CODEMPCT,
CODFILIALCT,
CODCONTR,
CODITCONTR,
ANOATENDO,
MESATENDO,
TOTALHORASTRAB,
CODEMPOC,
CODFILIALOC,
TIPOORC,
CODORC)
 AS 
select a.dataatendo, a.codempct, a.codfilialct, a.codcontr, a.coditcontr, a.anoatendo, a.mesatendo, sum(totalmin)/60 totalhorastrab, a.codempoc, a.codfilialoc, a.tipoorc, a.codorc
from atatendimentovw01 a
group by a.dataatendo, a.codempct, a.codfilialct, a.codcontr, a.coditcontr, a.anoatendo, a.mesatendo, a.codempoc, a.codfilialoc, a.tipoorc, a.codorc
;

/* Drop altered view: ATATENDIMENTOVW06 */
/* Create altered view: ATATENDIMENTOVW06 */
/* Create view: ATATENDIMENTOVW06 (ViwData.CreateDependDef) */
CREATE VIEW ATATENDIMENTOVW06(
CODEMP,
CODFILIAL,
CODATENDO,
CODEMPAE,
CODFILIALAE,
CODATEND,
NOMEATEND,
CODEMPEP,
CODFILIALEP,
MATEMPR,
NOMEEMPR,
DATAATENDO,
HORAATENDO,
HORAATENDOFIN,
CODEMPTO,
CODFILIALTO,
CODTURNO,
DESCTURNO,
CODEMPEA,
CODFILIALEA,
CODESPEC,
DESCESPEC,
PERCCOMIESPEC,
CODEMPCT,
CODFILIALCT,
CODCONTR,
CODITCONTR,
TPCOBCONTR,
ANOATENDO,
MESATENDO,
HORASEXPED,
TOTALCOMIS,
TOTALGERAL,
TOTALBH,
TOTALHORASTRAB,
VLRLIQITVENDA,
SITREVATENDO,
CODEMPOC,
CODFILIALOC,
TIPOORC,
CODORC)
 AS 
select a.codemp, a.codfilial, a.codatendo, a.codempae, a.codfilialae, a.codatend, 
a.nomeatend, a.codempep, a.codfilialep, a.matempr, a.nomeempr, a.dataatendo, 
a.horaatendo, a.horaatendofin, a.codempto, a.codfilialto, a.codturno, a.descturno,
a.codempea, a.codfilialea, a.codespec, a.descespec, perccomiespec,
a.codempct, a.codfilialct, a.codcontr, a.coditcontr, a.tpcobcontr,
a.anoatendo, a.mesatendo, 
a.horasexped, a.totalcomis, a.totalgeral, a.totalbh,
 ( case when a.tpcobcontr='ES' then ( select s1.totalhorastrab from atatendimentovw04 s1
        where s1.codempct=a.codempct and s1.codfilialct=a.codfilialct and 
        s1.codcontr=a.codcontr and s1.coditcontr=a.coditcontr ) 
   else ( select s1.totalhorastrab from atatendimentovw04 s1
        where s1.codempct=a.codempct and s1.codfilialct=a.codfilialct and 
        s1.codcontr=a.codcontr and s1.coditcontr=a.coditcontr and 
        s1.anoatendo=a.anoatendo and s1.mesatendo=a.mesatendo ) end) totalhorastrab, 
  ( case when a.tpcobcontr='ES' then ( select s2.vlrliqitvenda from atatendimentovw05 s2
        where s2.codempct=a.codempct and s2.codfilialct=a.codfilialct and 
         s2.codcontr=a.codcontr and s2.coditcontr=a.coditcontr)
        else ( select s2.vlrliqitvenda from atatendimentovw05 s2
        where s2.codempct=a.codempct and s2.codfilialct=a.codfilialct and 
         s2.codcontr=a.codcontr and s2.coditcontr=a.coditcontr and
         a.dataatendo between s2.dtiniapura and s2.dtfinapura) end ) vlrliqitvenda,
   a.sitrevatendo, a.codempoc, a.codfilialoc, a.tipoorc, a.codorc
from atatendimentovw03 a
;

/* Drop altered view: ATATENDIMENTOVW08 */
/* Create altered view: ATATENDIMENTOVW08 */
/* Create view: ATATENDIMENTOVW08 (ViwData.CreateDependDef) */
CREATE VIEW ATATENDIMENTOVW08(
DATAATENDO,
DTFINCONTR,
CODEMPAE,
CODFILIALAE,
CODATEND,
NOMEATEND,
CODEMPCT,
CODFILIALCT,
CODCONTR,
CODITCONTR,
DESCCONTR,
DESCITCONTR,
TPCOBCONTR,
SITCONTR,
TOTALCOMIS,
CODEMPOC,
CODFILIALOC,
TIPOORC,
CODORC)
 AS 
select a.dataatendo, fn.dtfincontr, a.codempae, a.codfilialae, a.codatend, a.nomeatend,
a.codempct, a.codfilialct, a.codcontr, a.coditcontr, ct.desccontr, ic.descitcontr,
ct.tpcobcontr, ct.sitcontr,
sum(a.totalcomis) totalcomis, a.codempoc, a.codfilialoc, a.tipoorc, a.codorc
from atatendimentovw02 a, vditcontrato ic,  vdcontrato ct
left outer join vdfincontr fn
on fn.codemp=ct.codemp and fn.codfilial=ct.codfilial and
fn.codcontr=ct.codcontr
where ct.codemp=a.codempct and ct.codfilial=a.codfilialct and ct.codcontr=a.codcontr and
ic.codemp=a.codempct and ic.codfilial=a.codfilialct and ic.codcontr=a.codcontr and
ic.coditcontr=a.coditcontr and ct.recebcontr='S' and
( (ct.tpcobcontr='ES' and fn.dtfincontr is not null) or (ct.tpcobcontr='ME') )
group by a.dataatendo, fn.dtfincontr, a.codempae, a.codfilialae, a.codatend, a.nomeatend,
a.codempct, a.codfilialct, a.codcontr, a.coditcontr, ct.desccontr, ic.descitcontr,
ct.tpcobcontr, ct.sitcontr, a.codempoc, a.codfilialoc, a.tipoorc, a.codorc
;

/* Create Index... */
CREATE INDEX EQMOVPRODIDX02 ON EQMOVPROD(CODPROD,DTMOVPROD);


/* Create Primary Key... */
ALTER TABLE SPNATOPER ADD CONSTRAINT SPNATOPERLPK PRIMARY KEY (CODIGO,CST);

ALTER TABLE VDCONTRORC ADD CONSTRAINT VDCONTRORCPK PRIMARY KEY (CODCONTR,CODITCONTR,CODFILIAL,CODEMP,CODORC,CODITORC,TIPOORC,CODFILIALOR,CODEMPOR);

/* Create Foreign Key... */
--CONNECT 'localhost:/opt/firebird/dados/desenv/freedom1.2.6.0.fdb' USER 'SYSDBA' PASSWORD '123654' ROLE 'ADM';

ALTER TABLE FNITPAGAR ADD CONSTRAINT FNITPAGARFKCONTRAT FOREIGN KEY (CODCONTR,CODITCONTR,CODFILIALCT,CODEMPCT) REFERENCES VDITCONTRATO(CODCONTR,CODITCONTR,CODFILIAL,CODEMP);

ALTER TABLE FNITRECEBER ADD CONSTRAINT FNITRECEBERFKCONTR FOREIGN KEY (CODCONTR,CODITCONTR,CODFILIALCT,CODEMPCT) REFERENCES VDITCONTRATO(CODCONTR,CODITCONTR,CODFILIAL,CODEMP);

ALTER TABLE SGPREFERE3 ADD CONSTRAINT SGPREFERE3ATMODOR FOREIGN KEY (CODMODELOR,CODFILIALOR,CODEMPOR) REFERENCES ATMODATENDO(CODMODEL,CODFILIAL,CODEMP);

ALTER TABLE VDCONTRORC ADD CONSTRAINT VDCONTRORCFKVDITCO FOREIGN KEY (CODCONTR,CODITCONTR,CODFILIAL,CODEMP) REFERENCES VDITCONTRATO(CODCONTR,CODITCONTR,CODFILIAL,CODEMP) ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE VDCONTRORC ADD CONSTRAINT VDCONTRORCFKVDITOR FOREIGN KEY (CODORC,CODITORC,TIPOORC,CODFILIALOR,CODEMPOR) REFERENCES VDITORCAMENTO(CODORC,CODITORC,TIPOORC,CODFILIAL,CODEMP);

/*  Empty EQMOVPRODISP for EQMOVPRODCSLDSP(param list change)  */
/* AssignEmptyBody proc */
SET TERM ^ ;

ALTER PROCEDURE EQMOVPRODISP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD SMALLINT,
ESTOQTIPOMOVPD CHAR(1))
 AS
 BEGIN EXIT; END
^

/*  Empty EQMOVPRODPRCSLDSP for EQMOVPRODCSLDSP(param list change)  */
/* AssignEmptyBody proc */
ALTER PROCEDURE EQMOVPRODPRCSLDSP(SCODFILIAL SMALLINT,
ICODMOVPROD INTEGER,
ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
DDTMOVPROD DATE,
DDTMOVPRODPRC DATE,
NSLDMOVPROD NUMERIC(15,5),
NCUSTOMPMMOVPROD NUMERIC(15,5),
NSLDMOVPRODAX NUMERIC(15,5),
NCUSTOMPMMOVPRODAX NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1))
 RETURNS(NSLDPRC NUMERIC(15,5),
NCUSTOMPMPRC NUMERIC(15,5),
NSLDPRCAX NUMERIC(15,5),
NCUSTOMPMPRCAX NUMERIC(15,5),
ESTOQTIPOMOVPD CHAR(1))
 AS
 BEGIN EXIT; END
^

/*  Empty EQMOVPRODUSP for EQMOVPRODCSLDSP(param list change)  */
/* AssignEmptyBody proc */
ALTER PROCEDURE EQMOVPRODUSP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD BIGINT,
ESTOQTIPOMOVPD CHAR(1))
 AS
 BEGIN EXIT; END
^

/*  Empty EQMOVPRODIUDSP for EQMOVPRODDSP(param list change)  */
/* AssignEmptyBody proc */
ALTER PROCEDURE EQMOVPRODIUDSP(CIUD CHAR(1),
ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
SEQSUBPROD SMALLINT,
ESTOQTIPOMOVPD CHAR(1))
 AS
 BEGIN EXIT; END
^

ALTER TRIGGER CPITCOMPRATGAI
 AS Declare variable I integer;
BEGIN I = 0; END
^

ALTER TRIGGER CPITCOMPRATGAU
 AS Declare variable I integer;
BEGIN I = 0; END
^

ALTER TRIGGER CPITCOMPRATGAD
 AS Declare variable I integer;
BEGIN I = 0; END
^

ALTER TRIGGER EQINVPRODTGAI
 AS Declare variable I integer;
BEGIN I = 0; END
^

ALTER TRIGGER EQINVPRODTGAU
 AS Declare variable I integer;
BEGIN I = 0; END
^

ALTER TRIGGER EQINVPRODTGAD
 AS Declare variable I integer;
BEGIN I = 0; END
^

ALTER TRIGGER EQITRMATGAI
 AS Declare variable I integer;
BEGIN I = 0; END
^

ALTER TRIGGER EQITRMATGAU
 AS Declare variable I integer;
BEGIN I = 0; END
^

ALTER TRIGGER EQITRMATGAD
 AS Declare variable I integer;
BEGIN I = 0; END
^

ALTER TRIGGER PPOPTGAI
 AS Declare variable I integer;
BEGIN I = 0; END
^

ALTER TRIGGER PPOPTGAU
 AS Declare variable I integer;
BEGIN I = 0; END
^

ALTER TRIGGER PPOPTGAD
 AS Declare variable I integer;
BEGIN I = 0; END
^

ALTER TRIGGER PPOPENTRADATGAI
 AS Declare variable I integer;
BEGIN I = 0; END
^

ALTER TRIGGER PPOPENTRADATGAD
 AS Declare variable I integer;
BEGIN I = 0; END
^

ALTER TRIGGER PPOPSUBPRODTGAI
 AS Declare variable I integer;
BEGIN I = 0; END
^

ALTER TRIGGER PPOPSUBPRODTGAU
 AS Declare variable I integer;
BEGIN I = 0; END
^

ALTER TRIGGER PPOPSUBPRODTGAD
 AS Declare variable I integer;
BEGIN I = 0; END
^

ALTER TRIGGER VDITVENDATGAI
 AS Declare variable I integer;
BEGIN I = 0; END
^

ALTER TRIGGER VDITVENDATGAU
 AS Declare variable I integer;
BEGIN I = 0; END
^

ALTER TRIGGER VDITVENDATGAD
 AS Declare variable I integer;
BEGIN I = 0; END
^

/*  Empty EQMOVPRODDSP for EQMOVPRODPRCSLDSP(param list change)  */
/* AssignEmptyBody proc */
ALTER PROCEDURE EQMOVPRODDSP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
DDTMOVPROD DATE,
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD SMALLINT)
 AS
 BEGIN EXIT; END
^

ALTER TRIGGER FNITRECEBERTGAU
 AS Declare variable I integer;
BEGIN I = 0; END
^

ALTER TRIGGER FNITPAGARTGBU
 AS Declare variable I integer;
BEGIN I = 0; END
^

/* Alter empty procedure EQMOVPRODCSLDSP with new param-list */
ALTER PROCEDURE EQMOVPRODCSLDSP(ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
NCUSTOMPMMOVPROD NUMERIC(15,5),
NSLDMOVPROD NUMERIC(15,5),
ESTOQTIPOMOVPD CHAR(1),
TIPONF CHAR(1))
 RETURNS(NCUSTOMPM NUMERIC(15,5),
NSALDO NUMERIC(15,5),
CESTOQMOVPROD CHAR(1),
CTIPOMOVPROD CHAR(1),
SOPERADOR SMALLINT)
 AS
 BEGIN EXIT; END
^

/* Alter empty procedure EQMOVPRODDSP with new param-list */
ALTER PROCEDURE EQMOVPRODDSP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
DDTMOVPROD DATE,
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD SMALLINT,
TIPONF CHAR(1))
 AS
 BEGIN EXIT; END
^

/* Alter empty procedure EQMOVPRODISP with new param-list */
ALTER PROCEDURE EQMOVPRODISP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD SMALLINT,
ESTOQTIPOMOVPD CHAR(1),
TIPONF CHAR(1))
 AS
 BEGIN EXIT; END
^

SET TERM ; ^

Update Rdb$Procedure_Parameters set Rdb$Description =
'Sequencial do subproduto'
where Rdb$Procedure_Name='EQMOVPRODISP' and Rdb$Parameter_Name='SEQSUBPROD';

/* Alter empty procedure EQMOVPRODPRCSLDSP with new param-list */
SET TERM ^ ;

ALTER PROCEDURE EQMOVPRODPRCSLDSP(SCODFILIAL SMALLINT,
ICODMOVPROD INTEGER,
ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
DDTMOVPROD DATE,
DDTMOVPRODPRC DATE,
NSLDMOVPROD NUMERIC(15,5),
NCUSTOMPMMOVPROD NUMERIC(15,5),
NSLDMOVPRODAX NUMERIC(15,5),
NCUSTOMPMMOVPRODAX NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
TIPONF CHAR(1))
 RETURNS(NSLDPRC NUMERIC(15,5),
NCUSTOMPMPRC NUMERIC(15,5),
NSLDPRCAX NUMERIC(15,5),
NCUSTOMPMPRCAX NUMERIC(15,5),
ESTOQTIPOMOVPD CHAR(1))
 AS
 BEGIN EXIT; END
^

/* Alter empty procedure EQMOVPRODUSP with new param-list */
ALTER PROCEDURE EQMOVPRODUSP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD BIGINT,
ESTOQTIPOMOVPD CHAR(1),
TIPONF CHAR(1))
 AS
 BEGIN EXIT; END
^

/* Alter Procedure... */
/* Alter (ATATENDIMENTOIUSP) */
ALTER PROCEDURE ATATENDIMENTOIUSP(IU CHAR(1),
CODEMP INTEGER,
CODFILIAL SMALLINT,
CODATENDO INTEGER,
CODEMPTO INTEGER,
CODFILIALTO SMALLINT,
CODTPATENDO INTEGER,
CODEMPAE INTEGER,
CODFILIALAE SMALLINT,
CODATEND INTEGER,
CODEMPSA INTEGER,
CODFILIALSA SMALLINT,
CODSETOR INTEGER,
DOCATENDO INTEGER,
DATAATENDO DATE,
DATAATENDOFIN DATE,
HORAATENDO TIME,
HORAATENDOFIN TIME,
OBSATENDO VARCHAR(10000),
CODEMPCL INTEGER,
CODFILIALCL SMALLINT,
CODCLI INTEGER,
CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
CODCONTR INTEGER,
CODITCONTR SMALLINT,
CODEMPIR INTEGER,
CODFILIALIR SMALLINT,
CODREC INTEGER,
NPARCITREC INTEGER,
CODEMPCH INTEGER,
CODFILIALCH SMALLINT,
CODCHAMADO INTEGER,
OBSINTERNO VARCHAR(10000),
CONCLUICHAMADO CHAR(1),
CODEMPEA INTEGER,
CODFILIALEA SMALLINT,
CODESPEC INTEGER,
CODEMPUS INTEGER,
CODFILIALUS SMALLINT,
IDUSU VARCHAR(128),
STATUSATENDO CHAR(2),
CODEMPTA INTEGER,
CODFILIALTA SMALLINT,
CODTAREFA INTEGER,
CODEMPOC INTEGER,
CODFILIALOC INTEGER,
TIPOORC CHAR(1),
CODORC INTEGER)
 AS
declare variable horaatendors time;
declare variable horaatendofinrs time;
declare variable dataatendors date;
declare variable contorc integer;
BEGIN

  DATAATENDORS = NULL;

  SELECT FIRST 1 A.DATAATENDO, A.HORAATENDO, A.HORAATENDOFIN
    FROM ATATENDIMENTO A
    WHERE A.CODEMP=:CODEMP AND A.CODFILIAL=:CODFILIAL AND
        A.CODEMPAE=:CODEMPAE AND A.CODFILIALAE=:CODFILIALAE AND
        A.CODATEND=:CODATEND AND A.CODATENDO<>:CODATENDO AND
        A.DATAATENDO=:DATAATENDO AND ( (A.HORAATENDO BETWEEN :HORAATENDO+1 AND :HORAATENDOFIN-1 )
        OR (A.HORAATENDOFIN BETWEEN :HORAATENDO+1 AND :HORAATENDOFIN-1 ) )
    INTO :DATAATENDORS, :HORAATENDORS, :HORAATENDOFINRS ;

  if (DATAATENDORS IS NOT NULL) then
  begin
     exception atatendimentoex02 'Jah existe(m) lancamento(s) em '||:dataatendors||' - h.: '||
        :horaatendors||' - '||:horaatendofinrs;
  end

  if (IU = 'I') then
  begin
     SELECT ISEQ FROM SPGERANUM(:CODEMP,:CODFILIAL,'AT') INTO :CODATENDO;
     STATUSATENDO = 'AA';
     INSERT INTO ATATENDIMENTO (
        CODEMP,CODFILIAL,CODATENDO,CODEMPTO,
        CODFILIALTO,CODTPATENDO,CODEMPAE,
        CODFILIALAE,CODATEND,CODEMPSA,CODFILIALSA,
        CODSETAT,STATUSATENDO,
        CODEMPUS,CODFILIALUS, IDUSU,
        DOCATENDO, DATAATENDO,
        DATAATENDOFIN, HORAATENDO, HORAATENDOFIN, OBSATENDO, CODEMPCL, CODFILIALCL, CODCLI, CODEMPCT, CODFILIALCT,
        CODCONTR, CODITCONTR, CODEMPCH, CODFILIALCH, CODCHAMADO, obsinterno, CONCLUICHAMADO,
        CODEMPEA, CODFILIALEA, CODESPEC , CODEMPTA, CODFILIALTA, CODTAREFA )

     VALUES (
        :CODEMP, :CODFILIAL, :CODATENDO,
        :CODEMPTO, :CODFILIALTO, :CODTPATENDO,
        :CODEMPAE, :CODFILIALAE,:CODATEND,
        :CODEMPSA,:CODFILIALSA, :CODSETOR,
        :STATUSATENDO ,
        :CODEMPUS, :CODFILIALUS, lower(:IDUSU),
        :DOCATENDO, :DATAATENDO, :DATAATENDOFIN, :HORAATENDO,
        :HORAATENDOFIN, :OBSATENDO,
        :CODEMPCL, :CODFILIALCL, :CODCLI,
        :CODEMPCT, :CODFILIALCT, :CODCONTR, :CODITCONTR,
        :CODEMPCH, :CODFILIALCH, :CODCHAMADO,
        :OBSINTERNO, :CONCLUICHAMADO,
        :CODEMPEA, :CODFILIALEA, :CODESPEC , :CODEMPTA, :CODFILIALTA, :CODTAREFA
     );
  -- Caso o atendimento tenha vinculo com o contas a receber
     if (CODREC IS NOT NULL AND NPARCITREC IS NOT NULL) then
     begin
        INSERT INTO ATATENDIMENTOITREC (CODEMP,CODFILIAL,CODATENDO,CODEMPIR,CODFILIALIR,CODREC,NPARCITREC) VALUES
                (:CODEMP,:CODFILIAL,:CODATENDO,:CODEMPIR,:CODFILIALIR,:CODREC,:NPARCITREC);
     end

       -- Caso o atendimento tenha vinculo com o contas a receber
     if ( CODORC IS NOT NULL AND TIPOORC IS NOT NULL) then
     begin
        INSERT INTO atatendimentoorc (CODEMP,CODFILIAL,CODATENDO,CODEMPOC,CODFILIALOC,TIPOORC,CODORC) VALUES
                (:CODEMP,:CODFILIAL,:CODATENDO,:CODEMPOC,:CODFILIALOC,:TIPOORC,:CODORC);
     end
  end
  else if (IU = 'U') then
  begin
        UPDATE ATATENDIMENTO SET
            CODATEND=:CODATEND, DATAATENDO=:DATAATENDO, HORAATENDO=:HORAATENDO, DATAATENDOFIN=:DATAATENDOFIN,
            HORAATENDOFIN=:HORAATENDOFIN, OBSATENDO=:OBSATENDO,CODEMPTO=:CODEMPTO, CODFILIALTO=:CODFILIALTO,
            CODTPATENDO=:CODTPATENDO,CODEMPSA=:CODEMPSA, CODFILIALSA=:CODFILIALSA, CODSETAT=:CODSETOR, CODEMPCH=:CODEMPCH,
            CODFILIALCH=:CODFILIALCH, CODCHAMADO=:CODCHAMADO, CODEMPCT=:CODEMPCT, CODFILIALCT=:CODFILIALCT,
            CODCONTR=:CODCONTR, CODITCONTR=:CODITCONTR, STATUSATENDO=:STATUSATENDO, OBSINTERNO=:OBSINTERNO,
            CONCLUICHAMADO=:CONCLUICHAMADO, CODEMPEA=:CODEMPEA, CODFILIALEA=:CODFILIALEA, CODESPEC=:CODESPEC,
            CODEMPTA=:CODEMPTA, CODFILIALTA=:CODFILIALTA, CODTAREFA=:CODTAREFA,
            CODEMPCL=:CODEMPCL, CODFILIALCL=:CODFILIALCL, CODCLI=:CODCLI
        WHERE
            CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL AND CODATENDO=:CODATENDO;

        SELECT COUNT(*) FROM ATATENDIMENTOORC WHERE CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL AND CODATENDO=:CODATENDO
        INTO :CONTORC;

        if ( :CONTORC = 0 AND CODORC IS NOT NULL AND TIPOORC IS NOT NULL) then
        begin
           INSERT INTO atatendimentoorc (CODEMP,CODFILIAL,CODATENDO,CODEMPOC,CODFILIALOC,TIPOORC,CODORC) VALUES
                    (:CODEMP,:CODFILIAL,:CODATENDO,:CODEMPOC,:CODFILIALOC,:TIPOORC,:CODORC);
        end
        
  end
END
^

/* empty dependent procedure body */
/* Clear: ATRESUMOATENDOSP02 for: ATRESUMOATENDOSP01 */
/* AssignEmptyBody proc */
ALTER PROCEDURE ATRESUMOATENDOSP02(CODEMPCLP INTEGER,
CODFILIALCLP SMALLINT,
CODCLIP INTEGER,
CODEMPCTP INTEGER,
CODFILIALCTP SMALLINT,
CODCONTRP INTEGER,
CODITCONTRP SMALLINT,
DTINIP DATE,
DTFIMP DATE)
 RETURNS(CODEMPCL INTEGER,
CODFILIALCL SMALLINT,
CODCLI INTEGER,
RAZCLI VARCHAR(60),
CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
CODITCONTR INTEGER,
CODCONTR INTEGER,
DESCCONTR VARCHAR(100),
VLRHORA DECIMAL(15,5),
VLRHORAEXCED DECIMAL(15,5),
QTDCONTR DECIMAL(15,5),
QTDITCONTR DECIMAL(15,5),
VLRCOB DECIMAL(15,5),
VLRCOBEXCED DECIMAL(15,5),
VLRCOBTOT DECIMAL(15,5),
MES SMALLINT,
ANO SMALLINT,
QTDHORAS DECIMAL(15,5),
SALDOMES DECIMAL(15,5),
EXCEDENTEMES DECIMAL(15,5),
EXCEDENTEMESCOB DECIMAL(15,5),
ACUMULO SMALLINT,
CDATAINI DATE)
 AS
 BEGIN EXIT; END
^

/* Alter (ATRESUMOATENDOSP01) */
ALTER PROCEDURE ATRESUMOATENDOSP01(CODEMPP INTEGER,
CODFILIALP SMALLINT,
CODCLIP INTEGER,
CODEMPCTP INTEGER,
CODFILIALCTP SMALLINT,
CODCONTRP INTEGER,
CODITCONTRP SMALLINT,
DTINIP DATE,
DTFIMP DATE)
 RETURNS(ANO SMALLINT,
MES SMALLINT,
CODEMPCL INTEGER,
CODFILIALCL SMALLINT,
CODCLI INTEGER,
CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
CODCONTR INTEGER,
QTDCONTR DECIMAL(15,5),
DTINICIO DATE,
VALOR DECIMAL(15,5),
VALOREXCEDENTE DECIMAL(15,5),
QTDITCONTR DECIMAL(15,5),
QTDHORAS DECIMAL(15,2),
MESCOB INTEGER,
SALDOMESCOB DECIMAL(15,5),
SALDOMES DECIMAL(15,5),
SALDOPERIODO DECIMAL(15,5),
EXCEDENTEMESCOB DECIMAL(15,5),
EXCEDENTEPERIODO DECIMAL(15,5),
EXCEDENTECOB DECIMAL(15,5),
VALOREXCEDENTECOB DECIMAL(15,5),
VALORTOTALCOB DECIMAL(15,5),
VALORCONTR DECIMAL(15,5),
EXCEDENTEMES DECIMAL(15,5),
TOTFRANQUIAMES DECIMAL(15,5))
 AS
begin
  saldoperiodo = 0;
 -- saldoperiodo2 = 0;
  saldomescob = 0;
  excedentemescob = 0;
  excedenteperiodo = 0;
--  excedenteperiodo2 = 0;
  excedentecob = 0;
  valorexcedentecob = 0;
  valortotalcob = 0;
  -- MES COBRANÇA
  mescob = extract(month from :dtfimp);
  -- DATA DO MÊS ANTERIOR A COBRANÇA
  --dtant = addmonth(:dtfimp, -1);
  -- MES ANTERIOR A COBRANÇA
 -- mesant = extract(month from :dtant);


  for select extract(year from a.dataatendo) ano
   , extract( month from a.dataatendo) mes
   , ct.codempcl, ct.codfilialcl, ct.codcli
   , ct.codemp codempct, ct.codfilial codfilialct, ct.codcontr
   , a.qtdcontr, a.dtinicio
    , avg((select avg(ic.vlritcontr) from vditcontrato ic
     where  ic.codemp=ct.codemp and ic.codfilial=ct.codfilial and ic.codcontr=ct.codcontr
     and coalesce(ic.franquiaitcontr,'N')='S' ) )  valor
   , avg((select avg(ic.vlritcontrexced) from vditcontrato ic
     where  ic.codemp=ct.codemp and ic.codfilial=ct.codfilial and ic.codcontr=ct.codcontr
     and coalesce(ic.franquiaitcontr,'N')='S' ) )  valorexcedente
   , avg((select sum(qtditcontr) from vditcontrato ic
     where  ic.codemp=ct.codemp and ic.codfilial=ct.codfilial and ic.codcontr=ct.codcontr
     and coalesce(ic.franquiaitcontr,'N')='S' ) )  qtditcontr
   , cast(sum(a.totalcobcli) as decimal(15,2)) qtdhoras
    from vdcontrato ct
    left outer join atatendimentovw02 a on
    a.codempcl=ct.codempcl and a.codfilialcl=ct.codfilialcl and a.codcli=ct.codcli
    and a.codempct=ct.codemp and a.codfilialct=ct.codfilial and a.codcontr=ct.codcontr
    and ( :coditcontrp=0 or a.coditcontr=:coditcontrp ) 
    and a.dataatendo between :dtinip  and
    :dtfimp and a.mrelcobespec='S'
    where
     ct.codempcl=:codempp and ct.codfilialcl=:codfilialp and ct.codcli=:codclip
    and ct.codemp=:codempctp and ct.codfilial=:codfilialctp  and ct.codcontr=:codcontrp
    and ct.recebcontr='S' and ct.tpcobcontr in ('ME','BI','AN') and ct.ativo='S'
    group by 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
    order by 1 desc, 2 desc

   into :ano, :mes

   , :codempcl, :codfilialcl, :codcli
   , :codempct, :codfilialct, :codcontr, :qtdcontr, :dtinicio, :valor
   , :valorexcedente, :qtditcontr, :qtdhoras
   do
   begin
       /* Caso não existam lançamentos retornar ano e mês atual */
       if (:ano is null) then
          ano = extract(year from dtfimp);

       if (:mes is null) then
           mes = extract(month from dtfimp);

       -- TOTAL DE FRANQUIA NO MES
       totfranquiames = qtditcontr;

       -- SALDO MÊS
       if( :qtditcontr - :qtdhoras   > 0) then
           saldomes =  qtditcontr - qtdhoras;
       else
           saldomes = 0;

       -- VALOR CONTRATADO
       if (mes=mescob) then
          valorcontr = qtditcontr * valor;

       -- EXCEDENTE MES
       if( :qtdhoras < :qtditcontr ) then
          excedentemes = 0;
       else
          excedentemes = qtdhoras - qtditcontr;

       -- EXCEDENTE MES COBRANÇA
       if( (:qtdhoras > :qtditcontr) and (mes = mescob) ) then
          excedentemescob = excedentemes;

       if (mes=mescob) then
       begin
          --- SALDO DO MÊS DE COBRANÇA
          saldomescob = saldomescob + saldomes;
       end
       else
       begin
         -- SALDO DO PERÍODO
         saldoperiodo = saldoperiodo + saldomes;

         -- EXCEDENTE DO PERÍODO
          excedenteperiodo = excedenteperiodo + excedentemes;

       end 

   end

   -- EXCEDENTE COBRADO
   if( :excedenteperiodo - :saldoperiodo > 0) then
       excedentecob =  excedenteperiodo - saldoperiodo;
   else
       excedentecob = 0;

   if (excedentecob>0) then
      saldoperiodo = 0;

   saldoperiodo = saldoperiodo + saldomescob;
   excedentecob = excedentemescob;

   --VLRTOTAL =$V{QTDITCONTRCALC}.multiply($F{VALOR}).add($V{EXCEDENTECOB}.multiply( $V{VALOREXCEDENTE} ))

   -- VALOR A COBRAR EXCEDENTE
   valorexcedentecob = excedentecob * valorexcedente;
        
   -- VALOR TOTAL A COBRAR
   valortotalcob = (valorcontr) + (excedentecob * valorexcedente);

 -- saldoperiodo2 = 0;
  excedentemescob = 0;
  --excedenteperiodo2 = 0;

  for select extract(year from a.dataatendo) ano
   , extract( month from a.dataatendo) mes
   , ct.codempcl, ct.codfilialcl, ct.codcli
   , ct.codemp codempct, ct.codfilial codfilialct, ct.codcontr
   , a.qtdcontr, a.dtinicio
   , cast(sum(a.totalcobcli) as decimal(15,2)) qtdhoras
    from vdcontrato ct
    left outer join atatendimentovw02 a on
    a.codempcl=ct.codempcl and a.codfilialcl=ct.codfilialcl and a.codcli=ct.codcli
    and a.codempct=ct.codemp and a.codfilialct=ct.codfilial and a.codcontr=ct.codcontr
    and ( :coditcontrp=0 or a.coditcontr=:coditcontrp ) 
    and a.dataatendo between :dtinip  and
    :dtfimp and a.mrelcobespec='S'
    where
     ct.codempcl=:codempp and ct.codfilialcl=:codfilialp and ct.codcli=:codclip
    and ct.codemp=:codempctp and ct.codfilial=:codfilialctp  and ct.codcontr=:codcontrp
    and ct.recebcontr='S' and ct.tpcobcontr in ('ME','BI','AN') and ct.ativo='S'
    group by 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
    order by 1 desc, 2 desc

   into :ano, :mes
   , :codempcl, :codfilialcl, :codcli
   , :codempct, :codfilialct, :codcontr
   , :qtdcontr, :dtinicio, :qtdhoras
   do
   begin
       /* Caso não existam lançamentos retornar ano e mês atual */
       if (:ano is null) then
          ano = extract(year from dtfimp);

       if (:mes is null) then
           mes = extract(month from dtfimp);

       -- TOTAL DE FRANQUIA NO MES
       totfranquiames = qtditcontr;

       -- SALDO MÊS
       if( :qtditcontr - :qtdhoras   > 0) then
           saldomes =  qtditcontr - qtdhoras;
       else
           saldomes = 0;

       -- VALOR CONTRATADO
       valorcontr = qtditcontr * valor;

       -- EXCEDENTE MES
       if( :qtdhoras < :qtditcontr ) then
          excedentemes = 0;
       else
          excedentemes = qtdhoras - qtditcontr;

       -- EXCEDENTE MES COBRANÇA
       if( (:qtdhoras < :qtditcontr)
       --or (mes <> mescob)
       ) then
          excedentemescob = 0;
       else
          excedentemescob = qtdhoras - qtditcontr;

       -- SALDO DO PERÍODO
--       saldoperiodo2 = saldoperiodo2 + saldomes;

       -- EXCEDENTE DO PERÍODO
  --     excedenteperiodo2 = excedenteperiodo2 + excedentemescob;

       --VLRTOTAL =$V{QTDITCONTRCALC}.multiply($F{VALOR}).add($V{EXCEDENTECOB}.multiply( $V{VALOREXCEDENTE} ))

       -- VALOR A COBRAR EXCEDENTE
--       valorexcedentecob = excedentecob * valorexcedente;
        
       -- VALOR TOTAL A COBRAR
--       valortotalcob = (qtditcontr * valor) + (excedentecob * valorexcedente);

      suspend;
   end


end
^

/* Alter (ATRESUMOATENDOSP02) */
ALTER PROCEDURE ATRESUMOATENDOSP02(CODEMPCLP INTEGER,
CODFILIALCLP SMALLINT,
CODCLIP INTEGER,
CODEMPCTP INTEGER,
CODFILIALCTP SMALLINT,
CODCONTRP INTEGER,
CODITCONTRP SMALLINT,
DTINIP DATE,
DTFIMP DATE)
 RETURNS(CODEMPCL INTEGER,
CODFILIALCL SMALLINT,
CODCLI INTEGER,
RAZCLI VARCHAR(60),
CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
CODITCONTR INTEGER,
CODCONTR INTEGER,
DESCCONTR VARCHAR(100),
VLRHORA DECIMAL(15,5),
VLRHORAEXCED DECIMAL(15,5),
QTDCONTR DECIMAL(15,5),
QTDITCONTR DECIMAL(15,5),
VLRCOB DECIMAL(15,5),
VLRCOBEXCED DECIMAL(15,5),
VLRCOBTOT DECIMAL(15,5),
MES SMALLINT,
ANO SMALLINT,
QTDHORAS DECIMAL(15,5),
SALDOMES DECIMAL(15,5),
EXCEDENTEMES DECIMAL(15,5),
EXCEDENTEMESCOB DECIMAL(15,5),
ACUMULO SMALLINT,
CDATAINI DATE)
 AS
declare variable dtiniac date;
begin
  for select cl.codemp codempcl, cl.codfilial codfilialcl, cl.codcli, cl.razcli
    , ct.codemp codempct, ct.codfilial codfilialct, ct.codcontr, ct.desccontr, ct.dtinicio
    from vdcliente cl, vdcontrato ct
    where cl.codemp=:codempclp and cl.codfilial=:codfilialclp and (:codclip=0 or cl.codcli=:codclip)
       and ct.codemp=:codempctp and ct.codfilial=:codfilialctp and (:codcontrp=0 or ct.codcontr=:codcontrp)
       and ct.codempcl=cl.codemp and ct.codfilialcl=cl.codfilial and ct.codcli=cl.codcli
       and ct.ativo='S' and ct.tpcobcontr in ('ME','BI','AN') and ct.recebcontr='S'
     order by cl.razcli,  cl.codcli,  ct.codcontr
  into :codempcl, :codfilialcl, :codcli, :razcli
    , :codempct, :codfilialct, :codcontr, :desccontr, :cdataini
  do
  begin


--       and i.codemp=ct.codemp  and i.codfilial=ct.codfilial and i.codcontr=ct.codcontr and (:coditcontrp=0 or i.coditcontr=:coditcontrp)

  --vditcontrato i,

      select max(i.acumuloitcontr) from vditcontrato i
      where i.codemp=:codempct  and i.codfilial=:codfilialct and i.codcontr=:codcontr and (:coditcontrp=0 or i.coditcontr=:coditcontr)
      and i.acumuloitcontr is not null
      into :acumulo;
      if ( (:acumulo is null) or (:acumulo=0) ) then
      begin
        acumulo = 0;
        dtiniac = dtinip;
      end
      else
      begin
        dtiniac = dtinip;
        dtiniac = cast( addmonth(dtiniac, -1*acumulo) as date);
        if( dtiniac > dtinip ) then
         dtiniac = dtinip;
      end
      for select a.mes, a.ano, a.qtdcontr, a.valor, a.valorexcedente, a.qtditcontr, a.qtdhoras, a.valortotalcob
       , a.saldomes, a.excedentemes, a.excedentemescob, a.valorexcedentecob , a.valorcontr
         from atresumoatendosp01(:codempcl, :codfilialcl, :codcli
         , :codempct, :codfilialct, :codcontr, :coditcontrp, :dtiniac, :dtfimp) a
      into :mes, :ano, :qtdcontr, :vlrhora, :vlrhoraexced, :qtditcontr, :qtdhoras, :vlrcobtot
      , :saldomes, :excedentemes, :excedentemescob, :vlrcobexced, :vlrcob
      do
      begin
        
      suspend;
      end
  end
end
^

/* Alter (EQMOVPRODCSLDSP) */
ALTER PROCEDURE EQMOVPRODCSLDSP(ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
NCUSTOMPMMOVPROD NUMERIC(15,5),
NSLDMOVPROD NUMERIC(15,5),
ESTOQTIPOMOVPD CHAR(1),
TIPONF CHAR(1))
 RETURNS(NCUSTOMPM NUMERIC(15,5),
NSALDO NUMERIC(15,5),
CESTOQMOVPROD CHAR(1),
CTIPOMOVPROD CHAR(1),
SOPERADOR SMALLINT)
 AS
begin
  /* Procedure que retorna o cálculo de custo e saldo */
  NCUSTOMPM = 0;
  NSALDO = 0;
  SELECT CESTIPOMOV, SOPERADOR
     FROM EQMOVPRODCKTMSP( :ICODEMPTM, :SCODFILIALTM, :ICODTIPOMOV, :ESTOQTIPOMOVPD)
     INTO :CTIPOMOVPROD, :SOPERADOR;
  if (SOPERADOR=0) then
  begin
     CESTOQMOVPROD = 'N';
     NSALDO = NSLDMOVPROD;
  end
  else
  begin  /* verifica se é para controlar estoque */
     CESTOQMOVPROD = 'S';
     NSALDO = NSLDMOVPROD + CAST ( (NQTDMOVPROD * SOPERADOR) AS NUMERIC(15, 5) );
  end
  if ( (NSALDO >= NSLDMOVPROD) AND (NSALDO > 0) AND (SOPERADOR>0 OR CTIPOMOVPROD='E') ) then
  begin
    if ( (NSLDMOVPROD * NCUSTOMPMMOVPROD)  <= 0) then
       NCUSTOMPM = NPRECOMOVPROD;
    else
    begin
       if (tiponf='C') then
          NCUSTOMPM = cast(NPRECOMOVPROD * NQTDMOVPROD / NSLDMOVPROD as numeric(15,5) ) + NCUSTOMPMMOVPROD   ;
       else
          NCUSTOMPM = ( cast(NSLDMOVPROD * NCUSTOMPMMOVPROD as numeric(15,5) ) +
          cast(NQTDMOVPROD * NPRECOMOVPROD as numeric(15,5)) ) / (NSLDMOVPROD + NQTDMOVPROD) ;
    end
  end
  else
      NCUSTOMPM = NCUSTOMPMMOVPROD;

  suspend;
end
^

ALTER PROCEDURE EQMOVPRODPRCSLDSP(SCODFILIAL SMALLINT,
ICODMOVPROD INTEGER,
ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
DDTMOVPROD DATE,
DDTMOVPRODPRC DATE,
NSLDMOVPROD NUMERIC(15,5),
NCUSTOMPMMOVPROD NUMERIC(15,5),
NSLDMOVPRODAX NUMERIC(15,5),
NCUSTOMPMMOVPRODAX NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
TIPONF CHAR(1))
 RETURNS(NSLDPRC NUMERIC(15,5),
NCUSTOMPMPRC NUMERIC(15,5),
NSLDPRCAX NUMERIC(15,5),
NCUSTOMPMPRCAX NUMERIC(15,5),
ESTOQTIPOMOVPD CHAR(1))
 AS
declare variable icodemptm integer;
declare variable scodfilialtm smallint;
declare variable icodtipomov integer;
declare variable nqtdmovprod numeric(15,5);
declare variable nprecomovprod numeric(15,5);
declare variable icodmovprodprc integer;
declare variable cestoqmovprod char(1);
declare variable icodempaxprc integer;
declare variable scodfilialaxprc smallint;
declare variable icodalmoxprc integer;
begin
  /* Procedure de processamento de estoque */
  FOR SELECT MP.CODEMPTM, MP.CODFILIALTM, MP.CODTIPOMOV ,
    MP.QTDMOVPROD, MP.PRECOMOVPROD , MP.CODMOVPROD,
    MP.CODEMPAX, MP.CODFILIALAX, MP.CODALMOX, MP.ESTOQMOVPROD
    FROM EQMOVPROD MP
    WHERE MP.CODEMPPD=:ICODEMPPD AND MP.CODFILIALPD=:SCODFILIALPD AND
       MP.CODPROD=:ICODPROD AND MP.CODEMP=:ICODEMPPD AND MP.CODFILIAL=:SCODFILIAL AND
       ( (MP.DTMOVPROD = :DDTMOVPROD AND MP.CODMOVPROD > :ICODMOVPROD) OR
         (MP.DTMOVPROD>:DDTMOVPROD) ) AND  /* ALTEREI AQUI */
       ( (:DDTMOVPRODPRC IS NULL /* AND MP.CODMOVPROD!=:ICODMOVPROD */) OR
         (MP.DTMOVPROD = :DDTMOVPRODPRC AND MP.CODMOVPROD < :ICODMOVPROD) OR
         (MP.DTMOVPROD < :DDTMOVPRODPRC) )
    ORDER BY MP.DTMOVPROD, MP.CODMOVPROD
    INTO :ICODEMPTM, :SCODFILIALTM, :ICODTIPOMOV,
     :NQTDMOVPROD, :NPRECOMOVPROD, :ICODMOVPRODPRC,
     :ICODEMPAXPRC, :SCODFILIALAXPRC, :ICODALMOXPRC, :ESTOQTIPOMOVPD DO
  BEGIN
      SELECT NSALDO, NCUSTOMPM, CESTOQMOVPROD FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
        :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPROD, :ESTOQTIPOMOVPD, :TIPONF)
      INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :CESTOQMOVPROD;
      if (CMULTIALMOX='N') then /* Se não for multi almoxarifado*/
      begin
         NSLDMOVPRODAX = NSLDMOVPROD;
         NCUSTOMPMMOVPRODAX = NCUSTOMPMMOVPROD;
         UPDATE EQMOVPROD SET SLDMOVPROD=:NSLDMOVPROD, CUSTOMPMMOVPROD=:NCUSTOMPMMOVPROD,
            SLDMOVPRODAX=:NSLDMOVPRODAX, CUSTOMPMMOVPRODAX=:NCUSTOMPMMOVPRODAX,
            ESTOQMOVPROD=:CESTOQMOVPROD
            WHERE CODEMP=:ICODEMPPD AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPRODPRC;
      end
      else if (ICODEMPAX=ICODEMPAXPRC AND SCODFILIALAX=SCODFILIALAXPRC AND
          ICODALMOX=ICODALMOXPRC) then
          /* Se for multi almoxarifado e o código do almoxarifado for o mesmo*/
      begin
        SELECT NSALDO, NCUSTOMPM FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
            :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPRODAX, :NSLDMOVPRODAX, :ESTOQTIPOMOVPD, :TIPONF)
            INTO :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX;
        UPDATE EQMOVPROD SET SLDMOVPROD=:NSLDMOVPROD, CUSTOMPMMOVPROD=:NCUSTOMPMMOVPROD,
            SLDMOVPRODAX=:NSLDMOVPRODAX, CUSTOMPMMOVPRODAX=:NCUSTOMPMMOVPRODAX,
            ESTOQMOVPROD=:CESTOQMOVPROD
            WHERE CODEMP=:ICODEMPPD AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPRODPRC;
      end
      else /* Se for multi almoxarifado não atualiza almoxarifado diferente */
      begin
        UPDATE EQMOVPROD SET SLDMOVPROD=:NSLDMOVPROD, CUSTOMPMMOVPROD=:NCUSTOMPMMOVPROD,
            ESTOQMOVPROD=:CESTOQMOVPROD
            WHERE CODEMP=:ICODEMPPD AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPRODPRC;
      end
      NSLDPRC = NSLDMOVPROD;
      NCUSTOMPMPRC = NCUSTOMPMMOVPROD;
      NSLDPRCAX = NSLDMOVPRODAX;
      NCUSTOMPMPRCAX = NCUSTOMPMMOVPRODAX;
  END
  suspend;
end
^

/* Alter (EQMOVPRODDSP) */
ALTER PROCEDURE EQMOVPRODDSP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
DDTMOVPROD DATE,
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD SMALLINT,
TIPONF CHAR(1))
 AS
declare variable icodemp integer;
declare variable scodfilial smallint;
declare variable icodmovprod integer;
declare variable nsldmovprod numeric(15,5);
declare variable ncustompmmovprod numeric(15,5);
declare variable nsldmovprodax numeric(15,5);
declare variable ncustompmmovprodax numeric(15,5);
begin
  /* Procedure de deleção da tabela eqmovprod */
  SELECT ICODEMP, SCODFILIAL, ICODMOVPROD
  FROM EQMOVPRODRETCODSP(:ICODEMPIV, :SCODFILIALIV, :ICODINVPROD, :ICODEMPCP,
    :SCODFILIALCP, :ICODCOMPRA, :SCODITCOMPRA, :ICODEMPVD, :SCODFILIALVD,
    :CTIPOVENDA, :ICODVENDA, :SCODITVENDA, :ICODEMPRM, :SCODFILIALRM, :ICODRMA,
    :SCODITRMA, :ICODEMPOP,  :SCODFILIALOP,  :ICODOP, :SSEQOP, :sseqentop, :seqsubprod)
    INTO :ICODEMP, :SCODFILIAL, :ICODMOVPROD;

  SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX
  FROM EQMOVPRODSLDSP(:ICODEMP, :SCODFILIAL, :ICODMOVPROD,
   :ICODEMPPD, :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, 0, 0,
   :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
     INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX  ;

  /* DELETAR EQMOVPROD */
  DELETE FROM EQMOVPROD WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL
    AND CODMOVPROD=:ICODMOVPROD;

  /* REPROCESSAR ESTOQUE */
  SELECT NSLDPRC, NCUSTOMPMPRC, NSLDPRCAX, NCUSTOMPMPRCAX
    FROM EQMOVPRODPRCSLDSP( :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
      :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, null, :NSLDMOVPROD, :NCUSTOMPMMOVPROD,
      :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX,
      :CMULTIALMOX, :TIPONF)
    INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX;

  /* ATUALIZA CUSTO NO CADASTRO DE PRODUTOS
   OPERADOR 1 PARA EFETUAR A ATUALIZAÇÃO SEMPRE
  EXECUTE PROCEDURE EQMOVPRODATCUSTSP( 1, :ICODEMP, :SCODFILIAL,
   :ICODMOVPROD,  :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, 0);
   */

  suspend;
end
^

ALTER PROCEDURE EQMOVPRODCSLDSP(ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
NCUSTOMPMMOVPROD NUMERIC(15,5),
NSLDMOVPROD NUMERIC(15,5),
ESTOQTIPOMOVPD CHAR(1),
TIPONF CHAR(1))
 RETURNS(NCUSTOMPM NUMERIC(15,5),
NSALDO NUMERIC(15,5),
CESTOQMOVPROD CHAR(1),
CTIPOMOVPROD CHAR(1),
SOPERADOR SMALLINT)
 AS
begin
  /* Procedure que retorna o cálculo de custo e saldo */
  NCUSTOMPM = 0;
  NSALDO = 0;
  SELECT CESTIPOMOV, SOPERADOR
     FROM EQMOVPRODCKTMSP( :ICODEMPTM, :SCODFILIALTM, :ICODTIPOMOV, :ESTOQTIPOMOVPD)
     INTO :CTIPOMOVPROD, :SOPERADOR;
  if (SOPERADOR=0) then
  begin
     CESTOQMOVPROD = 'N';
     NSALDO = NSLDMOVPROD;
  end
  else
  begin  /* verifica se é para controlar estoque */
     CESTOQMOVPROD = 'S';
     NSALDO = NSLDMOVPROD + CAST ( (NQTDMOVPROD * SOPERADOR) AS NUMERIC(15, 5) );
  end
  if ( (NSALDO >= NSLDMOVPROD) AND (NSALDO > 0) AND (SOPERADOR>0 OR CTIPOMOVPROD='E') ) then
  begin
    if ( (NSLDMOVPROD * NCUSTOMPMMOVPROD)  <= 0) then
       NCUSTOMPM = NPRECOMOVPROD;
    else
    begin
       if (tiponf='C') then
          NCUSTOMPM = cast(NPRECOMOVPROD * NQTDMOVPROD / NSLDMOVPROD as numeric(15,5) ) + NCUSTOMPMMOVPROD   ;
       else
          NCUSTOMPM = ( cast(NSLDMOVPROD * NCUSTOMPMMOVPROD as numeric(15,5) ) +
          cast(NQTDMOVPROD * NPRECOMOVPROD as numeric(15,5)) ) / (NSLDMOVPROD + NQTDMOVPROD) ;
    end
  end
  else
      NCUSTOMPM = NCUSTOMPMMOVPROD;

  suspend;
end
^

/* Alter (EQMOVPRODISP) */
ALTER PROCEDURE EQMOVPRODISP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD SMALLINT,
ESTOQTIPOMOVPD CHAR(1),
TIPONF CHAR(1))
 AS
declare variable scodfilial smallint;
declare variable icodmovprod integer;
declare variable cestoqmovprod char(1);
declare variable ctipomovprod char(1);
declare variable nsldmovprod numeric(15,5);
declare variable ncustompmmovprod numeric(15,5);
declare variable soperador smallint;
declare variable nsldmovprodax numeric(15,5);
declare variable ncustompmmovprodax numeric(15,5);
begin
  /* Procedure de inserção na tabela eqmovprod */

  SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX FROM EQMOVPRODSLDSP(null, null, null, :ICODEMPPD,
     :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, :NPRECOMOVPROD, :NPRECOMOVPROD,
     :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX )
     INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX ;

  /* Verifica se haverá mudança de saldo*/
  SELECT NSALDO, NCUSTOMPM, CESTOQMOVPROD, CTIPOMOVPROD, SOPERADOR FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
      :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPROD, :ESTOQTIPOMOVPD, :TIPONF)
      INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :CESTOQMOVPROD, :CTIPOMOVPROD, :SOPERADOR;

  if (CMULTIALMOX='N') then
  begin
     NSLDMOVPRODAX = NSLDMOVPROD;
     NCUSTOMPMMOVPRODAX = NCUSTOMPMMOVPROD;
  end
  else
  begin
      SELECT NSALDO, NCUSTOMPM FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
          :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPRODAX, :NSLDMOVPRODAX, :ESTOQTIPOMOVPD, :TIPONF)
        INTO :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX;
  end

  SELECT SCODFILIAL, ICODMOVPROD FROM EQMOVPRODSEQSP(:ICODEMPPD)
     INTO :SCODFILIAL, :ICODMOVPROD;  /* encontra o próximo código e a filial*/

   INSERT INTO EQMOVPROD ( CODEMP, CODFILIAL, CODMOVPROD,
      CODEMPPD, CODFILIALPD , CODPROD , CODEMPLE ,
      CODFILIALLE , CODLOTE , CODEMPTM, CODFILIALTM,
      CODTIPOMOV, CODEMPIV , CODFILIALIV , CODINVPROD ,
      CODEMPCP , CODFILIALCP , CODCOMPRA , CODITCOMPRA , CODEMPVD ,
      CODFILIALVD , TIPOVENDA , CODVENDA , CODITVENDA , CODEMPRM ,
      CODFILIALRM , CODRMA , CODITRMA ,
      CODEMPOP, CODFILIALOP, CODOP, SEQOP, SEQENTOP,
      CODEMPNT , CODFILIALNT ,
      CODNAT , DTMOVPROD , DOCMOVPROD , FLAG , QTDMOVPROD ,
      PRECOMOVPROD, ESTOQMOVPROD, TIPOMOVPROD, SLDMOVPROD, CUSTOMPMMOVPROD,
      SLDMOVPRODAX, CUSTOMPMMOVPRODAX, CODEMPAX, CODFILIALAX, CODALMOX, seqsubprod )
   VALUES ( :ICODEMPPD, :SCODFILIAL, :ICODMOVPROD,
    :ICODEMPPD , :SCODFILIALPD , :ICODPROD , :ICODEMPLE ,
    :SCODFILIALLE , :CCODLOTE , :ICODEMPTM, :SCODFILIALTM,
    :ICODTIPOMOV, :ICODEMPIV , :SCODFILIALIV ,
    :ICODINVPROD , :ICODEMPCP , :SCODFILIALCP , :ICODCOMPRA ,
    :SCODITCOMPRA , :ICODEMPVD , :SCODFILIALVD , :CTIPOVENDA ,
    :ICODVENDA , :SCODITVENDA , :ICODEMPRM , :SCODFILIALRM ,
    :ICODRMA , :SCODITRMA , :ICODEMPOP, :SCODFILIALOP, :ICODOP, :SSEQOP, :sseqentop,
    :ICODEMPNT , :SCODFILIALNT , :CCODNAT ,
    :DDTMOVPROD , :IDOCMOVPROD , :CFLAG , :NQTDMOVPROD ,
    :NPRECOMOVPROD, :CESTOQMOVPROD, :CTIPOMOVPROD, :NSLDMOVPROD, :NCUSTOMPMMOVPROD,
    :NSLDMOVPRODAX,  :NCUSTOMPMMOVPRODAX, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :seqsubprod );

  /* REPROCESSAR ESTOQUE */

  SELECT NSLDPRC, NCUSTOMPMPRC, NSLDPRCAX, NCUSTOMPMPRCAX
    FROM EQMOVPRODPRCSLDSP( :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
     :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, null, :NSLDMOVPROD, :NCUSTOMPMMOVPROD,
     :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX,
     :CMULTIALMOX, :TIPONF)
    INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX ;

 /* ATUALIZA O CUSTO NO CADASTRO DE PRODUTOS
   EXECUTE PROCEDURE EQMOVPRODATCUSTSP(:SOPERADOR, :ICODEMPPD, :SCODFILIAL,
    :ICODMOVPROD, :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, :NCUSTOMPMMOVPROD); 
 */


  suspend;
end
^

SET TERM ; ^

Update Rdb$Procedure_Parameters set Rdb$Description =
'Sequencial do subproduto'
where Rdb$Procedure_Name='EQMOVPRODISP' and Rdb$Parameter_Name='SEQSUBPROD';

SET TERM ^ ;

ALTER PROCEDURE EQMOVPRODDSP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
DDTMOVPROD DATE,
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD SMALLINT,
TIPONF CHAR(1))
 AS
declare variable icodemp integer;
declare variable scodfilial smallint;
declare variable icodmovprod integer;
declare variable nsldmovprod numeric(15,5);
declare variable ncustompmmovprod numeric(15,5);
declare variable nsldmovprodax numeric(15,5);
declare variable ncustompmmovprodax numeric(15,5);
begin
  /* Procedure de deleção da tabela eqmovprod */
  SELECT ICODEMP, SCODFILIAL, ICODMOVPROD
  FROM EQMOVPRODRETCODSP(:ICODEMPIV, :SCODFILIALIV, :ICODINVPROD, :ICODEMPCP,
    :SCODFILIALCP, :ICODCOMPRA, :SCODITCOMPRA, :ICODEMPVD, :SCODFILIALVD,
    :CTIPOVENDA, :ICODVENDA, :SCODITVENDA, :ICODEMPRM, :SCODFILIALRM, :ICODRMA,
    :SCODITRMA, :ICODEMPOP,  :SCODFILIALOP,  :ICODOP, :SSEQOP, :sseqentop, :seqsubprod)
    INTO :ICODEMP, :SCODFILIAL, :ICODMOVPROD;

  SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX
  FROM EQMOVPRODSLDSP(:ICODEMP, :SCODFILIAL, :ICODMOVPROD,
   :ICODEMPPD, :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, 0, 0,
   :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
     INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX  ;

  /* DELETAR EQMOVPROD */
  DELETE FROM EQMOVPROD WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL
    AND CODMOVPROD=:ICODMOVPROD;

  /* REPROCESSAR ESTOQUE */
  SELECT NSLDPRC, NCUSTOMPMPRC, NSLDPRCAX, NCUSTOMPMPRCAX
    FROM EQMOVPRODPRCSLDSP( :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
      :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, null, :NSLDMOVPROD, :NCUSTOMPMMOVPROD,
      :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX,
      :CMULTIALMOX, :TIPONF)
    INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX;

  /* ATUALIZA CUSTO NO CADASTRO DE PRODUTOS
   OPERADOR 1 PARA EFETUAR A ATUALIZAÇÃO SEMPRE
  EXECUTE PROCEDURE EQMOVPRODATCUSTSP( 1, :ICODEMP, :SCODFILIAL,
   :ICODMOVPROD,  :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, 0);
   */

  suspend;
end
^

ALTER PROCEDURE EQMOVPRODUSP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD BIGINT,
ESTOQTIPOMOVPD CHAR(1),
TIPONF CHAR(1))
 AS
declare variable icodemp integer;
declare variable scodfilial smallint;
declare variable icodmovprod integer;
declare variable nsldprc numeric(15,5);
declare variable ncustompmprc numeric(15,5);
declare variable nsldprcax numeric(15,5);
declare variable ncustompmprcax numeric(15,5);
declare variable nsldlc numeric(15,5);
declare variable ncustompmlc numeric(15,5);
declare variable nsldlcax numeric(15,5);
declare variable ncustompmlcax numeric(15,5);
declare variable ddtmovprodold date;
declare variable nprecomovprodold numeric(15,5);
declare variable nqtdmovprodold numeric(15,5);
declare variable icodemptmold integer;
declare variable scodfilialtmold smallint;
declare variable icodtipomovold integer;
declare variable calttm char(1);
declare variable ddtprc date;
declare variable ddtprcate date;
declare variable cestoqmovprod char(1);
begin
  /* Procedure de atualização da tabela eqmovprod */

  DDTPRCATE = NULL; /* Até onde deve ser processando o estoque */
 /* localiza movprod */

-- execute procedure sgdebugsp('antes da atualização...','no inicio');

  SELECT ICODEMP, SCODFILIAL, ICODMOVPROD
    FROM EQMOVPRODRETCODSP(:ICODEMPIV, :SCODFILIALIV, :ICODINVPROD, :ICODEMPCP,
      :SCODFILIALCP, :ICODCOMPRA, :SCODITCOMPRA, :ICODEMPVD, :SCODFILIALVD,
      :CTIPOVENDA, :ICODVENDA, :SCODITVENDA, :ICODEMPRM, :SCODFILIALRM,
      :ICODRMA, :SCODITRMA, :ICODEMPOP, :SCODFILIALOP, :ICODOP, :SSEQOP, :sseqentop, :seqsubprod)
    INTO :ICODEMP, :SCODFILIAL, :ICODMOVPROD;

--  traz valores antigos

  SELECT MP.CODEMPTM, MP.CODFILIALTM, MP.CODTIPOMOV, MP.DTMOVPROD,
       MP.PRECOMOVPROD, MP.QTDMOVPROD  FROM EQMOVPROD MP
     WHERE MP.CODEMP=:ICODEMP AND MP.CODFILIAL=:SCODFILIAL AND MP.CODMOVPROD=:ICODMOVPROD
     INTO :ICODEMPTMOLD, :SCODFILIALTMOLD, :ICODTIPOMOVOLD, :DDTMOVPRODOLD,
       :NPRECOMOVPRODOLD, :NQTDMOVPRODOLD;

   /* abaixo verificação se a alteração de tipo de movimento mexe no estoque */
   SELECT CALTTM FROM EQMOVPRODCKUTMSP(:ICODEMPTM, :SCODFILIALTM, :ICODTIPOMOV,
      :ICODEMPTMOLD, :SCODFILIALTMOLD, :ICODTIPOMOVOLD) INTO :CALTTM;

   /* verifica se há relevância para reprocessamento */
   if ( (DDTMOVPROD!=DDTMOVPRODOLD) OR (CALTTM='S') OR
        (NPRECOMOVPROD!=NPRECOMOVPRODOLD) OR (NQTDMOVPROD!=NQTDMOVPRODOLD) ) then
   begin

   -- execute procedure sgdebugsp('entrou no if','1');


      if ( DDTMOVPRODOLD IS NULL) then
         DDTMOVPRODOLD = DDTMOVPROD; /* garantir que a data antiga não e nula; */
      /* verifica qual data é menor para reprocessamento */
      if ( DDTMOVPROD<=DDTMOVPRODOLD ) then
      begin

     -- execute procedure sgdebugsp('entrou no if','2');

          DDTPRC = DDTMOVPROD;
          if (DDTMOVPROD=DDTMOVPRODOLD) then
             DDTPRCATE = null;
          else
             DDTPRCATE = DDTMOVPRODOLD;
/*          verifica lançamento anterior e traz custo e saldo */
          SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX
             FROM EQMOVPRODSLDSP(:ICODEMP, :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
             :SCODFILIALPD, :ICODPROD, :DDTPRC, :NPRECOMOVPROD, :NPRECOMOVPROD,
             :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
             INTO :NSLDPRC, :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX ;

          /* verifica se havera mudança de saldo */
          SELECT NSALDO, NCUSTOMPM, CESTOQMOVPROD
              FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
              :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMPRC, :NSLDPRC, :ESTOQTIPOMOVPD, :TIPONF)
              INTO :NSLDPRC, :NCUSTOMPMPRC, :CESTOQMOVPROD;
          if (CMULTIALMOX='N') then
          begin
              NSLDPRCAX = NSLDPRC;
              NCUSTOMPMPRCAX = NCUSTOMPMPRC;
          end
          else
          begin
          SELECT NSALDO, NCUSTOMPM
              FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
              :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMPRCAX, :NSLDPRCAX, :ESTOQTIPOMOVPD, :TIPONF)
              INTO :NSLDPRCAX, :NCUSTOMPMPRCAX;
          end
          NCUSTOMPMLC = NCUSTOMPMPRC;
          NSLDLC = NSLDPRC;
          NCUSTOMPMLCAX = NCUSTOMPMPRCAX;
          NSLDLCAX = NSLDPRCAX;
      end
      else
      begin
          DDTPRC = DDTMOVPRODOLD;
          DDTPRCATE = DDTMOVPROD;
          /* verifica lançamento anterior e traz custo e saldo */

       --   execute procedure sgdebugsp('entrou no else','3');

          SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX
             FROM EQMOVPRODSLDSP(:ICODEMP, :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
             :SCODFILIALPD, :ICODPROD, :DDTPRC, 0, 0,
             :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
             INTO :NSLDPRC, :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX ;

          /* verifica lançamento anterior e traz custo e saldo */
          SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX
             FROM EQMOVPRODSLDSP(:ICODEMP, :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
             :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, :NCUSTOMPMLC, :NCUSTOMPMLCAX,
             :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
             INTO :NSLDLC, :NCUSTOMPMLC, :NSLDLCAX, :NCUSTOMPMLCAX ;

          /* verifica se havera mudança de saldo */
          SELECT NSALDO, NCUSTOMPM, CESTOQMOVPROD
              FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
              :ICODTIPOMOV, (:NQTDMOVPROD-:NQTDMOVPRODOLD), :NPRECOMOVPROD,
              :NCUSTOMPMLC, :NSLDLC, :ESTOQTIPOMOVPD, :TIPONF)
              INTO :NSLDLC, :NCUSTOMPMLC, :CESTOQMOVPROD;
          if (CMULTIALMOX='N') then
          begin
             NSLDLCAX = NSLDLC;
             NCUSTOMPMLCAX = NCUSTOMPMLC;
          end
          else
          begin
              SELECT NSALDO, NCUSTOMPM
                  FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
                  :ICODTIPOMOV, (:NQTDMOVPROD-:NQTDMOVPRODOLD), :NPRECOMOVPROD,
                  :NCUSTOMPMLCAX, :NSLDLCAX, :ESTOQTIPOMOVPD, :TIPONF)
                  INTO :NSLDLCAX, :NCUSTOMPMLCAX;
          end

      end

       SELECT NSLDPRC, NCUSTOMPMPRC, NSLDPRCAX, NCUSTOMPMPRCAX
        FROM EQMOVPRODPRCSLDSP( :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
          :SCODFILIALPD, :ICODPROD, :DDTPRC, :DDTPRCATE, :NSLDPRC,
          :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX,
          :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX, :TIPONF)
        INTO :NSLDPRC, :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX;

      UPDATE EQMOVPROD SET DTMOVPROD=:DDTMOVPROD,
         QTDMOVPROD=:NQTDMOVPROD, PRECOMOVPROD=:NPRECOMOVPROD,
         SLDMOVPROD=:NSLDLC, CUSTOMPMMOVPROD=:NCUSTOMPMLC,
         SLDMOVPRODAX=:NSLDLCAX, CUSTOMPMMOVPRODAX=:NCUSTOMPMLCAX,
         FLAG=:CFLAG, CODEMPNT=:ICODEMPNT, CODFILIALNT=:SCODFILIALNT,
         CODNAT=:CCODNAT, DOCMOVPROD=:IDOCMOVPROD, CODEMPTM=:ICODEMPTM,
         CODFILIALTM=:SCODFILIALTM, CODTIPOMOV=:ICODTIPOMOV, CODEMPLE=:ICODEMPLE,
         CODFILIALLE=:SCODFILIALLE, CODLOTE=:CCODLOTE, ESTOQMOVPROD=:CESTOQMOVPROD ,
         CODEMPAX=:ICODEMPAX, CODFILIALAX=:SCODFILIALAX, CODALMOX=:ICODALMOX
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPROD;
   end
   else /*  caso não tenha nenhuma alteração relevânte para processamento */

  --  execute procedure sgdebugsp('antes do reprocessamento','5SG');

      UPDATE EQMOVPROD SET FLAG=:CFLAG, CODEMPNT=:ICODEMPNT, CODFILIALNT=:SCODFILIALNT,
         CODNAT=:CCODNAT, DOCMOVPROD=:IDOCMOVPROD, CODEMPTM=:ICODEMPTM,
         CODFILIALTM=:SCODFILIALTM, CODTIPOMOV=:ICODTIPOMOV, CODEMPLE=:ICODEMPLE,
         CODFILIALLE=:SCODFILIALLE, CODLOTE=:CCODLOTE,
         CODEMPAX=:ICODEMPAX, CODFILIALAX=:SCODFILIALAX, CODALMOX=:ICODALMOX
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPROD;
end
^

ALTER PROCEDURE EQMOVPRODISP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD SMALLINT,
ESTOQTIPOMOVPD CHAR(1),
TIPONF CHAR(1))
 AS
declare variable scodfilial smallint;
declare variable icodmovprod integer;
declare variable cestoqmovprod char(1);
declare variable ctipomovprod char(1);
declare variable nsldmovprod numeric(15,5);
declare variable ncustompmmovprod numeric(15,5);
declare variable soperador smallint;
declare variable nsldmovprodax numeric(15,5);
declare variable ncustompmmovprodax numeric(15,5);
begin
  /* Procedure de inserção na tabela eqmovprod */

  SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX FROM EQMOVPRODSLDSP(null, null, null, :ICODEMPPD,
     :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, :NPRECOMOVPROD, :NPRECOMOVPROD,
     :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX )
     INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX ;

  /* Verifica se haverá mudança de saldo*/
  SELECT NSALDO, NCUSTOMPM, CESTOQMOVPROD, CTIPOMOVPROD, SOPERADOR FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
      :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPROD, :ESTOQTIPOMOVPD, :TIPONF)
      INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :CESTOQMOVPROD, :CTIPOMOVPROD, :SOPERADOR;

  if (CMULTIALMOX='N') then
  begin
     NSLDMOVPRODAX = NSLDMOVPROD;
     NCUSTOMPMMOVPRODAX = NCUSTOMPMMOVPROD;
  end
  else
  begin
      SELECT NSALDO, NCUSTOMPM FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
          :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPRODAX, :NSLDMOVPRODAX, :ESTOQTIPOMOVPD, :TIPONF)
        INTO :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX;
  end

  SELECT SCODFILIAL, ICODMOVPROD FROM EQMOVPRODSEQSP(:ICODEMPPD)
     INTO :SCODFILIAL, :ICODMOVPROD;  /* encontra o próximo código e a filial*/

   INSERT INTO EQMOVPROD ( CODEMP, CODFILIAL, CODMOVPROD,
      CODEMPPD, CODFILIALPD , CODPROD , CODEMPLE ,
      CODFILIALLE , CODLOTE , CODEMPTM, CODFILIALTM,
      CODTIPOMOV, CODEMPIV , CODFILIALIV , CODINVPROD ,
      CODEMPCP , CODFILIALCP , CODCOMPRA , CODITCOMPRA , CODEMPVD ,
      CODFILIALVD , TIPOVENDA , CODVENDA , CODITVENDA , CODEMPRM ,
      CODFILIALRM , CODRMA , CODITRMA ,
      CODEMPOP, CODFILIALOP, CODOP, SEQOP, SEQENTOP,
      CODEMPNT , CODFILIALNT ,
      CODNAT , DTMOVPROD , DOCMOVPROD , FLAG , QTDMOVPROD ,
      PRECOMOVPROD, ESTOQMOVPROD, TIPOMOVPROD, SLDMOVPROD, CUSTOMPMMOVPROD,
      SLDMOVPRODAX, CUSTOMPMMOVPRODAX, CODEMPAX, CODFILIALAX, CODALMOX, seqsubprod )
   VALUES ( :ICODEMPPD, :SCODFILIAL, :ICODMOVPROD,
    :ICODEMPPD , :SCODFILIALPD , :ICODPROD , :ICODEMPLE ,
    :SCODFILIALLE , :CCODLOTE , :ICODEMPTM, :SCODFILIALTM,
    :ICODTIPOMOV, :ICODEMPIV , :SCODFILIALIV ,
    :ICODINVPROD , :ICODEMPCP , :SCODFILIALCP , :ICODCOMPRA ,
    :SCODITCOMPRA , :ICODEMPVD , :SCODFILIALVD , :CTIPOVENDA ,
    :ICODVENDA , :SCODITVENDA , :ICODEMPRM , :SCODFILIALRM ,
    :ICODRMA , :SCODITRMA , :ICODEMPOP, :SCODFILIALOP, :ICODOP, :SSEQOP, :sseqentop,
    :ICODEMPNT , :SCODFILIALNT , :CCODNAT ,
    :DDTMOVPROD , :IDOCMOVPROD , :CFLAG , :NQTDMOVPROD ,
    :NPRECOMOVPROD, :CESTOQMOVPROD, :CTIPOMOVPROD, :NSLDMOVPROD, :NCUSTOMPMMOVPROD,
    :NSLDMOVPRODAX,  :NCUSTOMPMMOVPRODAX, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :seqsubprod );

  /* REPROCESSAR ESTOQUE */

  SELECT NSLDPRC, NCUSTOMPMPRC, NSLDPRCAX, NCUSTOMPMPRCAX
    FROM EQMOVPRODPRCSLDSP( :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
     :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, null, :NSLDMOVPROD, :NCUSTOMPMMOVPROD,
     :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX,
     :CMULTIALMOX, :TIPONF)
    INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX ;

 /* ATUALIZA O CUSTO NO CADASTRO DE PRODUTOS
   EXECUTE PROCEDURE EQMOVPRODATCUSTSP(:SOPERADOR, :ICODEMPPD, :SCODFILIAL,
    :ICODMOVPROD, :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, :NCUSTOMPMMOVPROD); 
 */


  suspend;
end
^

/* Alter (EQMOVPRODIUDSP) */
ALTER PROCEDURE EQMOVPRODIUDSP(CIUD CHAR(1),
ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
SEQSUBPROD SMALLINT,
ESTOQTIPOMOVPD CHAR(1),
TIPONF CHAR(1))
 AS
declare variable cmultialmox char(1);
begin
  /* Procedure que controle INSERT, UPDATE E DELETE da tabela eqmovprod */

  /* Linha incluida para passar como parâmetro se é multi almoxarifado
      Como o objetivo de evitar I/O
  */
  SELECT CMULTIALMOX FROM SGRETMULTIALMOXSP(:ICODEMPPD) INTO :CMULTIALMOX;
  
  if (CIUD='I') then /* SE FOR INSERT */
     execute procedure EQMOVPRODISP( ICODEMPPD, SCODFILIALPD, ICODPROD,
         ICODEMPLE, SCODFILIALLE, CCODLOTE, ICODEMPTM, SCODFILIALTM, ICODTIPOMOV,
         ICODEMPIV, SCODFILIALIV, ICODINVPROD, ICODEMPCP, SCODFILIALCP, ICODCOMPRA,
         SCODITCOMPRA, ICODEMPVD, SCODFILIALVD, CTIPOVENDA, ICODVENDA, SCODITVENDA,
         ICODEMPRM, SCODFILIALRM, ICODRMA, SCODITRMA,
         ICODEMPOP, SCODFILIALOP, ICODOP, SSEQOP, sseqentop,
         ICODEMPNT, SCODFILIALNT,
         CCODNAT, DDTMOVPROD, IDOCMOVPROD, CFLAG, NQTDMOVPROD, NPRECOMOVPROD,
         ICODEMPAX, SCODFILIALAX, ICODALMOX, CMULTIALMOX, :seqsubprod, :estoqtipomovpd, :tiponf);
  else if (CIUD='U') then
     execute procedure EQMOVPRODUSP( ICODEMPPD, SCODFILIALPD, ICODPROD,
         ICODEMPLE, SCODFILIALLE, CCODLOTE, ICODEMPTM, SCODFILIALTM, ICODTIPOMOV,
         ICODEMPIV, SCODFILIALIV, ICODINVPROD, ICODEMPCP, SCODFILIALCP, ICODCOMPRA,
         SCODITCOMPRA, ICODEMPVD, SCODFILIALVD, CTIPOVENDA, ICODVENDA, SCODITVENDA,
         ICODEMPRM, SCODFILIALRM, ICODRMA, SCODITRMA,
         ICODEMPOP, SCODFILIALOP, ICODOP, SSEQOP, sseqentop,
         ICODEMPNT, SCODFILIALNT,
         CCODNAT, DDTMOVPROD, IDOCMOVPROD, CFLAG, NQTDMOVPROD, NPRECOMOVPROD,
         ICODEMPAX, SCODFILIALAX, ICODALMOX, CMULTIALMOX,:seqsubprod, :estoqtipomovpd, :tiponf);
  else if (CIUD='D') then
     execute procedure EQMOVPRODDSP( ICODEMPPD, SCODFILIALPD, ICODPROD, ICODEMPIV,
         SCODFILIALIV, ICODINVPROD, ICODEMPCP, SCODFILIALCP, ICODCOMPRA, SCODITCOMPRA,
         ICODEMPVD, SCODFILIALVD, CTIPOVENDA, ICODVENDA, SCODITVENDA,
         ICODEMPRM, SCODFILIALRM, ICODRMA, SCODITRMA,
         ICODEMPOP, SCODFILIALOP, ICODOP, SSEQOP, sseqentop,
         DDTMOVPROD, ICODEMPAX, SCODFILIALAX, ICODALMOX, CMULTIALMOX, :seqsubprod, :tiponf );
--  suspend;
end
^

SET TERM ; ^

Update Rdb$Procedure_Parameters set Rdb$Description =
'Sequencial de subproduto'
where Rdb$Procedure_Name='EQMOVPRODIUDSP' and Rdb$Parameter_Name='SEQSUBPROD';

/* Alter (EQMOVPRODPRCSLDSP) */
SET TERM ^ ;

ALTER PROCEDURE EQMOVPRODPRCSLDSP(SCODFILIAL SMALLINT,
ICODMOVPROD INTEGER,
ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
DDTMOVPROD DATE,
DDTMOVPRODPRC DATE,
NSLDMOVPROD NUMERIC(15,5),
NCUSTOMPMMOVPROD NUMERIC(15,5),
NSLDMOVPRODAX NUMERIC(15,5),
NCUSTOMPMMOVPRODAX NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
TIPONF CHAR(1))
 RETURNS(NSLDPRC NUMERIC(15,5),
NCUSTOMPMPRC NUMERIC(15,5),
NSLDPRCAX NUMERIC(15,5),
NCUSTOMPMPRCAX NUMERIC(15,5),
ESTOQTIPOMOVPD CHAR(1))
 AS
declare variable icodemptm integer;
declare variable scodfilialtm smallint;
declare variable icodtipomov integer;
declare variable nqtdmovprod numeric(15,5);
declare variable nprecomovprod numeric(15,5);
declare variable icodmovprodprc integer;
declare variable cestoqmovprod char(1);
declare variable icodempaxprc integer;
declare variable scodfilialaxprc smallint;
declare variable icodalmoxprc integer;
begin
  /* Procedure de processamento de estoque */
  FOR SELECT MP.CODEMPTM, MP.CODFILIALTM, MP.CODTIPOMOV ,
    MP.QTDMOVPROD, MP.PRECOMOVPROD , MP.CODMOVPROD,
    MP.CODEMPAX, MP.CODFILIALAX, MP.CODALMOX, MP.ESTOQMOVPROD
    FROM EQMOVPROD MP
    WHERE MP.CODEMPPD=:ICODEMPPD AND MP.CODFILIALPD=:SCODFILIALPD AND
       MP.CODPROD=:ICODPROD AND MP.CODEMP=:ICODEMPPD AND MP.CODFILIAL=:SCODFILIAL AND
       ( (MP.DTMOVPROD = :DDTMOVPROD AND MP.CODMOVPROD > :ICODMOVPROD) OR
         (MP.DTMOVPROD>:DDTMOVPROD) ) AND  /* ALTEREI AQUI */
       ( (:DDTMOVPRODPRC IS NULL /* AND MP.CODMOVPROD!=:ICODMOVPROD */) OR
         (MP.DTMOVPROD = :DDTMOVPRODPRC AND MP.CODMOVPROD < :ICODMOVPROD) OR
         (MP.DTMOVPROD < :DDTMOVPRODPRC) )
    ORDER BY MP.DTMOVPROD, MP.CODMOVPROD
    INTO :ICODEMPTM, :SCODFILIALTM, :ICODTIPOMOV,
     :NQTDMOVPROD, :NPRECOMOVPROD, :ICODMOVPRODPRC,
     :ICODEMPAXPRC, :SCODFILIALAXPRC, :ICODALMOXPRC, :ESTOQTIPOMOVPD DO
  BEGIN
      SELECT NSALDO, NCUSTOMPM, CESTOQMOVPROD FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
        :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPROD, :ESTOQTIPOMOVPD, :TIPONF)
      INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :CESTOQMOVPROD;
      if (CMULTIALMOX='N') then /* Se não for multi almoxarifado*/
      begin
         NSLDMOVPRODAX = NSLDMOVPROD;
         NCUSTOMPMMOVPRODAX = NCUSTOMPMMOVPROD;
         UPDATE EQMOVPROD SET SLDMOVPROD=:NSLDMOVPROD, CUSTOMPMMOVPROD=:NCUSTOMPMMOVPROD,
            SLDMOVPRODAX=:NSLDMOVPRODAX, CUSTOMPMMOVPRODAX=:NCUSTOMPMMOVPRODAX,
            ESTOQMOVPROD=:CESTOQMOVPROD
            WHERE CODEMP=:ICODEMPPD AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPRODPRC;
      end
      else if (ICODEMPAX=ICODEMPAXPRC AND SCODFILIALAX=SCODFILIALAXPRC AND
          ICODALMOX=ICODALMOXPRC) then
          /* Se for multi almoxarifado e o código do almoxarifado for o mesmo*/
      begin
        SELECT NSALDO, NCUSTOMPM FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
            :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPRODAX, :NSLDMOVPRODAX, :ESTOQTIPOMOVPD, :TIPONF)
            INTO :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX;
        UPDATE EQMOVPROD SET SLDMOVPROD=:NSLDMOVPROD, CUSTOMPMMOVPROD=:NCUSTOMPMMOVPROD,
            SLDMOVPRODAX=:NSLDMOVPRODAX, CUSTOMPMMOVPRODAX=:NCUSTOMPMMOVPRODAX,
            ESTOQMOVPROD=:CESTOQMOVPROD
            WHERE CODEMP=:ICODEMPPD AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPRODPRC;
      end
      else /* Se for multi almoxarifado não atualiza almoxarifado diferente */
      begin
        UPDATE EQMOVPROD SET SLDMOVPROD=:NSLDMOVPROD, CUSTOMPMMOVPROD=:NCUSTOMPMMOVPROD,
            ESTOQMOVPROD=:CESTOQMOVPROD
            WHERE CODEMP=:ICODEMPPD AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPRODPRC;
      end
      NSLDPRC = NSLDMOVPROD;
      NCUSTOMPMPRC = NCUSTOMPMMOVPROD;
      NSLDPRCAX = NSLDMOVPRODAX;
      NCUSTOMPMPRCAX = NCUSTOMPMMOVPRODAX;
  END
  suspend;
end
^

/* Alter (EQMOVPRODUSP) */
ALTER PROCEDURE EQMOVPRODUSP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD BIGINT,
ESTOQTIPOMOVPD CHAR(1),
TIPONF CHAR(1))
 AS
declare variable icodemp integer;
declare variable scodfilial smallint;
declare variable icodmovprod integer;
declare variable nsldprc numeric(15,5);
declare variable ncustompmprc numeric(15,5);
declare variable nsldprcax numeric(15,5);
declare variable ncustompmprcax numeric(15,5);
declare variable nsldlc numeric(15,5);
declare variable ncustompmlc numeric(15,5);
declare variable nsldlcax numeric(15,5);
declare variable ncustompmlcax numeric(15,5);
declare variable ddtmovprodold date;
declare variable nprecomovprodold numeric(15,5);
declare variable nqtdmovprodold numeric(15,5);
declare variable icodemptmold integer;
declare variable scodfilialtmold smallint;
declare variable icodtipomovold integer;
declare variable calttm char(1);
declare variable ddtprc date;
declare variable ddtprcate date;
declare variable cestoqmovprod char(1);
begin
  /* Procedure de atualização da tabela eqmovprod */

  DDTPRCATE = NULL; /* Até onde deve ser processando o estoque */
 /* localiza movprod */

-- execute procedure sgdebugsp('antes da atualização...','no inicio');

  SELECT ICODEMP, SCODFILIAL, ICODMOVPROD
    FROM EQMOVPRODRETCODSP(:ICODEMPIV, :SCODFILIALIV, :ICODINVPROD, :ICODEMPCP,
      :SCODFILIALCP, :ICODCOMPRA, :SCODITCOMPRA, :ICODEMPVD, :SCODFILIALVD,
      :CTIPOVENDA, :ICODVENDA, :SCODITVENDA, :ICODEMPRM, :SCODFILIALRM,
      :ICODRMA, :SCODITRMA, :ICODEMPOP, :SCODFILIALOP, :ICODOP, :SSEQOP, :sseqentop, :seqsubprod)
    INTO :ICODEMP, :SCODFILIAL, :ICODMOVPROD;

--  traz valores antigos

  SELECT MP.CODEMPTM, MP.CODFILIALTM, MP.CODTIPOMOV, MP.DTMOVPROD,
       MP.PRECOMOVPROD, MP.QTDMOVPROD  FROM EQMOVPROD MP
     WHERE MP.CODEMP=:ICODEMP AND MP.CODFILIAL=:SCODFILIAL AND MP.CODMOVPROD=:ICODMOVPROD
     INTO :ICODEMPTMOLD, :SCODFILIALTMOLD, :ICODTIPOMOVOLD, :DDTMOVPRODOLD,
       :NPRECOMOVPRODOLD, :NQTDMOVPRODOLD;

   /* abaixo verificação se a alteração de tipo de movimento mexe no estoque */
   SELECT CALTTM FROM EQMOVPRODCKUTMSP(:ICODEMPTM, :SCODFILIALTM, :ICODTIPOMOV,
      :ICODEMPTMOLD, :SCODFILIALTMOLD, :ICODTIPOMOVOLD) INTO :CALTTM;

   /* verifica se há relevância para reprocessamento */
   if ( (DDTMOVPROD!=DDTMOVPRODOLD) OR (CALTTM='S') OR
        (NPRECOMOVPROD!=NPRECOMOVPRODOLD) OR (NQTDMOVPROD!=NQTDMOVPRODOLD) ) then
   begin

   -- execute procedure sgdebugsp('entrou no if','1');


      if ( DDTMOVPRODOLD IS NULL) then
         DDTMOVPRODOLD = DDTMOVPROD; /* garantir que a data antiga não e nula; */
      /* verifica qual data é menor para reprocessamento */
      if ( DDTMOVPROD<=DDTMOVPRODOLD ) then
      begin

     -- execute procedure sgdebugsp('entrou no if','2');

          DDTPRC = DDTMOVPROD;
          if (DDTMOVPROD=DDTMOVPRODOLD) then
             DDTPRCATE = null;
          else
             DDTPRCATE = DDTMOVPRODOLD;
/*          verifica lançamento anterior e traz custo e saldo */
          SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX
             FROM EQMOVPRODSLDSP(:ICODEMP, :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
             :SCODFILIALPD, :ICODPROD, :DDTPRC, :NPRECOMOVPROD, :NPRECOMOVPROD,
             :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
             INTO :NSLDPRC, :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX ;

          /* verifica se havera mudança de saldo */
          SELECT NSALDO, NCUSTOMPM, CESTOQMOVPROD
              FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
              :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMPRC, :NSLDPRC, :ESTOQTIPOMOVPD, :TIPONF)
              INTO :NSLDPRC, :NCUSTOMPMPRC, :CESTOQMOVPROD;
          if (CMULTIALMOX='N') then
          begin
              NSLDPRCAX = NSLDPRC;
              NCUSTOMPMPRCAX = NCUSTOMPMPRC;
          end
          else
          begin
          SELECT NSALDO, NCUSTOMPM
              FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
              :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMPRCAX, :NSLDPRCAX, :ESTOQTIPOMOVPD, :TIPONF)
              INTO :NSLDPRCAX, :NCUSTOMPMPRCAX;
          end
          NCUSTOMPMLC = NCUSTOMPMPRC;
          NSLDLC = NSLDPRC;
          NCUSTOMPMLCAX = NCUSTOMPMPRCAX;
          NSLDLCAX = NSLDPRCAX;
      end
      else
      begin
          DDTPRC = DDTMOVPRODOLD;
          DDTPRCATE = DDTMOVPROD;
          /* verifica lançamento anterior e traz custo e saldo */

       --   execute procedure sgdebugsp('entrou no else','3');

          SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX
             FROM EQMOVPRODSLDSP(:ICODEMP, :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
             :SCODFILIALPD, :ICODPROD, :DDTPRC, 0, 0,
             :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
             INTO :NSLDPRC, :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX ;

          /* verifica lançamento anterior e traz custo e saldo */
          SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX
             FROM EQMOVPRODSLDSP(:ICODEMP, :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
             :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, :NCUSTOMPMLC, :NCUSTOMPMLCAX,
             :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
             INTO :NSLDLC, :NCUSTOMPMLC, :NSLDLCAX, :NCUSTOMPMLCAX ;

          /* verifica se havera mudança de saldo */
          SELECT NSALDO, NCUSTOMPM, CESTOQMOVPROD
              FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
              :ICODTIPOMOV, (:NQTDMOVPROD-:NQTDMOVPRODOLD), :NPRECOMOVPROD,
              :NCUSTOMPMLC, :NSLDLC, :ESTOQTIPOMOVPD, :TIPONF)
              INTO :NSLDLC, :NCUSTOMPMLC, :CESTOQMOVPROD;
          if (CMULTIALMOX='N') then
          begin
             NSLDLCAX = NSLDLC;
             NCUSTOMPMLCAX = NCUSTOMPMLC;
          end
          else
          begin
              SELECT NSALDO, NCUSTOMPM
                  FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
                  :ICODTIPOMOV, (:NQTDMOVPROD-:NQTDMOVPRODOLD), :NPRECOMOVPROD,
                  :NCUSTOMPMLCAX, :NSLDLCAX, :ESTOQTIPOMOVPD, :TIPONF)
                  INTO :NSLDLCAX, :NCUSTOMPMLCAX;
          end

      end

       SELECT NSLDPRC, NCUSTOMPMPRC, NSLDPRCAX, NCUSTOMPMPRCAX
        FROM EQMOVPRODPRCSLDSP( :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
          :SCODFILIALPD, :ICODPROD, :DDTPRC, :DDTPRCATE, :NSLDPRC,
          :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX,
          :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX, :TIPONF)
        INTO :NSLDPRC, :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX;

      UPDATE EQMOVPROD SET DTMOVPROD=:DDTMOVPROD,
         QTDMOVPROD=:NQTDMOVPROD, PRECOMOVPROD=:NPRECOMOVPROD,
         SLDMOVPROD=:NSLDLC, CUSTOMPMMOVPROD=:NCUSTOMPMLC,
         SLDMOVPRODAX=:NSLDLCAX, CUSTOMPMMOVPRODAX=:NCUSTOMPMLCAX,
         FLAG=:CFLAG, CODEMPNT=:ICODEMPNT, CODFILIALNT=:SCODFILIALNT,
         CODNAT=:CCODNAT, DOCMOVPROD=:IDOCMOVPROD, CODEMPTM=:ICODEMPTM,
         CODFILIALTM=:SCODFILIALTM, CODTIPOMOV=:ICODTIPOMOV, CODEMPLE=:ICODEMPLE,
         CODFILIALLE=:SCODFILIALLE, CODLOTE=:CCODLOTE, ESTOQMOVPROD=:CESTOQMOVPROD ,
         CODEMPAX=:ICODEMPAX, CODFILIALAX=:SCODFILIALAX, CODALMOX=:ICODALMOX
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPROD;
   end
   else /*  caso não tenha nenhuma alteração relevânte para processamento */

  --  execute procedure sgdebugsp('antes do reprocessamento','5SG');

      UPDATE EQMOVPROD SET FLAG=:CFLAG, CODEMPNT=:ICODEMPNT, CODFILIALNT=:SCODFILIALNT,
         CODNAT=:CCODNAT, DOCMOVPROD=:IDOCMOVPROD, CODEMPTM=:ICODEMPTM,
         CODFILIALTM=:SCODFILIALTM, CODTIPOMOV=:ICODTIPOMOV, CODEMPLE=:ICODEMPLE,
         CODFILIALLE=:SCODFILIALLE, CODLOTE=:CCODLOTE,
         CODEMPAX=:ICODEMPAX, CODFILIALAX=:SCODFILIALAX, CODALMOX=:ICODALMOX
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPROD;
end
^

/* Alter (FNADICLANCASP01) */
ALTER PROCEDURE FNADICLANCASP01(ICODREC INTEGER,
INPARCITREC INTEGER,
PDVITREC CHAR(1),
SNUMCONTA CHAR(10),
ICODEMPCA INTEGER,
ICODFILIALCA INTEGER,
ICODCLI INTEGER,
ICODEMPCL INTEGER,
ICODFILIALCL INTEGER,
SCODPLAN CHAR(13),
ICODEMPPN INTEGER,
ICODFILIALPN INTEGER,
IANOCC INTEGER,
SCODCC CHAR(19),
ICODEMPCC INTEGER,
ICODFILIALCC INTEGER,
DDTCOMPITREC DATE,
DDTPAGOITREC DATE,
SDOCLANCAITREC VARCHAR(15),
SOBSITREC CHAR(250),
DVLRPAGOITREC NUMERIC(15,5),
ICODEMP INTEGER,
ICODFILIAL SMALLINT,
DVLRPAGOJUROS NUMERIC(15,5),
DVLRDESC NUMERIC(15,5),
CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
CODCONTR INTEGER,
CODITCONTR SMALLINT)
 AS
declare variable icodlanca integer;
declare variable scodplanconta char(13);
declare variable icodemppconta integer;
declare variable icodfilialpconta integer;
declare variable cflag char(1);
declare variable ifiliallanca integer;
declare variable tipolanca char(1);
declare variable codempjr integer;
declare variable codfilialjr smallint;
declare variable codplanjr char(13);
declare variable codempdc integer;
declare variable codfilialdc smallint;
declare variable codplandc char(13);
declare variable codsublanca smallint = 1;
BEGIN
    SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNLANCA') INTO IFILIALLANCA;

    SELECT CODPLAN,CODEMPPN,CODFILIALPN FROM FNCONTA WHERE NUMCONTA = :SNUMCONTA
        AND CODEMP=:ICODEMPCA AND CODFILIAL=:ICODFILIALCA INTO :sCodPlanConta,:iCodEmpPConta,:iCodFilialPConta;

    SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALLANCA,'LA') INTO ICODLANCA;

    SELECT FLAG FROM FNRECEBER WHERE CODREC=:ICODREC
        AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO :cFlag;

    SELECT CODEMPJR,CODFILIALJR,CODPLANJR,CODEMPDC,CODFILIALDC,CODPLANDC FROM SGPREFERE1
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
        INTO :CODEMPJR,:CODFILIALJR,:CODPLANJR,:CODEMPDC,:CODFILIALDC,:CODPLANDC;


    IF (ICODCLI IS NULL) THEN
        TIPOLANCA = 'A';
    ELSE
        TIPOLANCA = 'C';

    if ( (DVLRPAGOJUROS IS NULL) OR (:CODPLANJR IS NULL)  ) then
        DVLRPAGOJUROS = 0;
    else
        DVLRPAGOITREC = DVLRPAGOITREC - DVLRPAGOJUROS;

    if (DVLRDESC IS NULL  OR (:CODPLANDC IS NULL) ) then
        DVLRDESC = 0;
    else
        DVLRPAGOITREC = DVLRPAGOITREC + DVLRDESC;


    INSERT INTO FNLANCA (TIPOLANCA,CODEMP,CODFILIAL,CODLANCA,CODEMPRC,CODFILIALRC,CODREC,NPARCITREC,CODEMPPN,CODFILIALPN,CODPLAN, 
        DTCOMPLANCA, DATALANCA, DOCLANCA,HISTBLANCA,DTPREVLANCA,VLRLANCA,FLAG,CODEMPCL,CODFILIALCL,CODCLI,PDVITREC)
        VALUES (:TIPOLANCA,:ICODEMP,:IFILIALLANCA,:iCodLanca,:ICODEMP,:ICODFILIAL,:ICODREC,:iNParcItRec,:iCodEmpPConta,:iCodFilialPConta,
                :sCodPlanConta,:dDtCompItRec, :dDtPagoItRec,:sDocLancaItRec,:sObsItRec,:dDtPagoItRec,0,:cFlag,:ICODEMPCL,:ICODFILIALCL,:ICODCLI,:PDVITREC
        );

    INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPCL,CODFILIALCL,CODCLI,CODEMPPN,CODFILIALPN,CODPLAN,
                CODEMPRC, CODFILIALRC, CODREC, NPARCITREC,
                CODEMPCC, CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA, DTCOMPSUBLANCA, DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,FLAG, CODEMPCT, CODFILIALCT, CODCONTR, CODITCONTR)
        VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPCL,:ICODFILIALCL,:ICODCLI,:ICODEMPPN,:ICODFILIALPN,:SCODPLAN,
                :ICODEMP, :ICODFILIAL, :ICODREC, :INPARCITREC,
                :ICODEMPCC,:ICODFILIALCC,:IANOCC,:SCODCC,'S',:dDtCompItRec,:dDtPagoItRec,:dDtPagoItRec,:dVlrPagoItRec*-1,:cFlag, :codempct, :codfilialct, :codcontr, :coditcontr
        );

    -- Lançamento dos juros em conta distinta.

    IF(DVLRPAGOJUROS > 0) THEN
    BEGIN

        CODSUBLANCA = CODSUBLANCA + 1;

        INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPCL,CODFILIALCL,CODCLI,CODEMPPN,CODFILIALPN,CODPLAN,
                 CODEMPRC, CODFILIALRC, CODREC, NPARCITREC,
                  CODEMPCC, CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DTCOMPSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,FLAG, TIPOSUBLANCA, CODEMPCT, CODFILIALCT, CODCONTR, CODITCONTR)
        VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPCL,:ICODFILIALCL,:ICODCLI,:CODEMPJR,:CODFILIALJR,:CODPLANJR,
                :ICODEMP, :ICODFILIAL, :ICODREC, :INPARCITREC,
                :ICODEMPCC, :ICODFILIALCC,:IANOCC,:SCODCC,'S',:dDtCompItRec,:dDtPagoItRec,:dDtPagoItRec,:DVLRPAGOJUROS*-1,:cFlag, 'J', :codempct, :codfilialct, :codcontr, :coditcontr
        );

    END

    -- Lançamento do desconto em conta distinta.

    IF(DVLRDESC > 0) THEN
    BEGIN

        CODSUBLANCA = CODSUBLANCA + 1;

        INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPCL,CODFILIALCL,CODCLI,CODEMPPN,CODFILIALPN,CODPLAN,
             CODEMPRC, CODFILIALRC, CODREC, NPARCITREC,
             CODEMPCC, CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DTCOMPSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,FLAG, TIPOSUBLANCA
             ,CODEMPCT, CODFILIALCT, CODCONTR, CODITCONTR)
        VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPCL,:ICODFILIALCL,:ICODCLI,:CODEMPDC,:CODFILIALDC,:CODPLANDC,
               :ICODEMP, :ICODFILIAL, :ICODREC, :INPARCITREC,
             :ICODEMPCC, :ICODFILIALCC,:IANOCC,:SCODCC,'S',:dDtCompItRec,:dDtPagoItRec,:dDtPagoItRec,:DVLRDESC,:cFlag, 'D'
             , :codempct, :codfilialct, :codcontr, :coditcontr
        );

    END


END
^

/* Alter (FNADICLANCASP02) */
ALTER PROCEDURE FNADICLANCASP02(ICODPAG INTEGER,
INPARCPAG INTEGER,
SNUMCONTA CHAR(10),
ICODEMPCA INTEGER,
ICODFILIALCA INTEGER,
ICODFOR INTEGER,
ICODEMPFR INTEGER,
ICODFILIALFR INTEGER,
SCODPLAN CHAR(13),
ICODEMPPN INTEGER,
ICODFILIALPN INTEGER,
IANOCC INTEGER,
SCODCC CHAR(19),
ICODEMPCC INTEGER,
ICODFILIALCC INTEGER,
DDTCOMPITPAG DATE,
DDTPAGOITPAG DATE,
SDOCLANCAITPAG VARCHAR(15),
SOBSITPAG CHAR(250),
DVLRPAGOITPAG NUMERIC(15,5),
ICODEMP INTEGER,
ICODFILIAL SMALLINT,
DVLRJUROSPAG NUMERIC(15,5),
DVLRDESC NUMERIC(15,5),
CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
CODCONTR INTEGER,
CODITCONTR SMALLINT)
 AS
declare variable icodlanca integer;
declare variable scodplanconta char(13);
declare variable icodemppconta integer;
declare variable icodfilialpconta integer;
declare variable cflag char(1);
declare variable ifiliallanca integer;
declare variable tipolanca char(1);
declare variable codempjp integer;
declare variable codfilialjp smallint;
declare variable codplanjp char(13);
declare variable codempdr integer;
declare variable codfilialdr smallint;
declare variable codplandr char(13);
declare variable codsublanca smallint = 1;
BEGIN

    SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNLANCA')
    INTO IFILIALLANCA;

    SELECT CODPLAN,CODEMP,CODFILIAL FROM FNCONTA
    WHERE NUMCONTA=:sNumConta AND CODEMP=:ICODEMPCA AND CODFILIAL=:ICODFILIALCA
    INTO :sCodPlanConta,:iCodEmpPConta,:iCodFilialPConta;

    SELECT ISEQ FROM SPGERANUM(:iCODEMP,:IFILIALLANCA,'LA')
    INTO :iCodLanca;

    SELECT FLAG FROM FNPAGAR
    WHERE CODPAG=:iCodPag AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
    INTO :cFlag;

    SELECT CODEMPJP,CODFILIALJP,CODPLANJP,CODEMPDR,CODFILIALDR,CODPLANDR
    FROM SGPREFERE1
    WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
    INTO :CODEMPJP,:CODFILIALJP,:CODPLANJP,:CODEMPDR,:CODFILIALDR,:CODPLANDR;

    IF (ICODFOR IS NULL) THEN
        TIPOLANCA = 'A';
      ELSE
        TIPOLANCA = 'F';

    if ( (DVLRJUROSPAG IS NULL) OR (:CODPLANJP IS NULL)  ) then
        DVLRJUROSPAG = 0;
    else
        DVLRPAGOITPAG = DVLRPAGOITPAG - DVLRJUROSPAG;

    if (DVLRDESC IS NULL  OR (:CODPLANDR IS NULL) ) then
        DVLRDESC = 0;
    else
        DVLRPAGOITPAG = DVLRPAGOITPAG + DVLRDESC;

    INSERT INTO FNLANCA (TIPOLANCA,CODEMP,CODFILIAL,CODLANCA,CODEMPPG,CODFILIALPG,CODPAG,
                         NPARCPAG,CODEMPPN,CODFILIALPN,CODPLAN,DTCOMPLANCA,DATALANCA,DOCLANCA,
                         HISTBLANCA,DTPREVLANCA,VLRLANCA,FLAG, CODEMPFR, CODFILIALFR, CODFOR)
         VALUES (:TIPOLANCA,:ICODEMP,:IFILIALLANCA,:iCodLanca,:ICODEMP,:ICODFILIAL,:iCodPag,
                 :iNParcPag,:iCodEmpPConta,:iCodFilialPConta,:sCodPlanConta, :dDtCompItPag, :dDtPagoItPag,:sDocLancaItPag,
                 :sObsItPag,:dDtPagoItPag,0,:cFlag, :ICODEMPFR, :ICODFILIALFR, :ICODFOR
         );

    INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPFR,CODFILIALFR,CODFOR,CODEMPPN,CODFILIALPN, CODPLAN,
        CODEMPPG, CODFILIALPG, CODPAG, NPARCPAG,
        CODEMPCC,CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DTCOMPSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,FLAG,
        CODEMPCT, CODFILIALCT, CODCONTR, CODITCONTR)
        VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPFR,:ICODFILIALFR,:ICODFOR,:ICODEMPPN,:ICODFILIALPN, :sCodplan,
        :ICODEMP,:ICODFILIAL,:iCodPag, :iNParcPag,
        :ICODEMPCC,:ICODFILIALCC,:IANOCC,:SCODCC,'E',:dDtCompItPag,:dDtPagoItPag,:dDtPagoItPag,:dVlrPagoItPag,:cFlag,
        :codempct, :codfilialct, :codcontr, :coditcontr);

    -- Lançamento dos juros em conta distinta.

    IF(DVLRJUROSPAG >0) THEN
    BEGIN

        CODSUBLANCA = CODSUBLANCA + 1;

        INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPFR,CODFILIALFR,CODFOR,
             CODEMPPN,CODFILIALPN,CODPLAN,CODEMPCC,CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DTCOMPSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,
             CODEMPPG, CODFILIALPG, CODPAG, NPARCPAG, FLAG, TIPOSUBLANCA
             , CODEMPCT, CODFILIALCT, CODCONTR, CODITCONTR
             )
            VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPFR,:ICODFILIALFR,:ICODFOR,
            :CODEMPJP,:CODFILIALJP,:CODPLANJP,:ICODEMPCC,:ICODFILIALCC,:IANOCC,:SCODCC,'E',:dDtCompItPag,:dDtPagoItPag,:dDtPagoItPag,:DVLRJUROSPAG,
            :ICODEMP, :ICODFILIAL, :iCodPag, :iNParcPag,:cFlag, 'J'
            , :codempct, :codfilialct, :codcontr, :coditcontr
            );

    END

    -- Lançamento de desconto em conta distinta.

    IF(DVLRDESC >0) THEN
    BEGIN

        CODSUBLANCA = CODSUBLANCA + 1;

        INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPFR,CODFILIALFR,CODFOR,
        CODEMPPN,CODFILIALPN,CODPLAN,CODEMPCC,CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DTCOMPSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,
              CODEMPPG, CODFILIALPG, CODPAG, NPARCPAG, FLAG, TIPOSUBLANCA
              , CODEMPCT, CODFILIALCT, CODCONTR, CODITCONTR)
            VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPFR,:ICODFILIALFR,:ICODFOR,
             :CODEMPDR,:CODFILIALDR,:CODPLANDR,:ICODEMPCC,:ICODFILIALCC,:IANOCC,:SCODCC,'E',:dDtCompItPag,:dDtPagoItPag,:dDtPagoItPag,:DVLRDESC*-1
             ,:ICODEMP, :ICODFILIAL, :iCodPag, :iNParcPag, :cFlag, 'D'
             ,:codempct, :codfilialct, :codcontr, :coditcontr
             );

    END

END
^

/* Alter (FNCHECAPGTOSP) */
ALTER PROCEDURE FNCHECAPGTOSP(CODCLI INTEGER,
CODEMP INTEGER,
CODFILIAL SMALLINT,
BLOQVDPORATRASO CHAR(1),
NUMDIASBLOQ SMALLINT)
 RETURNS(RETORNO VARCHAR(15))
 AS
DECLARE VARIABLE LINHAS INTEGER;
DECLARE VARIABLE CODFILIALRC INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'FNRECEBER') INTO :CODFILIALRC;
  SELECT COUNT(*) FROM FNITRECEBER IR, FNRECEBER R
     WHERE R.CODEMPCL=:CODEMP AND R.CODFILIALCL=:CODFILIAL AND R.CODCLI=:CODCLI 
       AND IR.CODEMP=R.CODEMP AND IR.CODFILIAL=R.CODFILIAL AND IR.CODREC=R.CODREC
       AND IR.STATUSITREC IN ('R1','RL')
       AND IR.CODEMP=:CODEMP AND IR.CODFILIAL=:CODFILIALRC 
       INTO :LINHAS;
  IF (LINHAS > 0) THEN
  BEGIN
    RETORNO = 'N';
    IF (BLOQVDPORATRASO = 'S' ) THEN
    BEGIN
       SELECT COUNT(*) FROM FNITRECEBER IR, FNRECEBER R
          WHERE R.CODEMPCL=:CODEMP AND R.CODFILIALCL=:CODFILIAL AND R.CODCLI=:CODCLI 
          AND IR.CODEMP=R.CODEMP AND IR.CODFILIAL=R.CODFILIAL AND IR.CODREC=R.CODREC
          AND IR.STATUSITREC IN ('R1')
          AND IR.CODEMP=:CODEMP AND IR.CODFILIAL=:CODFILIALRC
          AND ( IR.DTVENCITREC + :NUMDIASBLOQ ) < CAST( 'TODAY' as DATE)   
          INTO :LINHAS;
       IF (LINHAS>0) THEN 
          RETORNO = 'N='||:LINHAS;
    END
  END
  ELSE
    RETORNO = 'S';
  SUSPEND;
END
^

/* Alter (SGRETVERSAO) */
ALTER PROCEDURE SGRETVERSAO RETURNS(VERSAO VARCHAR(30))
 AS
begin
    versao = '1.2.6.1 (29/05/2013)';
    suspend;
end
^

/* empty dependent procedure body */
/* Clear: ATBUSCAPRECOSP for: VDBUSCAPRECOSP */
/* AssignEmptyBody proc */
ALTER PROCEDURE ATBUSCAPRECOSP(ICODPROD INTEGER,
ICODCONV INTEGER,
ICODEMPCV INTEGER,
ICODFILIALCV SMALLINT,
ICODPLANOPAG INTEGER,
ICODEMPPG INTEGER,
ICODFILIALPG SMALLINT,
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 RETURNS(PRECO NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

/* empty dependent procedure body */
/* Clear: VDADICITORCRECMERCSP for: VDBUSCAPRECOSP */
/* AssignEmptyBody proc */
ALTER PROCEDURE VDADICITORCRECMERCSP(CODEMP INTEGER,
CODFILIAL SMALLINT,
TICKET INTEGER,
CODEMPOC INTEGER,
CODFILIALOC SMALLINT,
CODORC INTEGER,
COMPONENTES CHAR(1),
SERVICOS CHAR(1),
NOVOS CHAR(1))
 AS
 BEGIN EXIT; END
^

/* Alter (VDBUSCAPRECOSP) */
ALTER PROCEDURE VDBUSCAPRECOSP(ICODPROD INTEGER,
ICODCLI INTEGER,
ICODEMPCL INTEGER,
ICODFILIALCL SMALLINT,
ICODPLANOPAG INTEGER,
ICODEMPPG INTEGER,
ICODFILIALPG SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPTM INTEGER,
ICODFILIALTM SMALLINT,
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 RETURNS(PRECO NUMERIC(14,5),
CODCLASCLIP INTEGER,
CODPLANOPAGP INTEGER,
CODPRECOPRODP INTEGER,
CODTABP INTEGER)
 AS
declare variable icodtab integer;
declare variable icodemptab integer;
declare variable icodfilialtab smallint;
declare variable icodclascli integer;
declare variable icodempclascli integer;
declare variable icodfilialclascli smallint;
declare variable percdesccli numeric(3,2);
declare variable desccli char(1);
declare variable arredpreco smallint;
declare variable codfilialpf integer;
declare variable centavos decimal(2,2);
declare variable precobase decimal(15,5);

begin
    -- Buscando código da filial de preferencias
    select icodfilial from sgretfilial(:icodemp,'SGFILIAL') into :codfilialpf;

    -- Buscando preferencias de arredondamento;
    select coalesce(arredpreco, 0)
    from sgprefere1 p1
    where p1.codemp=:icodemp and p1.codfilial=:codfilialpf
    into :arredpreco;

    -- Buscando tabela de preços do tipo de movimento;
    select codtab, codemptb, codfilialtb
    from eqtipomov
    where codtipomov=:icodtipomov and codemp=:icodemptm and codfilial=:icodfilialtm
    into :icodtab, :icodemptab, :icodfilialtab;


    -- Buscando informações do produto
    select coalesce(pd.desccli,'N'), coalesce(precobaseprod,0) from eqproduto pd
        where pd.codprod=:icodprod and pd.codemp=:icodemp and pd.codfilial=:icodfilial
        into :desccli, :precobase;

    -- Buscando informações do cliente
        
    select codclascli, codempcc, codfilialcc, coalesce(percdesccli,0) percdesccli
    from vdcliente
    where codcli=:icodcli and codemp=:icodempcl and codfilial=:icodfilialcl
    into :icodclascli, :icodempclascli, icodfilialclascli, :percdesccli;

     -- Buscando preço da tabela de preços utilizando todos os filtros exceto tabela de preços
    for select pp.codclascli, pp.codplanopag, pp.codtab, pp.codprecoprod, pp.precoprod
    from vdprecoprod pp
    where pp.codemp=:icodemp and pp.codfilial=:icodfilial and pp.codprod=:icodprod
    and pp.ativoprecoprod='S'
    and ( ( pp.codplanopag is null ) or (pp.codemppg=:icodemppg and pp.codfilialpg=:icodfilialpg and pp.codplanopag=:icodplanopag ) )
    and ( ( pp.codclascli is null) or (pp.codempcc=:icodempclascli and pp.codfilialcc=:icodfilialclascli and pp.codclascli=:icodclascli ) )
    order by pp.codclascli, pp.codplanopag, pp.codtab, pp.codprecoprod
    into :codclasclip, :codplanopagp, :codtabp, :codprecoprodp, :preco do
    begin
        --exception vdvendaex01 'Teste';

        if ( (:preco is not null) or (:preco <> 0) ) then
        begin
            --suspend;
            break;
        end
    end

    -- Buscando preço da tabela de preços específica
    if ( (:preco is null) or (:preco = 0) ) then
    begin

        for select pp.codclascli, pp.codplanopag, pp.codtab, pp.codprecoprod, pp.precoprod
        from vdprecoprod pp
        where pp.codemp=:icodemp and pp.codfilial=:icodfilial and pp.codprod=:icodprod
        and pp.ativoprecoprod='S'
        and pp.codemptb=:icodemptab and pp.codfilialtb=:icodfilialtab and pp.codtab=:icodtab
        order by pp.codclascli, pp.codplanopag, pp.codtab, pp.codprecoprod
        into :codclasclip, :codplanopagp, :codtabp, :codprecoprodp, :preco do
        begin
            --exception vdvendaex01 'Teste';

            if ( (:preco is not null) or (:preco <> 0) ) then
            begin
               --suspend;
               break;
            end
        end
    end

    --Se ainda não conseguiu pagar o preco, deve utilizar o preço base do produto aplicando o desconto especial do cliente se houver
    if ((preco is null) or (preco = 0)) then
    begin
         preco = precobase;
    end

    -- Verifica se o cliente possui desconto especial e o produto permite este desconto...
    if( percdesccli >0 and 'S' = :desccli ) then
    begin
         preco = :preco - (:preco * (:percdesccli / 100)) ;
    end

    if( :arredpreco > 0 ) then
    begin

        -- capturando valor dos centavos
        centavos = ( cast(:preco as decimal(15,2)) - truncate(preco) ) * 10;

        -- se o valor em centavos é maior ou igual ao parametro de arredondamento (arredondar para cima)
        if(:centavos >= :arredpreco) then
        begin
            preco = truncate(preco) + 1;
        end
        else
        begin
            preco = truncate(preco);
        end

    end

    suspend;

end
^

/* Alter (VDCONTRATOTOTSP) */
ALTER PROCEDURE VDCONTRATOTOTSP(CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
CODCONTR INTEGER,
CODITCONTR INTEGER,
CODEMPSC INTEGER,
CODFILIALSC SMALLINT,
CODCONTRSC INTEGER,
CODEMPTA INTEGER,
CODFILIALTA SMALLINT,
CODTAREFA INTEGER,
CODEMPST INTEGER,
CODFILIALST SMALLINT,
CODTAREFAST INTEGER,
DATAINI DATE,
DATAFIM DATE)
 RETURNS(TOTALPREVGERAL NUMERIC(15,5),
TOTALPREVPER NUMERIC(15,5),
TOTALGERAL NUMERIC(15,5),
TOTALCOBCLIGERAL NUMERIC(15,5),
TOTALANT NUMERIC(15,5),
TOTALCOBCLIANT NUMERIC(15,5),
TOTALPER NUMERIC(15,5),
TOTALCOBCLIPER NUMERIC(15,5),
SALDOANT NUMERIC(15,5),
SALDOPER NUMERIC(15,5))
 AS
begin
  if (:codcontrsc is not null) then
  begin
     codempct = codempsc;
     codfilialct = codfilialsc;
     codcontr = codcontrsc;
  end
  if (:codtarefast is not null) then
  begin
     codempta = codempst;
     codfilialta = codfilialst;
     codtarefa = codtarefast;
  end
  select sum(a.totalgeral), sum(a.totalcobcli)
   from atatendimentovw02 a
    left outer join crtarefa ta
      on ta.codemp=a.codempta and ta.codfilial=a.codfilialta and ta.codtarefa=a.codtarefa
    left outer join crtarefa st
      on st.codempta=ta.codemp and st.codfilialta=ta.codemp and st.codtarefata=ta.codtarefa
    where a.codempct=:codempct and a.codfilialct=:codfilialct and a.codcontr=:codcontr and
    (:coditcontr is null or a.coditcontr=:coditcontr) and
    (
       (:codtarefa is null) or
       (st.codtarefa is null and ta.codemp=:codempta and ta.codfilial=:codfilialta and ta.codtarefa=:codtarefa ) or
       (st.codtarefa is not null and st.codempta=:codempta and st.codfilialta=:codfilialta and st.codtarefata=:codtarefa )
    )
  into :totalgeral,  :totalcobcligeral;

  select sum(a.totalgeral), sum(a.totalcobcli)
   from atatendimentovw02 a
    left outer join crtarefa ta
      on ta.codemp=a.codempta and ta.codfilial=a.codfilialta and ta.codtarefa=a.codtarefa
    left outer join crtarefa st
      on st.codempta=ta.codemp and st.codfilialta=ta.codemp and st.codtarefata=ta.codtarefa
    where a.codempct=:codempct and a.codfilialct=:codfilialct and a.codcontr=:codcontr and
    (:coditcontr is null or a.coditcontr=:coditcontr) and
      a.dataatendo between :dataini and :datafim and
    (
       (:codtarefa is null) or
       (st.codtarefa is null and ta.codemp=:codempta and ta.codfilial=:codfilialta and ta.codtarefa=:codtarefa ) or
       (st.codtarefa is not null and st.codempta=:codempta and st.codfilialta=:codfilialta and st.codtarefata=:codtarefa )
    )
  into :totalper,  :totalcobcliper;

  select sum(a.totalgeral), sum(a.totalcobcli)
   from atatendimentovw02 a
    left outer join crtarefa ta
     on ta.codemp=a.codempta and ta.codfilial=a.codfilialta and ta.codtarefa=a.codtarefa
    left outer join crtarefa st
      on st.codempta=ta.codemp and st.codfilialta=ta.codemp and st.codtarefata=ta.codtarefa
    where a.codempct=:codempct and a.codfilialct=:codfilialct and a.codcontr=:codcontr and
    (:coditcontr is null or a.coditcontr=:coditcontr) and
     a.dataatendo < :dataini and
    (
       (:codtarefa is null) or
       (st.codtarefa is null and ta.codemp=:codempta and ta.codfilial=:codfilialta and ta.codtarefa=:codtarefa ) or
       (st.codtarefa is not null and st.codempta=:codempta and st.codfilialta=:codfilialta and st.codtarefata=:codtarefa )
    )
  into :totalant,  :totalcobcliant;

  select sum(coalesce(st.tempodectarefa, ta.tempodectarefa) )
    from crtarefa ta
    left outer join crtarefa st
      on st.codempta=ta.codemp and st.codfilialta=ta.codemp and st.codtarefata=ta.codtarefa
    where ta.codempct=:codempct and ta.codfilialct=:codfilialct and ta.codcontr=:codcontr and
    (:coditcontr is null or ta.coditcontr=:coditcontr) and
    (
       (:codtarefa is null) or
       (st.codtarefa is null and ta.codemp=:codempta and ta.codfilial=:codfilialta and ta.codtarefa=:codtarefa ) or
       (st.codtarefa is not null and st.codempta=:codempta and st.codfilialta=:codfilialta and st.codtarefata=:codtarefa )
    )
  into totalprevgeral;

  select sum(tp.tempodectarefa)
   from crtarefa ttp, crtarefaper tp
    left outer join crtarefa ta
      on ta.codemp=ttp.codempta and ta.codfilial=ttp.codfilialta and ta.codtarefa=ttp.codtarefa
    left outer join crtarefa st
      on st.codempta=ta.codemp and st.codfilialta=ta.codemp and st.codtarefata=ta.codtarefa
    where ttp.codemp=tp.codemp and ttp.codfilial=tp.codfilial and ttp.codtarefa=tp.codtarefa and
      ttp.codempct=:codempct and ttp.codfilialct=:codfilialct and ttp.codcontr=:codcontr and
    (:coditcontr is null or ttp.coditcontr=:coditcontr) and
      tp.dtiniper>=:dataini and tp.dtfimper<=:datafim and
    (
       (:codtarefa is null) or
       (st.codtarefa is null and ta.codemp=:codempta and ta.codfilial=:codfilialta and ta.codtarefa=:codtarefa ) or
       (st.codtarefa is not null and st.codempta=:codempta and st.codfilialta=:codfilialta and st.codtarefata=:codtarefa )
    )
  into :totalprevper;

  if (totalgeral is null) then
      totalgeral = 0;
  if (totalcobcligeral is null) then
      totalcobcligeral = 0;
  if (totalant is null) then
      totalant = 0;
  if (totalcobcliant is null) then
      totalcobcliant = 0;
  if (totalper is null) then
      totalper = 0;
  if (totalcobcliper is null) then
      totalcobcliper = 0;
  saldoant = totalprevgeral - totalcobcliant;
  saldoper = totalprevper - totalcobcliper;

  suspend;
end
^

/* Alter (VDCOPIACLIENTE) */
ALTER PROCEDURE VDCOPIACLIENTE(ICODCLI INTEGER,
IDOCUMENTO VARCHAR(14),
ICODEMP INTEGER,
ICODFILIAL INTEGER)
 RETURNS(ICOD INTEGER)
 AS
declare variable inovocod integer;
declare variable usacliseq char(1);
begin
    
  SELECT USACLISEQ FROM SGPREFERE1 WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO :USACLISEQ;
  IF (:USACLISEQ='S') THEN
      select iseq from spgeranum(:ICODEMP,:ICODFILIAL,'CL') into INOVOCOD;
  ELSE
      SELECT MAX(CODCLI)+1 FROM VDCLIENTE WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO INOVOCOD;

    INSERT INTO VDCLIENTE (CODEMP, CODFILIAL, CODCLI, RAZCLI, NOMECLI, CODEMPCC, CODFILIALCC,
        CODCLASCLI, CODEMPVD, CODFILIALVD, CODVEND, CODEMPTC, CODFILIALTC, CODTIPOCOB, CODEMPPG,
        CODFILIALPG, CODPLANOPAG, CODEMPTN, CODFILIALTN, CODTRAN, CODEMPBO, CODFILIALBO, CODBANCO,
        CODEMPSR, CODFILIALSR, CODSETOR, CODEMPTI, CODFILIALTI, CODTIPOCLI, CODTPCRED, CODFILIALTR,
        CODEMPTR, CODFISCCLI, CODEMPFC, CODFILIALFC, CODEMPEC, CODFILIALEC, CODTBEC, CODITTBEC, CODEMPHP,
        CODFILIALHP, CODHIST, CODEMPCB, CODFILIALCB, CODCARTCOB, DATACLI, PESSOACLI, ATIVOCLI, CNPJCLI,
        INSCCLI, CPFCLI, RGCLI, SSPCLI, ENDCLI, NUMCLI, COMPLCLI, BAIRCLI, CIDCLI, UFCLI, CEPCLI, DDDCLI,
        FONECLI, RAMALCLI, DDDFAXCLI, FAXCLI, EMAILCLI, EMAILCOB, EMAILENT, EMAILNFECLI, CONTCLI, ENDCOB,
        NUMCOB, COMPLCOB, BAIRCOB, CIDCOB, UFCOB, CEPCOB, DDDFONECOB, FONECOB, DDDFAXCOB, FAXCOB, ENDENT,
        NUMENT, COMPLENT, BAIRENT, CIDENT, UFENT, CEPENT, DDDFONEENT, FONEENT, DDDFAXENT, FAXENT, OBSCLI,
        AGENCIACLI, CODEMPPQ, CODFILIALPQ, CODPESQ, INCRACLI, DTINITR, DTVENCTOTR, NIRFCLI, SIMPLESCLI, DDDCELCLI,
        CELCLI, NATCLI, UFNATCLI, TEMPORESCLI, APELIDOCLI, SITECLI, CODCONTDEB, CODCONTCRED, CODCLICONTAB,
        FOTOCLI, IMGASSCLI, CODMUNIC, SIGLAUF, CODPAIS, CODMUNICENT, SIGLAUFENT, CODPAISENT, CODMUNICCOB,
        SIGLAUFCOB, CODPAISCOB, CODEMPUC, CODFILIALUC, CODUNIFCOD, SUFRAMACLI, PRODRURALCLI, CTOCLI, CODCNAE,
        INSCMUNCLI, PERCDESCCLI, CONTCLICOB, CONTCLIENT, DESCIPI, DDDCELENT, CELENT)
        SELECT :ICODEMP, :ICODFILIAL, :INOVOCOD, RAZCLI, NOMECLI, CODEMPCC, CODFILIALCC, CODCLASCLI, CODEMPVD,
            CODFILIALVD, CODVEND, CODEMPTC, CODFILIALTC, CODTIPOCOB, CODEMPPG, CODFILIALPG, CODPLANOPAG, CODEMPTN,
            CODFILIALTN, CODTRAN, CODEMPBO, CODFILIALBO, CODBANCO, CODEMPSR, CODFILIALSR, CODSETOR, CODEMPTI,
            CODFILIALTI, CODTIPOCLI, CODTPCRED, CODFILIALTR, CODEMPTR, CODFISCCLI, CODEMPFC, CODFILIALFC, CODEMPEC,
            CODFILIALEC, CODTBEC, CODITTBEC, CODEMPHP, CODFILIALHP, CODHIST, CODEMPCB, CODFILIALCB, CODCARTCOB, DATACLI,
            PESSOACLI, ATIVOCLI,

            CASE PESSOACLI
                WHEN 'J' THEN :IDOCUMENTO
            ELSE NULL
            END,

            INSCCLI,

            CASE PESSOACLI
                WHEN 'F' THEN :IDOCUMENTO
            ELSE NULL
            END,

            RGCLI, SSPCLI, ENDCLI, NUMCLI, COMPLCLI, BAIRCLI, CIDCLI,
            UFCLI, CEPCLI, DDDCLI, FONECLI, RAMALCLI, DDDFAXCLI, FAXCLI, EMAILCLI, EMAILCOB, EMAILENT, EMAILNFECLI,
            CONTCLI, ENDCOB, NUMCOB, COMPLCOB, BAIRCOB, CIDCOB, UFCOB, CEPCOB, DDDFONECOB, FONECOB, DDDFAXCOB, FAXCOB,
            ENDENT, NUMENT, COMPLENT, BAIRENT, CIDENT, UFENT, CEPENT, DDDFONEENT, FONEENT, DDDFAXENT, FAXENT, OBSCLI,
            AGENCIACLI, CODEMPPQ, CODFILIALPQ, CODPESQ, INCRACLI, DTINITR, DTVENCTOTR, NIRFCLI, SIMPLESCLI, DDDCELCLI,
            CELCLI, NATCLI, UFNATCLI, TEMPORESCLI, APELIDOCLI, SITECLI, CODCONTDEB, CODCONTCRED, CODCLICONTAB, FOTOCLI,
            IMGASSCLI, CODMUNIC, SIGLAUF, CODPAIS, CODMUNICENT, SIGLAUFENT, CODPAISENT, CODMUNICCOB, SIGLAUFCOB, CODPAISCOB,
            CODEMPUC, CODFILIALUC, CODUNIFCOD, SUFRAMACLI, PRODRURALCLI, CTOCLI, CODCNAE, INSCMUNCLI, PERCDESCCLI, CONTCLICOB,
            CONTCLIENT, DESCIPI, DDDCELENT, CELENT
            FROM VDCLIENTE  VC WHERE VC.CODEMP=:ICODEMP AND VC.CODFILIAL=:ICODFILIAL AND VC.CODCLI = :ICODCLI ;

     ICOD = INOVOCOD;

  suspend;
end
^

/* Restore procedure body: ATBUSCAPRECOSP */
ALTER PROCEDURE ATBUSCAPRECOSP(ICODPROD INTEGER,
ICODCONV INTEGER,
ICODEMPCV INTEGER,
ICODFILIALCV SMALLINT,
ICODPLANOPAG INTEGER,
ICODEMPPG INTEGER,
ICODFILIALPG SMALLINT,
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 RETURNS(PRECO NUMERIC(15,5))
 AS
DECLARE VARIABLE iCodTipoMov INTEGER;
  DECLARE VARIABLE iCodEmpTM INTEGER;
  DECLARE VARIABLE iCodFilialTM INTEGER;
  DECLARE VARIABLE iCodCli INTEGER;
  DECLARE VARIABLE iCodEmpCli INTEGER;
  DECLARE VARIABLE iCodFilialCli INTEGER;
BEGIN
  SELECT CODTIPOMOV2,CODEMPT2,CODFILIALT2 FROM SGPREFERE1 WHERE CODEMP=:ICODEMP
         AND CODFILIAL=:ICODFILIAL INTO iCodTipoMov,iCodEmpTM,iCodFilialTM;
  SELECT CODCLI,CODEMPCL,CODFILIALCL FROM ATCONVENIADO WHERE CODCONV=:ICODCONV
         AND CODEMP=:ICODEMPCV AND CODFILIAL=:ICODFILIALCV INTO iCodCli,iCodEmpCli,iCodFilialCli;

  SELECT PRECO FROM VDBUSCAPRECOSP(:ICODPROD,:iCodCli,:iCodEmpCli,:iCodFilialCli,:ICODPLANOPAG,:ICODEMPPG,
    :ICODFILIALPG,:iCodTipoMov,:iCodEmpTM,:iCodFilialTM,:ICODEMP,:ICODFILIAL) INTO PRECO;

  SUSPEND;
END
^

/* Restore procedure body: VDADICITORCRECMERCSP */
ALTER PROCEDURE VDADICITORCRECMERCSP(CODEMP INTEGER,
CODFILIAL SMALLINT,
TICKET INTEGER,
CODEMPOC INTEGER,
CODFILIALOC SMALLINT,
CODORC INTEGER,
COMPONENTES CHAR(1),
SERVICOS CHAR(1),
NOVOS CHAR(1))
 AS
declare variable codemppd integer;
declare variable codfilialpd integer;
declare variable codprod integer;
declare variable coditos integer;
declare variable coditorc integer;
declare variable codprodant integer;
declare variable coditrecmerc integer;
declare variable refprod varchar(20);
declare variable codemptm integer;
declare variable codfilialtm smallint;
declare variable codtipomov integer;
declare variable codempax integer;
declare variable codfilialax smallint;
declare variable codalmox integer;
declare variable precoitorc numeric(15,5);
declare variable qtditorc numeric(15,5);
declare variable codempcl integer;
declare variable codfilialcl smallint;
declare variable codcli integer;
declare variable codemppg integer;
declare variable codfilialpg smallint;
declare variable codplanopag integer;
declare variable gerachamado char(1);
declare variable obsitorc varchar(10000);
declare variable descprod char(100);
declare variable vlrliqitorc numeric(15,5);
declare variable vlrproditorc numeric(15,5);
declare variable usaprecopecaserv char(1);
declare variable codprodpeca integer;
declare variable garantia char(1);
declare variable codprodir integer;
declare variable refprodir varchar(20);
begin
    
    -- Buscando preferencias do GMS
    select coalesce(p8.usaprecopecaserv,'N') from sgprefere8 p8
    where p8.codemp=:codemp and p8.codfilial=:codfilial
    into :usaprecopecaserv;

    -- Buscando informações do orçamento
    select codempcl, codfilialcl, codcli, codemppg, codfilialpg, codplanopag, codemptm, codfilialtm, codtipomov
    from vdorcamento
    where codemp=:codempoc and codfilial=:codfilialoc and codorc=:codorc and tipoorc='O'
    into :codempcl, :codfilialcl, :codcli, :codemppg, :codfilialpg, :codplanopag, :codemptm, :codfilialtm, :codtipomov;

    -- Sendo um orçamento para peças e mão-de-obra
    -- Deve gerar orçamento dos ítens de suplemento
    for select ir.codemppd, ir.codfilialpd, ir.codprodpd, ir.refprodpd, ir.coditrecmerc, ir.coditos, ir.qtditos,
        ir.gerachamado, pd.descprod, irm.codprod, irm.garantia, irm.codprod codprodir, irm.refprod refprodir
        from eqitrecmercitos ir, eqitrecmerc irm, eqproduto pd
        where
        irm.codemp=ir.codemp and irm.codfilial=ir.codfilial and irm.ticket=ir.ticket and irm.coditrecmerc=ir.coditrecmerc
        and pd.codemp=irm.codemppd and pd.codfilial=irm.codfilialpd and irm.codprod=pd.codprod
        and ir.codemp=:codemp and ir.codfilial=:codfilial and ir.ticket=:ticket and
        -- Filtrando componentes e serviços
        (
           (ir.gerarma=:componentes and ir.gerarma='S') or
           (ir.gerachamado=:servicos and ir.gerachamado='S') or
           (ir.geranovo=:novos and ir.geranovo='S')
        )

        into :codemppd, :codfilialpd, :codprod, :refprod, :coditrecmerc, :coditos, :qtditorc,
             :gerachamado, :descprod, :codprodpeca, :garantia, :codprodir, :refprodir
        do
        begin

--            if(:codprod <> :codprodant or :codprodant is null) then
--            begin

                -- Verifica se é serviço, sendo serviço insere a descriçao do produto
                -- consertado na descrição auxiliar do item de orçamento
                if(:gerachamado=:servicos and :gerachamado='S') then
                begin
                    if( 'N' = :garantia ) then
                    begin
                        obsitorc = :refprodir || ' - ' || :descprod;
                    end
                    else
                    begin
                        obsitorc = :refprodir || ' - ' || :descprod || '[G]';
                    end

                end

                --Buscando código do item de orçamento
                select coalesce(max(coditorc)+1,1) from vditorcamento io
                where io.codemp=:codempoc and io.codfilial=:codfilialoc and io.codorc=:codorc and io.tipoorc='O'
                into :coditorc;

                -- Buscando preço de venda
                -- Se não está em garantia...

                if('N' = :garantia) then
                begin
                    -- Se o preço é basedo na peca, deve buscar o preço da peça
                    if(usaprecopecaserv='S') then
                    begin
                        select preco from vdbuscaprecosp(:codprodpeca,:codcli,:codempcl,:codfilialcl,
                        :codplanopag,:codemppg,:codfilialpg,:codtipomov,:codemptm,:codfilialtm,:codemp,:codfilial)
                        into :precoitorc;
                    end
                    else
                    begin
                        select preco from vdbuscaprecosp(:codprod,:codcli,:codempcl,:codfilialcl,
                        :codplanopag,:codemppg,:codfilialpg,:codtipomov,:codemptm,:codfilialtm,:codemp,:codfilial)
                        into :precoitorc;
                    end
                end
                else
                begin

                    precoitorc = 0.00;

                end

                -- Buscando informações do produto
                select pd.codempax, pd.codfilialax, pd.codalmox, pd.refprod from eqproduto pd
                where pd.codemp=:codemppd and pd.codfilial=:codfilialpd and pd.codprod=:codprod
                into :codempax, :codfilialax, :codalmox, :refprod;

                vlrproditorc = :qtditorc * :precoitorc;
                vlrliqitorc = vlrproditorc;

                -- Inserir itens
                insert into vditorcamento (
                codemp, codfilial, codorc, tipoorc, coditorc,
                codemppd, codfilialpd, codprod, refprod,
                qtditorc, precoitorc, codempax, codfilialax, codalmox, obsitorc, vlrproditorc, vlrliqitorc, sitproditorc)
                values (:codempoc, :codfilialoc, :codorc, 'O', :coditorc,
                :codemppd, :codfilialpd, :codprod, :refprod,
                :qtditorc, :precoitorc, :codempax, :codfilialax, :codalmox, :obsitorc, :vlrproditorc, :vlrliqitorc,
                'PE') ;

                -- Inserindo vínculo entre item de orçamento e ordem de serviço

                insert into eqitrecmercitositorc(codemp, codfilial, ticket, coditrecmerc, coditos, codempoc, codfilialoc, codorc, coditorc, tipoorc)
                values(:codemp,:codfilial,:ticket,:coditrecmerc,:coditos, :codempoc,:codfilialoc,:codorc,:coditorc,'O');

                codprodant = codprod;

--            end
        end

        -- Atualizando o status da ordem de serviço
        update eqrecmerc rm set rm.status = 'EO'
        where rm.codemp=:codemp and rm.codfilial=:codfilial and rm.ticket=:ticket;

end
^

/* Alter exist trigger... */
ALTER TRIGGER CPITCOMPRATGAD
as

declare variable ddtcompra date;
declare variable cflag char(1);
declare variable idoccompra integer;
declare variable icodemptm integer;
declare variable scodfilialtm smallint;
declare variable icodtipomov integer;

begin

    -- Se não estifver em manutenção...
    if ( not ( (old.emmanut='S') and (old.emmanut is not null) ) ) then
    begin

        -- Atualizando cabeçalho da compra
        update cpcompra cp set
            cp.vlrdescitcompra = cp.vlrdescitcompra - old.vlrdescitcompra,
            cp.vlrprodcompra = cp.vlrprodcompra - old.vlrproditcompra,
            cp.vlrbaseicmscompra = cp.vlrbaseicmscompra - old.vlrbaseicmsitcompra,
            cp.vlricmscompra = cp.vlricmscompra - old.vlricmsitcompra,
            -- Icms substituição tributária
            cp.vlrbaseicmsstcompra = coalesce(cp.vlrbaseicmsstcompra,0) - coalesce(old.vlrbaseicmsstitcompra,0),
            cp.vlricmsstcompra = coalesce(cp.vlricmsstcompra,0) - coalesce(old.vlricmsstitcompra,0),

            cp.vlrisentascompra = cp.vlrisentascompra - old.vlrisentasitcompra,
            cp.vlroutrascompra = cp.vlroutrascompra - old.vlroutrasitcompra,
            cp.vlrbaseipicompra = cp.vlrbaseipicompra - old.vlrbaseipiitcompra,
            cp.vlripicompra = cp.vlripicompra - old.vlripiitcompra,
            cp.vlrliqcompra = cp.vlrliqcompra - old.vlrliqitcompra,
            cp.vlrfunruralcompra = cp.vlrfunruralcompra - old.vlrfunruralitcompra,
            cp.vlrfretecompra = cp.vlrfretecompra - old.vlrfreteitcompra,
            cp.vlradiccompra = cp.vlradiccompra - old.vlradicitcompra
        where codcompra=old.codcompra and codemp=old.codemp and codfilial=old.codfilial;

        -- Buscando informações do cabeçaho da compra
        select c.dtentcompra, c.flag, c.doccompra, c.codemptm, c.codfilialtm, c.codtipomov
        from cpcompra c
        where c.codcompra=old.codcompra and c.codemp=old.codemp and c.codfilial=old.codfilial
        into :ddtcompra, :cflag, :idoccompra, :icodemptm, :scodfilialtm, :icodtipomov;

        -- Atualizando movimentação de estoque
        execute procedure eqmovprodiudsp('D', old.codemppd, old.codfilialpd, old.codprod,
        old.codemple, old.codfilialle, old.codlote, :icodemptm, :scodfilialtm, :icodtipomov,
        null, null, null, old.codemp, old.codfilial, old.codcompra, old.coditcompra,
        null, null, null, null, null, null, null, null, null, null, null, null, null, null, old.codempnt,
        old.codfilialnt, old.codnat, :ddtcompra, :idoccompra, :cflag, old.qtditcompra, old.custoitcompra,
        old.codempax, old.codfilialax, old.codalmox, null, 'S', old.tiponfitcompra);

    end

end
^

/* Alter exist trigger... */
ALTER TRIGGER CPITCOMPRATGAI
as
    declare variable dtcompra date;
    declare variable flag char(1);
    declare variable doccompra integer;
    declare variable codemptm integer;
    declare variable codfilialtm smallint;
    declare variable codtipomov integer;
    declare variable calctrib char(1);

begin

    -- Buscando informações do cabeçalho da compra
    select c.dtentcompra, c.flag, c.doccompra, c.codemptm, c.codfilialtm, c.codtipomov, calctrib
    from cpcompra c
    where c.codcompra = new.codcompra and c.codemp = new.codemp and c.codfilial = new.codfilial
    into :dtcompra, :flag, :doccompra, :codemptm, :codfilialtm, :codtipomov, :calctrib;

    -- Executando procedure para movimentação de produto
    execute procedure eqmovprodiudsp (
        'I', new.codemppd, new.codfilialpd, new.codprod, new.codemple, new.codfilialle, new.codlote,
        :codemptm, :codfilialtm, :codtipomov, null, null, null, new.codemp, new.codfilial, new.codcompra, new.coditcompra,
        null, null, null, null, null, null, null, null, null, null, null, null, null, null, new.codempnt, new.codfilialnt, new.codnat,
        :dtcompra, :doccompra, :flag, new.qtditcompra, new.custoitcompra, new.codempax, new.codfilialax, new.codalmox, null, 'S', new.tiponfitcompra
    );

    -- Executa procedure de geração de tabela de vinculo para numeros de serie

    execute procedure cpitcompraseriesp('I', new.codemp, new.codfilial, new.codcompra, new.coditcompra, new.codemppd, new.codfilialpd, new.codprod, new.numserietmp, new.qtditcompra);

    -- Gerando tabela de informações fiscais adicionais (lfitcompra)
    if(calctrib='S') then
    begin
       -- Inserindo registros na tabela de informações fiscais complementares (LFITCOMPRA)
        execute procedure lfgeralfitcomprasp(new.codemp, new.codfilial, new.codcompra, new.coditcompra);
    end

    -- Atualizando cabeçalho da compra

    update cpcompra cp set
    cp.vlrfretecompra = cp.vlrfretecompra + new.vlrfreteitcompra,
    cp.vlradiccompra = cp.vlradiccompra + new.vlradicitcompra
    where cp.codcompra=new.codcompra and cp.codemp=new.codemp and cp.codfilial=new.codfilial;


end
^

/* Alter exist trigger... */
ALTER TRIGGER CPITCOMPRATGAU
as

declare variable ddtcompra date;
declare variable cflag char(1);
declare variable idoccompra integer;
declare variable icodemptm integer;
declare variable scodfilialtm smallint;
declare variable icodtipomov integer;
declare variable calctrib char(1);
declare variable codimp integer;

begin
    -- Se não estiver em manutenção...
    if ( not ( (new.emmanut='S') or ( (old.emmanut='S') and (old.emmanut is not null) ) ) ) then
    begin
        -- Buscando informações da compra
        select c.dtentcompra, c.flag, c.doccompra, c.codemptm, c.codfilialtm, c.codtipomov, c.calctrib, c.codimp
        from cpcompra c
        where c.codcompra = new.codcompra and c.codemp=new.codemp and c.codfilial = new.codfilial
        into :ddtcompra, :cflag, :idoccompra, :icodemptm, :scodfilialtm, :icodtipomov, :calctrib, :codimp;

        if(:codimp is null) then
        begin
            -- Atualizando cabeçalho da compra (não atualiza frete para não entrar em loop);
            update cpcompra cp set
                cp.vlrdescitcompra = cp.vlrdescitcompra -old.vlrdescitcompra + new.vlrdescitcompra,
                cp.vlrprodcompra = cp.vlrprodcompra - old.vlrproditcompra + new.vlrproditcompra,
                cp.vlrbaseicmscompra = cp.vlrbaseicmscompra - old.vlrbaseicmsitcompra + new.vlrbaseicmsitcompra,
                cp.vlricmscompra = cp.vlricmscompra -old.vlricmsitcompra + new.vlricmsitcompra,
                -- Icms substituição tributária
                cp.vlrbaseicmsstcompra = cp.vlrbaseicmsstcompra - old.vlrbaseicmsstitcompra + new.vlrbaseicmsstitcompra,
                cp.vlricmsstcompra = cp.vlricmsstcompra -old.vlricmsstitcompra + new.vlricmsstitcompra,
                
                cp.vlrisentascompra = cp.vlrisentascompra - old.vlrisentasitcompra + new.vlrisentasitcompra,
                cp.vlroutrascompra = cp.vlroutrascompra - old.vlroutrasitcompra + new.vlroutrasitcompra,
                cp.vlrbaseipicompra = cp.vlrbaseipicompra - old.vlrbaseipiitcompra + new.vlrbaseipiitcompra,
                cp.vlripicompra = cp.vlripicompra - old.vlripiitcompra + new.vlripiitcompra,
                cp.vlrliqcompra = cp.vlrliqcompra - old.vlrliqitcompra + new.vlrliqitcompra,
                cp.vlrfunruralcompra = cp.vlrfunruralcompra - old.vlrfunruralitcompra + new.vlrfunruralitcompra
            where cp.codcompra=new.codcompra and cp.codemp=new.codemp and cp.codfilial=new.codfilial and cp.codimp is null;
        end
        else
        begin

            -- Atualizando cabeçalho da compra (atualiza o frete);

            update cpcompra cp set
                cp.vlrdescitcompra = cp.vlrdescitcompra -old.vlrdescitcompra + new.vlrdescitcompra,
                cp.vlrprodcompra = cp.vlrprodcompra - old.vlrproditcompra + new.vlrproditcompra,
                cp.vlrbaseicmscompra = cp.vlrbaseicmscompra - old.vlrbaseicmsitcompra + new.vlrbaseicmsitcompra,
                cp.vlricmscompra = cp.vlricmscompra -old.vlricmsitcompra + new.vlricmsitcompra,
                -- Icms substituição tributária
                cp.vlrbaseicmsstcompra = cp.vlrbaseicmsstcompra - old.vlrbaseicmsstitcompra + new.vlrbaseicmsstitcompra,
                cp.vlricmsstcompra = cp.vlricmsstcompra -old.vlricmsstitcompra + new.vlricmsstitcompra,

                cp.vlrisentascompra = cp.vlrisentascompra - old.vlrisentasitcompra + new.vlrisentasitcompra,
                cp.vlroutrascompra = cp.vlroutrascompra - old.vlroutrasitcompra + new.vlroutrasitcompra,
                cp.vlrbaseipicompra = cp.vlrbaseipicompra - old.vlrbaseipiitcompra + new.vlrbaseipiitcompra,
                cp.vlripicompra = cp.vlripicompra - old.vlripiitcompra + new.vlripiitcompra,
                cp.vlrliqcompra = cp.vlrliqcompra - old.vlrliqitcompra + new.vlrliqitcompra,
                cp.vlrfunruralcompra = cp.vlrfunruralcompra - old.vlrfunruralitcompra + new.vlrfunruralitcompra,
                cp.vlrfretecompra = cp.vlrfretecompra - old.vlrfreteitcompra + new.vlrfreteitcompra,
                cp.vlradiccompra = cp.vlradiccompra - old.vlradicitcompra + new.vlradicitcompra
            where cp.codcompra=new.codcompra and cp.codemp=new.codemp and cp.codfilial=new.codfilial and cp.codimp is not null;

        end

        -- Atualizando movimentação de estoque
        execute procedure eqmovprodiudsp('U', new.codemppd, new.codfilialpd, new.codprod,
        new.codemple, new.codfilialle, new.codlote, :icodemptm, :scodfilialtm, :icodtipomov, null, null, null,
        new.codemp, new.codfilial, new.codcompra, new.coditcompra, null, null, null, null, null, null, null, null,
        null, null, null, null, null, null, new.codempnt, new.codfilialnt, new.codnat, :ddtcompra, :idoccompra, :cflag,
        new.qtditcompra, new.custoitcompra, new.codempax, new.codfilialax, new.codalmox, null, 'S', new.tiponfitcompra);

        -- Executa procedure para atualização de tabela de vinculo para numeros de serie
        execute procedure cpitcompraseriesp('U', old.codemp, old.codfilial, old.codcompra, old.coditcompra, old.codemppd, old.codfilialpd, old.codprod, new.numserietmp, new.qtditcompra);

        -- Gerando tabela de informações fiscais adicionais (lfitcompra)
        if(calctrib='S') then
        begin
           -- Inserindo registros na tabela de informações fiscais complementares (LFITCOMPRA)
            execute procedure lfgeralfitcomprasp(new.codemp, new.codfilial, new.codcompra, new.coditcompra);
        end


    end

end
^

/* Alter exist trigger... */
ALTER TRIGGER CPITIMPORTACAOTGBU
as
    declare variable cotacao        decimal(15,5);

begin

  if (new.emmanut is null) then
     new.emmanut='N';
  if ( not ( (new.emmanut='S') or ( (old.emmanut='S') and (old.emmanut is not null)) ) ) then
  begin

    -- Atualizando log
    new.DTALT=cast('now' AS DATE);
    new.IDUSUALT=USER;
    new.HALT = cast('now' AS TIME);

    -- Buscando informações do cabeçalho
    select imp.cotacaomoeda
    from cpimportacao imp where imp.codemp=new.codemp and imp.codfilial=new.codfilial and imp.codimp=new.codimp
    into :cotacao;

    -- Calculando VMLE e VMLD

    new.vmlemi      =  ( new.qtd         *       new.precomi ) + new.vlrthcmi ;
    new.vmldmi      =   new.vmlemi       +       new.vlrfretemi;
    new.vlradmi     =   new.vmldmi       ;
    new.vlrvmcv     =  ( new.qtd         *       new.precomi ) + new.vlrfretemi ;

    -- Calculando valores em moeda corrente
    new.preco       =   new.precomi     *       :cotacao;
    new.vmle        =   new.vmlemi      *       :cotacao;
    new.vmld        =   new.vmldmi      *       :cotacao;
    new.vlrfrete    =   new.vlrfretemi  *       :cotacao;
    new.vlrseguro   =   new.vlrseguromi *       :cotacao;
    new.vlrthc      =   new.vlrthcmi    *       :cotacao;
    new.vlrad       =   new.vlradmi     *       :cotacao;

    -- Calculando II

    new.vlrii       =   new.vlrad       *       new.aliqii  /   100.00;

    -- Calculando IPI

    new.vlripi      = ( new.vlrad       +       new.vlrii ) *  ( new.aliqipi /   100.00);

    -- Calculando o ICMS

    new.vlrbaseicms         =  cast ( ( new.vlrad      +       new.vlrcofins      +   new.vlrpis   +     new.vlripi   + new.vlrii + new.vlrtxsiscomex + new.vlritdespad ) / (  cast(1.00 as decimal(15,5)) - (new.aliqicmsuf / 100.00) ) as decimal(15,5));

    new.vlricms             =   cast( new.vlrbaseicms *   cast( ( new.aliqicmsuf     / cast(100.00 as decimal(15,5)) ) as decimal(15,5)) as decimal(15,5));

    if(new.percdifericms > 0) then
        new.vlricmsdiferido     =   new.vlricms     *    cast(  ( new.percdifericms  / cast(100.00 as decimal(15,5)) ) as decimal(15,5));
    else
        new.vlricmsdiferido     =   0.00;

    new.vlricmsdevido       =   new.vlricms     -       new.vlricmsdiferido;

    new.vlricmscredpresum   =   cast( new.vlrbaseicms *   cast( ( new.aliqicmsuf  / cast(100.00 as numeric(15,5) ) ) as decimal(15,5) ) as decimal(15,5)) ;
    
    new.vlricmscredpresum   =   new.vlricmscredpresum - new.vlricmsdiferido;

    if (new.perccredpresimp<100) then
    begin
       new.vlricmscredpresum = new.vlricmscredpresum * cast(( new.perccredpresimp / cast(100.00 as numeric(15,5) ) ) as decimal(15,5)) ; 
    end

    new.vlricmsrecolhimento =   new.vlricmsdevido   -   new.vlricmscredpresum;

    -- Gerando o número do sequencial de adição.
    if(old.codncm <> new.codncm) then
    begin
        select coalesce(count(*),0) + 1
        from cpitimportacao
        where codemp=new.codemp and codfilial=new.codfilial and codimp=new.codimp and codncm=new.codncm
        into new.seqadic;
    end
    
  end

end
^

/* Alter exist trigger... */
ALTER TRIGGER EQINVPRODTGAD
AS
begin
  /* Apos a exclusão do inventário */
  EXECUTE PROCEDURE EQMOVPRODIUDSP('D', old.CODEMPPD, old.CODFILIALPD,
     old.CODPROD, old.CODEMPLE, old.CODFILIALLE, old.CODLOTE,
     old.CODEMPTM, old.CODFILIALTM, old.CODTIPOMOV, old.CODEMP,
     old.CODFILIAL, old.CODINVPROD, null, null, null, null,null,
     null, null, null, null, null, null, null, null, null, null, null,
     null, null, null,null,
     null, old.DATAINVP, old.CODINVPROD, 'S', old.QTDINVP, old.PRECOINVP,
     old.CODEMPAX, old.CODFILIALAX, old.CODALMOX, null, 'S', 'N');
end
^

/* Alter exist trigger... */
ALTER TRIGGER EQINVPRODTGAI
AS
BEGIN
  EXECUTE PROCEDURE EQMOVPRODIUDSP('I', new.CODEMPPD, new.CODFILIALPD,
     new.CODPROD, new.CODEMPLE, new.CODFILIALLE, new.CODLOTE,
     new.CODEMPTM, new.CODFILIALTM, new.CODTIPOMOV, new.CODEMP,
     new.CODFILIAL, new.CODINVPROD,  null, null, null, null,
     null, null, null, null, null, null, null, null, null,null,
     null,null,null,null,
     null, null, null, new.DATAINVP, new.CODINVPROD, 'S',
     new.QTDINVP, new.PRECOINVP,
     new.CODEMPAX, new.CODFILIALAX, new.CODALMOX, null, 'S', 'N');
END
^

/* Alter exist trigger... */
ALTER TRIGGER EQINVPRODTGAU
AS
BEGIN
  if ( not ( (new.emmanut='S') or ( (old.emmanut='S') and (old.emmanut is not null) )) ) then
  begin
      EXECUTE PROCEDURE EQMOVPRODIUDSP('U', new.CODEMPPD, new.CODFILIALPD,
         new.CODPROD, new.CODEMPLE, new.CODFILIALLE, new.CODLOTE,
         new.CODEMPTM, new.CODFILIALTM, new.CODTIPOMOV, new.CODEMP,
         new.CODFILIAL, new.CODINVPROD,  null, null, null, null,
         null, null, null, null, null, null, null, null, null,null,null,null,
         null, null, null, null, null, new.DATAINVP, new.CODINVPROD, 'S',
         new.QTDINVP, new.PRECOINVP,
         new.CODEMPAX, new.CODFILIALAX, new.CODALMOX, null, 'S', 'N');
  end
END
^

/* Alter exist trigger... */
ALTER TRIGGER EQITRMATGAD
AS
  DECLARE VARIABLE DDTRMA DATE;
  DECLARE VARIABLE ICODEMPTM INT;
  DECLARE VARIABLE ICODFILIALTM SMALLINT;
  declare VARIABLE ICODTIPOMOV INT ;

  begin
  
      SELECT R.DTAREQRMA,R.codemptm,R.codfilialtm,R.codtipomov
        FROM EQRMA R
        WHERE R.CODRMA = OLD.CODRMA AND R.CODEMP=OLD.CODEMP AND R.CODFILIAL = OLD.CODFILIAL
        INTO :DDTRMA,:ICODEMPTM,:ICODFILIALTM,:ICODTIPOMOV;

      EXECUTE PROCEDURE EQMOVPRODIUDSP('D',OLD.CODEMPPD, OLD.CODFILIALPD, OLD.CODPROD,
        OLD.CODEMPLE, OLD.CODFILIALLE, OLD.codlote, :ICODEMPTM,
        :ICODFILIALTM, :ICODTIPOMOV, null, null, null ,null, null,
        null, null, null, null, null, null,
        null, OLD.CODEMP, OLD.CODFILIAL, OLD.codrma, OLD.coditrma, null, null, null,null,
        null,null,null,null, :DDTRMA, OLD.codrma, 'N', OLD.qtdexpitrma, OLD.precoitrma,
        OLD.CODEMPAX, OLD.CODFILIALAX, OLD.CODALMOX, null, 'S', 'N');
end
^

/* Alter exist trigger... */
ALTER TRIGGER EQITRMATGAI
AS
    declare variable DDTRMA date;
    declare variable ICODEMPTM int;
    declare variable ICODFILIALTM smallint;
    declare variable ICODTIPOMOV int;
    declare variable ICODOP int;
    declare variable QTD decimal(15,5);
    declare variable CBAIXARMAAPROV char(1);

    begin

        select r.dtareqrma,r.codemptm,r.codfilialtm,r.codtipomov,r.codop
            from eqrma r
                where r.codrma=new.codrma and r.codemp=new.codemp and r.codfilial=new.codfilial
        into :DDTRMA,:ICODEMPTM,:ICODFILIALTM,:ICODTIPOMOV,:ICODOP;

        select baixarmaaprov from sgprefere5
            where codemp=new.codemp and codfilial=new.codfilial
        into :CBAIXARMAAPROV;

        if(:CBAIXARMAAPROV='S' AND :ICODOP IS NOT NULL) THEN
        begin
            QTD = new.qtdaprovitrma;
        end
        else
            QTD = new.qtdexpitrma;

        execute procedure eqmovprodiudsp('I',new.CODEMPPD, new.CODFILIALPD, new.CODPROD,
            new.CODEMPLE, new.CODFILIALLE, new.codlote, :ICODEMPTM,:ICODFILIALTM,:ICODTIPOMOV,
            null, null, null ,null, null, null, null, null, null, null, null, null, new.CODEMP,
            new.CODFILIAL, new.codrma, new.coditrma, null, null, null, null,null,null,null,null,
            :DDTRMA, new.codrma, 'N', :QTD, new.precoitrma, new.CODEMPAX,
            new.CODFILIALAX, new.CODALMOX, null, 'S', 'N');
end
^

/* Alter exist trigger... */
ALTER TRIGGER EQITRMATGAU
as
    declare variable icodemptm int;
    declare variable icodfilialtm smallint;
    declare variable icodtipomov int;
    declare variable ddtrma date;
    declare variable baixarmaaprov char(1);
    declare variable estoque char(1);
    declare variable qtdmov numeric(15,5);

begin
    -- Verifica se tabela está em manutenção // caso não esteja inicia procedimentos
    if ( new.emmanut is null) then
        new.emmanut='N';

    if ( not ( (new.emmanut='S') or ( (old.emmanut='S') and (old.emmanut is not null) )) ) then
    begin


        -- Carregando preferências
        select baixarmaaprov from sgprefere5
        where codemp=new.codemp and codfilial=new.codfilial
        into :baixarmaaprov;
    
        qtdmov = new.qtdexpitrma;
    
        if(:baixarmaaprov='S' and new.sitaprovitrma in ('AT','AP')) then
        begin
            estoque = 'S';
            qtdmov = new.qtdaprovitrma;
        end
        else
        begin
            estoque = 'N';
        end
    
    
        -- Carregando informações do cabeçalho (RMA)
        select r.dtareqrma,r.codemptm,r.codfilialtm,r.codtipomov
        from eqrma r
        where r.codrma = new.codrma and r.codemp=new.codemp and r.codfilial = new.codfilial
        into :ddtrma,:icodemptm,:icodfilialtm,:icodtipomov;
    
        -- Movimentação de estoque
        execute procedure eqmovprodiudsp('U',new.codemppd, new.codfilialpd, new.codprod,
            new.codemple, new.codfilialle, new.codlote, :icodemptm,:icodfilialtm, :icodtipomov,
            null, null, null ,null, null,null, null, null, null, null, null, null,
            new.codemp, new.codfilial, new.codrma, new.coditrma, null, null, null, null,
            null, null, null, null, :ddtrma, new.codrma, :estoque, :qtdmov, new.precoitrma,
            new.codempax, new.codfilialax, new.codalmox, null, 'S', 'N' );
    
   end
   
end
^

/* Alter exist trigger... */
ALTER TRIGGER FNITPAGARTGBU
AS
  DECLARE VARIABLE IFILIALPAG INTEGER;
  DECLARE VARIABLE ICODFOR INTEGER;
  DECLARE VARIABLE ICODEMPFR INTEGER;
  DECLARE VARIABLE ICODFILIALFR INTEGER;
  DECLARE VARIABLE CODEMPLC INTEGER;
  DECLARE VARIABLE CODFILIALLC SMALLINT;
  DECLARE VARIABLE CODLANCA INTEGER;
  DECLARE VARIABLE COUNTLANCA INTEGER;
  DECLARE VARIABLE VLRLANCA NUMERIC(15,5);
BEGIN

  new.DTALT=cast('now' AS DATE);
  new.IDUSUALT=USER;
  new.HALT = cast('now' AS TIME);

  IF ( new.EMMANUT IS NULL ) THEN
  BEGIN
      new.EMMANUT = 'N';
  END

  IF ( not ( (new.EMMANUT='S') or ( (old.EMMANUT='S') and (old.EMMANUT is not null)) ) ) THEN
  BEGIN

     if ( (old.edititpag='S') or (new.edititpag is null) ) then
     begin
         new.edititpag = 'N';
     end

     SELECT ICODFILIAL FROM SGRETFILIAL(new.CODEMP,'FNPAGAR') INTO IFILIALPAG;
     IF ((old.STATUSITPAG IN ('PP','PL') )  AND (new.STATUSITPAG='P1') ) THEN
     BEGIN

       IF ( (old.MULTIBAIXA IS NULL) OR (old.MULTIBAIXA='N') ) THEN
       BEGIN        
          DELETE FROM FNSUBLANCA WHERE CODPAG=new.CODPAG AND NPARCPAG=new.NPARCPAG AND 
              CODEMPPG=new.CODEMP AND CODFILIALPG = new.CODFILIAL;
          DELETE FROM FNLANCA WHERE CODPAG=new.CODPAG AND NPARCPAG=new.NPARCPAG AND 
              CODEMPPG=new.CODEMP AND CODFILIALPG = new.CODFILIAL;
       END
       ELSE 
       BEGIN
          SELECT CODEMP, CODFILIAL, CODLANCA FROM FNSUBLANCA
             WHERE CODPAG=new.CODPAG AND NPARCPAG=new.NPARCPAG AND 
                CODEMPPG=new.CODEMP AND CODFILIALPG = new.CODFILIAL 
             INTO :CODEMPLC, :CODFILIALLC, :CODLANCA;
          DELETE FROM FNSUBLANCA WHERE CODPAG=new.CODPAG AND NPARCPAG=new.NPARCPAG AND 
             CODEMPPG=new.CODEMP AND CODFILIALPG = new.CODFILIAL; 
          SELECT VLRLANCA FROM FNLANCA
             WHERE CODEMP=:CODEMPLC AND CODFILIAL=:CODFILIALLC AND CODLANCA=:CODLANCA
             INTO :VLRLANCA;
          IF (:VLRLANCA=0) THEN 
          BEGIN
             DELETE FROM FNLANCA 
             WHERE CODEMP=:CODEMPLC AND CODFILIAL=:CODFILIALLC AND CODLANCA=:CODLANCA;
          END 
       END

       new.VLRPAGOITPAG = 0;
       new.DTPAGOITPAG = NULL;

     END
     ELSE IF ( (old.STATUSITPAG='P1') AND ( new.STATUSITPAG='CP' ) ) THEN
     BEGIN
        IF ( (new.OBSITPAG IS NULL) OR (rtrim(new.OBSITPAG)='') ) THEN
        BEGIN
           EXCEPTION FNITPAGAREX01;
        END
        new.VLRCANCITPAG = new.VLRAPAGITPAG;
        new.VLRPARCITPAG = 0;
        new.VLRDESCITPAG = 0;
        new.VLRJUROSITPAG = 0;
        new.VLRDEVITPAG = 0;
        new.VLRITPAG = 0;
     END

     SELECT ICODFILIAL FROM SGRETFILIAL(new.CODEMP,'FNSUBLANCA') INTO :CODFILIALLC;
     SELECT COUNT (CODLANCA) FROM FNSUBLANCA WHERE CODPAG=new.CODPAG AND NPARCPAG=new.NPARCPAG
           AND CODEMPPG= new.CODEMP AND CODFILIALPG=new.CODFILIAL
           AND CODEMP=new.CODEMP AND CODFILIAL = :CODFILIALLC INTO :COUNTLANCA;

     new.VLRITPAG = new.VLRPARCITPAG - new.VLRDESCITPAG - new.VLRDEVITPAG + new.VLRJUROSITPAG + new.VLRMULTAITPAG + new.VLRADICITPAG;

     IF ( new.STATUSITPAG = 'P1' ) THEN
     BEGIN
         new.VLRAPAGITPAG = new.VLRITPAG - new.VLRPAGOITPAG;
     END
  
     if( :countlanca <= 1 ) then
     begin
         if (new.VLRAPAGITPAG < 0) then /* se o valor a pagar for menor que zero */
           new.VLRAPAGITPAG = 0;  /* então valor a pagar será zero */
         if ( (new.VLRAPAGITPAG=0) AND (new.VLRITPAG>0) ) then /* se o valor a pagar for igual a zero e existir valor na parcela*/
           new.STATUSITPAG = 'PP';  /* então o status será PP(pagamento completo) */
         else if ( (new.VLRPAGOITPAG>0) AND (new.VLRITPAG>0) ) then /* caso contrário e o valor pago maior que zero e existir valor na parcela*/
           new.STATUSITPAG = 'PL'; /*  então o status será PL(pagamento parcial) */
     end

     IF ((old.STATUSITPAG='P1' AND new.STATUSITPAG in ('PP','PL')) OR
            (old.STATUSITPAG in ('PL') AND new.STATUSITPAG in ('PP','PL') AND new.VLRPAGOITPAG > 0) ) THEN
     BEGIN
       /* faz o lançamento */
       SELECT CODFOR,CODEMPFR,CODFILIALFR FROM FNPAGAR WHERE CODEMP=new.CODEMP AND CODFILIAL=new.CODFILIAL AND CODPAG=new.CODPAG
         INTO ICODFOR,ICODEMPFR,ICODFILIALFR;

       if ( (new.multibaixa = 'N') and ((new.edititpag is null) or (new.edititpag='N') ) ) THEN
       BEGIN
           EXECUTE PROCEDURE FNADICLANCASP02(new.CodPag,new.NParcPag,new.NumConta,new.CODEMPCA,new.CODFILIALCA,:ICODFOR,:ICODEMPFR,:ICODFILIALFR,
                              new.CodPlan,new.CODEMPPN,new.CODFILIALPN,new.AnoCC,new.CodCC,new.CODEMPCC,new.CODFILIALCC, new.DTCOMPITPAG,
                              new.DtPagoItPag,new.DocLancaItPag,new.ObsItPag,new.VlrPagoItPag,new.CODEMP,new.CODFILIAL,new.vlrjurositpag,new.vlrdescitpag
                              ,new.codempct, new.codfilialct, new.codcontr, new.coditcontr);
       END

       /* Altera o valor pago e o valor a pagar */
       if ((new.edititpag is null) or (new.edititpag='N')) then
       begin
           new.VLRPAGOITPAG = new.VLRPAGOITPAG + old.VLRPAGOITPAG;
       end

       new.VLRAPAGITPAG = new.VLRITPAG - new.VLRPAGOITPAG;

       if (new.VLRAPAGITPAG < 0) then /* se o valor a pagar for menor que zero */
         new.VLRAPAGITPAG = 0;  /* então valor a pagar será zero */

       if (new.VLRAPAGITPAG=0) then /* se o valor a pagar for igual a zero */
         new.STATUSITPAG = 'PP';  /* então o status será PP(pagamento completo) */
       else if (new.VLRPAGOITPAG>0) then /* caso contrário e o valor pago maior que zero */
         new.STATUSITPAG = 'PL'; /*  então o status será PL(pagamento parcial) */

     END
     ELSE IF (new.VLRPAGOITPAG < 0 )THEN
     BEGIN
         new.VLRPAGOITPAG = new.VLRPAGOITPAG * -1;
         new.VLRAPAGITPAG = new.VLRAPAGITPAG + new.VLRPAGOITPAG;
         new.VLRPAGOITPAG = old.VLRPAGOITPAG - new.VLRPAGOITPAG;
     END
     ELSE IF ((old.STATUSITPAG='PP') AND (new.STATUSITPAG='PP')) THEN
     BEGIN
        EXCEPTION FNPAGAREX01;
     END

     if (new.edititpag='S') then
     begin
        new.edititpag='N';
     end

   END
   
   
END
^

/* Alter exist trigger... */
ALTER TRIGGER FNITRECEBERTGAU
AS
  DECLARE VARIABLE ICODCLI INTEGER;
  DECLARE VARIABLE ICODEMPCL INTEGER;
  DECLARE VARIABLE ICODFILIALCL INTEGER;
  DECLARE VARIABLE SCODFILIALCI SMALLINT;
  DECLARE VARIABLE CODFILIALLC SMALLINT;
  DECLARE VARIABLE CODEMPLC INTEGER;
  DECLARE VARIABLE CODLANCA INTEGER;
  DECLARE VARIABLE VLRLANCA NUMERIC(15,5);
  DECLARE VARIABLE ESTITRECALTDTVENC CHAR(1);
  DECLARE VARIABLE AUTOBAIXAPARC CHAR(1);
  DECLARE VARIABLE PERMITBAIXAPARCJDM CHAR(1);
BEGIN
  IF ( not ( (new.EMMANUT='S') or ( (old.EMMANUT='S') and (old.EMMANUT is not null)) ) ) THEN
  BEGIN

     SELECT ESTITRECALTDTVENC, PERMITBAIXAPARCJDM FROM SGPREFERE1 WHERE CODEMP=new.CODEMP AND CODFILIAL=new.CODFILIAL INTO :ESTITRECALTDTVENC, :PERMITBAIXAPARCJDM;
     SELECT ITPP.AUTOBAIXAPARC FROM FNPARCPAG ITPP, FNRECEBER R
       WHERE ITPP.CODEMP=R.CODFILIALPG AND ITPP.CODFILIAL=R.CODFILIALPG AND ITPP.CODPLANOPAG=R.CODPLANOPAG AND
         ITPP.NROPARCPAG=new.NPARCITREC AND
          R.CODEMP=new.CODEMP AND R.CODFILIAL=new.CODFILIAL AND R.CODREC=new.CODREC
       INTO :AUTOBAIXAPARC;
     IF  ( ( (old.STATUSITREC IN ('RP','RL') )  AND (new.STATUSITREC='R1') ) OR
           ( (old.STATUSITREC IN ('RP','RL') )  AND (new.STATUSITREC='RR') ) OR
           ( (ESTITRECALTDTVENC='S') AND (AUTOBAIXAPARC='S') AND
             (old.DTVENCITREC<>new.DTVENCITREC) ) ) THEN
     BEGIN
       SELECT ICODFILIAL FROM SGRETFILIAL(new.CODEMP,'FNCOMISSAO') INTO :SCODFILIALCI;
       SELECT ICODFILIAL FROM SGRETFILIAL(new.CODEMP,'FNLANCA') INTO :CODFILIALLC;
       
       execute procedure fnestornacomissaosp new.codemp, new.codfilial, new.codrec, new.nparcitrec;

       --UPDATE VDCOMISSAO SET STATUSCOMI='C1'
--              WHERE CODREC=new.CODREC AND NPARCITREC=new.NPARCITREC
--              AND CODEMPRC = new.CODEMP AND CODFILIALRC=new.CODFILIAL
--              AND CODEMP=new.CODEMP AND CODFILIAL=:SCODFILIALCI
--              AND STATUSCOMI NOT IN ('CE') AND TIPOCOMI='R';
       
       
              
       IF ( (old.MULTIBAIXA IS NULL) OR (old.MULTIBAIXA='N') ) THEN
       BEGIN        
          DELETE FROM FNSUBLANCA WHERE CODREC=new.CODREC AND NPARCITREC=new.NPARCITREC AND 
             CODEMPRC=new.CODEMP AND CODFILIALRC = new.CODFILIAL;
          DELETE FROM FNLANCA WHERE CODREC=new.CODREC AND NPARCITREC=new.NPARCITREC AND 
             CODEMPRC=new.CODEMP AND CODFILIALRC = new.CODFILIAL;
       END
       ELSE 
       BEGIN
          SELECT CODEMP, CODFILIAL, CODLANCA FROM FNSUBLANCA
             WHERE CODREC=new.CODREC AND NPARCITREC=new.NPARCITREC AND 
                CODEMPRC=new.CODEMP AND CODFILIALRC = new.CODFILIAL 
             INTO :CODEMPLC, :CODFILIALLC, :CODLANCA;
          DELETE FROM FNSUBLANCA WHERE CODREC=new.CODREC AND NPARCITREC=new.NPARCITREC AND 
             CODEMPRC=new.CODEMP AND CODFILIALRC = new.CODFILIAL;
          SELECT VLRLANCA FROM FNLANCA
             WHERE CODEMP=:CODEMPLC AND CODFILIAL=:CODFILIALLC AND CODLANCA=:CODLANCA
             INTO :VLRLANCA;
          IF (:VLRLANCA=0) THEN 
          BEGIN
             DELETE FROM FNLANCA 
             WHERE CODEMP=:CODEMPLC AND CODFILIAL=:CODFILIALLC AND CODLANCA=:CODLANCA;
          END 
       END
     END
     ELSE IF ((old.STATUSITREC='R1' AND new.STATUSITREC in ('RP','RL')) OR
              (old.STATUSITREC='RR' AND new.STATUSITREC in ('RP','RL')) OR
              (old.STATUSITREC in ('RP','RL') AND new.STATUSITREC in ('RP','RL') AND new.VLRPAGOITREC > 0) OR
              (old.STATUSITREC = 'RB' AND new.STATUSITREC = 'RP')) THEN
     BEGIN
        SELECT CODCLI,CODEMPCL,CODFILIALCL FROM FNRECEBER WHERE CODEMP=new.CODEMP AND
           CODFILIAL=new.CODFILIAL AND CODREC=new.CODREC
           INTO ICODCLI,ICODEMPCL,ICODFILIALCL;
        IF ((new.VLRPAGOITREC-old.VLRPAGOITREC) > 0) THEN
        BEGIN
          IF(new.multibaixa is null or new.multibaixa = 'N')THEN
          BEGIN
             EXECUTE PROCEDURE FNADICLANCASP01(new.CodRec,new.NParcItRec,new.PDVITREC,new.NumConta,new.CODEMPCA,new.CODFILIALCA,:ICODCLI,:ICODEMPCL,:ICODFILIALCL,
                        new.CodPlan,new.CODEMPPN,new.CODFILIALPN,new.ANOCC,new.CODCC,new.CODEMPCC,new.CODFILIALCC, new.dtCompItRec, new.DtPagoItRec, 
                        new.DocLancaItRec, SUBSTRING(new.ObsItRec FROM 1 FOR 50),new.VlrPagoItRec-old.VlrPagoItRec,new.CODEMP,new.CODFILIAL,new.vlrjurositrec,new.vlrdescitrec
                        ,new.codempct, new.codfilialct, new.codcontr, new.coditcontr);
          END
        END
        IF (new.STATUSITREC = 'RP') THEN
        BEGIN
            UPDATE VDCOMISSAO SET STATUSCOMI='C2'
               WHERE CODREC=old.CODREC
               AND CODEMPRC=old.CODEMP
               AND CODFILIALRC=old.CODFILIAL
               AND NPARCITREC=old.NPARCITREC
               AND NOT STATUSCOMI IN ('CP','C2')
               AND CODEMP=old.CODEMP;
        END
     END
     ELSE IF (old.VLRCOMIITREC != new.VLRCOMIITREC) THEN
     BEGIN
        EXECUTE PROCEDURE vdgeracomissaosp(new.CODEMP, new.CODFILIAL, new.CODREC,
           new.NPARCITREC, new.VLRCOMIITREC, new.DTVENCITREC);
     END

     IF ( (new.ALTUSUITREC='S') AND ( (old.VLRITREC!=new.VLRITREC) OR
          (old.VLRDESCITREC!=new.VLRDESCITREC) OR (old.VLRMULTAITREC!=new.VLRMULTAITREC) OR
          (old.VLRJUROSITREC!=new.VLRJUROSITREC) OR (old.VLRPARCITREC!=new.VLRPARCITREC) OR
          (old.VLRPAGOITREC!=new.VLRPAGOITREC) OR (old.VLRAPAGITREC!=new.VLRAPAGITREC) ) ) THEN
        UPDATE FNRECEBER SET VLRREC = VLRREC - old.VLRITREC + new.VLRITREC,
            VLRDESCREC = VLRDESCREC - old.VLRDESCITREC + new.VLRDESCITREC,
            VLRMULTAREC = VLRMULTAREC - old.VLRMULTAITREC + new.VLRMULTAITREC,
            VLRJUROSREC = VLRJUROSREC - old.VLRJUROSITREC + new.VLRJUROSITREC,
            VLRDEVREC = VLRDEVREC - old.VLRDEVITREC + new.VLRDEVITREC,
            VLRPARCREC = VLRPARCREC - old.VLRPARCITREC + new.VLRPARCITREC,
            VLRPAGOREC = VLRPAGOREC - old.VLRPAGOITREC + new.VLRPAGOITREC,
            ALTUSUREC = 'S' WHERE CODREC=new.CODREC
           AND CODEMP=new.CODEMP AND CODFILIAL=new.CODFILIAL;
      /* Condição para evitar baixa parcial de títulos com juros, descontos ou multas. */
      IF ( (:PERMITBAIXAPARCJDM='N') AND (new.STATUSITREC='RL') AND ( (new.VLRDESCITREC<>0) OR (new.VLRJUROSITREC<>0) OR (new.VLRMULTAITREC<>0) ) ) THEN
         EXCEPTION FNITRECEBEREX03; 
   END
   
END
^

/* Alter exist trigger... */
ALTER TRIGGER PPOPENTRADATGAD
AS
declare variable preco decimal;
declare variable codemppd integer;
declare variable codfilialpd smallint;
declare variable codprod integer;
declare variable codemple integer;
declare variable codfilialle smallint;
declare variable codlote varchar(20);
declare variable codemptm integer;
declare variable codfilialtm smallint;
declare variable codtipomov integer;
declare variable codempax integer;
declare variable codfilialax smallint;
declare variable codalmox integer;
declare variable codempopm integer;
declare variable codfilialopm smallint;
declare variable codopm integer;
declare variable seqopm smallint;
declare variable qtddistiop decimal(15,5);

begin

    -- Buscando custo do produto acabado
    select sum(pd.custompmprod) from ppitop it, eqproduto pd where it.codemp=old.codemp and it.codfilial=it.codfilial and
    it.codop=old.codop and it.seqop=old.seqop and
    pd.codemp=it.codemppd and pd.codfilial=it.codfilialpd and pd.codprod=it.codprod into :preco;

    -- Buscando informações da OP
    select codemppd, codfilialpd, codprod, codemple, codfilialle, codlote, codemptm, codfilialtm, codtipomov, codempax, codfilialax, codalmox,
    codempopm, codfilialopm, codopm, seqopm, qtddistiop
    from ppop where
    codemp=old.codemp and codfilial=old.codfilial and codop=old.codop and seqop=old.seqop
    into
    :codemppd, :codfilialpd, :codprod, :codemple, :codfilialle, :codlote, :codemptm, :codfilialtm, :codtipomov, :codempax, :codfilialax, :codalmox,
    :codempopm, codfilialopm, :codopm, :seqopm, :qtddistiop;

    execute procedure eqmovprodiudsp('U', :codemppd, :codfilialpd, :codprod,
        :codemple, :codfilialle, :codlote, :codemptm,
        :codfilialtm, :codtipomov, null, null, null ,null, null,
        null, null, null, null, null, null,
        null, null, null, null, null, old.codemp, old.codfilial, old.codop, old.seqop, old.seqent,
        null, null, null,
        old.dtent, old.codop, 'N', 0,:preco,
        :codempax, :codfilialax, :codalmox, null, 'S', 'N' );

   if (:codopm is not null) then
   begin
      execute procedure ppatudistopsp( :codempopm, :codfilialopm, :codopm, :seqopm, :qtddistiop, 0);
   end
end
^

/* Alter exist trigger... */
ALTER TRIGGER PPOPENTRADATGAI
as
declare variable preco numeric;
declare variable qtdest numeric;
declare variable codemppd integer;
declare variable codfilialpd smallint;
declare variable codprod integer;
declare variable codemple integer;
declare variable codfilialle smallint;
declare variable codlote varchar(20);
declare variable codemptm integer;
declare variable codfilialtm smallint;
declare variable codtipomov integer;
declare variable codempax integer;
declare variable codfilialax smallint;
declare variable codalmox integer;
declare variable codempopm integer;
declare variable codfilialopm smallint;
declare variable codopm integer;
declare variable seqopm smallint;
declare variable qtddistiop decimal(15,5);
declare variable seqest integer;
declare variable prodetapas char(1);

begin

    -- Buscando preferências de produção

    select coalesce(p5.prodetapas,'N') from sgprefere5 p5 where p5.codemp=new.codemp and p5.codfilial=new.codfilial
    into :prodetapas;

    -- Buscando informações da OP
    select codemppd, codfilialpd, codprod, codemple, codfilialle, codlote, codemptm, codfilialtm, codtipomov, codempax, codfilialax, codalmox,
    codempopm, codfilialopm, codopm, seqopm, qtddistiop, seqest
    from ppop where codemp=new.codemp and codfilial=new.codfilial and codop=new.codop and seqop=new.seqop
    into
    :codemppd, :codfilialpd, :codprod, :codemple, :codfilialle, :codlote, :codemptm, :codfilialtm, :codtipomov, :codempax, :codfilialax, :codalmox,
    :codempopm, codfilialopm, :codopm, :seqopm, :qtddistiop, :seqest;

    select pe.qtdest from ppestrutura pe
    where pe.codemp=:codemppd and pe.codfilial=:codfilialpd and
    pe.codprod=:codprod and pe.seqest=:seqest into :qtdest;

    if (:codopm is not null) then
    begin
        execute procedure ppatudistopsp( :codempopm, :codfilialopm, :codopm, :seqopm, :qtddistiop, 0);
    end

    -- Se o processo de finalização for em etapas deve gerar movimentação de estoque vinculada ao item de entrada da O.P.
    if( :prodetapas = 'S' ) then
    begin

        -- Buscando custo do produto acabado
        select sum((select ncustompm from eqprodutosp01(it.codemppd,it.codfilialpd,it.codprod,null,null,null)) * it.qtditop ) / op.qtdprevprodop
        from ppitop it, eqproduto pd, ppop op
        where it.codemp=new.codemp and it.codfilial=it.codfilial
        and it.codop=new.codop and it.seqop=new.seqop
        and pd.codemp=it.codemppd and pd.codfilial=it.codfilialpd
        and pd.codprod=it.codprod
        and op.codemp=new.codemp and op.codfilial=new.codfilial and op.codop=new.codop and op.seqop=new.seqop
        group by op.qtdprevprodop
        into :preco;

        execute procedure EQMOVPRODIUDSP('I', :CODEMPPD, :CODFILIALPD, :CODPROD,
        :CODEMPLE, :CODFILIALLE, :codlote, :codemptm,
        :codfilialtm, :codtipomov, null, null, null ,null, null,
        null, null, null, null, null, null,
        null, null, null, null, null,new.codemp, new.codfilial,new.codop, new.seqop, new.seqent,
        null, null,  null, new.dtent, new.codop,
        'S',new.qtdent,cast(:preco as numeric(15,5)),
        :codempax, :codfilialax, :codalmox, null, 'S', 'N' );

        -- Atualizando quantidade final produzida na O.P.
        update ppop op set
        op.qtdfinalprodop=( select sum(et.qtdent) from ppopentrada et
                            where et.codemp=new.codemp and et.codfilial=new.codfilial and et.codop=new.codop and et.seqop=new.seqop
                           )
        where op.codemp=new.codemp and op.codfilial=new.codfilial and op.codop=new.codop and op.seqop=new.seqop;

    end

    if (:CODOPM is not null) then EXECUTE PROCEDURE PPATUDISTOPSP(:CODEMPOPM, :CODFILIALOPM, :CODOPM, :SEQOPM, 0, :QTDDISTIOP);

end
^

/* Alter exist trigger... */
ALTER TRIGGER PPOPSUBPRODTGAD
AS
declare variable preco decimal(15,5);
declare variable codempax integer;
declare variable codfilialax smallint;
declare variable codalmox integer;
declare variable dtestoque date;
begin

    --Buscando almoxarifado do produto
    select codempax, codfilialax, codalmox from eqproduto where codemp=old.codemppd and codfilial=old.codfilialpd and codprod=old.codprod
    into :codempax, :codfilialax, :codalmox;

    -- Buscando custo do produto;
    select ncustompm from eqprodutosp01(old.codemppd,old.codfilialpd,old.codprod,null,null,null)
    into :preco;

    -- Buscando data de finalização da fase
    select coalesce(fs.datafimprodfs,op.dtemitop) from ppopfase fs, ppop op
    where
    op.codemp=fs.codemp and op.codfilial=fs.codfilial and op.codop=fs.codop and op.seqop=fs.seqop and
    fs.codemp=old.codemp and fs.codfilial=old.codfilial and fs.codop=old.codop and fs.seqop=old.seqop and fs.codempfs=old.codempfs
    and fs.codfilialfs=old.codfilialfs and fs.codfase=old.codfase and fs.seqof=old.seqof
    into :dtestoque;

 
   EXECUTE PROCEDURE EQMOVPRODIUDSP('D',old.CODEMPPD, old.CODFILIALPD, old.CODPROD,
        old.CODEMPLE, old.CODFILIALLE, old.codlote, old.codemptm,
        old.codfilialtm, old.codtipomov, null, null, null ,null, null,
        null, null, null, null, null, null,
        null, null, null, null, null, old.codemp, old.codfilial, old.codop, old.seqop, null,
        null, null, null,
        :dtestoque, old.codop, 'N', old.qtditsp,:preco,
        :codempax, :codfilialax, :codalmox, old.seqsubprod, 'S', 'N' );
end
^

/* Alter exist trigger... */
ALTER TRIGGER PPOPSUBPRODTGAI
AS
declare variable dtestoque date;
declare variable preco decimal(15,5);
declare variable codempax integer;
declare variable codfilialax smallint;
declare variable codalmox integer;
begin

    --Buscando almoxarifado do produto
    select codempax, codfilialax, codalmox from eqproduto where codemp=new.codemppd and codfilial=new.codfilialpd and codprod=new.codprod
    into :codempax, :codfilialax, :codalmox;

    -- Buscando custo do produto;
    select ncustompm from eqprodutosp01(new.codemppd,new.codfilialpd,new.codprod,null,null,null)
    into :preco;

    -- Buscando data de finalização da fase
    select coalesce(fs.datafimprodfs,op.dtemitop) from ppopfase fs, ppop op
    where
    op.codemp=fs.codemp and op.codfilial=fs.codfilial and op.codop=fs.codop and op.seqop=fs.seqop and
    fs.codemp=new.codemp and fs.codfilial=new .codfilial and fs.codop=new.codop and fs.seqop=new.seqop and fs.codempfs=new.codempfs
    and fs.codfilialfs=new.codfilialfs and fs.codfase=new.codfase and fs.seqof=new.seqof
    into :dtestoque;

    EXECUTE PROCEDURE EQMOVPRODIUDSP('I',new.CODEMPPD, new.CODFILIALPD, new.CODPROD,
    new.CODEMPLE, new.CODFILIALLE, new.codlote, new.codemptm,
    new.codfilialtm, new.codtipomov, null, null, null ,null, null,
    null, null, null, null, null, null,
    null, null, null, null, null,new.codemp, new.codfilial,new.codop, new.seqop, null,
    null, null,  null, :dtestoque, new.codop,
    'N',0.00,cast(:preco as numeric(15,5)),
    :codempax, :codfilialax, :codalmox, new.seqsubprod, 'S', 'N' );

end
^

/* Alter exist trigger... */
ALTER TRIGGER PPOPSUBPRODTGAU
AS
declare variable preco decimal(15,5);
declare variable codempax integer;
declare variable codfilialax smallint;
declare variable codalmox integer;

begin

    if ( new.qtditsp>0 and (old.dtsubprod is null and new.dtsubprod is not null) ) then
        begin

            --Buscando almoxarifado do produto
            select codempax, codfilialax, codalmox from eqproduto where codemp=new.codemppd and codfilial=new.codfilialpd and codprod=new.codprod
            into :codempax, :codfilialax, :codalmox;

            -- Buscando custo do produto;
            select ncustompm from eqprodutosp01(new.codemppd,new.codfilialpd,new.codprod,null,null,null)
            into :preco;

            execute procedure eqmovprodiudsp('U',new.codemppd, new.codfilialpd, new.codprod,
                new.CODEMPLE, new.CODFILIALLE, new.codlote, new.codemptm,
                new.codfilialtm, new.codtipomov, null, null, null ,null, null,
                null, null, null, null, null, null,null, null, null, null, null,
                new.codemp, new.codfilial,new.codop,new.seqop, null, null, null, null,
                new.dtsubprod , new.codop, 'N', new.qtditsp,:preco,
                :codempax, :codfilialax, :codalmox, new.seqsubprod, 'S', 'N' );
        end
end
^

/* Alter exist trigger... */
ALTER TRIGGER PPOPTGAD
AS
declare variable preco decimal;
begin
  select sum(pd.custompmprod) from ppitop it, eqproduto pd where it.codemp=old.codemp and it.codfilial=it.codfilial and
    it.codop=old.codop and it.seqop=old.seqop and
    pd.codemp=it.codemppd and pd.codfilial=it.codfilialpd and pd.codprod=it.codprod into :preco;

   EXECUTE PROCEDURE EQMOVPRODIUDSP('D',old.CODEMPPD, old.CODFILIALPD, old.CODPROD,
        old.CODEMPLE, old.CODFILIALLE, old.codlote, old.codemptm,
        old.codfilialtm, old.codtipomov, null, null, null ,null, null,
        null, null, null, null, null, null,
        null, null, null, null, null, old.codemp, old.codfilial, old.codop, old.seqop, null,
        null, null, null,
        old.dtfabrop, old.codop, 'N', old.qtdfinalprodop,:preco,
        old.codempax, old.codfilialax, old.codalmox, null, 'S', 'N' );

   if (old.CODOPM is not null) then
      EXECUTE PROCEDURE PPATUDISTOPSP(old.CODEMPOPM, old.CODFILIALOPM, old.CODOPM,
        old.SEQOPM, old.QTDDISTIOP, 0);

end
^

/* Alter exist trigger... */
ALTER TRIGGER PPOPTGAI
as
declare variable preco numeric;
declare variable qtdest numeric;
declare variable prodetapas char(1);
begin

   EXECUTE PROCEDURE PPITOPSP01(new.CODEMP, new.CODFILIAL, new.CODOP, new.SEQOP);

   EXECUTE PROCEDURE ppgeraopcq (new.CODEMP, new.CODFILIAL, new.CODOP, new.SEQOP);

   select sum(pd.custompmprod) from ppitop it, eqproduto pd where it.codemp=new.codemp and
   it.codfilial=it.codfilial and it.codop=new.codop and it.seqop=new.seqop and
   pd.codemp=it.codemppd and pd.codfilial=it.codfilialpd and
   pd.codprod=it.codprod into :preco;

   select pe.qtdest from ppestrutura pe
      where pe.codemp=new.codemppd and pe.codfilial=new.codfilialpd and
      pe.codprod=new.codprod and pe.seqest=new.seqest into :qtdest;

   -- Buscando preferências de produção

   select coalesce(p5.prodetapas,'N') from sgprefere5 p5 where p5.codemp=new.codemp and p5.codfilial=new.codfilial
   into :prodetapas;

   -- Se o processo de finalização não for em etapas deve gerar movimentação de estoque vinculada diretamente a O.P.
   if( :prodetapas = 'N' or :prodetapas is null ) then
   begin

       EXECUTE PROCEDURE EQMOVPRODIUDSP('I',new.CODEMPPD, new.CODFILIALPD, new.CODPROD,
            new.CODEMPLE, new.CODFILIALLE, new.codlote, new.codemptm,
            new.codfilialtm, new.codtipomov, null, null, null ,null, null,
            null, null, null, null, null, null,
            null, null, null, null, null,new.codemp, new.codfilial,new.codop, new.seqop, null,
            null, null,  null, new.dtfabrop, new.codop,
            'N',new.qtdfinalprodop,cast(:preco as numeric(15,5)),
            new.codempax, new.codfilialax, new.codalmox, null, 'S', 'N' );

       if (new.CODOPM is not null) then
          EXECUTE PROCEDURE PPATUDISTOPSP(new.CODEMPOPM, new.CODFILIALOPM, new.CODOPM,
            new.SEQOPM, 0, new.QTDDISTIOP);

   end

end
^

/* Alter exist trigger... */
ALTER TRIGGER PPOPTGAU
as
declare variable preco decimal(15,5);
declare variable codempoc integer;
declare variable codfilialoc smallint;
declare variable tipoorc char(1);
declare variable codorc integer;
declare variable coditorc smallint;
declare variable prodetapas char(1);
declare variable qtdprodorc decimal(15,5);

begin

    if ( not ( (new.emmanut='S') or ( (old.emmanut='S') and (old.emmanut is not null) )) ) then
    begin

        -- Buscando preferências de produção
    
        select coalesce(p5.prodetapas,'N') from sgprefere5 p5 where p5.codemp=new.codemp and p5.codfilial=new.codfilial
        into :prodetapas;
    
        /*Cancelamento de O.P */
        
        if(old.sitop!='CA' and new.sitop = 'CA') then
        begin
    
            /* Cancelamento de movimentação de estoque */
    
            -- Se o processo de finalização não for em etapas deve gerar movimentação de estoque vinculada diretamente a O.P.
            if( :prodetapas = 'N' ) then
            begin
                execute procedure eqmovprodiudsp('D',new.codemppd, new.codfilialpd, new.codprod,
                    new.CODEMPLE, new.CODFILIALLE, new.codlote, new.codemptm,
                    new.codfilialtm, new.codtipomov, null, null, null ,null, null,
                    null, null, null, null, null, null,null, null, null, null, null,
                    new.codemp, new.codfilial,new.codop,new.seqop, null, null, null, null,
                    new.dtfabrop, new.codop, null, new.qtdfinalprodop,:preco,
                    new.codempax, new.codfilialax, new.codalmox, null, 'S', 'N' );
            end
            else
            begin
    
                delete from ppopentrada et where et.codemp=new.codemp and et.codfilial=new.codfilial and et.codop=new.codop and et.seqop=new.seqop;
    
            end
    
            -- Desfazendo vinculos com ítem de orçamento
            delete from ppopitorc oi where oi.codemp=new.codemp and oi.codfilial=new.codfilial
            and oi.codop=new.codop and oi.seqop=new.seqop;
    
            -- Cancelando as RMAs vinculadas
            update eqrma rma set rma.sitrma='CA', rma.motivocancrma='Ordem de produção original cancelada!'
            where rma.codempof=new.codemp and rma.codfilialof=new.codfilial and rma.codop=new.codop and rma.seqop=new.seqop;
    
            -- Excluindo subproducao
            delete from ppopsubprod where codemp=new.codemp and codfilial=new.codfilial and codop=new.codop and seqop = new.seqop;
    
        end
        else if (old.sitop!='FN' and new.sitop='FN') then
        begin
            -- Atualizando status do ítem de orçamento na finalização da OP
            for select oi.codempoc,oi.codfilialoc, oi.tipoorc, oi.codorc, oi.coditorc
            from ppopitorc oi
            where oi.codemp=new.codemp and oi.codfilial=new.codfilial and oi.codop=new.codop and oi.seqop=new.seqop
            into :codempoc, :codfilialoc, :tipoorc, :codorc, :coditorc do
            begin
                update vditorcamento io set io.sitproditorc = 'PD'
                where io.codemp=:codempoc and io.codfilial=:codfilialoc and io.tipoorc=:tipoorc
                and io.codorc=:codorc and io.coditorc=:coditorc;
            end
    
            if( :prodetapas = 'N' ) then
            begin
                -- Buscando custo do produto acabado
               if ( (new.qtdfinalprodop is null) or (new.qtdfinalprodop=0) ) then
               begin
                  preco = 0;
               end
               else
               begin
                   select cast(cast(sum( cast((select cast(ncustompm as decimal(15,5)) 
                   from eqprodutosp01(it.codemppd,it.codfilialpd,it.codprod,null,null,null)) as decimal(15,5)) * it.qtditop ) 
                   as decimal(15,5)) / new.qtdfinalprodop as decimal(15,5))
                       from ppitop it, eqproduto pd
                       where it.codemp=new.codemp and it.codfilial=it.codfilial
                       and it.codop=new.codop and it.seqop=new.seqop
                       and pd.codemp=it.codemppd and pd.codfilial=it.codfilialpd
                       and pd.codprod=it.codprod
                   into :preco;
               end
    
               execute procedure eqmovprodiudsp('U',new.codemppd, new.codfilialpd, new.codprod,
                    new.CODEMPLE, new.CODFILIALLE, new.codlote, new.codemptm,
                    new.codfilialtm, new.codtipomov, null, null, null ,null, null,
                    null, null, null, null, null, null,null, null, null, null, null,
                    new.codemp, new.codfilial,new.codop,new.seqop, null, null, null, null,
                    new.dtfabrop, new.codop, 'N', new.qtdfinalprodop,:preco,
                    new.codempax, new.codfilialax, new.codalmox, null, 'S', 'N' );
    
                -- Buscando quantidade de produto acabado destinado a orçamentos;
                select cast(sum(oo.qtdprod) as decimal(15,5)) from ppopitorc oo
                where oo.codemp=new.codemp and oo.codfilial=new.codfilial and oo.codop=new.codop and oo.seqop=new.seqop
                into :qtdprodorc;
    
                -- Atualizando a quantidade final produzida por item de orçamento;
    
                if(:qtdprodorc is not null and :qtdprodorc > 0 ) then
                begin
    
                    update ppopitorc oo set oo.qtdfinalproditorc = cast( ( cast(cast(oo.qtdprod as decimal(15,5)) /  cast(:qtdprodorc as decimal(15,5) ) as decimal(15,5)) * (cast(new.qtdfinalprodop as decimal(15,5)))) as decimal(15,5) )
                    where oo.codemp=new.codemp and oo.codfilial=new.codfilial and oo.codop=new.codop and oo.seqop=new.seqop;
    
                end
    
            end
            
            else
            begin    --se for em etapas executar a atualização dos itens de RMA
                   execute procedure ppitopsp02(new.codemp, new.codfilial, new.codop, new.seqop);
            end
            
        end
    
        /* Outras ações */
    
        else
        begin
            if (old.qtdprevprodop <> new.qtdprevprodop ) then
            begin
                delete from ppitop
                    where codemp=new.codemp AND codfilial=new.codfilial
                        and codop=new.codop and seqop=new.seqop;
    
                delete from PPOPFASE
                    where codemp=new.codemp and codfilial=new.codfilial
                        and codop=new.codop and seqop=new.seqop;
    
                execute procedure ppitopsp01(new.codemp, new.codfilial, new.codop, new.seqop);
            end
    
            if( (old.qtdfinalprodop <> new.qtdfinalprodop) and (new.qtdfinalprodop>0) ) then
            begin
    
                if( :prodetapas = 'N' ) then
                begin
    
                    -- Buscando custo do produto acabado
                    select cast(sum((select ncustompm from eqprodutosp01(it.codemppd,it.codfilialpd,it.codprod,null,null,null)) * it.qtditop ) / new.qtdfinalprodop as decimal(15,5))
    
                    from ppitop it, eqproduto pd
                    where it.codemp=new.codemp and it.codfilial=it.codfilial
                    and it.codop=new.codop and it.seqop=new.seqop
                    and pd.codemp=it.codemppd and pd.codfilial=it.codfilialpd
                    and pd.codprod=it.codprod
                    into :preco;
    
                    execute procedure eqmovprodiudsp('U',new.codemppd, new.codfilialpd, new.codprod,
                    new.CODEMPLE, new.CODFILIALLE, new.codlote, new.codemptm,
                    new.codfilialtm, new.codtipomov, null, null, null ,null, null,
                    null, null, null, null, null, null,null, null, null, null, null,
                    new.codemp, new.codfilial,new.codop,new.seqop, null, null, null, null,
                    new.dtfabrop, new.codop, 'N', new.qtdfinalprodop,:preco,
                    new.codempax, new.codfilialax, new.codalmox, null, 'S', 'N' );
    
                end
    
                execute procedure ppitopsp02(new.codemp, new.codfilial, new.codop, new.seqop);
    
            end
            if (new.CODOPM is not null) then
                execute procedure ppatudistopsp(new.codempopm, new.codfilialopm, new.codopm,
                    new.seqopm, old.qtddistiop, new.qtddistiop);
    
        end
    end
end
^

/* Alter exist trigger... */
ALTER TRIGGER VDITVENDATGAD
AS
  DECLARE VARIABLE DDTVENDA DATE;
  DECLARE VARIABLE CFLAG CHAR(1);
  DECLARE VARIABLE IDOCVENDA INTEGER;
  DECLARE VARIABLE ICODEMPTM INTEGER;
  DECLARE VARIABLE SCODFILIALTM SMALLINT;
  DECLARE VARIABLE ICODTIPOMOV INTEGER;
  declare variable subtipovenda char(2);
  declare variable estoqtipomovpd char(1);
BEGIN
  IF ( not ( (old.EMMANUT='S') and (old.EMMANUT IS NOT NULL) ) ) THEN
  BEGIN
      estoqtipomovpd = 'S';
      
      UPDATE VDVENDA SET
         VLRPRODVENDA = VLRPRODVENDA - old.VLRPRODITVENDA,
         VLRBASEICMSVENDA = VLRBASEICMSVENDA - old.VLRBASEICMSITVENDA,
         VLRICMSVENDA = VLRICMSVENDA -old.VLRICMSITVENDA,
         VLRISENTASVENDA = VLRISENTASVENDA - old.VLRISENTASITVENDA,
         VLROUTRASVENDA = VLROUTRASVENDA - old.VLROUTRASITVENDA,
         VLRBASEIPIVENDA = VLRBASEIPIVENDA - old.VLRBASEIPIITVENDA,
         VLRIPIVENDA = VLRIPIVENDA - old.VLRIPIITVENDA,
         VLRLIQVENDA = VLRLIQVENDA - old.VLRLIQITVENDA,
         VLRCOMISVENDA = VLRCOMISVENDA - old.VLRCOMISITVENDA,
         VLRBASEISSVENDA = VLRBASEISSVENDA - old.VLRBASEISSITVENDA,
         VLRISSVENDA = VLRISSVENDA - old.VLRISSITVENDA,
         VLRDESCITVENDA = VLRDESCITVENDA - old.VLRDESCITVENDA,
         VLRBASEICMSSTVENDA = VLRBASEICMSSTVENDA - OLD.vlrbaseicmsstitvenda,
         VLRICMSSTVENDA = VLRICMSSTVENDA - OLD.vlricmsstitvenda,
         VLRBASECOMIS = VLRBASECOMIS - OLD.vlrbasecomisitvenda
         WHERE CODVENDA=old.CODVENDA AND TIPOVENDA=old.TIPOVENDA AND
         CODEMP=old.CODEMP AND CODFILIAL=old.CODFILIAL;
         
      SELECT V.DTEMITVENDA, V.FLAG, V.DOCVENDA,
          V.CODEMPTM, V.CODFILIALTM, V.CODTIPOMOV, V.SUBTIPOVENDA
       FROM VDVENDA V  WHERE V.CODVENDA = old.CODVENDA AND
          V.CODEMP=old.CODEMP AND V.CODFILIAL = old.CODFILIAL AND
          V.TIPOVENDA=old.TIPOVENDA
      INTO :DDTVENDA, :CFLAG, :IDOCVENDA, :ICODEMPTM, :SCODFILIALTM, :ICODTIPOMOV, :subtipovenda;
      
      if ( (subtipovenda is not null) and (subtipovenda='NC') ) then
         estoqtipomovpd = 'N';
         
      EXECUTE PROCEDURE EQMOVPRODIUDSP('D', old.CODEMPPD, old.CODFILIALPD,
         old.CODPROD, old.CODEMPLE, old.CODFILIALLE, old.CODLOTE,
         :ICODEMPTM, :SCODFILIALTM, :ICODTIPOMOV, null, null, null,
         null, null, null, null,
         old.CODEMP, old.CODFILIAL, old.TIPOVENDA, old.CODVENDA, old.CODITVENDA,
          null, null, null, null,null,null, null, null, null,
         old.CODEMPNT, old.CODFILIALNT, old.CODNAT, :DDTVENDA,
         :IDOCVENDA, :CFLAG, old.QTDITVENDA, old.PRECOITVENDA,
         old.CODEMPAX, old.CODFILIALAX, old.CODALMOX, null, :estoqtipomovpd, 'N');
      
  END
END
^

/* Alter exist trigger... */
ALTER TRIGGER VDITVENDATGAI
as
    declare variable dtvenda date ;
    declare variable flag char(1);
    declare variable docvenda integer;
    declare variable codemptm integer;
    declare variable codfilialtm smallint;
    declare variable codtipomov integer;
    declare variable preco numeric(15, 5);
    declare variable visualizalucr char(1);
    declare variable custopeps numeric(15, 5);
    declare variable custompm numeric(15, 5);
    declare variable custouc numeric(15, 5);
    declare variable subtipovenda char(2);
    declare variable estoqtipomovpd char(1);

begin
    estoqtipomovpd = 'S';
    
    -- Carregamento de preferencias
    select visualizalucr from sgprefere1 where codemp=new.codemp and codfilial = new.codfilial
    into :visualizalucr;

    -- Carregamento de informações do cabeçalho da venda
    select vd.dtemitvenda, vd.flag, vd.docvenda, vd.codemptm, vd.codfilialtm, vd.codtipomov, vd.subtipovenda
        from eqtipomov tm, vdvenda vd
        where
            tm.codemp=vd.codemptm and tm.codfilial=vd.codfilialtm and tm.codtipomov=vd.codtipomov and
            vd.codemp=new.codemp and vd.codfilial=new.codfilial and vd.tipovenda=new.tipovenda and vd.codvenda=new.codvenda
    into :dtvenda, :flag, :docvenda, :codemptm, :codfilialtm, :codtipomov, :subtipovenda;

    if ( (subtipovenda is not null) and (subtipovenda='NC')) then
       estoqtipomovpd='N';
       
    -- Inicializando preco do item
    if (new.qtditvenda != 0 ) then
        preco = new.vlrliqitvenda/new.qtditvenda;
    else
        preco = new.precoitvenda;

    -- Executando movimentação do estoque
    execute procedure eqmovprodiudsp(
        'I', new.codemppd, new.codfilialpd, new.codprod,new.codemple, new.codfilialle, new.codlote, :codemptm, :codfilialtm,
        :codtipomov, null, null, null, null, null, null, null, new.codemp, new.codfilial, new.tipovenda, new.codvenda, new.coditvenda,
        null, null, null, null,null,null,null, null, null, new.codempnt, new.codfilialnt, new.codnat,:dtvenda, :docvenda, :flag, new.qtditvenda, :preco,
        new.codempax, new.codfilialax, new.codalmox, null, :estoqtipomovpd, 'N'
    );

    -- Salvamento de custos no momento da venda
    if( visualizalucr = 'S' ) then
    begin
        -- Busca do custo da ultima compra;
        select custounit from eqcustoprodsp(new.codemppd, new.codfilialpd, new.codprod,
            new.dtins,'U',new.codempax, new.codfilialax, new.codalmox,'N')
        into :custouc;

        -- Busca do custo médio (MPM)
        select custounit from eqcustoprodsp(new.codemppd, new.codfilialpd, new.codprod,
            new.dtins,'M',new.codempax, new.codfilialax, new.codalmox,'N')
        into :custompm;

        -- Busca do custo peps
        select custounit from eqcustoprodsp(new.codemppd, new.codfilialpd, new.codprod,
            new.dtins,'P',new.codempax, new.codfilialax, new.codalmox,'N')
        into :custopeps;

        -- Inserindo registro na tabela de custos de item de venda
        insert into vditcustovenda (codemp,codfilial,codvenda,tipovenda,coditvenda,vlrprecoultcp, vlrcustompm, vlrcustopeps)
        values (new.codemp,new.codfilial,new.codvenda,new.tipovenda,new.coditvenda,:custouc,:custompm,:custopeps);

    end

     -- Executa procedure de geração de tabela de vinculo para numeros de serie

    execute procedure vditvendaseriesp('I', new.codemp, new.codfilial, new.codvenda, new.tipovenda, new.coditvenda, new.codemppd, new.codfilialpd, new.codprod, new.numserietmp, new.qtditvenda);

    -- Inserindo registros na tabela de informações fiscais complementares (LFITVENDA)

    execute procedure lfgeralfitvendasp(new.codemp, new.codfilial, new.codvenda, new.tipovenda, new.coditvenda);

    -- Inserindo registro na tabela de vinculo entre compras e vendas (devolução)

    if(new.codcompra is not null and new.coditcompra is not null) then
    begin
        insert into cpdevolucao
            (codemp, codfilial, codcompra, coditcompra, qtddev,
             codempvd, codfilialvd, codvenda, tipovenda, coditvenda )
        values
            (new.codempcp, new.codfilialcp, new.codcompra, new.coditcompra,new.qtditvenda,
             new.codemp, new.codfilial,new.codvenda, new.tipovenda, new.coditvenda);
    end

    execute procedure cpgeradevolucaosp (
    new.codempcp,new.codfilialcp, new.codcompra, new.coditcompra, new.codemp, new.codfilial,
    new.codvenda, new.coditvenda, new.tipovenda, new.qtditvenda);

end
^

/* Alter exist trigger... */
ALTER TRIGGER VDITVENDATGAU
AS
  DECLARE VARIABLE DDTVENDA DATE;
  DECLARE VARIABLE CFLAG CHAR(1);
  DECLARE VARIABLE IDOCVENDA INTEGER;
  DECLARE VARIABLE ICODEMPTM INTEGER;
  DECLARE VARIABLE SCODFILIALTM SMALLINT;
  DECLARE VARIABLE ICODTIPOMOV INTEGER;
  DECLARE VARIABLE CSTATUS CHAR(2);
  DECLARE VARIABLE CTIPOPROD varCHAR(2);
  DECLARE VARIABLE NPRECO NUMERIC(15, 5);
  DECLARE VARIABLE visualizalucr CHAR(1);
  DECLARE VARIABLE custopeps NUMERIC(15, 5);
  DECLARE VARIABLE custompm NUMERIC(15, 5);
  DECLARE VARIABLE custouc NUMERIC(15, 5);
  declare variable subtipovenda char(2);
  declare variable estoqtipomovpd char(1);

BEGIN
  
  estoqtipomovpd = 'S';
  select visualizalucr from sgprefere1 where codemp=new.codemp and codfilial = new.codfilial
    into :visualizalucr;

  IF ( not ( (new.EMMANUT='S') or ( (old.EMMANUT='S') and (old.EMMANUT IS NOT NULL) ) ) ) THEN
  BEGIN
      SELECT VD.DTEMITVENDA,VD.DOCVENDA,VD.STATUSVENDA,VD.FLAG,
             VD.CODEMPTM, VD.CODFILIALTM, VD.CODTIPOMOV, VD.SUBTIPOVENDA
        FROM VDVENDA VD
        WHERE VD.CODVENDA = new.CODVENDA AND VD.TIPOVENDA = new.TIPOVENDA
            AND VD.CODEMP=new.CODEMP AND VD.CODFILIAL = new.CODFILIAL
        INTO :DDTVENDA, :IDOCVENDA, :CSTATUS, :CFLAG, :ICODEMPTM,
          :SCODFILIALTM, :ICODTIPOMOV, :SUBTIPOVENDA;
          
      if ( (subtipovenda is not null) and (subtipovenda='NC') ) then
          estoqtipomovpd = 'N';
          
      SELECT TIPOPROD FROM EQPRODUTO WHERE CODPROD=old.CODPROD
             AND CODEMP=old.CODEMPPD AND CODFILIAL = old.CODFILIALPD
         INTO CTIPOPROD;
      if (substr(:CSTATUS,1,1)!='C') then
      BEGIN
        UPDATE VDVENDA SET VLRDESCITVENDA = VLRDESCITVENDA -old.VLRDESCITVENDA + new.VLRDESCITVENDA,
               VLRPRODVENDA = VLRPRODVENDA - old.VLRPRODITVENDA + new.VLRPRODITVENDA,
               VLRBASEICMSVENDA = VLRBASEICMSVENDA - old.VLRBASEICMSITVENDA + new.VLRBASEICMSITVENDA,
               VLRICMSVENDA = VLRICMSVENDA -old.VLRICMSITVENDA + new.VLRICMSITVENDA,
               VLRISENTASVENDA = VLRISENTASVENDA - old.VLRISENTASITVENDA + new.VLRISENTASITVENDA,
               VLROUTRASVENDA = VLROUTRASVENDA - old.VLROUTRASITVENDA + new.VLROUTRASITVENDA,
               VLRBASEIPIVENDA = VLRBASEIPIVENDA - old.VLRBASEIPIITVENDA + new.VLRBASEIPIITVENDA,
               VLRIPIVENDA = VLRIPIVENDA - old.VLRIPIITVENDA + new.VLRIPIITVENDA,
               VLRLIQVENDA = VLRLIQVENDA - old.VLRLIQITVENDA + new.VLRLIQITVENDA,
               VLRCOMISVENDA = VLRCOMISVENDA - old.VLRCOMISITVENDA + new.VLRCOMISITVENDA,
               VLRBASEISSVENDA = VLRBASEISSVENDA - old.VLRBASEISSITVENDA + new.VLRBASEISSITVENDA,
               VLRISSVENDA = VLRISSVENDA - old.VLRISSITVENDA + new.VLRISSITVENDA,
               VLRBASEICMSSTVENDA = VLRBASEICMSSTVENDA - OLD.vlrbaseicmsstitvenda + NEW.vlrbaseicmsstitvenda,
               VLRICMSSTVENDA = VLRICMSSTVENDA - OLD.vlricmsstitvenda + NEW.vlricmsstitvenda,
               vlrbasecomis = vlrbasecomis - old.vlrbasecomisitvenda + new.vlrbasecomisitvenda
               WHERE CODVENDA=new.CODVENDA AND TIPOVENDA=new.TIPOVENDA
               AND CODEMP=new.CODEMP AND CODFILIAL=new.CODFILIAL;
        
        IF (SUBSTR(CSTATUS,1,1) = 'P') THEN
          CSTATUS = 'PV';
        ELSE IF (SUBSTR(CSTATUS,1,1) = 'V') THEN
          CSTATUS = 'VD';
      END
      IF (new.QTDITVENDA = 0) THEN
         NPRECO = new.PRECOITVENDA;
      ELSE
         NPRECO = new.VLRLIQITVENDA/new.QTDITVENDA;
      EXECUTE PROCEDURE EQMOVPRODIUDSP('U',new.CODEMPPD, new.CODFILIALPD, new.CODPROD,
        new.CODEMPLE, new.CODFILIALLE, new.CODLOTE, :ICODEMPTM,
        :SCODFILIALTM, :ICODTIPOMOV, null, null, null ,null, null,
        null, null, new.CODEMP, new.CODFILIAL, new.TIPOVENDA, new.CODVENDA,
        new.CODITVENDA, null, null, null, null,null,null,null, null, null,
        new.CODEMPNT, new.CODFILIALNT,
        new.CODNAT, :DDTVENDA, :IDOCVENDA, :CFLAG, new.QTDITVENDA, :NPRECO,
        new.CODEMPAX, new.CODFILIALAX, new.CODALMOX, null, :estoqtipomovpd, 'N');


       if( visualizalucr = 'S' ) then
       begin

            -- Busca do custo da ultima compra;
            select custounit from eqcustoprodsp(new.codemppd, new.codfilialpd, new.codprod,
                new.dtins,'U',new.codempax, new.codfilialax, new.codalmox,'N')
            into :custouc;

            -- Busca do custo médio (MPM)
            select custounit from eqcustoprodsp(new.codemppd, new.codfilialpd, new.codprod,
                new.dtins,'M',new.codempax, new.codfilialax, new.codalmox,'N')
            into :custompm;

            -- Busca do custo peps
            select custounit from eqcustoprodsp(new.codemppd, new.codfilialpd, new.codprod,
                new.dtins,'P',new.codempax, new.codfilialax, new.codalmox,'N')
            into :custopeps;

            -- Atualizando registro na tabela de custos de item de venda

            update vditcustovenda icv set vlrprecoultcp=:custouc, vlrcustompm=:custompm, vlrcustopeps=:custopeps
                where icv.codemp=new.codemp and icv.codfilial=new.codfilial and icv.codvenda=new.codvenda
                and icv.tipovenda=new.tipovenda and icv.coditvenda=new.coditvenda;

       end

        -- Executa procedure para atualização de tabela de vinculo para numeros de serie
        execute procedure vditvendaseriesp('U', old.codemp, old.codfilial, old.codvenda, old.tipovenda, old.coditvenda, old.codemppd, old.codfilialpd, old.codprod, new.numserietmp, new.qtditvenda);


        -- Atualizando registros na tabela de informações fiscais complementares (LFITVENDA)
        if(new.coditfisc is not null) then
        begin
            execute procedure lfgeralfitvendasp(
            new.codemp, new.codfilial, new.codvenda, new.tipovenda, new.coditvenda);
        end

        -- Atualizando informações referentes à devolução
        execute procedure cpgeradevolucaosp (
        new.codempcp,new.codfilialcp, new.codcompra, new.coditcompra, new.codemp, new.codfilial,
        new.codvenda, new.coditvenda, new.tipovenda, new.qtditvenda);


   END
END
^

/* Alter exist trigger... */
ALTER TRIGGER VDVENDATGBU
AS
  DECLARE VARIABLE ICODFILIAL INTEGER;
  DECLARE VARIABLE ICODITVENDA INTEGER;
  DECLARE VARIABLE iCodTipoMov INTEGER;
  DECLARE VARIABLE sSerie CHAR(4);
  DECLARE VARIABLE credicmssimples CHAR(1);
  DECLARE VARIABLE iCodFilialPref smallint;
  DECLARE VARIABLE dDesc NUMERIC(15, 5);
  DECLARE VARIABLE PERCPISFILIAL NUMERIC(9,2);
  DECLARE VARIABLE PERCCOFINSFILIAL NUMERIC(9,2);
  DECLARE VARIABLE PERCIRFILIAL NUMERIC(9,2);
  DECLARE VARIABLE PERCCSOCIALFILIAL NUMERIC(9,2);
  DECLARE VARIABLE PERCSIMPLESFILIAL NUMERIC(9,2);
  DECLARE VARIABLE VLRPRODITVENDA NUMERIC(15, 5);
  DECLARE VARIABLE QTDITVENDA NUMERIC(9,2);
  DECLARE VARIABLE VLRCOMISITVENDA NUMERIC(15, 5);
  DECLARE VARIABLE VLRDESCITVENDA NUMERIC(15, 5);
  DECLARE VARIABLE PERCCOMISITVENDA NUMERIC(9,2);
  DECLARE VARIABLE SIMPLESFILIAL CHAR(1);
  DECLARE VARIABLE SIMPLESCLI CHAR(1);
  DECLARE VARIABLE PESSOACLI CHAR(1);          
  DECLARE VARIABLE NVLRFRETE NUMERIC(15,5);
  DECLARE VARIABLE CADICFRETEVD CHAR(1);
  DECLARE VARIABLE PERCIT NUMERIC(9,2);
  DECLARE VARIABLE RETENSAOIMP CHAR(1);

BEGIN

  retensaoimp = 'N';

  IF (new.EMMANUT IS NULL) THEN
     new.EMMANUT='N';
  if (new.BLOQVENDA IS NULL) then
     new.BLOQVENDA='N';
  IF ( not ( (new.EMMANUT='S') or ( (old.EMMANUT='S') and (old.EMMANUT is not null)) ) ) THEN
  BEGIN
      if ( ( (old.BLOQVENDA IS  NULL) OR (old.BLOQVENDA='N') ) AND (new.BLOQVENDA='S') )  then
      begin
          new.DTALT=cast('now' AS DATE);
          new.IDUSUALT=user;
          new.HALT=cast('now' AS TIME);
      end
      IF ( (new.DTCOMPVENDA is null) or (old.DTEMITVENDA<>new.DTEMITVENDA)  ) THEN
         new.DTCOMPVENDA=new.DTEMITVENDA;

      SELECT ICODFILIAL FROM SGRETFILIAL(new.CODEMP, 'SGPREFERE1') INTO iCodFilialPref;
      EXECUTE PROCEDURE VDCLIENTEATIVOSP(new.CODEMPCL, new.CODFILIALCL, new.CODCLI);

      if ( ( (old.BLOQVENDA IS NOT NULL AND old.BLOQVENDA='S') or (new.BLOQVENDA='S') ) and coalesce(old.chavenfevenda,'')=coalesce(new.chavenfevenda,'')) then
         EXCEPTION VDVENDAEX07 'ESTA VENDA ESTÁ BLOQUEADA!!!';


      new.DTALT=cast('now' AS DATE);
      new.IDUSUALT=user;
      new.HALT=cast('now' AS TIME);
      SELECT CODFILIALSEL FROM SGCONEXAO WHERE NRCONEXAO=CURRENT_CONNECTION AND
          CONECTADO > 0 INTO ICODFILIAL;
      IF (substr(old.STATUSVENDA,1,1) = 'C' and substr(new.STATUSVENDA,1,1) <> 'C' and old.chavenfevenda=new.chavenfevenda ) THEN
        EXCEPTION VDVENDAEX05;
      IF (substr(old.STATUSVENDA,1,1) = 'D' and substr(old.STATUSVENDA,1,1) <> 'D' and old.chavenfevenda=new.chavenfevenda) THEN
        EXCEPTION VDVENDAEX05 'ESTA VENDA FOI DEVOLVIDA!';
      IF ((SUBSTR(old.STATUSVENDA,1,1) = 'P') AND (SUBSTR(new.STATUSVENDA,1,1) = 'V' ) AND new.IMPNOTAVENDA = 'N') THEN
      BEGIN
        if ( new.subtipovenda = 'NC' ) then
        begin
             SELECT T2.CODTIPOMOV, T2.SERIE FROM EQTIPOMOV T2, EQTIPOMOV T WHERE T2.CODEMP=T.CODEMPTC
               AND T2.CODFILIAL=T.CODFILIALTC AND T2.CODTIPOMOV = T.CODTIPOMOVTC
               AND T.CODEMP=new.CODEMPTM AND T.CODFILIAL=new.CODFILIALTM AND T.CODTIPOMOV=new.CODTIPOMOV
               INTO :iCodTipoMov, :sSerie;
        end
        if ( ( new.subtipovenda <> 'NC') or (iCodTipoMov is null) ) then 
        begin
             SELECT T2.CODTIPOMOV, T2.SERIE FROM EQTIPOMOV T2, EQTIPOMOV T WHERE T2.CODEMP=T.CODEMPTM
               AND T2.CODFILIAL=T.CODFILIALTM AND T2.CODTIPOMOV = T.CODTIPOMOVTM
               AND T.CODEMP=new.CODEMPTM AND T.CODFILIAL=new.CODFILIALTM AND T.CODTIPOMOV=new.CODTIPOMOV
               INTO :iCodTipoMov, :sSerie;
        end
        IF (iCodTipoMov IS NULL) THEN
          SELECT T.CODTIPOMOV, T.SERIE FROM SGPREFERE1 P, EQTIPOMOV T WHERE P.CODEMPTM=T.CODEMP AND
                 P.CODFILIALTM=T.CODFILIAL AND P.CODTIPOMOV = T.CODTIPOMOV
                 AND P.CODEMP=new.CODEMP AND P.CODFILIAL = :iCodFilialPref INTO :iCodTipoMov, :sSerie;
        new.CODTIPOMOV = :iCodTipoMov;
        new.SERIE = :sSerie;
        IF ( ( not (old.IMPNOTAVENDA = 'S') ) AND ( not (new.IMPNOTAVENDA = 'S') ) ) THEN
        BEGIN
            SELECT DOC FROM LFNOVODOCSP(new.Serie,new.CODEMPSE,new.CODFILIALSE) INTO new.DocVenda;
            new.IMPNOTAVENDA = 'S';
        END
      END
      SELECT FISCALTIPOMOV FROM EQTIPOMOV WHERE CODTIPOMOV=new.CODTIPOMOV
             AND CODEMP=new.CODEMP AND CODFILIAL = new.codfilialtm INTO new.FLAG;
      IF (new.FLAG<>'S') THEN
        new.FLAG = 'N';
      SELECT VLRFRETEVD, ADICFRETEVD FROM VDFRETEVD WHERE CODVENDA=old.CODVENDA AND TIPOVENDA=old.TIPOVENDA AND ADICFRETEVD = 'S'
             AND CODEMP=old.CODEMP AND CODFILIAL = old.codfilial INTO new.VLRFRETEVENDA, :CADICFRETEVD;
      IF (new.VLRDESCVENDA IS NULL) THEN
        new.VLRDESCVENDA = 0;
      IF (new.VLRDESCITVENDA IS NULL) THEN
        new.VLRDESCITVENDA = 0;
      IF (new.VLRADICVENDA IS NULL) THEN
        new.VLRADICVENDA = 0;
      IF (new.VLRFRETEVENDA IS NULL) THEN
        new.VLRFRETEVENDA = 0;
      IF (new.VLRPRODVENDA IS NULL) THEN
        new.VLRPRODVENDA = 0;
      IF (new.VLRIPIVENDA IS NULL) THEN
        new.VLRIPIVENDA = 0;
      IF (new.VLRBASEICMSVENDA IS NULL) THEN
        new.VLRBASEICMSVENDA = 0;
      IF (new.VLRDESCITVENDA > 0) THEN
        dDesc = new.VLRDESCITVENDA;
      ELSE
        dDesc = new.VLRDESCVENDA;
      IF (new.VLRBASEICMSSTVENDA IS NULL) THEN
        new.VLRBASEICMSSTVENDA = 0;
      IF (new.VLRICMSSTVENDA IS NULL) THEN
        new.VLRICMSSTVENDA = 0;

      SELECT C.SIMPLESCLI,C.PESSOACLI FROM VDCLIENTE C WHERE C.CODCLI=new.CODCLI AND
        C.CODFILIAL=new.CODFILIALCL AND C.CODEMP=new.CODEMPCL INTO SIMPLESCLI,PESSOACLI;
      SELECT SIMPLESFILIAL,PERCPISFILIAL,PERCCOFINSFILIAL,PERCIRFILIAL,PERCCSOCIALFILIAL,coalesce(PERCSIMPLESFILIAL,0)
        FROM SGFILIAL WHERE CODEMP=new.CODEMP AND CODFILIAL=:ICODFILIAL
        INTO SIMPLESFILIAL,PERCPISFILIAL,PERCCOFINSFILIAL,PERCIRFILIAL,PERCCSOCIALFILIAL,PERCSIMPLESFILIAL;
      IF (SIMPLESFILIAL = 'N') THEN
      BEGIN
        new.VLRIRVENDA = (new.vlrliqvenda/100)*PERCIRFILIAL;
        new.VLRCSOCIALVENDA = (new.vlrliqvenda/100)*PERCCSOCIALFILIAL;
      END
      ELSE
      BEGIN
        new.VLRIRVENDA = 0;
        new.VLRCSOCIALVENDA = 0;

        /*Verifica se deve destacar crédito de icms (simples)*/
        select p1.credicmssimples,p1.retensaoimp from sgprefere1 p1 where p1.codemp=new.codemp and p1.codfilial=:icodfilialpref
        into credicmssimples,retensaoimp;

        if(credicmssimples='S') then
        begin
            new.vlricmssimples = (new.vlrprodvenda/100) * percsimplesfilial ;
            new.percicmssimples = percsimplesfilial;
        end

      END
      if (CADICFRETEVD = 'S') then
         NVLRFRETE = new.VLRFRETEVENDA;
      else
         NVLRFRETE = 0;

      new.VLRLIQVENDA = coalesce(new.VLRPRODVENDA,0)
                      - coalesce(dDesc,0)
                      + coalesce(new.VLRADICVENDA,0)
                      + coalesce(:NVLRFRETE,0)
                      + coalesce(new.VLRIPIVENDA,0)
                      + coalesce(new.vlricmsstvenda,0);

      if (SIMPLESCLI = 'N' AND PESSOACLI = 'J' AND RETENSAOIMP = 'S') then
      begin
        new.VLRLIQVENDA =
             cast(
                (coalesce(new.VLRLIQVENDA,0)) -
                (case when new.calcpisvenda='S' then coalesce(new.vlrpisvenda,0) else 0 end) -
                (case when new.calccofinsvenda='S' then coalesce(new.vlrcofinsvenda,0) else 0 end) -
                (case when new.calcirvenda='S' then coalesce(new.vlrirvenda,0) else 0 end) -
                (case when new.calccsocialvenda='S' then coalesce(new.vlrcsocialvenda,0) else 0 end)
            as numeric(15, 5));
      end

      IF ((substr(old.STATUSVENDA,1,1) IN ('P','V')) AND (substr(new.STATUSVENDA,1,1)='C')) THEN
      BEGIN
          new.VLRDESCITVENDA = 0;
          new.VLRPRODVENDA = 0;
          new.VLRBASEICMSVENDA = 0;
          new.VLRICMSVENDA = 0;
          new.VLRISENTASVENDA = 0;
          new.VLROUTRASVENDA = 0;
          new.VLRBASEIPIVENDA = 0;
          new.VLRIPIVENDA = 0;
          new.VLRLIQVENDA = 0;
          new.VLRCOMISVENDA = 0;
          new.VLRISSVENDA = 0;
          new.VLRBASEISSVENDA = 0;
          new.vlrpisvenda = 0;
          new.vlrcofinsvenda = 0;
          new.vlrirvenda = 0;
          new.vlrcsocialvenda =0;
          new.vlrbaseicmsstvenda=0;
          new.vlricmsstvenda=0;
      END
    /**
       COMISSAO
    **/
      IF ((NOT NEW.VLRCOMISVENDA IS NULL) AND
          (NEW.VLRLIQVENDA > 0) AND
          ((NOT NEW.VLRDESCVENDA = OLD.VLRDESCVENDA) OR (NOT NEW.PERCMCOMISVENDA = OLD.PERCMCOMISVENDA))) then
      BEGIN
        /* Distribuindo a comissao: */
        FOR SELECT CODITVENDA,VLRPRODITVENDA,QTDITVENDA,coalesce(VLRCOMISITVENDA,0),coalesce(vlrdescitvenda,0),
            coalesce(iv.perccomisitvenda,0)
            FROM VDITVENDA IV
            WHERE CODEMP=new.CODEMP AND CODFILIAL=new.CODFILIAL AND CODVENDA=new.CODVENDA and tipovenda=new.tipovenda
            INTO ICODITVENDA,VLRPRODITVENDA,QTDITVENDA,VLRCOMISITVENDA,VLRDESCITVENDA,PERCCOMISITVENDA DO
        BEGIN
          /* Calculo do item.: */
          /* INCLUIDO PARA DISTRIBUIR A COMISSAO MENOS O DESCONTO PROPORCIONALMENTE*/
          PERCIT = 0;
          IF (new.VLRPRODVENDA > 0 AND NOT new.VLRDESCITVENDA > 0 AND new.VLRDESCVENDA > 0) THEN
          BEGIN
            PERCIT = (100*VLRPRODITVENDA) / new.VLRPRODVENDA;
            VLRDESCITVENDA = (new.VLRDESCVENDA  * PERCIT) / 100;
          END
          IF (new.VLRPRODVENDA > 0 AND new.PERCMCOMISVENDA > 0) THEN
          BEGIN
            PERCCOMISITVENDA = new.PERCMCOMISVENDA;
            /* Retira.. */
            new.VLRCOMISVENDA = new.VLRCOMISVENDA - VLRCOMISITVENDA;
            /* Atualiza.. */
            VLRCOMISITVENDA = ((VLRPRODITVENDA - VLRDESCITVENDA) * PERCCOMISITVENDA) / 100;
            /* Adiciona.. */
            new.VLRCOMISVENDA = new.VLRCOMISVENDA + VLRCOMISITVENDA;
          END
          ELSE IF (new.PERCMCOMISVENDA=0) then
          BEGIN
              VLRCOMISITVENDA = 0;
              PERCCOMISITVENDA = 0;
              new.VLRCOMISVENDA = 0;
          END
          UPDATE VDITVENDA SET VLRCOMISITVENDA=:VLRCOMISITVENDA,PERCCOMISITVENDA=:PERCCOMISITVENDA
          WHERE CODITVENDA=:ICODITVENDA AND CODVENDA=new.CODVENDA AND TIPOVENDA=new.TIPOVENDA AND CODEMP=new.CODEMP AND CODFILIAL=new.CODFILIAL;
        END
      END
      /* Calcula o percentual medio da comissao */
      ELSE IF (new.PERCMCOMISVENDA = old.PERCMCOMISVENDA AND new.VLRLIQVENDA > 0) THEN
      begin
        -- new.PERCMCOMISVENDA = (new.VLRCOMISVENDA/new.VLRLIQVENDA)*100.000;
    -- Modificado, pois causava divergencia em vendas geradas a partir de orçamentos.
    if ((new.vlrprodvenda-new.vlrdescvenda)>0) then
    begin
        new.PERCMCOMISVENDA = (new.VLRCOMISVENDA/(new.vlrprodvenda-new.vlrdescvenda)) * 100;
    end
    else
    begin
        new.PERCMCOMISVENDA = 0;
    end
      end

      IF (new.STATUSVENDA = 'V4') THEN
      BEGIN
        new.IMPNOTAVENDA = 'S';
        new.STATUSVENDA = 'V3';
      END
      IF ((new.IMPNOTAVENDA = 'S') AND (old.IMPNOTAVENDA = 'S')) THEN
      BEGIN
        new.DOCVENDA = old.DOCVENDA;
      END
  END

  -- Atualizando o status do documento fiscal para 02 - Documento cancelado, quando nota for cancelado pelo sistema.
  IF (substr(new.STATUSVENDA,1,1) = 'C' and new.sitdoc!='02') THEN
  begin
    new.sitdoc = '02';
  end

  if(old.chavenfevenda is null and new.chavenfevenda is not null) then
  begin
    new.emmanut = 'N';
  end


END
^

/* Alter empty procedure EQMOVPRODCSLDSP with new param-list */
ALTER PROCEDURE EQMOVPRODCSLDSP(ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
NCUSTOMPMMOVPROD NUMERIC(15,5),
NSLDMOVPROD NUMERIC(15,5),
ESTOQTIPOMOVPD CHAR(1),
TIPONF CHAR(1))
 RETURNS(NCUSTOMPM NUMERIC(15,5),
NSALDO NUMERIC(15,5),
CESTOQMOVPROD CHAR(1),
CTIPOMOVPROD CHAR(1),
SOPERADOR SMALLINT)
 AS
 BEGIN EXIT; END
^

/* Alter empty procedure EQMOVPRODDSP with new param-list */
ALTER PROCEDURE EQMOVPRODDSP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
DDTMOVPROD DATE,
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD SMALLINT,
TIPONF CHAR(1))
 AS
 BEGIN EXIT; END
^

/* Alter empty procedure EQMOVPRODISP with new param-list */
ALTER PROCEDURE EQMOVPRODISP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD SMALLINT,
ESTOQTIPOMOVPD CHAR(1),
TIPONF CHAR(1))
 AS
 BEGIN EXIT; END
^

SET TERM ; ^

Update Rdb$Procedure_Parameters set Rdb$Description =
'Sequencial do subproduto'
where Rdb$Procedure_Name='EQMOVPRODISP' and Rdb$Parameter_Name='SEQSUBPROD';

/* Alter empty procedure EQMOVPRODPRCSLDSP with new param-list */
SET TERM ^ ;

ALTER PROCEDURE EQMOVPRODPRCSLDSP(SCODFILIAL SMALLINT,
ICODMOVPROD INTEGER,
ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
DDTMOVPROD DATE,
DDTMOVPRODPRC DATE,
NSLDMOVPROD NUMERIC(15,5),
NCUSTOMPMMOVPROD NUMERIC(15,5),
NSLDMOVPRODAX NUMERIC(15,5),
NCUSTOMPMMOVPRODAX NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
TIPONF CHAR(1))
 RETURNS(NSLDPRC NUMERIC(15,5),
NCUSTOMPMPRC NUMERIC(15,5),
NSLDPRCAX NUMERIC(15,5),
NCUSTOMPMPRCAX NUMERIC(15,5),
ESTOQTIPOMOVPD CHAR(1))
 AS
 BEGIN EXIT; END
^

/* Alter empty procedure EQMOVPRODUSP with new param-list */
ALTER PROCEDURE EQMOVPRODUSP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD BIGINT,
ESTOQTIPOMOVPD CHAR(1),
TIPONF CHAR(1))
 AS
 BEGIN EXIT; END
^

/* Alter Procedure... */
/* Alter (ATATENDIMENTOIUSP) */
ALTER PROCEDURE ATATENDIMENTOIUSP(IU CHAR(1),
CODEMP INTEGER,
CODFILIAL SMALLINT,
CODATENDO INTEGER,
CODEMPTO INTEGER,
CODFILIALTO SMALLINT,
CODTPATENDO INTEGER,
CODEMPAE INTEGER,
CODFILIALAE SMALLINT,
CODATEND INTEGER,
CODEMPSA INTEGER,
CODFILIALSA SMALLINT,
CODSETOR INTEGER,
DOCATENDO INTEGER,
DATAATENDO DATE,
DATAATENDOFIN DATE,
HORAATENDO TIME,
HORAATENDOFIN TIME,
OBSATENDO VARCHAR(10000),
CODEMPCL INTEGER,
CODFILIALCL SMALLINT,
CODCLI INTEGER,
CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
CODCONTR INTEGER,
CODITCONTR SMALLINT,
CODEMPIR INTEGER,
CODFILIALIR SMALLINT,
CODREC INTEGER,
NPARCITREC INTEGER,
CODEMPCH INTEGER,
CODFILIALCH SMALLINT,
CODCHAMADO INTEGER,
OBSINTERNO VARCHAR(10000),
CONCLUICHAMADO CHAR(1),
CODEMPEA INTEGER,
CODFILIALEA SMALLINT,
CODESPEC INTEGER,
CODEMPUS INTEGER,
CODFILIALUS SMALLINT,
IDUSU VARCHAR(128),
STATUSATENDO CHAR(2),
CODEMPTA INTEGER,
CODFILIALTA SMALLINT,
CODTAREFA INTEGER,
CODEMPOC INTEGER,
CODFILIALOC INTEGER,
TIPOORC CHAR(1),
CODORC INTEGER)
 AS
declare variable horaatendors time;
declare variable horaatendofinrs time;
declare variable dataatendors date;
declare variable contorc integer;
BEGIN

  DATAATENDORS = NULL;

  SELECT FIRST 1 A.DATAATENDO, A.HORAATENDO, A.HORAATENDOFIN
    FROM ATATENDIMENTO A
    WHERE A.CODEMP=:CODEMP AND A.CODFILIAL=:CODFILIAL AND
        A.CODEMPAE=:CODEMPAE AND A.CODFILIALAE=:CODFILIALAE AND
        A.CODATEND=:CODATEND AND A.CODATENDO<>:CODATENDO AND
        A.DATAATENDO=:DATAATENDO AND ( (A.HORAATENDO BETWEEN :HORAATENDO+1 AND :HORAATENDOFIN-1 )
        OR (A.HORAATENDOFIN BETWEEN :HORAATENDO+1 AND :HORAATENDOFIN-1 ) )
    INTO :DATAATENDORS, :HORAATENDORS, :HORAATENDOFINRS ;

  if (DATAATENDORS IS NOT NULL) then
  begin
     exception atatendimentoex02 'Jah existe(m) lancamento(s) em '||:dataatendors||' - h.: '||
        :horaatendors||' - '||:horaatendofinrs;
  end

  if (IU = 'I') then
  begin
     SELECT ISEQ FROM SPGERANUM(:CODEMP,:CODFILIAL,'AT') INTO :CODATENDO;
     STATUSATENDO = 'AA';
     INSERT INTO ATATENDIMENTO (
        CODEMP,CODFILIAL,CODATENDO,CODEMPTO,
        CODFILIALTO,CODTPATENDO,CODEMPAE,
        CODFILIALAE,CODATEND,CODEMPSA,CODFILIALSA,
        CODSETAT,STATUSATENDO,
        CODEMPUS,CODFILIALUS, IDUSU,
        DOCATENDO, DATAATENDO,
        DATAATENDOFIN, HORAATENDO, HORAATENDOFIN, OBSATENDO, CODEMPCL, CODFILIALCL, CODCLI, CODEMPCT, CODFILIALCT,
        CODCONTR, CODITCONTR, CODEMPCH, CODFILIALCH, CODCHAMADO, obsinterno, CONCLUICHAMADO,
        CODEMPEA, CODFILIALEA, CODESPEC , CODEMPTA, CODFILIALTA, CODTAREFA )

     VALUES (
        :CODEMP, :CODFILIAL, :CODATENDO,
        :CODEMPTO, :CODFILIALTO, :CODTPATENDO,
        :CODEMPAE, :CODFILIALAE,:CODATEND,
        :CODEMPSA,:CODFILIALSA, :CODSETOR,
        :STATUSATENDO ,
        :CODEMPUS, :CODFILIALUS, lower(:IDUSU),
        :DOCATENDO, :DATAATENDO, :DATAATENDOFIN, :HORAATENDO,
        :HORAATENDOFIN, :OBSATENDO,
        :CODEMPCL, :CODFILIALCL, :CODCLI,
        :CODEMPCT, :CODFILIALCT, :CODCONTR, :CODITCONTR,
        :CODEMPCH, :CODFILIALCH, :CODCHAMADO,
        :OBSINTERNO, :CONCLUICHAMADO,
        :CODEMPEA, :CODFILIALEA, :CODESPEC , :CODEMPTA, :CODFILIALTA, :CODTAREFA
     );
  -- Caso o atendimento tenha vinculo com o contas a receber
     if (CODREC IS NOT NULL AND NPARCITREC IS NOT NULL) then
     begin
        INSERT INTO ATATENDIMENTOITREC (CODEMP,CODFILIAL,CODATENDO,CODEMPIR,CODFILIALIR,CODREC,NPARCITREC) VALUES
                (:CODEMP,:CODFILIAL,:CODATENDO,:CODEMPIR,:CODFILIALIR,:CODREC,:NPARCITREC);
     end

       -- Caso o atendimento tenha vinculo com o contas a receber
     if ( CODORC IS NOT NULL AND TIPOORC IS NOT NULL) then
     begin
        INSERT INTO atatendimentoorc (CODEMP,CODFILIAL,CODATENDO,CODEMPOC,CODFILIALOC,TIPOORC,CODORC) VALUES
                (:CODEMP,:CODFILIAL,:CODATENDO,:CODEMPOC,:CODFILIALOC,:TIPOORC,:CODORC);
     end
  end
  else if (IU = 'U') then
  begin
        UPDATE ATATENDIMENTO SET
            CODATEND=:CODATEND, DATAATENDO=:DATAATENDO, HORAATENDO=:HORAATENDO, DATAATENDOFIN=:DATAATENDOFIN,
            HORAATENDOFIN=:HORAATENDOFIN, OBSATENDO=:OBSATENDO,CODEMPTO=:CODEMPTO, CODFILIALTO=:CODFILIALTO,
            CODTPATENDO=:CODTPATENDO,CODEMPSA=:CODEMPSA, CODFILIALSA=:CODFILIALSA, CODSETAT=:CODSETOR, CODEMPCH=:CODEMPCH,
            CODFILIALCH=:CODFILIALCH, CODCHAMADO=:CODCHAMADO, CODEMPCT=:CODEMPCT, CODFILIALCT=:CODFILIALCT,
            CODCONTR=:CODCONTR, CODITCONTR=:CODITCONTR, STATUSATENDO=:STATUSATENDO, OBSINTERNO=:OBSINTERNO,
            CONCLUICHAMADO=:CONCLUICHAMADO, CODEMPEA=:CODEMPEA, CODFILIALEA=:CODFILIALEA, CODESPEC=:CODESPEC,
            CODEMPTA=:CODEMPTA, CODFILIALTA=:CODFILIALTA, CODTAREFA=:CODTAREFA,
            CODEMPCL=:CODEMPCL, CODFILIALCL=:CODFILIALCL, CODCLI=:CODCLI
        WHERE
            CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL AND CODATENDO=:CODATENDO;

        SELECT COUNT(*) FROM ATATENDIMENTOORC WHERE CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL AND CODATENDO=:CODATENDO
        INTO :CONTORC;

        if ( :CONTORC = 0 AND CODORC IS NOT NULL AND TIPOORC IS NOT NULL) then
        begin
           INSERT INTO atatendimentoorc (CODEMP,CODFILIAL,CODATENDO,CODEMPOC,CODFILIALOC,TIPOORC,CODORC) VALUES
                    (:CODEMP,:CODFILIAL,:CODATENDO,:CODEMPOC,:CODFILIALOC,:TIPOORC,:CODORC);
        end
        
  end
END
^

/* Alter (ATBUSCAPRECOSP) */
ALTER PROCEDURE ATBUSCAPRECOSP(ICODPROD INTEGER,
ICODCONV INTEGER,
ICODEMPCV INTEGER,
ICODFILIALCV SMALLINT,
ICODPLANOPAG INTEGER,
ICODEMPPG INTEGER,
ICODFILIALPG SMALLINT,
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 RETURNS(PRECO NUMERIC(15,5))
 AS
DECLARE VARIABLE iCodTipoMov INTEGER;
  DECLARE VARIABLE iCodEmpTM INTEGER;
  DECLARE VARIABLE iCodFilialTM INTEGER;
  DECLARE VARIABLE iCodCli INTEGER;
  DECLARE VARIABLE iCodEmpCli INTEGER;
  DECLARE VARIABLE iCodFilialCli INTEGER;
BEGIN
  SELECT CODTIPOMOV2,CODEMPT2,CODFILIALT2 FROM SGPREFERE1 WHERE CODEMP=:ICODEMP
         AND CODFILIAL=:ICODFILIAL INTO iCodTipoMov,iCodEmpTM,iCodFilialTM;
  SELECT CODCLI,CODEMPCL,CODFILIALCL FROM ATCONVENIADO WHERE CODCONV=:ICODCONV
         AND CODEMP=:ICODEMPCV AND CODFILIAL=:ICODFILIALCV INTO iCodCli,iCodEmpCli,iCodFilialCli;

  SELECT PRECO FROM VDBUSCAPRECOSP(:ICODPROD,:iCodCli,:iCodEmpCli,:iCodFilialCli,:ICODPLANOPAG,:ICODEMPPG,
    :ICODFILIALPG,:iCodTipoMov,:iCodEmpTM,:iCodFilialTM,:ICODEMP,:ICODFILIAL) INTO PRECO;

  SUSPEND;
END
^

/* Alter (ATRESUMOATENDOSP01) */
ALTER PROCEDURE ATRESUMOATENDOSP01(CODEMPP INTEGER,
CODFILIALP SMALLINT,
CODCLIP INTEGER,
CODEMPCTP INTEGER,
CODFILIALCTP SMALLINT,
CODCONTRP INTEGER,
CODITCONTRP SMALLINT,
DTINIP DATE,
DTFIMP DATE)
 RETURNS(ANO SMALLINT,
MES SMALLINT,
CODEMPCL INTEGER,
CODFILIALCL SMALLINT,
CODCLI INTEGER,
CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
CODCONTR INTEGER,
QTDCONTR DECIMAL(15,5),
DTINICIO DATE,
VALOR DECIMAL(15,5),
VALOREXCEDENTE DECIMAL(15,5),
QTDITCONTR DECIMAL(15,5),
QTDHORAS DECIMAL(15,2),
MESCOB INTEGER,
SALDOMESCOB DECIMAL(15,5),
SALDOMES DECIMAL(15,5),
SALDOPERIODO DECIMAL(15,5),
EXCEDENTEMESCOB DECIMAL(15,5),
EXCEDENTEPERIODO DECIMAL(15,5),
EXCEDENTECOB DECIMAL(15,5),
VALOREXCEDENTECOB DECIMAL(15,5),
VALORTOTALCOB DECIMAL(15,5),
VALORCONTR DECIMAL(15,5),
EXCEDENTEMES DECIMAL(15,5),
TOTFRANQUIAMES DECIMAL(15,5))
 AS
begin
  saldoperiodo = 0;
 -- saldoperiodo2 = 0;
  saldomescob = 0;
  excedentemescob = 0;
  excedenteperiodo = 0;
--  excedenteperiodo2 = 0;
  excedentecob = 0;
  valorexcedentecob = 0;
  valortotalcob = 0;
  -- MES COBRANÇA
  mescob = extract(month from :dtfimp);
  -- DATA DO MÊS ANTERIOR A COBRANÇA
  --dtant = addmonth(:dtfimp, -1);
  -- MES ANTERIOR A COBRANÇA
 -- mesant = extract(month from :dtant);


  for select extract(year from a.dataatendo) ano
   , extract( month from a.dataatendo) mes
   , ct.codempcl, ct.codfilialcl, ct.codcli
   , ct.codemp codempct, ct.codfilial codfilialct, ct.codcontr
   , a.qtdcontr, a.dtinicio
    , avg((select avg(ic.vlritcontr) from vditcontrato ic
     where  ic.codemp=ct.codemp and ic.codfilial=ct.codfilial and ic.codcontr=ct.codcontr
     and coalesce(ic.franquiaitcontr,'N')='S' ) )  valor
   , avg((select avg(ic.vlritcontrexced) from vditcontrato ic
     where  ic.codemp=ct.codemp and ic.codfilial=ct.codfilial and ic.codcontr=ct.codcontr
     and coalesce(ic.franquiaitcontr,'N')='S' ) )  valorexcedente
   , avg((select sum(qtditcontr) from vditcontrato ic
     where  ic.codemp=ct.codemp and ic.codfilial=ct.codfilial and ic.codcontr=ct.codcontr
     and coalesce(ic.franquiaitcontr,'N')='S' ) )  qtditcontr
   , cast(sum(a.totalcobcli) as decimal(15,2)) qtdhoras
    from vdcontrato ct
    left outer join atatendimentovw02 a on
    a.codempcl=ct.codempcl and a.codfilialcl=ct.codfilialcl and a.codcli=ct.codcli
    and a.codempct=ct.codemp and a.codfilialct=ct.codfilial and a.codcontr=ct.codcontr
    and ( :coditcontrp=0 or a.coditcontr=:coditcontrp ) 
    and a.dataatendo between :dtinip  and
    :dtfimp and a.mrelcobespec='S'
    where
     ct.codempcl=:codempp and ct.codfilialcl=:codfilialp and ct.codcli=:codclip
    and ct.codemp=:codempctp and ct.codfilial=:codfilialctp  and ct.codcontr=:codcontrp
    and ct.recebcontr='S' and ct.tpcobcontr in ('ME','BI','AN') and ct.ativo='S'
    group by 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
    order by 1 desc, 2 desc

   into :ano, :mes

   , :codempcl, :codfilialcl, :codcli
   , :codempct, :codfilialct, :codcontr, :qtdcontr, :dtinicio, :valor
   , :valorexcedente, :qtditcontr, :qtdhoras
   do
   begin
       /* Caso não existam lançamentos retornar ano e mês atual */
       if (:ano is null) then
          ano = extract(year from dtfimp);

       if (:mes is null) then
           mes = extract(month from dtfimp);

       -- TOTAL DE FRANQUIA NO MES
       totfranquiames = qtditcontr;

       -- SALDO MÊS
       if( :qtditcontr - :qtdhoras   > 0) then
           saldomes =  qtditcontr - qtdhoras;
       else
           saldomes = 0;

       -- VALOR CONTRATADO
       if (mes=mescob) then
          valorcontr = qtditcontr * valor;

       -- EXCEDENTE MES
       if( :qtdhoras < :qtditcontr ) then
          excedentemes = 0;
       else
          excedentemes = qtdhoras - qtditcontr;

       -- EXCEDENTE MES COBRANÇA
       if( (:qtdhoras > :qtditcontr) and (mes = mescob) ) then
          excedentemescob = excedentemes;

       if (mes=mescob) then
       begin
          --- SALDO DO MÊS DE COBRANÇA
          saldomescob = saldomescob + saldomes;
       end
       else
       begin
         -- SALDO DO PERÍODO
         saldoperiodo = saldoperiodo + saldomes;

         -- EXCEDENTE DO PERÍODO
          excedenteperiodo = excedenteperiodo + excedentemes;

       end 

   end

   -- EXCEDENTE COBRADO
   if( :excedenteperiodo - :saldoperiodo > 0) then
       excedentecob =  excedenteperiodo - saldoperiodo;
   else
       excedentecob = 0;

   if (excedentecob>0) then
      saldoperiodo = 0;

   saldoperiodo = saldoperiodo + saldomescob;
   excedentecob = excedentemescob;

   --VLRTOTAL =$V{QTDITCONTRCALC}.multiply($F{VALOR}).add($V{EXCEDENTECOB}.multiply( $V{VALOREXCEDENTE} ))

   -- VALOR A COBRAR EXCEDENTE
   valorexcedentecob = excedentecob * valorexcedente;
        
   -- VALOR TOTAL A COBRAR
   valortotalcob = (valorcontr) + (excedentecob * valorexcedente);

 -- saldoperiodo2 = 0;
  excedentemescob = 0;
  --excedenteperiodo2 = 0;

  for select extract(year from a.dataatendo) ano
   , extract( month from a.dataatendo) mes
   , ct.codempcl, ct.codfilialcl, ct.codcli
   , ct.codemp codempct, ct.codfilial codfilialct, ct.codcontr
   , a.qtdcontr, a.dtinicio
   , cast(sum(a.totalcobcli) as decimal(15,2)) qtdhoras
    from vdcontrato ct
    left outer join atatendimentovw02 a on
    a.codempcl=ct.codempcl and a.codfilialcl=ct.codfilialcl and a.codcli=ct.codcli
    and a.codempct=ct.codemp and a.codfilialct=ct.codfilial and a.codcontr=ct.codcontr
    and ( :coditcontrp=0 or a.coditcontr=:coditcontrp ) 
    and a.dataatendo between :dtinip  and
    :dtfimp and a.mrelcobespec='S'
    where
     ct.codempcl=:codempp and ct.codfilialcl=:codfilialp and ct.codcli=:codclip
    and ct.codemp=:codempctp and ct.codfilial=:codfilialctp  and ct.codcontr=:codcontrp
    and ct.recebcontr='S' and ct.tpcobcontr in ('ME','BI','AN') and ct.ativo='S'
    group by 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
    order by 1 desc, 2 desc

   into :ano, :mes
   , :codempcl, :codfilialcl, :codcli
   , :codempct, :codfilialct, :codcontr
   , :qtdcontr, :dtinicio, :qtdhoras
   do
   begin
       /* Caso não existam lançamentos retornar ano e mês atual */
       if (:ano is null) then
          ano = extract(year from dtfimp);

       if (:mes is null) then
           mes = extract(month from dtfimp);

       -- TOTAL DE FRANQUIA NO MES
       totfranquiames = qtditcontr;

       -- SALDO MÊS
       if( :qtditcontr - :qtdhoras   > 0) then
           saldomes =  qtditcontr - qtdhoras;
       else
           saldomes = 0;

       -- VALOR CONTRATADO
       valorcontr = qtditcontr * valor;

       -- EXCEDENTE MES
       if( :qtdhoras < :qtditcontr ) then
          excedentemes = 0;
       else
          excedentemes = qtdhoras - qtditcontr;

       -- EXCEDENTE MES COBRANÇA
       if( (:qtdhoras < :qtditcontr)
       --or (mes <> mescob)
       ) then
          excedentemescob = 0;
       else
          excedentemescob = qtdhoras - qtditcontr;

       -- SALDO DO PERÍODO
--       saldoperiodo2 = saldoperiodo2 + saldomes;

       -- EXCEDENTE DO PERÍODO
  --     excedenteperiodo2 = excedenteperiodo2 + excedentemescob;

       --VLRTOTAL =$V{QTDITCONTRCALC}.multiply($F{VALOR}).add($V{EXCEDENTECOB}.multiply( $V{VALOREXCEDENTE} ))

       -- VALOR A COBRAR EXCEDENTE
--       valorexcedentecob = excedentecob * valorexcedente;
        
       -- VALOR TOTAL A COBRAR
--       valortotalcob = (qtditcontr * valor) + (excedentecob * valorexcedente);

      suspend;
   end


end
^

/* Alter (ATRESUMOATENDOSP02) */
ALTER PROCEDURE ATRESUMOATENDOSP02(CODEMPCLP INTEGER,
CODFILIALCLP SMALLINT,
CODCLIP INTEGER,
CODEMPCTP INTEGER,
CODFILIALCTP SMALLINT,
CODCONTRP INTEGER,
CODITCONTRP SMALLINT,
DTINIP DATE,
DTFIMP DATE)
 RETURNS(CODEMPCL INTEGER,
CODFILIALCL SMALLINT,
CODCLI INTEGER,
RAZCLI VARCHAR(60),
CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
CODITCONTR INTEGER,
CODCONTR INTEGER,
DESCCONTR VARCHAR(100),
VLRHORA DECIMAL(15,5),
VLRHORAEXCED DECIMAL(15,5),
QTDCONTR DECIMAL(15,5),
QTDITCONTR DECIMAL(15,5),
VLRCOB DECIMAL(15,5),
VLRCOBEXCED DECIMAL(15,5),
VLRCOBTOT DECIMAL(15,5),
MES SMALLINT,
ANO SMALLINT,
QTDHORAS DECIMAL(15,5),
SALDOMES DECIMAL(15,5),
EXCEDENTEMES DECIMAL(15,5),
EXCEDENTEMESCOB DECIMAL(15,5),
ACUMULO SMALLINT,
CDATAINI DATE)
 AS
declare variable dtiniac date;
begin
  for select cl.codemp codempcl, cl.codfilial codfilialcl, cl.codcli, cl.razcli
    , ct.codemp codempct, ct.codfilial codfilialct, ct.codcontr, ct.desccontr, ct.dtinicio
    from vdcliente cl, vdcontrato ct
    where cl.codemp=:codempclp and cl.codfilial=:codfilialclp and (:codclip=0 or cl.codcli=:codclip)
       and ct.codemp=:codempctp and ct.codfilial=:codfilialctp and (:codcontrp=0 or ct.codcontr=:codcontrp)
       and ct.codempcl=cl.codemp and ct.codfilialcl=cl.codfilial and ct.codcli=cl.codcli
       and ct.ativo='S' and ct.tpcobcontr in ('ME','BI','AN') and ct.recebcontr='S'
     order by cl.razcli,  cl.codcli,  ct.codcontr
  into :codempcl, :codfilialcl, :codcli, :razcli
    , :codempct, :codfilialct, :codcontr, :desccontr, :cdataini
  do
  begin


--       and i.codemp=ct.codemp  and i.codfilial=ct.codfilial and i.codcontr=ct.codcontr and (:coditcontrp=0 or i.coditcontr=:coditcontrp)

  --vditcontrato i,

      select max(i.acumuloitcontr) from vditcontrato i
      where i.codemp=:codempct  and i.codfilial=:codfilialct and i.codcontr=:codcontr and (:coditcontrp=0 or i.coditcontr=:coditcontr)
      and i.acumuloitcontr is not null
      into :acumulo;
      if ( (:acumulo is null) or (:acumulo=0) ) then
      begin
        acumulo = 0;
        dtiniac = dtinip;
      end
      else
      begin
        dtiniac = dtinip;
        dtiniac = cast( addmonth(dtiniac, -1*acumulo) as date);
        if( dtiniac > dtinip ) then
         dtiniac = dtinip;
      end
      for select a.mes, a.ano, a.qtdcontr, a.valor, a.valorexcedente, a.qtditcontr, a.qtdhoras, a.valortotalcob
       , a.saldomes, a.excedentemes, a.excedentemescob, a.valorexcedentecob , a.valorcontr
         from atresumoatendosp01(:codempcl, :codfilialcl, :codcli
         , :codempct, :codfilialct, :codcontr, :coditcontrp, :dtiniac, :dtfimp) a
      into :mes, :ano, :qtdcontr, :vlrhora, :vlrhoraexced, :qtditcontr, :qtdhoras, :vlrcobtot
      , :saldomes, :excedentemes, :excedentemescob, :vlrcobexced, :vlrcob
      do
      begin
        
      suspend;
      end
  end
end
^

/* Alter (EQMOVPRODCSLDSP) */
ALTER PROCEDURE EQMOVPRODCSLDSP(ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
NCUSTOMPMMOVPROD NUMERIC(15,5),
NSLDMOVPROD NUMERIC(15,5),
ESTOQTIPOMOVPD CHAR(1),
TIPONF CHAR(1))
 RETURNS(NCUSTOMPM NUMERIC(15,5),
NSALDO NUMERIC(15,5),
CESTOQMOVPROD CHAR(1),
CTIPOMOVPROD CHAR(1),
SOPERADOR SMALLINT)
 AS
begin
  /* Procedure que retorna o cálculo de custo e saldo */
  NCUSTOMPM = 0;
  NSALDO = 0;
  SELECT CESTIPOMOV, SOPERADOR
     FROM EQMOVPRODCKTMSP( :ICODEMPTM, :SCODFILIALTM, :ICODTIPOMOV, :ESTOQTIPOMOVPD)
     INTO :CTIPOMOVPROD, :SOPERADOR;
  if (SOPERADOR=0) then
  begin
     CESTOQMOVPROD = 'N';
     NSALDO = NSLDMOVPROD;
  end
  else
  begin  /* verifica se é para controlar estoque */
     CESTOQMOVPROD = 'S';
     NSALDO = NSLDMOVPROD + CAST ( (NQTDMOVPROD * SOPERADOR) AS NUMERIC(15, 5) );
  end
  if ( (NSALDO >= NSLDMOVPROD) AND (NSALDO > 0) AND (SOPERADOR>0 OR CTIPOMOVPROD='E') ) then
  begin
    if ( (NSLDMOVPROD * NCUSTOMPMMOVPROD)  <= 0) then
       NCUSTOMPM = NPRECOMOVPROD;
    else
    begin
       if (tiponf='C') then
          NCUSTOMPM = cast(NPRECOMOVPROD * NQTDMOVPROD / NSLDMOVPROD as numeric(15,5) ) + NCUSTOMPMMOVPROD   ;
       else
          NCUSTOMPM = ( cast(NSLDMOVPROD * NCUSTOMPMMOVPROD as numeric(15,5) ) +
          cast(NQTDMOVPROD * NPRECOMOVPROD as numeric(15,5)) ) / (NSLDMOVPROD + NQTDMOVPROD) ;
    end
  end
  else
      NCUSTOMPM = NCUSTOMPMMOVPROD;

  suspend;
end
^

ALTER PROCEDURE EQMOVPRODPRCSLDSP(SCODFILIAL SMALLINT,
ICODMOVPROD INTEGER,
ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
DDTMOVPROD DATE,
DDTMOVPRODPRC DATE,
NSLDMOVPROD NUMERIC(15,5),
NCUSTOMPMMOVPROD NUMERIC(15,5),
NSLDMOVPRODAX NUMERIC(15,5),
NCUSTOMPMMOVPRODAX NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
TIPONF CHAR(1))
 RETURNS(NSLDPRC NUMERIC(15,5),
NCUSTOMPMPRC NUMERIC(15,5),
NSLDPRCAX NUMERIC(15,5),
NCUSTOMPMPRCAX NUMERIC(15,5),
ESTOQTIPOMOVPD CHAR(1))
 AS
declare variable icodemptm integer;
declare variable scodfilialtm smallint;
declare variable icodtipomov integer;
declare variable nqtdmovprod numeric(15,5);
declare variable nprecomovprod numeric(15,5);
declare variable icodmovprodprc integer;
declare variable cestoqmovprod char(1);
declare variable icodempaxprc integer;
declare variable scodfilialaxprc smallint;
declare variable icodalmoxprc integer;
begin
  /* Procedure de processamento de estoque */
  FOR SELECT MP.CODEMPTM, MP.CODFILIALTM, MP.CODTIPOMOV ,
    MP.QTDMOVPROD, MP.PRECOMOVPROD , MP.CODMOVPROD,
    MP.CODEMPAX, MP.CODFILIALAX, MP.CODALMOX, MP.ESTOQMOVPROD
    FROM EQMOVPROD MP
    WHERE MP.CODEMPPD=:ICODEMPPD AND MP.CODFILIALPD=:SCODFILIALPD AND
       MP.CODPROD=:ICODPROD AND MP.CODEMP=:ICODEMPPD AND MP.CODFILIAL=:SCODFILIAL AND
       ( (MP.DTMOVPROD = :DDTMOVPROD AND MP.CODMOVPROD > :ICODMOVPROD) OR
         (MP.DTMOVPROD>:DDTMOVPROD) ) AND  /* ALTEREI AQUI */
       ( (:DDTMOVPRODPRC IS NULL /* AND MP.CODMOVPROD!=:ICODMOVPROD */) OR
         (MP.DTMOVPROD = :DDTMOVPRODPRC AND MP.CODMOVPROD < :ICODMOVPROD) OR
         (MP.DTMOVPROD < :DDTMOVPRODPRC) )
    ORDER BY MP.DTMOVPROD, MP.CODMOVPROD
    INTO :ICODEMPTM, :SCODFILIALTM, :ICODTIPOMOV,
     :NQTDMOVPROD, :NPRECOMOVPROD, :ICODMOVPRODPRC,
     :ICODEMPAXPRC, :SCODFILIALAXPRC, :ICODALMOXPRC, :ESTOQTIPOMOVPD DO
  BEGIN
      SELECT NSALDO, NCUSTOMPM, CESTOQMOVPROD FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
        :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPROD, :ESTOQTIPOMOVPD, :TIPONF)
      INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :CESTOQMOVPROD;
      if (CMULTIALMOX='N') then /* Se não for multi almoxarifado*/
      begin
         NSLDMOVPRODAX = NSLDMOVPROD;
         NCUSTOMPMMOVPRODAX = NCUSTOMPMMOVPROD;
         UPDATE EQMOVPROD SET SLDMOVPROD=:NSLDMOVPROD, CUSTOMPMMOVPROD=:NCUSTOMPMMOVPROD,
            SLDMOVPRODAX=:NSLDMOVPRODAX, CUSTOMPMMOVPRODAX=:NCUSTOMPMMOVPRODAX,
            ESTOQMOVPROD=:CESTOQMOVPROD
            WHERE CODEMP=:ICODEMPPD AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPRODPRC;
      end
      else if (ICODEMPAX=ICODEMPAXPRC AND SCODFILIALAX=SCODFILIALAXPRC AND
          ICODALMOX=ICODALMOXPRC) then
          /* Se for multi almoxarifado e o código do almoxarifado for o mesmo*/
      begin
        SELECT NSALDO, NCUSTOMPM FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
            :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPRODAX, :NSLDMOVPRODAX, :ESTOQTIPOMOVPD, :TIPONF)
            INTO :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX;
        UPDATE EQMOVPROD SET SLDMOVPROD=:NSLDMOVPROD, CUSTOMPMMOVPROD=:NCUSTOMPMMOVPROD,
            SLDMOVPRODAX=:NSLDMOVPRODAX, CUSTOMPMMOVPRODAX=:NCUSTOMPMMOVPRODAX,
            ESTOQMOVPROD=:CESTOQMOVPROD
            WHERE CODEMP=:ICODEMPPD AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPRODPRC;
      end
      else /* Se for multi almoxarifado não atualiza almoxarifado diferente */
      begin
        UPDATE EQMOVPROD SET SLDMOVPROD=:NSLDMOVPROD, CUSTOMPMMOVPROD=:NCUSTOMPMMOVPROD,
            ESTOQMOVPROD=:CESTOQMOVPROD
            WHERE CODEMP=:ICODEMPPD AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPRODPRC;
      end
      NSLDPRC = NSLDMOVPROD;
      NCUSTOMPMPRC = NCUSTOMPMMOVPROD;
      NSLDPRCAX = NSLDMOVPRODAX;
      NCUSTOMPMPRCAX = NCUSTOMPMMOVPRODAX;
  END
  suspend;
end
^

/* Alter (EQMOVPRODDSP) */
ALTER PROCEDURE EQMOVPRODDSP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
DDTMOVPROD DATE,
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD SMALLINT,
TIPONF CHAR(1))
 AS
declare variable icodemp integer;
declare variable scodfilial smallint;
declare variable icodmovprod integer;
declare variable nsldmovprod numeric(15,5);
declare variable ncustompmmovprod numeric(15,5);
declare variable nsldmovprodax numeric(15,5);
declare variable ncustompmmovprodax numeric(15,5);
begin
  /* Procedure de deleção da tabela eqmovprod */
  SELECT ICODEMP, SCODFILIAL, ICODMOVPROD
  FROM EQMOVPRODRETCODSP(:ICODEMPIV, :SCODFILIALIV, :ICODINVPROD, :ICODEMPCP,
    :SCODFILIALCP, :ICODCOMPRA, :SCODITCOMPRA, :ICODEMPVD, :SCODFILIALVD,
    :CTIPOVENDA, :ICODVENDA, :SCODITVENDA, :ICODEMPRM, :SCODFILIALRM, :ICODRMA,
    :SCODITRMA, :ICODEMPOP,  :SCODFILIALOP,  :ICODOP, :SSEQOP, :sseqentop, :seqsubprod)
    INTO :ICODEMP, :SCODFILIAL, :ICODMOVPROD;

  SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX
  FROM EQMOVPRODSLDSP(:ICODEMP, :SCODFILIAL, :ICODMOVPROD,
   :ICODEMPPD, :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, 0, 0,
   :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
     INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX  ;

  /* DELETAR EQMOVPROD */
  DELETE FROM EQMOVPROD WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL
    AND CODMOVPROD=:ICODMOVPROD;

  /* REPROCESSAR ESTOQUE */
  SELECT NSLDPRC, NCUSTOMPMPRC, NSLDPRCAX, NCUSTOMPMPRCAX
    FROM EQMOVPRODPRCSLDSP( :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
      :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, null, :NSLDMOVPROD, :NCUSTOMPMMOVPROD,
      :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX,
      :CMULTIALMOX, :TIPONF)
    INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX;

  /* ATUALIZA CUSTO NO CADASTRO DE PRODUTOS
   OPERADOR 1 PARA EFETUAR A ATUALIZAÇÃO SEMPRE
  EXECUTE PROCEDURE EQMOVPRODATCUSTSP( 1, :ICODEMP, :SCODFILIAL,
   :ICODMOVPROD,  :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, 0);
   */

  suspend;
end
^

ALTER PROCEDURE EQMOVPRODCSLDSP(ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
NCUSTOMPMMOVPROD NUMERIC(15,5),
NSLDMOVPROD NUMERIC(15,5),
ESTOQTIPOMOVPD CHAR(1),
TIPONF CHAR(1))
 RETURNS(NCUSTOMPM NUMERIC(15,5),
NSALDO NUMERIC(15,5),
CESTOQMOVPROD CHAR(1),
CTIPOMOVPROD CHAR(1),
SOPERADOR SMALLINT)
 AS
begin
  /* Procedure que retorna o cálculo de custo e saldo */
  NCUSTOMPM = 0;
  NSALDO = 0;
  SELECT CESTIPOMOV, SOPERADOR
     FROM EQMOVPRODCKTMSP( :ICODEMPTM, :SCODFILIALTM, :ICODTIPOMOV, :ESTOQTIPOMOVPD)
     INTO :CTIPOMOVPROD, :SOPERADOR;
  if (SOPERADOR=0) then
  begin
     CESTOQMOVPROD = 'N';
     NSALDO = NSLDMOVPROD;
  end
  else
  begin  /* verifica se é para controlar estoque */
     CESTOQMOVPROD = 'S';
     NSALDO = NSLDMOVPROD + CAST ( (NQTDMOVPROD * SOPERADOR) AS NUMERIC(15, 5) );
  end
  if ( (NSALDO >= NSLDMOVPROD) AND (NSALDO > 0) AND (SOPERADOR>0 OR CTIPOMOVPROD='E') ) then
  begin
    if ( (NSLDMOVPROD * NCUSTOMPMMOVPROD)  <= 0) then
       NCUSTOMPM = NPRECOMOVPROD;
    else
    begin
       if (tiponf='C') then
          NCUSTOMPM = cast(NPRECOMOVPROD * NQTDMOVPROD / NSLDMOVPROD as numeric(15,5) ) + NCUSTOMPMMOVPROD   ;
       else
          NCUSTOMPM = ( cast(NSLDMOVPROD * NCUSTOMPMMOVPROD as numeric(15,5) ) +
          cast(NQTDMOVPROD * NPRECOMOVPROD as numeric(15,5)) ) / (NSLDMOVPROD + NQTDMOVPROD) ;
    end
  end
  else
      NCUSTOMPM = NCUSTOMPMMOVPROD;

  suspend;
end
^

/* Alter (EQMOVPRODISP) */
ALTER PROCEDURE EQMOVPRODISP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD SMALLINT,
ESTOQTIPOMOVPD CHAR(1),
TIPONF CHAR(1))
 AS
declare variable scodfilial smallint;
declare variable icodmovprod integer;
declare variable cestoqmovprod char(1);
declare variable ctipomovprod char(1);
declare variable nsldmovprod numeric(15,5);
declare variable ncustompmmovprod numeric(15,5);
declare variable soperador smallint;
declare variable nsldmovprodax numeric(15,5);
declare variable ncustompmmovprodax numeric(15,5);
begin
  /* Procedure de inserção na tabela eqmovprod */

  SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX FROM EQMOVPRODSLDSP(null, null, null, :ICODEMPPD,
     :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, :NPRECOMOVPROD, :NPRECOMOVPROD,
     :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX )
     INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX ;

  /* Verifica se haverá mudança de saldo*/
  SELECT NSALDO, NCUSTOMPM, CESTOQMOVPROD, CTIPOMOVPROD, SOPERADOR FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
      :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPROD, :ESTOQTIPOMOVPD, :TIPONF)
      INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :CESTOQMOVPROD, :CTIPOMOVPROD, :SOPERADOR;

  if (CMULTIALMOX='N') then
  begin
     NSLDMOVPRODAX = NSLDMOVPROD;
     NCUSTOMPMMOVPRODAX = NCUSTOMPMMOVPROD;
  end
  else
  begin
      SELECT NSALDO, NCUSTOMPM FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
          :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPRODAX, :NSLDMOVPRODAX, :ESTOQTIPOMOVPD, :TIPONF)
        INTO :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX;
  end

  SELECT SCODFILIAL, ICODMOVPROD FROM EQMOVPRODSEQSP(:ICODEMPPD)
     INTO :SCODFILIAL, :ICODMOVPROD;  /* encontra o próximo código e a filial*/

   INSERT INTO EQMOVPROD ( CODEMP, CODFILIAL, CODMOVPROD,
      CODEMPPD, CODFILIALPD , CODPROD , CODEMPLE ,
      CODFILIALLE , CODLOTE , CODEMPTM, CODFILIALTM,
      CODTIPOMOV, CODEMPIV , CODFILIALIV , CODINVPROD ,
      CODEMPCP , CODFILIALCP , CODCOMPRA , CODITCOMPRA , CODEMPVD ,
      CODFILIALVD , TIPOVENDA , CODVENDA , CODITVENDA , CODEMPRM ,
      CODFILIALRM , CODRMA , CODITRMA ,
      CODEMPOP, CODFILIALOP, CODOP, SEQOP, SEQENTOP,
      CODEMPNT , CODFILIALNT ,
      CODNAT , DTMOVPROD , DOCMOVPROD , FLAG , QTDMOVPROD ,
      PRECOMOVPROD, ESTOQMOVPROD, TIPOMOVPROD, SLDMOVPROD, CUSTOMPMMOVPROD,
      SLDMOVPRODAX, CUSTOMPMMOVPRODAX, CODEMPAX, CODFILIALAX, CODALMOX, seqsubprod )
   VALUES ( :ICODEMPPD, :SCODFILIAL, :ICODMOVPROD,
    :ICODEMPPD , :SCODFILIALPD , :ICODPROD , :ICODEMPLE ,
    :SCODFILIALLE , :CCODLOTE , :ICODEMPTM, :SCODFILIALTM,
    :ICODTIPOMOV, :ICODEMPIV , :SCODFILIALIV ,
    :ICODINVPROD , :ICODEMPCP , :SCODFILIALCP , :ICODCOMPRA ,
    :SCODITCOMPRA , :ICODEMPVD , :SCODFILIALVD , :CTIPOVENDA ,
    :ICODVENDA , :SCODITVENDA , :ICODEMPRM , :SCODFILIALRM ,
    :ICODRMA , :SCODITRMA , :ICODEMPOP, :SCODFILIALOP, :ICODOP, :SSEQOP, :sseqentop,
    :ICODEMPNT , :SCODFILIALNT , :CCODNAT ,
    :DDTMOVPROD , :IDOCMOVPROD , :CFLAG , :NQTDMOVPROD ,
    :NPRECOMOVPROD, :CESTOQMOVPROD, :CTIPOMOVPROD, :NSLDMOVPROD, :NCUSTOMPMMOVPROD,
    :NSLDMOVPRODAX,  :NCUSTOMPMMOVPRODAX, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :seqsubprod );

  /* REPROCESSAR ESTOQUE */

  SELECT NSLDPRC, NCUSTOMPMPRC, NSLDPRCAX, NCUSTOMPMPRCAX
    FROM EQMOVPRODPRCSLDSP( :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
     :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, null, :NSLDMOVPROD, :NCUSTOMPMMOVPROD,
     :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX,
     :CMULTIALMOX, :TIPONF)
    INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX ;

 /* ATUALIZA O CUSTO NO CADASTRO DE PRODUTOS
   EXECUTE PROCEDURE EQMOVPRODATCUSTSP(:SOPERADOR, :ICODEMPPD, :SCODFILIAL,
    :ICODMOVPROD, :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, :NCUSTOMPMMOVPROD); 
 */


  suspend;
end
^

SET TERM ; ^

Update Rdb$Procedure_Parameters set Rdb$Description =
'Sequencial do subproduto'
where Rdb$Procedure_Name='EQMOVPRODISP' and Rdb$Parameter_Name='SEQSUBPROD';

SET TERM ^ ;

ALTER PROCEDURE EQMOVPRODDSP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
DDTMOVPROD DATE,
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD SMALLINT,
TIPONF CHAR(1))
 AS
declare variable icodemp integer;
declare variable scodfilial smallint;
declare variable icodmovprod integer;
declare variable nsldmovprod numeric(15,5);
declare variable ncustompmmovprod numeric(15,5);
declare variable nsldmovprodax numeric(15,5);
declare variable ncustompmmovprodax numeric(15,5);
begin
  /* Procedure de deleção da tabela eqmovprod */
  SELECT ICODEMP, SCODFILIAL, ICODMOVPROD
  FROM EQMOVPRODRETCODSP(:ICODEMPIV, :SCODFILIALIV, :ICODINVPROD, :ICODEMPCP,
    :SCODFILIALCP, :ICODCOMPRA, :SCODITCOMPRA, :ICODEMPVD, :SCODFILIALVD,
    :CTIPOVENDA, :ICODVENDA, :SCODITVENDA, :ICODEMPRM, :SCODFILIALRM, :ICODRMA,
    :SCODITRMA, :ICODEMPOP,  :SCODFILIALOP,  :ICODOP, :SSEQOP, :sseqentop, :seqsubprod)
    INTO :ICODEMP, :SCODFILIAL, :ICODMOVPROD;

  SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX
  FROM EQMOVPRODSLDSP(:ICODEMP, :SCODFILIAL, :ICODMOVPROD,
   :ICODEMPPD, :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, 0, 0,
   :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
     INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX  ;

  /* DELETAR EQMOVPROD */
  DELETE FROM EQMOVPROD WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL
    AND CODMOVPROD=:ICODMOVPROD;

  /* REPROCESSAR ESTOQUE */
  SELECT NSLDPRC, NCUSTOMPMPRC, NSLDPRCAX, NCUSTOMPMPRCAX
    FROM EQMOVPRODPRCSLDSP( :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
      :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, null, :NSLDMOVPROD, :NCUSTOMPMMOVPROD,
      :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX,
      :CMULTIALMOX, :TIPONF)
    INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX;

  /* ATUALIZA CUSTO NO CADASTRO DE PRODUTOS
   OPERADOR 1 PARA EFETUAR A ATUALIZAÇÃO SEMPRE
  EXECUTE PROCEDURE EQMOVPRODATCUSTSP( 1, :ICODEMP, :SCODFILIAL,
   :ICODMOVPROD,  :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, 0);
   */

  suspend;
end
^

ALTER PROCEDURE EQMOVPRODUSP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD BIGINT,
ESTOQTIPOMOVPD CHAR(1),
TIPONF CHAR(1))
 AS
declare variable icodemp integer;
declare variable scodfilial smallint;
declare variable icodmovprod integer;
declare variable nsldprc numeric(15,5);
declare variable ncustompmprc numeric(15,5);
declare variable nsldprcax numeric(15,5);
declare variable ncustompmprcax numeric(15,5);
declare variable nsldlc numeric(15,5);
declare variable ncustompmlc numeric(15,5);
declare variable nsldlcax numeric(15,5);
declare variable ncustompmlcax numeric(15,5);
declare variable ddtmovprodold date;
declare variable nprecomovprodold numeric(15,5);
declare variable nqtdmovprodold numeric(15,5);
declare variable icodemptmold integer;
declare variable scodfilialtmold smallint;
declare variable icodtipomovold integer;
declare variable calttm char(1);
declare variable ddtprc date;
declare variable ddtprcate date;
declare variable cestoqmovprod char(1);
begin
  /* Procedure de atualização da tabela eqmovprod */

  DDTPRCATE = NULL; /* Até onde deve ser processando o estoque */
 /* localiza movprod */

-- execute procedure sgdebugsp('antes da atualização...','no inicio');

  SELECT ICODEMP, SCODFILIAL, ICODMOVPROD
    FROM EQMOVPRODRETCODSP(:ICODEMPIV, :SCODFILIALIV, :ICODINVPROD, :ICODEMPCP,
      :SCODFILIALCP, :ICODCOMPRA, :SCODITCOMPRA, :ICODEMPVD, :SCODFILIALVD,
      :CTIPOVENDA, :ICODVENDA, :SCODITVENDA, :ICODEMPRM, :SCODFILIALRM,
      :ICODRMA, :SCODITRMA, :ICODEMPOP, :SCODFILIALOP, :ICODOP, :SSEQOP, :sseqentop, :seqsubprod)
    INTO :ICODEMP, :SCODFILIAL, :ICODMOVPROD;

--  traz valores antigos

  SELECT MP.CODEMPTM, MP.CODFILIALTM, MP.CODTIPOMOV, MP.DTMOVPROD,
       MP.PRECOMOVPROD, MP.QTDMOVPROD  FROM EQMOVPROD MP
     WHERE MP.CODEMP=:ICODEMP AND MP.CODFILIAL=:SCODFILIAL AND MP.CODMOVPROD=:ICODMOVPROD
     INTO :ICODEMPTMOLD, :SCODFILIALTMOLD, :ICODTIPOMOVOLD, :DDTMOVPRODOLD,
       :NPRECOMOVPRODOLD, :NQTDMOVPRODOLD;

   /* abaixo verificação se a alteração de tipo de movimento mexe no estoque */
   SELECT CALTTM FROM EQMOVPRODCKUTMSP(:ICODEMPTM, :SCODFILIALTM, :ICODTIPOMOV,
      :ICODEMPTMOLD, :SCODFILIALTMOLD, :ICODTIPOMOVOLD) INTO :CALTTM;

   /* verifica se há relevância para reprocessamento */
   if ( (DDTMOVPROD!=DDTMOVPRODOLD) OR (CALTTM='S') OR
        (NPRECOMOVPROD!=NPRECOMOVPRODOLD) OR (NQTDMOVPROD!=NQTDMOVPRODOLD) ) then
   begin

   -- execute procedure sgdebugsp('entrou no if','1');


      if ( DDTMOVPRODOLD IS NULL) then
         DDTMOVPRODOLD = DDTMOVPROD; /* garantir que a data antiga não e nula; */
      /* verifica qual data é menor para reprocessamento */
      if ( DDTMOVPROD<=DDTMOVPRODOLD ) then
      begin

     -- execute procedure sgdebugsp('entrou no if','2');

          DDTPRC = DDTMOVPROD;
          if (DDTMOVPROD=DDTMOVPRODOLD) then
             DDTPRCATE = null;
          else
             DDTPRCATE = DDTMOVPRODOLD;
/*          verifica lançamento anterior e traz custo e saldo */
          SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX
             FROM EQMOVPRODSLDSP(:ICODEMP, :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
             :SCODFILIALPD, :ICODPROD, :DDTPRC, :NPRECOMOVPROD, :NPRECOMOVPROD,
             :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
             INTO :NSLDPRC, :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX ;

          /* verifica se havera mudança de saldo */
          SELECT NSALDO, NCUSTOMPM, CESTOQMOVPROD
              FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
              :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMPRC, :NSLDPRC, :ESTOQTIPOMOVPD, :TIPONF)
              INTO :NSLDPRC, :NCUSTOMPMPRC, :CESTOQMOVPROD;
          if (CMULTIALMOX='N') then
          begin
              NSLDPRCAX = NSLDPRC;
              NCUSTOMPMPRCAX = NCUSTOMPMPRC;
          end
          else
          begin
          SELECT NSALDO, NCUSTOMPM
              FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
              :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMPRCAX, :NSLDPRCAX, :ESTOQTIPOMOVPD, :TIPONF)
              INTO :NSLDPRCAX, :NCUSTOMPMPRCAX;
          end
          NCUSTOMPMLC = NCUSTOMPMPRC;
          NSLDLC = NSLDPRC;
          NCUSTOMPMLCAX = NCUSTOMPMPRCAX;
          NSLDLCAX = NSLDPRCAX;
      end
      else
      begin
          DDTPRC = DDTMOVPRODOLD;
          DDTPRCATE = DDTMOVPROD;
          /* verifica lançamento anterior e traz custo e saldo */

       --   execute procedure sgdebugsp('entrou no else','3');

          SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX
             FROM EQMOVPRODSLDSP(:ICODEMP, :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
             :SCODFILIALPD, :ICODPROD, :DDTPRC, 0, 0,
             :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
             INTO :NSLDPRC, :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX ;

          /* verifica lançamento anterior e traz custo e saldo */
          SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX
             FROM EQMOVPRODSLDSP(:ICODEMP, :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
             :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, :NCUSTOMPMLC, :NCUSTOMPMLCAX,
             :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
             INTO :NSLDLC, :NCUSTOMPMLC, :NSLDLCAX, :NCUSTOMPMLCAX ;

          /* verifica se havera mudança de saldo */
          SELECT NSALDO, NCUSTOMPM, CESTOQMOVPROD
              FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
              :ICODTIPOMOV, (:NQTDMOVPROD-:NQTDMOVPRODOLD), :NPRECOMOVPROD,
              :NCUSTOMPMLC, :NSLDLC, :ESTOQTIPOMOVPD, :TIPONF)
              INTO :NSLDLC, :NCUSTOMPMLC, :CESTOQMOVPROD;
          if (CMULTIALMOX='N') then
          begin
             NSLDLCAX = NSLDLC;
             NCUSTOMPMLCAX = NCUSTOMPMLC;
          end
          else
          begin
              SELECT NSALDO, NCUSTOMPM
                  FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
                  :ICODTIPOMOV, (:NQTDMOVPROD-:NQTDMOVPRODOLD), :NPRECOMOVPROD,
                  :NCUSTOMPMLCAX, :NSLDLCAX, :ESTOQTIPOMOVPD, :TIPONF)
                  INTO :NSLDLCAX, :NCUSTOMPMLCAX;
          end

      end

       SELECT NSLDPRC, NCUSTOMPMPRC, NSLDPRCAX, NCUSTOMPMPRCAX
        FROM EQMOVPRODPRCSLDSP( :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
          :SCODFILIALPD, :ICODPROD, :DDTPRC, :DDTPRCATE, :NSLDPRC,
          :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX,
          :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX, :TIPONF)
        INTO :NSLDPRC, :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX;

      UPDATE EQMOVPROD SET DTMOVPROD=:DDTMOVPROD,
         QTDMOVPROD=:NQTDMOVPROD, PRECOMOVPROD=:NPRECOMOVPROD,
         SLDMOVPROD=:NSLDLC, CUSTOMPMMOVPROD=:NCUSTOMPMLC,
         SLDMOVPRODAX=:NSLDLCAX, CUSTOMPMMOVPRODAX=:NCUSTOMPMLCAX,
         FLAG=:CFLAG, CODEMPNT=:ICODEMPNT, CODFILIALNT=:SCODFILIALNT,
         CODNAT=:CCODNAT, DOCMOVPROD=:IDOCMOVPROD, CODEMPTM=:ICODEMPTM,
         CODFILIALTM=:SCODFILIALTM, CODTIPOMOV=:ICODTIPOMOV, CODEMPLE=:ICODEMPLE,
         CODFILIALLE=:SCODFILIALLE, CODLOTE=:CCODLOTE, ESTOQMOVPROD=:CESTOQMOVPROD ,
         CODEMPAX=:ICODEMPAX, CODFILIALAX=:SCODFILIALAX, CODALMOX=:ICODALMOX
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPROD;
   end
   else /*  caso não tenha nenhuma alteração relevânte para processamento */

  --  execute procedure sgdebugsp('antes do reprocessamento','5SG');

      UPDATE EQMOVPROD SET FLAG=:CFLAG, CODEMPNT=:ICODEMPNT, CODFILIALNT=:SCODFILIALNT,
         CODNAT=:CCODNAT, DOCMOVPROD=:IDOCMOVPROD, CODEMPTM=:ICODEMPTM,
         CODFILIALTM=:SCODFILIALTM, CODTIPOMOV=:ICODTIPOMOV, CODEMPLE=:ICODEMPLE,
         CODFILIALLE=:SCODFILIALLE, CODLOTE=:CCODLOTE,
         CODEMPAX=:ICODEMPAX, CODFILIALAX=:SCODFILIALAX, CODALMOX=:ICODALMOX
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPROD;
end
^

ALTER PROCEDURE EQMOVPRODISP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD SMALLINT,
ESTOQTIPOMOVPD CHAR(1),
TIPONF CHAR(1))
 AS
declare variable scodfilial smallint;
declare variable icodmovprod integer;
declare variable cestoqmovprod char(1);
declare variable ctipomovprod char(1);
declare variable nsldmovprod numeric(15,5);
declare variable ncustompmmovprod numeric(15,5);
declare variable soperador smallint;
declare variable nsldmovprodax numeric(15,5);
declare variable ncustompmmovprodax numeric(15,5);
begin
  /* Procedure de inserção na tabela eqmovprod */

  SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX FROM EQMOVPRODSLDSP(null, null, null, :ICODEMPPD,
     :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, :NPRECOMOVPROD, :NPRECOMOVPROD,
     :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX )
     INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX ;

  /* Verifica se haverá mudança de saldo*/
  SELECT NSALDO, NCUSTOMPM, CESTOQMOVPROD, CTIPOMOVPROD, SOPERADOR FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
      :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPROD, :ESTOQTIPOMOVPD, :TIPONF)
      INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :CESTOQMOVPROD, :CTIPOMOVPROD, :SOPERADOR;

  if (CMULTIALMOX='N') then
  begin
     NSLDMOVPRODAX = NSLDMOVPROD;
     NCUSTOMPMMOVPRODAX = NCUSTOMPMMOVPROD;
  end
  else
  begin
      SELECT NSALDO, NCUSTOMPM FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
          :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPRODAX, :NSLDMOVPRODAX, :ESTOQTIPOMOVPD, :TIPONF)
        INTO :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX;
  end

  SELECT SCODFILIAL, ICODMOVPROD FROM EQMOVPRODSEQSP(:ICODEMPPD)
     INTO :SCODFILIAL, :ICODMOVPROD;  /* encontra o próximo código e a filial*/

   INSERT INTO EQMOVPROD ( CODEMP, CODFILIAL, CODMOVPROD,
      CODEMPPD, CODFILIALPD , CODPROD , CODEMPLE ,
      CODFILIALLE , CODLOTE , CODEMPTM, CODFILIALTM,
      CODTIPOMOV, CODEMPIV , CODFILIALIV , CODINVPROD ,
      CODEMPCP , CODFILIALCP , CODCOMPRA , CODITCOMPRA , CODEMPVD ,
      CODFILIALVD , TIPOVENDA , CODVENDA , CODITVENDA , CODEMPRM ,
      CODFILIALRM , CODRMA , CODITRMA ,
      CODEMPOP, CODFILIALOP, CODOP, SEQOP, SEQENTOP,
      CODEMPNT , CODFILIALNT ,
      CODNAT , DTMOVPROD , DOCMOVPROD , FLAG , QTDMOVPROD ,
      PRECOMOVPROD, ESTOQMOVPROD, TIPOMOVPROD, SLDMOVPROD, CUSTOMPMMOVPROD,
      SLDMOVPRODAX, CUSTOMPMMOVPRODAX, CODEMPAX, CODFILIALAX, CODALMOX, seqsubprod )
   VALUES ( :ICODEMPPD, :SCODFILIAL, :ICODMOVPROD,
    :ICODEMPPD , :SCODFILIALPD , :ICODPROD , :ICODEMPLE ,
    :SCODFILIALLE , :CCODLOTE , :ICODEMPTM, :SCODFILIALTM,
    :ICODTIPOMOV, :ICODEMPIV , :SCODFILIALIV ,
    :ICODINVPROD , :ICODEMPCP , :SCODFILIALCP , :ICODCOMPRA ,
    :SCODITCOMPRA , :ICODEMPVD , :SCODFILIALVD , :CTIPOVENDA ,
    :ICODVENDA , :SCODITVENDA , :ICODEMPRM , :SCODFILIALRM ,
    :ICODRMA , :SCODITRMA , :ICODEMPOP, :SCODFILIALOP, :ICODOP, :SSEQOP, :sseqentop,
    :ICODEMPNT , :SCODFILIALNT , :CCODNAT ,
    :DDTMOVPROD , :IDOCMOVPROD , :CFLAG , :NQTDMOVPROD ,
    :NPRECOMOVPROD, :CESTOQMOVPROD, :CTIPOMOVPROD, :NSLDMOVPROD, :NCUSTOMPMMOVPROD,
    :NSLDMOVPRODAX,  :NCUSTOMPMMOVPRODAX, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :seqsubprod );

  /* REPROCESSAR ESTOQUE */

  SELECT NSLDPRC, NCUSTOMPMPRC, NSLDPRCAX, NCUSTOMPMPRCAX
    FROM EQMOVPRODPRCSLDSP( :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
     :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, null, :NSLDMOVPROD, :NCUSTOMPMMOVPROD,
     :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX,
     :CMULTIALMOX, :TIPONF)
    INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX ;

 /* ATUALIZA O CUSTO NO CADASTRO DE PRODUTOS
   EXECUTE PROCEDURE EQMOVPRODATCUSTSP(:SOPERADOR, :ICODEMPPD, :SCODFILIAL,
    :ICODMOVPROD, :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, :NCUSTOMPMMOVPROD); 
 */


  suspend;
end
^

/* Alter (EQMOVPRODIUDSP) */
ALTER PROCEDURE EQMOVPRODIUDSP(CIUD CHAR(1),
ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
SEQSUBPROD SMALLINT,
ESTOQTIPOMOVPD CHAR(1),
TIPONF CHAR(1))
 AS
declare variable cmultialmox char(1);
begin
  /* Procedure que controle INSERT, UPDATE E DELETE da tabela eqmovprod */

  /* Linha incluida para passar como parâmetro se é multi almoxarifado
      Como o objetivo de evitar I/O
  */
  SELECT CMULTIALMOX FROM SGRETMULTIALMOXSP(:ICODEMPPD) INTO :CMULTIALMOX;
  
  if (CIUD='I') then /* SE FOR INSERT */
     execute procedure EQMOVPRODISP( ICODEMPPD, SCODFILIALPD, ICODPROD,
         ICODEMPLE, SCODFILIALLE, CCODLOTE, ICODEMPTM, SCODFILIALTM, ICODTIPOMOV,
         ICODEMPIV, SCODFILIALIV, ICODINVPROD, ICODEMPCP, SCODFILIALCP, ICODCOMPRA,
         SCODITCOMPRA, ICODEMPVD, SCODFILIALVD, CTIPOVENDA, ICODVENDA, SCODITVENDA,
         ICODEMPRM, SCODFILIALRM, ICODRMA, SCODITRMA,
         ICODEMPOP, SCODFILIALOP, ICODOP, SSEQOP, sseqentop,
         ICODEMPNT, SCODFILIALNT,
         CCODNAT, DDTMOVPROD, IDOCMOVPROD, CFLAG, NQTDMOVPROD, NPRECOMOVPROD,
         ICODEMPAX, SCODFILIALAX, ICODALMOX, CMULTIALMOX, :seqsubprod, :estoqtipomovpd, :tiponf);
  else if (CIUD='U') then
     execute procedure EQMOVPRODUSP( ICODEMPPD, SCODFILIALPD, ICODPROD,
         ICODEMPLE, SCODFILIALLE, CCODLOTE, ICODEMPTM, SCODFILIALTM, ICODTIPOMOV,
         ICODEMPIV, SCODFILIALIV, ICODINVPROD, ICODEMPCP, SCODFILIALCP, ICODCOMPRA,
         SCODITCOMPRA, ICODEMPVD, SCODFILIALVD, CTIPOVENDA, ICODVENDA, SCODITVENDA,
         ICODEMPRM, SCODFILIALRM, ICODRMA, SCODITRMA,
         ICODEMPOP, SCODFILIALOP, ICODOP, SSEQOP, sseqentop,
         ICODEMPNT, SCODFILIALNT,
         CCODNAT, DDTMOVPROD, IDOCMOVPROD, CFLAG, NQTDMOVPROD, NPRECOMOVPROD,
         ICODEMPAX, SCODFILIALAX, ICODALMOX, CMULTIALMOX,:seqsubprod, :estoqtipomovpd, :tiponf);
  else if (CIUD='D') then
     execute procedure EQMOVPRODDSP( ICODEMPPD, SCODFILIALPD, ICODPROD, ICODEMPIV,
         SCODFILIALIV, ICODINVPROD, ICODEMPCP, SCODFILIALCP, ICODCOMPRA, SCODITCOMPRA,
         ICODEMPVD, SCODFILIALVD, CTIPOVENDA, ICODVENDA, SCODITVENDA,
         ICODEMPRM, SCODFILIALRM, ICODRMA, SCODITRMA,
         ICODEMPOP, SCODFILIALOP, ICODOP, SSEQOP, sseqentop,
         DDTMOVPROD, ICODEMPAX, SCODFILIALAX, ICODALMOX, CMULTIALMOX, :seqsubprod, :tiponf );
--  suspend;
end
^

SET TERM ; ^

Update Rdb$Procedure_Parameters set Rdb$Description =
'Sequencial de subproduto'
where Rdb$Procedure_Name='EQMOVPRODIUDSP' and Rdb$Parameter_Name='SEQSUBPROD';

/* Alter (EQMOVPRODPRCSLDSP) */
SET TERM ^ ;

ALTER PROCEDURE EQMOVPRODPRCSLDSP(SCODFILIAL SMALLINT,
ICODMOVPROD INTEGER,
ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
DDTMOVPROD DATE,
DDTMOVPRODPRC DATE,
NSLDMOVPROD NUMERIC(15,5),
NCUSTOMPMMOVPROD NUMERIC(15,5),
NSLDMOVPRODAX NUMERIC(15,5),
NCUSTOMPMMOVPRODAX NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
TIPONF CHAR(1))
 RETURNS(NSLDPRC NUMERIC(15,5),
NCUSTOMPMPRC NUMERIC(15,5),
NSLDPRCAX NUMERIC(15,5),
NCUSTOMPMPRCAX NUMERIC(15,5),
ESTOQTIPOMOVPD CHAR(1))
 AS
declare variable icodemptm integer;
declare variable scodfilialtm smallint;
declare variable icodtipomov integer;
declare variable nqtdmovprod numeric(15,5);
declare variable nprecomovprod numeric(15,5);
declare variable icodmovprodprc integer;
declare variable cestoqmovprod char(1);
declare variable icodempaxprc integer;
declare variable scodfilialaxprc smallint;
declare variable icodalmoxprc integer;
begin
  /* Procedure de processamento de estoque */
  FOR SELECT MP.CODEMPTM, MP.CODFILIALTM, MP.CODTIPOMOV ,
    MP.QTDMOVPROD, MP.PRECOMOVPROD , MP.CODMOVPROD,
    MP.CODEMPAX, MP.CODFILIALAX, MP.CODALMOX, MP.ESTOQMOVPROD
    FROM EQMOVPROD MP
    WHERE MP.CODEMPPD=:ICODEMPPD AND MP.CODFILIALPD=:SCODFILIALPD AND
       MP.CODPROD=:ICODPROD AND MP.CODEMP=:ICODEMPPD AND MP.CODFILIAL=:SCODFILIAL AND
       ( (MP.DTMOVPROD = :DDTMOVPROD AND MP.CODMOVPROD > :ICODMOVPROD) OR
         (MP.DTMOVPROD>:DDTMOVPROD) ) AND  /* ALTEREI AQUI */
       ( (:DDTMOVPRODPRC IS NULL /* AND MP.CODMOVPROD!=:ICODMOVPROD */) OR
         (MP.DTMOVPROD = :DDTMOVPRODPRC AND MP.CODMOVPROD < :ICODMOVPROD) OR
         (MP.DTMOVPROD < :DDTMOVPRODPRC) )
    ORDER BY MP.DTMOVPROD, MP.CODMOVPROD
    INTO :ICODEMPTM, :SCODFILIALTM, :ICODTIPOMOV,
     :NQTDMOVPROD, :NPRECOMOVPROD, :ICODMOVPRODPRC,
     :ICODEMPAXPRC, :SCODFILIALAXPRC, :ICODALMOXPRC, :ESTOQTIPOMOVPD DO
  BEGIN
      SELECT NSALDO, NCUSTOMPM, CESTOQMOVPROD FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
        :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPROD, :ESTOQTIPOMOVPD, :TIPONF)
      INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :CESTOQMOVPROD;
      if (CMULTIALMOX='N') then /* Se não for multi almoxarifado*/
      begin
         NSLDMOVPRODAX = NSLDMOVPROD;
         NCUSTOMPMMOVPRODAX = NCUSTOMPMMOVPROD;
         UPDATE EQMOVPROD SET SLDMOVPROD=:NSLDMOVPROD, CUSTOMPMMOVPROD=:NCUSTOMPMMOVPROD,
            SLDMOVPRODAX=:NSLDMOVPRODAX, CUSTOMPMMOVPRODAX=:NCUSTOMPMMOVPRODAX,
            ESTOQMOVPROD=:CESTOQMOVPROD
            WHERE CODEMP=:ICODEMPPD AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPRODPRC;
      end
      else if (ICODEMPAX=ICODEMPAXPRC AND SCODFILIALAX=SCODFILIALAXPRC AND
          ICODALMOX=ICODALMOXPRC) then
          /* Se for multi almoxarifado e o código do almoxarifado for o mesmo*/
      begin
        SELECT NSALDO, NCUSTOMPM FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
            :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPRODAX, :NSLDMOVPRODAX, :ESTOQTIPOMOVPD, :TIPONF)
            INTO :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX;
        UPDATE EQMOVPROD SET SLDMOVPROD=:NSLDMOVPROD, CUSTOMPMMOVPROD=:NCUSTOMPMMOVPROD,
            SLDMOVPRODAX=:NSLDMOVPRODAX, CUSTOMPMMOVPRODAX=:NCUSTOMPMMOVPRODAX,
            ESTOQMOVPROD=:CESTOQMOVPROD
            WHERE CODEMP=:ICODEMPPD AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPRODPRC;
      end
      else /* Se for multi almoxarifado não atualiza almoxarifado diferente */
      begin
        UPDATE EQMOVPROD SET SLDMOVPROD=:NSLDMOVPROD, CUSTOMPMMOVPROD=:NCUSTOMPMMOVPROD,
            ESTOQMOVPROD=:CESTOQMOVPROD
            WHERE CODEMP=:ICODEMPPD AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPRODPRC;
      end
      NSLDPRC = NSLDMOVPROD;
      NCUSTOMPMPRC = NCUSTOMPMMOVPROD;
      NSLDPRCAX = NSLDMOVPRODAX;
      NCUSTOMPMPRCAX = NCUSTOMPMMOVPRODAX;
  END
  suspend;
end
^

/* Alter (EQMOVPRODUSP) */
ALTER PROCEDURE EQMOVPRODUSP(ICODEMPPD INTEGER,
SCODFILIALPD SMALLINT,
ICODPROD INTEGER,
ICODEMPLE INTEGER,
SCODFILIALLE SMALLINT,
CCODLOTE VARCHAR(20),
ICODEMPTM INTEGER,
SCODFILIALTM SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPIV INTEGER,
SCODFILIALIV SMALLINT,
ICODINVPROD INTEGER,
ICODEMPCP INTEGER,
SCODFILIALCP SMALLINT,
ICODCOMPRA INTEGER,
SCODITCOMPRA SMALLINT,
ICODEMPVD INTEGER,
SCODFILIALVD SMALLINT,
CTIPOVENDA CHAR(1),
ICODVENDA INTEGER,
SCODITVENDA SMALLINT,
ICODEMPRM INTEGER,
SCODFILIALRM SMALLINT,
ICODRMA INTEGER,
SCODITRMA SMALLINT,
ICODEMPOP INTEGER,
SCODFILIALOP SMALLINT,
ICODOP INTEGER,
SSEQOP SMALLINT,
SSEQENTOP SMALLINT,
ICODEMPNT INTEGER,
SCODFILIALNT SMALLINT,
CCODNAT CHAR(4),
DDTMOVPROD DATE,
IDOCMOVPROD INTEGER,
CFLAG CHAR(1),
NQTDMOVPROD NUMERIC(15,5),
NPRECOMOVPROD NUMERIC(15,5),
ICODEMPAX INTEGER,
SCODFILIALAX SMALLINT,
ICODALMOX INTEGER,
CMULTIALMOX CHAR(1),
SEQSUBPROD BIGINT,
ESTOQTIPOMOVPD CHAR(1),
TIPONF CHAR(1))
 AS
declare variable icodemp integer;
declare variable scodfilial smallint;
declare variable icodmovprod integer;
declare variable nsldprc numeric(15,5);
declare variable ncustompmprc numeric(15,5);
declare variable nsldprcax numeric(15,5);
declare variable ncustompmprcax numeric(15,5);
declare variable nsldlc numeric(15,5);
declare variable ncustompmlc numeric(15,5);
declare variable nsldlcax numeric(15,5);
declare variable ncustompmlcax numeric(15,5);
declare variable ddtmovprodold date;
declare variable nprecomovprodold numeric(15,5);
declare variable nqtdmovprodold numeric(15,5);
declare variable icodemptmold integer;
declare variable scodfilialtmold smallint;
declare variable icodtipomovold integer;
declare variable calttm char(1);
declare variable ddtprc date;
declare variable ddtprcate date;
declare variable cestoqmovprod char(1);
begin
  /* Procedure de atualização da tabela eqmovprod */

  DDTPRCATE = NULL; /* Até onde deve ser processando o estoque */
 /* localiza movprod */

-- execute procedure sgdebugsp('antes da atualização...','no inicio');

  SELECT ICODEMP, SCODFILIAL, ICODMOVPROD
    FROM EQMOVPRODRETCODSP(:ICODEMPIV, :SCODFILIALIV, :ICODINVPROD, :ICODEMPCP,
      :SCODFILIALCP, :ICODCOMPRA, :SCODITCOMPRA, :ICODEMPVD, :SCODFILIALVD,
      :CTIPOVENDA, :ICODVENDA, :SCODITVENDA, :ICODEMPRM, :SCODFILIALRM,
      :ICODRMA, :SCODITRMA, :ICODEMPOP, :SCODFILIALOP, :ICODOP, :SSEQOP, :sseqentop, :seqsubprod)
    INTO :ICODEMP, :SCODFILIAL, :ICODMOVPROD;

--  traz valores antigos

  SELECT MP.CODEMPTM, MP.CODFILIALTM, MP.CODTIPOMOV, MP.DTMOVPROD,
       MP.PRECOMOVPROD, MP.QTDMOVPROD  FROM EQMOVPROD MP
     WHERE MP.CODEMP=:ICODEMP AND MP.CODFILIAL=:SCODFILIAL AND MP.CODMOVPROD=:ICODMOVPROD
     INTO :ICODEMPTMOLD, :SCODFILIALTMOLD, :ICODTIPOMOVOLD, :DDTMOVPRODOLD,
       :NPRECOMOVPRODOLD, :NQTDMOVPRODOLD;

   /* abaixo verificação se a alteração de tipo de movimento mexe no estoque */
   SELECT CALTTM FROM EQMOVPRODCKUTMSP(:ICODEMPTM, :SCODFILIALTM, :ICODTIPOMOV,
      :ICODEMPTMOLD, :SCODFILIALTMOLD, :ICODTIPOMOVOLD) INTO :CALTTM;

   /* verifica se há relevância para reprocessamento */
   if ( (DDTMOVPROD!=DDTMOVPRODOLD) OR (CALTTM='S') OR
        (NPRECOMOVPROD!=NPRECOMOVPRODOLD) OR (NQTDMOVPROD!=NQTDMOVPRODOLD) ) then
   begin

   -- execute procedure sgdebugsp('entrou no if','1');


      if ( DDTMOVPRODOLD IS NULL) then
         DDTMOVPRODOLD = DDTMOVPROD; /* garantir que a data antiga não e nula; */
      /* verifica qual data é menor para reprocessamento */
      if ( DDTMOVPROD<=DDTMOVPRODOLD ) then
      begin

     -- execute procedure sgdebugsp('entrou no if','2');

          DDTPRC = DDTMOVPROD;
          if (DDTMOVPROD=DDTMOVPRODOLD) then
             DDTPRCATE = null;
          else
             DDTPRCATE = DDTMOVPRODOLD;
/*          verifica lançamento anterior e traz custo e saldo */
          SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX
             FROM EQMOVPRODSLDSP(:ICODEMP, :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
             :SCODFILIALPD, :ICODPROD, :DDTPRC, :NPRECOMOVPROD, :NPRECOMOVPROD,
             :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
             INTO :NSLDPRC, :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX ;

          /* verifica se havera mudança de saldo */
          SELECT NSALDO, NCUSTOMPM, CESTOQMOVPROD
              FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
              :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMPRC, :NSLDPRC, :ESTOQTIPOMOVPD, :TIPONF)
              INTO :NSLDPRC, :NCUSTOMPMPRC, :CESTOQMOVPROD;
          if (CMULTIALMOX='N') then
          begin
              NSLDPRCAX = NSLDPRC;
              NCUSTOMPMPRCAX = NCUSTOMPMPRC;
          end
          else
          begin
          SELECT NSALDO, NCUSTOMPM
              FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
              :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMPRCAX, :NSLDPRCAX, :ESTOQTIPOMOVPD, :TIPONF)
              INTO :NSLDPRCAX, :NCUSTOMPMPRCAX;
          end
          NCUSTOMPMLC = NCUSTOMPMPRC;
          NSLDLC = NSLDPRC;
          NCUSTOMPMLCAX = NCUSTOMPMPRCAX;
          NSLDLCAX = NSLDPRCAX;
      end
      else
      begin
          DDTPRC = DDTMOVPRODOLD;
          DDTPRCATE = DDTMOVPROD;
          /* verifica lançamento anterior e traz custo e saldo */

       --   execute procedure sgdebugsp('entrou no else','3');

          SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX
             FROM EQMOVPRODSLDSP(:ICODEMP, :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
             :SCODFILIALPD, :ICODPROD, :DDTPRC, 0, 0,
             :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
             INTO :NSLDPRC, :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX ;

          /* verifica lançamento anterior e traz custo e saldo */
          SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX
             FROM EQMOVPRODSLDSP(:ICODEMP, :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
             :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, :NCUSTOMPMLC, :NCUSTOMPMLCAX,
             :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
             INTO :NSLDLC, :NCUSTOMPMLC, :NSLDLCAX, :NCUSTOMPMLCAX ;

          /* verifica se havera mudança de saldo */
          SELECT NSALDO, NCUSTOMPM, CESTOQMOVPROD
              FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
              :ICODTIPOMOV, (:NQTDMOVPROD-:NQTDMOVPRODOLD), :NPRECOMOVPROD,
              :NCUSTOMPMLC, :NSLDLC, :ESTOQTIPOMOVPD, :TIPONF)
              INTO :NSLDLC, :NCUSTOMPMLC, :CESTOQMOVPROD;
          if (CMULTIALMOX='N') then
          begin
             NSLDLCAX = NSLDLC;
             NCUSTOMPMLCAX = NCUSTOMPMLC;
          end
          else
          begin
              SELECT NSALDO, NCUSTOMPM
                  FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
                  :ICODTIPOMOV, (:NQTDMOVPROD-:NQTDMOVPRODOLD), :NPRECOMOVPROD,
                  :NCUSTOMPMLCAX, :NSLDLCAX, :ESTOQTIPOMOVPD, :TIPONF)
                  INTO :NSLDLCAX, :NCUSTOMPMLCAX;
          end

      end

       SELECT NSLDPRC, NCUSTOMPMPRC, NSLDPRCAX, NCUSTOMPMPRCAX
        FROM EQMOVPRODPRCSLDSP( :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
          :SCODFILIALPD, :ICODPROD, :DDTPRC, :DDTPRCATE, :NSLDPRC,
          :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX,
          :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX, :TIPONF)
        INTO :NSLDPRC, :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX;

      UPDATE EQMOVPROD SET DTMOVPROD=:DDTMOVPROD,
         QTDMOVPROD=:NQTDMOVPROD, PRECOMOVPROD=:NPRECOMOVPROD,
         SLDMOVPROD=:NSLDLC, CUSTOMPMMOVPROD=:NCUSTOMPMLC,
         SLDMOVPRODAX=:NSLDLCAX, CUSTOMPMMOVPRODAX=:NCUSTOMPMLCAX,
         FLAG=:CFLAG, CODEMPNT=:ICODEMPNT, CODFILIALNT=:SCODFILIALNT,
         CODNAT=:CCODNAT, DOCMOVPROD=:IDOCMOVPROD, CODEMPTM=:ICODEMPTM,
         CODFILIALTM=:SCODFILIALTM, CODTIPOMOV=:ICODTIPOMOV, CODEMPLE=:ICODEMPLE,
         CODFILIALLE=:SCODFILIALLE, CODLOTE=:CCODLOTE, ESTOQMOVPROD=:CESTOQMOVPROD ,
         CODEMPAX=:ICODEMPAX, CODFILIALAX=:SCODFILIALAX, CODALMOX=:ICODALMOX
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPROD;
   end
   else /*  caso não tenha nenhuma alteração relevânte para processamento */

  --  execute procedure sgdebugsp('antes do reprocessamento','5SG');

      UPDATE EQMOVPROD SET FLAG=:CFLAG, CODEMPNT=:ICODEMPNT, CODFILIALNT=:SCODFILIALNT,
         CODNAT=:CCODNAT, DOCMOVPROD=:IDOCMOVPROD, CODEMPTM=:ICODEMPTM,
         CODFILIALTM=:SCODFILIALTM, CODTIPOMOV=:ICODTIPOMOV, CODEMPLE=:ICODEMPLE,
         CODFILIALLE=:SCODFILIALLE, CODLOTE=:CCODLOTE,
         CODEMPAX=:ICODEMPAX, CODFILIALAX=:SCODFILIALAX, CODALMOX=:ICODALMOX
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPROD;
end
^

/* Alter (FNADICLANCASP01) */
ALTER PROCEDURE FNADICLANCASP01(ICODREC INTEGER,
INPARCITREC INTEGER,
PDVITREC CHAR(1),
SNUMCONTA CHAR(10),
ICODEMPCA INTEGER,
ICODFILIALCA INTEGER,
ICODCLI INTEGER,
ICODEMPCL INTEGER,
ICODFILIALCL INTEGER,
SCODPLAN CHAR(13),
ICODEMPPN INTEGER,
ICODFILIALPN INTEGER,
IANOCC INTEGER,
SCODCC CHAR(19),
ICODEMPCC INTEGER,
ICODFILIALCC INTEGER,
DDTCOMPITREC DATE,
DDTPAGOITREC DATE,
SDOCLANCAITREC VARCHAR(15),
SOBSITREC CHAR(250),
DVLRPAGOITREC NUMERIC(15,5),
ICODEMP INTEGER,
ICODFILIAL SMALLINT,
DVLRPAGOJUROS NUMERIC(15,5),
DVLRDESC NUMERIC(15,5),
CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
CODCONTR INTEGER,
CODITCONTR SMALLINT)
 AS
declare variable icodlanca integer;
declare variable scodplanconta char(13);
declare variable icodemppconta integer;
declare variable icodfilialpconta integer;
declare variable cflag char(1);
declare variable ifiliallanca integer;
declare variable tipolanca char(1);
declare variable codempjr integer;
declare variable codfilialjr smallint;
declare variable codplanjr char(13);
declare variable codempdc integer;
declare variable codfilialdc smallint;
declare variable codplandc char(13);
declare variable codsublanca smallint = 1;
BEGIN
    SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNLANCA') INTO IFILIALLANCA;

    SELECT CODPLAN,CODEMPPN,CODFILIALPN FROM FNCONTA WHERE NUMCONTA = :SNUMCONTA
        AND CODEMP=:ICODEMPCA AND CODFILIAL=:ICODFILIALCA INTO :sCodPlanConta,:iCodEmpPConta,:iCodFilialPConta;

    SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALLANCA,'LA') INTO ICODLANCA;

    SELECT FLAG FROM FNRECEBER WHERE CODREC=:ICODREC
        AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO :cFlag;

    SELECT CODEMPJR,CODFILIALJR,CODPLANJR,CODEMPDC,CODFILIALDC,CODPLANDC FROM SGPREFERE1
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
        INTO :CODEMPJR,:CODFILIALJR,:CODPLANJR,:CODEMPDC,:CODFILIALDC,:CODPLANDC;


    IF (ICODCLI IS NULL) THEN
        TIPOLANCA = 'A';
    ELSE
        TIPOLANCA = 'C';

    if ( (DVLRPAGOJUROS IS NULL) OR (:CODPLANJR IS NULL)  ) then
        DVLRPAGOJUROS = 0;
    else
        DVLRPAGOITREC = DVLRPAGOITREC - DVLRPAGOJUROS;

    if (DVLRDESC IS NULL  OR (:CODPLANDC IS NULL) ) then
        DVLRDESC = 0;
    else
        DVLRPAGOITREC = DVLRPAGOITREC + DVLRDESC;


    INSERT INTO FNLANCA (TIPOLANCA,CODEMP,CODFILIAL,CODLANCA,CODEMPRC,CODFILIALRC,CODREC,NPARCITREC,CODEMPPN,CODFILIALPN,CODPLAN, 
        DTCOMPLANCA, DATALANCA, DOCLANCA,HISTBLANCA,DTPREVLANCA,VLRLANCA,FLAG,CODEMPCL,CODFILIALCL,CODCLI,PDVITREC)
        VALUES (:TIPOLANCA,:ICODEMP,:IFILIALLANCA,:iCodLanca,:ICODEMP,:ICODFILIAL,:ICODREC,:iNParcItRec,:iCodEmpPConta,:iCodFilialPConta,
                :sCodPlanConta,:dDtCompItRec, :dDtPagoItRec,:sDocLancaItRec,:sObsItRec,:dDtPagoItRec,0,:cFlag,:ICODEMPCL,:ICODFILIALCL,:ICODCLI,:PDVITREC
        );

    INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPCL,CODFILIALCL,CODCLI,CODEMPPN,CODFILIALPN,CODPLAN,
                CODEMPRC, CODFILIALRC, CODREC, NPARCITREC,
                CODEMPCC, CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA, DTCOMPSUBLANCA, DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,FLAG, CODEMPCT, CODFILIALCT, CODCONTR, CODITCONTR)
        VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPCL,:ICODFILIALCL,:ICODCLI,:ICODEMPPN,:ICODFILIALPN,:SCODPLAN,
                :ICODEMP, :ICODFILIAL, :ICODREC, :INPARCITREC,
                :ICODEMPCC,:ICODFILIALCC,:IANOCC,:SCODCC,'S',:dDtCompItRec,:dDtPagoItRec,:dDtPagoItRec,:dVlrPagoItRec*-1,:cFlag, :codempct, :codfilialct, :codcontr, :coditcontr
        );

    -- Lançamento dos juros em conta distinta.

    IF(DVLRPAGOJUROS > 0) THEN
    BEGIN

        CODSUBLANCA = CODSUBLANCA + 1;

        INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPCL,CODFILIALCL,CODCLI,CODEMPPN,CODFILIALPN,CODPLAN,
                 CODEMPRC, CODFILIALRC, CODREC, NPARCITREC,
                  CODEMPCC, CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DTCOMPSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,FLAG, TIPOSUBLANCA, CODEMPCT, CODFILIALCT, CODCONTR, CODITCONTR)
        VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPCL,:ICODFILIALCL,:ICODCLI,:CODEMPJR,:CODFILIALJR,:CODPLANJR,
                :ICODEMP, :ICODFILIAL, :ICODREC, :INPARCITREC,
                :ICODEMPCC, :ICODFILIALCC,:IANOCC,:SCODCC,'S',:dDtCompItRec,:dDtPagoItRec,:dDtPagoItRec,:DVLRPAGOJUROS*-1,:cFlag, 'J', :codempct, :codfilialct, :codcontr, :coditcontr
        );

    END

    -- Lançamento do desconto em conta distinta.

    IF(DVLRDESC > 0) THEN
    BEGIN

        CODSUBLANCA = CODSUBLANCA + 1;

        INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPCL,CODFILIALCL,CODCLI,CODEMPPN,CODFILIALPN,CODPLAN,
             CODEMPRC, CODFILIALRC, CODREC, NPARCITREC,
             CODEMPCC, CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DTCOMPSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,FLAG, TIPOSUBLANCA
             ,CODEMPCT, CODFILIALCT, CODCONTR, CODITCONTR)
        VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPCL,:ICODFILIALCL,:ICODCLI,:CODEMPDC,:CODFILIALDC,:CODPLANDC,
               :ICODEMP, :ICODFILIAL, :ICODREC, :INPARCITREC,
             :ICODEMPCC, :ICODFILIALCC,:IANOCC,:SCODCC,'S',:dDtCompItRec,:dDtPagoItRec,:dDtPagoItRec,:DVLRDESC,:cFlag, 'D'
             , :codempct, :codfilialct, :codcontr, :coditcontr
        );

    END


END
^

/* Alter (FNADICLANCASP02) */
ALTER PROCEDURE FNADICLANCASP02(ICODPAG INTEGER,
INPARCPAG INTEGER,
SNUMCONTA CHAR(10),
ICODEMPCA INTEGER,
ICODFILIALCA INTEGER,
ICODFOR INTEGER,
ICODEMPFR INTEGER,
ICODFILIALFR INTEGER,
SCODPLAN CHAR(13),
ICODEMPPN INTEGER,
ICODFILIALPN INTEGER,
IANOCC INTEGER,
SCODCC CHAR(19),
ICODEMPCC INTEGER,
ICODFILIALCC INTEGER,
DDTCOMPITPAG DATE,
DDTPAGOITPAG DATE,
SDOCLANCAITPAG VARCHAR(15),
SOBSITPAG CHAR(250),
DVLRPAGOITPAG NUMERIC(15,5),
ICODEMP INTEGER,
ICODFILIAL SMALLINT,
DVLRJUROSPAG NUMERIC(15,5),
DVLRDESC NUMERIC(15,5),
CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
CODCONTR INTEGER,
CODITCONTR SMALLINT)
 AS
declare variable icodlanca integer;
declare variable scodplanconta char(13);
declare variable icodemppconta integer;
declare variable icodfilialpconta integer;
declare variable cflag char(1);
declare variable ifiliallanca integer;
declare variable tipolanca char(1);
declare variable codempjp integer;
declare variable codfilialjp smallint;
declare variable codplanjp char(13);
declare variable codempdr integer;
declare variable codfilialdr smallint;
declare variable codplandr char(13);
declare variable codsublanca smallint = 1;
BEGIN

    SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNLANCA')
    INTO IFILIALLANCA;

    SELECT CODPLAN,CODEMP,CODFILIAL FROM FNCONTA
    WHERE NUMCONTA=:sNumConta AND CODEMP=:ICODEMPCA AND CODFILIAL=:ICODFILIALCA
    INTO :sCodPlanConta,:iCodEmpPConta,:iCodFilialPConta;

    SELECT ISEQ FROM SPGERANUM(:iCODEMP,:IFILIALLANCA,'LA')
    INTO :iCodLanca;

    SELECT FLAG FROM FNPAGAR
    WHERE CODPAG=:iCodPag AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
    INTO :cFlag;

    SELECT CODEMPJP,CODFILIALJP,CODPLANJP,CODEMPDR,CODFILIALDR,CODPLANDR
    FROM SGPREFERE1
    WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
    INTO :CODEMPJP,:CODFILIALJP,:CODPLANJP,:CODEMPDR,:CODFILIALDR,:CODPLANDR;

    IF (ICODFOR IS NULL) THEN
        TIPOLANCA = 'A';
      ELSE
        TIPOLANCA = 'F';

    if ( (DVLRJUROSPAG IS NULL) OR (:CODPLANJP IS NULL)  ) then
        DVLRJUROSPAG = 0;
    else
        DVLRPAGOITPAG = DVLRPAGOITPAG - DVLRJUROSPAG;

    if (DVLRDESC IS NULL  OR (:CODPLANDR IS NULL) ) then
        DVLRDESC = 0;
    else
        DVLRPAGOITPAG = DVLRPAGOITPAG + DVLRDESC;

    INSERT INTO FNLANCA (TIPOLANCA,CODEMP,CODFILIAL,CODLANCA,CODEMPPG,CODFILIALPG,CODPAG,
                         NPARCPAG,CODEMPPN,CODFILIALPN,CODPLAN,DTCOMPLANCA,DATALANCA,DOCLANCA,
                         HISTBLANCA,DTPREVLANCA,VLRLANCA,FLAG, CODEMPFR, CODFILIALFR, CODFOR)
         VALUES (:TIPOLANCA,:ICODEMP,:IFILIALLANCA,:iCodLanca,:ICODEMP,:ICODFILIAL,:iCodPag,
                 :iNParcPag,:iCodEmpPConta,:iCodFilialPConta,:sCodPlanConta, :dDtCompItPag, :dDtPagoItPag,:sDocLancaItPag,
                 :sObsItPag,:dDtPagoItPag,0,:cFlag, :ICODEMPFR, :ICODFILIALFR, :ICODFOR
         );

    INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPFR,CODFILIALFR,CODFOR,CODEMPPN,CODFILIALPN, CODPLAN,
        CODEMPPG, CODFILIALPG, CODPAG, NPARCPAG,
        CODEMPCC,CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DTCOMPSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,FLAG,
        CODEMPCT, CODFILIALCT, CODCONTR, CODITCONTR)
        VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPFR,:ICODFILIALFR,:ICODFOR,:ICODEMPPN,:ICODFILIALPN, :sCodplan,
        :ICODEMP,:ICODFILIAL,:iCodPag, :iNParcPag,
        :ICODEMPCC,:ICODFILIALCC,:IANOCC,:SCODCC,'E',:dDtCompItPag,:dDtPagoItPag,:dDtPagoItPag,:dVlrPagoItPag,:cFlag,
        :codempct, :codfilialct, :codcontr, :coditcontr);

    -- Lançamento dos juros em conta distinta.

    IF(DVLRJUROSPAG >0) THEN
    BEGIN

        CODSUBLANCA = CODSUBLANCA + 1;

        INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPFR,CODFILIALFR,CODFOR,
             CODEMPPN,CODFILIALPN,CODPLAN,CODEMPCC,CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DTCOMPSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,
             CODEMPPG, CODFILIALPG, CODPAG, NPARCPAG, FLAG, TIPOSUBLANCA
             , CODEMPCT, CODFILIALCT, CODCONTR, CODITCONTR
             )
            VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPFR,:ICODFILIALFR,:ICODFOR,
            :CODEMPJP,:CODFILIALJP,:CODPLANJP,:ICODEMPCC,:ICODFILIALCC,:IANOCC,:SCODCC,'E',:dDtCompItPag,:dDtPagoItPag,:dDtPagoItPag,:DVLRJUROSPAG,
            :ICODEMP, :ICODFILIAL, :iCodPag, :iNParcPag,:cFlag, 'J'
            , :codempct, :codfilialct, :codcontr, :coditcontr
            );

    END

    -- Lançamento de desconto em conta distinta.

    IF(DVLRDESC >0) THEN
    BEGIN

        CODSUBLANCA = CODSUBLANCA + 1;

        INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPFR,CODFILIALFR,CODFOR,
        CODEMPPN,CODFILIALPN,CODPLAN,CODEMPCC,CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DTCOMPSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,
              CODEMPPG, CODFILIALPG, CODPAG, NPARCPAG, FLAG, TIPOSUBLANCA
              , CODEMPCT, CODFILIALCT, CODCONTR, CODITCONTR)
            VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,:CODSUBLANCA,:ICODEMPFR,:ICODFILIALFR,:ICODFOR,
             :CODEMPDR,:CODFILIALDR,:CODPLANDR,:ICODEMPCC,:ICODFILIALCC,:IANOCC,:SCODCC,'E',:dDtCompItPag,:dDtPagoItPag,:dDtPagoItPag,:DVLRDESC*-1
             ,:ICODEMP, :ICODFILIAL, :iCodPag, :iNParcPag, :cFlag, 'D'
             ,:codempct, :codfilialct, :codcontr, :coditcontr
             );

    END

END
^

/* Alter (FNCHECAPGTOSP) */
ALTER PROCEDURE FNCHECAPGTOSP(CODCLI INTEGER,
CODEMP INTEGER,
CODFILIAL SMALLINT,
BLOQVDPORATRASO CHAR(1),
NUMDIASBLOQ SMALLINT)
 RETURNS(RETORNO VARCHAR(15))
 AS
DECLARE VARIABLE LINHAS INTEGER;
DECLARE VARIABLE CODFILIALRC INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'FNRECEBER') INTO :CODFILIALRC;
  SELECT COUNT(*) FROM FNITRECEBER IR, FNRECEBER R
     WHERE R.CODEMPCL=:CODEMP AND R.CODFILIALCL=:CODFILIAL AND R.CODCLI=:CODCLI 
       AND IR.CODEMP=R.CODEMP AND IR.CODFILIAL=R.CODFILIAL AND IR.CODREC=R.CODREC
       AND IR.STATUSITREC IN ('R1','RL')
       AND IR.CODEMP=:CODEMP AND IR.CODFILIAL=:CODFILIALRC 
       INTO :LINHAS;
  IF (LINHAS > 0) THEN
  BEGIN
    RETORNO = 'N';
    IF (BLOQVDPORATRASO = 'S' ) THEN
    BEGIN
       SELECT COUNT(*) FROM FNITRECEBER IR, FNRECEBER R
          WHERE R.CODEMPCL=:CODEMP AND R.CODFILIALCL=:CODFILIAL AND R.CODCLI=:CODCLI 
          AND IR.CODEMP=R.CODEMP AND IR.CODFILIAL=R.CODFILIAL AND IR.CODREC=R.CODREC
          AND IR.STATUSITREC IN ('R1')
          AND IR.CODEMP=:CODEMP AND IR.CODFILIAL=:CODFILIALRC
          AND ( IR.DTVENCITREC + :NUMDIASBLOQ ) < CAST( 'TODAY' as DATE)   
          INTO :LINHAS;
       IF (LINHAS>0) THEN 
          RETORNO = 'N='||:LINHAS;
    END
  END
  ELSE
    RETORNO = 'S';
  SUSPEND;
END
^

/* Alter (SGRETVERSAO) */
ALTER PROCEDURE SGRETVERSAO RETURNS(VERSAO VARCHAR(30))
 AS
begin
    versao = '1.2.6.1 (29/05/2013)';
    suspend;
end
^

/* Alter (VDADICITORCRECMERCSP) */
ALTER PROCEDURE VDADICITORCRECMERCSP(CODEMP INTEGER,
CODFILIAL SMALLINT,
TICKET INTEGER,
CODEMPOC INTEGER,
CODFILIALOC SMALLINT,
CODORC INTEGER,
COMPONENTES CHAR(1),
SERVICOS CHAR(1),
NOVOS CHAR(1))
 AS
declare variable codemppd integer;
declare variable codfilialpd integer;
declare variable codprod integer;
declare variable coditos integer;
declare variable coditorc integer;
declare variable codprodant integer;
declare variable coditrecmerc integer;
declare variable refprod varchar(20);
declare variable codemptm integer;
declare variable codfilialtm smallint;
declare variable codtipomov integer;
declare variable codempax integer;
declare variable codfilialax smallint;
declare variable codalmox integer;
declare variable precoitorc numeric(15,5);
declare variable qtditorc numeric(15,5);
declare variable codempcl integer;
declare variable codfilialcl smallint;
declare variable codcli integer;
declare variable codemppg integer;
declare variable codfilialpg smallint;
declare variable codplanopag integer;
declare variable gerachamado char(1);
declare variable obsitorc varchar(10000);
declare variable descprod char(100);
declare variable vlrliqitorc numeric(15,5);
declare variable vlrproditorc numeric(15,5);
declare variable usaprecopecaserv char(1);
declare variable codprodpeca integer;
declare variable garantia char(1);
declare variable codprodir integer;
declare variable refprodir varchar(20);
begin
    
    -- Buscando preferencias do GMS
    select coalesce(p8.usaprecopecaserv,'N') from sgprefere8 p8
    where p8.codemp=:codemp and p8.codfilial=:codfilial
    into :usaprecopecaserv;

    -- Buscando informações do orçamento
    select codempcl, codfilialcl, codcli, codemppg, codfilialpg, codplanopag, codemptm, codfilialtm, codtipomov
    from vdorcamento
    where codemp=:codempoc and codfilial=:codfilialoc and codorc=:codorc and tipoorc='O'
    into :codempcl, :codfilialcl, :codcli, :codemppg, :codfilialpg, :codplanopag, :codemptm, :codfilialtm, :codtipomov;

    -- Sendo um orçamento para peças e mão-de-obra
    -- Deve gerar orçamento dos ítens de suplemento
    for select ir.codemppd, ir.codfilialpd, ir.codprodpd, ir.refprodpd, ir.coditrecmerc, ir.coditos, ir.qtditos,
        ir.gerachamado, pd.descprod, irm.codprod, irm.garantia, irm.codprod codprodir, irm.refprod refprodir
        from eqitrecmercitos ir, eqitrecmerc irm, eqproduto pd
        where
        irm.codemp=ir.codemp and irm.codfilial=ir.codfilial and irm.ticket=ir.ticket and irm.coditrecmerc=ir.coditrecmerc
        and pd.codemp=irm.codemppd and pd.codfilial=irm.codfilialpd and irm.codprod=pd.codprod
        and ir.codemp=:codemp and ir.codfilial=:codfilial and ir.ticket=:ticket and
        -- Filtrando componentes e serviços
        (
           (ir.gerarma=:componentes and ir.gerarma='S') or
           (ir.gerachamado=:servicos and ir.gerachamado='S') or
           (ir.geranovo=:novos and ir.geranovo='S')
        )

        into :codemppd, :codfilialpd, :codprod, :refprod, :coditrecmerc, :coditos, :qtditorc,
             :gerachamado, :descprod, :codprodpeca, :garantia, :codprodir, :refprodir
        do
        begin

--            if(:codprod <> :codprodant or :codprodant is null) then
--            begin

                -- Verifica se é serviço, sendo serviço insere a descriçao do produto
                -- consertado na descrição auxiliar do item de orçamento
                if(:gerachamado=:servicos and :gerachamado='S') then
                begin
                    if( 'N' = :garantia ) then
                    begin
                        obsitorc = :refprodir || ' - ' || :descprod;
                    end
                    else
                    begin
                        obsitorc = :refprodir || ' - ' || :descprod || '[G]';
                    end

                end

                --Buscando código do item de orçamento
                select coalesce(max(coditorc)+1,1) from vditorcamento io
                where io.codemp=:codempoc and io.codfilial=:codfilialoc and io.codorc=:codorc and io.tipoorc='O'
                into :coditorc;

                -- Buscando preço de venda
                -- Se não está em garantia...

                if('N' = :garantia) then
                begin
                    -- Se o preço é basedo na peca, deve buscar o preço da peça
                    if(usaprecopecaserv='S') then
                    begin
                        select preco from vdbuscaprecosp(:codprodpeca,:codcli,:codempcl,:codfilialcl,
                        :codplanopag,:codemppg,:codfilialpg,:codtipomov,:codemptm,:codfilialtm,:codemp,:codfilial)
                        into :precoitorc;
                    end
                    else
                    begin
                        select preco from vdbuscaprecosp(:codprod,:codcli,:codempcl,:codfilialcl,
                        :codplanopag,:codemppg,:codfilialpg,:codtipomov,:codemptm,:codfilialtm,:codemp,:codfilial)
                        into :precoitorc;
                    end
                end
                else
                begin

                    precoitorc = 0.00;

                end

                -- Buscando informações do produto
                select pd.codempax, pd.codfilialax, pd.codalmox, pd.refprod from eqproduto pd
                where pd.codemp=:codemppd and pd.codfilial=:codfilialpd and pd.codprod=:codprod
                into :codempax, :codfilialax, :codalmox, :refprod;

                vlrproditorc = :qtditorc * :precoitorc;
                vlrliqitorc = vlrproditorc;

                -- Inserir itens
                insert into vditorcamento (
                codemp, codfilial, codorc, tipoorc, coditorc,
                codemppd, codfilialpd, codprod, refprod,
                qtditorc, precoitorc, codempax, codfilialax, codalmox, obsitorc, vlrproditorc, vlrliqitorc, sitproditorc)
                values (:codempoc, :codfilialoc, :codorc, 'O', :coditorc,
                :codemppd, :codfilialpd, :codprod, :refprod,
                :qtditorc, :precoitorc, :codempax, :codfilialax, :codalmox, :obsitorc, :vlrproditorc, :vlrliqitorc,
                'PE') ;

                -- Inserindo vínculo entre item de orçamento e ordem de serviço

                insert into eqitrecmercitositorc(codemp, codfilial, ticket, coditrecmerc, coditos, codempoc, codfilialoc, codorc, coditorc, tipoorc)
                values(:codemp,:codfilial,:ticket,:coditrecmerc,:coditos, :codempoc,:codfilialoc,:codorc,:coditorc,'O');

                codprodant = codprod;

--            end
        end

        -- Atualizando o status da ordem de serviço
        update eqrecmerc rm set rm.status = 'EO'
        where rm.codemp=:codemp and rm.codfilial=:codfilial and rm.ticket=:ticket;

end
^

/* Alter (VDBUSCAPRECOSP) */
ALTER PROCEDURE VDBUSCAPRECOSP(ICODPROD INTEGER,
ICODCLI INTEGER,
ICODEMPCL INTEGER,
ICODFILIALCL SMALLINT,
ICODPLANOPAG INTEGER,
ICODEMPPG INTEGER,
ICODFILIALPG SMALLINT,
ICODTIPOMOV INTEGER,
ICODEMPTM INTEGER,
ICODFILIALTM SMALLINT,
ICODEMP INTEGER,
ICODFILIAL SMALLINT)
 RETURNS(PRECO NUMERIC(14,5),
CODCLASCLIP INTEGER,
CODPLANOPAGP INTEGER,
CODPRECOPRODP INTEGER,
CODTABP INTEGER)
 AS
declare variable icodtab integer;
declare variable icodemptab integer;
declare variable icodfilialtab smallint;
declare variable icodclascli integer;
declare variable icodempclascli integer;
declare variable icodfilialclascli smallint;
declare variable percdesccli numeric(3,2);
declare variable desccli char(1);
declare variable arredpreco smallint;
declare variable codfilialpf integer;
declare variable centavos decimal(2,2);
declare variable precobase decimal(15,5);

begin
    -- Buscando código da filial de preferencias
    select icodfilial from sgretfilial(:icodemp,'SGFILIAL') into :codfilialpf;

    -- Buscando preferencias de arredondamento;
    select coalesce(arredpreco, 0)
    from sgprefere1 p1
    where p1.codemp=:icodemp and p1.codfilial=:codfilialpf
    into :arredpreco;

    -- Buscando tabela de preços do tipo de movimento;
    select codtab, codemptb, codfilialtb
    from eqtipomov
    where codtipomov=:icodtipomov and codemp=:icodemptm and codfilial=:icodfilialtm
    into :icodtab, :icodemptab, :icodfilialtab;


    -- Buscando informações do produto
    select coalesce(pd.desccli,'N'), coalesce(precobaseprod,0) from eqproduto pd
        where pd.codprod=:icodprod and pd.codemp=:icodemp and pd.codfilial=:icodfilial
        into :desccli, :precobase;

    -- Buscando informações do cliente
        
    select codclascli, codempcc, codfilialcc, coalesce(percdesccli,0) percdesccli
    from vdcliente
    where codcli=:icodcli and codemp=:icodempcl and codfilial=:icodfilialcl
    into :icodclascli, :icodempclascli, icodfilialclascli, :percdesccli;

     -- Buscando preço da tabela de preços utilizando todos os filtros exceto tabela de preços
    for select pp.codclascli, pp.codplanopag, pp.codtab, pp.codprecoprod, pp.precoprod
    from vdprecoprod pp
    where pp.codemp=:icodemp and pp.codfilial=:icodfilial and pp.codprod=:icodprod
    and pp.ativoprecoprod='S'
    and ( ( pp.codplanopag is null ) or (pp.codemppg=:icodemppg and pp.codfilialpg=:icodfilialpg and pp.codplanopag=:icodplanopag ) )
    and ( ( pp.codclascli is null) or (pp.codempcc=:icodempclascli and pp.codfilialcc=:icodfilialclascli and pp.codclascli=:icodclascli ) )
    order by pp.codclascli, pp.codplanopag, pp.codtab, pp.codprecoprod
    into :codclasclip, :codplanopagp, :codtabp, :codprecoprodp, :preco do
    begin
        --exception vdvendaex01 'Teste';

        if ( (:preco is not null) or (:preco <> 0) ) then
        begin
            --suspend;
            break;
        end
    end

    -- Buscando preço da tabela de preços específica
    if ( (:preco is null) or (:preco = 0) ) then
    begin

        for select pp.codclascli, pp.codplanopag, pp.codtab, pp.codprecoprod, pp.precoprod
        from vdprecoprod pp
        where pp.codemp=:icodemp and pp.codfilial=:icodfilial and pp.codprod=:icodprod
        and pp.ativoprecoprod='S'
        and pp.codemptb=:icodemptab and pp.codfilialtb=:icodfilialtab and pp.codtab=:icodtab
        order by pp.codclascli, pp.codplanopag, pp.codtab, pp.codprecoprod
        into :codclasclip, :codplanopagp, :codtabp, :codprecoprodp, :preco do
        begin
            --exception vdvendaex01 'Teste';

            if ( (:preco is not null) or (:preco <> 0) ) then
            begin
               --suspend;
               break;
            end
        end
    end

    --Se ainda não conseguiu pagar o preco, deve utilizar o preço base do produto aplicando o desconto especial do cliente se houver
    if ((preco is null) or (preco = 0)) then
    begin
         preco = precobase;
    end

    -- Verifica se o cliente possui desconto especial e o produto permite este desconto...
    if( percdesccli >0 and 'S' = :desccli ) then
    begin
         preco = :preco - (:preco * (:percdesccli / 100)) ;
    end

    if( :arredpreco > 0 ) then
    begin

        -- capturando valor dos centavos
        centavos = ( cast(:preco as decimal(15,2)) - truncate(preco) ) * 10;

        -- se o valor em centavos é maior ou igual ao parametro de arredondamento (arredondar para cima)
        if(:centavos >= :arredpreco) then
        begin
            preco = truncate(preco) + 1;
        end
        else
        begin
            preco = truncate(preco);
        end

    end

    suspend;

end
^

/* Alter (VDCONTRATOTOTSP) */
ALTER PROCEDURE VDCONTRATOTOTSP(CODEMPCT INTEGER,
CODFILIALCT SMALLINT,
CODCONTR INTEGER,
CODITCONTR INTEGER,
CODEMPSC INTEGER,
CODFILIALSC SMALLINT,
CODCONTRSC INTEGER,
CODEMPTA INTEGER,
CODFILIALTA SMALLINT,
CODTAREFA INTEGER,
CODEMPST INTEGER,
CODFILIALST SMALLINT,
CODTAREFAST INTEGER,
DATAINI DATE,
DATAFIM DATE)
 RETURNS(TOTALPREVGERAL NUMERIC(15,5),
TOTALPREVPER NUMERIC(15,5),
TOTALGERAL NUMERIC(15,5),
TOTALCOBCLIGERAL NUMERIC(15,5),
TOTALANT NUMERIC(15,5),
TOTALCOBCLIANT NUMERIC(15,5),
TOTALPER NUMERIC(15,5),
TOTALCOBCLIPER NUMERIC(15,5),
SALDOANT NUMERIC(15,5),
SALDOPER NUMERIC(15,5))
 AS
begin
  if (:codcontrsc is not null) then
  begin
     codempct = codempsc;
     codfilialct = codfilialsc;
     codcontr = codcontrsc;
  end
  if (:codtarefast is not null) then
  begin
     codempta = codempst;
     codfilialta = codfilialst;
     codtarefa = codtarefast;
  end
  select sum(a.totalgeral), sum(a.totalcobcli)
   from atatendimentovw02 a
    left outer join crtarefa ta
      on ta.codemp=a.codempta and ta.codfilial=a.codfilialta and ta.codtarefa=a.codtarefa
    left outer join crtarefa st
      on st.codempta=ta.codemp and st.codfilialta=ta.codemp and st.codtarefata=ta.codtarefa
    where a.codempct=:codempct and a.codfilialct=:codfilialct and a.codcontr=:codcontr and
    (:coditcontr is null or a.coditcontr=:coditcontr) and
    (
       (:codtarefa is null) or
       (st.codtarefa is null and ta.codemp=:codempta and ta.codfilial=:codfilialta and ta.codtarefa=:codtarefa ) or
       (st.codtarefa is not null and st.codempta=:codempta and st.codfilialta=:codfilialta and st.codtarefata=:codtarefa )
    )
  into :totalgeral,  :totalcobcligeral;

  select sum(a.totalgeral), sum(a.totalcobcli)
   from atatendimentovw02 a
    left outer join crtarefa ta
      on ta.codemp=a.codempta and ta.codfilial=a.codfilialta and ta.codtarefa=a.codtarefa
    left outer join crtarefa st
      on st.codempta=ta.codemp and st.codfilialta=ta.codemp and st.codtarefata=ta.codtarefa
    where a.codempct=:codempct and a.codfilialct=:codfilialct and a.codcontr=:codcontr and
    (:coditcontr is null or a.coditcontr=:coditcontr) and
      a.dataatendo between :dataini and :datafim and
    (
       (:codtarefa is null) or
       (st.codtarefa is null and ta.codemp=:codempta and ta.codfilial=:codfilialta and ta.codtarefa=:codtarefa ) or
       (st.codtarefa is not null and st.codempta=:codempta and st.codfilialta=:codfilialta and st.codtarefata=:codtarefa )
    )
  into :totalper,  :totalcobcliper;

  select sum(a.totalgeral), sum(a.totalcobcli)
   from atatendimentovw02 a
    left outer join crtarefa ta
     on ta.codemp=a.codempta and ta.codfilial=a.codfilialta and ta.codtarefa=a.codtarefa
    left outer join crtarefa st
      on st.codempta=ta.codemp and st.codfilialta=ta.codemp and st.codtarefata=ta.codtarefa
    where a.codempct=:codempct and a.codfilialct=:codfilialct and a.codcontr=:codcontr and
    (:coditcontr is null or a.coditcontr=:coditcontr) and
     a.dataatendo < :dataini and
    (
       (:codtarefa is null) or
       (st.codtarefa is null and ta.codemp=:codempta and ta.codfilial=:codfilialta and ta.codtarefa=:codtarefa ) or
       (st.codtarefa is not null and st.codempta=:codempta and st.codfilialta=:codfilialta and st.codtarefata=:codtarefa )
    )
  into :totalant,  :totalcobcliant;

  select sum(coalesce(st.tempodectarefa, ta.tempodectarefa) )
    from crtarefa ta
    left outer join crtarefa st
      on st.codempta=ta.codemp and st.codfilialta=ta.codemp and st.codtarefata=ta.codtarefa
    where ta.codempct=:codempct and ta.codfilialct=:codfilialct and ta.codcontr=:codcontr and
    (:coditcontr is null or ta.coditcontr=:coditcontr) and
    (
       (:codtarefa is null) or
       (st.codtarefa is null and ta.codemp=:codempta and ta.codfilial=:codfilialta and ta.codtarefa=:codtarefa ) or
       (st.codtarefa is not null and st.codempta=:codempta and st.codfilialta=:codfilialta and st.codtarefata=:codtarefa )
    )
  into totalprevgeral;

  select sum(tp.tempodectarefa)
   from crtarefa ttp, crtarefaper tp
    left outer join crtarefa ta
      on ta.codemp=ttp.codempta and ta.codfilial=ttp.codfilialta and ta.codtarefa=ttp.codtarefa
    left outer join crtarefa st
      on st.codempta=ta.codemp and st.codfilialta=ta.codemp and st.codtarefata=ta.codtarefa
    where ttp.codemp=tp.codemp and ttp.codfilial=tp.codfilial and ttp.codtarefa=tp.codtarefa and
      ttp.codempct=:codempct and ttp.codfilialct=:codfilialct and ttp.codcontr=:codcontr and
    (:coditcontr is null or ttp.coditcontr=:coditcontr) and
      tp.dtiniper>=:dataini and tp.dtfimper<=:datafim and
    (
       (:codtarefa is null) or
       (st.codtarefa is null and ta.codemp=:codempta and ta.codfilial=:codfilialta and ta.codtarefa=:codtarefa ) or
       (st.codtarefa is not null and st.codempta=:codempta and st.codfilialta=:codfilialta and st.codtarefata=:codtarefa )
    )
  into :totalprevper;

  if (totalgeral is null) then
      totalgeral = 0;
  if (totalcobcligeral is null) then
      totalcobcligeral = 0;
  if (totalant is null) then
      totalant = 0;
  if (totalcobcliant is null) then
      totalcobcliant = 0;
  if (totalper is null) then
      totalper = 0;
  if (totalcobcliper is null) then
      totalcobcliper = 0;
  saldoant = totalprevgeral - totalcobcliant;
  saldoper = totalprevper - totalcobcliper;

  suspend;
end
^

/* Alter (VDCOPIACLIENTE) */
ALTER PROCEDURE VDCOPIACLIENTE(ICODCLI INTEGER,
IDOCUMENTO VARCHAR(14),
ICODEMP INTEGER,
ICODFILIAL INTEGER)
 RETURNS(ICOD INTEGER)
 AS
declare variable inovocod integer;
declare variable usacliseq char(1);
begin
    
  SELECT USACLISEQ FROM SGPREFERE1 WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO :USACLISEQ;
  IF (:USACLISEQ='S') THEN
      select iseq from spgeranum(:ICODEMP,:ICODFILIAL,'CL') into INOVOCOD;
  ELSE
      SELECT MAX(CODCLI)+1 FROM VDCLIENTE WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO INOVOCOD;

    INSERT INTO VDCLIENTE (CODEMP, CODFILIAL, CODCLI, RAZCLI, NOMECLI, CODEMPCC, CODFILIALCC,
        CODCLASCLI, CODEMPVD, CODFILIALVD, CODVEND, CODEMPTC, CODFILIALTC, CODTIPOCOB, CODEMPPG,
        CODFILIALPG, CODPLANOPAG, CODEMPTN, CODFILIALTN, CODTRAN, CODEMPBO, CODFILIALBO, CODBANCO,
        CODEMPSR, CODFILIALSR, CODSETOR, CODEMPTI, CODFILIALTI, CODTIPOCLI, CODTPCRED, CODFILIALTR,
        CODEMPTR, CODFISCCLI, CODEMPFC, CODFILIALFC, CODEMPEC, CODFILIALEC, CODTBEC, CODITTBEC, CODEMPHP,
        CODFILIALHP, CODHIST, CODEMPCB, CODFILIALCB, CODCARTCOB, DATACLI, PESSOACLI, ATIVOCLI, CNPJCLI,
        INSCCLI, CPFCLI, RGCLI, SSPCLI, ENDCLI, NUMCLI, COMPLCLI, BAIRCLI, CIDCLI, UFCLI, CEPCLI, DDDCLI,
        FONECLI, RAMALCLI, DDDFAXCLI, FAXCLI, EMAILCLI, EMAILCOB, EMAILENT, EMAILNFECLI, CONTCLI, ENDCOB,
        NUMCOB, COMPLCOB, BAIRCOB, CIDCOB, UFCOB, CEPCOB, DDDFONECOB, FONECOB, DDDFAXCOB, FAXCOB, ENDENT,
        NUMENT, COMPLENT, BAIRENT, CIDENT, UFENT, CEPENT, DDDFONEENT, FONEENT, DDDFAXENT, FAXENT, OBSCLI,
        AGENCIACLI, CODEMPPQ, CODFILIALPQ, CODPESQ, INCRACLI, DTINITR, DTVENCTOTR, NIRFCLI, SIMPLESCLI, DDDCELCLI,
        CELCLI, NATCLI, UFNATCLI, TEMPORESCLI, APELIDOCLI, SITECLI, CODCONTDEB, CODCONTCRED, CODCLICONTAB,
        FOTOCLI, IMGASSCLI, CODMUNIC, SIGLAUF, CODPAIS, CODMUNICENT, SIGLAUFENT, CODPAISENT, CODMUNICCOB,
        SIGLAUFCOB, CODPAISCOB, CODEMPUC, CODFILIALUC, CODUNIFCOD, SUFRAMACLI, PRODRURALCLI, CTOCLI, CODCNAE,
        INSCMUNCLI, PERCDESCCLI, CONTCLICOB, CONTCLIENT, DESCIPI, DDDCELENT, CELENT)
        SELECT :ICODEMP, :ICODFILIAL, :INOVOCOD, RAZCLI, NOMECLI, CODEMPCC, CODFILIALCC, CODCLASCLI, CODEMPVD,
            CODFILIALVD, CODVEND, CODEMPTC, CODFILIALTC, CODTIPOCOB, CODEMPPG, CODFILIALPG, CODPLANOPAG, CODEMPTN,
            CODFILIALTN, CODTRAN, CODEMPBO, CODFILIALBO, CODBANCO, CODEMPSR, CODFILIALSR, CODSETOR, CODEMPTI,
            CODFILIALTI, CODTIPOCLI, CODTPCRED, CODFILIALTR, CODEMPTR, CODFISCCLI, CODEMPFC, CODFILIALFC, CODEMPEC,
            CODFILIALEC, CODTBEC, CODITTBEC, CODEMPHP, CODFILIALHP, CODHIST, CODEMPCB, CODFILIALCB, CODCARTCOB, DATACLI,
            PESSOACLI, ATIVOCLI,

            CASE PESSOACLI
                WHEN 'J' THEN :IDOCUMENTO
            ELSE NULL
            END,

            INSCCLI,

            CASE PESSOACLI
                WHEN 'F' THEN :IDOCUMENTO
            ELSE NULL
            END,

            RGCLI, SSPCLI, ENDCLI, NUMCLI, COMPLCLI, BAIRCLI, CIDCLI,
            UFCLI, CEPCLI, DDDCLI, FONECLI, RAMALCLI, DDDFAXCLI, FAXCLI, EMAILCLI, EMAILCOB, EMAILENT, EMAILNFECLI,
            CONTCLI, ENDCOB, NUMCOB, COMPLCOB, BAIRCOB, CIDCOB, UFCOB, CEPCOB, DDDFONECOB, FONECOB, DDDFAXCOB, FAXCOB,
            ENDENT, NUMENT, COMPLENT, BAIRENT, CIDENT, UFENT, CEPENT, DDDFONEENT, FONEENT, DDDFAXENT, FAXENT, OBSCLI,
            AGENCIACLI, CODEMPPQ, CODFILIALPQ, CODPESQ, INCRACLI, DTINITR, DTVENCTOTR, NIRFCLI, SIMPLESCLI, DDDCELCLI,
            CELCLI, NATCLI, UFNATCLI, TEMPORESCLI, APELIDOCLI, SITECLI, CODCONTDEB, CODCONTCRED, CODCLICONTAB, FOTOCLI,
            IMGASSCLI, CODMUNIC, SIGLAUF, CODPAIS, CODMUNICENT, SIGLAUFENT, CODPAISENT, CODMUNICCOB, SIGLAUFCOB, CODPAISCOB,
            CODEMPUC, CODFILIALUC, CODUNIFCOD, SUFRAMACLI, PRODRURALCLI, CTOCLI, CODCNAE, INSCMUNCLI, PERCDESCCLI, CONTCLICOB,
            CONTCLIENT, DESCIPI, DDDCELENT, CELENT
            FROM VDCLIENTE  VC WHERE VC.CODEMP=:ICODEMP AND VC.CODFILIAL=:ICODFILIAL AND VC.CODCLI = :ICODCLI ;

     ICOD = INOVOCOD;

  suspend;
end
^

SET TERM ; ^

ALTER TABLE CPITCOMPRA ALTER COLUMN CODEMP POSITION 1;

ALTER TABLE CPITCOMPRA ALTER COLUMN CODFILIAL POSITION 2;

ALTER TABLE CPITCOMPRA ALTER COLUMN CODCOMPRA POSITION 3;

ALTER TABLE CPITCOMPRA ALTER COLUMN CODITCOMPRA POSITION 4;

ALTER TABLE CPITCOMPRA ALTER COLUMN CODEMPPD POSITION 5;

ALTER TABLE CPITCOMPRA ALTER COLUMN CODFILIALPD POSITION 6;

ALTER TABLE CPITCOMPRA ALTER COLUMN CODPROD POSITION 7;

ALTER TABLE CPITCOMPRA ALTER COLUMN CODEMPLE POSITION 8;

ALTER TABLE CPITCOMPRA ALTER COLUMN CODFILIALLE POSITION 9;

ALTER TABLE CPITCOMPRA ALTER COLUMN CODLOTE POSITION 10;

ALTER TABLE CPITCOMPRA ALTER COLUMN CODEMPNT POSITION 11;

ALTER TABLE CPITCOMPRA ALTER COLUMN CODFILIALNT POSITION 12;

ALTER TABLE CPITCOMPRA ALTER COLUMN CODNAT POSITION 13;

ALTER TABLE CPITCOMPRA ALTER COLUMN CODEMPAX POSITION 14;

ALTER TABLE CPITCOMPRA ALTER COLUMN CODFILIALAX POSITION 15;

ALTER TABLE CPITCOMPRA ALTER COLUMN CODALMOX POSITION 16;

ALTER TABLE CPITCOMPRA ALTER COLUMN QTDITCOMPRA POSITION 17;

ALTER TABLE CPITCOMPRA ALTER COLUMN QTDITCOMPRACANC POSITION 18;

ALTER TABLE CPITCOMPRA ALTER COLUMN PRECOITCOMPRA POSITION 19;

ALTER TABLE CPITCOMPRA ALTER COLUMN PERCDESCITCOMPRA POSITION 20;

ALTER TABLE CPITCOMPRA ALTER COLUMN VLRDESCITCOMPRA POSITION 21;

ALTER TABLE CPITCOMPRA ALTER COLUMN PERCICMSITCOMPRA POSITION 22;

ALTER TABLE CPITCOMPRA ALTER COLUMN VLRBASEICMSITCOMPRA POSITION 23;

ALTER TABLE CPITCOMPRA ALTER COLUMN VLRICMSITCOMPRA POSITION 24;

ALTER TABLE CPITCOMPRA ALTER COLUMN PERCICMSSTITCOMPRA POSITION 25;

ALTER TABLE CPITCOMPRA ALTER COLUMN VLRBASEICMSSTITCOMPRA POSITION 26;

ALTER TABLE CPITCOMPRA ALTER COLUMN VLRICMSSTITCOMPRA POSITION 27;

ALTER TABLE CPITCOMPRA ALTER COLUMN PERCIPIITCOMPRA POSITION 28;

ALTER TABLE CPITCOMPRA ALTER COLUMN VLRBASEIPIITCOMPRA POSITION 29;

ALTER TABLE CPITCOMPRA ALTER COLUMN VLRIPIITCOMPRA POSITION 30;

ALTER TABLE CPITCOMPRA ALTER COLUMN VLRBASEFUNRURALITCOMPRA POSITION 31;

ALTER TABLE CPITCOMPRA ALTER COLUMN ALIQFUNRURALITCOMPRA POSITION 32;

ALTER TABLE CPITCOMPRA ALTER COLUMN VLRFUNRURALITCOMPRA POSITION 33;

ALTER TABLE CPITCOMPRA ALTER COLUMN VLRLIQITCOMPRA POSITION 34;

ALTER TABLE CPITCOMPRA ALTER COLUMN VLRADICITCOMPRA POSITION 35;

ALTER TABLE CPITCOMPRA ALTER COLUMN VLRFRETEITCOMPRA POSITION 36;

ALTER TABLE CPITCOMPRA ALTER COLUMN VLRISENTASITCOMPRA POSITION 37;

ALTER TABLE CPITCOMPRA ALTER COLUMN VLROUTRASITCOMPRA POSITION 38;

ALTER TABLE CPITCOMPRA ALTER COLUMN VLRPRODITCOMPRA POSITION 39;

ALTER TABLE CPITCOMPRA ALTER COLUMN CUSTOITCOMPRA POSITION 40;

ALTER TABLE CPITCOMPRA ALTER COLUMN CUSTOVDITCOMPRA POSITION 41;

ALTER TABLE CPITCOMPRA ALTER COLUMN REFPROD POSITION 42;

ALTER TABLE CPITCOMPRA ALTER COLUMN OBSITCOMPRA POSITION 43;

ALTER TABLE CPITCOMPRA ALTER COLUMN CODEMPIF POSITION 44;

ALTER TABLE CPITCOMPRA ALTER COLUMN CODFILIALIF POSITION 45;

ALTER TABLE CPITCOMPRA ALTER COLUMN CODFISC POSITION 46;

ALTER TABLE CPITCOMPRA ALTER COLUMN EMMANUT POSITION 47;

ALTER TABLE CPITCOMPRA ALTER COLUMN CODITFISC POSITION 48;

ALTER TABLE CPITCOMPRA ALTER COLUMN CODEMPNS POSITION 49;

ALTER TABLE CPITCOMPRA ALTER COLUMN CODFILIALNS POSITION 50;

ALTER TABLE CPITCOMPRA ALTER COLUMN NUMSERIETMP POSITION 51;

ALTER TABLE CPITCOMPRA ALTER COLUMN NADICAO POSITION 52;

ALTER TABLE CPITCOMPRA ALTER COLUMN SEQADIC POSITION 53;

ALTER TABLE CPITCOMPRA ALTER COLUMN DESCDI POSITION 54;

ALTER TABLE CPITCOMPRA ALTER COLUMN APROVPRECO POSITION 55;

ALTER TABLE CPITCOMPRA ALTER COLUMN EMITITCOMPRA POSITION 56;

ALTER TABLE CPITCOMPRA ALTER COLUMN ALIQISSITCOMPRA POSITION 57;

ALTER TABLE CPITCOMPRA ALTER COLUMN VLRISSITCOMPRA POSITION 58;

ALTER TABLE CPITCOMPRA ALTER COLUMN VLRIIITCOMPRA POSITION 59;

ALTER TABLE CPITCOMPRA ALTER COLUMN VLRITOUTRASDESPITCOMPRA POSITION 60;

ALTER TABLE CPITCOMPRA ALTER COLUMN CALCCUSTO POSITION 61;

ALTER TABLE CPITCOMPRA ALTER COLUMN ADICICMSTOTNOTA POSITION 62;

ALTER TABLE CPITCOMPRA ALTER COLUMN VLRTXSISCOMEXITCOMPRA POSITION 63;

ALTER TABLE CPITCOMPRA ALTER COLUMN TIPONFITCOMPRA POSITION 64;

ALTER TABLE CPITCOMPRA ALTER COLUMN DTINS POSITION 65;

ALTER TABLE CPITCOMPRA ALTER COLUMN HINS POSITION 66;

ALTER TABLE CPITCOMPRA ALTER COLUMN IDUSUINS POSITION 67;

ALTER TABLE CPITCOMPRA ALTER COLUMN DTALT POSITION 68;

ALTER TABLE CPITCOMPRA ALTER COLUMN HALT POSITION 69;

ALTER TABLE CPITCOMPRA ALTER COLUMN IDUSUALT POSITION 70;

ALTER TABLE EQPRODUTO ALTER COLUMN CODEMP POSITION 1;

ALTER TABLE EQPRODUTO ALTER COLUMN CODFILIAL POSITION 2;

ALTER TABLE EQPRODUTO ALTER COLUMN CODPROD POSITION 3;

ALTER TABLE EQPRODUTO ALTER COLUMN DESCPROD POSITION 4;

ALTER TABLE EQPRODUTO ALTER COLUMN REFPROD POSITION 5;

ALTER TABLE EQPRODUTO ALTER COLUMN CODEMPAX POSITION 6;

ALTER TABLE EQPRODUTO ALTER COLUMN CODFILIALAX POSITION 7;

ALTER TABLE EQPRODUTO ALTER COLUMN CODALMOX POSITION 8;

ALTER TABLE EQPRODUTO ALTER COLUMN CODEMPMA POSITION 9;

ALTER TABLE EQPRODUTO ALTER COLUMN CODFILIALMA POSITION 10;

ALTER TABLE EQPRODUTO ALTER COLUMN CODMOEDA POSITION 11;

ALTER TABLE EQPRODUTO ALTER COLUMN CODEMPUD POSITION 12;

ALTER TABLE EQPRODUTO ALTER COLUMN CODFILIALUD POSITION 13;

ALTER TABLE EQPRODUTO ALTER COLUMN CODUNID POSITION 14;

ALTER TABLE EQPRODUTO ALTER COLUMN CODEMPFC POSITION 15;

ALTER TABLE EQPRODUTO ALTER COLUMN CODFILIALFC POSITION 16;

ALTER TABLE EQPRODUTO ALTER COLUMN CODFISC POSITION 17;

ALTER TABLE EQPRODUTO ALTER COLUMN CODEMPMC POSITION 18;

ALTER TABLE EQPRODUTO ALTER COLUMN CODFILIALMC POSITION 19;

ALTER TABLE EQPRODUTO ALTER COLUMN CODMARCA POSITION 20;

ALTER TABLE EQPRODUTO ALTER COLUMN DESCAUXPROD POSITION 21;

ALTER TABLE EQPRODUTO ALTER COLUMN TIPOPROD POSITION 22;

ALTER TABLE EQPRODUTO ALTER COLUMN CVPROD POSITION 23;

ALTER TABLE EQPRODUTO ALTER COLUMN CODEMPGP POSITION 24;

ALTER TABLE EQPRODUTO ALTER COLUMN CODFILIALGP POSITION 25;

ALTER TABLE EQPRODUTO ALTER COLUMN CODGRUP POSITION 26;

ALTER TABLE EQPRODUTO ALTER COLUMN CODBARPROD POSITION 27;

ALTER TABLE EQPRODUTO ALTER COLUMN CLOTEPROD POSITION 28;

ALTER TABLE EQPRODUTO ALTER COLUMN SERIEPROD POSITION 29;

ALTER TABLE EQPRODUTO ALTER COLUMN CODFABPROD POSITION 30;

ALTER TABLE EQPRODUTO ALTER COLUMN COMISPROD POSITION 31;

ALTER TABLE EQPRODUTO ALTER COLUMN PESOLIQPROD POSITION 32;

ALTER TABLE EQPRODUTO ALTER COLUMN PESOBRUTPROD POSITION 33;

ALTER TABLE EQPRODUTO ALTER COLUMN QTDMINPROD POSITION 34;

ALTER TABLE EQPRODUTO ALTER COLUMN QTDMAXPROD POSITION 35;

ALTER TABLE EQPRODUTO ALTER COLUMN DTMPMPROD POSITION 36;

ALTER TABLE EQPRODUTO ALTER COLUMN CUSTOMPMPROD POSITION 37;

ALTER TABLE EQPRODUTO ALTER COLUMN CUSTOPEPSPROD POSITION 38;

ALTER TABLE EQPRODUTO ALTER COLUMN CUSTOINFOPROD POSITION 39;

ALTER TABLE EQPRODUTO ALTER COLUMN PRECOBASEPROD POSITION 40;

ALTER TABLE EQPRODUTO ALTER COLUMN PRECOCOMISPROD POSITION 41;

ALTER TABLE EQPRODUTO ALTER COLUMN SLDPROD POSITION 42;

ALTER TABLE EQPRODUTO ALTER COLUMN SLDRESPROD POSITION 43;

ALTER TABLE EQPRODUTO ALTER COLUMN SLDCONSIGPROD POSITION 44;

ALTER TABLE EQPRODUTO ALTER COLUMN SLDLIQPROD POSITION 45;

ALTER TABLE EQPRODUTO ALTER COLUMN ATIVOPROD POSITION 46;

ALTER TABLE EQPRODUTO ALTER COLUMN DTULTCPPROD POSITION 47;

ALTER TABLE EQPRODUTO ALTER COLUMN QTDULTCPPROD POSITION 48;

ALTER TABLE EQPRODUTO ALTER COLUMN DESCCOMPPROD POSITION 49;

ALTER TABLE EQPRODUTO ALTER COLUMN OBSPROD POSITION 50;

ALTER TABLE EQPRODUTO ALTER COLUMN VERIFPROD POSITION 51;

ALTER TABLE EQPRODUTO ALTER COLUMN LOCALPROD POSITION 52;

ALTER TABLE EQPRODUTO ALTER COLUMN RMAPROD POSITION 53;

ALTER TABLE EQPRODUTO ALTER COLUMN CODEMPPE POSITION 54;

ALTER TABLE EQPRODUTO ALTER COLUMN CODFILIALPE POSITION 55;

ALTER TABLE EQPRODUTO ALTER COLUMN CODPE POSITION 56;

ALTER TABLE EQPRODUTO ALTER COLUMN CODEMPCC POSITION 57;

ALTER TABLE EQPRODUTO ALTER COLUMN CODFILIALCC POSITION 58;

ALTER TABLE EQPRODUTO ALTER COLUMN ANOCC POSITION 59;

ALTER TABLE EQPRODUTO ALTER COLUMN CODCC POSITION 60;

ALTER TABLE EQPRODUTO ALTER COLUMN USARECEITAPROD POSITION 61;

ALTER TABLE EQPRODUTO ALTER COLUMN USATELAADICPDV POSITION 62;

ALTER TABLE EQPRODUTO ALTER COLUMN VLRDENSIDADE POSITION 63;

ALTER TABLE EQPRODUTO ALTER COLUMN VLRCONCENT POSITION 64;

ALTER TABLE EQPRODUTO ALTER COLUMN COMPRIMENTO POSITION 65;

ALTER TABLE EQPRODUTO ALTER COLUMN LARGURA POSITION 66;

ALTER TABLE EQPRODUTO ALTER COLUMN ESPESSURA POSITION 67;

ALTER TABLE EQPRODUTO ALTER COLUMN GUIATRAFPROD POSITION 68;

ALTER TABLE EQPRODUTO ALTER COLUMN QTDEMBALAGEM POSITION 69;

ALTER TABLE EQPRODUTO ALTER COLUMN CODEANPROD POSITION 70;

ALTER TABLE EQPRODUTO ALTER COLUMN CUBAGEM POSITION 71;

ALTER TABLE EQPRODUTO ALTER COLUMN CODEMPSC POSITION 72;

ALTER TABLE EQPRODUTO ALTER COLUMN CODFILIALSC POSITION 73;

ALTER TABLE EQPRODUTO ALTER COLUMN CODSECAO POSITION 74;

ALTER TABLE EQPRODUTO ALTER COLUMN CODEMPTC POSITION 75;

ALTER TABLE EQPRODUTO ALTER COLUMN CODFILIALTC POSITION 76;

ALTER TABLE EQPRODUTO ALTER COLUMN CODTPCHAMADO POSITION 77;

ALTER TABLE EQPRODUTO ALTER COLUMN QTDHORASSERV POSITION 78;

ALTER TABLE EQPRODUTO ALTER COLUMN NRODIASVALID POSITION 79;

ALTER TABLE EQPRODUTO ALTER COLUMN DESCCLI POSITION 80;

ALTER TABLE EQPRODUTO ALTER COLUMN QTDPORPLANO POSITION 81;

ALTER TABLE EQPRODUTO ALTER COLUMN NROPLANOS POSITION 82;

ALTER TABLE EQPRODUTO ALTER COLUMN CERTFSC POSITION 83;

ALTER TABLE EQPRODUTO ALTER COLUMN FATORFSC POSITION 84;

ALTER TABLE EQPRODUTO ALTER COLUMN CODEMPOG POSITION 85;

ALTER TABLE EQPRODUTO ALTER COLUMN CODFILIALOG POSITION 86;

ALTER TABLE EQPRODUTO ALTER COLUMN CODPRODOG POSITION 87;

ALTER TABLE EQPRODUTO ALTER COLUMN CODEMPMG POSITION 88;

ALTER TABLE EQPRODUTO ALTER COLUMN CODFILIALMG POSITION 89;

ALTER TABLE EQPRODUTO ALTER COLUMN CODMODG POSITION 90;

ALTER TABLE EQPRODUTO ALTER COLUMN PRAZOREPO POSITION 91;

ALTER TABLE EQPRODUTO ALTER COLUMN DTINS POSITION 92;

ALTER TABLE EQPRODUTO ALTER COLUMN HINS POSITION 93;

ALTER TABLE EQPRODUTO ALTER COLUMN IDUSUINS POSITION 94;

ALTER TABLE EQPRODUTO ALTER COLUMN DTALT POSITION 95;

ALTER TABLE EQPRODUTO ALTER COLUMN HALT POSITION 96;

ALTER TABLE EQPRODUTO ALTER COLUMN IDUSUALT POSITION 97;

ALTER TABLE FNITPAGAR ALTER COLUMN CODEMP POSITION 1;

ALTER TABLE FNITPAGAR ALTER COLUMN CODFILIAL POSITION 2;

ALTER TABLE FNITPAGAR ALTER COLUMN CODPAG POSITION 3;

ALTER TABLE FNITPAGAR ALTER COLUMN NPARCPAG POSITION 4;

ALTER TABLE FNITPAGAR ALTER COLUMN VLRITPAG POSITION 5;

ALTER TABLE FNITPAGAR ALTER COLUMN VLRDESCITPAG POSITION 6;

ALTER TABLE FNITPAGAR ALTER COLUMN VLRMULTAITPAG POSITION 7;

ALTER TABLE FNITPAGAR ALTER COLUMN VLRJUROSITPAG POSITION 8;

ALTER TABLE FNITPAGAR ALTER COLUMN VLRDEVITPAG POSITION 9;

ALTER TABLE FNITPAGAR ALTER COLUMN VLRPARCITPAG POSITION 10;

ALTER TABLE FNITPAGAR ALTER COLUMN VLRPAGOITPAG POSITION 11;

ALTER TABLE FNITPAGAR ALTER COLUMN VLRAPAGITPAG POSITION 12;

ALTER TABLE FNITPAGAR ALTER COLUMN VLRADICITPAG POSITION 13;

ALTER TABLE FNITPAGAR ALTER COLUMN VLRCANCITPAG POSITION 14;

ALTER TABLE FNITPAGAR ALTER COLUMN DTITPAG POSITION 15;

ALTER TABLE FNITPAGAR ALTER COLUMN DTCOMPITPAG POSITION 16;

ALTER TABLE FNITPAGAR ALTER COLUMN DTVENCITPAG POSITION 17;

ALTER TABLE FNITPAGAR ALTER COLUMN DTPAGOITPAG POSITION 18;

ALTER TABLE FNITPAGAR ALTER COLUMN STATUSITPAG POSITION 19;

ALTER TABLE FNITPAGAR ALTER COLUMN CODEMPCA POSITION 20;

ALTER TABLE FNITPAGAR ALTER COLUMN CODFILIALCA POSITION 21;

ALTER TABLE FNITPAGAR ALTER COLUMN NUMCONTA POSITION 22;

ALTER TABLE FNITPAGAR ALTER COLUMN CODEMPPN POSITION 23;

ALTER TABLE FNITPAGAR ALTER COLUMN CODFILIALPN POSITION 24;

ALTER TABLE FNITPAGAR ALTER COLUMN CODPLAN POSITION 25;

ALTER TABLE FNITPAGAR ALTER COLUMN DOCLANCAITPAG POSITION 26;

ALTER TABLE FNITPAGAR ALTER COLUMN OBSITPAG POSITION 27;

ALTER TABLE FNITPAGAR ALTER COLUMN FLAG POSITION 28;

ALTER TABLE FNITPAGAR ALTER COLUMN CODEMPCC POSITION 29;

ALTER TABLE FNITPAGAR ALTER COLUMN CODFILIALCC POSITION 30;

ALTER TABLE FNITPAGAR ALTER COLUMN ANOCC POSITION 31;

ALTER TABLE FNITPAGAR ALTER COLUMN CODCC POSITION 32;

ALTER TABLE FNITPAGAR ALTER COLUMN CODEMPTC POSITION 33;

ALTER TABLE FNITPAGAR ALTER COLUMN CODFILIALTC POSITION 34;

ALTER TABLE FNITPAGAR ALTER COLUMN CODTIPOCOB POSITION 35;

ALTER TABLE FNITPAGAR ALTER COLUMN CODEMPCT POSITION 36;

ALTER TABLE FNITPAGAR ALTER COLUMN CODFILIALCT POSITION 37;

ALTER TABLE FNITPAGAR ALTER COLUMN CODCONTR POSITION 38;

ALTER TABLE FNITPAGAR ALTER COLUMN CODITCONTR POSITION 39;

ALTER TABLE FNITPAGAR ALTER COLUMN EMMANUT POSITION 40;

ALTER TABLE FNITPAGAR ALTER COLUMN CODEMPSN POSITION 41;

ALTER TABLE FNITPAGAR ALTER COLUMN CODFILIALSN POSITION 42;

ALTER TABLE FNITPAGAR ALTER COLUMN CODSINAL POSITION 43;

ALTER TABLE FNITPAGAR ALTER COLUMN MULTIBAIXA POSITION 44;

ALTER TABLE FNITPAGAR ALTER COLUMN EDITITPAG POSITION 45;

ALTER TABLE FNITPAGAR ALTER COLUMN DTINS POSITION 46;

ALTER TABLE FNITPAGAR ALTER COLUMN IDUSUINS POSITION 47;

ALTER TABLE FNITPAGAR ALTER COLUMN DTALT POSITION 48;

ALTER TABLE FNITPAGAR ALTER COLUMN IDUSUALT POSITION 49;

ALTER TABLE FNITPAGAR ALTER COLUMN HINS POSITION 50;

ALTER TABLE FNITPAGAR ALTER COLUMN HALT POSITION 51;

ALTER TABLE FNITRECEBER ALTER COLUMN CODEMP POSITION 1;

ALTER TABLE FNITRECEBER ALTER COLUMN CODFILIAL POSITION 2;

ALTER TABLE FNITRECEBER ALTER COLUMN CODREC POSITION 3;

ALTER TABLE FNITRECEBER ALTER COLUMN NPARCITREC POSITION 4;

ALTER TABLE FNITRECEBER ALTER COLUMN VLRITREC POSITION 5;

ALTER TABLE FNITRECEBER ALTER COLUMN VLRDESCITREC POSITION 6;

ALTER TABLE FNITRECEBER ALTER COLUMN VLRMULTAITREC POSITION 7;

ALTER TABLE FNITRECEBER ALTER COLUMN VLRJUROSITREC POSITION 8;

ALTER TABLE FNITRECEBER ALTER COLUMN VLRDEVITREC POSITION 9;

ALTER TABLE FNITRECEBER ALTER COLUMN VLRPARCITREC POSITION 10;

ALTER TABLE FNITRECEBER ALTER COLUMN VLRPAGOITREC POSITION 11;

ALTER TABLE FNITRECEBER ALTER COLUMN VLRAPAGITREC POSITION 12;

ALTER TABLE FNITRECEBER ALTER COLUMN VLRCOMIITREC POSITION 13;

ALTER TABLE FNITRECEBER ALTER COLUMN VLRCANCITREC POSITION 14;

ALTER TABLE FNITRECEBER ALTER COLUMN VLRBASECOMIS POSITION 15;

ALTER TABLE FNITRECEBER ALTER COLUMN DESCPONT POSITION 16;

ALTER TABLE FNITRECEBER ALTER COLUMN DTITREC POSITION 17;

ALTER TABLE FNITRECEBER ALTER COLUMN DTCOMPITREC POSITION 18;

ALTER TABLE FNITRECEBER ALTER COLUMN DTVENCITREC POSITION 19;

ALTER TABLE FNITRECEBER ALTER COLUMN DTPREVITREC POSITION 20;

ALTER TABLE FNITRECEBER ALTER COLUMN DTPAGOITREC POSITION 21;

ALTER TABLE FNITRECEBER ALTER COLUMN DTLIQITREC POSITION 22;

ALTER TABLE FNITRECEBER ALTER COLUMN STATUSITREC POSITION 23;

ALTER TABLE FNITRECEBER ALTER COLUMN CODEMPPN POSITION 24;

ALTER TABLE FNITRECEBER ALTER COLUMN CODFILIALPN POSITION 25;

ALTER TABLE FNITRECEBER ALTER COLUMN CODPLAN POSITION 26;

ALTER TABLE FNITRECEBER ALTER COLUMN OBSITREC POSITION 27;

ALTER TABLE FNITRECEBER ALTER COLUMN CODEMPCA POSITION 28;

ALTER TABLE FNITRECEBER ALTER COLUMN CODFILIALCA POSITION 29;

ALTER TABLE FNITRECEBER ALTER COLUMN NUMCONTA POSITION 30;

ALTER TABLE FNITRECEBER ALTER COLUMN CODEMPBO POSITION 31;

ALTER TABLE FNITRECEBER ALTER COLUMN CODFILIALBO POSITION 32;

ALTER TABLE FNITRECEBER ALTER COLUMN CODBANCO POSITION 33;

ALTER TABLE FNITRECEBER ALTER COLUMN CODEMPTC POSITION 34;

ALTER TABLE FNITRECEBER ALTER COLUMN CODFILIALTC POSITION 35;

ALTER TABLE FNITRECEBER ALTER COLUMN CODTIPOCOB POSITION 36;

ALTER TABLE FNITRECEBER ALTER COLUMN CODEMPCB POSITION 37;

ALTER TABLE FNITRECEBER ALTER COLUMN CODFILIALCB POSITION 38;

ALTER TABLE FNITRECEBER ALTER COLUMN CODCARTCOB POSITION 39;

ALTER TABLE FNITRECEBER ALTER COLUMN DOCLANCAITREC POSITION 40;

ALTER TABLE FNITRECEBER ALTER COLUMN FLAG POSITION 41;

ALTER TABLE FNITRECEBER ALTER COLUMN CODEMPCC POSITION 42;

ALTER TABLE FNITRECEBER ALTER COLUMN CODFILIALCC POSITION 43;

ALTER TABLE FNITRECEBER ALTER COLUMN ANOCC POSITION 44;

ALTER TABLE FNITRECEBER ALTER COLUMN CODCC POSITION 45;

ALTER TABLE FNITRECEBER ALTER COLUMN IMPRECIBOITREC POSITION 46;

ALTER TABLE FNITRECEBER ALTER COLUMN RECIBOITREC POSITION 47;

ALTER TABLE FNITRECEBER ALTER COLUMN ALTUSUITREC POSITION 48;

ALTER TABLE FNITRECEBER ALTER COLUMN PDVITREC POSITION 49;

ALTER TABLE FNITRECEBER ALTER COLUMN RECEMCOB POSITION 50;

ALTER TABLE FNITRECEBER ALTER COLUMN DTINIEMCOB POSITION 51;

ALTER TABLE FNITRECEBER ALTER COLUMN DTFIMEMCOB POSITION 52;

ALTER TABLE FNITRECEBER ALTER COLUMN SEQNOSSONUMERO POSITION 53;

ALTER TABLE FNITRECEBER ALTER COLUMN NOSSONUMERO POSITION 54;

ALTER TABLE FNITRECEBER ALTER COLUMN EMMANUT POSITION 55;

ALTER TABLE FNITRECEBER ALTER COLUMN CODEMPSN POSITION 56;

ALTER TABLE FNITRECEBER ALTER COLUMN CODFILIALSN POSITION 57;

ALTER TABLE FNITRECEBER ALTER COLUMN CODSINAL POSITION 58;

ALTER TABLE FNITRECEBER ALTER COLUMN MULTIBAIXA POSITION 59;

ALTER TABLE FNITRECEBER ALTER COLUMN CODEMPCT POSITION 60;

ALTER TABLE FNITRECEBER ALTER COLUMN CODFILIALCT POSITION 61;

ALTER TABLE FNITRECEBER ALTER COLUMN CODCONTR POSITION 62;

ALTER TABLE FNITRECEBER ALTER COLUMN CODITCONTR POSITION 63;

ALTER TABLE FNITRECEBER ALTER COLUMN DTINS POSITION 64;

ALTER TABLE FNITRECEBER ALTER COLUMN HINS POSITION 65;

ALTER TABLE FNITRECEBER ALTER COLUMN IDUSUINS POSITION 66;

ALTER TABLE FNITRECEBER ALTER COLUMN DTALT POSITION 67;

ALTER TABLE FNITRECEBER ALTER COLUMN HALT POSITION 68;

ALTER TABLE FNITRECEBER ALTER COLUMN IDUSUALT POSITION 69;

ALTER TABLE LFSITTRIB ALTER COLUMN CODEMP POSITION 1;

ALTER TABLE LFSITTRIB ALTER COLUMN CODFILIAL POSITION 2;

ALTER TABLE LFSITTRIB ALTER COLUMN CODSITTRIB POSITION 3;

ALTER TABLE LFSITTRIB ALTER COLUMN IMPSITTRIB POSITION 4;

ALTER TABLE LFSITTRIB ALTER COLUMN DESCSITTRIB POSITION 5;

ALTER TABLE LFSITTRIB ALTER COLUMN OPERACAO POSITION 6;

ALTER TABLE LFSITTRIB ALTER COLUMN DTINS POSITION 7;

ALTER TABLE LFSITTRIB ALTER COLUMN HINS POSITION 8;

ALTER TABLE LFSITTRIB ALTER COLUMN IDUSUINS POSITION 9;

ALTER TABLE LFSITTRIB ALTER COLUMN DTALT POSITION 10;

ALTER TABLE LFSITTRIB ALTER COLUMN HALT POSITION 11;

ALTER TABLE LFSITTRIB ALTER COLUMN IDUSUALT POSITION 12;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMP POSITION 1;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIAL POSITION 2;

ALTER TABLE SGPREFERE1 ALTER COLUMN USAREFPROD POSITION 3;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODTIPOMOV POSITION 4;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPTM POSITION 5;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALTM POSITION 6;

ALTER TABLE SGPREFERE1 ALTER COLUMN USAPEDSEQ POSITION 7;

ALTER TABLE SGPREFERE1 ALTER COLUMN USAORCSEQ POSITION 8;

ALTER TABLE SGPREFERE1 ALTER COLUMN FILTRO POSITION 9;

ALTER TABLE SGPREFERE1 ALTER COLUMN USALIQREL POSITION 10;

ALTER TABLE SGPREFERE1 ALTER COLUMN TIPOPRECOCUSTO POSITION 11;

ALTER TABLE SGPREFERE1 ALTER COLUMN ANOCENTROCUSTO POSITION 12;

ALTER TABLE SGPREFERE1 ALTER COLUMN OBSORCPAD POSITION 13;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODTIPOMOV2 POSITION 14;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALT2 POSITION 15;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPT2 POSITION 16;

ALTER TABLE SGPREFERE1 ALTER COLUMN CLASSORC POSITION 17;

ALTER TABLE SGPREFERE1 ALTER COLUMN CLASSORCPD POSITION 18;

ALTER TABLE SGPREFERE1 ALTER COLUMN TITORCTXT01 POSITION 19;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODTIPOMOV3 POSITION 20;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALT3 POSITION 21;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPT3 POSITION 22;

ALTER TABLE SGPREFERE1 ALTER COLUMN ORDNOTA POSITION 23;

ALTER TABLE SGPREFERE1 ALTER COLUMN SETORVENDA POSITION 24;

ALTER TABLE SGPREFERE1 ALTER COLUMN PREFCRED POSITION 25;

ALTER TABLE SGPREFERE1 ALTER COLUMN TIPOPREFCRED POSITION 26;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPMO POSITION 27;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALMO POSITION 28;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODMOEDA POSITION 29;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODTIPOMOV4 POSITION 30;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALT4 POSITION 31;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPT4 POSITION 32;

ALTER TABLE SGPREFERE1 ALTER COLUMN USACLASCOMIS POSITION 33;

ALTER TABLE SGPREFERE1 ALTER COLUMN PERCPRECOCUSTO POSITION 34;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODGRUP POSITION 35;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALGP POSITION 36;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPGP POSITION 37;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODMARCA POSITION 38;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALMC POSITION 39;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPMC POSITION 40;

ALTER TABLE SGPREFERE1 ALTER COLUMN RGCLIOBRIG POSITION 41;

ALTER TABLE SGPREFERE1 ALTER COLUMN TABFRETEVD POSITION 42;

ALTER TABLE SGPREFERE1 ALTER COLUMN TABADICVD POSITION 43;

ALTER TABLE SGPREFERE1 ALTER COLUMN TRAVATMNFVD POSITION 44;

ALTER TABLE SGPREFERE1 ALTER COLUMN TIPOVALIDORC POSITION 45;

ALTER TABLE SGPREFERE1 ALTER COLUMN CLIMESMOCNPJ POSITION 46;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODTBJ POSITION 47;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPTJ POSITION 48;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALTJ POSITION 49;

ALTER TABLE SGPREFERE1 ALTER COLUMN CNPJOBRIGCLI POSITION 50;

ALTER TABLE SGPREFERE1 ALTER COLUMN JUROSPOSCALC POSITION 51;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPFR POSITION 52;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALFR POSITION 53;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFOR POSITION 54;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPTN POSITION 55;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALTN POSITION 56;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODTRAN POSITION 57;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPTF POSITION 58;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALTF POSITION 59;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODTIPOFOR POSITION 60;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPT5 POSITION 61;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALT5 POSITION 62;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODTIPOMOV5 POSITION 63;

ALTER TABLE SGPREFERE1 ALTER COLUMN ESTLOTNEG POSITION 64;

ALTER TABLE SGPREFERE1 ALTER COLUMN ESTNEG POSITION 65;

ALTER TABLE SGPREFERE1 ALTER COLUMN NATVENDA POSITION 66;

ALTER TABLE SGPREFERE1 ALTER COLUMN IPIVENDA POSITION 67;

ALTER TABLE SGPREFERE1 ALTER COLUMN CUSTOSICMS POSITION 68;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPPG POSITION 69;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALPG POSITION 70;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODPLANOPAG POSITION 71;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPTB POSITION 72;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALTB POSITION 73;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODTAB POSITION 74;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPCE POSITION 75;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALCE POSITION 76;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODCLASCLI POSITION 77;

ALTER TABLE SGPREFERE1 ALTER COLUMN CASASDEC POSITION 78;

ALTER TABLE SGPREFERE1 ALTER COLUMN CASASDECFIN POSITION 79;

ALTER TABLE SGPREFERE1 ALTER COLUMN COMISPDUPL POSITION 80;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPT6 POSITION 81;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALT6 POSITION 82;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODTIPOMOV6 POSITION 83;

ALTER TABLE SGPREFERE1 ALTER COLUMN BLOQVENDA POSITION 84;

ALTER TABLE SGPREFERE1 ALTER COLUMN BLOQCOMPRA POSITION 85;

ALTER TABLE SGPREFERE1 ALTER COLUMN VENDAMATPRIM POSITION 86;

ALTER TABLE SGPREFERE1 ALTER COLUMN VENDAPATRIM POSITION 87;

ALTER TABLE SGPREFERE1 ALTER COLUMN PEPSPROD POSITION 88;

ALTER TABLE SGPREFERE1 ALTER COLUMN CNPJFOROBRIG POSITION 89;

ALTER TABLE SGPREFERE1 ALTER COLUMN INSCESTFOROBRIG POSITION 90;

ALTER TABLE SGPREFERE1 ALTER COLUMN BUSCAPRODSIMILAR POSITION 91;

ALTER TABLE SGPREFERE1 ALTER COLUMN MULTIALMOX POSITION 92;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPT8 POSITION 93;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALT8 POSITION 94;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODTIPOMOV8 POSITION 95;

ALTER TABLE SGPREFERE1 ALTER COLUMN ESTNEGGRUP POSITION 96;

ALTER TABLE SGPREFERE1 ALTER COLUMN USATABPE POSITION 97;

ALTER TABLE SGPREFERE1 ALTER COLUMN TAMDESCPROD POSITION 98;

ALTER TABLE SGPREFERE1 ALTER COLUMN DESCCOMPPED POSITION 99;

ALTER TABLE SGPREFERE1 ALTER COLUMN OBSCLIVEND POSITION 100;

ALTER TABLE SGPREFERE1 ALTER COLUMN CONTESTOQ POSITION 101;

ALTER TABLE SGPREFERE1 ALTER COLUMN DIASPEDT POSITION 102;

ALTER TABLE SGPREFERE1 ALTER COLUMN RECALCPCVENDA POSITION 103;

ALTER TABLE SGPREFERE1 ALTER COLUMN RECALCPCORC POSITION 104;

ALTER TABLE SGPREFERE1 ALTER COLUMN USALAYOUTPED POSITION 105;

ALTER TABLE SGPREFERE1 ALTER COLUMN VERIFALTPARCVENDA POSITION 106;

ALTER TABLE SGPREFERE1 ALTER COLUMN BUSCACODPRODGEN POSITION 107;

ALTER TABLE SGPREFERE1 ALTER COLUMN FILBUSCGENPROD POSITION 108;

ALTER TABLE SGPREFERE1 ALTER COLUMN FILBUSCGENREF POSITION 109;

ALTER TABLE SGPREFERE1 ALTER COLUMN FILBUSCGENCODBAR POSITION 110;

ALTER TABLE SGPREFERE1 ALTER COLUMN FILBUSCGENCODFAB POSITION 111;

ALTER TABLE SGPREFERE1 ALTER COLUMN FILBUSCGENCODFOR POSITION 112;

ALTER TABLE SGPREFERE1 ALTER COLUMN BUSCAVLRULTCOMPRA POSITION 113;

ALTER TABLE SGPREFERE1 ALTER COLUMN ICMSVENDA POSITION 114;

ALTER TABLE SGPREFERE1 ALTER COLUMN USAPRECOZERO POSITION 115;

ALTER TABLE SGPREFERE1 ALTER COLUMN USAIMGASSORC POSITION 116;

ALTER TABLE SGPREFERE1 ALTER COLUMN IMGASSORC POSITION 117;

ALTER TABLE SGPREFERE1 ALTER COLUMN CONSISTCPFCLI POSITION 118;

ALTER TABLE SGPREFERE1 ALTER COLUMN CONSISTEIECLI POSITION 119;

ALTER TABLE SGPREFERE1 ALTER COLUMN CONSISTEIEFOR POSITION 120;

ALTER TABLE SGPREFERE1 ALTER COLUMN CONSISTECPFFOR POSITION 121;

ALTER TABLE SGPREFERE1 ALTER COLUMN USANOMEVENDORC POSITION 122;

ALTER TABLE SGPREFERE1 ALTER COLUMN SISCONTABIL POSITION 123;

ALTER TABLE SGPREFERE1 ALTER COLUMN ATBANCOIMPBOL POSITION 124;

ALTER TABLE SGPREFERE1 ALTER COLUMN TIPOCODBAR POSITION 125;

ALTER TABLE SGPREFERE1 ALTER COLUMN ADICORCOBSPED POSITION 126;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPMENSORC POSITION 127;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALMENSORC POSITION 128;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODMENSORC POSITION 129;

ALTER TABLE SGPREFERE1 ALTER COLUMN CUSTOCOMPRA POSITION 130;

ALTER TABLE SGPREFERE1 ALTER COLUMN TABTRANSPCP POSITION 131;

ALTER TABLE SGPREFERE1 ALTER COLUMN TABTRANSPORC POSITION 132;

ALTER TABLE SGPREFERE1 ALTER COLUMN TABSOLCP POSITION 133;

ALTER TABLE SGPREFERE1 ALTER COLUMN ADICFRETEBASEICM POSITION 134;

ALTER TABLE SGPREFERE1 ALTER COLUMN PRECOCPREL POSITION 135;

ALTER TABLE SGPREFERE1 ALTER COLUMN DESCORC POSITION 136;

ALTER TABLE SGPREFERE1 ALTER COLUMN MULTICOMIS POSITION 137;

ALTER TABLE SGPREFERE1 ALTER COLUMN USUATIVCLI POSITION 138;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPHISTREC POSITION 139;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALHISTREC POSITION 140;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODHISTREC POSITION 141;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPHISTPAG POSITION 142;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALHISTPAG POSITION 143;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODHISTPAG POSITION 144;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPTC POSITION 145;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALTC POSITION 146;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODTIPOCLI POSITION 147;

ALTER TABLE SGPREFERE1 ALTER COLUMN ESTITRECALTDTVENC POSITION 148;

ALTER TABLE SGPREFERE1 ALTER COLUMN LCREDGLOBAL POSITION 149;

ALTER TABLE SGPREFERE1 ALTER COLUMN VDMANUTCOMOBRIG POSITION 150;

ALTER TABLE SGPREFERE1 ALTER COLUMN CLASSPED POSITION 151;

ALTER TABLE SGPREFERE1 ALTER COLUMN CLASSPED02 POSITION 152;

ALTER TABLE SGPREFERE1 ALTER COLUMN TIPOCLASSPED POSITION 153;

ALTER TABLE SGPREFERE1 ALTER COLUMN USAIBGECLI POSITION 154;

ALTER TABLE SGPREFERE1 ALTER COLUMN USAIBGEFOR POSITION 155;

ALTER TABLE SGPREFERE1 ALTER COLUMN USAIBGETRANSP POSITION 156;

ALTER TABLE SGPREFERE1 ALTER COLUMN SOMAVOLUMES POSITION 157;

ALTER TABLE SGPREFERE1 ALTER COLUMN BUSCACEP POSITION 158;

ALTER TABLE SGPREFERE1 ALTER COLUMN URLWSCEP POSITION 159;

ALTER TABLE SGPREFERE1 ALTER COLUMN CLASSCP POSITION 160;

ALTER TABLE SGPREFERE1 ALTER COLUMN LABELOBS01CP POSITION 161;

ALTER TABLE SGPREFERE1 ALTER COLUMN LABELOBS02CP POSITION 162;

ALTER TABLE SGPREFERE1 ALTER COLUMN LABELOBS03CP POSITION 163;

ALTER TABLE SGPREFERE1 ALTER COLUMN LABELOBS04CP POSITION 164;

ALTER TABLE SGPREFERE1 ALTER COLUMN CONSISTEIEPF POSITION 165;

ALTER TABLE SGPREFERE1 ALTER COLUMN CREDICMSSIMPLES POSITION 166;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPMS POSITION 167;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALMS POSITION 168;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODMENSICMSSIMPLES POSITION 169;

ALTER TABLE SGPREFERE1 ALTER COLUMN GERACOMISVENDAORC POSITION 170;

ALTER TABLE SGPREFERE1 ALTER COLUMN GERACODUNIF POSITION 171;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODTIPOMOV9 POSITION 172;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALT9 POSITION 173;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPT9 POSITION 174;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPJP POSITION 175;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALJP POSITION 176;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODPLANJP POSITION 177;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPJR POSITION 178;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALJR POSITION 179;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODPLANJR POSITION 180;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPDR POSITION 181;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALDR POSITION 182;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODPLANDR POSITION 183;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPDC POSITION 184;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALDC POSITION 185;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODPLANDC POSITION 186;

ALTER TABLE SGPREFERE1 ALTER COLUMN GERAPAGEMIS POSITION 187;

ALTER TABLE SGPREFERE1 ALTER COLUMN LANCAFINCONTR POSITION 188;

ALTER TABLE SGPREFERE1 ALTER COLUMN LANCARMACONTR POSITION 189;

ALTER TABLE SGPREFERE1 ALTER COLUMN CASASDECPRE POSITION 190;

ALTER TABLE SGPREFERE1 ALTER COLUMN VISUALIZALUCR POSITION 191;

ALTER TABLE SGPREFERE1 ALTER COLUMN CLASSNFE POSITION 192;

ALTER TABLE SGPREFERE1 ALTER COLUMN DIRNFE POSITION 193;

ALTER TABLE SGPREFERE1 ALTER COLUMN DIRNFELIN POSITION 194;

ALTER TABLE SGPREFERE1 ALTER COLUMN FORMATODANFE POSITION 195;

ALTER TABLE SGPREFERE1 ALTER COLUMN AMBIENTENFE POSITION 196;

ALTER TABLE SGPREFERE1 ALTER COLUMN PROCEMINFE POSITION 197;

ALTER TABLE SGPREFERE1 ALTER COLUMN VERPROCNFE POSITION 198;

ALTER TABLE SGPREFERE1 ALTER COLUMN KEYLICNFE POSITION 199;

ALTER TABLE SGPREFERE1 ALTER COLUMN DTVENCTONFE POSITION 200;

ALTER TABLE SGPREFERE1 ALTER COLUMN INFADPRODNFE POSITION 201;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPNF POSITION 202;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALNF POSITION 203;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMAILNF POSITION 204;

ALTER TABLE SGPREFERE1 ALTER COLUMN EXIBEPARCOBSDANFE POSITION 205;

ALTER TABLE SGPREFERE1 ALTER COLUMN VERSAONFE POSITION 206;

ALTER TABLE SGPREFERE1 ALTER COLUMN REGIMETRIBNFE POSITION 207;

ALTER TABLE SGPREFERE1 ALTER COLUMN INFCPDEVOLUCAO POSITION 208;

ALTER TABLE SGPREFERE1 ALTER COLUMN INFVDREMESSA POSITION 209;

ALTER TABLE SGPREFERE1 ALTER COLUMN GERARECEMIS POSITION 210;

ALTER TABLE SGPREFERE1 ALTER COLUMN RETENSAOIMP POSITION 211;

ALTER TABLE SGPREFERE1 ALTER COLUMN TIPOCUSTOLUC POSITION 212;

ALTER TABLE SGPREFERE1 ALTER COLUMN TABIMPORTCP POSITION 213;

ALTER TABLE SGPREFERE1 ALTER COLUMN HABVLRTOTITORC POSITION 214;

ALTER TABLE SGPREFERE1 ALTER COLUMN USABUSCAGENPRODCP POSITION 215;

ALTER TABLE SGPREFERE1 ALTER COLUMN ADICOBSORCPED POSITION 216;

ALTER TABLE SGPREFERE1 ALTER COLUMN USAPRECOCOT POSITION 217;

ALTER TABLE SGPREFERE1 ALTER COLUMN BLOQPRECOAPROV POSITION 218;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPFT POSITION 219;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALFT POSITION 220;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODTIPOFORFT POSITION 221;

ALTER TABLE SGPREFERE1 ALTER COLUMN USAPRECOCOMIS POSITION 222;

ALTER TABLE SGPREFERE1 ALTER COLUMN ESPECIALCOMIS POSITION 223;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALTS POSITION 224;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODTIPOMOVS POSITION 225;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPTS POSITION 226;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPSV POSITION 227;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALSV POSITION 228;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODPLANOPAGSV POSITION 229;

ALTER TABLE SGPREFERE1 ALTER COLUMN ARREDPRECO POSITION 230;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPPC POSITION 231;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALPC POSITION 232;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODPLANPC POSITION 233;

ALTER TABLE SGPREFERE1 ALTER COLUMN TPNOSSONUMERO POSITION 234;

ALTER TABLE SGPREFERE1 ALTER COLUMN IMPDOCBOL POSITION 235;

ALTER TABLE SGPREFERE1 ALTER COLUMN FECHACAIXA POSITION 236;

ALTER TABLE SGPREFERE1 ALTER COLUMN FECHACAIXAAUTO POSITION 237;

ALTER TABLE SGPREFERE1 ALTER COLUMN NUMDIGIDENTTIT POSITION 238;

ALTER TABLE SGPREFERE1 ALTER COLUMN KEYLICEFD POSITION 239;

ALTER TABLE SGPREFERE1 ALTER COLUMN DTVENCTOEFD POSITION 240;

ALTER TABLE SGPREFERE1 ALTER COLUMN REVALIDARLOTECOMPRA POSITION 241;

ALTER TABLE SGPREFERE1 ALTER COLUMN ENCORCPROD POSITION 242;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPIM POSITION 243;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALIM POSITION 244;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODTIPOMOVIM POSITION 245;

ALTER TABLE SGPREFERE1 ALTER COLUMN COMISSAODESCONTO POSITION 246;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPHC POSITION 247;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALHC POSITION 248;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODHISTCNAB POSITION 249;

ALTER TABLE SGPREFERE1 ALTER COLUMN ALINHATELALANCA POSITION 250;

ALTER TABLE SGPREFERE1 ALTER COLUMN VENDACONSUM POSITION 251;

ALTER TABLE SGPREFERE1 ALTER COLUMN CVPROD POSITION 252;

ALTER TABLE SGPREFERE1 ALTER COLUMN VERIFPROD POSITION 253;

ALTER TABLE SGPREFERE1 ALTER COLUMN RMAPROD POSITION 254;

ALTER TABLE SGPREFERE1 ALTER COLUMN TIPOPROD POSITION 255;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPIG POSITION 256;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALIG POSITION 257;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODIMG POSITION 258;

ALTER TABLE SGPREFERE1 ALTER COLUMN OBSITVENDAPED POSITION 259;

ALTER TABLE SGPREFERE1 ALTER COLUMN FATORCPARC POSITION 260;

ALTER TABLE SGPREFERE1 ALTER COLUMN APROVORCFATPARC POSITION 261;

ALTER TABLE SGPREFERE1 ALTER COLUMN BLOQSEQICP POSITION 262;

ALTER TABLE SGPREFERE1 ALTER COLUMN BLOQSEQIVD POSITION 263;

ALTER TABLE SGPREFERE1 ALTER COLUMN UTILORDCPINT POSITION 264;

ALTER TABLE SGPREFERE1 ALTER COLUMN KEYLICEPC POSITION 265;

ALTER TABLE SGPREFERE1 ALTER COLUMN DTVENCTOEPC POSITION 266;

ALTER TABLE SGPREFERE1 ALTER COLUMN IMPLOTENFE POSITION 267;

ALTER TABLE SGPREFERE1 ALTER COLUMN TOTCPSFRETE POSITION 268;

ALTER TABLE SGPREFERE1 ALTER COLUMN IDENTCLIBCO POSITION 269;

ALTER TABLE SGPREFERE1 ALTER COLUMN QTDDESC POSITION 270;

ALTER TABLE SGPREFERE1 ALTER COLUMN LOCALSERV POSITION 271;

ALTER TABLE SGPREFERE1 ALTER COLUMN VDPRODQQCLAS POSITION 272;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPVD POSITION 273;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALVD POSITION 274;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODVEND POSITION 275;

ALTER TABLE SGPREFERE1 ALTER COLUMN PADRAONFE POSITION 276;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPME POSITION 277;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALME POSITION 278;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODMENSVENDA POSITION 279;

ALTER TABLE SGPREFERE1 ALTER COLUMN TIPOEMISSAONFE POSITION 280;

ALTER TABLE SGPREFERE1 ALTER COLUMN CCNFECP POSITION 281;

ALTER TABLE SGPREFERE1 ALTER COLUMN ADICICMSTOTNOTA POSITION 282;

ALTER TABLE SGPREFERE1 ALTER COLUMN UTILIZATBCALCCA POSITION 283;

ALTER TABLE SGPREFERE1 ALTER COLUMN HABCOMPRACOMPL POSITION 284;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODEMPIC POSITION 285;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODFILIALIC POSITION 286;

ALTER TABLE SGPREFERE1 ALTER COLUMN CODTIPOMOVIC POSITION 287;

ALTER TABLE SGPREFERE1 ALTER COLUMN DESCNATCOMPL POSITION 288;

ALTER TABLE SGPREFERE1 ALTER COLUMN HABLOGPAGAR POSITION 289;

ALTER TABLE SGPREFERE1 ALTER COLUMN HABLOGRECEBER POSITION 290;

ALTER TABLE SGPREFERE1 ALTER COLUMN CONSISTENDENTVD POSITION 291;

ALTER TABLE SGPREFERE1 ALTER COLUMN USACLISEQ POSITION 292;

ALTER TABLE SGPREFERE1 ALTER COLUMN BLOQDESCCOMPORC POSITION 293;

ALTER TABLE SGPREFERE1 ALTER COLUMN BLOQPRECOORC POSITION 294;

ALTER TABLE SGPREFERE1 ALTER COLUMN BLOQDESCCOMPVD POSITION 295;

ALTER TABLE SGPREFERE1 ALTER COLUMN BLOQPRECOVD POSITION 296;

ALTER TABLE SGPREFERE1 ALTER COLUMN DESABDESCFECHAVD POSITION 297;

ALTER TABLE SGPREFERE1 ALTER COLUMN DESABDESCFECHAORC POSITION 298;

ALTER TABLE SGPREFERE1 ALTER COLUMN PERMITBAIXAPARCJDM POSITION 299;

ALTER TABLE SGPREFERE1 ALTER COLUMN BLOQCOMISSORC POSITION 300;

ALTER TABLE SGPREFERE1 ALTER COLUMN BLOQCOMISSVD POSITION 301;

ALTER TABLE SGPREFERE1 ALTER COLUMN CALCPRECOG POSITION 302;

ALTER TABLE SGPREFERE1 ALTER COLUMN ENDERECOOBRIGCLI POSITION 303;

ALTER TABLE SGPREFERE1 ALTER COLUMN ENTREGAOBRIGCLI POSITION 304;

ALTER TABLE SGPREFERE1 ALTER COLUMN PERIODOCONSCH POSITION 305;

ALTER TABLE SGPREFERE1 ALTER COLUMN BLOQPEDVD POSITION 306;

ALTER TABLE SGPREFERE1 ALTER COLUMN AGENDAFPRINCIPAL POSITION 307;

ALTER TABLE SGPREFERE1 ALTER COLUMN ATUALIZAAGENDA POSITION 308;

ALTER TABLE SGPREFERE1 ALTER COLUMN TEMPOATUAGENDA POSITION 309;

ALTER TABLE SGPREFERE1 ALTER COLUMN SOLDTSAIDA POSITION 310;

ALTER TABLE SGPREFERE1 ALTER COLUMN NPERMITDTMAIOR POSITION 311;

ALTER TABLE SGPREFERE1 ALTER COLUMN PERMITIMPORCANTAP POSITION 312;

ALTER TABLE SGPREFERE1 ALTER COLUMN BLOQEDITORCAPOSAP POSITION 313;

ALTER TABLE SGPREFERE1 ALTER COLUMN BLOQVDPORATRASO POSITION 314;

ALTER TABLE SGPREFERE1 ALTER COLUMN NUMDIASBLOQVD POSITION 315;

ALTER TABLE SGPREFERE1 ALTER COLUMN DTINS POSITION 316;

ALTER TABLE SGPREFERE1 ALTER COLUMN HINS POSITION 317;

ALTER TABLE SGPREFERE1 ALTER COLUMN IDUSUINS POSITION 318;

ALTER TABLE SGPREFERE1 ALTER COLUMN DTALT POSITION 319;

ALTER TABLE SGPREFERE1 ALTER COLUMN HALT POSITION 320;

ALTER TABLE SGPREFERE1 ALTER COLUMN IDUSUALT POSITION 321;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMP POSITION 1;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIAL POSITION 2;

ALTER TABLE SGPREFERE3 ALTER COLUMN SMTPMAIL POSITION 3;

ALTER TABLE SGPREFERE3 ALTER COLUMN SMTPSSLMAIL POSITION 4;

ALTER TABLE SGPREFERE3 ALTER COLUMN SMTPAUTMAIL POSITION 5;

ALTER TABLE SGPREFERE3 ALTER COLUMN PORTAMAIL POSITION 6;

ALTER TABLE SGPREFERE3 ALTER COLUMN USERMAIL POSITION 7;

ALTER TABLE SGPREFERE3 ALTER COLUMN PASSMAIL POSITION 8;

ALTER TABLE SGPREFERE3 ALTER COLUMN ENDMAIL POSITION 9;

ALTER TABLE SGPREFERE3 ALTER COLUMN AUTOHORATEND POSITION 10;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPCE POSITION 11;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALCE POSITION 12;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODATIVCE POSITION 13;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPTE POSITION 14;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALTE POSITION 15;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODATIVTE POSITION 16;

ALTER TABLE SGPREFERE3 ALTER COLUMN BLOQATENDCLIATRASO POSITION 17;

ALTER TABLE SGPREFERE3 ALTER COLUMN MOSTRACLIATRASO POSITION 18;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPNC POSITION 19;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALNC POSITION 20;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMAILNC POSITION 21;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPAO POSITION 22;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALAO POSITION 23;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODATENDO POSITION 24;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPMI POSITION 25;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALMI POSITION 26;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODMODELMI POSITION 27;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPME POSITION 28;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALME POSITION 29;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODMODELME POSITION 30;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPFI POSITION 31;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALFI POSITION 32;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODMODELFI POSITION 33;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPFJ POSITION 34;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALFJ POSITION 35;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODMODELFJ POSITION 36;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPAP POSITION 37;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALAP POSITION 38;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODMODELAP POSITION 39;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPOR POSITION 40;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALOR POSITION 41;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODMODELOR POSITION 42;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPEC POSITION 43;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALEC POSITION 44;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMAILEC POSITION 45;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPEA POSITION 46;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALEA POSITION 47;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMAILEA POSITION 48;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPT1 POSITION 49;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALT1 POSITION 50;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODTIPOCONT1 POSITION 51;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPT2 POSITION 52;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALT2 POSITION 53;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODTIPOCONT2 POSITION 54;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPCF POSITION 55;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALCF POSITION 56;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODCONFEMAIL POSITION 57;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPC2 POSITION 58;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALC2 POSITION 59;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODCONFEMAIL2 POSITION 60;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPEN POSITION 61;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALEN POSITION 62;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMAILEN POSITION 63;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPE2 POSITION 64;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALE2 POSITION 65;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMAILEN2 POSITION 66;

ALTER TABLE SGPREFERE3 ALTER COLUMN EMAILNOTIF1 POSITION 67;

ALTER TABLE SGPREFERE3 ALTER COLUMN EMAILNOTIF2 POSITION 68;

ALTER TABLE SGPREFERE3 ALTER COLUMN TEMPOMAXINT POSITION 69;

ALTER TABLE SGPREFERE3 ALTER COLUMN LANCAPONTOAF POSITION 70;

ALTER TABLE SGPREFERE3 ALTER COLUMN TOLREGPONTO POSITION 71;

ALTER TABLE SGPREFERE3 ALTER COLUMN USACTOSEQ POSITION 72;

ALTER TABLE SGPREFERE3 ALTER COLUMN LAYOUTFICHAAVAL POSITION 73;

ALTER TABLE SGPREFERE3 ALTER COLUMN LAYOUTPREFICHAAVAL POSITION 74;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPV1 POSITION 75;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALV1 POSITION 76;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODVARG1 POSITION 77;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPV2 POSITION 78;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALV2 POSITION 79;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODVARG2 POSITION 80;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPV3 POSITION 81;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALV3 POSITION 82;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODVARG3 POSITION 83;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPV4 POSITION 84;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALV4 POSITION 85;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODVARG4 POSITION 86;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPV5 POSITION 87;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALV5 POSITION 88;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODVARG5 POSITION 89;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPV6 POSITION 90;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALV6 POSITION 91;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODVARG6 POSITION 92;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPV7 POSITION 93;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALV7 POSITION 94;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODVARG7 POSITION 95;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPV8 POSITION 96;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALV8 POSITION 97;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODVARG8 POSITION 98;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODEMPSR POSITION 99;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODFILIALSR POSITION 100;

ALTER TABLE SGPREFERE3 ALTER COLUMN CODSETOR POSITION 101;

ALTER TABLE SGPREFERE3 ALTER COLUMN BLOQATENDIMENTO POSITION 102;

ALTER TABLE SGPREFERE3 ALTER COLUMN PERIODOBLOQ POSITION 103;

ALTER TABLE SGPREFERE3 ALTER COLUMN DTINS POSITION 104;

ALTER TABLE SGPREFERE3 ALTER COLUMN HINS POSITION 105;

ALTER TABLE SGPREFERE3 ALTER COLUMN IDUSUINS POSITION 106;

ALTER TABLE SGPREFERE3 ALTER COLUMN DTALT POSITION 107;

ALTER TABLE SGPREFERE3 ALTER COLUMN HALT POSITION 108;

ALTER TABLE SGPREFERE3 ALTER COLUMN IDUSUALT POSITION 109;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODEMP POSITION 1;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODFILIAL POSITION 2;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODEMPTR POSITION 3;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODFILIALTR POSITION 4;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODTIPORECMERC POSITION 5;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODEMPCM POSITION 6;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODFILIALCM POSITION 7;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODTIPORECMERCCM POSITION 8;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODEMPTC POSITION 9;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODFILIALTC POSITION 10;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODTIPOMOVTC POSITION 11;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODEMPTO POSITION 12;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODFILIALTO POSITION 13;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODTIPORECMERCOS POSITION 14;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODEMPPP POSITION 15;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODFILIALPP POSITION 16;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODPLANOPAG POSITION 17;

ALTER TABLE SGPREFERE8 ALTER COLUMN GERACHAMADOOS POSITION 18;

ALTER TABLE SGPREFERE8 ALTER COLUMN USAPRECOPECASERV POSITION 19;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODEMPDS POSITION 20;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODFILIALDS POSITION 21;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODTIPOMOVDS POSITION 22;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODEMPSE POSITION 23;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODFILIALSE POSITION 24;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODPRODSE POSITION 25;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODEMPTE POSITION 26;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODFILIALTE POSITION 27;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODTIPOEXPED POSITION 28;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODEMPTN POSITION 29;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODFILIALTN POSITION 30;

ALTER TABLE SGPREFERE8 ALTER COLUMN CODTRAN POSITION 31;

ALTER TABLE SGPREFERE8 ALTER COLUMN SINCTICKET POSITION 32;

ALTER TABLE SGPREFERE8 ALTER COLUMN SOLCPHOMOLOGFOR POSITION 33;

ALTER TABLE SGPREFERE8 ALTER COLUMN UTILRENDACOT POSITION 34;

ALTER TABLE SGPREFERE8 ALTER COLUMN PERMITDOCCOLDUPL POSITION 35;

ALTER TABLE SGPREFERE8 ALTER COLUMN OBSPADOC POSITION 36;

ALTER TABLE SGPREFERE8 ALTER COLUMN DTINS POSITION 37;

ALTER TABLE SGPREFERE8 ALTER COLUMN HINS POSITION 38;

ALTER TABLE SGPREFERE8 ALTER COLUMN IDUSUINS POSITION 39;

ALTER TABLE SGPREFERE8 ALTER COLUMN DTALT POSITION 40;

ALTER TABLE SGPREFERE8 ALTER COLUMN HALT POSITION 41;

ALTER TABLE SGPREFERE8 ALTER COLUMN IDUSUALT POSITION 42;

ALTER TABLE SGPREFERE8 ALTER COLUMN PERCPRECOCOLETACP POSITION 43;

ALTER TABLE SGPREFERE8 ALTER COLUMN DETITEMPAINELSERV POSITION 44;

ALTER TABLE VDCLIENTE ALTER COLUMN CODEMP POSITION 1;

ALTER TABLE VDCLIENTE ALTER COLUMN CODFILIAL POSITION 2;

ALTER TABLE VDCLIENTE ALTER COLUMN CODCLI POSITION 3;

ALTER TABLE VDCLIENTE ALTER COLUMN RAZCLI POSITION 4;

ALTER TABLE VDCLIENTE ALTER COLUMN NOMECLI POSITION 5;

ALTER TABLE VDCLIENTE ALTER COLUMN CODEMPCC POSITION 6;

ALTER TABLE VDCLIENTE ALTER COLUMN CODFILIALCC POSITION 7;

ALTER TABLE VDCLIENTE ALTER COLUMN CODCLASCLI POSITION 8;

ALTER TABLE VDCLIENTE ALTER COLUMN CODEMPVD POSITION 9;

ALTER TABLE VDCLIENTE ALTER COLUMN CODFILIALVD POSITION 10;

ALTER TABLE VDCLIENTE ALTER COLUMN CODVEND POSITION 11;

ALTER TABLE VDCLIENTE ALTER COLUMN CODEMPTC POSITION 12;

ALTER TABLE VDCLIENTE ALTER COLUMN CODFILIALTC POSITION 13;

ALTER TABLE VDCLIENTE ALTER COLUMN CODTIPOCOB POSITION 14;

ALTER TABLE VDCLIENTE ALTER COLUMN CODEMPPG POSITION 15;

ALTER TABLE VDCLIENTE ALTER COLUMN CODFILIALPG POSITION 16;

ALTER TABLE VDCLIENTE ALTER COLUMN CODPLANOPAG POSITION 17;

ALTER TABLE VDCLIENTE ALTER COLUMN CODEMPTN POSITION 18;

ALTER TABLE VDCLIENTE ALTER COLUMN CODFILIALTN POSITION 19;

ALTER TABLE VDCLIENTE ALTER COLUMN CODTRAN POSITION 20;

ALTER TABLE VDCLIENTE ALTER COLUMN CODEMPBO POSITION 21;

ALTER TABLE VDCLIENTE ALTER COLUMN CODFILIALBO POSITION 22;

ALTER TABLE VDCLIENTE ALTER COLUMN CODBANCO POSITION 23;

ALTER TABLE VDCLIENTE ALTER COLUMN CODEMPSR POSITION 24;

ALTER TABLE VDCLIENTE ALTER COLUMN CODFILIALSR POSITION 25;

ALTER TABLE VDCLIENTE ALTER COLUMN CODSETOR POSITION 26;

ALTER TABLE VDCLIENTE ALTER COLUMN CODEMPTI POSITION 27;

ALTER TABLE VDCLIENTE ALTER COLUMN CODFILIALTI POSITION 28;

ALTER TABLE VDCLIENTE ALTER COLUMN CODTIPOCLI POSITION 29;

ALTER TABLE VDCLIENTE ALTER COLUMN CODTPCRED POSITION 30;

ALTER TABLE VDCLIENTE ALTER COLUMN CODFILIALTR POSITION 31;

ALTER TABLE VDCLIENTE ALTER COLUMN CODEMPTR POSITION 32;

ALTER TABLE VDCLIENTE ALTER COLUMN CODFISCCLI POSITION 33;

ALTER TABLE VDCLIENTE ALTER COLUMN CODEMPFC POSITION 34;

ALTER TABLE VDCLIENTE ALTER COLUMN CODFILIALFC POSITION 35;

ALTER TABLE VDCLIENTE ALTER COLUMN CODEMPEC POSITION 36;

ALTER TABLE VDCLIENTE ALTER COLUMN CODFILIALEC POSITION 37;

ALTER TABLE VDCLIENTE ALTER COLUMN CODTBEC POSITION 38;

ALTER TABLE VDCLIENTE ALTER COLUMN CODITTBEC POSITION 39;

ALTER TABLE VDCLIENTE ALTER COLUMN CODEMPHP POSITION 40;

ALTER TABLE VDCLIENTE ALTER COLUMN CODFILIALHP POSITION 41;

ALTER TABLE VDCLIENTE ALTER COLUMN CODHIST POSITION 42;

ALTER TABLE VDCLIENTE ALTER COLUMN CODEMPCB POSITION 43;

ALTER TABLE VDCLIENTE ALTER COLUMN CODFILIALCB POSITION 44;

ALTER TABLE VDCLIENTE ALTER COLUMN CODCARTCOB POSITION 45;

ALTER TABLE VDCLIENTE ALTER COLUMN DATACLI POSITION 46;

ALTER TABLE VDCLIENTE ALTER COLUMN PESSOACLI POSITION 47;

ALTER TABLE VDCLIENTE ALTER COLUMN ATIVOCLI POSITION 48;

ALTER TABLE VDCLIENTE ALTER COLUMN CNPJCLI POSITION 49;

ALTER TABLE VDCLIENTE ALTER COLUMN INSCCLI POSITION 50;

ALTER TABLE VDCLIENTE ALTER COLUMN CPFCLI POSITION 51;

ALTER TABLE VDCLIENTE ALTER COLUMN RGCLI POSITION 52;

ALTER TABLE VDCLIENTE ALTER COLUMN SSPCLI POSITION 53;

ALTER TABLE VDCLIENTE ALTER COLUMN ENDCLI POSITION 54;

ALTER TABLE VDCLIENTE ALTER COLUMN NUMCLI POSITION 55;

ALTER TABLE VDCLIENTE ALTER COLUMN COMPLCLI POSITION 56;

ALTER TABLE VDCLIENTE ALTER COLUMN EDIFICIOCLI POSITION 57;

ALTER TABLE VDCLIENTE ALTER COLUMN BAIRCLI POSITION 58;

ALTER TABLE VDCLIENTE ALTER COLUMN CIDCLI POSITION 59;

ALTER TABLE VDCLIENTE ALTER COLUMN UFCLI POSITION 60;

ALTER TABLE VDCLIENTE ALTER COLUMN CEPCLI POSITION 61;

ALTER TABLE VDCLIENTE ALTER COLUMN DDDCLI POSITION 62;

ALTER TABLE VDCLIENTE ALTER COLUMN FONECLI POSITION 63;

ALTER TABLE VDCLIENTE ALTER COLUMN RAMALCLI POSITION 64;

ALTER TABLE VDCLIENTE ALTER COLUMN DDDFAXCLI POSITION 65;

ALTER TABLE VDCLIENTE ALTER COLUMN FAXCLI POSITION 66;

ALTER TABLE VDCLIENTE ALTER COLUMN EMAILCLI POSITION 67;

ALTER TABLE VDCLIENTE ALTER COLUMN EMAILCOB POSITION 68;

ALTER TABLE VDCLIENTE ALTER COLUMN EMAILENT POSITION 69;

ALTER TABLE VDCLIENTE ALTER COLUMN EMAILNFECLI POSITION 70;

ALTER TABLE VDCLIENTE ALTER COLUMN CONTCLI POSITION 71;

ALTER TABLE VDCLIENTE ALTER COLUMN ENDCOB POSITION 72;

ALTER TABLE VDCLIENTE ALTER COLUMN NUMCOB POSITION 73;

ALTER TABLE VDCLIENTE ALTER COLUMN COMPLCOB POSITION 74;

ALTER TABLE VDCLIENTE ALTER COLUMN BAIRCOB POSITION 75;

ALTER TABLE VDCLIENTE ALTER COLUMN CIDCOB POSITION 76;

ALTER TABLE VDCLIENTE ALTER COLUMN UFCOB POSITION 77;

ALTER TABLE VDCLIENTE ALTER COLUMN CEPCOB POSITION 78;

ALTER TABLE VDCLIENTE ALTER COLUMN DDDFONECOB POSITION 79;

ALTER TABLE VDCLIENTE ALTER COLUMN FONECOB POSITION 80;

ALTER TABLE VDCLIENTE ALTER COLUMN DDDFAXCOB POSITION 81;

ALTER TABLE VDCLIENTE ALTER COLUMN FAXCOB POSITION 82;

ALTER TABLE VDCLIENTE ALTER COLUMN ENDENT POSITION 83;

ALTER TABLE VDCLIENTE ALTER COLUMN NUMENT POSITION 84;

ALTER TABLE VDCLIENTE ALTER COLUMN COMPLENT POSITION 85;

ALTER TABLE VDCLIENTE ALTER COLUMN BAIRENT POSITION 86;

ALTER TABLE VDCLIENTE ALTER COLUMN CIDENT POSITION 87;

ALTER TABLE VDCLIENTE ALTER COLUMN UFENT POSITION 88;

ALTER TABLE VDCLIENTE ALTER COLUMN CEPENT POSITION 89;

ALTER TABLE VDCLIENTE ALTER COLUMN DDDFONEENT POSITION 90;

ALTER TABLE VDCLIENTE ALTER COLUMN FONEENT POSITION 91;

ALTER TABLE VDCLIENTE ALTER COLUMN DDDFAXENT POSITION 92;

ALTER TABLE VDCLIENTE ALTER COLUMN FAXENT POSITION 93;

ALTER TABLE VDCLIENTE ALTER COLUMN DDDCELENT POSITION 94;

ALTER TABLE VDCLIENTE ALTER COLUMN CELENT POSITION 95;

ALTER TABLE VDCLIENTE ALTER COLUMN OBSCLI POSITION 96;

ALTER TABLE VDCLIENTE ALTER COLUMN AGENCIACLI POSITION 97;

ALTER TABLE VDCLIENTE ALTER COLUMN NCONTABCOCLI POSITION 98;

ALTER TABLE VDCLIENTE ALTER COLUMN CODEMPPQ POSITION 99;

ALTER TABLE VDCLIENTE ALTER COLUMN CODFILIALPQ POSITION 100;

ALTER TABLE VDCLIENTE ALTER COLUMN CODPESQ POSITION 101;

ALTER TABLE VDCLIENTE ALTER COLUMN INCRACLI POSITION 102;

ALTER TABLE VDCLIENTE ALTER COLUMN DTINITR POSITION 103;

ALTER TABLE VDCLIENTE ALTER COLUMN DTVENCTOTR POSITION 104;

ALTER TABLE VDCLIENTE ALTER COLUMN NIRFCLI POSITION 105;

ALTER TABLE VDCLIENTE ALTER COLUMN SIMPLESCLI POSITION 106;

ALTER TABLE VDCLIENTE ALTER COLUMN DDDCELCLI POSITION 107;

ALTER TABLE VDCLIENTE ALTER COLUMN CELCLI POSITION 108;

ALTER TABLE VDCLIENTE ALTER COLUMN NATCLI POSITION 109;

ALTER TABLE VDCLIENTE ALTER COLUMN UFNATCLI POSITION 110;

ALTER TABLE VDCLIENTE ALTER COLUMN TEMPORESCLI POSITION 111;

ALTER TABLE VDCLIENTE ALTER COLUMN APELIDOCLI POSITION 112;

ALTER TABLE VDCLIENTE ALTER COLUMN SITECLI POSITION 113;

ALTER TABLE VDCLIENTE ALTER COLUMN CODCONTDEB POSITION 114;

ALTER TABLE VDCLIENTE ALTER COLUMN CODCONTCRED POSITION 115;

ALTER TABLE VDCLIENTE ALTER COLUMN CODCLICONTAB POSITION 116;

ALTER TABLE VDCLIENTE ALTER COLUMN FOTOCLI POSITION 117;

ALTER TABLE VDCLIENTE ALTER COLUMN IMGASSCLI POSITION 118;

ALTER TABLE VDCLIENTE ALTER COLUMN CODMUNIC POSITION 119;

ALTER TABLE VDCLIENTE ALTER COLUMN SIGLAUF POSITION 120;

ALTER TABLE VDCLIENTE ALTER COLUMN CODPAIS POSITION 121;

ALTER TABLE VDCLIENTE ALTER COLUMN CODMUNICENT POSITION 122;

ALTER TABLE VDCLIENTE ALTER COLUMN SIGLAUFENT POSITION 123;

ALTER TABLE VDCLIENTE ALTER COLUMN CODPAISENT POSITION 124;

ALTER TABLE VDCLIENTE ALTER COLUMN CODMUNICCOB POSITION 125;

ALTER TABLE VDCLIENTE ALTER COLUMN SIGLAUFCOB POSITION 126;

ALTER TABLE VDCLIENTE ALTER COLUMN CODPAISCOB POSITION 127;

ALTER TABLE VDCLIENTE ALTER COLUMN CODEMPUC POSITION 128;

ALTER TABLE VDCLIENTE ALTER COLUMN CODFILIALUC POSITION 129;

ALTER TABLE VDCLIENTE ALTER COLUMN CODUNIFCOD POSITION 130;

ALTER TABLE VDCLIENTE ALTER COLUMN SUFRAMACLI POSITION 131;

ALTER TABLE VDCLIENTE ALTER COLUMN PRODRURALCLI POSITION 132;

ALTER TABLE VDCLIENTE ALTER COLUMN CTOCLI POSITION 133;

ALTER TABLE VDCLIENTE ALTER COLUMN CODCNAE POSITION 134;

ALTER TABLE VDCLIENTE ALTER COLUMN INSCMUNCLI POSITION 135;

ALTER TABLE VDCLIENTE ALTER COLUMN PERCDESCCLI POSITION 136;

ALTER TABLE VDCLIENTE ALTER COLUMN CONTCLICOB POSITION 137;

ALTER TABLE VDCLIENTE ALTER COLUMN CONTCLIENT POSITION 138;

ALTER TABLE VDCLIENTE ALTER COLUMN DESCIPI POSITION 139;

ALTER TABLE VDCLIENTE ALTER COLUMN IDENTCLIBCO POSITION 140;

ALTER TABLE VDCLIENTE ALTER COLUMN DTNASCCLI POSITION 141;

ALTER TABLE VDCLIENTE ALTER COLUMN DTINS POSITION 142;

ALTER TABLE VDCLIENTE ALTER COLUMN HINS POSITION 143;

ALTER TABLE VDCLIENTE ALTER COLUMN IDUSUINS POSITION 144;

ALTER TABLE VDCLIENTE ALTER COLUMN DTALT POSITION 145;

ALTER TABLE VDCLIENTE ALTER COLUMN HALT POSITION 146;

ALTER TABLE VDCLIENTE ALTER COLUMN IDUSUALT POSITION 147;


COMMIT WORK;
