/* Generated by IB DB Comparer v.1.15.Beta.  23/10/2007 11:08:30 */
/* Server Version: WI-V6.3.4.4910 Firebird 1.5.  ODS Version: 10.1. */

SET NAMES NONE;

SET SQL DIALECT 3;

CONNECT '/opt/firebird/dados/vazio.fdb' USER 'SYSDBA' PASSWORD 'masterkey';

/* Create Procedure... */
SET TERM ^ ;
CREATE PROCEDURE "ARREDDOUBLE"("DEVALOR" DOUBLE PRECISION,
"ICASASDEC" INTEGER)
 RETURNS("DERETORNO" DOUBLE PRECISION)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "ATADICATENDIMENTOSP"("ICODCONV" INTEGER,
"ICODTIPOATENDO" INTEGER,
"ICODATEND" INTEGER,
"ICODSETOR" INTEGER,
"VOBSATENDO" VARCHAR(10000) CHARACTER SET NONE,
"ICODEMP" INTEGER,
"ICODFILIAL" INTEGER,
"IDOC" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "ATBUSCAPRECOSP"("ICODPROD" INTEGER,
"ICODCONV" INTEGER,
"ICODEMPCV" INTEGER,
"ICODFILIALCV" SMALLINT,
"ICODPLANOPAG" INTEGER,
"ICODEMPPG" INTEGER,
"ICODFILIALPG" SMALLINT,
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT)
 RETURNS("PRECO" NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "CPADICFORSP"("CODEMP" INTEGER,
"CODFILIAL" INTEGER,
"CODFILIALCL" INTEGER,
"CODCLI" INTEGER)
 RETURNS("CODFOR" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "CPBLOQCOMPRASP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODCOMPRA" INTEGER,
"CBLOQCOMPRA" CHAR(1) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "CPCOMPRASP01"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"NQTD" NUMERIC(15,5),
"NVLRTOT" NUMERIC(15,5),
"NVLRICMS" NUMERIC(15,5))
 RETURNS("NVLRCUSTO" NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "CPGERAENTRADASP"("CODEMP" INTEGER,
"CODFILIAL" INTEGER,
"CODFILIALVD" INTEGER,
"TIPOVENDA" CHAR(1) CHARACTER SET NONE,
"CODVENDA" INTEGER,
"CITEM" CHAR(1) CHARACTER SET NONE)
 RETURNS("CODCOMPRA" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "CPGERAITENTRADASP"("CODEMP" INTEGER,
"CODFILIAL" INTEGER,
"CODCOMPRA" INTEGER,
"CODFILIALVD" INTEGER,
"TIPOVENDA" CHAR(1) CHARACTER SET NONE,
"CODVENDA" INTEGER,
"CODITVENDA" INTEGER,
"QTDIT" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQADICPRODUTOSP"("ICODPROD" INTEGER,
"SDESCPROD" CHAR(50) CHARACTER SET NONE,
"SDESCAUXPROD" CHAR(40) CHARACTER SET NONE,
"SREFPROD" CHAR(13) CHARACTER SET NONE,
"SCODFABPROD" CHAR(13) CHARACTER SET NONE,
"SCODBARPROD" CHAR(13) CHARACTER SET NONE,
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQBUSCASIMILARSP"("CODEMP" INTEGER,
"CODFILIAL" CHAR(8) CHARACTER SET NONE,
"IPROD" INTEGER,
"SREFPROD" CHAR(13) CHARACTER SET NONE)
 RETURNS("SRET" CHAR(13) CHARACTER SET NONE,
"IRET" INTEGER,
"CORIG" CHAR(1) CHARACTER SET NONE,
"ICODFOR" INTEGER,
"SRAZFOR" CHAR(50) CHARACTER SET NONE,
"NPRECO" NUMERIC(15,5),
"SSIM" CHAR(18) CHARACTER SET NONE,
"SSIMMASTER" CHAR(18) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQCALCPEPSSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODPROD" INTEGER,
"NSLDPROD" NUMERIC(15,5),
"DTESTOQ" DATE,
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER)
 RETURNS("NCUSTOPEPS" NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQCOPIAPROD"("ICODPROD" INTEGER,
"ICODEMP" INTEGER,
"ICODFILIAL" INTEGER)
 RETURNS("ICOD" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQCUSTOPRODSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODPROD" INTEGER,
"DTESTOQ" DATE,
"CTIPOCUSTO" CHAR(1) CHARACTER SET NONE,
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER,
"CCOMSALDO" CHAR(10) CHARACTER SET NONE)
 RETURNS("SLDPROD" NUMERIC(15,5),
"CUSTOUNIT" NUMERIC(15,5),
"CUSTOTOT" NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQGERARMASP"("CODEMPOP" INTEGER,
"CODFILIALOP" INTEGER,
"CODOP" INTEGER,
"SEQOP" SMALLINT)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQMOVPRODATEQSP"("ICODEMPPD" INTEGER,
"SCODFILIALPD" SMALLINT,
"ICODPROD" INTEGER,
"ICODEMPLEOLD" INTEGER,
"SCODFILIALLEOLD" SMALLINT,
"CCODLOTEOLD" CHAR(13) CHARACTER SET NONE,
"ICODEMPLENEW" INTEGER,
"SCODFILIALLENEW" SMALLINT,
"CCODLOTENEW" CHAR(13) CHARACTER SET NONE,
"SOPERADOR" SMALLINT,
"NQTDMOVPRODOLD" NUMERIC(15,5),
"NQTDMOVPRODNEW" NUMERIC(15,5),
"ICODEMPAXOLD" INTEGER,
"SCODFILIALAXOLD" SMALLINT,
"ICODALMOXOLD" INTEGER,
"ICODEMPAXNEW" INTEGER,
"SCODFILIALAXNEW" SMALLINT,
"ICODALMOXNEW" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQMOVPRODCKCPSP"("ICODEMPPD" INTEGER,
"SCODFILIALPD" SMALLINT,
"ICODPROD" INTEGER,
"ICODCOMPRA" INTEGER,
"ICODINVPROD" INTEGER,
"DDTMOVPROD" DATE,
"NQTDMOVPROD" NUMERIC(15,5),
"NCUSTOMPMMOVPROD" NUMERIC(15,5))
 RETURNS("DDTULTCPPROD" DATE,
"NQTDULTCPPROD" NUMERIC(15,5),
"DDTMPMPROD" DATE,
"NCUSTOMPMPROD" NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQMOVPRODCKTMSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODTIPOMOV" INTEGER)
 RETURNS("CESTIPOMOV" CHAR(1) CHARACTER SET NONE,
"SOPERADOR" SMALLINT)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQMOVPRODCKUTMSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODTIPOMOV" INTEGER,
"ICODEMPOLD" INTEGER,
"SCODFILIALOLD" SMALLINT,
"ICODTIPOMOVOLD" INTEGER)
 RETURNS("CALTTM" CHAR(1) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQMOVPRODCSLDSP"("ICODEMPTM" INTEGER,
"SCODFILIALTM" SMALLINT,
"ICODTIPOMOV" INTEGER,
"NQTDMOVPROD" NUMERIC(15,5),
"NPRECOMOVPROD" NUMERIC(15,5),
"NCUSTOMPMMOVPROD" NUMERIC(15,5),
"NSLDMOVPROD" NUMERIC(15,5))
 RETURNS("NCUSTOMPM" NUMERIC(15,5),
"NSALDO" NUMERIC(15,5),
"CESTOQMOVPROD" CHAR(1) CHARACTER SET NONE,
"CTIPOMOVPROD" CHAR(1) CHARACTER SET NONE,
"SOPERADOR" SMALLINT)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQMOVPRODDSP"("ICODEMPPD" INTEGER,
"SCODFILIALPD" SMALLINT,
"ICODPROD" INTEGER,
"ICODEMPIV" INTEGER,
"SCODFILIALIV" SMALLINT,
"ICODINVPROD" INTEGER,
"ICODEMPCP" INTEGER,
"SCODFILIALCP" SMALLINT,
"ICODCOMPRA" INTEGER,
"SCODITCOMPRA" SMALLINT,
"ICODEMPVD" INTEGER,
"SCODFILIALVD" SMALLINT,
"CTIPOVENDA" CHAR(1) CHARACTER SET NONE,
"ICODVENDA" INTEGER,
"SCODITVENDA" SMALLINT,
"ICODEMPRM" INTEGER,
"SCODFILIALRM" SMALLINT,
"ICODRMA" INTEGER,
"SCODITRMA" SMALLINT,
"ICODEMPOP" INTEGER,
"SCODFILIALOP" SMALLINT,
"ICODOP" INTEGER,
"SSEQOP" SMALLINT,
"DDTMOVPROD" DATE,
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER,
"CMULTIALMOX" CHAR(1) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQMOVPRODISP"("ICODEMPPD" INTEGER,
"SCODFILIALPD" SMALLINT,
"ICODPROD" INTEGER,
"ICODEMPLE" INTEGER,
"SCODFILIALLE" SMALLINT,
"CCODLOTE" CHAR(13) CHARACTER SET NONE,
"ICODEMPTM" INTEGER,
"SCODFILIALTM" SMALLINT,
"ICODTIPOMOV" INTEGER,
"ICODEMPIV" INTEGER,
"SCODFILIALIV" SMALLINT,
"ICODINVPROD" INTEGER,
"ICODEMPCP" INTEGER,
"SCODFILIALCP" SMALLINT,
"ICODCOMPRA" INTEGER,
"SCODITCOMPRA" SMALLINT,
"ICODEMPVD" INTEGER,
"SCODFILIALVD" SMALLINT,
"CTIPOVENDA" CHAR(1) CHARACTER SET NONE,
"ICODVENDA" INTEGER,
"SCODITVENDA" SMALLINT,
"ICODEMPRM" INTEGER,
"SCODFILIALRM" SMALLINT,
"ICODRMA" INTEGER,
"SCODITRMA" SMALLINT,
"ICODEMPOP" INTEGER,
"SCODFILIALOP" SMALLINT,
"ICODOP" INTEGER,
"SSEQOP" SMALLINT,
"ICODEMPNT" INTEGER,
"SCODFILIALNT" SMALLINT,
"CCODNAT" CHAR(4) CHARACTER SET NONE,
"DDTMOVPROD" DATE,
"IDOCMOVPROD" INTEGER,
"CFLAG" CHAR(1) CHARACTER SET NONE,
"NQTDMOVPROD" NUMERIC(15,5),
"NPRECOMOVPROD" NUMERIC(15,5),
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER,
"CMULTIALMOX" CHAR(1) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQMOVPRODIUDSP"("CIUD" CHAR(1) CHARACTER SET NONE,
"ICODEMPPD" INTEGER,
"SCODFILIALPD" SMALLINT,
"ICODPROD" INTEGER,
"ICODEMPLE" INTEGER,
"SCODFILIALLE" SMALLINT,
"CCODLOTE" CHAR(13) CHARACTER SET NONE,
"ICODEMPTM" INTEGER,
"SCODFILIALTM" SMALLINT,
"ICODTIPOMOV" INTEGER,
"ICODEMPIV" INTEGER,
"SCODFILIALIV" SMALLINT,
"ICODINVPROD" INTEGER,
"ICODEMPCP" INTEGER,
"SCODFILIALCP" SMALLINT,
"ICODCOMPRA" INTEGER,
"SCODITCOMPRA" SMALLINT,
"ICODEMPVD" INTEGER,
"SCODFILIALVD" SMALLINT,
"CTIPOVENDA" CHAR(1) CHARACTER SET NONE,
"ICODVENDA" INTEGER,
"SCODITVENDA" SMALLINT,
"ICODEMPRM" INTEGER,
"SCODFILIALRM" SMALLINT,
"ICODRMA" INTEGER,
"SCODITRMA" SMALLINT,
"ICODEMPOP" INTEGER,
"SCODFILIALOP" SMALLINT,
"ICODOP" INTEGER,
"SSEQOP" SMALLINT,
"ICODEMPNT" INTEGER,
"SCODFILIALNT" SMALLINT,
"CCODNAT" CHAR(4) CHARACTER SET NONE,
"DDTMOVPROD" DATE,
"IDOCMOVPROD" INTEGER,
"CFLAG" CHAR(1) CHARACTER SET NONE,
"NQTDMOVPROD" NUMERIC(15,5),
"NPRECOMOVPROD" NUMERIC(15,5),
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQMOVPRODPRCSLDSP"("SCODFILIAL" SMALLINT,
"ICODMOVPROD" INTEGER,
"ICODEMPPD" INTEGER,
"SCODFILIALPD" SMALLINT,
"ICODPROD" INTEGER,
"DDTMOVPROD" DATE,
"DDTMOVPRODPRC" DATE,
"NSLDMOVPROD" NUMERIC(15,5),
"NCUSTOMPMMOVPROD" NUMERIC(15,5),
"NSLDMOVPRODAX" NUMERIC(15,5),
"NCUSTOMPMMOVPRODAX" NUMERIC(15,5),
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER,
"CMULTIALMOX" CHAR(1) CHARACTER SET NONE)
 RETURNS("NSLDPRC" NUMERIC(15,5),
"NCUSTOMPMPRC" NUMERIC(15,5),
"NSLDPRCAX" NUMERIC(15,5),
"NCUSTOMPMPRCAX" NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQMOVPRODRETCODSP"("ICODEMPIV" INTEGER,
"SCODFILIALIV" SMALLINT,
"ICODINVPROD" INTEGER,
"ICODEMPCP" INTEGER,
"SCODFILIALCP" SMALLINT,
"ICODCOMPRA" INTEGER,
"SCODITCOMPRA" SMALLINT,
"ICODEMPVD" INTEGER,
"SCODFILIALVD" SMALLINT,
"CTIPOVENDA" CHAR(1) CHARACTER SET NONE,
"ICODVENDA" INTEGER,
"SCODITVENDA" SMALLINT,
"ICODEMPRM" INTEGER,
"SCODFILIALRM" SMALLINT,
"ICODRMA" INTEGER,
"SCODITRMA" SMALLINT,
"ICODEMPOP" INTEGER,
"SCODFILIALOP" SMALLINT,
"ICODOP" INTEGER,
"SSEQOP" SMALLINT)
 RETURNS("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODMOVPROD" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQMOVPRODSEQSP"("ICODEMP" INTEGER)
 RETURNS("SCODFILIAL" SMALLINT,
"ICODMOVPROD" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQMOVPRODSLDSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODMOVPROD" INTEGER,
"ICODEMPPD" INTEGER,
"SCODFILIALPD" SMALLINT,
"ICODPROD" INTEGER,
"DDTMOVPROD" DATE,
"NCUSTOMPMMOVPROD" NUMERIC(15,5),
"NCUSTOMPMMOVPRODAX" NUMERIC(15,5),
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER,
"CMULTIALMOX" CHAR(1) CHARACTER SET NONE)
 RETURNS("NSALDO" NUMERIC(15,5),
"NCUSTOMPM" NUMERIC(15,5),
"ICODMOVPRODSLD" INTEGER,
"NSALDOAX" NUMERIC(15,5),
"NCUSTOMPMAX" NUMERIC(15,5),
"ICODMOVPRODSLDAX" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQMOVPRODUSP"("ICODEMPPD" INTEGER,
"SCODFILIALPD" SMALLINT,
"ICODPROD" INTEGER,
"ICODEMPLE" INTEGER,
"SCODFILIALLE" SMALLINT,
"CCODLOTE" CHAR(13) CHARACTER SET NONE,
"ICODEMPTM" INTEGER,
"SCODFILIALTM" SMALLINT,
"ICODTIPOMOV" INTEGER,
"ICODEMPIV" INTEGER,
"SCODFILIALIV" SMALLINT,
"ICODINVPROD" INTEGER,
"ICODEMPCP" INTEGER,
"SCODFILIALCP" SMALLINT,
"ICODCOMPRA" INTEGER,
"SCODITCOMPRA" SMALLINT,
"ICODEMPVD" INTEGER,
"SCODFILIALVD" SMALLINT,
"CTIPOVENDA" CHAR(1) CHARACTER SET NONE,
"ICODVENDA" INTEGER,
"SCODITVENDA" SMALLINT,
"ICODEMPRM" INTEGER,
"SCODFILIALRM" SMALLINT,
"ICODRMA" INTEGER,
"SCODITRMA" SMALLINT,
"ICODEMPOP" INTEGER,
"SCODFILIALOP" SMALLINT,
"ICODOP" INTEGER,
"SSEQOP" SMALLINT,
"ICODEMPNT" INTEGER,
"SCODFILIALNT" SMALLINT,
"CCODNAT" CHAR(4) CHARACTER SET NONE,
"DDTMOVPROD" DATE,
"IDOCMOVPROD" INTEGER,
"CFLAG" CHAR(1) CHARACTER SET NONE,
"NQTDMOVPROD" NUMERIC(15,5),
"NPRECOMOVPROD" NUMERIC(15,5),
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER,
"CMULTIALMOX" CHAR(1) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQPRODUTOSP01"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODPROD" INTEGER,
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER)
 RETURNS("NSALDO" NUMERIC(15,5),
"NSALDOAX" NUMERIC(15,5),
"NCUSTOMPM" NUMERIC(15,5),
"NCUSTOPEPS" NUMERIC(15,5),
"NCUSTOMPMAX" NUMERIC(15,5),
"NCUSTOPEPSAX" NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQREFPRODSP"("CODEMP" INTEGER,
"CODFILIAL" SMALLINT,
"CODPROD" INTEGER)
 RETURNS("REFPROD" CHAR(13) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQRELDEMANDASP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"SCODFILIALPD" SMALLINT,
"DDTINI" DATE,
"DDTFIM" DATE)
 RETURNS("CODMARCA" CHAR(6) CHARACTER SET NONE,
"CODGRUP" CHAR(14) CHARACTER SET NONE,
"CODPROD" INTEGER,
"REFPROD" CHAR(13) CHARACTER SET NONE,
"DESCPROD" CHAR(50) CHARACTER SET NONE,
"DESCGRUP" CHAR(50) CHARACTER SET NONE,
"SLDINI" NUMERIC(15,5),
"VLRCOMPRAS" NUMERIC(15,5),
"VLRDEVENT" NUMERIC(15,5),
"VLROUTENT" NUMERIC(15,5),
"VLRVENDAS" NUMERIC(15,5),
"VLRDEVSAI" NUMERIC(15,5),
"VLROUTSAI" NUMERIC(15,5),
"SLDFIM" NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQRELINVPRODSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"CTIPOCUSTO" CHAR(1) CHARACTER SET NONE,
"ICODEMPGP" INTEGER,
"SCODFILIALGP" SMALLINT,
"CCODGRUP" CHAR(14) CHARACTER SET NONE,
"DDTESTOQ" DATE,
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER)
 RETURNS("CODPROD" INTEGER,
"REFPROD" CHAR(13) CHARACTER SET NONE,
"DESCPROD" CHAR(50) CHARACTER SET NONE,
"CODGRUP" CHAR(14) CHARACTER SET NONE,
"SALDO" NUMERIC(15,5),
"CUSTO" NUMERIC(15,5),
"VLRESTOQ" NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQRELPEPSSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"DTESTOQ" DATE,
"ICODEMPMC" INTEGER,
"SCODFILIALMC" SMALLINT,
"CCODMARCA" CHAR(6) CHARACTER SET NONE,
"ICODEMPGP" INTEGER,
"SCODFILIALGP" SMALLINT,
"CCODGRUP" CHAR(14) CHARACTER SET NONE,
"CTIPOCUSTO" CHAR(1) CHARACTER SET NONE,
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER)
 RETURNS("CODPROD" INTEGER,
"REFPROD" CHAR(13) CHARACTER SET NONE,
"DESCPROD" CHAR(50) CHARACTER SET NONE,
"SLDPROD" NUMERIC(15,5),
"CUSTOUNIT" NUMERIC(15,5),
"CUSTOTOT" NUMERIC(15,5),
"CODBARPROD" CHAR(13) CHARACTER SET NONE,
"CODFABPROD" CHAR(13) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQSALDOLOTEATEQSP"("ICODEMPLEOLD" INTEGER,
"SCODFILIALLEOLD" SMALLINT,
"ICODPROD" INTEGER,
"CCODLOTEOLD" CHAR(13) CHARACTER SET NONE,
"ICODEMPLENEW" INTEGER,
"SCODFILIALLENEW" SMALLINT,
"CCODLOTENEW" CHAR(13) CHARACTER SET NONE,
"SOPERADOR" SMALLINT,
"NQTDMOVPRODOLD" NUMERIC(15,5),
"NQTDMOVPRODNEW" NUMERIC(15,5),
"ICODEMPAXOLD" INTEGER,
"SCODFILIALAXOLD" SMALLINT,
"ICODALMOXOLD" INTEGER,
"ICODEMPAXNEW" INTEGER,
"SCODFILIALAXNEW" SMALLINT,
"ICODALMOXNEW" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "EQSALDOPRODATEQSP"("ICODEMPPD" INTEGER,
"SCODFILIALPD" SMALLINT,
"ICODPROD" INTEGER,
"SOPERADOR" SMALLINT,
"NQTDMOVPRODOLD" NUMERIC(15,5),
"NQTDMOVPRODNEW" NUMERIC(15,5),
"ICODEMPAXOLD" INTEGER,
"SCODFILIALAXOLD" SMALLINT,
"ICODALMOXOLD" INTEGER,
"ICODEMPAXNEW" INTEGER,
"SCODFILIALAXNEW" SMALLINT,
"ICODALMOXNEW" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "FNADICITRECEBERSP01"("CALTVLR" CHAR(1) CHARACTER SET NONE,
"ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODREC" INTEGER,
"INPARCITREC" INTEGER,
"NVLRDESCITREC" NUMERIC(15,5),
"NVLRMULTAITREC" NUMERIC(15,5),
"NVLRJUROSITREC" NUMERIC(15,5),
"NVLRPARCITREC" NUMERIC(15,5),
"NVLRPAGOITREC" NUMERIC(15,5),
"DDTITREC" DATE,
"DDTVENCITREC" DATE,
"CSTATUSITREC" CHAR(2) CHARACTER SET NONE,
"CFLAG" CHAR(1) CHARACTER SET NONE,
"ICODEMPBO" INTEGER,
"SCODFILIALBO" SMALLINT,
"CCODBANCO" CHAR(3) CHARACTER SET NONE,
"ICODEMPTC" INTEGER,
"SCODFILIALTC" SMALLINT,
"ICODTIPOCOB" INTEGER,
"ICODEMPCB" INTEGER,
"SCODFILIALCB" SMALLINT,
"CODCARTCOB" CHAR(2) CHARACTER SET NONE,
"NVLRCOMIITREC" NUMERIC(15,5),
"OBSITREC" VARCHAR(250) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "FNADICLANCASP01"("ICODREC" INTEGER,
"INPARCITREC" INTEGER,
"PDVITREC" CHAR(1),
"SNUMCONTA" CHAR(10) CHARACTER SET NONE,
"ICODEMPCA" INTEGER,
"ICODFILIALCA" INTEGER,
"ICODCLI" INTEGER,
"ICODEMPCL" INTEGER,
"ICODFILIALCL" INTEGER,
"SCODPLAN" CHAR(13) CHARACTER SET NONE,
"ICODEMPPN" INTEGER,
"ICODFILIALPN" INTEGER,
"IANOCC" INTEGER,
"SCODCC" CHAR(19) CHARACTER SET NONE,
"ICODEMPCC" INTEGER,
"ICODFILIALCC" INTEGER,
"DDTPAGOITREC" DATE,
"SDOCLANCAITREC" CHAR(10) CHARACTER SET NONE,
"SOBSITREC" CHAR(50) CHARACTER SET NONE,
"DVLRPAGOITREC" NUMERIC(18,2),
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "FNADICLANCASP02"("ICODPAG" INTEGER,
"INPARCPAG" INTEGER,
"SNUMCONTA" CHAR(10) CHARACTER SET NONE,
"ICODEMPCA" INTEGER,
"ICODFILIALCA" INTEGER,
"ICODFOR" INTEGER,
"ICODEMPFR" INTEGER,
"ICODFILIALFR" INTEGER,
"SCODPLAN" CHAR(13) CHARACTER SET NONE,
"ICODEMPPN" INTEGER,
"ICODFILIALPN" INTEGER,
"IANOCC" INTEGER,
"SCODCC" CHAR(19) CHARACTER SET NONE,
"ICODEMPCC" INTEGER,
"ICODFILIALCC" INTEGER,
"DDTPAGOITPAG" DATE,
"SDOCLANCAITPAG" CHAR(10) CHARACTER SET NONE,
"SOBSITPAG" CHAR(50) CHARACTER SET NONE,
"DVLRPAGOITPAG" NUMERIC(15,5),
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "FNADICPAGARSP01"("CODCOMPRA" INTEGER,
"ICODEMPPG" INTEGER,
"ICODFILIALPG" SMALLINT,
"CODPLANOPAG" INTEGER,
"ICODEMPFR" INTEGER,
"ICODFILIALFR" SMALLINT,
"CODFOR" INTEGER,
"VLRLIQCOMPRA" NUMERIC(18,2),
"DTSAIDACOMPRA" DATE,
"DOCCOMPRA" INTEGER,
"ICODEMPBO" INTEGER,
"ICODFILIALBO" SMALLINT,
"CODBANCO" CHAR(3) CHARACTER SET NONE,
"FLAG" CHAR(1) CHARACTER SET NONE,
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "FNADICRECEBERSP01"("CTIPOVENDA" CHAR(1) CHARACTER SET NONE,
"ICODVENDA" INTEGER,
"ICODEMPTC" INTEGER,
"ICODFILIALTC" INTEGER,
"CODTIPOCOB" INTEGER,
"ICODEMPPG" INTEGER,
"ICODFILIALPG" SMALLINT,
"CODPLANOPAG" INTEGER,
"ICODEMPCL" INTEGER,
"ICODFILIALCL" SMALLINT,
"CODCLI" INTEGER,
"ICODEMPVD" INTEGER,
"ICODFILIALVD" SMALLINT,
"CODVEND" INTEGER,
"VLRLIQVENDA" NUMERIC(15,5),
"DTSAIDAVENDA" DATE,
"VLRCOMISVENDA" NUMERIC(15,5),
"DOCVENDA" INTEGER,
"ICODEMPBO" INTEGER,
"ICODFILIALBO" SMALLINT,
"CODBANCO" CHAR(3) CHARACTER SET NONE,
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT,
"CODEMPCB" INTEGER,
"CODFILIALCB" SMALLINT,
"CODCARTCOB" CHAR(2) CHARACTER SET NONE,
"FLAG" CHAR(1) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "FNCHECAPGTOSP"("ICODCLI" INTEGER,
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT)
 RETURNS("SRETORNO" CHAR(1) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "FNDELETARECEBERSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"CTIPOVENDA" CHAR(1) CHARACTER SET NONE,
"ICODVENDA" INTEGER)
 RETURNS("SDELETADO" SMALLINT)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "FNGERAITRECEBERSP01"("CALTVLR" CHAR(1) CHARACTER SET NONE,
"ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODREC" INTEGER,
"ICODEMPPG" INTEGER,
"SCODFILIALPG" SMALLINT,
"ICODPLANOPAG" INTEGER,
"NVLRREC" NUMERIC(15,5),
"DDATAREC" DATE,
"CFLAG" CHAR(1) CHARACTER SET NONE,
"ICODEMPBO" INTEGER,
"SCODFILIALBO" SMALLINT,
"CCODBANCO" CHAR(3) CHARACTER SET NONE,
"ICODEMPTC" INTEGER,
"SCODFILIALTC" SMALLINT,
"ICODTIPOCOB" INTEGER,
"ICODEMPCB" INTEGER,
"SCODFILIALCB" SMALLINT,
"CODCARTCOB" CHAR(2) CHARACTER SET NONE,
"NVLRCOMIREC" NUMERIC(15,5),
"OBSREC" VARCHAR(250) CHARACTER SET NONE)
 RETURNS("I" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "FNITRECEBERSP01"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODREC" INTEGER,
"NVLRPARCREC" NUMERIC(15,5),
"NVLRCOMIREC" NUMERIC(15,5),
"INROPARCREC" INTEGER,
"CCLASCOMIS" CHAR(1) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "FNLIBCREDSP"("CODVENDA" INTEGER,
"CODCLI" INTEGER,
"CODEMPCL" INTEGER,
"CODFILIALCL" INTEGER,
"VLRLIB" NUMERIC(18,3))
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "FNSALDOPLANSP"("ICODEMPPN" INTEGER,
"ICODFILIALPN" INTEGER,
"SCODPLANANT" CHAR(13) CHARACTER SET NONE,
"DDATAANT" DATE,
"DVLRANT" NUMERIC(15,5),
"SCODPLANATU" CHAR(13) CHARACTER SET NONE,
"DDATAATU" DATE,
"DVLRATU" NUMERIC(15,5))
 RETURNS("SRETORNO" CHAR(1) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "GERAVISITASSP"("NUMVISITAS" INTEGER,
"TIPOVISITA" CHAR(10) CHARACTER SET NONE,
"CODATEND" INTEGER,
"CODFILIALATEND" INTEGER,
"CODEMPATEND" INTEGER,
"CODCLI" INTEGER,
"CODFILIALCLI" INTEGER,
"CODEMPCLI" INTEGER,
"DATA" DATE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "LFBUSCAFISCALSP"("FILIALATUAL" INTEGER,
"CODEMP" INTEGER,
"CODFILIAL" INTEGER,
"CODPROD" INTEGER,
"CODEMPCL" INTEGER,
"CODFILIALCL" INTEGER,
"CODCLI" INTEGER)
 RETURNS("ORIGFISC" CHAR(1) CHARACTER SET NONE,
"CODTRATTRIB" CHAR(2) CHARACTER SET NONE,
"REDFISC" NUMERIC(9,2),
"TIPOFISC" CHAR(2) CHARACTER SET NONE,
"CODMENS" INTEGER,
"ALIQFISC" NUMERIC(9,2),
"ALIQIPIFISC" NUMERIC(9,2),
"TPREDICMSFISC" CHAR(1) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "LFBUSCAICMSSP"("CODNAT" CHAR(4) CHARACTER SET NONE,
"ESTCLI" CHAR(2) CHARACTER SET NONE,
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT)
 RETURNS("PERCICMS" NUMERIC(9,2))
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "LFBUSCANATSP"("FILIALATUAL" INTEGER,
"CODEMP" INTEGER,
"CODFILIAL" INTEGER,
"CODPROD" INTEGER,
"CODEMPCL" INTEGER,
"CODFILIALCL" INTEGER,
"CODCLI" INTEGER,
"CODEMPFR" INTEGER,
"CODFILIALFR" INTEGER,
"CODFOR" INTEGER,
"CODFILIALTM" SMALLINT,
"CODTIPOMOV" INTEGER)
 RETURNS("CODNAT" CHAR(4) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "LFNOVODOCSP"("SSERIE" CHAR(4) CHARACTER SET NONE,
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT)
 RETURNS("DOC" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "PPATUDISTOPSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODOP" INTEGER,
"SSEQOP" SMALLINT,
"NQTDDISTOLD" NUMERIC(15,5),
"NQTDDISTNEW" NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "PPCUSTOPRODSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODPROD" INTEGER,
"DTESTOQ" DATE,
"CTIPOCUSTO" CHAR(1) CHARACTER SET NONE,
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER,
"CCOMSALDO" CHAR(10) CHARACTER SET NONE)
 RETURNS("CUSTOUNIT" NUMERIC(15,5),
"SLDPROD" NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "PPITOPSP01"("ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT,
"ICODOP" INTEGER,
"ISEQOP" SMALLINT)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "PPRELCUSTOSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"DTESTOQ" DATE,
"ICODEMPMC" INTEGER,
"SCODFILIALMC" SMALLINT,
"CCODMARCA" CHAR(6) CHARACTER SET NONE,
"ICODEMPGP" INTEGER,
"SCODFILIALGP" SMALLINT,
"CCODGRUP" CHAR(14) CHARACTER SET NONE,
"CTIPOCUSTO" CHAR(1) CHARACTER SET NONE,
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER)
 RETURNS("CODPROD" INTEGER,
"REFPROD" CHAR(13) CHARACTER SET NONE,
"DESCPROD" CHAR(50) CHARACTER SET NONE,
"TIPOPROD" CHAR(1) CHARACTER SET NONE,
"SLDPROD" NUMERIC(15,5),
"CUSTOUNIT" NUMERIC(15,5),
"CUSTOTOT" NUMERIC(15,5))
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "PVABRECAIXASP"("ICODCAIXA" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODEMP" INTEGER,
"NVLRINICAIXA" NUMERIC(15,5),
"DDTAMOV" DATE,
"ICODFILIALUS" SMALLINT,
"CIDUSU" CHAR(8) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "PVADICMOVCAIXASP01"("ICODCAIXA" INTEGER,
"NVLRINICAIXA" NUMERIC(18,3),
"ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"DDTAMOV" DATE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "PVFECHACAIXASP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODCAIXA" INTEGER,
"DDTAMOV" DATE,
"REDUZ" CHAR(1) CHARACTER SET NONE,
"ICODFILIALUS" SMALLINT,
"CIDUSU" CHAR(8) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "PVFECHAVENDASP"("ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT,
"NVALOR" NUMERIC(15,5),
"ITERM" INTEGER,
"DDTAMOV" DATE,
"CIDUSU" CHAR(8) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "PVRETMOVCAIXASP"("ICODCAIXA" INTEGER,
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT,
"DDTAMOV" DATE)
 RETURNS("DDTAMOVRET" DATE,
"CTIPOMOV" CHAR(1) CHARACTER SET NONE,
"NVLRSLDMOV" NUMERIC(15,5),
"CIDUSU" CHAR(8) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "PVSANGRIASP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"NVALOR" NUMERIC(18,3),
"ICODCAIXA" INTEGER,
"DDTAMOV" DATE,
"CIDUSU" CHAR(8) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "PVSEQMOVCAIXASP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODCAIXA" INTEGER,
"DDTAMOV" DATE)
 RETURNS("INROMOV" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "PVSUPRIMENTOSP"("ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT,
"NVALOR" NUMERIC(18,3),
"ITERM" INTEGER,
"DDTAMOV" DATE,
"CIDUSU" CHAR(8) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "PVVALIDFAIXACAIXASP"("ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT,
"ICODCAIXA" INTEGER,
"NEWSEQINI" INTEGER,
"NEWSEQMAX" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "PVVERIFCAIXASP"("ICODCAIXA" INTEGER,
"ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"DDTAMOV" DATE,
"SCODFILIALUS" SMALLINT,
"CIDUSU" CHAR(8) CHARACTER SET NONE)
 RETURNS("IRETORNO" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "SGAGENTEISP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"CTIPOAGE" CHAR(5) CHARACTER SET NONE,
"CDESCAGE" CHAR(50) CHARACTER SET NONE)
 RETURNS("CODAGE" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "SGAGENTEUIDSP"("CIUD" CHAR(1) CHARACTER SET NONE,
"ICODEMP" INTEGER,
"CTIPOAGE" CHAR(5) CHARACTER SET NONE,
"ICODAGE" INTEGER,
"CDESCAGE" CHAR(50) CHARACTER SET NONE)
 RETURNS("CODEMP" INTEGER,
"CODFILIAL" SMALLINT,
"TIPOAGE" CHAR(5) CHARACTER SET NONE,
"CODAGE" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "SGAGENTEUSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"CTIPOAGE" CHAR(5) CHARACTER SET NONE,
"ICODAGE" INTEGER,
"CDESCAGE" CHAR(50) CHARACTER SET NONE)
 RETURNS("CODAGE" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "SGATUALIZABDSP"("ICODEMP" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "SGDADOSINISP"("ICODEMP" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "SGESTACAOIMPSP01"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODEST" INTEGER,
"SNROIMP" SMALLINT,
"CPADIMP" CHAR(1) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "SGFIMCONSP" AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "SGGRANTADMSP"("ICODEMP" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "SGGRANTUSERSP" AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "SGINICONSP"("ICODEMP" INTEGER,
"CIDUSU" CHAR(8) CHARACTER SET NONE,
"ICODFILIALSEL" SMALLINT,
"ICODTERM" SMALLINT)
 RETURNS("SRET" SMALLINT)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "SGLOGSP01"("CLASLOG" CHAR(2) CHARACTER SET NONE,
"TIPOLOG" CHAR(3) CHARACTER SET NONE,
"DESCLOG" CHAR(60) CHARACTER SET NONE,
"OBSLOG" VARCHAR(1000) CHARACTER SET NONE)
 RETURNS("CODFILIAL" SMALLINT,
"CODLOG" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "SGOBJETOINSTBSP"("ICODEMP" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "SGRETCAIXA" RETURNS("CODEMP" INTEGER,
"CODFILIAL" SMALLINT,
"CODTERM" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "SGRETFILIAL"("ICODEMP" INTEGER,
"SNOMETAB" CHAR(30) CHARACTER SET NONE)
 RETURNS("ICODFILIAL" SMALLINT)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "SGRETINFOUSU"("IDUSU" CHAR(8) CHARACTER SET NONE)
 RETURNS("ANOCCUSU" SMALLINT,
"CODFILIALCCUSU" SMALLINT,
"CODEMPUSU" INTEGER,
"CODFILIALUSU" SMALLINT,
"CODCCUSU" CHAR(19) CHARACTER SET NONE,
"IDUSUS" CHAR(8) CHARACTER SET NONE,
"ALMOXARIFE" CHAR(1) CHARACTER SET NONE,
"APROVARMA" CHAR(2) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "SGRETMULTIALMOXSP"("ICODEMP" INTEGER)
 RETURNS("CMULTIALMOX" CHAR(1) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "SGSETAGENDASP"("CODAGD" INTEGER,
"CODEMP" INTEGER,
"DTAINIAGD" DATE,
"HRINIAGD" TIME,
"DTAFIMAGD" DATE,
"HRFIMAGD" TIME,
"ASSUNTOAGD" CHAR(50) CHARACTER SET NONE,
"DESCAGD" VARCHAR(10000) CHARACTER SET NONE,
"CODFILIALTA" SMALLINT,
"CODTIPOAGD" INTEGER,
"PRIORAGD" SMALLINT,
"CODAGE" INTEGER,
"TIPOAGE" CHAR(5) CHARACTER SET NONE,
"CODFILIALAE" SMALLINT,
"CODAGEEMIT" INTEGER,
"TIPOAGEEMIT" CHAR(5) CHARACTER SET NONE,
"CAAGD" CHAR(2) CHARACTER SET NONE)
 RETURNS("IRET" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "SGUPACESSOMUSP"("ICODEMP" INTEGER,
"ICODFILIAL" INTEGER,
"SIDUSU" CHAR(8) CHARACTER SET NONE,
"ICODSIS" INTEGER,
"ICODMODU" INTEGER,
"ICODMENU" INTEGER,
"CTPACESSOMU" CHAR(1) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "SGUPMENUSP01"("ICODSIS" INTEGER,
"CDESCSIS" CHAR(50) CHARACTER SET NONE,
"ICODMODU" INTEGER,
"CDESCMODU" CHAR(50) CHARACTER SET NONE,
"ICODMENU" INTEGER,
"CDESCMENU" CHAR(50) CHARACTER SET NONE,
"CNOMEMENU" CHAR(50) CHARACTER SET NONE,
"CACAOMENU" CHAR(100) CHARACTER SET NONE,
"ICODSISPAI" INTEGER,
"ICODMODUPAI" INTEGER,
"ICODMENUPAI" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "SPGERANUM"("ICODEMP" INTEGER,
"ICODFILIAL" INTEGER,
"STAB" CHAR(2) CHARACTER SET NONE)
 RETURNS("ISEQ" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "SPGERANUMPDV"("ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT,
"ICODCAIXA" INTEGER)
 RETURNS("ISEQ" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "TKCONTTOCLI"("CODEMP" INTEGER,
"CODFILIAL" INTEGER,
"CODCTO" INTEGER,
"CODFILIALTI" INTEGER,
"CODTIPOCLI" INTEGER,
"CODFILIALCC" INTEGER,
"CODCLASCLI" INTEGER,
"CODFILIALSR" INTEGER,
"CODSETOR" INTEGER)
 RETURNS("IRET" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "TKSETHISTSP"("CODHISTTK" INTEGER,
"CODEMP" INTEGER,
"CODFILIALCO" INTEGER,
"CODCTO" INTEGER,
"CODFILIALCL" INTEGER,
"CODCLI" INTEGER,
"DESCHISTTK" VARCHAR(10000) CHARACTER SET NONE,
"CODFILIALAE" INTEGER,
"CODATEND" INTEGER,
"SITHISTTK" CHAR(2) CHARACTER SET NONE,
"DATAHISTTK" DATE,
"TIPOHISTTK" CHAR(1) CHARACTER SET NONE)
 RETURNS("IRET" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "VDADICCOMISSAOSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODREC" INTEGER,
"INPARCITREC" INTEGER,
"NVLRVENDACOMI" NUMERIC(15,5),
"NVLRCOMI" NUMERIC(15,5),
"DDATACOMI" DATE,
"DDTVENCCOMI" DATE,
"CTIPOCOMI" CHAR(1) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "VDADICITEMPDVSP"("CODVENDA" INTEGER,
"CODEMP" INTEGER,
"CODFILIAL" CHAR(8) CHARACTER SET NONE,
"CODPROD" INTEGER,
"CODEMPPD" INTEGER,
"CODFILIALPD" INTEGER,
"QTDITVENDA" NUMERIC(9,5),
"VLRPRECOITVENDA" NUMERIC(18,5),
"VLRDESCITVENDA" NUMERIC(18,5),
"PERCDESCITVENDA" NUMERIC(15,5),
"VLRCOMISITVENDA" NUMERIC(15,5),
"PERCCOMISITVENDA" NUMERIC(15,5),
"SCODLOTE" CHAR(13) CHARACTER SET NONE,
"CODEMPLE" INTEGER,
"CODFILIALLE" SMALLINT,
"CODFILIALCV" SMALLINT,
"CODCONV" INTEGER)
 RETURNS("CODITVENDA" INTEGER,
"PERCICMSITVENDA" NUMERIC(9,2),
"VLRBASEICMSITVENDA" NUMERIC(18,3),
"VLRICMSITVENDA" NUMERIC(18,3),
"VLRLIQITVENDA" NUMERIC(18,3))
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "VDADICITVENDAORCSP"("FILIALATUAL" INTEGER,
"ICODVENDA" INTEGER,
"ICODORC" INTEGER,
"ICODITORC" INTEGER,
"ICODFILIAL" SMALLINT,
"ICODEMP" INTEGER,
"STIPOVENDA" CHAR(10) CHARACTER SET NONE,
"TPAGRUP" CHAR(1) CHARACTER SET NONE,
"IQTDITVENDA" FLOAT)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "VDADICVENDAORCSP"("ICODORC" INTEGER,
"ICODFILIAL" SMALLINT,
"ICODEMP" INTEGER,
"STIPOVENDA" CHAR(10) CHARACTER SET NONE,
"NEWCODVENDA" INTEGER)
 RETURNS("IRET" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "VDBAIXACOMISSAOSP"("STIPO" CHAR(1) CHARACTER SET NONE,
"DINI" DATE,
"DFIM" DATE,
"ICODVEND" INTEGER,
"ICODEMPVD" INTEGER,
"ICODFILIALVD" SMALLINT,
"SCODCONTA" CHAR(10) CHARACTER SET NONE,
"ICODEMPCA" INTEGER,
"ICODFILIALCA" SMALLINT,
"SCODPLAN" CHAR(13) CHARACTER SET NONE,
"ICODEMPPN" INTEGER,
"ICODFILIALPN" SMALLINT,
"DDATA" DATE,
"IDOC" INTEGER,
"DVLR" NUMERIC(15,5),
"SOBS" CHAR(50) CHARACTER SET NONE,
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "VDBLOQVENDASP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"CTIPOVENDA" CHAR(1) CHARACTER SET NONE,
"ICODVENDA" INTEGER,
"CBLOQVENDA" CHAR(1) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "VDBUSCAPRECOSP"("ICODPROD" INTEGER,
"ICODCLI" INTEGER,
"ICODEMPCL" INTEGER,
"ICODFILIALCL" SMALLINT,
"ICODPLANOPAG" INTEGER,
"ICODEMPPG" INTEGER,
"ICODFILIALPG" SMALLINT,
"ICODTIPOMOV" INTEGER,
"ICODEMPTM" INTEGER,
"ICODFILIALTM" SMALLINT,
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT)
 RETURNS("PRECO" NUMERIC(18,2))
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "VDCLIENTEATIVOSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODCLI" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "VDCOPIAORCSP"("CODEMP" INTEGER,
"CODFILIAL" INTEGER,
"CODORC" INTEGER,
"CODFILIALCL" INTEGER,
"CODCLI" INTEGER)
 RETURNS("IRET" INTEGER)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "VDDESBAIXACOMISSAOSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODVEND" INTEGER,
"CORDEM" CHAR(1) CHARACTER SET NONE,
"DINI" DATE,
"DFIM" DATE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "VDESTORNACOMISSAOSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODEMPVD" INTEGER,
"SCODFILIALVD" SMALLINT,
"ICODVEND" INTEGER,
"DINI" DATE,
"DFIM" DATE,
"CORDEM" CHAR(1) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "VDEVOLUVENDAS"("ICODEMP" SMALLINT,
"ICODFILIAL" SMALLINT,
"DATAINI" DATE,
"DATAFIM" DATE,
"ICODTIPOCLI" SMALLINT,
"ICODCLI" SMALLINT,
"FILTRAVENDAS" CHAR(1) CHARACTER SET NONE)
 RETURNS("VALOR" NUMERIC(15,5),
"MES" SMALLINT,
"ANO" SMALLINT)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "VDGERACOMISSAOSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODREC" INTEGER,
"INPARCITREC" INTEGER,
"NVLRCOMIITREC" NUMERIC(15,5),
"DDTVENCITREC" DATE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "VDGERAESTORNOCOMISP" AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
CREATE PROCEDURE "VDUPVENDAORCSP"("ICODEMP" INTEGER,
"ICODFILIAL" INTEGER,
"ICODORC" INTEGER,
"ICODITORC" INTEGER,
"ICODFILIALVD" INTEGER,
"ICODVENDA" INTEGER,
"ICODITVENDA" INTEGER,
"STIPOVENDA" CHAR(10) CHARACTER SET NONE)
 AS
 BEGIN EXIT; END
^

SET TERM ; ^
COMMIT WORK;

/* Alter Procedure... */
SET TERM ^ ;
ALTER PROCEDURE "ARREDDOUBLE"("DEVALOR" DOUBLE PRECISION,
"ICASASDEC" INTEGER)
 RETURNS("DERETORNO" DOUBLE PRECISION)
 AS
DECLARE VARIABLE I INTEGER;
DECLARE VARIABLE J INTEGER;
begin
  /* Procedure Text */
  I=1;
  J=1;
  WHILE (:J<=:iCasasDec) DO
  BEGIN
     I = I * 10;
     J=J+1;
  END
  deRetorno = floor(deValor * i + 0.5) / i;
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "ATATENDIMENTO"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODATENDO" INTEGER NOT NULL,
"CODCONV" INTEGER NOT NULL,
"CODEMPCV" INTEGER NOT NULL,
"CODFILIALCV" INTEGER NOT NULL,
"CODEMPTO" INTEGER NOT NULL,
"CODFILIALTO" SMALLINT NOT NULL,
"CODTPATENDO" INTEGER NOT NULL,
"CODEMPAE" INTEGER NOT NULL,
"CODFILIALAE" SMALLINT NOT NULL,
"CODATEND" INTEGER NOT NULL,
"CODEMPSA" INTEGER NOT NULL,
"CODFILIALSA" INTEGER NOT NULL,
"CODSETAT" INTEGER NOT NULL,
"DATAATENDO" DATE DEFAULT 'today' NOT NULL,
"HORAATENDO" TIME DEFAULT 'now' NOT NULL,
"OBSATENDO" VARCHAR(10000) CHARACTER SET NONE,
"STATUSATENDO" CHAR(2) CHARACTER SET NONE NOT NULL,
"IDUSU" CHAR(8) CHARACTER SET NONE NOT NULL,
"CODEMPUS" INTEGER NOT NULL,
"CODFILIALUS" INTEGER NOT NULL,
"DOCATENDO" INTEGER NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
CREATE TABLE "ATATENDIMENTOORC"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODATENDO" INTEGER NOT NULL,
"CODEMPOC" INTEGER NOT NULL,
"CODFILIALOC" SMALLINT NOT NULL,
"TIPOORC" CHAR(1) CHARACTER SET NONE NOT NULL,
"CODORC" INTEGER NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
CREATE TABLE "VDORCAMENTO"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"TIPOORC" CHAR(1) CHARACTER SET NONE DEFAULT 'O' NOT NULL,
"CODORC" INTEGER NOT NULL,
"CODEMPAE" INTEGER,
"CODFILIALAE" SMALLINT,
"CODATEND" INTEGER,
"CODEMPCV" INTEGER,
"CODFILIALCV" SMALLINT,
"CODCONV" INTEGER,
"DTORC" DATE NOT NULL,
"DTVENCORC" DATE NOT NULL,
"VLRPRODORC" "NUMERICDN",
"PERCDESCORC" NUMERIC(9,2),
"VLRDESCORC" "NUMERICDN",
"PERCADICORC" NUMERIC(15,5),
"VLRADICORC" "NUMERICDN",
"VLRDESCITORC" "NUMERICDN",
"VLRLIQORC" "NUMERICDN",
"STATUSORC" CHAR(2) CHARACTER SET NONE NOT NULL,
"OBSORC" VARCHAR(10000) CHARACTER SET NONE,
"CODPLANOPAG" INTEGER,
"CODFILIALPG" INTEGER,
"CODEMPPG" INTEGER,
"TXT01" CHAR(20) CHARACTER SET NONE,
"CODEMPVD" INTEGER NOT NULL,
"CODFILIALVD" SMALLINT NOT NULL,
"CODVEND" INTEGER NOT NULL,
"CODEMPCL" INTEGER NOT NULL,
"CODFILIALCL" SMALLINT NOT NULL,
"CODCLI" INTEGER NOT NULL,
"CODTPCONV" INTEGER,
"CODFILIALTC" INTEGER,
"CODEMPTC" INTEGER,
"PRAZOENTORC" SMALLINT,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"EMMANUT" CHAR(1) CHARACTER SET NONE,
"CODCLCOMIS" INTEGER,
"CODEMPCM" SMALLINT,
"CODFILIALCM" INTEGER);
COMMIT WORK;
CREATE TABLE "SGPREFERE2"("CODFILIAL" INTEGER NOT NULL,
"CODEMP" INTEGER NOT NULL,
"CODTPATENDO" INTEGER,
"CODFILIALTO" INTEGER,
"CODEMPTO" INTEGER,
"CODTPATENDO2" INTEGER,
"CODFILIALT2" INTEGER,
"CODEMPT2" INTEGER,
"CODTPATENDO3" INTEGER,
"CODFILIALT3" INTEGER,
"CODEMPT3" INTEGER,
"CODSETAT" INTEGER,
"CODFILIALSA" INTEGER,
"CODEMPSA" INTEGER,
"CODSETAT2" INTEGER,
"CODFILIALS2" INTEGER,
"CODEMPS2" INTEGER,
"CODEMPAE" INTEGER,
"CODFILIALAE" SMALLINT,
"CODATEND" INTEGER,
"CLASSMEDIDA" CHAR(20) CHARACTER SET NONE,
"CODEMPTI" INTEGER,
"CODFILIALTI" SMALLINT,
"CODTIPOCLI" INTEGER,
"CODEMPCI" INTEGER,
"CODFILIALCI" SMALLINT,
"CODCLASCLI" INTEGER,
"CODEMPTA" INTEGER,
"CODFILIALTA" SMALLINT,
"CODTBA" SMALLINT,
"CODITTBA" INTEGER,
"CODEMPTV" INTEGER,
"CODFILIALTV" SMALLINT,
"CODTBV" SMALLINT,
"CODITTBV" INTEGER,
"CODEMPVD" INTEGER NOT NULL,
"CODFILIALVD" SMALLINT NOT NULL,
"CODVEND" INTEGER NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "ATADICATENDIMENTOSP"("ICODCONV" INTEGER,
"ICODTIPOATENDO" INTEGER,
"ICODATEND" INTEGER,
"ICODSETOR" INTEGER,
"VOBSATENDO" VARCHAR(10000) CHARACTER SET NONE,
"ICODEMP" INTEGER,
"ICODFILIAL" INTEGER,
"IDOC" INTEGER)
 AS
DECLARE VARIABLE ICODATENDO INTEGER;
DECLARE VARIABLE IFILIALATENDO INTEGER;
DECLARE VARIABLE IFILIALCONV INTEGER;
DECLARE VARIABLE IFILIALTIPOATENDO INTEGER;
DECLARE VARIABLE IFILIALATEND INTEGER;
DECLARE VARIABLE IFILIALSETOR INTEGER;
DECLARE VARIABLE IFILIALPREF INTEGER;
DECLARE VARIABLE IFILIALVEND INTEGER;
DECLARE VARIABLE IFILIALORC INTEGER;
DECLARE VARIABLE ICODTPATENDOLEV INTEGER; /*TIPO DE ATENDIMENTO PARA LEVANTAMENTOS*/
DECLARE VARIABLE ICODORC INTEGER;
DECLARE VARIABLE ICODCLI INTEGER;
DECLARE VARIABLE ICODVEND INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATATENDIMENTO') INTO IFILIALATENDO;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATCONVENIADO') INTO IFILIALCONV;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATTIPOATENDO') INTO IFILIALTIPOATENDO;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATATENDENTE') INTO IFILIALATEND;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'ATSETOR') INTO IFILIALSETOR;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'VDORCAMENTO') INTO IFILIALORC;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'SGPREFERE2') INTO IFILIALPREF;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'VDVENDEDOR') INTO IFILIALVEND;
  SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALATENDO,'AT') INTO ICODATENDO;
  SELECT CODTPATENDO FROM SGPREFERE2 WHERE CODEMP=:ICODEMP AND CODFILIAL=:IFILIALPREF INTO ICODTPATENDOLEV;
  INSERT INTO ATATENDIMENTO (
    CODEMP,CODFILIAL,CODATENDO,CODCONV,
    CODEMPCV,CODFILIALCV,CODEMPTO,
    CODFILIALTO,CODTPATENDO,CODEMPAE,
    CODFILIALAE,CODATEND,CODEMPSA,CODFILIALSA,
    CODSETAT,STATUSATENDO,OBSATENDO,IDUSU,CODEMPUS,CODFILIALUS,DOCATENDO)
  VALUES
  (
    :ICODEMP,:IFILIALATENDO,:ICODATENDO,:ICODCONV,
    :ICODEMP,:IFILIALCONV,:ICODEMP,
    :IFILIALTIPOATENDO,:ICODTIPOATENDO,:ICODEMP,
    :IFILIALATEND,:ICODATEND,:ICODEMP,:IFILIALSETOR,
    :ICODSETOR,'AA',:VOBSATENDO,lower(USER),:ICODEMP,:ICODFILIAL,:IDOC
  );
/*  SELECT CODORC FROM ATATENDIMENTOORC WHERE CODEMP=:ICODEMP
    AND CODFILIAL=:IFILIALORC AND CODORC=:IDOC INTO ICODORC;*/
  IF (ICODTIPOATENDO = ICODTPATENDOLEV/* AND ICODORC IS NULL*/) THEN
  BEGIN
    SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALORC,'OC') INTO ICODORC;
    SELECT CODFILIALVD,CODVEND FROM SGPREFERE2 WHERE
      CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO IFILIALVEND,ICODVEND;
    INSERT INTO VDORCAMENTO (CODEMP,CODFILIAL,TIPOORC,CODORC,CODEMPCV,CODFILIALCV,CODCONV,
        DTORC,DTVENCORC,STATUSORC,CODEMPVD,CODFILIALVD,CODVEND)
      VALUES
      (
        :ICODEMP,:IFILIALORC,'O',:ICODORC,:ICODEMP,:IFILIALCONV,:ICODCONV,
        CAST ('today' AS DATE),CAST ('today' AS DATE),'OA',:ICODEMP,:IFILIALVEND,:ICODVEND
      );


    INSERT INTO ATATENDIMENTOORC (CODEMP,CODFILIAL,CODATENDO,CODEMPOC,CODFILIALOC,TIPOORC,CODORC)
      VALUES
        (:ICODEMP,:IFILIALORC,:ICODATENDO,:ICODEMP,:IFILIALORC,'O',:ICODORC);

    UPDATE ATATENDIMENTO SET DOCATENDO = :IDOC WHERE
      CODEMP=:ICODEMP AND CODFILIAL=:IFILIALATENDO AND CODATENDO=:ICODATENDO;
  END

END
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "ATCONVENIADO"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODCONV" INTEGER NOT NULL,
"NOMECONV" CHAR(50) CHARACTER SET NONE NOT NULL,
"CODEMPTC" INTEGER NOT NULL,
"CODFILIALTC" SMALLINT NOT NULL,
"CODTPCONV" INTEGER NOT NULL,
"DTNASCCONV" DATE NOT NULL,
"CODEMPAE" INTEGER,
"CODFILIALAE" SMALLINT,
"CODATEND" INTEGER,
"CODEMPGI" INTEGER,
"CODFILIALGI" SMALLINT,
"CODGRI" INTEGER,
"RGCONV" CHAR(10) CHARACTER SET NONE,
"CPFCONV" CHAR(11) CHARACTER SET NONE,
"ENDCONV" CHAR(50) CHARACTER SET NONE,
"NUMCONV" INTEGER,
"BAIRCONV" CHAR(30) CHARACTER SET NONE,
"CIDCONV" CHAR(30) CHARACTER SET NONE,
"CEPCONV" CHAR(8) CHARACTER SET NONE,
"FONECONV" CHAR(12) CHARACTER SET NONE,
"FAXCONV" CHAR(8) CHARACTER SET NONE,
"EMAILCONV" CHAR(60) CHARACTER SET NONE,
"PAICONV" CHAR(50) CHARACTER SET NONE,
"MAECONV" CHAR(50) CHARACTER SET NONE,
"RGPAICONV" CHAR(10) CHARACTER SET NONE,
"RGMAECONV" CHAR(10) CHARACTER SET NONE,
"CNSCONV" CHAR(15) CHARACTER SET NONE,
"CODEMPCL" INTEGER,
"CODFILIALCL" INTEGER,
"CODCLI" INTEGER,
"UFCONV" CHAR(2) CHARACTER SET NONE,
"CELCONV" CHAR(8) CHARACTER SET NONE,
"SEXOCONV" CHAR(1) CHARACTER SET NONE,
"IDENTIFICCONV" CHAR(20) CHARACTER SET NONE,
"COMPLCONV" CHAR(20) CHARACTER SET NONE,
"CODEMPEC" INTEGER,
"CODFILIALEC" SMALLINT,
"CODENC" INTEGER,
"CODEMPFC" INTEGER,
"CODFILIALFC" SMALLINT,
"CODFUNC" INTEGER,
"ICARDCONV" CHAR(15) CHARACTER SET NONE,
"NRVIACONV" SMALLINT,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT 'now',
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"DDDCONV" CHAR(4) CHARACTER SET NONE,
"DDDFAXCONV" CHAR(4) CHARACTER SET NONE,
"DDDCELCONV" CHAR(4) CHARACTER SET NONE);
COMMIT WORK;
CREATE TABLE "SGPREFERE1"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"USAREFPROD" CHAR(1) CHARACTER SET NONE NOT NULL,
"CODTIPOMOV" INTEGER,
"CODEMPTM" SMALLINT,
"CODFILIALTM" SMALLINT,
"USAPEDSEQ" CHAR(1) CHARACTER SET NONE,
"USAORCSEQ" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"FILTRO" CHAR(2) CHARACTER SET NONE,
"USALIQREL" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"TIPOPRECOCUSTO" CHAR(1) CHARACTER SET NONE DEFAULT 'M' NOT NULL,
"ANOCENTROCUSTO" SMALLINT,
"OBSORCPAD" VARCHAR(10000) CHARACTER SET NONE,
"CODTIPOMOV2" INTEGER,
"CODFILIALT2" SMALLINT,
"CODEMPT2" INTEGER,
"CLASSORC" CHAR(20) CHARACTER SET NONE,
"TITORCTXT01" CHAR(20) CHARACTER SET NONE,
"CODTIPOMOV3" INTEGER,
"CODFILIALT3" SMALLINT,
"CODEMPT3" INTEGER,
"ORDNOTA" CHAR(1) CHARACTER SET NONE,
"SETORVENDA" CHAR(1) CHARACTER SET NONE DEFAULT 'C',
"PREFCRED" CHAR(1) CHARACTER SET NONE,
"LCREDGLOBAL" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL,
"CODEMPMO" INTEGER NOT NULL,
"CODFILIALMO" INTEGER NOT NULL,
"CODMOEDA" CHAR(4) CHARACTER SET NONE NOT NULL,
"CODTIPOMOV4" INTEGER,
"CODFILIALT4" INTEGER,
"CODEMPT4" INTEGER,
"USACLASCOMIS" CHAR(1) CHARACTER SET NONE,
"PERCPRECOCUSTO" NUMERIC(9,2) DEFAULT 0 NOT NULL,
"CODGRUP" CHAR(14) CHARACTER SET NONE,
"CODFILIALGP" INTEGER,
"CODEMPGP" INTEGER,
"CODMARCA" CHAR(6) CHARACTER SET NONE,
"CODFILIALMC" INTEGER,
"CODEMPMC" INTEGER,
"RGCLIOBRIG" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL,
"TABFRETEVD" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL,
"TABADICVD" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL,
"TRAVATMNFVD" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL,
"TIPOVALIDORC" CHAR(1) CHARACTER SET NONE DEFAULT 'D',
"CLIMESMOCNPJ" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"CODTBJ" INTEGER,
"CODEMPTJ" INTEGER,
"CODFILIALTJ" INTEGER,
"CNPJOBRIGCLI" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL,
"JUROSPOSCALC" CHAR(1) CHARACTER SET NONE,
"CODEMPFR" INTEGER,
"CODFILIALFR" INTEGER,
"CODFOR" INTEGER,
"CODEMPTN" INTEGER,
"CODFILIALTN" SMALLINT,
"CODTRAN" INTEGER,
"CODEMPTF" INTEGER,
"CODFILIALTF" INTEGER,
"CODTIPOFOR" INTEGER,
"CODEMPT5" INTEGER,
"CODFILIALT5" INTEGER,
"CODTIPOMOV5" INTEGER,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"ESTLOTNEG" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"ESTNEG" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"NATVENDA" CHAR(1) CHARACTER SET NONE DEFAULT 'S',
"IPIVENDA" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"CUSTOSICMS" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL,
"CODEMPPG" INTEGER,
"CODFILIALPG" SMALLINT,
"CODPLANOPAG" INTEGER,
"CODEMPTB" INTEGER,
"CODFILIALTB" SMALLINT,
"CODTAB" INTEGER,
"CODEMPCE" INTEGER,
"CODFILIALCE" SMALLINT,
"CODCLASCLI" INTEGER,
"CASASDEC" SMALLINT DEFAULT 2,
"CASASDECFIN" SMALLINT DEFAULT 2,
"COMISPDUPL" CHAR(1) CHARACTER SET NONE DEFAULT 'S',
"CODEMPT6" INTEGER,
"CODFILIALT6" SMALLINT,
"CODTIPOMOV6" INTEGER,
"BLOQVENDA" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL,
"BLOQCOMPRA" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"VENDAMATPRIM" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"PEPSPROD" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"CNPJFOROBRIG" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL,
"INSCESTFOROBRIG" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL,
"BUSCAPRODSIMILAR" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"MULTIALMOX" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"CODEMPT8" INTEGER,
"CODFILIALT8" SMALLINT,
"CODTIPOMOV8" INTEGER,
"ESTNEGGRUP" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"USATABPE" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"TAMDESCPROD" SMALLINT DEFAULT 50,
"DESCCOMPPED" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"OBSCLIVEND" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"CONTESTOQ" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL,
"DIASPEDT" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"RECALCPCVENDA" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"RECALCPCORC" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"USALAYOUTPED" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"VERIFALTPARCVENDA" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"BUSCACODPRODGEN" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"FILBUSCGENPROD" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"FILBUSCGENREF" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"FILBUSCGENCODBAR" CHAR(1) CHARACTER SET NONE NOT NULL,
"FILBUSCGENCODFAB" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"BUSCAVLRULTCOMPRA" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"ICMSVENDA" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"USAPRECOZERO" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"USAIMGASSORC" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"IMGASSORC" BLOB SEGMENT SIZE 50,
"CONSISTEIECLI" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL,
"CONSISTEIEFOR" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL,
"USANOMEVENDORC" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"SISCONTABIL" CHAR(2) CHARACTER SET NONE DEFAULT '00' NOT NULL,
"ATBANCOIMPBOL" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"TIPOCODBAR" CHAR(1) CHARACTER SET NONE DEFAULT '1' NOT NULL,
"ADICORCOBSPED" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "ATBUSCAPRECOSP"("ICODPROD" INTEGER,
"ICODCONV" INTEGER,
"ICODEMPCV" INTEGER,
"ICODFILIALCV" SMALLINT,
"ICODPLANOPAG" INTEGER,
"ICODEMPPG" INTEGER,
"ICODFILIALPG" SMALLINT,
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT)
 RETURNS("PRECO" NUMERIC(15,5))
 AS
DECLARE VARIABLE iCodTipoMov INTEGER;
  DECLARE VARIABLE iCodEmpTM INTEGER;
  DECLARE VARIABLE iCodFilialTM INTEGER;
  DECLARE VARIABLE iCodCli INTEGER;
  DECLARE VARIABLE iCodEmpCli INTEGER;
  DECLARE VARIABLE iCodFilialCli INTEGER;
BEGIN
  SELECT CODTIPOMOV2,CODEMPT2,CODFILIALT2 FROM SGPREFERE1 WHERE CODEMP=:ICODEMP
         AND CODFILIAL=:ICODFILIAL INTO iCodTipoMov,iCodEmpTM,iCodFilialTM;
  SELECT CODCLI,CODEMPCL,CODFILIALCL FROM ATCONVENIADO WHERE CODCONV=:ICODCONV
         AND CODEMP=:ICODEMPCV AND CODFILIAL=:ICODFILIALCV INTO iCodCli,iCodEmpCli,iCodFilialCli;

  SELECT PRECO FROM VDBUSCAPRECOSP(:ICODPROD,:iCodCli,:iCodEmpCli,:iCodFilialCli,:ICODPLANOPAG,:ICODEMPPG,
    :ICODFILIALPG,:iCodTipoMov,:iCodEmpTM,:iCodFilialTM,:ICODEMP,:ICODFILIAL) INTO PRECO;

  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "CPFORNECED"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODFOR" INTEGER NOT NULL,
"RAZFOR" CHAR(50) CHARACTER SET NONE NOT NULL,
"CODEMPTF" INTEGER NOT NULL,
"CODFILIALTF" SMALLINT NOT NULL,
"CODTIPOFOR" INTEGER NOT NULL,
"CODEMPBO" INTEGER,
"CODFILIALBO" SMALLINT,
"CODBANCO" CHAR(3) CHARACTER SET NONE,
"CODEMPHP" INTEGER,
"CODFILIALHP" SMALLINT,
"CODHIST" INTEGER,
"NOMEFOR" CHAR(50) CHARACTER SET NONE NOT NULL,
"DATAFOR" DATE DEFAULT 'today' NOT NULL,
"ATIVOFOR" CHAR(1) CHARACTER SET NONE,
"PESSOAFOR" CHAR(1) CHARACTER SET NONE NOT NULL,
"CNPJFOR" CHAR(14) CHARACTER SET NONE,
"CPFFOR" CHAR(11) CHARACTER SET NONE,
"INSCFOR" CHAR(15) CHARACTER SET NONE,
"RGFOR" CHAR(10) CHARACTER SET NONE,
"ENDFOR" CHAR(50) CHARACTER SET NONE,
"NUMFOR" INTEGER,
"COMPLFOR" CHAR(20) CHARACTER SET NONE,
"BAIRFOR" CHAR(30) CHARACTER SET NONE,
"CEPFOR" CHAR(8) CHARACTER SET NONE,
"CIDFOR" CHAR(30) CHARACTER SET NONE,
"UFFOR" CHAR(2) CHARACTER SET NONE,
"CONTFOR" CHAR(40) CHARACTER SET NONE,
"FONEFOR" CHAR(12) CHARACTER SET NONE,
"FAXFOR" CHAR(8) CHARACTER SET NONE,
"AGENCIAFOR" CHAR(6) CHARACTER SET NONE,
"CONTAFOR" CHAR(10) CHARACTER SET NONE,
"EMAILFOR" CHAR(50) CHARACTER SET NONE,
"OBSFOR" VARCHAR(10000) CHARACTER SET NONE,
"CELFOR" CHAR(8) CHARACTER SET NONE,
"CLIFOR" CHAR(1) CHARACTER SET NONE DEFAULT 'F',
"SSPFOR" CHAR(10) CHARACTER SET NONE,
"DDDFONEFOR" CHAR(4) CHARACTER SET NONE,
"DDDFAXFOR" CHAR(4) CHARACTER SET NONE,
"DDDCELFOR" CHAR(4) CHARACTER SET NONE,
"SITEFOR" CHAR(50) CHARACTER SET NONE,
"CODCONTDEB" VARCHAR(20) CHARACTER SET NONE,
"CODCONTCRED" VARCHAR(20) CHARACTER SET NONE,
"CODFORCONTAB" VARCHAR(20) CHARACTER SET NONE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
CREATE TABLE "VDCLIENTE"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODCLI" INTEGER NOT NULL,
"RAZCLI" CHAR(50) CHARACTER SET NONE NOT NULL,
"NOMECLI" CHAR(50) CHARACTER SET NONE NOT NULL,
"CODEMPCC" INTEGER,
"CODFILIALCC" SMALLINT,
"CODCLASCLI" INTEGER,
"CODEMPVD" INTEGER,
"CODFILIALVD" SMALLINT,
"CODVEND" INTEGER,
"CODEMPTC" INTEGER,
"CODFILIALTC" SMALLINT,
"CODTIPOCOB" INTEGER,
"CODEMPPG" INTEGER,
"CODFILIALPG" SMALLINT,
"CODPLANOPAG" INTEGER,
"CODEMPTN" INTEGER,
"CODFILIALTN" SMALLINT,
"CODTRAN" INTEGER,
"CODEMPBO" INTEGER,
"CODFILIALBO" SMALLINT,
"CODBANCO" CHAR(3) CHARACTER SET NONE,
"CODEMPSR" INTEGER,
"CODFILIALSR" SMALLINT,
"CODSETOR" INTEGER,
"CODEMPTI" INTEGER NOT NULL,
"CODFILIALTI" SMALLINT NOT NULL,
"CODTIPOCLI" INTEGER NOT NULL,
"CODTPCRED" INTEGER,
"CODFILIALTR" INTEGER,
"CODEMPTR" INTEGER,
"CODFISCCLI" INTEGER,
"CODEMPFC" INTEGER,
"CODFILIALFC" INTEGER,
"CODPAIS" SMALLINT,
"CODEMPEC" INTEGER,
"CODFILIALEC" SMALLINT,
"CODTBEC" SMALLINT,
"CODITTBEC" INTEGER,
"CODEMPHP" INTEGER,
"CODFILIALHP" SMALLINT,
"CODHIST" INTEGER,
"CODEMPCB" INTEGER,
"CODFILIALCB" SMALLINT,
"CODCARTCOB" CHAR(2) CHARACTER SET NONE,
"DATACLI" DATE DEFAULT 'today' NOT NULL,
"PESSOACLI" CHAR(1) CHARACTER SET NONE NOT NULL,
"ATIVOCLI" CHAR(1) CHARACTER SET NONE NOT NULL,
"CNPJCLI" CHAR(14) CHARACTER SET NONE,
"INSCCLI" CHAR(15) CHARACTER SET NONE,
"CPFCLI" CHAR(11) CHARACTER SET NONE,
"RGCLI" CHAR(10) CHARACTER SET NONE,
"SSPCLI" CHAR(10) CHARACTER SET NONE,
"ENDCLI" CHAR(50) CHARACTER SET NONE,
"NUMCLI" INTEGER,
"COMPLCLI" CHAR(20) CHARACTER SET NONE,
"BAIRCLI" CHAR(30) CHARACTER SET NONE,
"CIDCLI" CHAR(30) CHARACTER SET NONE,
"UFCLI" CHAR(2) CHARACTER SET NONE,
"CEPCLI" CHAR(8) CHARACTER SET NONE,
"DDDCLI" CHAR(4) CHARACTER SET NONE,
"FONECLI" CHAR(12) CHARACTER SET NONE,
"RAMALCLI" CHAR(6) CHARACTER SET NONE,
"DDDFAXCLI" CHAR(4) CHARACTER SET NONE,
"FAXCLI" CHAR(8) CHARACTER SET NONE,
"EMAILCLI" CHAR(50) CHARACTER SET NONE,
"CONTCLI" CHAR(40) CHARACTER SET NONE,
"ENDCOB" CHAR(50) CHARACTER SET NONE,
"NUMCOB" INTEGER,
"COMPLCOB" CHAR(20) CHARACTER SET NONE,
"BAIRCOB" CHAR(30) CHARACTER SET NONE,
"CIDCOB" CHAR(30) CHARACTER SET NONE,
"UFCOB" CHAR(2) CHARACTER SET NONE,
"CEPCOB" CHAR(8) CHARACTER SET NONE,
"DDDFONECOB" CHAR(4) CHARACTER SET NONE,
"FONECOB" CHAR(12) CHARACTER SET NONE,
"DDDFAXCOB" CHAR(4) CHARACTER SET NONE,
"FAXCOB" CHAR(8) CHARACTER SET NONE,
"ENDENT" CHAR(50) CHARACTER SET NONE,
"NUMENT" INTEGER,
"COMPLENT" CHAR(20) CHARACTER SET NONE,
"BAIRENT" CHAR(30) CHARACTER SET NONE,
"CIDENT" CHAR(30) CHARACTER SET NONE,
"UFENT" CHAR(2) CHARACTER SET NONE,
"CEPENT" CHAR(8) CHARACTER SET NONE,
"DDDFONEENT" CHAR(4) CHARACTER SET NONE,
"FONEENT" CHAR(12) CHARACTER SET NONE,
"DDDFAXENT" CHAR(4) CHARACTER SET NONE,
"FAXENT" CHAR(8) CHARACTER SET NONE,
"OBSCLI" VARCHAR(10000) CHARACTER SET NONE,
"AGENCIACLI" CHAR(6) CHARACTER SET NONE,
"CODEMPPQ" INTEGER,
"CODFILIALPQ" SMALLINT,
"CODPESQ" INTEGER,
"INCRACLI" CHAR(15) CHARACTER SET NONE,
"DTINITR" DATE,
"DTVENCTOTR" DATE,
"NIRFCLI" CHAR(15) CHARACTER SET NONE,
"SIMPLESCLI" CHAR(1) CHARACTER SET NONE,
"DDDCELCLI" CHAR(4) CHARACTER SET NONE,
"CELCLI" CHAR(8) CHARACTER SET NONE,
"NATCLI" CHAR(30) CHARACTER SET NONE,
"UFNATCLI" CHAR(2) CHARACTER SET NONE,
"TEMPORESCLI" CHAR(20) CHARACTER SET NONE,
"APELIDOCLI" CHAR(30) CHARACTER SET NONE,
"SITECLI" CHAR(50) CHARACTER SET NONE,
"CODCONTDEB" VARCHAR(20) CHARACTER SET NONE,
"CODCONTCRED" VARCHAR(20) CHARACTER SET NONE,
"CODCLICONTAB" VARCHAR(20) CHARACTER SET NONE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT user,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "CPADICFORSP"("CODEMP" INTEGER,
"CODFILIAL" INTEGER,
"CODFILIALCL" INTEGER,
"CODCLI" INTEGER)
 RETURNS("CODFOR" INTEGER)
 AS
DECLARE VARIABLE CODTIPOFOR INTEGER;
DECLARE VARIABLE CODFILIALTF INTEGER;
DECLARE VARIABLE CODFILIALFR INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'CPFORNECED') INTO CODFILIALFR;
  SELECT P.CODTIPOFOR,P.CODFILIALTF FROM SGPREFERE1 P WHERE P.CODEMP=:CODEMP
    AND P.CODFILIAL=:CODFILIAL INTO CODTIPOFOR,CODFILIALTF;
  SELECT MAX(CODFOR)+1 FROM CPFORNECED WHERE CODEMP=:CODEMP
    AND CODFILIAL=:CODFILIALFR INTO CODFOR;
  INSERT INTO CPFORNECED (CODEMP,CODFILIAL,CODFOR,RAZFOR,CODEMPTF,CODFILIALTF,
                        CODTIPOFOR,CODEMPBO,CODFILIALBO,CODBANCO,NOMEFOR,
                        DATAFOR,ATIVOFOR,PESSOAFOR,CNPJFOR,CPFFOR,INSCFOR,
                        RGFOR,ENDFOR,NUMFOR,COMPLFOR,BAIRFOR,CEPFOR,CIDFOR,
                        UFFOR,CONTFOR,FONEFOR,FAXFOR,AGENCIAFOR,CONTAFOR,
                        EMAILFOR,OBSFOR,CELFOR,CLIFOR)
                 SELECT :CODEMP,:CODFILIALFR,:CODFOR,RAZCLI,:CODEMP,:CODFILIALTF,
                        :CODTIPOFOR,NULL,NULL,NULL,NOMECLI,
                        DATACLI,ATIVOCLI,PESSOACLI,CNPJCLI,CPFCLI,INSCCLI,
                        RGCLI,ENDCLI,NUMCLI,COMPLCLI,BAIRCLI,CEPCLI,CIDCLI,
                        UFCLI,CONTCLI,FONECLI,FAXCLI,NULL,NULL,
                        EMAILCLI,OBSCLI,CELCLI,'C' FROM VDCLIENTE WHERE
                        CODCLI=:CODCLI AND CODFILIAL=:CODFILIALCL AND
                        CODEMP=:CODEMP;
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "CPCOMPRA"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODCOMPRA" INTEGER NOT NULL,
"CODEMPPG" INTEGER NOT NULL,
"CODFILIALPG" SMALLINT NOT NULL,
"CODPLANOPAG" INTEGER NOT NULL,
"CODEMPFR" INTEGER NOT NULL,
"CODFILIALFR" SMALLINT NOT NULL,
"CODFOR" INTEGER NOT NULL,
"CODEMPSE" INTEGER NOT NULL,
"CODFILIALSE" SMALLINT NOT NULL,
"SERIE" CHAR(4) CHARACTER SET NONE NOT NULL,
"CODEMPTM" INTEGER NOT NULL,
"CODFILIALTM" SMALLINT NOT NULL,
"CODTIPOMOV" INTEGER NOT NULL,
"DOCCOMPRA" INTEGER NOT NULL,
"DTENTCOMPRA" DATE NOT NULL,
"DTEMITCOMPRA" DATE NOT NULL,
"VLRPRODCOMPRA" "NUMERICDN",
"PERCDESCCOMPRA" NUMERIC(6,2),
"VLRDESCCOMPRA" "NUMERICDN",
"VLRDESCITCOMPRA" "NUMERICDN",
"VLRCOMPRA" "NUMERICDN",
"VLRBASEICMSCOMPRA" "NUMERICDN",
"VLRICMSCOMPRA" "NUMERICDN",
"VLRISENTASCOMPRA" "NUMERICDN",
"VLROUTRASCOMPRA" "NUMERICDN",
"VLRBASEIPICOMPRA" "NUMERICDN",
"VLRLIQCOMPRA" "NUMERICDN",
"STATUSCOMPRA" CHAR(2) CHARACTER SET NONE NOT NULL,
"VLRFRETECOMPRA" "NUMERICDN",
"VLRADICCOMPRA" "NUMERICDN",
"PERCIPICOMPRA" NUMERIC(6,2),
"VLRIPICOMPRA" "NUMERICDN",
"CODEMPBO" INTEGER,
"CODFILIALBO" SMALLINT,
"CODBANCO" CHAR(3) CHARACTER SET NONE,
"IMPNOTACOMPRA" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"BLOQCOMPRA" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"EMMANUT" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"FLAG" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"ADICFRETECOMPRA" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"TIPOFRETECOMPRA" CHAR(1) CHARACTER SET NONE,
"OBSERVACAO" VARCHAR(1024) CHARACTER SET NONE,
"CODEMPSOL" INTEGER,
"CODFILIALSOL" SMALLINT,
"CODSOL" INTEGER);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "CPBLOQCOMPRASP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODCOMPRA" INTEGER,
"CBLOQCOMPRA" CHAR(1) CHARACTER SET NONE)
 AS
begin
  /* Stored procedure de bloqueio e desbloqueio de venda*/
  UPDATE CPCOMPRA SET EMMANUT='S', BLOQCOMPRA=:CBLOQCOMPRA WHERE CODEMP=:ICODEMP AND
     CODFILIAL=:SCODFILIAL AND CODCOMPRA=:ICODCOMPRA;
  UPDATE CPCOMPRA SET EMMANUT='N' WHERE CODEMP=:ICODEMP AND
     CODFILIAL=:SCODFILIAL AND CODCOMPRA=:ICODCOMPRA;
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "CPCOMPRASP01"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"NQTD" NUMERIC(15,5),
"NVLRTOT" NUMERIC(15,5),
"NVLRICMS" NUMERIC(15,5))
 RETURNS("NVLRCUSTO" NUMERIC(15,5))
 AS
DECLARE VARIABLE ICASASDEC INTEGER;
DECLARE VARIABLE CCUSTOSICMS CHAR(1);
begin
  /* Procedure Text */
  if (NQTD!=0) then
  begin
    SELECT CUSTOSICMS,CASASDECFIN FROM SGPREFERE1 WHERE CODEMP=:iCodEmp
       AND CODFILIAL=:sCodFilial INTO :cCustoSICMS, :iCasasDec;
    if (iCasasDec is null) then
       iCasasDec = 2;
    if (cCustoSICMS IS NULL) then
       cCustoSICMS = 'N';
    if (cCustoSICMS='S') then
    begin
       select deRetorno
         from arredDouble( (:NVLRTOT - :NVLRICMS) / :NQTD , :ICASASDEC  )
         into :NVLRCUSTO;
    end
    else
    begin
       select deRetorno
         from arredDouble( :NVLRTOT / :NQTD , :ICASASDEC )
         into :NVLRCUSTO;
    end
  end
  else
  begin
    NVLRCUSTO = 0;
  end
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "VDVENDA"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"TIPOVENDA" CHAR(1) CHARACTER SET NONE DEFAULT 'V' NOT NULL,
"CODVENDA" INTEGER NOT NULL,
"CODEMPVD" INTEGER,
"CODFILIALVD" SMALLINT,
"CODVEND" INTEGER,
"CODEMPCL" INTEGER NOT NULL,
"CODFILIALCL" SMALLINT NOT NULL,
"CODCLI" INTEGER NOT NULL,
"CODEMPPG" INTEGER NOT NULL,
"CODFILIALPG" SMALLINT NOT NULL,
"CODPLANOPAG" INTEGER NOT NULL,
"CODEMPSE" INTEGER NOT NULL,
"CODFILIALSE" SMALLINT NOT NULL,
"SERIE" CHAR(4) CHARACTER SET NONE NOT NULL,
"CODEMPTM" INTEGER NOT NULL,
"CODFILIALTM" SMALLINT NOT NULL,
"CODTIPOMOV" INTEGER NOT NULL,
"CODEMPCX" INTEGER,
"CODFILIALCX" SMALLINT,
"CODCAIXA" INTEGER,
"DOCVENDA" INTEGER NOT NULL,
"DTSAIDAVENDA" DATE NOT NULL,
"DTEMITVENDA" DATE NOT NULL,
"VLRPRODVENDA" "NUMERICDN",
"PERCDESCVENDA" NUMERIC(9,2),
"VLRDESCVENDA" "NUMERICDN",
"VLRDESCITVENDA" "NUMERICDN",
"VLRVENDA" "NUMERICDN",
"VLRBASEICMSVENDA" "NUMERICDN",
"VLRICMSVENDA" "NUMERICDN",
"VLRISENTASVENDA" "NUMERICDN",
"VLROUTRASVENDA" "NUMERICDN",
"VLRBASEIPIVENDA" "NUMERICDN",
"VLRLIQVENDA" "NUMERICDN",
"PERCCOMISVENDA" NUMERIC(9,2),
"VLRCOMISVENDA" "NUMERICDN",
"STATUSVENDA" CHAR(2) CHARACTER SET NONE NOT NULL,
"VLRFRETEVENDA" "NUMERICDN",
"VLRADICVENDA" "NUMERICDN",
"VLRIPIVENDA" "NUMERICDN",
"OBSVENDA" VARCHAR(10000) CHARACTER SET NONE,
"CODEMPBO" INTEGER,
"CODFILIALBO" SMALLINT,
"CODBANCO" CHAR(3) CHARACTER SET NONE,
"CODEMPTC" INTEGER,
"CODFILIALTC" SMALLINT,
"CODTIPOCOB" INTEGER,
"VLRBASEISSVENDA" "NUMERICDN" DEFAULT 0,
"VLRISSVENDA" "NUMERICDN" DEFAULT 0,
"IMPNOTAVENDA" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"FLAG" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"CODCLASCOMIS" CHAR(1) CHARACTER SET NONE,
"VLRPISVENDA" "NUMERICDN" DEFAULT 0,
"VLRCOFINSVENDA" "NUMERICDN" DEFAULT 0,
"VLRIRVENDA" "NUMERICDN" DEFAULT 0,
"VLRCSOCIALVENDA" "NUMERICDN" DEFAULT 0,
"PERCMCOMISVENDA" NUMERIC(7,3) DEFAULT 0,
"CODEMPCM" INTEGER,
"CODFILIALCM" INTEGER,
"CODCLCOMIS" INTEGER,
"CODEMPCB" INTEGER,
"CODFILIALCB" SMALLINT,
"CODCARTCOB" CHAR(2) CHARACTER SET NONE,
"PEDCLIVENDA" CHAR(10) CHARACTER SET NONE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"EMMANUT" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"BLOQVENDA" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL);
COMMIT WORK;
CREATE TABLE "EQTIPOMOV"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODTIPOMOV" INTEGER NOT NULL,
"CODEMPMN" INTEGER NOT NULL,
"CODFILIALMN" SMALLINT NOT NULL,
"CODMODNOTA" INTEGER NOT NULL,
"CODEMPSE" INTEGER NOT NULL,
"CODFILIALSE" SMALLINT NOT NULL,
"SERIE" CHAR(4) CHARACTER SET NONE NOT NULL,
"DESCTIPOMOV" CHAR(40) CHARACTER SET NONE NOT NULL,
"ESTIPOMOV" CHAR(1) CHARACTER SET NONE NOT NULL,
"FISCALTIPOMOV" CHAR(1) CHARACTER SET NONE NOT NULL,
"ESTOQTIPOMOV" CHAR(1) CHARACTER SET NONE NOT NULL,
"TIPOMOV" CHAR(2) CHARACTER SET NONE NOT NULL,
"CODEMPTB" INTEGER,
"CODFILIALTB" SMALLINT,
"CODTAB" INTEGER,
"ESPECIETIPOMOV" CHAR(4) CHARACTER SET NONE,
"CODEMPTM" INTEGER,
"CODFILIALTM" SMALLINT,
"CODTIPOMOVTM" INTEGER,
"IMPPEDTIPOMOV" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"IMPNFTIPOMOV" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"IMPBOLTIPOMOV" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"IMPRECTIPOMOV" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"REIMPNFTIPOMOV" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"TUSUTIPOMOV" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL,
"SOMAVDTIPOMOV" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"SEQNFTIPOMOV" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"VLRMFINTIPOMOV" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"CTIPOFRETE" CHAR(1) CHARACTER SET NONE DEFAULT 'C',
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "CPGERAENTRADASP"("CODEMP" INTEGER,
"CODFILIAL" INTEGER,
"CODFILIALVD" INTEGER,
"TIPOVENDA" CHAR(1) CHARACTER SET NONE,
"CODVENDA" INTEGER,
"CITEM" CHAR(1) CHARACTER SET NONE)
 RETURNS("CODCOMPRA" INTEGER)
 AS
DECLARE VARIABLE STATUSVENDA CHAR(2);
DECLARE VARIABLE CODCLI INTEGER;
DECLARE VARIABLE CODFILIALCL INTEGER;
DECLARE VARIABLE CODFILIALCP INTEGER;
DECLARE VARIABLE CODTIPOMOV INTEGER;
DECLARE VARIABLE CODFILIALTM INTEGER;
DECLARE VARIABLE SERIE INTEGER;
DECLARE VARIABLE CODFILIALSE INTEGER;
DECLARE VARIABLE DOC INTEGER;
DECLARE VARIABLE CODFOR INTEGER;
DECLARE VARIABLE CODFILIALFR INTEGER;
DECLARE VARIABLE CODITVENDA INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'CPFORNECED') INTO CODFILIALFR;
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'CPCOMPRA') INTO CODFILIALCP;
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'VDCLINTE') INTO CODFILIALCL;

  SELECT ISEQ FROM SPGERANUM(:CODEMP,:CODFILIAL,'CP') INTO CODCOMPRA;

  SELECT CODCLI,CODFILIALCL,STATUSVENDA FROM VDVENDA WHERE CODVENDA=:CODVENDA AND TIPOVENDA=:TIPOVENDA
    AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL INTO CODCLI,CODFILIALCL,STATUSVENDA;
  IF (SUBSTRING (STATUSVENDA FROM 1 FOR 1) = 'C') THEN
    EXCEPTION VDVENDAEX05;
  
  SELECT CODFOR FROM CPADICFORSP(:CODEMP,:CODFILIAL,:CODFILIALCL,:CODCLI) INTO CODFOR;

  SELECT P.CODTIPOMOV5,P.CODFILIALT5,
    T.SERIE,T.CODFILIALSE FROM SGPREFERE1 P, EQTIPOMOV T WHERE P.CODEMP=:CODEMP
    AND P.CODFILIAL=:CODFILIAL AND T.CODTIPOMOV=P.CODTIPOMOV5 AND
    T.CODEMP=P.CODEMPT5 AND T.CODFILIAL=P.CODFILIALT5
    INTO CODTIPOMOV,CODFILIALTM,SERIE,CODFILIALSE;

  SELECT * FROM LFNOVODOCSP(:SERIE,:CODEMP,:CODFILIALSE) INTO DOC;

  INSERT INTO CPCOMPRA (CODEMP,CODFILIAL,CODCOMPRA,CODEMPPG,CODFILIALPG,CODPLANOPAG,
                        CODEMPFR,CODFILIALFR,CODFOR,CODEMPSE,CODFILIALSE,SERIE,
                        CODEMPTM,CODFILIALTM,CODTIPOMOV,DOCCOMPRA,DTENTCOMPRA,DTEMITCOMPRA)
                 SELECT :CODEMP,:CODFILIAL,:CODCOMPRA,CODEMPPG,CODFILIALPG,CODPLANOPAG,
                        :CODEMP,:CODFILIALFR,:CODFOR,:CODEMP,:CODFILIALSE,:SERIE,
                        CODEMP,:CODFILIALTM,:CODTIPOMOV,:DOC,DTSAIDAVENDA,DTEMITVENDA FROM
                        VDVENDA WHERE CODEMP=:CODEMP AND CODFILIAL=:CODFILIALVD AND
                        CODVENDA=:CODVENDA AND TIPOVENDA=:TIPOVENDA;
  IF (CITEM = 'S') THEN
    EXECUTE PROCEDURE CPGERAITENTRADASP(:CODEMP,:CODFILIALCP,:CODCOMPRA,:CODFILIALVD,:TIPOVENDA,:CODVENDA,NULL,NULL);
    
  UPDATE VDVENDA SET STATUSVENDA='DV' WHERE TIPOVENDA=:TIPOVENDA AND CODVENDA=:CODVENDA
    AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIALVD;
  
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "CPCOMPRAVENDA"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" INTEGER NOT NULL,
"CODCOMPRA" INTEGER NOT NULL,
"CODITCOMPRA" INTEGER NOT NULL,
"CODEMPVD" INTEGER NOT NULL,
"CODFILIALVD" INTEGER NOT NULL,
"TIPOVENDA" CHAR(1) CHARACTER SET NONE NOT NULL,
"CODVENDA" INTEGER NOT NULL,
"CODITVENDA" INTEGER NOT NULL,
"QTDDEV" "NUMERICDN" NOT NULL);
COMMIT WORK;
CREATE TABLE "CPITCOMPRA"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODCOMPRA" INTEGER NOT NULL,
"CODITCOMPRA" INTEGER NOT NULL,
"CODEMPPD" INTEGER NOT NULL,
"CODFILIALPD" SMALLINT NOT NULL,
"CODPROD" INTEGER NOT NULL,
"CODEMPLE" INTEGER,
"CODFILIALLE" SMALLINT,
"CODLOTE" CHAR(13) CHARACTER SET NONE,
"CODEMPNT" INTEGER NOT NULL,
"CODFILIALNT" SMALLINT NOT NULL,
"CODNAT" CHAR(4) CHARACTER SET NONE NOT NULL,
"CODEMPAX" INTEGER NOT NULL,
"CODFILIALAX" SMALLINT NOT NULL,
"CODALMOX" INTEGER NOT NULL,
"QTDITCOMPRA" "NUMERICDN" NOT NULL,
"PRECOITCOMPRA" "NUMERICDN" NOT NULL,
"PERCDESCITCOMPRA" NUMERIC(9,2),
"VLRDESCITCOMPRA" "NUMERICDN",
"PERCICMSITCOMPRA" NUMERIC(9,2),
"VLRBASEICMSITCOMPRA" "NUMERICDN",
"VLRICMSITCOMPRA" "NUMERICDN",
"PERCIPIITCOMPRA" NUMERIC(9,2),
"VLRBASEIPIITCOMPRA" "NUMERICDN",
"VLRIPIITCOMPRA" "NUMERICDN",
"VLRLIQITCOMPRA" "NUMERICDN",
"VLRADICITCOMPRA" "NUMERICDN",
"VLRFRETEITCOMPRA" "NUMERICDN",
"VLRISENTASITCOMPRA" "NUMERICDN",
"VLROUTRASITCOMPRA" "NUMERICDN",
"VLRPRODITCOMPRA" "NUMERICDN",
"CUSTOITCOMPRA" "NUMERICDN" DEFAULT 0,
"REFPROD" CHAR(13) CHARACTER SET NONE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"CUSTOVDITCOMPRA" "NUMERICDN" DEFAULT 0 NOT NULL,
"EMMANUT" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL);
COMMIT WORK;
CREATE TABLE "VDITVENDA"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"TIPOVENDA" CHAR(1) CHARACTER SET NONE DEFAULT 'V' NOT NULL,
"CODVENDA" INTEGER NOT NULL,
"CODITVENDA" INTEGER NOT NULL,
"CODEMPNT" INTEGER NOT NULL,
"CODFILIALNT" SMALLINT NOT NULL,
"CODNAT" CHAR(4) CHARACTER SET NONE NOT NULL,
"CODEMPPD" INTEGER NOT NULL,
"CODFILIALPD" SMALLINT NOT NULL,
"CODPROD" INTEGER NOT NULL,
"CODEMPLE" INTEGER,
"CODFILIALLE" SMALLINT,
"CODLOTE" CHAR(13) CHARACTER SET NONE,
"CODEMPAX" INTEGER NOT NULL,
"CODFILIALAX" SMALLINT NOT NULL,
"CODALMOX" INTEGER NOT NULL,
"QTDITVENDA" "NUMERICDN" NOT NULL,
"PRECOITVENDA" "NUMERICDN" NOT NULL,
"PERCDESCITVENDA" NUMERIC(9,2),
"VLRDESCITVENDA" "NUMERICDN",
"PERCICMSITVENDA" NUMERIC(9,2),
"VLRBASEICMSITVENDA" "NUMERICDN",
"VLRICMSITVENDA" "NUMERICDN",
"PERCIPIITVENDA" NUMERIC(9,2),
"VLRBASEIPIITVENDA" "NUMERICDN",
"VLRIPIITVENDA" "NUMERICDN",
"VLRLIQITVENDA" "NUMERICDN",
"PERCCOMISITVENDA" NUMERIC(9,2),
"VLRCOMISITVENDA" "NUMERICDN",
"VLRADICITVENDA" "NUMERICDN",
"PERCISSITVENDA" NUMERIC(9,2),
"VLRISSITVENDA" "NUMERICDN",
"VLRFRETEITVENDA" "NUMERICDN",
"VLRPRODITVENDA" "NUMERICDN",
"VLRISENTASITVENDA" "NUMERICDN",
"VLROUTRASITVENDA" "NUMERICDN",
"REFPROD" CHAR(13) CHARACTER SET NONE,
"VLRBASEISSITVENDA" "NUMERICDN" DEFAULT 0,
"OBSITVENDA" VARCHAR(502) CHARACTER SET NONE,
"ORIGFISC" CHAR(1) CHARACTER SET NONE,
"CODEMPTT" INTEGER,
"CODFILIALTT" INTEGER,
"CODTRATTRIB" CHAR(2) CHARACTER SET NONE,
"TIPOFISC" CHAR(2) CHARACTER SET NONE,
"CODEMPME" INTEGER,
"CODFILIALME" SMALLINT,
"CODMENS" INTEGER,
"STRDESCITVENDA" CHAR(50) CHARACTER SET NONE,
"QTDDEVITVENDA" "NUMERICDN" DEFAULT 0,
"CODEMPLG" INTEGER,
"CODFILIALLG" SMALLINT,
"CODLOG" INTEGER,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"EMMANUT" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"CANCITVENDA" CHAR(1) CHARACTER SET NONE,
"CODEMPPE" INTEGER,
"CODFILIALPE" SMALLINT,
"CODPE" INTEGER,
"DIASPE" SMALLINT,
"CODEMPCV" INTEGER,
"CODFILIALCV" SMALLINT,
"CODCONV" INTEGER);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "CPGERAITENTRADASP"("CODEMP" INTEGER,
"CODFILIAL" INTEGER,
"CODCOMPRA" INTEGER,
"CODFILIALVD" INTEGER,
"TIPOVENDA" CHAR(1) CHARACTER SET NONE,
"CODVENDA" INTEGER,
"CODITVENDA" INTEGER,
"QTDIT" INTEGER)
 AS
DECLARE VARIABLE CODITCOMPRA INTEGER;
DECLARE VARIABLE CODFILIALTM INTEGER;
DECLARE VARIABLE CODTIPOMOV INTEGER;
DECLARE VARIABLE CODFILIALFR INTEGER;
DECLARE VARIABLE CODFOR INTEGER;
DECLARE VARIABLE CODNAT CHAR(4);
DECLARE VARIABLE CODFILIALNT INTEGER;
DECLARE VARIABLE PERCICMSITCOMPRA NUMERIC(9,2);
DECLARE VARIABLE CODFILIALPD INTEGER;
DECLARE VARIABLE CODPROD INTEGER;
DECLARE VARIABLE CODFILIALLE INTEGER;
DECLARE VARIABLE CODLOTE CHAR(13);
DECLARE VARIABLE QTDITVENDA NUMERIC(18,3);
DECLARE VARIABLE QTDDEVITVENDA NUMERIC(18,3);
DECLARE VARIABLE PRECOITVENDA NUMERIC(18,3);
DECLARE VARIABLE PERCDESCITVENDA NUMERIC(9,2);
DECLARE VARIABLE VLRDESCITVENDA NUMERIC(18,3);
DECLARE VARIABLE PERCICMSITVENDA NUMERIC(9,2);
DECLARE VARIABLE VLRBASEICMSITVENDA NUMERIC(18,3);
DECLARE VARIABLE VLRICMSITVENDA NUMERIC(18,3);
DECLARE VARIABLE PERCIPIITVENDA NUMERIC(9,2);
DECLARE VARIABLE VLRBASEIPIITVENDA NUMERIC(18,3);
DECLARE VARIABLE VLRIPIITVENDA NUMERIC(18,3);
DECLARE VARIABLE VLRLIQITVENDA NUMERIC(18,3);
DECLARE VARIABLE VLRADICITVENDA NUMERIC(18,3);
DECLARE VARIABLE VLRFRETEITVENDA NUMERIC(18,3);
DECLARE VARIABLE VLRISENTASITVENDA NUMERIC(18,3);
DECLARE VARIABLE VLROUTRASITVENDA NUMERIC(18,3);
DECLARE VARIABLE VLRPRODITVENDA NUMERIC(18,3);
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'LFNATOPER') INTO CODFILIALNT;
  SELECT CODFOR,CODFILIALFR,CODTIPOMOV,CODFILIALTM FROM CPCOMPRA WHERE CODCOMPRA=:CODCOMPRA
    AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL INTO
    :CODFOR,:CODFILIALFR,:CODTIPOMOV,:CODFILIALTM;
  FOR SELECT CODITVENDA,CODFILIALPD,CODPROD,CODFILIALLE,CODLOTE,
             QTDITVENDA,PRECOITVENDA,PERCDESCITVENDA,VLRDESCITVENDA,PERCICMSITVENDA,
             VLRBASEICMSITVENDA,VLRICMSITVENDA,PERCIPIITVENDA,VLRBASEIPIITVENDA,
             VLRIPIITVENDA,VLRLIQITVENDA,VLRADICITVENDA,VLRFRETEITVENDA,VLRISENTASITVENDA,
             VLROUTRASITVENDA,VLRPRODITVENDA,VLRPRODITVENDA FROM VDITVENDA WHERE
             CODEMP=:CODEMP AND CODFILIAL=:CODFILIALVD AND CODVENDA=:CODVENDA AND TIPOVENDA=:TIPOVENDA AND
             (:CODITVENDA IS NULL OR CODITVENDA=:CODITVENDA)
             ORDER BY CODITVENDA INTO CODITCOMPRA,CODFILIALPD,CODPROD,CODFILIALLE,CODLOTE,
             QTDITVENDA,PRECOITVENDA,PERCDESCITVENDA,VLRDESCITVENDA,PERCICMSITVENDA,
             VLRBASEICMSITVENDA,VLRICMSITVENDA,PERCIPIITVENDA,VLRBASEIPIITVENDA,
             VLRIPIITVENDA,VLRLIQITVENDA,VLRADICITVENDA,VLRFRETEITVENDA,VLRISENTASITVENDA,
             VLROUTRASITVENDA,VLRPRODITVENDA,VLRPRODITVENDA DO
  BEGIN
      IF (QTDIT IS NULL) THEN
        QTDIT = QTDITVENDA;
      SELECT SUM(QTDDEV) FROM CPCOMPRAVENDA WHERE TIPOVENDA=:TIPOVENDA
        AND CODVENDA=:CODVENDA AND CODITVENDA=:CODITVENDA
        AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL INTO QTDDEVITVENDA;
      IF (QTDIT > QTDITVENDA OR QTDIT+QTDDEVITVENDA > QTDITVENDA) THEN
        EXCEPTION VDVENDAEX01 'O ITEM: '||CAST(CODITVENDA AS CHAR(3))||' DO PEDIDO: '||
          CAST(CODVENDA AS CHAR(6))||' JA FOI DEVOLVIDO!';
        
      SELECT CODNAT FROM LFBUSCANATSP (:CODFILIAL,:CODEMP,:CODFILIALPD,:CODPROD,NULL,NULL,NULL,
                                   :CODEMP,:CODFILIALFR,:CODFOR,:CODFILIALTM,:CODTIPOMOV) INTO CODNAT;
      INSERT INTO CPITCOMPRA (CODEMP,CODFILIAL,CODCOMPRA,CODITCOMPRA,CODEMPPD,CODFILIALPD,CODPROD,
                              CODEMPLE,CODFILIALLE,CODLOTE,CODEMPNT,CODFILIALNT,CODNAT,QTDITCOMPRA,
                              PRECOITCOMPRA,PERCDESCITCOMPRA,VLRDESCITCOMPRA,PERCICMSITCOMPRA,
                              VLRBASEICMSITCOMPRA,VLRICMSITCOMPRA,PERCIPIITCOMPRA,VLRBASEIPIITCOMPRA,
                              VLRIPIITCOMPRA,VLRLIQITCOMPRA,VLRADICITCOMPRA,VLRFRETEITCOMPRA,
                              VLRISENTASITCOMPRA,VLROUTRASITCOMPRA,VLRPRODITCOMPRA,CUSTOITCOMPRA)
                       VALUES (:CODEMP,:CODFILIAL,:CODCOMPRA,:CODITCOMPRA,:CODEMP,:CODFILIALPD,:CODPROD,
                              :CODEMP,:CODFILIALLE,:CODLOTE,:CODEMP,:CODFILIALNT,:CODNAT,:QTDIT,
                              :PRECOITVENDA,:PERCDESCITVENDA,:VLRDESCITVENDA,:PERCICMSITVENDA,
                              :VLRBASEICMSITVENDA,:VLRICMSITVENDA,:PERCIPIITVENDA,:VLRBASEIPIITVENDA,
                              :VLRIPIITVENDA,:VLRLIQITVENDA,:VLRADICITVENDA,:VLRFRETEITVENDA,
                              :VLRISENTASITVENDA,:VLROUTRASITVENDA,:VLRPRODITVENDA,:VLRPRODITVENDA);

      INSERT INTO CPCOMPRAVENDA(CODEMP,CODFILIAL,CODCOMPRA,CODITCOMPRA,CODEMPVD,
                                CODFILIALVD,TIPOVENDA,CODVENDA,CODITVENDA,QTDDEV)
                       VALUES (:CODEMP,:CODFILIAL,:CODCOMPRA,:CODITCOMPRA,:CODEMP,
                               :CODFILIALVD,:TIPOVENDA,:CODVENDA,:CODITCOMPRA,:QTDIT);
  END
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "VDPRECOPROD"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODPROD" INTEGER NOT NULL,
"CODPRECOPROD" INTEGER NOT NULL,
"CODEMPTB" INTEGER NOT NULL,
"CODFILIALTB" SMALLINT NOT NULL,
"CODTAB" INTEGER NOT NULL,
"CODEMPCC" INTEGER,
"CODFILIALCC" SMALLINT,
"CODCLASCLI" INTEGER,
"CODEMPPG" INTEGER NOT NULL,
"CODFILIALPG" SMALLINT NOT NULL,
"CODPLANOPAG" INTEGER NOT NULL,
"PRECOPROD" "NUMERICDN" NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
CREATE TABLE "EQPRODUTO"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODPROD" INTEGER NOT NULL,
"DESCPROD" CHAR(50) CHARACTER SET NONE NOT NULL,
"REFPROD" CHAR(13) CHARACTER SET NONE NOT NULL,
"CODEMPAX" INTEGER NOT NULL,
"CODFILIALAX" SMALLINT NOT NULL,
"CODALMOX" INTEGER NOT NULL,
"CODEMPMA" INTEGER NOT NULL,
"CODFILIALMA" SMALLINT NOT NULL,
"CODMOEDA" CHAR(4) CHARACTER SET NONE NOT NULL,
"CODEMPUD" INTEGER NOT NULL,
"CODFILIALUD" SMALLINT NOT NULL,
"CODUNID" CHAR(8) CHARACTER SET NONE NOT NULL,
"CODEMPFC" INTEGER NOT NULL,
"CODFILIALFC" SMALLINT NOT NULL,
"CODFISC" CHAR(13) CHARACTER SET NONE NOT NULL,
"CODEMPMC" INTEGER NOT NULL,
"CODFILIALMC" SMALLINT NOT NULL,
"CODMARCA" CHAR(6) CHARACTER SET NONE NOT NULL,
"DESCAUXPROD" CHAR(40) CHARACTER SET NONE,
"TIPOPROD" CHAR(1) CHARACTER SET NONE NOT NULL,
"CVPROD" CHAR(1) CHARACTER SET NONE NOT NULL,
"CODEMPGP" INTEGER NOT NULL,
"CODFILIALGP" SMALLINT NOT NULL,
"CODGRUP" CHAR(14) CHARACTER SET NONE NOT NULL,
"CODBARPROD" CHAR(13) CHARACTER SET NONE,
"CLOTEPROD" CHAR(1) CHARACTER SET NONE NOT NULL,
"CODFABPROD" CHAR(13) CHARACTER SET NONE,
"COMISPROD" NUMERIC(6,2),
"PESOLIQPROD" NUMERIC(10,3),
"PESOBRUTPROD" NUMERIC(10,3),
"QTDMINPROD" "NUMERICDN",
"QTDMAXPROD" "NUMERICDN",
"DTMPMPROD" DATE,
"CUSTOMPMPROD" "NUMERICDN" DEFAULT 0,
"CUSTOPEPSPROD" "NUMERICDN" DEFAULT 0,
"PRECOBASEPROD" "NUMERICDN",
"SLDPROD" "NUMERICDN",
"SLDRESPROD" "NUMERICDN",
"SLDCONSIGPROD" "NUMERICDN",
"SLDLIQPROD" "NUMERICDN",
"ATIVOPROD" CHAR(1) CHARACTER SET NONE DEFAULT 'S',
"DTULTCPPROD" DATE,
"QTDULTCPPROD" "NUMERICDN",
"DESCCOMPPROD" VARCHAR(500) CHARACTER SET NONE,
"VERIFPROD" CHAR(1) CHARACTER SET NONE DEFAULT 'S',
"LOCALPROD" CHAR(15) CHARACTER SET NONE,
"RMAPROD" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"CODEMPPE" INTEGER,
"CODFILIALPE" SMALLINT,
"CODPE" INTEGER,
"USARECEITAPROD" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"USATELAADICPDV" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQADICPRODUTOSP"("ICODPROD" INTEGER,
"SDESCPROD" CHAR(50) CHARACTER SET NONE,
"SDESCAUXPROD" CHAR(40) CHARACTER SET NONE,
"SREFPROD" CHAR(13) CHARACTER SET NONE,
"SCODFABPROD" CHAR(13) CHARACTER SET NONE,
"SCODBARPROD" CHAR(13) CHARACTER SET NONE,
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT)
 AS
DECLARE VARIABLE iCodnovo INTEGER;
  DECLARE VARIABLE CODALMOX INTEGER;
  DECLARE VARIABLE CODEMPAX INTEGER;
  DECLARE VARIABLE CODFILIALAX INTEGER;
  DECLARE VARIABLE CODMOEDA CHAR(4);
  DECLARE VARIABLE CODEMPMA INTEGER;
  DECLARE VARIABLE CODFILIALMA INTEGER;
  DECLARE VARIABLE CODUNID CHAR(8);
  DECLARE VARIABLE CODEMPUD INTEGER;
  DECLARE VARIABLE CODFILIALUD INTEGER;
  DECLARE VARIABLE CODFISC CHAR(10);
  DECLARE VARIABLE CODEMPFC INTEGER;
  DECLARE VARIABLE CODFILIALFC INTEGER;
  DECLARE VARIABLE CODMARCA CHAR(6);
  DECLARE VARIABLE CODEMPMC INTEGER;
  DECLARE VARIABLE CODFILIALMC INTEGER;
  DECLARE VARIABLE CODGRUP CHAR(10);
  DECLARE VARIABLE CODEMPGP INTEGER;
  DECLARE VARIABLE CODFILIALGP INTEGER;
  DECLARE VARIABLE TIPOPROD CHAR(1);
  DECLARE VARIABLE CVPROD CHAR(1);
  DECLARE VARIABLE CLOTEPROD CHAR(1);
  DECLARE VARIABLE COMISPROD NUMERIC(6,2);
  DECLARE VARIABLE PESOLIQPROD NUMERIC(10,2);
  DECLARE VARIABLE PESOBRUTPROD NUMERIC(10,2);
  DECLARE VARIABLE QTDMINPROD NUMERIC(15, 5);
  DECLARE VARIABLE QTDMAXPROD NUMERIC(15, 5);
  DECLARE VARIABLE PRECOBASEPROD NUMERIC(15, 5);
BEGIN
  BEGIN
    BEGIN
      iCodnovo = CAST(SREFPROD AS INTEGER);
/*Se no conseguir converter para int causa uma excesso e entra neste bloco: */
      WHEN ANY DO
      BEGIN
        SELECT MAX(CODPROD) FROM EQPRODUTO
           WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO :iCodnovo;
        iCodnovo = iCodnovo + 1;
      END
    END
    SELECT CODALMOX,CODEMPAX,CODFILIALAX,CODMOEDA,CODEMPMA,CODFILIALMA,CODUNID,CODEMPUD,CODFILIALUD,CODFISC,CODEMPFC,CODFILIALFC,CODMARCA,CODEMPMC,CODFILIALMC,CODGRUP,CODEMPGP,CODFILIALGP,TIPOPROD,
           CVPROD,CLOTEPROD,COMISPROD,PESOLIQPROD,PESOBRUTPROD,QTDMINPROD,
           QTDMAXPROD,PRECOBASEPROD FROM EQPRODUTO WHERE CODPROD=:iCodprod
           AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
           INTO
           :CODALMOX,:CODEMPAX,:CODFILIALAX,:CODMOEDA,:CODEMPMA,:CODFILIALMA,:CODUNID,:CODEMPUD,:CODFILIALUD,:CODFISC,:CODEMPFC,:CODFILIALFC,:CODMARCA,:CODEMPMC,:CODFILIALMC,:CODGRUP,:CODEMPGP,:CODFILIALGP,:TIPOPROD,
           :CVPROD,:CLOTEPROD,:COMISPROD,:PESOLIQPROD,:PESOBRUTPROD,:QTDMINPROD,
           :QTDMAXPROD,:PRECOBASEPROD;
    INSERT INTO EQPRODUTO (CODEMP,CODFILIAL,CODPROD,REFPROD,CODALMOX,CODEMPAX,CODFILIALAX,CODMOEDA,CODEMPMA,CODFILIALMA,CODUNID,CODEMPUD,CODFILIALUD,CODFISC,CODEMPFC,CODFILIALFC,CODMARCA,CODEMPMC,CODFILIALMC,
           CODGRUP,CODEMPGP,CODFILIALGP,TIPOPROD,CVPROD,DESCPROD,DESCAUXPROD,CLOTEPROD,CODBARPROD,CODFABPROD,
           COMISPROD,PESOLIQPROD,PESOBRUTPROD,QTDMINPROD,QTDMAXPROD,PRECOBASEPROD)
           VALUES (
                  :ICODEMP,:ICODFILIAL,:iCodnovo,:sRefProd,:CODALMOX,:CODEMPAX,:CODFILIALAX,:CODMOEDA,:CODEMPMA,:CODFILIALMA,:CODUNID,:CODEMPUD,:CODFILIALUD,:CODFISC,:CODEMPFC,:CODFILIALFC,:CODMARCA,:CODEMPMC,:CODFILIALMC,
                  :CODGRUP,:CODEMPGP,:CODFILIALGP,:TIPOPROD,:CVPROD,:sDescprod,:sDescAuxprod,:CLOTEPROD,:sCodbarprod,:sCodfabprod,
                  :COMISPROD,:PESOLIQPROD,:PESOBRUTPROD,:QTDMINPROD,:QTDMAXPROD,:PRECOBASEPROD
           );
    INSERT INTO VDPRECOPROD (CODEMP,CODFILIAL,CODPROD,CODPRECOPROD,CODCLASCLI,CODEMPCC,CODFILIALCC,CODTAB,CODEMPTB,CODFILIALTB,CODPLANOPAG,CODEMPPG,CODFILIALPG,PRECOPROD)
           SELECT :ICODEMP,:ICODFILIAL,:iCodnovo,CODPRECOPROD,CODCLASCLI,CODEMPCC,CODFILIALCC,
                  CODTAB,CODEMPTB,CODFILIALTB,CODPLANOPAG,CODEMPPG,CODFILIALPG,PRECOPROD FROM VDPRECOPROD WHERE CODPROD=:iCodprod
                  AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL;
  END
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQBUSCASIMILARSP"("CODEMP" INTEGER,
"CODFILIAL" CHAR(8) CHARACTER SET NONE,
"IPROD" INTEGER,
"SREFPROD" CHAR(13) CHARACTER SET NONE)
 RETURNS("SRET" CHAR(13) CHARACTER SET NONE,
"IRET" INTEGER,
"CORIG" CHAR(1) CHARACTER SET NONE,
"ICODFOR" INTEGER,
"SRAZFOR" CHAR(50) CHARACTER SET NONE,
"NPRECO" NUMERIC(15,5),
"SSIM" CHAR(18) CHARACTER SET NONE,
"SSIMMASTER" CHAR(18) CHARACTER SET NONE)
 AS
DECLARE VARIABLE SFK CHAR(21);
DECLARE VARIABLE SBUSCA CHAR(21);
BEGIN
/*  IF (IPROD IS NULL) THEN
  BEGIN
    SELECT CODPROD FROM EQPRODUTO WHERE CODEMP=:CODEMP
      AND CODFILIAL=:CODFILIAL AND REFPROD=:SREFPROD
      INTO IPROD;
    SBUSCA = CAST(SREFPROD AS CHAR(21));
  END
  ELSE
  BEGIN
    SBUSCA = CAST(IPROD AS VARCHAR(21));
  END
  FOR SELECT 'S',S.REFPRODSIM,S.REFPRODSIMFK,CAST(NULL AS INTEGER),
    CAST(NULL AS CHAR(50)),CAST(NULL AS NUMERIC(15, 5)),
    S.CODPROD,(SELECT P.REFPROD FROM EQPRODUTO P WHERE P.CODPROD=S.CODPROD
    AND P.CODEMP=S.CODEMP AND P.CODFILIAL=S.CODFILIAL)
    FROM EQSIMILAR S WHERE
    (S.CODPROD = :IPROD OR S.REFPRODSIM = :SBUSCA)
    AND S.CODEMP=:CODEMP AND S.CODFILIAL=:CODFILIAL INTO
    CORIG,SSIM,SFK,ICODFOR,SRAZFOR,NPRECO,IRET,SRET DO
  BEGIN
    SSIMMASTER = SSIM;
    SUSPEND;
    FOR SELECT 'K',S.REFPRODSIM,S.REFPRODSIMFK,CAST(NULL AS INTEGER),
      CAST(NULL AS CHAR(50)),CAST(NULL AS NUMERIC(15, 5)),
      S.CODPROD,(SELECT P.REFPROD FROM EQPRODUTO P WHERE P.CODPROD=S.CODPROD
      AND P.CODEMP=S.CODEMP AND P.CODFILIAL=S.CODFILIAL)
      FROM EQSIMILAR S WHERE
      (S.REFPRODSIMFK = :SFK OR S.CODPROD=:IRET) AND NOT S.REFPRODSIM=:SSIMMASTER
      AND S.CODEMP=:CODEMP AND S.CODFILIAL=:CODFILIAL INTO
      CORIG,SSIM,SFK,ICODFOR,SRAZFOR,NPRECO,IRET,SRET DO
    BEGIN
      SUSPEND;
    END
  END

  FOR SELECT 'C',C.REFPRODFOR,C.CODFOR,F.RAZFOR,CAST(NULL AS NUMERIC(15, 5)),
    P.CODPROD,(SELECT P.REFPROD FROM EQPRODUTO P WHERE P.CODPROD=C.CODPROD
    AND P.CODEMP=C.CODEMP AND P.CODFILIAL=C.CODFILIAL)
    FROM CPPRODFOR C, EQPRODUTO P, CPFORNECED F
    WHERE (C.CODPROD = :IPROD OR C.REFPRODFOR = :SBUSCA)
    AND C.CODEMP=:CODEMP AND C.CODFILIAL=:CODFILIAL AND P.CODEMP=C.CODEMP
    AND P.CODFILIAL=C.CODFILIAL AND P.CODPROD=C.CODPROD
    AND F.CODEMP=C.CODEMP AND F.CODFILIAL=C.CODFILIAL
    AND F.CODFOR=C.CODFOR
    UNION
    SELECT 'T',T.REFPRODTFOR,T.CODFOR,F.RAZFOR,T.PRECOPRODTFOR,
    (SELECT P.CODPROD FROM EQPRODUTO P WHERE P.CODEMP=T.CODEMPPD
    AND P.CODFILIAL=T.CODFILIALPD AND P.CODPROD=T.CODPROD),
    (SELECT P.REFPROD FROM EQPRODUTO P WHERE P.CODPROD=T.CODPROD
    AND P.CODEMP=T.CODEMP AND P.CODFILIAL=T.CODFILIAL)
    FROM CPTABFOR T, CPFORNECED F
    WHERE T.REFPRODTFOR = :SBUSCA AND T.CODEMP=:CODEMP
    AND T.CODFILIAL=:CODFILIAL AND F.CODEMP=T.CODEMP
    AND F.CODFILIAL=T.CODFILIAL AND F.CODFOR=T.CODFOR INTO
    CORIG,SSIM,ICODFOR,SRAZFOR,NPRECO,SRET,IRET DO
  BEGIN
    SUSPEND;
  END */
END
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "EQMOVPROD"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODMOVPROD" INTEGER NOT NULL,
"CODEMPPD" INTEGER NOT NULL,
"CODFILIALPD" SMALLINT NOT NULL,
"CODPROD" INTEGER NOT NULL,
"CODEMPVD" INTEGER,
"CODFILIALVD" SMALLINT,
"TIPOVENDA" CHAR(1) CHARACTER SET NONE,
"CODVENDA" INTEGER,
"CODITVENDA" INTEGER,
"CODEMPLE" INTEGER,
"CODFILIALLE" SMALLINT,
"CODLOTE" CHAR(13) CHARACTER SET NONE,
"CODEMPTM" INTEGER NOT NULL,
"CODFILIALTM" SMALLINT NOT NULL,
"CODTIPOMOV" INTEGER NOT NULL,
"CODEMPCP" INTEGER,
"CODFILIALCP" SMALLINT,
"CODCOMPRA" INTEGER,
"CODITCOMPRA" INTEGER,
"CODEMPIV" INTEGER,
"CODFILIALIV" SMALLINT,
"CODINVPROD" INTEGER,
"DTMOVPROD" DATE NOT NULL,
"TIPOMOVPROD" CHAR(1) CHARACTER SET NONE NOT NULL,
"ESTOQMOVPROD" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL,
"CODEMPAX" INTEGER NOT NULL,
"CODFILIALAX" SMALLINT NOT NULL,
"CODALMOX" INTEGER NOT NULL,
"QTDMOVPROD" "NUMERICDN" NOT NULL,
"PRECOMOVPROD" "NUMERICDN",
"CUSTOMPMMOVPROD" "NUMERICDN" DEFAULT 0,
"CUSTOMPMMOVPRODAX" "NUMERICDN",
"SLDMOVPROD" "NUMERICDN",
"SLDMOVPRODAX" "NUMERICDN",
"FLAG" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"CODEMPNT" INTEGER,
"CODFILIALNT" SMALLINT,
"CODNAT" CHAR(4) CHARACTER SET NONE,
"DOCMOVPROD" INTEGER,
"CODEMPRM" INTEGER,
"CODFILIALRM" SMALLINT,
"CODRMA" INTEGER,
"CODITRMA" SMALLINT,
"EMMANUT" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"CODEMPOP" INTEGER,
"CODFILIALOP" SMALLINT,
"CODOP" INTEGER,
"SEQOP" SMALLINT);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQCALCPEPSSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODPROD" INTEGER,
"NSLDPROD" NUMERIC(15,5),
"DTESTOQ" DATE,
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER)
 RETURNS("NCUSTOPEPS" NUMERIC(15,5))
 AS
DECLARE VARIABLE DTTEMP DATE;
DECLARE VARIABLE NCUSTO NUMERIC(15,5);
DECLARE VARIABLE NQTD NUMERIC(15,5);
DECLARE VARIABLE NRESTO NUMERIC(15,5);
DECLARE VARIABLE NCUSTOTOT NUMERIC(15,5);
DECLARE VARIABLE NSLDTMP NUMERIC(15,5);
begin
  /* Procedure que retorna o clculo do custo peps */
  NCUSTO = 0;
  NCUSTOTOT = 0;
  NRESTO = 0;
  NCUSTOPEPS = 0;
  IF ( (NSLDPROD IS NOT NULL) AND (NSLDPROD != 0) ) THEN
  BEGIN
      NSLDTMP = NSLDPROD;
      FOR SELECT MP.DTMOVPROD,MP.QTDMOVPROD,MP.PRECOMOVPROD
        FROM EQMOVPROD MP, EQTIPOMOV TM
         WHERE MP.CODEMPPD=:ICODEMP AND MP.CODFILIALPD=:SCODFILIAL AND MP.CODPROD=:ICODPROD AND
           MP.CODEMPTM=TM.CODEMP AND MP.CODFILIALTM=TM.CODFILIAL AND MP.CODTIPOMOV=TM.CODTIPOMOV AND
           MP.TIPOMOVPROD IN ('E','I') AND TM.TIPOMOV IN ('IV','CP','PC') AND
           MP.DTMOVPROD<=:DTESTOQ  AND
           ( (:ICODALMOX IS NULL) OR
             (MP.CODEMPAX=:ICODEMPAX AND MP.CODFILIALAX=:SCODFILIALAX AND
             MP.CODALMOX=:ICODALMOX)
           )
         ORDER BY MP.DTMOVPROD DESC, MP.CODMOVPROD DESC
         INTO :DTTEMP,:NQTD,:NCUSTO DO
      BEGIN
         IF (NQTD IS NULL) THEN
            NQTD = 0;
         IF ( (NCUSTO IS NULL) ) THEN
            NCUSTO = 0;
         NRESTO = NSLDTMP - NQTD;
         IF (NRESTO<=0) THEN
         BEGIN
           NCUSTOTOT = NCUSTOTOT + (NCUSTO * (NQTD+NRESTO) );
           BREAK;
         END
         ELSE
         BEGIN
           NCUSTOTOT = NCUSTOTOT + (NCUSTO * NQTD);
           NSLDTMP = NSLDTMP - NQTD;
         END
      END
      NCUSTOPEPS = NCUSTOTOT / NSLDPROD;
  END
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "VDFOTOPROD"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODPROD" INTEGER NOT NULL,
"CODFOTOPROD" INTEGER NOT NULL,
"DESCFOTOPROD" CHAR(40) CHARACTER SET NONE NOT NULL,
"TIPOFOTOPROD" CHAR(1) CHARACTER SET NONE NOT NULL,
"LARGFOTOPROD" INTEGER NOT NULL,
"ALTFOTOPROD" INTEGER NOT NULL,
"FOTOPROD" BLOB SEGMENT SIZE 50 NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
CREATE TABLE "CPPRODFOR"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODPROD" INTEGER NOT NULL,
"CODFOR" INTEGER NOT NULL,
"REFPRODFOR" CHAR(21) CHARACTER SET NONE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
CREATE TABLE "EQFATCONV"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODPROD" INTEGER NOT NULL,
"CODUNID" CHAR(8) CHARACTER SET NONE NOT NULL,
"FATCONV" NUMERIC(10,3) NOT NULL,
"CPFATCONV" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQCOPIAPROD"("ICODPROD" INTEGER,
"ICODEMP" INTEGER,
"ICODFILIAL" INTEGER)
 RETURNS("ICOD" INTEGER)
 AS
DECLARE VARIABLE INOVOCOD INTEGER;
BEGIN
  SELECT MAX(CODPROD)+1 FROM EQPRODUTO
    WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO INOVOCOD;
  INSERT INTO EQPRODUTO
      (CODPROD,CODEMP,CODFILIAL,DESCPROD,REFPROD,CODEMPAX,
      CODFILIALAX,CODALMOX,CODEMPMA,CODFILIALMA,CODMOEDA,CODEMPUD,
      CODFILIALUD,CODUNID,CODEMPFC,CODFILIALFC,CODFISC,CODEMPMC,
      CODFILIALMC,CODMARCA,DESCAUXPROD,TIPOPROD,CVPROD,CODEMPGP,
      CODFILIALGP,CODGRUP,CODBARPROD,CLOTEPROD,CODFABPROD,
      COMISPROD,PESOLIQPROD,PESOBRUTPROD,QTDMINPROD,QTDMAXPROD,
      PRECOBASEPROD,ATIVOPROD,DESCCOMPPROD)
    SELECT :INOVOCOD,:ICODEMP,:ICODFILIAL,DESCPROD,:INOVOCOD,CODEMPAX,
      CODFILIALAX,CODALMOX,CODEMPMA,CODFILIALMA,CODMOEDA,CODEMPUD,
      CODFILIALUD,CODUNID,CODEMPFC,CODFILIALFC,CODFISC,CODEMPMC,
      CODFILIALMC,CODMARCA,DESCAUXPROD,TIPOPROD,CVPROD,CODEMPGP,
      CODFILIALGP,CODGRUP,CODBARPROD,CLOTEPROD,CODFABPROD,COMISPROD,
      PESOLIQPROD,PESOBRUTPROD,QTDMINPROD,QTDMAXPROD,PRECOBASEPROD,
      ATIVOPROD,DESCCOMPPROD FROM
      EQPRODUTO WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL AND
      CODPROD=:ICODPROD;

    INSERT INTO VDPRECOPROD (CODEMP,CODFILIAL,CODPROD,CODPRECOPROD,
        CODEMPTB,CODFILIALTB,CODTAB,CODEMPCC,CODFILIALCC,CODCLASCLI,
        CODEMPPG,CODFILIALPG,CODPLANOPAG,PRECOPROD)
      SELECT CODEMP,CODFILIAL,:INOVOCOD,CODPRECOPROD,
        CODEMPTB,CODFILIALTB,CODTAB,CODEMPCC,CODFILIALCC,CODCLASCLI,
        CODEMPPG,CODFILIALPG,CODPLANOPAG,PRECOPROD FROM VDPRECOPROD
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL AND
          CODPROD=:ICODPROD;

    INSERT INTO EQFATCONV (CODEMP,CODFILIAL,CODPROD,CODUNID,FATCONV)
      SELECT CODEMP,CODFILIAL,:INOVOCOD,CODUNID,FATCONV FROM EQFATCONV
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL AND CODPROD=:ICODPROD;

    INSERT INTO CPPRODFOR (CODEMP,CODFILIAL,CODPROD,CODFOR,REFPRODFOR)
      SELECT CODEMP,CODFILIAL,:INOVOCOD,CODFOR,REFPRODFOR FROM CPPRODFOR
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL AND CODPROD=:ICODPROD;
        
    /* se for outro produto o lote provavelmente ser outro tambm */
    /*INSERT INTO EQLOTE (CODEMP,CODFILIAL,CODPROD,CODLOTE,VENCTOLOTE,
        SLDLOTE,SLDRESLOTE,SLDCONSIGLOTE,SLDLIQLOTE,DINILOTE)
      SELECT CODEMP,CODFILIAL,:INOVOCOD,CODLOTE,VENCTOLOTE,
        SLDLOTE,SLDRESLOTE,SLDCONSIGLOTE,SLDLIQLOTE,DINILOTE FROM EQLOTE
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL AND CODPROD=:ICODPROD;*/
        
    INSERT INTO VDFOTOPROD (CODEMP,CODFILIAL,CODPROD,CODFOTOPROD,DESCFOTOPROD,
        TIPOFOTOPROD,LARGFOTOPROD,ALTFOTOPROD,FOTOPROD)
      SELECT CODEMP,CODFILIAL,:INOVOCOD,CODFOTOPROD,DESCFOTOPROD,
        TIPOFOTOPROD,LARGFOTOPROD,ALTFOTOPROD,FOTOPROD FROM VDFOTOPROD
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL AND CODPROD=:ICODPROD;
   ICOD = INOVOCOD;
   SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQCUSTOPRODSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODPROD" INTEGER,
"DTESTOQ" DATE,
"CTIPOCUSTO" CHAR(1) CHARACTER SET NONE,
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER,
"CCOMSALDO" CHAR(10) CHARACTER SET NONE)
 RETURNS("SLDPROD" NUMERIC(15,5),
"CUSTOUNIT" NUMERIC(15,5),
"CUSTOTOT" NUMERIC(15,5))
 AS
DECLARE VARIABLE PRECOBASE NUMERIC(15,5);
DECLARE VARIABLE CUSTOMPM NUMERIC(15,5);
begin
  /* Retorna o custo unitrio do produto */
  IF (CTIPOCUSTO IS NULL) then
     CTIPOCUSTO = 'P';

  SELECT P.PRECOBASEPROD,
     (SELECT FIRST 1 M.SLDMOVPROD
     FROM EQMOVPROD M
     WHERE M.CODEMPPD=P.CODEMP AND
           M.CODFILIAL=P.CODFILIAL AND
           M.CODPROD=P.CODPROD AND
           M.DTMOVPROD<=:DTESTOQ
     ORDER BY P.CODPROD, M.DTMOVPROD DESC , M.CODMOVPROD DESC
     ) ,
     (SELECT FIRST 1 M.CUSTOMPMMOVPROD
     FROM EQMOVPROD M
     WHERE M.CODEMPPD=P.CODEMP AND
           M.CODFILIAL=P.CODFILIAL AND
           M.CODPROD=P.CODPROD AND
           M.DTMOVPROD<=:DTESTOQ
     ORDER BY P.CODPROD, M.DTMOVPROD DESC , M.CODMOVPROD DESC
     )
   FROM EQPRODUTO P
   WHERE P.CODEMP = :ICODEMP AND P.CODFILIAL = :SCODFILIAL AND
      P.CODPROD=:ICODPROD
   INTO :PRECOBASE, :SLDPROD, :CUSTOMPM;

  CUSTOUNIT = 0;
  CUSTOTOT = 0;
  IF (SLDPROD IS NULL) THEN
        SLDPROD = 0;
  IF ( (SLDPROD!=0) OR (CCOMSALDO!='S') ) THEN
  BEGIN
      IF (CTIPOCUSTO='P') THEN
      BEGIN
         SELECT NCUSTOPEPS FROM EQCALCPEPSSP(:ICODEMP,:SCODFILIAL,:ICODPROD,
            :SLDPROD,:DTESTOQ, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX)
            INTO :CUSTOUNIT;
         IF (CUSTOUNIT!=0) THEN
            CUSTOTOT = CUSTOUNIT*SLDPROD;
      END
      ELSE IF (CTIPOCUSTO='M') THEN
      BEGIN
         CUSTOUNIT = CUSTOMPM;
         IF (CUSTOUNIT IS NULL) THEN
            CUSTOUNIT = 0;
          CUSTOTOT = CUSTOUNIT*SLDPROD;
      END
      ELSE IF (CTIPOCUSTO='B') THEN
      BEGIN
         CUSTOUNIT = PRECOBASE;
         IF (CUSTOUNIT IS NULL) THEN
            CUSTOUNIT = 0;
          CUSTOTOT = CUSTOUNIT*SLDPROD;
      END
  END
  SUSPEND;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "PPITOP"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODOP" INTEGER NOT NULL,
"SEQOP" SMALLINT DEFAULT 0 NOT NULL,
"SEQITOP" SMALLINT NOT NULL,
"CODEMPPD" INTEGER NOT NULL,
"CODFILIALPD" SMALLINT NOT NULL,
"CODPROD" INTEGER NOT NULL,
"QTDITOP" "NUMERICDN" DEFAULT 0 NOT NULL,
"CODEMPFS" INTEGER NOT NULL,
"CODFILIALFS" SMALLINT NOT NULL,
"CODFASE" INTEGER NOT NULL,
"CODEMPLE" INTEGER,
"CODFILIALLE" SMALLINT,
"CODLOTE" CHAR(13) CHARACTER SET NONE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"REFPROD" CHAR(13) CHARACTER SET NONE NOT NULL,
"GERARMA" CHAR(1) CHARACTER SET NONE NOT NULL,
"QTDCOPIAITOP" "NUMERICDN",
"CODLOTERAT" CHAR(13) CHARACTER SET NONE);
COMMIT WORK;
CREATE TABLE "EQITRMA"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODRMA" INTEGER NOT NULL,
"CODITRMA" SMALLINT NOT NULL,
"CODEMPPD" INTEGER NOT NULL,
"CODFILIALPD" SMALLINT NOT NULL,
"CODPROD" INTEGER NOT NULL,
"QTDITRMA" "NUMERICDN" NOT NULL,
"SITITRMA" CHAR(2) CHARACTER SET NONE DEFAULT 'PE' NOT NULL,
"CODEMPAX" INTEGER NOT NULL,
"CODFILIALAX" SMALLINT NOT NULL,
"CODALMOX" INTEGER,
"QTDAPROVITRMA" "NUMERICDN" DEFAULT 0 NOT NULL,
"QTDEXPITRMA" "NUMERICDN" DEFAULT 0 NOT NULL,
"CODEMPLE" INTEGER,
"CODFILIALLE" SMALLINT,
"CODLOTE" CHAR(13) CHARACTER SET NONE,
"REFPROD" CHAR(13) CHARACTER SET NONE NOT NULL,
"DTAPROVITRMA" DATE,
"DTAEXPITRMA" DATE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"PRECOITRMA" "NUMERICDN" DEFAULT 0 NOT NULL,
"SITAPROVITRMA" CHAR(2) CHARACTER SET NONE DEFAULT 'PE' NOT NULL,
"SITEXPITRMA" CHAR(2) CHARACTER SET NONE DEFAULT 'PE' NOT NULL,
"MOTIVOCANCITRMA" VARCHAR(10000) CHARACTER SET NONE,
"PRIORITRMA" CHAR(1) CHARACTER SET NONE DEFAULT 'B' NOT NULL,
"MOTIVOPRIORITRMA" VARCHAR(10000) CHARACTER SET NONE);
COMMIT WORK;
CREATE TABLE "EQRMA"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODRMA" INTEGER NOT NULL,
"IDUSU" CHAR(8) CHARACTER SET NONE NOT NULL,
"CODEMPTM" INTEGER NOT NULL,
"CODFILIALTM" SMALLINT NOT NULL,
"CODTIPOMOV" INTEGER NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"MOTIVORMA" VARCHAR(10000) CHARACTER SET NONE,
"MOTIVOCANCRMA" VARCHAR(10000) CHARACTER SET NONE,
"SITRMA" CHAR(2) CHARACTER SET NONE DEFAULT 'PE' NOT NULL,
"CODEMPCC" INTEGER NOT NULL,
"CODFILIALCC" SMALLINT NOT NULL,
"ANOCC" SMALLINT NOT NULL,
"CODCC" CHAR(19) CHARACTER SET NONE NOT NULL,
"CODEMPUU" INTEGER NOT NULL,
"CODFILIALUU" SMALLINT NOT NULL,
"DTAREQRMA" DATE DEFAULT 'today' NOT NULL,
"DTAEXPRMA" DATE,
"SITAPROVRMA" CHAR(2) CHARACTER SET NONE DEFAULT 'PE' NOT NULL,
"SITEXPRMA" CHAR(2) CHARACTER SET NONE DEFAULT 'PE' NOT NULL,
"IDUSUAPROV" CHAR(8) CHARACTER SET NONE,
"CODEMPUA" INTEGER,
"CODFILIALUA" SMALLINT,
"IDUSUEXP" CHAR(8) CHARACTER SET NONE,
"CODEMPUE" INTEGER,
"CODFILIALUE" SMALLINT,
"DTAAPROVRMA" DATE,
"CODEMPOF" INTEGER,
"CODFILIALOF" SMALLINT,
"CODOP" INTEGER,
"SEQOP" SMALLINT,
"SEQOF" SMALLINT);
COMMIT WORK;
CREATE TABLE "PPOPFASE"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODOP" INTEGER NOT NULL,
"SEQOP" SMALLINT DEFAULT 0 NOT NULL,
"SEQOF" SMALLINT NOT NULL,
"CODEMPFS" INTEGER NOT NULL,
"CODFILIALFS" SMALLINT NOT NULL,
"CODFASE" INTEGER NOT NULL,
"CODEMPRP" INTEGER NOT NULL,
"CODFILIALRP" SMALLINT NOT NULL,
"CODRECP" INTEGER NOT NULL,
"TEMPOOF" "NUMERICDN" DEFAULT 0 NOT NULL,
"CODEMPTR" INTEGER NOT NULL,
"CODFILIALTR" SMALLINT NOT NULL,
"CODTPREC" INTEGER NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"DATAINIPRODFS" DATE,
"HINIPRODFS" TIME,
"DATAFIMPRODFS" DATE,
"HFIMPRODFS" TIME,
"OBSFS" VARCHAR(500) CHARACTER SET NONE,
"SITFS" CHAR(2) CHARACTER SET NONE DEFAULT 'PE');
COMMIT WORK;
CREATE TABLE "SGPREFERE5"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" INTEGER NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"CLASSOP" CHAR(20) CHARACTER SET NONE,
"NOMERESP" CHAR(50) CHARACTER SET NONE,
"IDENTPROFRESP" CHAR(30) CHARACTER SET NONE,
"CARGORESP" CHAR(30) CHARACTER SET NONE,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"CODTIPOMOV" INTEGER,
"CODEMPTM" SMALLINT,
"CODFILIALTM" SMALLINT,
"SITRMAOP" CHAR(2) CHARACTER SET NONE DEFAULT 'PE');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQGERARMASP"("CODEMPOP" INTEGER,
"CODFILIALOP" INTEGER,
"CODOP" INTEGER,
"SEQOP" SMALLINT)
 AS
DECLARE VARIABLE SEQOF SMALLINT;
DECLARE VARIABLE IDUSU1 CHAR(8);
DECLARE VARIABLE SEQITOP INTEGER;
DECLARE VARIABLE CODITRMA INTEGER;
DECLARE VARIABLE REFPROD CHAR(13);
DECLARE VARIABLE CODRMA INTEGER;
DECLARE VARIABLE CODTIPOMOV1 INTEGER;
DECLARE VARIABLE CODCCUSU1 CHAR(19);
DECLARE VARIABLE CODFILIALCCUSU1 SMALLINT;
DECLARE VARIABLE CODFILIALPD SMALLINT;
DECLARE VARIABLE CODFILIALTM1 SMALLINT;
DECLARE VARIABLE CODPROD INTEGER;
DECLARE VARIABLE CODFILIALLE SMALLINT;
DECLARE VARIABLE CUSTOMPMIT NUMERIC(15,5);
DECLARE VARIABLE CODLOTE CHAR(13);
DECLARE VARIABLE CODALMOX INTEGER;
DECLARE VARIABLE QTD NUMERIC(15,2);
DECLARE VARIABLE CODFILIALAX SMALLINT;
DECLARE VARIABLE CODFILIALUSU1 SMALLINT;
DECLARE VARIABLE ANOCCUSU1 SMALLINT;
DECLARE VARIABLE STATUSAPROVRMAGER CHAR(2) = 'PE';
DECLARE VARIABLE STATUSRMAGER CHAR(2);
DECLARE VARIABLE CODFILIALFASE SMALLINT;
DECLARE VARIABLE QTDAPROV NUMERIC(15,5) = 0;
DECLARE VARIABLE CODFASE INTEGER;
begin
  select codfilialusu,codfilialccusu,codccusu,anoccusu,idusus
         from sgretinfousu(user) into
         :CODFILIALUSU1,:CODFILIALCCUSU1,:CODCCUSU1,:ANOCCUSU1,:IDUSU1;
  select codfilialt8,codtipomov8 from sgprefere1
  where codemp=:CODEMPOP and codfilial=
  (select icodfilial from sgretfilial(:CODEMPOP, 'SGPREFERE1'))
  into :CODFILIALTM1,:CODTIPOMOV1;

  select coalesce(SITRMAOP,'PE') from sgprefere5 where codemp=:CODEMPOP and
  codfilial=(select icodfilial from sgretfilial(:CODEMPOP,'SGPREFERE5'))
   into :STATUSRMAGER;

  QTDAPROV = 0;
  STATUSAPROVRMAGER = 'PE';

  for select codfilialfs,codfase,seqof from ppopfase opf
      where opf.codemp=:CODEMPOP and opf.codfilial=:CODFILIALOP and
      opf.codop=:CODOP and  opf.seqop=:SEQOP and
      (select count(1) from ppitop it
      where it.codemp=:CODEMPOP and it.codfilial=:CODFILIALOP and
      it.codempfs=opf.codempfs and it.codfilialfs=opf.codfilialfs and
      it.codfase=opf.codfase and it.gerarma='S' and
      it.codop=:CODOP and it.seqop=:SEQOP) > 0
      into :codfilialfase,:codfase,:SEQOF do
  begin
  select coalesce((max(codrma)+1),1) from
     eqrma where codemp=:CODEMPOP and codfilial=:CODFILIALOP into :CODRMA;

  insert into eqrma (codemp,codfilial,codrma,
                     codempuu,codfilialuu,idusu,
                     codempua,codfilialua,idusuaprov,
                     codempue,codfilialue,idusuexp,
                     codemptm,codfilialtm,codtipomov,
                     codempcc,codfilialcc,anocc,codcc,
                     dtareqrma,dtaaprovrma,dtaexprma,
                     sitrma,sitaprovrma,sitexprma,
                     codempof,codfilialof,codop,seqop,seqof,
                     motivorma)
                     values
                     (:CODEMPOP,(SELECT ICODFILIAL FROM sgretfilial(:CODEMPOP,'EQRMA')),:CODRMA,
                      :CODEMPOP, :CODFILIALUSU1,:IDUSU1,
                      null,null,null,
                      null,null,null,
                      :CODEMPOP,(SELECT ICODFILIAL FROM sgretfilial(:CODEMPOP,'EQTIPOMOV')),
                      :CODTIPOMOV1,
                      :CODEMPOP,:CODFILIALCCUSU1,:ANOCCUSU1,:CODCCUSU1,
                      cast('now' AS DATE),null,null,
                      :STATUSRMAGER,:STATUSAPROVRMAGER,'PE',
                      :CODEMPOP,:CODFILIALOP,:CODOP,:SEQOP,:SEQOF,
                      'REQUISIO GERADA PARA ATENDIMENTO  OP:'||:CODOP||' SEQ:'||:SEQOP||' - FASE:'||:CODFASE
                     );
    for select it.seqitop,it.codfilialpd,it.codprod,it.refprod,it.qtditop,it.codfilialle,it.codlote,
        (SELECT coalesce(CUSTOMPMPROD,0) FROM EQPRODUTO WHERE CODEMP=it.codemppd and
        codfilial=it.codfilialpd and codprod=it.codprod),
        (SELECT CODFILIALAX FROM EQPRODUTO WHERE CODEMP=it.codemppd and
        codfilial=it.codfilialpd and codprod=it.codprod),
        (SELECT CODALMOX FROM EQPRODUTO WHERE CODEMP=it.codemppd and
        codfilial=it.codfilialpd and codprod=it.codprod)
        from ppitop it
        where it.codemp=:CODEMPOP and it.codfilial=:CODFILIALOP and
           it.codop=:CODOP and it.seqop=:SEQOP and it.codempfs=:CODEMPOP
            and it.codfilialfs=:CODFILIALFASE
            and it.codfase = :CODFASE and it.gerarma='S'
            into :SEQITOP, :CODFILIALPD,:CODPROD,:REFPROD,:QTD,
            :CODFILIALLE,:CODLOTE,:CUSTOMPMIT,:CODFILIALAX,:CODALMOX  DO
    begin
       select coalesce((max(coditrma)+1),1) from eqitrma
       where codemp=:CODEMPOP and codfilial=:CODFILIALOP and
       codrma=:CODRMA into :coditrma;

       if(:STATUSRMAGER='AF')then
       begin
         STATUSAPROVRMAGER = 'AT';
         QTDAPROV = :QTD;
       end

       insert into eqitrma (CODEMP,CODFILIAL,CODRMA,CODITRMA,
                            CODEMPPD,CODFILIALPD,CODPROD,REFPROD,
                            QTDITRMA,QTDAPROVITRMA,QTDEXPITRMA,PRECOITRMA,
                            CODEMPLE,CODFILIALLE,CODLOTE,
                            CODEMPAX,CODFILIALAX,CODALMOX,
                            SITITRMA,SITAPROVITRMA,SITEXPITRMA
                            )
                            values
                            (:CODEMPOP,(SELECT ICODFILIAL FROM sgretfilial(:CODEMPOP,'EQITRMA')),:CODRMA,
                            :coditrma,
                            :CODEMPOP,(SELECT ICODFILIAL FROM sgretfilial(:CODEMPOP,'EQPRODUTO')),
                            :CODPROD,:REFPROD,:QTD,:QTDAPROV,0,:CUSTOMPMIT,:CODEMPOP,(SELECT ICODFILIAL FROM sgretfilial(:CODEMPOP,'EQLOTE')),:CODLOTE,
                            :CODEMPOP,:CODFILIALAX,:CODALMOX,
                            :STATUSRMAGER,:STATUSAPROVRMAGER,'PE'
                            );

        update ppitop it set it.gerarma='N' where it.CODEMP=:CODEMPOP AND
            it.CODFILIAL=:CODFILIALOP AND
            it.codop=:CODOP and it.seqop=:SEQOP and it.seqitop=:seqitop;

   end
  end
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQMOVPRODATEQSP"("ICODEMPPD" INTEGER,
"SCODFILIALPD" SMALLINT,
"ICODPROD" INTEGER,
"ICODEMPLEOLD" INTEGER,
"SCODFILIALLEOLD" SMALLINT,
"CCODLOTEOLD" CHAR(13) CHARACTER SET NONE,
"ICODEMPLENEW" INTEGER,
"SCODFILIALLENEW" SMALLINT,
"CCODLOTENEW" CHAR(13) CHARACTER SET NONE,
"SOPERADOR" SMALLINT,
"NQTDMOVPRODOLD" NUMERIC(15,5),
"NQTDMOVPRODNEW" NUMERIC(15,5),
"ICODEMPAXOLD" INTEGER,
"SCODFILIALAXOLD" SMALLINT,
"ICODALMOXOLD" INTEGER,
"ICODEMPAXNEW" INTEGER,
"SCODFILIALAXNEW" SMALLINT,
"ICODALMOXNEW" INTEGER)
 AS
DECLARE VARIABLE CCLOTEPROD CHAR(1);
DECLARE VARIABLE ICODALMOX INTEGER;
DECLARE VARIABLE ICODEMPAX INTEGER;
DECLARE VARIABLE SCODFILIALAX SMALLINT;
begin
  /* Procedure de atualizao do estoque */
  UPDATE EQPRODUTO SET SLDPROD = SLDPROD+((:NQTDMOVPRODNEW-:NQTDMOVPRODOLD)*:SOPERADOR)
            WHERE CODPROD=:ICODPROD AND CODEMP=:ICODEMPPD AND CODFILIAL=:SCODFILIALPD;

  SELECT CLOTEPROD, CODALMOX,CODEMPAX,CODFILIALAX FROM EQPRODUTO
     WHERE CODPROD = :ICODPROD AND CODEMP=:ICODEMPPD AND CODFILIAL = :SCODFILIALPD
      INTO :CCLOTEPROD, :ICODALMOX, :ICODEMPAX, :SCODFILIALAX;

  EXECUTE PROCEDURE EQSALDOPRODATEQSP(:ICODEMPPD, :SCODFILIALPD, :ICODPROD, :SOPERADOR,
   :NQTDMOVPRODOLD, :NQTDMOVPRODNEW, :ICODEMPAXOLD, :SCODFILIALAXOLD, :ICODALMOXOLD,
   :ICODEMPAXNEW, :SCODFILIALAXNEW, :ICODALMOXNEW);

  IF (CCLOTEPROD = 'S') THEN
  BEGIN
    IF (CCODLOTENEW IS NULL) THEN
    BEGIN
      EXCEPTION EQPRODUTOEX01 'ESTE MOVIMENTO PRECISA DE UM LOTE!';
    END
    ELSE
    BEGIN
       EXECUTE PROCEDURE EQSALDOLOTEATEQSP(:ICODEMPLEOLD, :SCODFILIALLEOLD, :ICODPROD, :CCODLOTEOLD,
          :ICODEMPLENEW, :SCODFILIALLENEW, :CCODLOTENEW, :SOPERADOR, :NQTDMOVPRODOLD, :NQTDMOVPRODNEW,
          :ICODEMPAXOLD, :SCODFILIALAXOLD, :ICODALMOXOLD, :ICODEMPAXNEW, :SCODFILIALAXNEW, :ICODALMOXNEW);
    END
  END

  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQMOVPRODCKCPSP"("ICODEMPPD" INTEGER,
"SCODFILIALPD" SMALLINT,
"ICODPROD" INTEGER,
"ICODCOMPRA" INTEGER,
"ICODINVPROD" INTEGER,
"DDTMOVPROD" DATE,
"NQTDMOVPROD" NUMERIC(15,5),
"NCUSTOMPMMOVPROD" NUMERIC(15,5))
 RETURNS("DDTULTCPPROD" DATE,
"NQTDULTCPPROD" NUMERIC(15,5),
"DDTMPMPROD" DATE,
"NCUSTOMPMPROD" NUMERIC(15,5))
 AS
begin
  /* Procedure para checar data da ltima compra */
  NCUSTOMPMPROD = 0;
  if (NCUSTOMPMMOVPROD IS NULL) then
     NCUSTOMPMMOVPROD = 0;
  if ( (ICODINVPROD IS NOT NULL) OR (ICODCOMPRA IS NOT NULL) ) then
  begin
     SELECT DTULTCPPROD,QTDULTCPPROD,DTMPMPROD, CUSTOMPMPROD FROM EQPRODUTO WHERE CODPROD=:ICODPROD
          AND CODEMP=:ICODEMPPD AND CODFILIAL = :SCODFILIALPD
          INTO :DDTULTCPPROD, :NQTDULTCPPROD, :DDTMPMPROD, :NCUSTOMPMPROD;
      if (NQTDULTCPPROD IS NULL) then
         NQTDULTCPPROD = 0;
      if (NCUSTOMPMPROD IS NULL) then
         NCUSTOMPMPROD = 0;
      if ( ICODCOMPRA IS NOT NULL ) then
      begin
         if ( (DDTMOVPROD>DDTULTCPPROD) OR (DDTULTCPPROD IS NULL) ) then
         begin
             DDTULTCPPROD = DDTMOVPROD;
             NQTDULTCPPROD = NQTDMOVPROD;
         end
      end
      if ( ( ICODINVPROD IS NOT NULL) OR (ICODCOMPRA IS NOT NULL) ) then
      begin
         if ( (DDTMOVPROD>=DDTMPMPROD OR DDTMPMPROD IS NULL) AND
              (NCUSTOMPMMOVPROD>0)  ) then
         begin
            DDTMPMPROD = DDTMOVPROD;
            NCUSTOMPMPROD = NCUSTOMPMMOVPROD;
         end
      end
  end


  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQMOVPRODCKTMSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODTIPOMOV" INTEGER)
 RETURNS("CESTIPOMOV" CHAR(1) CHARACTER SET NONE,
"SOPERADOR" SMALLINT)
 AS
DECLARE VARIABLE CESTOQTIPOMOV CHAR(1);
begin
  /* Verifique se  para contar estoque */
  SELECT TM.ESTIPOMOV, TM.ESTOQTIPOMOV FROM EQTIPOMOV TM WHERE TM.CODEMP=:ICODEMP AND
     TM.CODFILIAL = :SCODFILIAL AND TM.CODTIPOMOV = :ICODTIPOMOV
     INTO :CESTIPOMOV, :CESTOQTIPOMOV;
  SOPERADOR = 0;
  if (CESTOQTIPOMOV='S') then
  begin
     if (CESTIPOMOV='S') then
        SOPERADOR = -1;
     else
        SOPERADOR = 1;
  end
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQMOVPRODCKUTMSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODTIPOMOV" INTEGER,
"ICODEMPOLD" INTEGER,
"SCODFILIALOLD" SMALLINT,
"ICODTIPOMOVOLD" INTEGER)
 RETURNS("CALTTM" CHAR(1) CHARACTER SET NONE)
 AS
DECLARE VARIABLE CESTIPOMOV CHAR(1);
DECLARE VARIABLE CESTOQTIPOMOV CHAR(1);
DECLARE VARIABLE CESTIPOMOVOLD CHAR(1);
DECLARE VARIABLE CESTOQTIPOMOVOLD CHAR(1);
begin
  /* Verifica se h alterao no tipo de movimento para reprocessamento de estoque */
  CALTTM = 'N';
  SELECT TM.ESTIPOMOV, TM.ESTOQTIPOMOV FROM EQTIPOMOV TM
     WHERE TM.CODEMP=:ICODEMP AND TM.CODFILIAL=:SCODFILIAL
      AND TM.CODTIPOMOV=:ICODTIPOMOV
     INTO :CESTIPOMOV, :CESTOQTIPOMOV;

  SELECT TM.ESTIPOMOV, TM.ESTOQTIPOMOV FROM EQTIPOMOV TM
     WHERE TM.CODEMP=:ICODEMPOLD AND TM.CODFILIAL=:SCODFILIALOLD
      AND TM.CODTIPOMOV=:ICODTIPOMOVOLD
     INTO :CESTIPOMOVOLD, :CESTOQTIPOMOVOLD;

  if ( (CESTIPOMOV!=CESTIPOMOVOLD) OR (CESTOQTIPOMOV!=CESTOQTIPOMOVOLD) OR
       (CESTIPOMOVOLD IS NULL) OR (CESTOQTIPOMOVOLD IS NULL)  ) then
     CALTTM = 'S';
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQMOVPRODCSLDSP"("ICODEMPTM" INTEGER,
"SCODFILIALTM" SMALLINT,
"ICODTIPOMOV" INTEGER,
"NQTDMOVPROD" NUMERIC(15,5),
"NPRECOMOVPROD" NUMERIC(15,5),
"NCUSTOMPMMOVPROD" NUMERIC(15,5),
"NSLDMOVPROD" NUMERIC(15,5))
 RETURNS("NCUSTOMPM" NUMERIC(15,5),
"NSALDO" NUMERIC(15,5),
"CESTOQMOVPROD" CHAR(1) CHARACTER SET NONE,
"CTIPOMOVPROD" CHAR(1) CHARACTER SET NONE,
"SOPERADOR" SMALLINT)
 AS
begin
  /* Procedure que retorna o clculo de custo e saldo */
  NCUSTOMPM = 0;
  NSALDO = 0;
  SELECT CESTIPOMOV, SOPERADOR
     FROM EQMOVPRODCKTMSP( :ICODEMPTM, :SCODFILIALTM, :ICODTIPOMOV)
     INTO :CTIPOMOVPROD, :SOPERADOR;
  if (SOPERADOR=0) then
  begin
     CESTOQMOVPROD = 'N';
     NSALDO = NSLDMOVPROD;
  end
  else
  begin  /* verifica se  para controlar estoque */
     CESTOQMOVPROD = 'S';
     NSALDO = NSLDMOVPROD + CAST ( (NQTDMOVPROD * SOPERADOR) AS NUMERIC(15, 5) );
  end
  if ( (NSALDO > NSLDMOVPROD) AND (NSALDO > 0) ) then
  begin
    if ( (NSLDMOVPROD * NCUSTOMPMMOVPROD)  < 0) then
       NCUSTOMPM = NPRECOMOVPROD;
    else
       NCUSTOMPM = ( (NSLDMOVPROD * NCUSTOMPMMOVPROD) +
           (NQTDMOVPROD * NPRECOMOVPROD) ) / NSALDO ;
  end
  else
      NCUSTOMPM = NCUSTOMPMMOVPROD;

  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQMOVPRODDSP"("ICODEMPPD" INTEGER,
"SCODFILIALPD" SMALLINT,
"ICODPROD" INTEGER,
"ICODEMPIV" INTEGER,
"SCODFILIALIV" SMALLINT,
"ICODINVPROD" INTEGER,
"ICODEMPCP" INTEGER,
"SCODFILIALCP" SMALLINT,
"ICODCOMPRA" INTEGER,
"SCODITCOMPRA" SMALLINT,
"ICODEMPVD" INTEGER,
"SCODFILIALVD" SMALLINT,
"CTIPOVENDA" CHAR(1) CHARACTER SET NONE,
"ICODVENDA" INTEGER,
"SCODITVENDA" SMALLINT,
"ICODEMPRM" INTEGER,
"SCODFILIALRM" SMALLINT,
"ICODRMA" INTEGER,
"SCODITRMA" SMALLINT,
"ICODEMPOP" INTEGER,
"SCODFILIALOP" SMALLINT,
"ICODOP" INTEGER,
"SSEQOP" SMALLINT,
"DDTMOVPROD" DATE,
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER,
"CMULTIALMOX" CHAR(1) CHARACTER SET NONE)
 AS
DECLARE VARIABLE ICODEMP INTEGER;
DECLARE VARIABLE SCODFILIAL SMALLINT;
DECLARE VARIABLE ICODMOVPROD INTEGER;
DECLARE VARIABLE NSLDMOVPROD NUMERIC(15,5);
DECLARE VARIABLE NCUSTOMPMMOVPROD NUMERIC(15,5);
DECLARE VARIABLE NSLDMOVPRODAX NUMERIC(15,5);
DECLARE VARIABLE NCUSTOMPMMOVPRODAX NUMERIC(15,5);
begin
  /* Procedure de deleo da tabela eqmovprod */
  SELECT ICODEMP, SCODFILIAL, ICODMOVPROD FROM EQMOVPRODRETCODSP(:ICODEMPIV, :SCODFILIALIV, :ICODINVPROD, :ICODEMPCP,
    :SCODFILIALCP, :ICODCOMPRA, :SCODITCOMPRA, :ICODEMPVD, :SCODFILIALVD,
    :CTIPOVENDA, :ICODVENDA, :SCODITVENDA, :ICODEMPRM, :SCODFILIALRM, :ICODRMA,
    :SCODITRMA, :ICODEMPOP,  :SCODFILIALOP,  :ICODOP, :SSEQOP) INTO :ICODEMP, :SCODFILIAL, :ICODMOVPROD;

  SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX FROM EQMOVPRODSLDSP(:ICODEMP, :SCODFILIAL, :ICODMOVPROD,
   :ICODEMPPD, :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, 0, 0,
   :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
     INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX  ;

  /* DELETAR EQMOVPROD */
  DELETE FROM EQMOVPROD WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL
    AND CODMOVPROD=:ICODMOVPROD;

  /* REPROCESSAR ESTOQUE */
  SELECT NSLDPRC, NCUSTOMPMPRC, NSLDPRCAX, NCUSTOMPMPRCAX
    FROM EQMOVPRODPRCSLDSP( :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
      :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, null, :NSLDMOVPROD, :NCUSTOMPMMOVPROD,
      :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX,
      :CMULTIALMOX)
    INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX;

  /* ATUALIZA CUSTO NO CADASTRO DE PRODUTOS
   OPERADOR 1 PARA EFETUAR A ATUALIZAO SEMPRE
  EXECUTE PROCEDURE EQMOVPRODATCUSTSP( 1, :ICODEMP, :SCODFILIAL,
   :ICODMOVPROD,  :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, 0);
   */

  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQMOVPRODISP"("ICODEMPPD" INTEGER,
"SCODFILIALPD" SMALLINT,
"ICODPROD" INTEGER,
"ICODEMPLE" INTEGER,
"SCODFILIALLE" SMALLINT,
"CCODLOTE" CHAR(13) CHARACTER SET NONE,
"ICODEMPTM" INTEGER,
"SCODFILIALTM" SMALLINT,
"ICODTIPOMOV" INTEGER,
"ICODEMPIV" INTEGER,
"SCODFILIALIV" SMALLINT,
"ICODINVPROD" INTEGER,
"ICODEMPCP" INTEGER,
"SCODFILIALCP" SMALLINT,
"ICODCOMPRA" INTEGER,
"SCODITCOMPRA" SMALLINT,
"ICODEMPVD" INTEGER,
"SCODFILIALVD" SMALLINT,
"CTIPOVENDA" CHAR(1) CHARACTER SET NONE,
"ICODVENDA" INTEGER,
"SCODITVENDA" SMALLINT,
"ICODEMPRM" INTEGER,
"SCODFILIALRM" SMALLINT,
"ICODRMA" INTEGER,
"SCODITRMA" SMALLINT,
"ICODEMPOP" INTEGER,
"SCODFILIALOP" SMALLINT,
"ICODOP" INTEGER,
"SSEQOP" SMALLINT,
"ICODEMPNT" INTEGER,
"SCODFILIALNT" SMALLINT,
"CCODNAT" CHAR(4) CHARACTER SET NONE,
"DDTMOVPROD" DATE,
"IDOCMOVPROD" INTEGER,
"CFLAG" CHAR(1) CHARACTER SET NONE,
"NQTDMOVPROD" NUMERIC(15,5),
"NPRECOMOVPROD" NUMERIC(15,5),
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER,
"CMULTIALMOX" CHAR(1) CHARACTER SET NONE)
 AS
DECLARE VARIABLE SCODFILIAL SMALLINT;
DECLARE VARIABLE ICODMOVPROD INTEGER;
DECLARE VARIABLE CESTOQMOVPROD CHAR(1);
DECLARE VARIABLE CTIPOMOVPROD CHAR(1);
DECLARE VARIABLE NSLDMOVPROD NUMERIC(15,5);
DECLARE VARIABLE NCUSTOMPMMOVPROD NUMERIC(15,5);
DECLARE VARIABLE SOPERADOR SMALLINT;
DECLARE VARIABLE NSLDMOVPRODAX NUMERIC(15,5);
DECLARE VARIABLE NCUSTOMPMMOVPRODAX NUMERIC(15,5);
begin
  /* Procedure de insero na tabela eqmovprod */

  SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX FROM EQMOVPRODSLDSP(null, null, null, :ICODEMPPD,
     :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, :NPRECOMOVPROD, :NPRECOMOVPROD,
     :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX )
     INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX ;

  /* Verifica se haver mudana de saldo*/
  SELECT NSALDO, NCUSTOMPM, CESTOQMOVPROD, CTIPOMOVPROD, SOPERADOR FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
      :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPROD)
      INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :CESTOQMOVPROD, :CTIPOMOVPROD, :SOPERADOR;

  if (CMULTIALMOX='N') then
  begin
     NSLDMOVPRODAX = NSLDMOVPROD;
     NCUSTOMPMMOVPRODAX = NCUSTOMPMMOVPROD;
  end
  else
  begin
      SELECT NSALDO, NCUSTOMPM FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
          :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPRODAX, :NSLDMOVPRODAX)
        INTO :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX;
  end

  SELECT SCODFILIAL, ICODMOVPROD FROM EQMOVPRODSEQSP(:ICODEMPPD)
     INTO :SCODFILIAL, :ICODMOVPROD;  /* encontra o prximo cdigo e a filial*/

   INSERT INTO EQMOVPROD ( CODEMP, CODFILIAL, CODMOVPROD,
      CODEMPPD, CODFILIALPD , CODPROD , CODEMPLE ,
      CODFILIALLE , CODLOTE , CODEMPTM, CODFILIALTM,
      CODTIPOMOV, CODEMPIV , CODFILIALIV , CODINVPROD ,
      CODEMPCP , CODFILIALCP , CODCOMPRA , CODITCOMPRA , CODEMPVD ,
      CODFILIALVD , TIPOVENDA , CODVENDA , CODITVENDA , CODEMPRM ,
      CODFILIALRM , CODRMA , CODITRMA ,
      CODEMPOP, CODFILIALOP, CODOP, SEQOP,
      CODEMPNT , CODFILIALNT ,
      CODNAT , DTMOVPROD , DOCMOVPROD , FLAG , QTDMOVPROD ,
      PRECOMOVPROD, ESTOQMOVPROD, TIPOMOVPROD, SLDMOVPROD, CUSTOMPMMOVPROD,
      SLDMOVPRODAX, CUSTOMPMMOVPRODAX, CODEMPAX, CODFILIALAX, CODALMOX )
   VALUES ( :ICODEMPPD, :SCODFILIAL, :ICODMOVPROD,
    :ICODEMPPD , :SCODFILIALPD , :ICODPROD , :ICODEMPLE ,
    :SCODFILIALLE , :CCODLOTE , :ICODEMPTM, :SCODFILIALTM,
    :ICODTIPOMOV, :ICODEMPIV , :SCODFILIALIV ,
    :ICODINVPROD , :ICODEMPCP , :SCODFILIALCP , :ICODCOMPRA ,
    :SCODITCOMPRA , :ICODEMPVD , :SCODFILIALVD , :CTIPOVENDA ,
    :ICODVENDA , :SCODITVENDA , :ICODEMPRM , :SCODFILIALRM ,
    :ICODRMA , :SCODITRMA , :ICODEMPOP, :SCODFILIALOP, :ICODOP, :SSEQOP,
    :ICODEMPNT , :SCODFILIALNT , :CCODNAT ,
    :DDTMOVPROD , :IDOCMOVPROD , :CFLAG , :NQTDMOVPROD ,
    :NPRECOMOVPROD, :CESTOQMOVPROD, :CTIPOMOVPROD, :NSLDMOVPROD, :NCUSTOMPMMOVPROD,
    :NSLDMOVPRODAX,  :NCUSTOMPMMOVPRODAX, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX );

  /* REPROCESSAR ESTOQUE */

  SELECT NSLDPRC, NCUSTOMPMPRC, NSLDPRCAX, NCUSTOMPMPRCAX
    FROM EQMOVPRODPRCSLDSP( :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
     :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, null, :NSLDMOVPROD, :NCUSTOMPMMOVPROD,
     :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX,
     :CMULTIALMOX)
    INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX ;

 /* ATUALIZA O CUSTO NO CADASTRO DE PRODUTOS
   EXECUTE PROCEDURE EQMOVPRODATCUSTSP(:SOPERADOR, :ICODEMPPD, :SCODFILIAL,
    :ICODMOVPROD, :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, :NCUSTOMPMMOVPROD); 
 */


  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQMOVPRODIUDSP"("CIUD" CHAR(1) CHARACTER SET NONE,
"ICODEMPPD" INTEGER,
"SCODFILIALPD" SMALLINT,
"ICODPROD" INTEGER,
"ICODEMPLE" INTEGER,
"SCODFILIALLE" SMALLINT,
"CCODLOTE" CHAR(13) CHARACTER SET NONE,
"ICODEMPTM" INTEGER,
"SCODFILIALTM" SMALLINT,
"ICODTIPOMOV" INTEGER,
"ICODEMPIV" INTEGER,
"SCODFILIALIV" SMALLINT,
"ICODINVPROD" INTEGER,
"ICODEMPCP" INTEGER,
"SCODFILIALCP" SMALLINT,
"ICODCOMPRA" INTEGER,
"SCODITCOMPRA" SMALLINT,
"ICODEMPVD" INTEGER,
"SCODFILIALVD" SMALLINT,
"CTIPOVENDA" CHAR(1) CHARACTER SET NONE,
"ICODVENDA" INTEGER,
"SCODITVENDA" SMALLINT,
"ICODEMPRM" INTEGER,
"SCODFILIALRM" SMALLINT,
"ICODRMA" INTEGER,
"SCODITRMA" SMALLINT,
"ICODEMPOP" INTEGER,
"SCODFILIALOP" SMALLINT,
"ICODOP" INTEGER,
"SSEQOP" SMALLINT,
"ICODEMPNT" INTEGER,
"SCODFILIALNT" SMALLINT,
"CCODNAT" CHAR(4) CHARACTER SET NONE,
"DDTMOVPROD" DATE,
"IDOCMOVPROD" INTEGER,
"CFLAG" CHAR(1) CHARACTER SET NONE,
"NQTDMOVPROD" NUMERIC(15,5),
"NPRECOMOVPROD" NUMERIC(15,5),
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER)
 AS
DECLARE VARIABLE CMULTIALMOX CHAR(1);
begin
  /* Procedure que controle INSERT, UPDATE E DELETE da tabela eqmovprod */

  /* Linha incluida para passar como parmetro se  multi almoxarifado
      Como o objetivo de evitar I/O
  */
  SELECT CMULTIALMOX FROM SGRETMULTIALMOXSP(:ICODEMPPD) INTO :CMULTIALMOX;

  if (CIUD='I') then /* SE FOR INSERT */
     execute procedure EQMOVPRODISP( ICODEMPPD, SCODFILIALPD, ICODPROD,
         ICODEMPLE, SCODFILIALLE, CCODLOTE, ICODEMPTM, SCODFILIALTM, ICODTIPOMOV,
         ICODEMPIV, SCODFILIALIV, ICODINVPROD, ICODEMPCP, SCODFILIALCP, ICODCOMPRA,
         SCODITCOMPRA, ICODEMPVD, SCODFILIALVD, CTIPOVENDA, ICODVENDA, SCODITVENDA,
         ICODEMPRM, SCODFILIALRM, ICODRMA, SCODITRMA,
         ICODEMPOP, SCODFILIALOP, ICODOP, SSEQOP,
         ICODEMPNT, SCODFILIALNT,
         CCODNAT, DDTMOVPROD, IDOCMOVPROD, CFLAG, NQTDMOVPROD, NPRECOMOVPROD,
         ICODEMPAX, SCODFILIALAX, ICODALMOX, CMULTIALMOX);
  else if (CIUD='U') then
     execute procedure EQMOVPRODUSP( ICODEMPPD, SCODFILIALPD, ICODPROD,
         ICODEMPLE, SCODFILIALLE, CCODLOTE, ICODEMPTM, SCODFILIALTM, ICODTIPOMOV,
         ICODEMPIV, SCODFILIALIV, ICODINVPROD, ICODEMPCP, SCODFILIALCP, ICODCOMPRA,
         SCODITCOMPRA, ICODEMPVD, SCODFILIALVD, CTIPOVENDA, ICODVENDA, SCODITVENDA,
         ICODEMPRM, SCODFILIALRM, ICODRMA, SCODITRMA,
         ICODEMPOP, SCODFILIALOP, ICODOP, SSEQOP,
         ICODEMPNT, SCODFILIALNT,
         CCODNAT, DDTMOVPROD, IDOCMOVPROD, CFLAG, NQTDMOVPROD, NPRECOMOVPROD,
         ICODEMPAX, SCODFILIALAX, ICODALMOX, CMULTIALMOX);
  else if (CIUD='D') then
     execute procedure EQMOVPRODDSP( ICODEMPPD, SCODFILIALPD, ICODPROD, ICODEMPIV,
         SCODFILIALIV, ICODINVPROD, ICODEMPCP, SCODFILIALCP, ICODCOMPRA, SCODITCOMPRA,
         ICODEMPVD, SCODFILIALVD, CTIPOVENDA, ICODVENDA, SCODITVENDA,
         ICODEMPRM, SCODFILIALRM, ICODRMA, SCODITRMA,
         ICODEMPOP, SCODFILIALOP, ICODOP, SSEQOP,
         DDTMOVPROD, ICODEMPAX, SCODFILIALAX, ICODALMOX, CMULTIALMOX );
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQMOVPRODPRCSLDSP"("SCODFILIAL" SMALLINT,
"ICODMOVPROD" INTEGER,
"ICODEMPPD" INTEGER,
"SCODFILIALPD" SMALLINT,
"ICODPROD" INTEGER,
"DDTMOVPROD" DATE,
"DDTMOVPRODPRC" DATE,
"NSLDMOVPROD" NUMERIC(15,5),
"NCUSTOMPMMOVPROD" NUMERIC(15,5),
"NSLDMOVPRODAX" NUMERIC(15,5),
"NCUSTOMPMMOVPRODAX" NUMERIC(15,5),
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER,
"CMULTIALMOX" CHAR(1) CHARACTER SET NONE)
 RETURNS("NSLDPRC" NUMERIC(15,5),
"NCUSTOMPMPRC" NUMERIC(15,5),
"NSLDPRCAX" NUMERIC(15,5),
"NCUSTOMPMPRCAX" NUMERIC(15,5))
 AS
DECLARE VARIABLE ICODEMPTM INTEGER;
DECLARE VARIABLE SCODFILIALTM SMALLINT;
DECLARE VARIABLE ICODTIPOMOV INTEGER;
DECLARE VARIABLE NQTDMOVPROD NUMERIC(15,5);
DECLARE VARIABLE NPRECOMOVPROD NUMERIC(15,5);
DECLARE VARIABLE ICODMOVPRODPRC INTEGER;
DECLARE VARIABLE CESTOQMOVPROD CHAR(1);
DECLARE VARIABLE ICODEMPAXPRC INTEGER;
DECLARE VARIABLE SCODFILIALAXPRC SMALLINT;
DECLARE VARIABLE ICODALMOXPRC INTEGER;
begin
  /* Procedure de processamento de estoque */
  FOR SELECT MP.CODEMPTM, MP.CODFILIALTM, MP.CODTIPOMOV ,
    MP.QTDMOVPROD, MP.PRECOMOVPROD , MP.CODMOVPROD,
    MP.CODEMPAX, MP.CODFILIALAX, MP.CODALMOX
    FROM EQMOVPROD MP
    WHERE MP.CODEMPPD=:ICODEMPPD AND MP.CODFILIALPD=:SCODFILIALPD AND
       MP.CODPROD=:ICODPROD AND MP.CODEMP=:ICODEMPPD AND MP.CODFILIAL=:SCODFILIAL AND
       ( (MP.DTMOVPROD = :DDTMOVPROD AND MP.CODMOVPROD > :ICODMOVPROD) OR
         (MP.DTMOVPROD>:DDTMOVPROD) ) AND  /* ALTEREI AQUI */
       ( (:DDTMOVPRODPRC IS NULL /* AND MP.CODMOVPROD!=:ICODMOVPROD */) OR
         (MP.DTMOVPROD = :DDTMOVPRODPRC AND MP.CODMOVPROD < :ICODMOVPROD) OR
         (MP.DTMOVPROD < :DDTMOVPRODPRC) )
    ORDER BY MP.DTMOVPROD, MP.CODMOVPROD
    INTO :ICODEMPTM, :SCODFILIALTM, :ICODTIPOMOV,
     :NQTDMOVPROD, :NPRECOMOVPROD, :ICODMOVPRODPRC,
     :ICODEMPAXPRC, :SCODFILIALAXPRC, :ICODALMOXPRC DO
  BEGIN
      SELECT NSALDO, NCUSTOMPM, CESTOQMOVPROD FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
        :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPROD, :NSLDMOVPROD)
      INTO :NSLDMOVPROD, :NCUSTOMPMMOVPROD, :CESTOQMOVPROD;
      if (CMULTIALMOX='N') then /* Se no for multi almoxarifado*/
      begin
         NSLDMOVPRODAX = NSLDMOVPROD;
         NCUSTOMPMMOVPRODAX = NCUSTOMPMMOVPROD;
         UPDATE EQMOVPROD SET SLDMOVPROD=:NSLDMOVPROD, CUSTOMPMMOVPROD=:NCUSTOMPMMOVPROD,
            SLDMOVPRODAX=:NSLDMOVPRODAX, CUSTOMPMMOVPRODAX=:NCUSTOMPMMOVPRODAX,
            ESTOQMOVPROD=:CESTOQMOVPROD
            WHERE CODEMP=:ICODEMPPD AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPRODPRC;
      end
      else if (ICODEMPAX=ICODEMPAXPRC AND SCODFILIALAX=SCODFILIALAXPRC AND
          ICODALMOX=ICODALMOXPRC) then
          /* Se for multi almoxarifado e o cdigo do almoxarifado for o mesmo*/
      begin
        SELECT NSALDO, NCUSTOMPM FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
            :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMMOVPRODAX, :NSLDMOVPRODAX)
            INTO :NSLDMOVPRODAX, :NCUSTOMPMMOVPRODAX;
        UPDATE EQMOVPROD SET SLDMOVPROD=:NSLDMOVPROD, CUSTOMPMMOVPROD=:NCUSTOMPMMOVPROD,
            SLDMOVPRODAX=:NSLDMOVPRODAX, CUSTOMPMMOVPRODAX=:NCUSTOMPMMOVPRODAX,
            ESTOQMOVPROD=:CESTOQMOVPROD
            WHERE CODEMP=:ICODEMPPD AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPRODPRC;
      end
      else /* Se for multi almoxarifado no atualiza almoxarifado diferente */
      begin
        UPDATE EQMOVPROD SET SLDMOVPROD=:NSLDMOVPROD, CUSTOMPMMOVPROD=:NCUSTOMPMMOVPROD,
            ESTOQMOVPROD=:CESTOQMOVPROD
            WHERE CODEMP=:ICODEMPPD AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPRODPRC;
      end
      NSLDPRC = NSLDMOVPROD;
      NCUSTOMPMPRC = NCUSTOMPMMOVPROD;
      NSLDPRCAX = NSLDMOVPRODAX;
      NCUSTOMPMPRCAX = NCUSTOMPMMOVPRODAX;
  END
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQMOVPRODRETCODSP"("ICODEMPIV" INTEGER,
"SCODFILIALIV" SMALLINT,
"ICODINVPROD" INTEGER,
"ICODEMPCP" INTEGER,
"SCODFILIALCP" SMALLINT,
"ICODCOMPRA" INTEGER,
"SCODITCOMPRA" SMALLINT,
"ICODEMPVD" INTEGER,
"SCODFILIALVD" SMALLINT,
"CTIPOVENDA" CHAR(1) CHARACTER SET NONE,
"ICODVENDA" INTEGER,
"SCODITVENDA" SMALLINT,
"ICODEMPRM" INTEGER,
"SCODFILIALRM" SMALLINT,
"ICODRMA" INTEGER,
"SCODITRMA" SMALLINT,
"ICODEMPOP" INTEGER,
"SCODFILIALOP" SMALLINT,
"ICODOP" INTEGER,
"SSEQOP" SMALLINT)
 RETURNS("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODMOVPROD" INTEGER)
 AS
begin
  /* Retorna o cdigo do movimento de estoque */
  if (ICODINVPROD IS NOT NULL) then
     SELECT MP.CODEMP, MP.CODFILIAL, MP.CODMOVPROD FROM EQMOVPROD MP
       WHERE MP.CODEMPIV=:ICODEMPIV AND MP.CODFILIALIV=:SCODFILIALIV
         AND MP.CODINVPROD=:ICODINVPROD
       INTO  :ICODEMP, :SCODFILIAL, :ICODMOVPROD;
  else if (ICODCOMPRA IS NOT NULL) then
     SELECT MP.CODEMP, MP.CODFILIAL, MP.CODMOVPROD FROM EQMOVPROD MP
       WHERE MP.CODEMPCP=:ICODEMPCP AND MP.CODFILIALCP=:SCODFILIALCP
         AND MP.CODCOMPRA=:ICODCOMPRA AND MP.CODITCOMPRA=:SCODITCOMPRA
       INTO  :ICODEMP, :SCODFILIAL, :ICODMOVPROD;
  else if (ICODVENDA IS NOT NULL) then
     SELECT MP.CODEMP, MP.CODFILIAL, MP.CODMOVPROD FROM EQMOVPROD MP
       WHERE MP.CODEMPVD=:ICODEMPVD AND MP.CODFILIALVD=:SCODFILIALVD
         AND MP.TIPOVENDA=:CTIPOVENDA AND MP.CODVENDA=:ICODVENDA
         AND MP.CODITVENDA=:SCODITVENDA
       INTO  :ICODEMP, :SCODFILIAL, :ICODMOVPROD;
  else if (ICODRMA IS NOT NULL) then
     SELECT MP.CODEMP, MP.CODFILIAL, MP.CODMOVPROD FROM EQMOVPROD MP
       WHERE MP.CODEMPRM=:ICODEMPRM AND MP.CODFILIALRM=:SCODFILIALRM
         AND MP.CODRMA=:ICODRMA AND MP.CODITRMA=:SCODITRMA
       INTO  :ICODEMP, :SCODFILIAL, :ICODMOVPROD;
  else if (ICODOP IS NOT NULL) then
     SELECT MP.CODEMP, MP.CODFILIAL, MP.CODMOVPROD FROM EQMOVPROD MP
       WHERE MP.CODEMPOP=:ICODEMPOP AND MP.CODFILIALOP=:SCODFILIALOP
         AND MP.CODOP=:ICODOP AND MP.SEQOP=:SSEQOP
       INTO  :ICODEMP, :SCODFILIAL, :ICODMOVPROD;



  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQMOVPRODSEQSP"("ICODEMP" INTEGER)
 RETURNS("SCODFILIAL" SMALLINT,
"ICODMOVPROD" INTEGER)
 AS
begin
  /* Busca o cdigo sequencial da tabela eqmovprod */
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP, 'EQMOVPROD') INTO :SCODFILIAL ;
  SELECT ISEQ FROM SPGERANUM(:ICODEMP, :SCODFILIAL, 'MP' ) INTO :ICODMOVPROD ;
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQMOVPRODSLDSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODMOVPROD" INTEGER,
"ICODEMPPD" INTEGER,
"SCODFILIALPD" SMALLINT,
"ICODPROD" INTEGER,
"DDTMOVPROD" DATE,
"NCUSTOMPMMOVPROD" NUMERIC(15,5),
"NCUSTOMPMMOVPRODAX" NUMERIC(15,5),
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER,
"CMULTIALMOX" CHAR(1) CHARACTER SET NONE)
 RETURNS("NSALDO" NUMERIC(15,5),
"NCUSTOMPM" NUMERIC(15,5),
"ICODMOVPRODSLD" INTEGER,
"NSALDOAX" NUMERIC(15,5),
"NCUSTOMPMAX" NUMERIC(15,5),
"ICODMOVPRODSLDAX" INTEGER)
 AS
begin
  /* Procedure que busca saldo e custo mdio */
  NSALDO = 0;
  NCUSTOMPM = 0;
  if (NCUSTOMPMMOVPROD IS NULL) then
     NCUSTOMPMMOVPROD = 0;
  if (ICODMOVPROD IS NULL) then
     SELECT FIRST 1 M.SLDMOVPROD, M.CUSTOMPMMOVPROD, M.CODMOVPROD
        FROM EQMOVPROD M
        WHERE M.CODEMPPD = :ICODEMPPD AND
          M.CODFILIALPD = :SCODFILIALPD AND
          M.CODPROD = :ICODPROD AND
          M.DTMOVPROD <= :DDTMOVPROD
        ORDER BY M.DTMOVPROD DESC, M.CODMOVPROD DESC
        INTO :NSALDO, :NCUSTOMPM, :ICODMOVPRODSLD;
   else
     SELECT FIRST 1 M.SLDMOVPROD, M.CUSTOMPMMOVPROD, M.CODMOVPROD
        FROM EQMOVPROD M
        WHERE M.CODEMP = :ICODEMP AND
          M.CODFILIAL = :SCODFILIAL AND
          M.CODEMPPD = :ICODEMPPD AND
          M.CODFILIALPD = :SCODFILIALPD AND
          M.CODPROD = :ICODPROD AND
          ( (M.DTMOVPROD = :DDTMOVPROD AND M.CODMOVPROD < :ICODMOVPROD ) OR
            (M.DTMOVPROD < :DDTMOVPROD ) )
        ORDER BY M.DTMOVPROD DESC, M.CODMOVPROD DESC
        INTO :NSALDO, :NCUSTOMPM, :ICODMOVPRODSLD;
  if (NSALDO IS NULL) then
     NSALDO = 0;
  if (NCUSTOMPM IS NULL) then
     NCUSTOMPM = NCUSTOMPMMOVPROD;

  if (CMULTIALMOX='N') then
  begin
      NSALDOAX = NSALDO;
      NCUSTOMPMAX = NCUSTOMPM;
      ICODMOVPRODSLDAX = ICODMOVPRODSLD;
  end
  else
  begin
      NSALDOAX = 0;
      NCUSTOMPMAX = 0;
      if (NCUSTOMPMMOVPRODAX IS NULL) then
         NCUSTOMPMMOVPRODAX = 0;
      if (ICODMOVPROD IS NULL) then
         SELECT FIRST 1 M.SLDMOVPROD, M.CUSTOMPMMOVPROD, M.CODMOVPROD
            FROM EQMOVPROD M
            WHERE M.CODEMPPD = :ICODEMPPD AND
              M.CODFILIALPD = :SCODFILIALPD AND
              M.CODPROD = :ICODPROD AND
              M.DTMOVPROD <= :DDTMOVPROD AND
              M.CODEMPAX = :ICODEMPAX AND
              M.CODFILIALAX = :SCODFILIALAX AND
              M.CODALMOX= :ICODALMOX
            ORDER BY M.DTMOVPROD DESC, M.CODMOVPROD DESC
            INTO :NSALDOAX, :NCUSTOMPMAX, :ICODMOVPRODSLDAX;
       else
         SELECT FIRST 1 M.SLDMOVPROD, M.CUSTOMPMMOVPROD, M.CODMOVPROD
            FROM EQMOVPROD M
            WHERE M.CODEMP = :ICODEMP AND
              M.CODFILIAL = :SCODFILIAL AND
              M.CODEMPPD = :ICODEMPPD AND
              M.CODFILIALPD = :SCODFILIALPD AND
              M.CODPROD = :ICODPROD AND
              M.CODEMPAX = :ICODEMPAX AND
              M.CODFILIALAX = :SCODFILIALAX AND
              M.CODALMOX = :ICODALMOX AND
              ( (M.DTMOVPROD = :DDTMOVPROD AND M.CODMOVPROD < :ICODMOVPROD ) OR
                (M.DTMOVPROD < :DDTMOVPROD ) )
            ORDER BY M.DTMOVPROD DESC, M.CODMOVPROD DESC
            INTO :NSALDOAX, :NCUSTOMPMAX, :ICODMOVPRODSLDAX;
      if (NSALDOAX IS NULL) then
         NSALDOAX = 0;
      if (NCUSTOMPMAX IS NULL) then
         NCUSTOMPMAX = NCUSTOMPMMOVPROD;
  end
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQMOVPRODUSP"("ICODEMPPD" INTEGER,
"SCODFILIALPD" SMALLINT,
"ICODPROD" INTEGER,
"ICODEMPLE" INTEGER,
"SCODFILIALLE" SMALLINT,
"CCODLOTE" CHAR(13) CHARACTER SET NONE,
"ICODEMPTM" INTEGER,
"SCODFILIALTM" SMALLINT,
"ICODTIPOMOV" INTEGER,
"ICODEMPIV" INTEGER,
"SCODFILIALIV" SMALLINT,
"ICODINVPROD" INTEGER,
"ICODEMPCP" INTEGER,
"SCODFILIALCP" SMALLINT,
"ICODCOMPRA" INTEGER,
"SCODITCOMPRA" SMALLINT,
"ICODEMPVD" INTEGER,
"SCODFILIALVD" SMALLINT,
"CTIPOVENDA" CHAR(1) CHARACTER SET NONE,
"ICODVENDA" INTEGER,
"SCODITVENDA" SMALLINT,
"ICODEMPRM" INTEGER,
"SCODFILIALRM" SMALLINT,
"ICODRMA" INTEGER,
"SCODITRMA" SMALLINT,
"ICODEMPOP" INTEGER,
"SCODFILIALOP" SMALLINT,
"ICODOP" INTEGER,
"SSEQOP" SMALLINT,
"ICODEMPNT" INTEGER,
"SCODFILIALNT" SMALLINT,
"CCODNAT" CHAR(4) CHARACTER SET NONE,
"DDTMOVPROD" DATE,
"IDOCMOVPROD" INTEGER,
"CFLAG" CHAR(1) CHARACTER SET NONE,
"NQTDMOVPROD" NUMERIC(15,5),
"NPRECOMOVPROD" NUMERIC(15,5),
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER,
"CMULTIALMOX" CHAR(1) CHARACTER SET NONE)
 AS
DECLARE VARIABLE ICODEMP INTEGER;
DECLARE VARIABLE SCODFILIAL SMALLINT;
DECLARE VARIABLE ICODMOVPROD INTEGER;
DECLARE VARIABLE NSLDPRC NUMERIC(15,5);
DECLARE VARIABLE NCUSTOMPMPRC NUMERIC(15,5);
DECLARE VARIABLE NSLDPRCAX NUMERIC(15,5);
DECLARE VARIABLE NCUSTOMPMPRCAX NUMERIC(15,5);
DECLARE VARIABLE NSLDLC NUMERIC(15,5);
DECLARE VARIABLE NCUSTOMPMLC NUMERIC(15,5);
DECLARE VARIABLE NSLDLCAX NUMERIC(15,5);
DECLARE VARIABLE NCUSTOMPMLCAX NUMERIC(15,5);
DECLARE VARIABLE DDTMOVPRODOLD DATE;
DECLARE VARIABLE NPRECOMOVPRODOLD NUMERIC(15,5);
DECLARE VARIABLE NQTDMOVPRODOLD NUMERIC(15,5);
DECLARE VARIABLE ICODEMPTMOLD INTEGER;
DECLARE VARIABLE SCODFILIALTMOLD SMALLINT;
DECLARE VARIABLE ICODTIPOMOVOLD INTEGER;
DECLARE VARIABLE CALTTM CHAR(1);
DECLARE VARIABLE DDTPRC DATE;
DECLARE VARIABLE DDTPRCATE DATE;
DECLARE VARIABLE CESTOQMOVPROD CHAR(1);
DECLARE VARIABLE SOPERADOR SMALLINT;
begin
  /* Procedure de atualizao da tabela eqmovprod */

  DDTPRCATE = NULL; /* At onde deve ser processando o estoque */

  SOPERADOR = 0; /* Pe o status do operador em modo zero */

 /* localiza movprod */

  SELECT ICODEMP, SCODFILIAL, ICODMOVPROD
    FROM EQMOVPRODRETCODSP(:ICODEMPIV, :SCODFILIALIV, :ICODINVPROD, :ICODEMPCP,
      :SCODFILIALCP, :ICODCOMPRA, :SCODITCOMPRA, :ICODEMPVD, :SCODFILIALVD,
      :CTIPOVENDA, :ICODVENDA, :SCODITVENDA, :ICODEMPRM, :SCODFILIALRM,
      :ICODRMA, :SCODITRMA, :ICODEMPOP, :SCODFILIALOP, :ICODOP, :SSEQOP)
    INTO :ICODEMP, :SCODFILIAL, :ICODMOVPROD;

/*  CTEMP = printlog('movprod atual: '||cast(:Icodmovprod as char(10))); */
/*  traz valores antigos
*/
  SELECT MP.CODEMPTM, MP.CODFILIALTM, MP.CODTIPOMOV, MP.DTMOVPROD,
       MP.PRECOMOVPROD, MP.QTDMOVPROD  FROM EQMOVPROD MP
     WHERE MP.CODEMP=:ICODEMP AND MP.CODFILIAL=:SCODFILIAL AND MP.CODMOVPROD=:ICODMOVPROD
     INTO :ICODEMPTMOLD, :SCODFILIALTMOLD, :ICODTIPOMOVOLD, :DDTMOVPRODOLD,
       :NPRECOMOVPRODOLD, :NQTDMOVPRODOLD;

   /* abaixo verificao se a alterao de tipo de movimento mexe no estoque */
   SELECT CALTTM FROM EQMOVPRODCKUTMSP(:ICODEMPTM, :SCODFILIALTM, :ICODTIPOMOV,
      :ICODEMPTMOLD, :SCODFILIALTMOLD, :ICODTIPOMOVOLD) INTO :CALTTM;

/*  CTEMP = printlog('DDTMOVPROD: '||cast(:DDTMOVPROD as char(10))); */
/*   CTEMP = printlog('DDTMOVPRODOLD: '||cast(:DDTMOVPRODOLD as char(10))); */



   /* verifica se h relevncia para reprocessamento */
   if ( (DDTMOVPROD!=DDTMOVPRODOLD) OR (CALTTM='S') OR
        (NPRECOMOVPROD!=NPRECOMOVPRODOLD) OR (NQTDMOVPROD!=NQTDMOVPRODOLD) ) then
   begin
      if ( DDTMOVPRODOLD IS NULL) then
         DDTMOVPRODOLD = DDTMOVPROD; /* garantir que a data antiga no e nula; */
      /* verifica qual data  menor para reprocessamento */
      if ( DDTMOVPROD<=DDTMOVPRODOLD ) then
      begin
          DDTPRC = DDTMOVPROD;
          if (DDTMOVPROD=DDTMOVPRODOLD) then
             DDTPRCATE = null;
          else
             DDTPRCATE = DDTMOVPRODOLD;

          /* CTEMP = printlog('ESTA ENTRANDO AQUI. DDTPRC: '||cast(:DDTPRC as char(10))); */
/*          verifica lanamento anterior e traz custo e saldo */
          SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX
             FROM EQMOVPRODSLDSP(:ICODEMP, :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
             :SCODFILIALPD, :ICODPROD, :DDTPRC, :NPRECOMOVPROD, :NPRECOMOVPROD,
             :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
             INTO :NSLDPRC, :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX ;

         /* CTEMP = printlog('LANCAMENTO ANTERIOR SALDO E CUSTO: '||cast(:NSLDPRC as char(15))||':'||cast(:NPRECOMOVPROD as char(15))); */

          /* verifica se havera mudana de saldo */
          SELECT NSALDO, NCUSTOMPM, CESTOQMOVPROD, SOPERADOR
              FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
              :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMPRC, :NSLDPRC)
              INTO :NSLDPRC, :NCUSTOMPMPRC, :CESTOQMOVPROD, :SOPERADOR;
          if (CMULTIALMOX='N') then
          begin
              NSLDPRCAX = NSLDPRC;
              NCUSTOMPMPRCAX = NCUSTOMPMPRC;
          end
          else
          begin
          SELECT NSALDO, NCUSTOMPM
              FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
              :ICODTIPOMOV, :NQTDMOVPROD, :NPRECOMOVPROD, :NCUSTOMPMPRCAX, :NSLDPRCAX)
              INTO :NSLDPRCAX, :NCUSTOMPMPRCAX;
          end
          NCUSTOMPMLC = NCUSTOMPMPRC;
          NSLDLC = NSLDPRC;
          NCUSTOMPMLCAX = NCUSTOMPMPRCAX;
          NSLDLCAX = NSLDPRCAX;
      end
      else
      begin
          /* CTEMP = printlog('O OLD  MENOR'); */

          DDTPRC = DDTMOVPRODOLD;
          DDTPRCATE = DDTMOVPROD;
          /* verifica lanamento anterior e traz custo e saldo */
          SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX
             FROM EQMOVPRODSLDSP(:ICODEMP, :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
             :SCODFILIALPD, :ICODPROD, :DDTPRC, 0, 0,
             :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
             INTO :NSLDPRC, :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX ;

          /* verifica lanamento anterior e traz custo e saldo */
          SELECT NSALDO, NCUSTOMPM, NSALDOAX, NCUSTOMPMAX
             FROM EQMOVPRODSLDSP(:ICODEMP, :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
             :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, :NCUSTOMPMLC, :NCUSTOMPMLCAX,
             :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
             INTO :NSLDLC, :NCUSTOMPMLC, :NSLDLCAX, :NCUSTOMPMLCAX ;

          /* verifica se havera mudana de saldo */
          SELECT NSALDO, NCUSTOMPM, CESTOQMOVPROD
              FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
              :ICODTIPOMOV, (:NQTDMOVPROD-:NQTDMOVPRODOLD), :NPRECOMOVPROD,
              :NCUSTOMPMLC, :NSLDLC)
              INTO :NSLDLC, :NCUSTOMPMLC, :CESTOQMOVPROD;
          if (CMULTIALMOX='N') then
          begin
             NSLDLCAX = NSLDLC;
             NCUSTOMPMLCAX = NCUSTOMPMLC;
          end
          else
          begin
              SELECT NSALDO, NCUSTOMPM
                  FROM EQMOVPRODCSLDSP(:ICODEMPTM, :SCODFILIALTM,
                  :ICODTIPOMOV, (:NQTDMOVPROD-:NQTDMOVPRODOLD), :NPRECOMOVPROD,
                  :NCUSTOMPMLCAX, :NSLDLCAX)
                  INTO :NSLDLCAX, :NCUSTOMPMLCAX;
          end

      end

      /* REPROCESSAR ESTOQUE */

       SELECT NSLDPRC, NCUSTOMPMPRC, NSLDPRCAX, NCUSTOMPMPRCAX
        FROM EQMOVPRODPRCSLDSP( :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
          :SCODFILIALPD, :ICODPROD, :DDTPRC, :DDTPRCATE, :NSLDPRC,
          :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX,
          :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
        INTO :NSLDPRC, :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX;

/* caso a data seja igual dever reprocessar datas posteriores */
/*      if (DDTMOVPROD=DDTMOVPRODOLD) then
      begin
          DDTPRC = DDTMOVPROD+1;
          DDTPRCATE = null;
          SELECT NSLDPRC, NCUSTOMPMPRC, NSLDPRCAX, NCUSTOMPMPRCAX
          FROM EQMOVPRODPRCSLDSP( :SCODFILIAL, :ICODMOVPROD, :ICODEMPPD,
            :SCODFILIALPD, :ICODPROD, :DDTPRC, :DDTPRCATE, :NSLDPRC,
            :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX,
            :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
          INTO :NSLDPRC, :NCUSTOMPMPRC, :NSLDPRCAX, :NCUSTOMPMPRCAX;
      end*/

      /* ATUALIZA CUSTO NO CADASTRO DE PRODUTOS */

    /*  EXECUTE PROCEDURE EQMOVPRODATCUSTSP( :SOPERADOR, :ICODEMP, :SCODFILIAL, */
      /*   :ICODMOVPROD, :SCODFILIALPD, :ICODPROD, :DDTMOVPROD, :NCUSTOMPMLC); */

       /* faz update  (Obs. o update tem que ser a ltima tarefa por questes de
           ndice */

      /*CTEMP = printlog('VAI FAZER O UPDATE: '||CAST(DDTMOVPROD AS CHAR(10)));*/

      UPDATE EQMOVPROD SET DTMOVPROD=:DDTMOVPROD,
         QTDMOVPROD=:NQTDMOVPROD, PRECOMOVPROD=:NPRECOMOVPROD,
         SLDMOVPROD=:NSLDLC, CUSTOMPMMOVPROD=:NCUSTOMPMLC,
         SLDMOVPRODAX=:NSLDLCAX, CUSTOMPMMOVPRODAX=:NCUSTOMPMLCAX,
         FLAG=:CFLAG, CODEMPNT=:ICODEMPNT, CODFILIALNT=:SCODFILIALNT,
         CODNAT=:CCODNAT, DOCMOVPROD=:IDOCMOVPROD, CODEMPTM=:ICODEMPTM,
         CODFILIALTM=:SCODFILIALTM, CODTIPOMOV=:ICODTIPOMOV, CODEMPLE=:ICODEMPLE,
         CODFILIALLE=:SCODFILIALLE, CODLOTE=:CCODLOTE, ESTOQMOVPROD=:CESTOQMOVPROD ,
         CODEMPAX=:ICODEMPAX, CODFILIALAX=:SCODFILIALAX, CODALMOX=:ICODALMOX
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPROD;

   end
   else /*  caso no tenha nenhuma alterao relevnte para processamento */
      UPDATE EQMOVPROD SET FLAG=:CFLAG, CODEMPNT=:ICODEMPNT, CODFILIALNT=:SCODFILIALNT,
         CODNAT=:CCODNAT, DOCMOVPROD=:IDOCMOVPROD, CODEMPTM=:ICODEMPTM,
         CODFILIALTM=:SCODFILIALTM, CODTIPOMOV=:ICODTIPOMOV, CODEMPLE=:ICODEMPLE,
         CODFILIALLE=:SCODFILIALLE, CODLOTE=:CCODLOTE,
         CODEMPAX=:ICODEMPAX, CODFILIALAX=:SCODFILIALAX, CODALMOX=:ICODALMOX
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL AND CODMOVPROD=:ICODMOVPROD;
   suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQPRODUTOSP01"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODPROD" INTEGER,
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER)
 RETURNS("NSALDO" NUMERIC(15,5),
"NSALDOAX" NUMERIC(15,5),
"NCUSTOMPM" NUMERIC(15,5),
"NCUSTOPEPS" NUMERIC(15,5),
"NCUSTOMPMAX" NUMERIC(15,5),
"NCUSTOPEPSAX" NUMERIC(15,5))
 AS
DECLARE VARIABLE DDTMOVPROD DATE;
DECLARE VARIABLE DDTMOVPRODAX DATE;
begin
  /* Procedure que retorna saldos e custos para a tela de cadastro de produtos */
  SELECT FIRST 1 MP.DTMOVPROD, MP.SLDMOVPROD , MP.CUSTOMPMMOVPROD
    FROM EQMOVPROD MP
    WHERE MP.CODEMPPD=:ICODEMP AND MP.CODFILIALPD=:SCODFILIAL AND MP.CODPROD=:ICODPROD
    ORDER BY MP.DTMOVPROD DESC, MP.CODMOVPROD DESC
    INTO :DDTMOVPROD, :NSALDO, :NCUSTOMPM;

  SELECT FIRST 1 MP.DTMOVPROD, MP.SLDMOVPRODAX, MP.CUSTOMPMMOVPRODAX
    FROM EQMOVPROD MP
    WHERE MP.CODEMPPD=:ICODEMP AND MP.CODFILIALPD=:SCODFILIAL AND MP.CODPROD=:ICODPROD
    ORDER BY MP.DTMOVPROD DESC, MP.CODMOVPROD DESC
    INTO :DDTMOVPRODAX, :NSALDOAX, :NCUSTOMPMAX;

  SELECT P.NCUSTOPEPS  FROM EQCALCPEPSSP(:ICODEMP, :SCODFILIAL,
     :ICODPROD, :NSALDO, :DDTMOVPROD, null, null,
     null ) P INTO :NCUSTOPEPS;

  SELECT P.NCUSTOPEPS  FROM EQCALCPEPSSP(:ICODEMP, :SCODFILIAL,
     :ICODPROD, :NSALDO, :DDTMOVPRODAX, :ICODEMPAX, :SCODFILIALAX,
     :ICODALMOX ) P INTO :NCUSTOPEPSAX;

  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQREFPRODSP"("CODEMP" INTEGER,
"CODFILIAL" SMALLINT,
"CODPROD" INTEGER)
 RETURNS("REFPROD" CHAR(13) CHARACTER SET NONE)
 AS
begin
  /* Procedure Text */
  SELECT REFPROD FROM EQPRODUTO WHERE CODPROD=:CODPROD AND
     CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL INTO :REFPROD;
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "EQGRUPO"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODGRUP" CHAR(14) CHARACTER SET NONE NOT NULL,
"DESCGRUP" CHAR(50) CHARACTER SET NONE NOT NULL,
"NIVELGRUP" INTEGER,
"CODEMPSG" INTEGER,
"CODFILIALSG" SMALLINT,
"CODSUBGRUP" CHAR(14) CHARACTER SET NONE,
"SIGLAGRUP" CHAR(10) CHARACTER SET NONE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"ESTNEGGRUP" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"ESTLOTNEGGRUP" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQRELDEMANDASP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"SCODFILIALPD" SMALLINT,
"DDTINI" DATE,
"DDTFIM" DATE)
 RETURNS("CODMARCA" CHAR(6) CHARACTER SET NONE,
"CODGRUP" CHAR(14) CHARACTER SET NONE,
"CODPROD" INTEGER,
"REFPROD" CHAR(13) CHARACTER SET NONE,
"DESCPROD" CHAR(50) CHARACTER SET NONE,
"DESCGRUP" CHAR(50) CHARACTER SET NONE,
"SLDINI" NUMERIC(15,5),
"VLRCOMPRAS" NUMERIC(15,5),
"VLRDEVENT" NUMERIC(15,5),
"VLROUTENT" NUMERIC(15,5),
"VLRVENDAS" NUMERIC(15,5),
"VLRDEVSAI" NUMERIC(15,5),
"VLROUTSAI" NUMERIC(15,5),
"SLDFIM" NUMERIC(15,5))
 AS
begin
  /* Stored procedure de relatrio de demanda */
  FOR SELECT P.CODMARCA, P.CODGRUP,P.CODPROD,
     P.REFPROD, P.DESCPROD,G.DESCGRUP,
     (SELECT FIRST 1 SLDMOVPROD FROM EQMOVPROD MP
      WHERE MP.CODEMP=:ICODEMP AND MP.CODFILIAL=:SCODFILIAL AND
         MP.CODEMPPD=P.CODEMP AND MP.CODFILIALPD=P.CODFILIAL AND
         MP.CODPROD=P.CODPROD AND MP.DTMOVPROD<:DDTINI
         ORDER BY MP.DTMOVPROD DESC, MP.CODMOVPROD DESC ) SLDINI,
     (SELECT SUM(MP.QTDMOVPROD)
         FROM EQMOVPROD MP, EQTIPOMOV TM
         WHERE TM.CODEMP=MP.CODEMPTM AND TM.CODFILIAL=MP.CODFILIALTM AND
           TM.CODTIPOMOV=MP.CODTIPOMOV AND MP.CODPROD=P.CODPROD AND
           MP.CODEMPPD=P.CODEMP AND MP.CODFILIALPD=P.CODFILIAL AND
           MP.DTMOVPROD BETWEEN :DDTINI AND :DDTFIM AND MP.ESTOQMOVPROD='S' AND
           TM.TIPOMOV IN ('CP','PC') AND TM.ESTIPOMOV = 'E') VLRCOMPRAS,
     (SELECT SUM(MP.QTDMOVPROD)
         FROM EQMOVPROD MP, EQTIPOMOV TM
         WHERE TM.CODEMP=MP.CODEMPTM AND TM.CODFILIAL=MP.CODFILIALTM AND
           TM.CODTIPOMOV=MP.CODTIPOMOV AND MP.CODPROD=P.CODPROD AND
           MP.CODEMPPD=P.CODEMP AND MP.CODFILIALPD=P.CODFILIAL AND
           MP.DTMOVPROD BETWEEN :DDTINI AND :DDTFIM AND MP.ESTOQMOVPROD='S' AND
           TM.TIPOMOV ='DV' AND TM.ESTIPOMOV = 'E') VLRDEVENT,
     (SELECT SUM(MP.QTDMOVPROD)
         FROM EQMOVPROD MP , EQTIPOMOV TM
         WHERE TM.CODEMP=MP.CODEMPTM AND TM.CODFILIAL=MP.CODFILIALTM AND
           TM.CODTIPOMOV=MP.CODTIPOMOV AND MP.CODPROD=P.CODPROD AND
           MP.CODEMPPD=P.CODEMP AND MP.CODFILIALPD=P.CODFILIAL AND
           MP.DTMOVPROD BETWEEN :DDTINI AND :DDTFIM AND MP.ESTOQMOVPROD='S' AND
           TM.TIPOMOV NOT IN ('CP','PC','DV') AND TM.ESTIPOMOV IN ('E','I')) VLROUTENT,
     (SELECT SUM(MP.QTDMOVPROD)
         FROM EQMOVPROD MP, EQTIPOMOV TM
         WHERE TM.CODEMP=MP.CODEMPTM AND TM.CODFILIAL=MP.CODFILIALTM AND
           TM.CODTIPOMOV=MP.CODTIPOMOV AND MP.CODPROD=P.CODPROD AND
           MP.CODEMPPD=P.CODEMP AND MP.CODFILIALPD=P.CODFILIAL AND
           MP.DTMOVPROD BETWEEN :DDTINI AND :DDTFIM AND MP.ESTOQMOVPROD='S' AND
           TM.TIPOMOV IN ('VD','PV') AND TM.ESTIPOMOV = 'S') VLRVENDAS,
     (SELECT SUM(MP.QTDMOVPROD)
         FROM EQMOVPROD MP, EQTIPOMOV TM
         WHERE TM.CODEMP=MP.CODEMPTM AND TM.CODFILIAL=MP.CODFILIALTM AND
           TM.CODTIPOMOV=MP.CODTIPOMOV AND MP.CODPROD=P.CODPROD AND
           MP.CODEMPPD=P.CODEMP AND MP.CODFILIALPD=P.CODFILIAL AND
           MP.DTMOVPROD BETWEEN :DDTINI AND :DDTFIM AND MP.ESTOQMOVPROD='S' AND
           TM.TIPOMOV ='DV' AND TM.ESTIPOMOV = 'S') VLRDEVSAI,
     (SELECT SUM(MP.QTDMOVPROD)
        FROM EQMOVPROD MP, EQTIPOMOV TM
         WHERE TM.CODEMP=MP.CODEMPTM AND TM.CODFILIAL=MP.CODFILIALTM AND
           TM.CODTIPOMOV=MP.CODTIPOMOV AND MP.CODPROD=P.CODPROD AND
           MP.CODEMPPD=P.CODEMP AND MP.CODFILIALPD=P.CODFILIAL AND
           MP.DTMOVPROD BETWEEN :DDTINI AND :DDTFIM AND MP.ESTOQMOVPROD='S' AND
           TM.TIPOMOV NOT IN ('VD','PV','DV') AND TM.ESTIPOMOV = 'S') VLROUTSAI
     FROM EQPRODUTO P, EQGRUPO G
         WHERE G.CODGRUP=P.CODGRUP AND G.CODEMP=P.CODEMPGP AND
           G.CODFILIAL=P.CODFILIALGP AND P.CODEMP=:ICODEMP AND
           P.CODFILIAL=:SCODFILIALPD AND P.ATIVOPROD='S'
     INTO :CODMARCA, :CODGRUP, :CODPROD, :REFPROD, :DESCPROD, :DESCGRUP,
        :SLDINI, :VLRCOMPRAS, :VLRDEVENT,  :VLROUTENT,
         :VLRVENDAS, :VLRDEVSAI, :VLROUTSAI DO
     BEGIN
        if (SLDINI IS NULL) then
           SLDINI = 0;
        if (VLROUTSAI IS NULL) then
           VLROUTSAI = 0;
        if (VLROUTENT IS NULL) then
           VLROUTENT = 0;
        if (VLRDEVSAI IS NULL) then
           VLRDEVSAI = 0;
        if (VLRDEVENT IS NULL) then
           VLRDEVENT = 0;
        if (VLRCOMPRAS IS NULL) then
           VLRCOMPRAS = 0;
        if (VLRVENDAS IS NULL) then
           VLRVENDAS = 0;
        SLDFIM = SLDINI + VLRCOMPRAS + VLRDEVENT + VLROUTENT -
           VLRVENDAS - VLRDEVSAI - VLROUTSAI;
        suspend;
     END
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQRELINVPRODSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"CTIPOCUSTO" CHAR(1) CHARACTER SET NONE,
"ICODEMPGP" INTEGER,
"SCODFILIALGP" SMALLINT,
"CCODGRUP" CHAR(14) CHARACTER SET NONE,
"DDTESTOQ" DATE,
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER)
 RETURNS("CODPROD" INTEGER,
"REFPROD" CHAR(13) CHARACTER SET NONE,
"DESCPROD" CHAR(50) CHARACTER SET NONE,
"CODGRUP" CHAR(14) CHARACTER SET NONE,
"SALDO" NUMERIC(15,5),
"CUSTO" NUMERIC(15,5),
"VLRESTOQ" NUMERIC(15,5))
 AS
DECLARE VARIABLE CMULTIALMOX CHAR(1);
DECLARE VARIABLE NCUSTOMPM NUMERIC(15,5);
begin
  /* Relatrio de estoque */
  SELECT CMULTIALMOX FROM SGRETMULTIALMOXSP(:ICODEMP) INTO :CMULTIALMOX;

  if (CCODGRUP IS NOT NULL) then
  begin
     CCODGRUP = rtrim(CCODGRUP);
     if (strlen(CCODGRUP)<14) then
        CCODGRUP = CCODGRUP || '%';
  end
  FOR SELECT P.CODPROD, P.REFPROD, P.DESCPROD, P.CODGRUP
    FROM EQPRODUTO P
    WHERE P.CODEMP=:ICODEMP AND P.CODFILIAL=:SCODFILIAL AND
          ( ( :CCODGRUP IS NULL ) OR
            (P.CODGRUP LIKE :CCODGRUP AND P.CODEMPGP=:ICODEMPGP AND
             P.CODFILIALGP=:SCODFILIALGP) )
    INTO :CODPROD, :REFPROD, :DESCPROD, :CODGRUP DO
  BEGIN
     SELECT NSALDO, NCUSTOMPM FROM EQMOVPRODSLDSP(null, null, null, :ICODEMP,
        :SCODFILIAL, :CODPROD, :DDTESTOQ, 0, 0,
        :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CMULTIALMOX)
       INTO :SALDO, :NCUSTOMPM;
     if (CTIPOCUSTO='M') then
        CUSTO = NCUSTOMPM;
     else
        SELECT NCUSTOPEPS FROM EQCALCPEPSSP(:ICODEMP, :SCODFILIAL, :CODPROD,
          :SALDO, :DDTESTOQ, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX)
        INTO :CUSTO;
     VLRESTOQ = CUSTO * SALDO;
     SUSPEND;
  END
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQRELPEPSSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"DTESTOQ" DATE,
"ICODEMPMC" INTEGER,
"SCODFILIALMC" SMALLINT,
"CCODMARCA" CHAR(6) CHARACTER SET NONE,
"ICODEMPGP" INTEGER,
"SCODFILIALGP" SMALLINT,
"CCODGRUP" CHAR(14) CHARACTER SET NONE,
"CTIPOCUSTO" CHAR(1) CHARACTER SET NONE,
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER)
 RETURNS("CODPROD" INTEGER,
"REFPROD" CHAR(13) CHARACTER SET NONE,
"DESCPROD" CHAR(50) CHARACTER SET NONE,
"SLDPROD" NUMERIC(15,5),
"CUSTOUNIT" NUMERIC(15,5),
"CUSTOTOT" NUMERIC(15,5),
"CODBARPROD" CHAR(13) CHARACTER SET NONE,
"CODFABPROD" CHAR(13) CHARACTER SET NONE)
 AS
begin
  /* Procedure Text */
  IF (ICODEMPGP IS NOT NULL) THEN
  BEGIN
    IF (STRLEN(RTRIM(CCODGRUP))<14) THEN
       CCODGRUP = RTRIM(CCODGRUP)||'%';
  END
  IF (CTIPOCUSTO IS NULL) then
     CTIPOCUSTO = 'P';

  FOR SELECT P.CODPROD,P.REFPROD,P.DESCPROD, P.CODBARPROD, P.CODFABPROD
   FROM EQPRODUTO P
   WHERE P.CODEMP = :ICODEMP AND P.CODFILIAL = :SCODFILIAL AND
   ( (:ICODEMPMC IS NULL) OR (P.CODEMPMC=:ICODEMPMC AND P.CODFILIALMC=:SCODFILIALMC AND
      P.CODMARCA=:CCODMARCA) ) AND
   ((:ICODEMPGP IS NULL) OR (P.CODEMPGP=:ICODEMPGP AND P.CODFILIALGP=:SCODFILIALGP AND
      P.CODGRUP LIKE :CCODGRUP) )
   INTO :CODPROD, :REFPROD, :DESCPROD, :CODBARPROD, :CODFABPROD  DO
  BEGIN
     SELECT SLDPROD, CUSTOUNIT, CUSTOTOT FROM EQCUSTOPRODSP(:ICODEMP,
        :SCODFILIAL, :CODPROD, :DTESTOQ, :CTIPOCUSTO, :ICODEMPAX,
        :SCODFILIALAX, :ICODALMOX, 'S')
       INTO :SLDPROD, :CUSTOUNIT, :CUSTOTOT;
     SUSPEND;
  END
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "EQSALDOLOTE"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODPROD" INTEGER NOT NULL,
"CODLOTE" CHAR(13) CHARACTER SET NONE NOT NULL,
"CODEMPAX" INTEGER NOT NULL,
"CODFILIALAX" SMALLINT NOT NULL,
"CODALMOX" INTEGER NOT NULL,
"SLDLOTE" "NUMERICDN" DEFAULT 0 NOT NULL,
"SLDRESLOTE" "NUMERICDN" DEFAULT 0 NOT NULL,
"SLDCONSIGLOTE" "NUMERICDN" DEFAULT 0 NOT NULL,
"SLDLIQLOTE" "NUMERICDN" DEFAULT 0 NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
CREATE TABLE "EQLOTE"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODPROD" INTEGER NOT NULL,
"CODLOTE" CHAR(13) CHARACTER SET NONE NOT NULL,
"VENCTOLOTE" DATE NOT NULL,
"SLDLOTE" "NUMERICDN",
"SLDRESLOTE" "NUMERICDN",
"SLDCONSIGLOTE" "NUMERICDN",
"SLDLIQLOTE" "NUMERICDN",
"DINILOTE" DATE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQSALDOLOTEATEQSP"("ICODEMPLEOLD" INTEGER,
"SCODFILIALLEOLD" SMALLINT,
"ICODPROD" INTEGER,
"CCODLOTEOLD" CHAR(13) CHARACTER SET NONE,
"ICODEMPLENEW" INTEGER,
"SCODFILIALLENEW" SMALLINT,
"CCODLOTENEW" CHAR(13) CHARACTER SET NONE,
"SOPERADOR" SMALLINT,
"NQTDMOVPRODOLD" NUMERIC(15,5),
"NQTDMOVPRODNEW" NUMERIC(15,5),
"ICODEMPAXOLD" INTEGER,
"SCODFILIALAXOLD" SMALLINT,
"ICODALMOXOLD" INTEGER,
"ICODEMPAXNEW" INTEGER,
"SCODFILIALAXNEW" SMALLINT,
"ICODALMOXNEW" INTEGER)
 AS
DECLARE VARIABLE ICODPRODSLD INTEGER;
begin
  /* Procedure de atualizao do estoque  na tabela de saldos de lotes por almoxarifado*/

  SELECT CODPROD FROM EQSALDOLOTE
     WHERE CODEMP=:ICODEMPLENEW AND CODFILIAL=:SCODFILIALLENEW AND CODPROD=:ICODPROD AND
        CODLOTE=:CCODLOTENEW AND CODEMPAX=:ICODEMPAXNEW AND 
        CODFILIALAX=:SCODFILIALAXNEW AND CODALMOX=:ICODALMOXNEW
     INTO :ICODPRODSLD;
  IF (ICODPRODSLD IS NULL) THEN
  BEGIN
     INSERT INTO EQSALDOLOTE (CODEMP, CODFILIAL, CODPROD, CODLOTE, CODEMPAX, CODFILIALAX, CODALMOX)
       VALUES (:ICODEMPLENEW, :SCODFILIALLENEW, :ICODPROD, :CCODLOTENEW, :ICODEMPAXNEW, :SCODFILIALAXNEW,
         :ICODALMOXNEW);
     NQTDMOVPRODOLD = 0;
  END

  IF ( (ICODALMOXOLD IS NULL) OR (CCODLOTEOLD IS NULL) ) THEN
    NQTDMOVPRODOLD = 0;
  ELSE IF ( (ICODEMPAXOLD!=ICODEMPAXNEW) OR (SCODFILIALAXOLD!=SCODFILIALAXNEW) OR
            (ICODALMOXOLD!=ICODALMOXNEW) OR (CCODLOTEOLD!=CCODLOTENEW) OR
            (ICODEMPLEOLD!=ICODEMPLENEW) OR (SCODFILIALLEOLD!=SCODFILIALLENEW) ) THEN
  BEGIN
      IF ((CCODLOTEOLD!=CCODLOTENEW) OR (ICODEMPLEOLD!=ICODEMPLENEW) OR
          (SCODFILIALLEOLD!=SCODFILIALLENEW) ) THEN
      BEGIN
         UPDATE EQLOTE SET SLDLOTE = SLDLOTE+((0-:NQTDMOVPRODOLD)*:SOPERADOR)
            WHERE CODLOTE=:CCODLOTEOLD AND CODPROD=:ICODPROD
            AND CODEMP=:ICODEMPLEOLD AND CODFILIAL=:SCODFILIALLEOLD;
      END
      UPDATE EQSALDOLOTE SET SLDLOTE = SLDLOTE+((0-:NQTDMOVPRODOLD)*:SOPERADOR)
         WHERE CODPROD=:ICODPROD AND CODLOTE=:CCODLOTEOLD AND CODALMOX = :ICODALMOXOLD
           AND CODEMPAX = :ICODEMPAXOLD AND CODFILIALAX = :SCODFILIALAXOLD
           AND CODEMP=:ICODEMPLEOLD AND CODFILIAL=:SCODFILIALLEOLD; 
      NQTDMOVPRODOLD=0;
  END
  UPDATE EQLOTE SET SLDLOTE = SLDLOTE+((:NQTDMOVPRODNEW-:NQTDMOVPRODOLD)*:SOPERADOR)
        WHERE CODLOTE=:CCODLOTENEW AND CODPROD=:ICODPROD
         AND CODEMP=:ICODEMPLENEW AND CODFILIAL=:SCODFILIALLENEW;
  UPDATE EQSALDOLOTE SET SLDLOTE = SLDLOTE+((:NQTDMOVPRODNEW-:NQTDMOVPRODOLD)*:SOPERADOR)
         WHERE CODPROD=:ICODPROD AND CODLOTE=:CCODLOTENEW AND CODALMOX = :ICODALMOXNEW
           AND CODEMPAX = :ICODEMPAXNEW AND CODFILIALAX = :SCODFILIALAXNEW
           AND CODEMP=:ICODEMPLENEW AND CODFILIAL=:SCODFILIALLENEW;
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "EQSALDOPROD"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODPROD" INTEGER NOT NULL,
"CODEMPAX" INTEGER NOT NULL,
"CODFILIALAX" SMALLINT NOT NULL,
"CODALMOX" INTEGER NOT NULL,
"SLDPROD" "NUMERICDN" DEFAULT 0 NOT NULL,
"SLDRESPROD" "NUMERICDN" DEFAULT 0 NOT NULL,
"SLDCONSIGPROD" "NUMERICDN" DEFAULT 0 NOT NULL,
"SLDLIQPROD" "NUMERICDN" DEFAULT 0 NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "EQSALDOPRODATEQSP"("ICODEMPPD" INTEGER,
"SCODFILIALPD" SMALLINT,
"ICODPROD" INTEGER,
"SOPERADOR" SMALLINT,
"NQTDMOVPRODOLD" NUMERIC(15,5),
"NQTDMOVPRODNEW" NUMERIC(15,5),
"ICODEMPAXOLD" INTEGER,
"SCODFILIALAXOLD" SMALLINT,
"ICODALMOXOLD" INTEGER,
"ICODEMPAXNEW" INTEGER,
"SCODFILIALAXNEW" SMALLINT,
"ICODALMOXNEW" INTEGER)
 AS
DECLARE VARIABLE ICODPRODSLD INTEGER;
begin
  /* Procedure de atualizao do estoque  na tabela de saldos por almoxarifado*/
  SELECT CODPROD FROM EQSALDOPROD
     WHERE CODEMP=:ICODEMPPD AND CODFILIAL=:SCODFILIALPD AND CODPROD=:ICODPROD AND
        CODEMPAX=:ICODEMPAXNEW AND CODFILIALAX=:SCODFILIALAXNEW AND CODALMOX=:ICODALMOXNEW
     INTO :ICODPRODSLD;
  IF (ICODPRODSLD IS NULL) THEN
  BEGIN
     INSERT INTO EQSALDOPROD (CODEMP, CODFILIAL, CODPROD, CODEMPAX, CODFILIALAX, CODALMOX)
       VALUES (:ICODEMPPD, :SCODFILIALPD, :ICODPROD, :ICODEMPAXNEW, :SCODFILIALAXNEW,
         :ICODALMOXNEW);
     NQTDMOVPRODOLD = 0;
  END

  IF (ICODALMOXOLD IS NULL) THEN
    NQTDMOVPRODOLD = 0;
  ELSE IF ( (ICODEMPAXOLD!=ICODEMPAXNEW) OR (SCODFILIALAXOLD!=SCODFILIALAXNEW) OR
            (ICODALMOXOLD!=ICODALMOXNEW) ) THEN
  BEGIN
      UPDATE EQSALDOPROD SET SLDPROD = SLDPROD+((0-:NQTDMOVPRODOLD)*:SOPERADOR)
         WHERE CODPROD=:ICODPROD AND CODALMOX = :ICODALMOXOLD
           AND CODEMPAX = :ICODEMPAXOLD AND CODFILIALAX = :SCODFILIALAXOLD
           AND CODEMP=:ICODEMPPD AND CODFILIAL=:SCODFILIALPD;
      NQTDMOVPRODOLD=0;
  END
  UPDATE EQSALDOPROD SET SLDPROD = SLDPROD+((:NQTDMOVPRODNEW-:NQTDMOVPRODOLD)*:SOPERADOR)
         WHERE CODPROD=:ICODPROD AND CODALMOX = :ICODALMOXNEW
           AND CODEMPAX = :ICODEMPAXNEW AND CODFILIALAX = :SCODFILIALAXNEW
           AND CODEMP=:ICODEMPPD AND CODFILIAL=:SCODFILIALPD;
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "FNITRECEBER"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODREC" INTEGER NOT NULL,
"NPARCITREC" INTEGER NOT NULL,
"VLRITREC" "NUMERICDN" NOT NULL,
"VLRDESCITREC" "NUMERICDN",
"VLRMULTAITREC" "NUMERICDN",
"VLRJUROSITREC" "NUMERICDN",
"VLRPARCITREC" "NUMERICDN",
"VLRPAGOITREC" "NUMERICDN",
"VLRAPAGITREC" "NUMERICDN",
"DTITREC" DATE NOT NULL,
"DTVENCITREC" DATE NOT NULL,
"DTPAGOITREC" DATE,
"STATUSITREC" CHAR(2) CHARACTER SET NONE NOT NULL,
"CODEMPPN" INTEGER,
"CODFILIALPN" SMALLINT,
"CODPLAN" CHAR(13) CHARACTER SET NONE,
"OBSITREC" VARCHAR(250) CHARACTER SET NONE,
"CODEMPCA" INTEGER,
"CODFILIALCA" SMALLINT,
"NUMCONTA" CHAR(10) CHARACTER SET NONE,
"CODEMPBO" INTEGER,
"CODFILIALBO" SMALLINT,
"CODBANCO" CHAR(3) CHARACTER SET NONE,
"CODEMPTC" INTEGER,
"CODFILIALTC" SMALLINT,
"CODTIPOCOB" INTEGER,
"CODEMPCB" INTEGER,
"CODFILIALCB" SMALLINT,
"CODCARTCOB" CHAR(2) CHARACTER SET NONE,
"DOCLANCAITREC" CHAR(10) CHARACTER SET NONE,
"FLAG" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"CODEMPCC" INTEGER,
"CODFILIALCC" SMALLINT,
"ANOCC" SMALLINT,
"CODCC" CHAR(19) CHARACTER SET NONE,
"VLRCOMIITREC" "NUMERICDN" DEFAULT 0,
"IMPRECIBOITREC" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"RECIBOITREC" INTEGER,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"ALTUSUITREC" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "FNADICITRECEBERSP01"("CALTVLR" CHAR(1) CHARACTER SET NONE,
"ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODREC" INTEGER,
"INPARCITREC" INTEGER,
"NVLRDESCITREC" NUMERIC(15,5),
"NVLRMULTAITREC" NUMERIC(15,5),
"NVLRJUROSITREC" NUMERIC(15,5),
"NVLRPARCITREC" NUMERIC(15,5),
"NVLRPAGOITREC" NUMERIC(15,5),
"DDTITREC" DATE,
"DDTVENCITREC" DATE,
"CSTATUSITREC" CHAR(2) CHARACTER SET NONE,
"CFLAG" CHAR(1) CHARACTER SET NONE,
"ICODEMPBO" INTEGER,
"SCODFILIALBO" SMALLINT,
"CCODBANCO" CHAR(3) CHARACTER SET NONE,
"ICODEMPTC" INTEGER,
"SCODFILIALTC" SMALLINT,
"ICODTIPOCOB" INTEGER,
"ICODEMPCB" INTEGER,
"SCODFILIALCB" SMALLINT,
"CODCARTCOB" CHAR(2) CHARACTER SET NONE,
"NVLRCOMIITREC" NUMERIC(15,5),
"OBSITREC" VARCHAR(250) CHARACTER SET NONE)
 AS
DECLARE VARIABLE INPARCITRECOLD INTEGER;
begin
   SELECT IR.NPARCITREC FROM FNITRECEBER IR WHERE IR.CODEMP=:ICODEMP AND
     IR.CODFILIAL=:SCODFILIAL AND IR.CODREC=:ICODREC AND
     IR.NPARCITREC=:INPARCITREC INTO :INPARCITRECOLD;

   IF (INPARCITRECOLD IS NULL) THEN
     /* Faz insero na tabela de parcelas do contas a receber */
       INSERT INTO FNITRECEBER (CODEMP,CODFILIAL,CODREC,NPARCITREC,VLRDESCITREC,VLRMULTAITREC,
              VLRJUROSITREC,VLRPARCITREC,VLRPAGOITREC,DTITREC,DTVENCITREC,
              STATUSITREC,FLAG,CODEMPBO,CODFILIALBO,CODBANCO,
              CODEMPTC, CODFILIALTC, CODTIPOCOB,
              CODEMPCB, CODFILIALCB, CODCARTCOB, VLRCOMIITREC, OBSITREC)
              VALUES
             (:ICODEMP,:SCODFILIAL,:ICODREC,:INPARCITREC,:NVLRDESCITREC,:NVLRMULTAITREC,
             :NVLRJUROSITREC,:NVLRPARCITREC,:NVLRPAGOITREC, :DDTITREC,:DDTVENCITREC,
             :CSTATUSITREC,:CFLAG,:ICODEMPBO,:SCODFILIALBO,:CCODBANCO,
             :ICODEMPTC, :SCODFILIALTC, :ICODTIPOCOB,
             :ICODEMPCB, :SCODFILIALCB, :CODCARTCOB, :NVLRCOMIITREC, :OBSITREC);
   ELSE
   BEGIN
       SELECT VLRDESCITREC, VLRMULTAITREC, VLRJUROSITREC, VLRPAGOITREC, STATUSITREC
       FROM FNITRECEBER
       WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL AND CODREC=:ICODREC AND
            NPARCITREC=:INPARCITREC
       INTO :NVLRDESCITREC, :NVLRMULTAITREC, :NVLRJUROSITREC, :NVLRPAGOITREC, :CSTATUSITREC;

       IF (CALTVLR='S') THEN /* Flag que indica se  para mudar os valores do contas areceber */
       BEGIN

           UPDATE FNITRECEBER SET ALTUSUITREC='N',VLRDESCITREC=:NVLRDESCITREC,VLRMULTAITREC=:NVLRMULTAITREC,
                  VLRJUROSITREC=:NVLRJUROSITREC,VLRPARCITREC=:NVLRPARCITREC,
                  VLRPAGOITREC=:NVLRPAGOITREC,DTITREC=:DDTITREC,STATUSITREC=:CSTATUSITREC,
                  FLAG=:CFLAG,CODEMPBO=:ICODEMPBO,CODFILIALBO=:SCODFILIALBO,
                  CODBANCO=:CCODBANCO,CODEMPTC=:ICODEMPTC, CODFILIALTC=:SCODFILIALTC, 
                  CODTIPOCOB=:ICODTIPOCOB,
                  CODEMPCB=:ICODEMPCB, CODFILIALCB=:SCODFILIALCB, CODCARTCOB=:CODCARTCOB,
                  VLRCOMIITREC=:NVLRCOMIITREC
            WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL AND CODREC=:ICODREC AND
                NPARCITREC=:INPARCITREC;
       END
       ELSE
           UPDATE FNITRECEBER SET ALTUSUITREC='N',DTITREC=:DDTITREC,
                  STATUSITREC=:CSTATUSITREC, FLAG=:CFLAG,CODEMPBO=:ICODEMPBO,
                  CODFILIALBO=:SCODFILIALBO,CODBANCO=:CCODBANCO,CODEMPTC=:ICODEMPTC,
                  CODFILIALTC=:SCODFILIALTC, CODTIPOCOB=:ICODTIPOCOB,
                  CODEMPCB=:ICODEMPCB, CODFILIALCB=:SCODFILIALCB, CODCARTCOB=:CODCARTCOB,
                  VLRCOMIITREC=:NVLRCOMIITREC
            WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL AND CODREC=:ICODREC AND
                NPARCITREC=:INPARCITREC;
  END
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "FNSUBLANCA"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODLANCA" INTEGER NOT NULL,
"CODSUBLANCA" INTEGER NOT NULL,
"CODEMPPN" INTEGER NOT NULL,
"CODFILIALPN" SMALLINT NOT NULL,
"CODPLAN" CHAR(13) CHARACTER SET NONE NOT NULL,
"STATUSSUBLANCA" CHAR(2) CHARACTER SET NONE NOT NULL,
"ORIGSUBLANCA" CHAR(1) CHARACTER SET NONE,
"DTPREVSUBLANCA" DATE,
"DATASUBLANCA" DATE,
"VLRSUBLANCA" "NUMERICDN" DEFAULT 0,
"FLAG" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"CODEMPCC" INTEGER,
"CODFILIALCC" SMALLINT,
"ANOCC" SMALLINT,
"CODCC" CHAR(19) CHARACTER SET NONE,
"CODEMPCL" INTEGER,
"CODFILIALCL" SMALLINT,
"CODCLI" INTEGER,
"CODEMPFR" INTEGER,
"CODFILIALFR" SMALLINT,
"CODFOR" INTEGER,
"HISTSUBLANCA" CHAR(50) CHARACTER SET NONE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
CREATE TABLE "FNLANCA"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODLANCA" INTEGER NOT NULL,
"CODCOMI" INTEGER,
"CODEMPPG" INTEGER,
"CODFILIALPG" SMALLINT,
"CODPAG" INTEGER,
"NPARCPAG" INTEGER,
"CODEMPRC" INTEGER,
"CODFILIALRC" SMALLINT,
"CODREC" INTEGER,
"NPARCITREC" INTEGER,
"CODEMPPN" INTEGER NOT NULL,
"CODFILIALPN" SMALLINT NOT NULL,
"CODPLAN" CHAR(13) CHARACTER SET NONE NOT NULL,
"DATALANCA" DATE NOT NULL,
"DOCLANCA" CHAR(15) CHARACTER SET NONE,
"HISTBLANCA" CHAR(50) CHARACTER SET NONE NOT NULL,
"HISTLANCA" VARCHAR(10000) CHARACTER SET NONE,
"TRANSFLANCA" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"STATUSLANCA" CHAR(2) CHARACTER SET NONE,
"DTPREVLANCA" DATE,
"DTPREVSUBLANCA" DATE,
"VLRLANCA" "NUMERICDN" DEFAULT 0,
"CODEMPCI" INTEGER,
"CODFILIALCI" SMALLINT,
"CODPCOMI" INTEGER,
"FLAG" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"TIPOLANCA" CHAR(1) CHARACTER SET NONE DEFAULT 'A' NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
CREATE TABLE "FNRECEBER"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODREC" INTEGER NOT NULL,
"CODEMPBO" INTEGER,
"CODFILIALBO" SMALLINT,
"CODBANCO" CHAR(3) CHARACTER SET NONE,
"CODEMPPG" INTEGER NOT NULL,
"CODFILIALPG" SMALLINT NOT NULL,
"CODPLANOPAG" INTEGER NOT NULL,
"CODEMPCL" INTEGER NOT NULL,
"CODFILIALCL" SMALLINT NOT NULL,
"CODCLI" INTEGER NOT NULL,
"CODEMPVD" INTEGER,
"CODFILIALVD" SMALLINT,
"CODVEND" INTEGER,
"CODEMPVA" INTEGER,
"CODFILIALVA" SMALLINT,
"TIPOVENDA" CHAR(1) CHARACTER SET NONE,
"CODVENDA" INTEGER,
"CODEMPTC" INTEGER,
"CODFILIALTC" SMALLINT,
"CODTIPOCOB" INTEGER,
"CODEMPCB" INTEGER,
"CODFILIALCB" SMALLINT,
"CODCARTCOB" CHAR(2) CHARACTER SET NONE,
"VLRREC" "NUMERICDN" NOT NULL,
"VLRDESCREC" "NUMERICDN",
"VLRMULTAREC" "NUMERICDN",
"VLRJUROSREC" "NUMERICDN",
"VLRPARCREC" "NUMERICDN" NOT NULL,
"VLRPAGOREC" "NUMERICDN",
"VLRAPAGREC" "NUMERICDN",
"DATAREC" DATE NOT NULL,
"STATUSREC" CHAR(2) CHARACTER SET NONE NOT NULL,
"VLRCOMIREC" "NUMERICDN",
"DTQUITREC" DATE,
"DOCREC" INTEGER NOT NULL,
"NROPARCREC" INTEGER DEFAULT 0,
"OBSREC" VARCHAR(250) CHARACTER SET NONE,
"FLAG" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"ALTUSUREC" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
CREATE TABLE "FNCONTA"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"NUMCONTA" CHAR(10) CHARACTER SET NONE NOT NULL,
"DESCCONTA" CHAR(50) CHARACTER SET NONE NOT NULL,
"CODEMPMA" INTEGER NOT NULL,
"CODFILIALMA" SMALLINT NOT NULL,
"CODMOEDA" CHAR(4) CHARACTER SET NONE NOT NULL,
"CODEMPBO" INTEGER,
"CODFILIALBO" SMALLINT,
"CODBANCO" CHAR(3) CHARACTER SET NONE,
"CODEMPPN" INTEGER NOT NULL,
"CODFILIALPN" SMALLINT NOT NULL,
"CODPLAN" CHAR(13) CHARACTER SET NONE NOT NULL,
"TIPOCONTA" CHAR(1) CHARACTER SET NONE NOT NULL,
"DATACONTA" DATE NOT NULL,
"CODEMPHP" INTEGER,
"CODFILIALHP" SMALLINT,
"CODHIST" INTEGER,
"CODCONTDEB" VARCHAR(20) CHARACTER SET NONE,
"CODCONTCRED" VARCHAR(20) CHARACTER SET NONE,
"AGENCIACONTA" CHAR(6) CHARACTER SET NONE,
"CONVCOBCONTA" VARCHAR(10) CHARACTER SET NONE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"ATIVACONTA" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL,
"TUSUCONTA" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "FNADICLANCASP01"("ICODREC" INTEGER,
"INPARCITREC" INTEGER,
"PDVITREC" CHAR(1),
"SNUMCONTA" CHAR(10),
"ICODEMPCA" INTEGER,
"ICODFILIALCA" INTEGER,
"ICODCLI" INTEGER,
"ICODEMPCL" INTEGER,
"ICODFILIALCL" INTEGER,
"SCODPLAN" CHAR(13),
"ICODEMPPN" INTEGER,
"ICODFILIALPN" INTEGER,
"IANOCC" INTEGER,
"SCODCC" CHAR(19),
"ICODEMPCC" INTEGER,
"ICODFILIALCC" INTEGER,
"DDTPAGOITREC" DATE,
"SDOCLANCAITREC" CHAR(10),
"SOBSITREC" CHAR(50),
"DVLRPAGOITREC" NUMERIC(18,2),
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT)
AS
DECLARE VARIABLE ICODLANCA INTEGER;
DECLARE VARIABLE SCODPLANCONTA CHAR(13);
DECLARE VARIABLE ICODEMPPCONTA INTEGER;
DECLARE VARIABLE ICODFILIALPCONTA INTEGER;
DECLARE VARIABLE CFLAG CHAR(1);
DECLARE VARIABLE IFILIALLANCA INTEGER;
DECLARE VARIABLE TIPOLANCA CHAR(1);
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNLANCA') INTO IFILIALLANCA;
  SELECT CODPLAN,CODEMPPN,CODFILIALPN FROM FNCONTA WHERE NUMCONTA = :SNUMCONTA
         AND CODEMP=:ICODEMPCA AND CODFILIAL=:ICODFILIALCA INTO :sCodPlanConta,:iCodEmpPConta,:iCodFilialPConta;
  SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALLANCA,'LA') INTO ICODLANCA;
  SELECT FLAG FROM FNRECEBER WHERE CODREC=:ICODREC
         AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO :cFlag;

  IF (ICODCLI IS NULL) THEN
    TIPOLANCA = 'A';
  ELSE
    TIPOLANCA = 'C';

  INSERT INTO FNLANCA (TIPOLANCA,CODEMP,CODFILIAL,CODLANCA,CODEMPRC,CODFILIALRC,CODREC,NPARCITREC,CODEMPPN,CODFILIALPN,
                       CODPLAN,DATALANCA,DOCLANCA,HISTBLANCA,DTPREVLANCA,VLRLANCA,FLAG,CODEMPCL,CODFILIALCL,CODCLI,PDVITREC)
         VALUES (
                 :TIPOLANCA,:ICODEMP,:IFILIALLANCA,:iCodLanca,:ICODEMP,:ICODFILIAL,:ICODREC,:iNParcItRec,:iCodEmpPConta,:iCodFilialPConta,
                 :sCodPlanConta,:dDtPagoItRec,:sDocLancaItRec,:sObsItRec,:dDtPagoItRec,0,:cFlag,:ICODEMPCL,:ICODFILIALCL,:ICODCLI,:PDVITREC
          );
  INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPCL,CODFILIALCL,CODCLI,CODEMPPN,CODFILIALPN,CODPLAN,CODEMPCC,
                          CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,FLAG)
         VALUES (
                :ICODEMP,:IFILIALLANCA,:iCodLanca,1,:ICODEMPCL,:ICODFILIALCL,:ICODCLI,:ICODEMPPN,:ICODFILIALPN,:SCODPLAN,:ICODEMPCC,
                :ICODFILIALCC,:IANOCC,:SCODCC,'S',:dDtPagoItRec,:dDtPagoItRec,:dVlrPagoItRec*-1,:cFlag
         );
END
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "FNPAGAR"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODPAG" INTEGER NOT NULL,
"CODEMPCP" INTEGER,
"CODFILIALCP" SMALLINT,
"CODCOMPRA" INTEGER,
"CODEMPPG" INTEGER NOT NULL,
"CODFILIALPG" SMALLINT NOT NULL,
"CODPLANOPAG" INTEGER NOT NULL,
"CODEMPFR" INTEGER NOT NULL,
"CODFILIALFR" SMALLINT NOT NULL,
"CODFOR" INTEGER NOT NULL,
"CODEMPBO" INTEGER,
"CODFILIALBO" SMALLINT,
"CODBANCO" CHAR(3) CHARACTER SET NONE,
"VLRDESCPAG" "NUMERICDN",
"VLRMULTAPAG" "NUMERICDN",
"VLRJUROSPAG" "NUMERICDN",
"VLRPARCPAG" "NUMERICDN" NOT NULL,
"VLRPAGOPAG" "NUMERICDN",
"VLRAPAGPAG" "NUMERICDN",
"DATAPAG" DATE,
"STATUSPAG" CHAR(2) CHARACTER SET NONE NOT NULL,
"DTQUITPAG" DATE,
"DOCPAG" INTEGER NOT NULL,
"VLRPAG" "NUMERICDN" DEFAULT 0,
"NROPARCPAG" INTEGER DEFAULT 0,
"OBSPAG" CHAR(50) CHARACTER SET NONE,
"VLRADICPAG" "NUMERICDN" DEFAULT 0,
"FLAG" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "FNADICLANCASP02"("ICODPAG" INTEGER,
"INPARCPAG" INTEGER,
"SNUMCONTA" CHAR(10) CHARACTER SET NONE,
"ICODEMPCA" INTEGER,
"ICODFILIALCA" INTEGER,
"ICODFOR" INTEGER,
"ICODEMPFR" INTEGER,
"ICODFILIALFR" INTEGER,
"SCODPLAN" CHAR(13) CHARACTER SET NONE,
"ICODEMPPN" INTEGER,
"ICODFILIALPN" INTEGER,
"IANOCC" INTEGER,
"SCODCC" CHAR(19) CHARACTER SET NONE,
"ICODEMPCC" INTEGER,
"ICODFILIALCC" INTEGER,
"DDTPAGOITPAG" DATE,
"SDOCLANCAITPAG" CHAR(10) CHARACTER SET NONE,
"SOBSITPAG" CHAR(50) CHARACTER SET NONE,
"DVLRPAGOITPAG" NUMERIC(15,5),
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT)
 AS
DECLARE VARIABLE iCodLanca INTEGER;
  DECLARE VARIABLE sCodPlanConta CHAR(13);
  DECLARE VARIABLE iCodEmpPConta INTEGER;
  DECLARE VARIABLE iCodFilialPConta INTEGER;
  DECLARE VARIABLE cFlag CHAR(1);
  DECLARE VARIABLE IFILIALLANCA INTEGER;
  DECLARE VARIABLE TIPOLANCA CHAR;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNLANCA') INTO IFILIALLANCA;
  SELECT CODPLAN,CODEMP,CODFILIAL FROM FNCONTA WHERE NUMCONTA=:sNumConta
         AND CODEMP=:ICODEMPCA AND CODFILIAL=:ICODFILIALCA INTO :sCodPlanConta,:iCodEmpPConta,:iCodFilialPConta;
  SELECT ISEQ FROM SPGERANUM(:iCODEMP,:IFILIALLANCA,'LA') INTO :iCodLanca;
  SELECT FLAG FROM FNPAGAR WHERE CODPAG=:iCodPag
         AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO :cFlag;

  IF (ICODFOR IS NULL) THEN
    TIPOLANCA = 'A';
  ELSE
    TIPOLANCA = 'F';

  INSERT INTO FNLANCA (TIPOLANCA,CODEMP,CODFILIAL,CODLANCA,CODEMPPG,CODFILIALPG,CODPAG,NPARCPAG,CODEMPPN,CODFILIALPN,CODPLAN,DATALANCA,DOCLANCA,
         HISTBLANCA,DTPREVLANCA,VLRLANCA,FLAG)
         VALUES (
                :TIPOLANCA,:ICODEMP,:IFILIALLANCA,:iCodLanca,:ICODEMP,:ICODFILIAL,:iCodPag,:iNParcPag,:iCodEmpPConta,:iCodFilialPConta,:sCodPlanConta,:dDtPagoItPag,
                :sDocLancaItPag,:sObsItPag,:dDtPagoItPag,0,:cFlag
         );
  INSERT INTO FNSUBLANCA (CODEMP,CODFILIAL,CODLANCA,CODSUBLANCA,CODEMPFR,CODFILIALFR,CODFOR,CODEMPPN,CODFILIALPN,CODPLAN,CODEMPCC,CODFILIALCC,ANOCC,CODCC,ORIGSUBLANCA,DATASUBLANCA,DTPREVSUBLANCA,VLRSUBLANCA,FLAG)
         VALUES (:ICODEMP,:IFILIALLANCA,:iCodLanca,1,:ICODEMPFR,:ICODFILIALFR,:ICODFOR,:ICODEMPPN,:ICODFILIALPN,:sCodplan,:ICODEMPCC,:ICODFILIALCC,:IANOCC,:SCODCC,'E',:dDtPagoItPag,:dDtPagoItPag,:dVlrPagoItPag,:cFlag);
END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "FNADICPAGARSP01"("CODCOMPRA" INTEGER,
"ICODEMPPG" INTEGER,
"ICODFILIALPG" SMALLINT,
"CODPLANOPAG" INTEGER,
"ICODEMPFR" INTEGER,
"ICODFILIALFR" SMALLINT,
"CODFOR" INTEGER,
"VLRLIQCOMPRA" NUMERIC(18,2),
"DTSAIDACOMPRA" DATE,
"DOCCOMPRA" INTEGER,
"ICODEMPBO" INTEGER,
"ICODFILIALBO" SMALLINT,
"CODBANCO" CHAR(3) CHARACTER SET NONE,
"FLAG" CHAR(1) CHARACTER SET NONE,
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT)
 AS
DECLARE VARIABLE ICODPAGAR INTEGER;
  DECLARE VARIABLE IFILIALPAGAR INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNPAGAR') INTO IFILIALPAGAR;
  SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALPAGAR,'PA') INTO ICODPAGAR;
  INSERT INTO FNPAGAR (CODEMP,CODFILIAL,CODPAG,CODPLANOPAG,CODEMPPG,CODFILIALPG,CODFOR,CODEMPFR,CODFILIALFR,CODCOMPRA,CODEMPCP,CODFILIALCP,VLRPAG,
                      VLRDESCPAG,VLRMULTAPAG,VLRJUROSPAG,VLRPARCPAG,VLRPAGOPAG,
                      VLRAPAGPAG,DATAPAG,STATUSPAG,DOCPAG,CODBANCO,CODEMPBO,CODFILIALBO,FLAG)
                      VALUES (
                             :ICODEMP,:IFILIALPAGAR,:ICODPAGAR,:CodPlanoPag,:ICODEMPPG,:ICODFILIALPG,:CodFor,:ICODEMPFR,:ICODFILIALFR,:CodCompra,:ICODEMP,:ICODFILIAL,:VlrLiqCompra,
                             0,0,0,:VlrLiqCompra,0,:VlrLiqCompra,:dtSaidaCompra,'P1',:DocCompra,
                             :CodBanco,:ICODEMPBO,:ICODFILIALBO,:FLAG
                      );
END
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "FNPLANOPAG"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODPLANOPAG" INTEGER NOT NULL,
"DESCPLANOPAG" CHAR(40) CHARACTER SET NONE,
"PARCPLANOPAG" INTEGER NOT NULL,
"APORCPLANOPAG" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"AUTOBAIXAPLANOPAG" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"CODEMPCA" INTEGER,
"CODFILIALCA" SMALLINT,
"NUMCONTA" CHAR(10) CHARACTER SET NONE,
"CODEMPPN" INTEGER,
"CODFILIALPN" SMALLINT,
"CODPLAN" CHAR(13) CHARACTER SET NONE,
"CODEMPCC" INTEGER,
"CODFILIALCC" SMALLINT,
"ANOCC" SMALLINT,
"CODCC" CHAR(19) CHARACTER SET NONE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"ATIVOPLANOPAG" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL,
"CVPLANOPAG" CHAR(1) CHARACTER SET NONE DEFAULT 'A' NOT NULL);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "FNADICRECEBERSP01"("CTIPOVENDA" CHAR(1) CHARACTER SET NONE,
"ICODVENDA" INTEGER,
"ICODEMPTC" INTEGER,
"ICODFILIALTC" INTEGER,
"CODTIPOCOB" INTEGER,
"ICODEMPPG" INTEGER,
"ICODFILIALPG" SMALLINT,
"CODPLANOPAG" INTEGER,
"ICODEMPCL" INTEGER,
"ICODFILIALCL" SMALLINT,
"CODCLI" INTEGER,
"ICODEMPVD" INTEGER,
"ICODFILIALVD" SMALLINT,
"CODVEND" INTEGER,
"VLRLIQVENDA" NUMERIC(15,5),
"DTSAIDAVENDA" DATE,
"VLRCOMISVENDA" NUMERIC(15,5),
"DOCVENDA" INTEGER,
"ICODEMPBO" INTEGER,
"ICODFILIALBO" SMALLINT,
"CODBANCO" CHAR(3) CHARACTER SET NONE,
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT,
"CODEMPCB" INTEGER,
"CODFILIALCB" SMALLINT,
"CODCARTCOB" CHAR(2) CHARACTER SET NONE,
"FLAG" CHAR(1) CHARACTER SET NONE)
 AS
DECLARE VARIABLE ICODREC INTEGER;
DECLARE VARIABLE SCODFILIALRC SMALLINT;
DECLARE VARIABLE IPARCPLANOPAG INTEGER;
BEGIN
  SELECT R.CODREC,R.CODFILIAL FROM FNRECEBER R
     WHERE R.CODEMPVA=:ICODEMP AND R.CODFILIALVA=:ICODFILIAL AND
       R.TIPOVENDA=:CTIPOVENDA AND R.CODVENDA=:ICODVENDA
     INTO :ICODREC,:SCODFILIALRC;
  SELECT PARCPLANOPAG FROM FNPLANOPAG WHERE CODEMP=:ICODEMPPG AND
     CODFILIAL=:ICODFILIALPG AND CODPLANOPAG=:CODPLANOPAG
     INTO :IPARCPLANOPAG;

  IF ( (ICODREC IS NULL) AND (IPARCPLANOPAG>0) ) THEN
  BEGIN
     SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNRECEBER') INTO SCODFILIALRC;
     SELECT ISEQ FROM SPGERANUM(:ICODEMP,:SCODFILIALRC,'RC') INTO :ICODREC;

     INSERT INTO FNRECEBER (CODEMP,CODFILIAL,CODREC, CODTIPOCOB, CODEMPTC, CODFILIALTC,
              CODPLANOPAG,CODEMPPG,CODFILIALPG,CODCLI,
              CODEMPCL,CODFILIALCL,CODVEND,CODEMPVD,CODFILIALVD,TIPOVENDA,CODVENDA,
              CODEMPVA,CODFILIALVA,VLRREC,
              VLRDESCREC,VLRMULTAREC,VLRJUROSREC,VLRPARCREC,VLRPAGOREC,
              VLRAPAGREC,DATAREC,STATUSREC,VLRCOMIREC,DOCREC,CODBANCO,CODEMPBO,CODFILIALBO,
              CODEMPCB, CODFILIALCB, CODCARTCOB, FLAG)
              VALUES (
                     :ICODEMP,:SCODFILIALRC,:ICODREC, :CODTIPOCOB, :ICODEMPTC, :ICODFILIALTC,
                     :CodPlanoPag,:ICODEMPPG,:ICODFILIALPG,:CodCli,
                     :ICODEMPCL,:ICODFILIALCL,:CodVend,:ICODEMPVD,:ICODFILIALVD,:CTIPOVENDA,:ICodVenda,
                     :ICODEMP,:ICODFILIAL,:VlrLiqVenda,
                     0,0,0,:VlrLiqVenda,0,:VlrLiqVenda,:dtSaidaVenda,'R1',
                     :VlrComisVenda,:DocVenda,:CodBanco,:ICODEMPBO,:ICODFILIALBO,
                     :CODEMPCB, :CODFILIALCB, :CODCARTCOB, :FLAG
              );
  END
  ELSE IF (ICODREC IS NOT NULL) THEN
  BEGIN
    IF (IPARCPLANOPAG>0) THEN
    BEGIN
        UPDATE FNRECEBER SET ALTUSUREC='N',
              CODTIPOCOB=:CODTIPOCOB,CODEMPTC=:ICODEMPTC, CODFILIALTC=:ICODFILIALTC,
              CODPLANOPAG=:CodPlanoPag,CODEMPPG=:ICODEMPPG,CODFILIALPG=:ICODFILIALPG,
              CODCLI=:CodCli, CODEMPCL=:ICODEMPCL,CODFILIALCL=:ICODFILIALCL,
              CODVEND=:CodVend,CODEMPVD=:ICODEMPVD,CODFILIALVD=:ICODFILIALVD,
              VLRREC=:VlrLiqVenda,VLRDESCREC=0,VLRMULTAREC=0,VLRJUROSREC=0,
              VLRPARCREC=:VlrLiqVenda,VLRPAGOREC=0,VLRAPAGREC=:VlrLiqVenda,
              DATAREC=:dtSaidaVenda,VLRCOMIREC=:VlrComisVenda,
              /* STATUSREC='R1' */
              DOCREC=:DocVenda,CODBANCO=:CodBanco,CODEMPBO=:ICODEMPBO,
              CODFILIALBO=:ICODFILIALBO,
              CODEMPCB=:CODEMPCB, CODFILIALCB=:CODFILIALCB, CODCARTCOB=:CODCARTCOB, FLAG=:FLAG
             WHERE CODREC=:ICODREC AND CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIALRC;
        UPDATE FNITRECEBER SET ALTUSUITREC='S' /* Atualiza os itens de contas a */
        /* receber para ajustar automaticamente os valores no cabealho */
             WHERE CODREC=:ICODREC AND CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIALRC;
     END
     ELSE
     BEGIN
         DELETE FROM FNRECEBER WHERE CODREC=:ICODREC AND CODEMP=:ICODEMP AND
            CODFILIAL=:SCODFILIALRC;
     END
   END

END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "FNCHECAPGTOSP"("ICODCLI" INTEGER,
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT)
 RETURNS("SRETORNO" CHAR(1) CHARACTER SET NONE)
 AS
DECLARE VARIABLE iLinhas INTEGER;
DECLARE VARIABLE IFILIALRECEBER INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNRECEBER') INTO IFILIALRECEBER;
  SELECT COUNT(*) FROM FNITRECEBER IT WHERE CODREC
         IN (
            SELECT CODREC FROM FNRECEBER REC WHERE REC.CODCLI = :iCodCli
                   AND REC.CODEMPCL=:ICODEMP AND REC.CODFILIALCL=:ICODFILIAL
                   AND REC.CODREC = IT.CODREC
                   AND CODEMP=IT.CODEMP AND CODFILIAL=IT.CODFILIAL
         )
         AND STATUSITREC != 'RP'
         AND IT.CODEMP=:ICODEMP AND IT.CODFILIAL=:IFILIALRECEBER INTO iLinhas;
  IF (iLinhas > 0) THEN
    sRetorno = 'N';
  ELSE
    sRetorno = 'S';
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "FNDELETARECEBERSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"CTIPOVENDA" CHAR(1) CHARACTER SET NONE,
"ICODVENDA" INTEGER)
 RETURNS("SDELETADO" SMALLINT)
 AS
DECLARE VARIABLE ICONTADOR INTEGER;
begin
  /* Procedure Text */
  SELECT COUNT(*) FROM FNRECEBER R, FNLANCA L
    WHERE R.CODVENDA=:ICODVENDA AND R.TIPOVENDA=:CTIPOVENDA AND
     R.CODEMPVA=:ICODEMP AND R.CODFILIALVA=:SCODFILIAL AND
     L.CODEMPRC=R.CODEMP AND L.CODFILIALRC=R.CODFILIAL AND
     L.CODREC=R.CODREC
    INTO :ICONTADOR;
  IF (ICONTADOR IS NULL) THEN
     ICONTADOR = 0;
  IF (ICONTADOR=0) THEN
  BEGIN
     SDELETADO = 1;
     DELETE FROM FNRECEBER WHERE CODVENDA=:ICODVENDA AND TIPOVENDA=:CTIPOVENDA AND
       CODEMPVA=:ICODEMP AND CODFILIALVA=:SCODFILIAL;
  END
  ELSE
  BEGIN
     SDELETADO = 0;
  END
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "FNPARCPAG"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODPLANOPAG" INTEGER NOT NULL,
"NROPARCPAG" INTEGER NOT NULL,
"PERCPAG" NUMERIC(9,5),
"DIASPAG" INTEGER,
"DESCPARCPAG" CHAR(30) CHARACTER SET NONE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "FNGERAITRECEBERSP01"("CALTVLR" CHAR(1) CHARACTER SET NONE,
"ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODREC" INTEGER,
"ICODEMPPG" INTEGER,
"SCODFILIALPG" SMALLINT,
"ICODPLANOPAG" INTEGER,
"NVLRREC" NUMERIC(15,5),
"DDATAREC" DATE,
"CFLAG" CHAR(1) CHARACTER SET NONE,
"ICODEMPBO" INTEGER,
"SCODFILIALBO" SMALLINT,
"CCODBANCO" CHAR(3) CHARACTER SET NONE,
"ICODEMPTC" INTEGER,
"SCODFILIALTC" SMALLINT,
"ICODTIPOCOB" INTEGER,
"ICODEMPCB" INTEGER,
"SCODFILIALCB" SMALLINT,
"CODCARTCOB" CHAR(2) CHARACTER SET NONE,
"NVLRCOMIREC" NUMERIC(15,5),
"OBSREC" VARCHAR(250) CHARACTER SET NONE)
 RETURNS("I" INTEGER)
 AS
DECLARE VARIABLE NPERC NUMERIC(10,6);
DECLARE VARIABLE NPERCPAG NUMERIC(10,6);
DECLARE VARIABLE NRESTO NUMERIC(15,5);
DECLARE VARIABLE INUMPARC INTEGER;
DECLARE VARIABLE IDIASPAG INTEGER;
DECLARE VARIABLE NRESTOCOMI NUMERIC(15,5);
DECLARE VARIABLE NVLRCOMIITREC NUMERIC(15,5);
DECLARE VARIABLE NVLRITREC NUMERIC(15,5);
begin
  /* Procedure Text */
  i = 0;
  nPerc = 100.000000;
  nResto = nVLRREC;
  nRestoComi = nVLRCOMIREC;
  SELECT PARCPLANOPAG FROM FNPLANOPAG WHERE CODPLANOPAG=:iCODPLANOPAG
         AND CODEMP=:iCODEMPPG AND CODFILIAL = :sCODFILIALPG INTO :iNumParc;
  FOR SELECT PERCPAG,DIASPAG FROM FNPARCPAG WHERE CODPLANOPAG=:iCODPLANOPAG
             AND CODEMP=:iCODEMPPG AND CODFILIAL = :sCODFILIALPG ORDER BY DIASPAG
             INTO :nPercPag,:iDiasPag DO
  BEGIN
    i = i+1;
    select v.deretorno
        from arreddouble(cast(:nVLRREC*:nPercPag as NUMERIC(15, 5))/:nPerc,2 ) v
       into :nVlrItRec;
    nResto = nResto-nVlrItRec;
    IF (i = iNumParc) THEN
    BEGIN
      nVlrItRec=nVlrItRec+nResto;
    END
    select v.deretorno from
       arreddouble(cast(:nVlrComiRec*:nPercPag as NUMERIC(15, 5))/:nPerc,2) v
       into :nVlrComiItRec;
    nRestoComi = nRestoComi-nVlrComiItRec;
    if (i = iNumParc) then
    begin
      nVlrComiItRec = nVlrComiItRec+nRestoComi;
    end

    EXECUTE PROCEDURE fnadicitrecebersp01 (:cALTVLR, :iCODEMP,:sCODFILIAL,:iCODREC,:i,0,0,0,:nVlrItRec,0,
                            :dDATAREC,:dDATAREC+:iDiasPag,'R1',:cFLAG,:iCODEMPBO,:sCODFILIALBO,
                            :cCODBANCO, :iCODEMPTC, :sCODFILIALTC, :iCODTIPOCOB,
                            :ICODEMPCB, :SCODFILIALCB, :CODCARTCOB, :NVLRCOMIITREC, :OBSREC);
  END
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "FNITRECEBERSP01"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODREC" INTEGER,
"NVLRPARCREC" NUMERIC(15,5),
"NVLRCOMIREC" NUMERIC(15,5),
"INROPARCREC" INTEGER,
"CCLASCOMIS" CHAR(1) CHARACTER SET NONE)
 AS
DECLARE VARIABLE INPARCITREC INTEGER;
DECLARE VARIABLE NVLRPARCITREC NUMERIC(15,5);
DECLARE VARIABLE NPERC NUMERIC(10,6);
DECLARE VARIABLE NVLRCOMIITREC NUMERIC(15,5);
DECLARE VARIABLE NRESTO NUMERIC(15,5);
DECLARE VARIABLE DVENCITREC DATE;
begin
  /* Procedure que atualiza a comisso na tabela ITRECEBER */
  nResto = nVlrComiRec;
  FOR SELECT NPARCITREC,VLRPARCITREC,DTVENCITREC FROM FNITRECEBER WHERE CODEMP=:iCodEmp AND
          CODFILIAL=:sCodFilial AND CODREC=:iCodRec
          ORDER BY NPARCITREC
          INTO :iNParcItRec , :nVlrParcItRec, :dVencItRec DO
  BEGIN
     nPerc = nVlrParcItRec/nVlrParcRec;
     nVlrComiItRec = cast( (nVlrComiRec * nPerc) as NUMERIC(15, 5) );
     nResto = nResto - nVlrComiItRec;
     IF (iNParcItRec=iNroParcRec) THEN
     BEGIN
        nVlrComiItRec = nVlrComiItRec + nResto;
     END
     UPDATE FNITRECEBER SET VLRCOMIITREC=:nVlrComiItRec WHERE CODEMP=:iCodEmp AND
          CODFILIAL=:sCodFilial AND CODREC=:iCodRec AND NPARCITREC=:iNParcItRec;
     IF (CCLASCOMIS='S') THEN
        EXECUTE PROCEDURE vdgeracomissaosp(:iCodEmp, :sCodFilial, :iCodRec,
           :iNParcItRec, :nVlrComiItRec, :dVencItRec);
  END
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "FNLIBCRED"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODLCRED" INTEGER NOT NULL,
"CODVENDA" INTEGER NOT NULL,
"DTAEMITLCRED" DATE DEFAULT 'now' NOT NULL,
"VLRAUTORIZLCRED" "NUMERICDN" DEFAULT 0 NOT NULL,
"VLRUTILLCRED" "NUMERICDN" DEFAULT 0 NOT NULL,
"CODEMPUS" INTEGER,
"CODFILIALUS" SMALLINT,
"IDUSU" CHAR(8) CHARACTER SET NONE,
"DTAUTILLCRED" DATE,
"SITLCRED" CHAR(1) CHARACTER SET NONE DEFAULT 'L' NOT NULL,
"CODEMPCL" INTEGER NOT NULL,
"CODFILIALCL" SMALLINT NOT NULL,
"CODCLI" INTEGER NOT NULL,
"DTAVCTOLCRED" DATE DEFAULT 'today' NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
CREATE TABLE "FNTIPOCRED"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODTPCRED" INTEGER NOT NULL,
"DESCTPCRED" CHAR(50) CHARACTER SET NONE NOT NULL,
"VLRTPCRED" "NUMERICDN" NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
CREATE TABLE "PVCAIXA"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODCAIXA" INTEGER NOT NULL,
"DESCCAIXA" CHAR(40) CHARACTER SET NONE NOT NULL,
"ECFCAIXA" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL,
"MODODEMO" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL,
"TEFCAIXA" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"CODEMPET" INTEGER NOT NULL,
"CODFILIALET" SMALLINT NOT NULL,
"CODEST" INTEGER NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"SEQINI" INTEGER,
"SEQMAX" INTEGER);
COMMIT WORK;
CREATE TABLE "SGCONEXAO"("NRCONEXAO" INTEGER NOT NULL,
"CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"IDUSU" CHAR(10) CHARACTER SET NONE NOT NULL,
"CODFILIALSEL" SMALLINT NOT NULL,
"CODTERM" INTEGER,
"CONECTADO" INTEGER DEFAULT 0 NOT NULL);
COMMIT WORK;
CREATE TABLE "SGESTACAO"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODEST" SMALLINT NOT NULL,
"DESCEST" CHAR(50) CHARACTER SET NONE NOT NULL,
"MODODEMOEST" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"IDUSUINS" CHAR(8) CHARACTER SET NONE,
"DTINS" DATE DEFAULT 'now',
"HINS" TIME DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE,
"DTALT" DATE,
"HALT" TIME);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "FNLIBCREDSP"("CODVENDA" INTEGER,
"CODCLI" INTEGER,
"CODEMPCL" INTEGER,
"CODFILIALCL" INTEGER,
"VLRLIB" NUMERIC(18,3))
 AS
DECLARE VARIABLE PREFCRED CHAR(1);
DECLARE VARIABLE CODFILIAL INTEGER;
DECLARE VARIABLE VLRTPCRED NUMERIC(15,5);
DECLARE VARIABLE VLRAUTORIZ NUMERIC(15,5);
DECLARE VARIABLE CODLIB INTEGER;
DECLARE VARIABLE IFILIALUS INTEGER;
DECLARE VARIABLE ECF CHAR(1);
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMPCL,'FNLIBCRED') INTO CODFILIAL;
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMPCL,'SGUSUARIO') INTO IFILIALUS;
  SELECT PREFCRED FROM SGPREFERE1 WHERE CODEMP=:CODEMPCL
    AND CODFILIAL=:CODFILIAL INTO PREFCRED;

  SELECT FIRST 1 ECFCAIXA FROM PVCAIXA CX, SGCONEXAO CON, SGESTACAO EST WHERE
    EST.CODEMP=CON.CODEMP AND EST.CODFILIAL=CON.CODFILIAL AND
    EST.CODEST=CON.CODTERM AND CX.CODFILIALET=EST.CODFILIAL AND
    CX.CODEMPET=EST.CODEMP AND CX.CODEST=EST.CODEST AND
    CON.NRCONEXAO=CURRENT_CONNECTION AND CONECTADO > 0 INTO ECF;

  IF (PREFCRED = 'N' OR ECF='S') THEN /* No verificar */
    EXIT;
  ELSE IF (PREFCRED = 'L') THEN /*Liberar se no ultrapassar o crdito pr aprovado */
  BEGIN
    SELECT VLRTPCRED FROM FNTIPOCRED TC, VDCLIENTE CL
      WHERE CL.CODCLI=:CODCLI AND CL.CODEMP=:CODEMPCL
      AND CL.CODFILIAL=:CODFILIALCL AND TC.CODTPCRED=CL.CODTPCRED
      AND TC.CODEMP=CL.CODEMPTR AND TC.CODFILIAL=CL.CODFILIALTR
      AND CAST('today' AS DATE) <= CL.DTVENCTOTR INTO VLRTPCRED;

    IF (VLRTPCRED > 0) THEN
    BEGIN
      IF (VLRLIB IS NULL) THEN
        EXIT;
      ELSE IF (VLRLIB <= VLRTPCRED) THEN
        EXIT;
      ELSE
        EXCEPTION VDVENDAEX04; /*Valor pre-aprovado insuficiente*/
    END
    ELSE
    BEGIN
      /* Caso no seja possvel liberar por credito pr-aprovado ento verifica liberao*/
      PREFCRED = 'A';
    END
  END
  IF (PREFCRED = 'A') THEN /* Aguardar liberao */
  BEGIN
    SELECT VLRAUTORIZLCRED,CODLCRED FROM FNLIBCRED WHERE CODEMP=:CODEMPCL
      AND CODFILIAL=:CODFILIAL AND CODCLI=:CODCLI AND CODEMPCL=:CODEMPCL
      AND CODFILIALCL=:CODFILIALCL AND CODVENDA=:CODVENDA
      AND DTAVCTOLCRED >= CAST('today' AS DATE) INTO VLRAUTORIZ,CODLIB;
    IF (VLRAUTORIZ > 0) THEN
    BEGIN
      IF (VLRLIB IS NULL) THEN
        EXIT;
      ELSE IF (VLRLIB <= VLRAUTORIZ) THEN
        UPDATE FNLIBCRED SET VLRUTILLCRED=:VLRLIB,SITLCRED='L',
          IDUSU=lower(USER),CODEMPUS=:CODEMPCL,CODFILIALUS=:IFILIALUS,
          DTAUTILLCRED=CAST('today' AS DATE)
          WHERE CODLCRED=:CODLIB AND CODEMP=:CODEMPCL
          AND CODFILIAL=:IFILIALUS;
      ELSE
        EXCEPTION VDVENDAEX03; /*Valor liberado insuficiente*/
    END
    ELSE
      EXCEPTION VDVENDAEX02; /*Venda no foi liberada*/
  END
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "FNSALDOLANCA"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODEMPPN" INTEGER NOT NULL,
"CODFILIALPN" INTEGER NOT NULL,
"CODPLAN" CHAR(13) CHARACTER SET NONE NOT NULL,
"DATASL" DATE NOT NULL,
"PREVSL" "NUMERICDN",
"SALDOSL" "NUMERICDN" NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "FNSALDOPLANSP"("ICODEMPPN" INTEGER,
"ICODFILIALPN" INTEGER,
"SCODPLANANT" CHAR(13) CHARACTER SET NONE,
"DDATAANT" DATE,
"DVLRANT" NUMERIC(15,5),
"SCODPLANATU" CHAR(13) CHARACTER SET NONE,
"DDATAATU" DATE,
"DVLRATU" NUMERIC(15,5))
 RETURNS("SRETORNO" CHAR(1) CHARACTER SET NONE)
 AS
DECLARE VARIABLE sCodPlan CHAR(13);
  DECLARE VARIABLE dDataSl DATE;
  DECLARE VARIABLE dTmp DATE;
  DECLARE VARIABLE dSaldoSl NUMERIC(15, 5);
  DECLARE VARIABLE dSaldoSlAnt NUMERIC(15, 5);
  DECLARE VARIABLE IFILIALSALDO INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMPPN,'FNSALDOLANCA') INTO IFILIALSALDO;
  IF (dVlrAnt IS NULL) THEN
     dVlrAnt = 0;
  IF (dVlrAtu IS NULL) THEN
     dVlrAtu = 0;
  IF ((sCodPlanAnt IS NOT NULL) AND (rtrim(sCodPlanAnt) != '')) THEN
  BEGIN
    SELECT CODPLAN,DATASL,SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodPlanAnt
           AND DATASL =: dDataAnt AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
           AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO sCodPlan,dDataSl,dSaldoSl;
    IF ((sCodPlan = sCodPlanAnt) AND (dDataSl = dDataAnt)) THEN
    BEGIN
      UPDATE FNSALDOLANCA SET SALDOSL =:dSaldoSl-:dVlrAnt WHERE CODPLAN=:sCodPlanAnt
             AND DATASL =:dDataAnt AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
             AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN;
      FOR SELECT DATASL,SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodplanAnt
          AND DATASL >:dDataAnt AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
          AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO :dTmp,:dSaldoSlAnt DO
      BEGIN
         if (:dSaldoSlAnt IS NULL) THEN
            dSaldoSlAnt = 0;
         UPDATE FNSALDOLANCA SET SALDOSL = :dSaldoSlAnt-:dVlrAnt WHERE CODPLAN=:sCodplanAnt
                AND DATASL =:dTmp AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
                AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN;
        SUSPEND;
      END
    END
    ELSE
    BEGIN
      SELECT SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodPlanAnt
             AND DATASL<:dDataAnt AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
             AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO dSaldoSlAnt;
      IF (dSaldoSlAnt IS NULL) THEN
          dSaldoSlAnt = 0;
      INSERT INTO FNSALDOLANCA (CODEMP,CODFILIAL,CODPLAN,CODFILIALPN,CODEMPPN,DATASL,PREVSL,SALDOSL)
             VALUES (
                    :ICODEMPPN,:IFILIALSALDO,:sCodPlanAnt,:ICODEMPPN,:ICODFILIALPN,:dDataAnt,0,:dSaldoSlAnt-:dVlrAnt
             );
      FOR SELECT DATASL,SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodplanAnt
                 AND DATASL >:dDataAnt AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
                 AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO :dTmp,:dSaldoSlAnt DO
      BEGIN
        if (:dSaldoSlAnt IS NULL) THEN
           dSaldoSlAnt = 0;
        UPDATE FNSALDOLANCA SET SALDOSL = :dSaldoSlAnt-:dVlrAnt WHERE CODPLAN=:sCodplanAnt
               AND DATASL =:dTmp AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
               AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN;
        SUSPEND;
      END
    END
  END
  IF ( (sCodPlanAtu IS NOT NULL) AND (rtrim(sCodPlanAtu) != '')) THEN
  BEGIN
    SELECT CODPLAN,DATASL,SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodPlanAtu
           AND DATASL =: dDataAtu AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
  AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO sCodPlan,dDataSl,dSaldoSl;
    IF ((sCodPlan = sCodPlanAtu) AND (dDataSl = dDataAtu)) THEN
    BEGIN
      UPDATE FNSALDOLANCA SET SALDOSL =:dSaldoSl+:dVlrAtu WHERE CODPLAN=:sCodPlanAtu
             AND DATASL =:dDataAtu AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
             AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN;
      FOR SELECT DATASL,SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodplanAtu
                 AND DATASL >:dDataAtu AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
                 AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO :dTmp,:dSaldoSlAnt DO
      BEGIN
        if (:dSaldoSlAnt IS NULL) THEN
           dSaldoSlAnt = 0;
        UPDATE FNSALDOLANCA SET SALDOSL = :dSaldoSlAnt+:dVlrAtu WHERE CODPLAN=:sCodplanAtu
               AND DATASL =:dTmp AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
               AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN;
        SUSPEND;
      END
    END
    ELSE
    BEGIN
      SELECT SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodPlanAtu
             AND DATASL<:dDataAtu AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
             AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO dSaldoSlAnt;
      IF (dSaldoSlAnt IS NULL) THEN
          dSaldoSlAnt = 0;
      INSERT INTO FNSALDOLANCA (CODEMP,CODFILIAL,CODPLAN,CODEMPPN,CODFILIALPN,DATASL,PREVSL,SALDOSL)
             VALUES (
                    :ICODEMPPN,:IFILIALSALDO,:sCodPlanAtu,:ICODEMPPN,:ICODFILIALPN,:dDataAtu,0,:dSaldoSlAnt+:dVlrAtu
             );
      FOR SELECT DATASL,SALDOSL FROM FNSALDOLANCA WHERE CODPLAN=:sCodplanAtu
                 AND DATASL >:dDataAtu AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
                 AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN INTO :dTmp,:dSaldoSlAnt DO
      BEGIN
        if (:dSaldoSlAnt IS NULL) THEN
           dSaldoSlAnt = 0;
        UPDATE FNSALDOLANCA SET SALDOSL = :dSaldoSlAnt+:dVlrAtu WHERE CODPLAN=:sCodplanAtu
               AND DATASL =:dTmp AND CODEMP=:ICODEMPPN AND CODFILIAL=:IFILIALSALDO
               AND CODEMP=:ICODEMPPN AND CODFILIAL=:ICODFILIALPN;
        SUSPEND;
      END
    END
  END
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "TKHISTORICO"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODHISTTK" INTEGER NOT NULL,
"DATAHISTTK" DATE NOT NULL,
"HORAHISTTK" TIME NOT NULL,
"CODEMPCO" INTEGER,
"CODFILIALCO" SMALLINT,
"CODCTO" INTEGER,
"CODEMPCL" INTEGER,
"CODFILIALCL" SMALLINT,
"CODCLI" INTEGER,
"DESCHISTTK" VARCHAR(10000) CHARACTER SET NONE NOT NULL,
"CODEMPAE" INTEGER NOT NULL,
"CODFILIALAE" SMALLINT NOT NULL,
"CODATEND" INTEGER NOT NULL,
"SITHISTTK" CHAR(2) CHARACTER SET NONE NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"TIPOHISTTK" CHAR(1) CHARACTER SET NONE DEFAULT 'H');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "GERAVISITASSP"("NUMVISITAS" INTEGER,
"TIPOVISITA" CHAR(10) CHARACTER SET NONE,
"CODATEND" INTEGER,
"CODFILIALATEND" INTEGER,
"CODEMPATEND" INTEGER,
"CODCLI" INTEGER,
"CODFILIALCLI" INTEGER,
"CODEMPCLI" INTEGER,
"DATA" DATE)
 AS
begin
INSERT INTO tkhistorico (CODEMP,CODFILIAL,CODHISTTK,DESCHISTTK,SITHISTTK,DATAHISTTK,HORAHISTTK,CODEMPCL,CODFILIALCL,CODCLI,CODEMPAE,CODFILIALAE,CODATEND,TIPOHISTTK)
VALUES(4,1,coalesce((SELECT MAX(CODHISTTK) from tkhistorico)+1,1),'VISITA','EF',:DATA,(CAST('now' AS TIME)),:CODEMPCLI,:CODFILIALCLI,:CODCLI,:CODEMPATEND,:CODFILIALATEND,:CODATEND,:TIPOVISITA);
suspend;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "LFCLFISCAL"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODFISC" CHAR(13) CHARACTER SET NONE NOT NULL,
"DESCFISC" CHAR(50) CHARACTER SET NONE NOT NULL,
"TIPOFISC" CHAR(2) CHARACTER SET NONE NOT NULL,
"TPREDICMSFISC" CHAR(1) CHARACTER SET NONE DEFAULT 'B' NOT NULL,
"ALIQFISC" NUMERIC(6,2),
"ALIQLFISC" NUMERIC(6,2),
"REDFISC" NUMERIC(6,2),
"ALIQIPIFISC" NUMERIC(6,2),
"CODEMPRA" INTEGER NOT NULL,
"CODFILIALRA" SMALLINT NOT NULL,
"CODREGRA" CHAR(4) CHARACTER SET NONE NOT NULL,
"ORIGFISC" CHAR(1) CHARACTER SET NONE,
"CODEMPTT" INTEGER,
"CODFILIALTT" SMALLINT,
"CODTRATTRIB" CHAR(2) CHARACTER SET NONE,
"CODEMPME" INTEGER,
"CODFILIALME" SMALLINT,
"CODMENS" INTEGER,
"SITPISFISC" CHAR(1) CHARACTER SET NONE DEFAULT 'T',
"SITCOFINSFISC" CHAR(1) CHARACTER SET NONE DEFAULT 'T',
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
CREATE TABLE "LFITCLFISCAL"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" INTEGER NOT NULL,
"CODFISC" CHAR(13) CHARACTER SET NONE NOT NULL,
"CODITFISC" INTEGER NOT NULL,
"ORIGFISC" CHAR(1) CHARACTER SET NONE NOT NULL,
"CODEMPTT" INTEGER NOT NULL,
"CODFILIALTT" INTEGER NOT NULL,
"TIPOFISC" CHAR(2) CHARACTER SET NONE NOT NULL,
"TPREDICMSFISC" CHAR(1) CHARACTER SET NONE DEFAULT 'B' NOT NULL,
"REDFISC" NUMERIC(9,2),
"CODTRATTRIB" CHAR(2) CHARACTER SET NONE NOT NULL,
"NOUFITFISC" CHAR(1) CHARACTER SET WIN1252 DEFAULT 'N' NOT NULL,
"CODEMPFC" INTEGER,
"CODFILIALFC" INTEGER,
"CODFISCCLI" INTEGER,
"ALIQFISC" NUMERIC(9,2),
"ALIQLFISC" NUMERIC(9,2),
"ALIQIPIFISC" NUMERIC(6,2) DEFAULT 0 NOT NULL,
"CODEMPME" INTEGER,
"CODFILIALME" SMALLINT,
"CODMENS" INTEGER,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
CREATE TABLE "SGFILIAL"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"RAZFILIAL" CHAR(50) CHARACTER SET NONE NOT NULL,
"NOMEFILIAL" CHAR(50) CHARACTER SET NONE NOT NULL,
"MZFILIAL" CHAR(1) CHARACTER SET NONE NOT NULL,
"CNPJFILIAL" CHAR(14) CHARACTER SET NONE,
"INSCFILIAL" CHAR(15) CHARACTER SET NONE,
"ENDFILIAL" CHAR(50) CHARACTER SET NONE,
"NUMFILIAL" INTEGER,
"COMPLFILIAL" CHAR(20) CHARACTER SET NONE,
"BAIRFILIAL" CHAR(30) CHARACTER SET NONE,
"CEPFILIAL" CHAR(8) CHARACTER SET NONE,
"CIDFILIAL" CHAR(30) CHARACTER SET NONE,
"UFFILIAL" CHAR(2) CHARACTER SET NONE,
"FONEFILIAL" CHAR(12) CHARACTER SET NONE,
"FAXFILIAL" CHAR(8) CHARACTER SET NONE,
"EMAILFILIAL" CHAR(50) CHARACTER SET NONE,
"WWWFILIAL" CHAR(50) CHARACTER SET NONE,
"CODDISTFILIAL" INTEGER,
"PERCPISFILIAL" NUMERIC(5,2) DEFAULT 0,
"PERCCOFINSFILIAL" NUMERIC(5,2) DEFAULT 0,
"PERCIRFILIAL" NUMERIC(5,2) DEFAULT 0,
"PERCCSOCIALFILIAL" NUMERIC(5,2) DEFAULT 0,
"SIMPLESFILIAL" CHAR(1) CHARACTER SET NONE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "LFBUSCAFISCALSP"("FILIALATUAL" INTEGER,
"CODEMP" INTEGER,
"CODFILIAL" INTEGER,
"CODPROD" INTEGER,
"CODEMPCL" INTEGER,
"CODFILIALCL" INTEGER,
"CODCLI" INTEGER)
 RETURNS("ORIGFISC" CHAR(1) CHARACTER SET NONE,
"CODTRATTRIB" CHAR(2) CHARACTER SET NONE,
"REDFISC" NUMERIC(9,2),
"TIPOFISC" CHAR(2) CHARACTER SET NONE,
"CODMENS" INTEGER,
"ALIQFISC" NUMERIC(9,2),
"ALIQIPIFISC" NUMERIC(9,2),
"TPREDICMSFISC" CHAR(1) CHARACTER SET NONE)
 AS
DECLARE VARIABLE NOESTCLI CHAR(1);
DECLARE VARIABLE ITMP INTEGER;
DECLARE VARIABLE CODFISCCLI INTEGER;
DECLARE VARIABLE CODEMPFC INTEGER;
DECLARE VARIABLE CODFILIALFC INTEGER;
BEGIN
 SELECT (SELECT COUNT(F.UFFILIAL) FROM SGFILIAL F
  WHERE F.CODEMP=:CODEMP AND F.CODFILIAL=:FILIALATUAL
  AND F.UFFILIAL=C.UFCLI), CODFISCCLI,CODEMPFC,CODFILIALFC
  FROM VDCLIENTE C WHERE C.CODCLI=:CODCLI
  AND C.CODEMP=:CODEMPCL AND C.CODFILIAL=:CODFILIALCL
 INTO ITMP,CODFISCCLI,CODEMPFC,CODFILIALFC;

 IF (ITMP > 0) THEN
  NOESTCLI='S';
 ELSE
  NOESTCLI='N';


 FOR SELECT IT.ORIGFISC,IT.CODTRATTRIB,IT.REDFISC,IT.ALIQFISC,
    IT.TIPOFISC,IT.CODMENS,IT.ALIQIPIFISC, IT.TPREDICMSFISC
  FROM LFITCLFISCAL IT, EQPRODUTO P WHERE P.CODPROD=:CODPROD
  AND P.CODFILIAL=:CODFILIAL AND P.CODEMP=P.CODEMP
  AND IT.CODEMP=P.CODEMPFC AND IT.CODFILIAL=P.CODFILIALFC
  AND IT.CODFISC=P.CODFISC AND IT.NOUFITFISC=:NOESTCLI
  AND (
           (IT.CODFISCCLI IS NULL AND :CODFISCCLI IS NOT NULL)
        OR (IT.CODFISCCLI IS NULL AND :CODFISCCLI IS NULL)
        OR (IT.CODFISCCLI=:CODFISCCLI AND IT.CODEMPFC=:CODEMPFC AND IT.CODFILIALFC=:CODFILIALFC)
      )
  ORDER BY IT.CODITFISC
 INTO ORIGFISC,CODTRATTRIB,REDFISC,ALIQFISC,TIPOFISC,CODMENS, ALIQIPIFISC, TPREDICMSFISC DO
 BEGIN
/*   EXCEPTION VDVENDAEX01; */
   SUSPEND;
   EXIT;
 END

/*S vem para c se as SELECTs acima no tiverem retornado nenhum valor.*/

 SELECT F.ORIGFISC,F.CODTRATTRIB,F.REDFISC,F.ALIQFISC,F.TIPOFISC, F.ALIQIPIFISC, F.TPREDICMSFISC
  FROM LFCLFISCAL F, EQPRODUTO P WHERE P.CODPROD=:CODPROD
  AND P.CODFILIAL=:CODFILIAL AND P.CODEMP=:CODEMP
  AND F.CODEMP=P.CODEMPFC AND F.CODFILIAL=P.CODFILIALFC AND F.CODFISC=P.CODFISC
 INTO ORIGFISC,CODTRATTRIB,REDFISC,ALIQFISC,TIPOFISC, ALIQIPIFISC, TPREDICMSFISC;
 SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "LFNATOPER"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODNAT" CHAR(4) CHARACTER SET NONE NOT NULL,
"DESCNAT" CHAR(60) CHARACTER SET NONE NOT NULL,
"IMPDTSAIDANAT" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL,
"ALIQENAT" NUMERIC(6,2) DEFAULT 0 NOT NULL,
"ALIQFNAT" NUMERIC(6,2) DEFAULT 0 NOT NULL,
"TXTNAT" VARCHAR(500) CHARACTER SET NONE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
CREATE TABLE "LFTABICMS"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" INTEGER NOT NULL,
"UFTI" CHAR(2) CHARACTER SET NONE NOT NULL,
"ALIQTI" NUMERIC(9,2) NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
CREATE TABLE "LFITNATOPER"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" INTEGER NOT NULL,
"CODNAT" CHAR(4) CHARACTER SET NONE NOT NULL,
"CODITNATOPER" INTEGER NOT NULL,
"CODEMPTI" INTEGER NOT NULL,
"CODFILIALTI" INTEGER NOT NULL,
"UFTI" CHAR(2) CHARACTER SET NONE NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "LFBUSCAICMSSP"("CODNAT" CHAR(4) CHARACTER SET NONE,
"ESTCLI" CHAR(2) CHARACTER SET NONE,
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT)
 RETURNS("PERCICMS" NUMERIC(9,2))
 AS
DECLARE VARIABLE EstEmp CHAR(2);
BEGIN
  SELECT UFFILIAL FROM SGFILIAL WHERE CODEMP=:ICODEMP
    AND CODFILIAL=:ICODFILIAL INTO :EstEmp;
  IF (EstCli = EstEmp) then
    SELECT ALIQENAT FROM LFNATOPER WHERE CODNAT=:CodNat
           AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO :PercICMS;
  ELSE
  BEGIN
    SELECT TI.ALIQTI FROM LFTABICMS TI, LFITNATOPER INO WHERE
      TI.CODEMP = INO.CODEMPTI AND TI.CODFILIAL=INO.CODFILIALTI
      AND TI.UFTI = INO.UFTI AND INO.CODEMP=:ICODEMP AND
      INO.CODFILIAL=:ICODFILIAL AND INO.CODNAT=:CodNat AND
      INO.UFTI=:EstCli INTO :PercICMS;
    IF (PercICMS IS NULL) THEN
      SELECT ALIQFNAT FROM LFNATOPER WHERE CODNAT=:CodNat
        AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO :PercICMS;
  END
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "LFITREGRAFISCAL"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODREGRA" CHAR(4) CHARACTER SET NONE NOT NULL,
"CODNAT" CHAR(4) CHARACTER SET NONE NOT NULL,
"NOUFITRF" CHAR(1) CHARACTER SET NONE NOT NULL,
"CVITRF" CHAR(1) CHARACTER SET NONE NOT NULL,
"CODEMPTM" INTEGER,
"CODFILIALTM" SMALLINT,
"CODTIPOMOV" INTEGER,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "LFBUSCANATSP"("FILIALATUAL" INTEGER,
"CODEMP" INTEGER,
"CODFILIAL" INTEGER,
"CODPROD" INTEGER,
"CODEMPCL" INTEGER,
"CODFILIALCL" INTEGER,
"CODCLI" INTEGER,
"CODEMPFR" INTEGER,
"CODFILIALFR" INTEGER,
"CODFOR" INTEGER,
"CODFILIALTM" SMALLINT,
"CODTIPOMOV" INTEGER)
 RETURNS("CODNAT" CHAR(4) CHARACTER SET NONE)
 AS
DECLARE VARIABLE NOEST CHAR;
  DECLARE VARIABLE CV CHAR;
  DECLARE VARIABLE ITMP INTEGER;
BEGIN
 IF (CODFOR IS NULL) THEN
 BEGIN
  SELECT COUNT(F.UFFILIAL) FROM SGFILIAL F, VDCLIENTE C
   WHERE F.CODEMP=:CODEMP AND F.CODFILIAL=:FILIALATUAL
   AND C.CODCLI=:CODCLI AND C.CODEMP=:CODEMPCL
   AND C.CODFILIAL=:CODFILIALCL AND F.UFFILIAL=C.UFCLI INTO ITMP;
  CV = 'V';
 END
 ELSE
 BEGIN
  SELECT COUNT(F.UFFILIAL) FROM SGFILIAL F, CPFORNECED FO
   WHERE F.CODEMP=:CODEMP AND F.CODFILIAL=:FILIALATUAL
   AND FO.CODFOR=:CODFOR AND FO.CODEMP=:CODEMPFR
   AND FO.CODFILIAL=:CODFILIALFR AND F.UFFILIAL=FO.UFFOR INTO ITMP;
  CV = 'C';
 END

 IF (ITMP > 0) THEN
  NOEST='S';
 ELSE
  NOEST='N';

 SELECT FIRST 1 R.CODNAT FROM EQPRODUTO P, LFITREGRAFISCAL R, LFCLFISCAL C WHERE
   P.CODPROD=:CODPROD AND P.CODFILIAL=:CODFILIAL AND P.CODEMP=:CODEMP
   AND C.CODFISC = P.CODFISC AND C.CODFILIAL = P.CODFILIALFC
   AND C.CODEMP = P.CODEMPFC AND R.CODREGRA = C.CODREGRA
   AND R.CODFILIAL = C.CODFILIALRA AND R.CODEMP = C.CODEMPRA
   AND R.CODEMPTM=:CODEMP AND R.CODFILIALTM=:CODFILIALTM AND
   R.CODTIPOMOV=:CODTIPOMOV AND R.CVITRF=:CV AND NOUFITRF=:NOEST
 INTO CODNAT;
 IF (CODNAT IS NULL) THEN
 BEGIN
   SELECT FIRST 1 R.CODNAT FROM EQPRODUTO P, LFITREGRAFISCAL R, LFCLFISCAL C WHERE
     P.CODPROD=:CODPROD AND P.CODFILIAL=:CODFILIAL AND P.CODEMP=:CODEMP
     AND C.CODFISC = P.CODFISC AND C.CODFILIAL = P.CODFILIALFC
     AND C.CODEMP = P.CODEMPFC AND R.CODREGRA = C.CODREGRA
     AND R.CODFILIAL = C.CODFILIALRA AND R.CODEMP = C.CODEMPRA
     AND R.CVITRF=:CV AND NOUFITRF=:NOEST
   INTO CODNAT;
 END
 SUSPEND;

END
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "LFSERIE"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"SERIE" CHAR(4) CHARACTER SET NONE NOT NULL,
"DOCSERIE" INTEGER DEFAULT 1 NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "LFNOVODOCSP"("SSERIE" CHAR(4) CHARACTER SET NONE,
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT)
 RETURNS("DOC" INTEGER)
 AS
BEGIN
  SELECT DOCSERIE FROM LFSERIE WHERE SERIE=:sSerie
         AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO :Doc;
  IF ((Doc IS NULL) OR (Doc = 0)) THEN
    Doc = 1;
  ELSE
    Doc = Doc + 1;
  UPDATE LFSERIE SET DOCSERIE=:Doc WHERE SERIE=:sSerie
         AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL;
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "PPOP"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODOP" INTEGER NOT NULL,
"SEQOP" SMALLINT DEFAULT 0 NOT NULL,
"DTEMITOP" DATE DEFAULT 'now' NOT NULL,
"CODEMPPD" INTEGER NOT NULL,
"CODFILIALPD" SMALLINT NOT NULL,
"CODPROD" INTEGER NOT NULL,
"SEQEST" SMALLINT DEFAULT 0 NOT NULL,
"REFPROD" CHAR(13) CHARACTER SET NONE NOT NULL,
"DTFABROP" DATE NOT NULL,
"QTDPREVPRODOP" "NUMERICDN" NOT NULL,
"QTDFINALPRODOP" "NUMERICDN" DEFAULT 0 NOT NULL,
"DTVALIDPDOP" DATE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"SITOP" CHAR(2) CHARACTER SET NONE DEFAULT 'II' NOT NULL,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"CODEMPLE" INTEGER,
"CODFILIALLE" SMALLINT,
"CODLOTE" CHAR(13) CHARACTER SET NONE,
"CODEMPTM" INTEGER NOT NULL,
"CODFILIALTM" SMALLINT NOT NULL,
"CODTIPOMOV" INTEGER NOT NULL,
"CODEMPAX" INTEGER NOT NULL,
"CODFILIALAX" SMALLINT NOT NULL,
"CODALMOX" INTEGER NOT NULL,
"JUSTFICQTDPROD" VARCHAR(500) CHARACTER SET NONE,
"CODEMPOPM" INTEGER,
"CODFILIALOPM" SMALLINT,
"CODOPM" INTEGER,
"SEQOPM" SMALLINT,
"QTDDISTPOP" "NUMERICDN" DEFAULT 0 NOT NULL,
"QTDDISTIOP" "NUMERICDN" DEFAULT 0 NOT NULL);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "PPATUDISTOPSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODOP" INTEGER,
"SSEQOP" SMALLINT,
"NQTDDISTOLD" NUMERIC(15,5),
"NQTDDISTNEW" NUMERIC(15,5))
 AS
begin
  if (NQTDDISTOLD is null) then
     NQTDDISTOLD = 0;
  if (NQTDDISTNEW is null) then
     NQTDDISTNEW = 0;
  if (NQTDDISTOLD!=NQTDDISTNEW) then
     UPDATE PPOP SET QTDDISTPOP = QTDDISTPOP + (:NQTDDISTNEW-:NQTDDISTOLD)
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL AND
          CODOP=:ICODOP AND SEQOP=:SSEQOP ;
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "PPITESTRUTURA"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODPROD" INTEGER NOT NULL,
"SEQEST" SMALLINT DEFAULT 0 NOT NULL,
"SEQITEST" SMALLINT NOT NULL,
"CODEMPPD" INTEGER NOT NULL,
"CODFILIALPD" SMALLINT NOT NULL,
"CODPRODPD" INTEGER NOT NULL,
"CODEMPFS" INTEGER NOT NULL,
"CODFILIALFS" SMALLINT NOT NULL,
"CODFASE" INTEGER NOT NULL,
"SEQEF" SMALLINT NOT NULL,
"QTDITEST" "NUMERICDN" NOT NULL,
"RMAAUTOITEST" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"REFPROD" CHAR(13) CHARACTER SET NONE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"REFPRODPD" CHAR(13) CHARACTER SET NONE);
COMMIT WORK;
CREATE TABLE "PPESTRUTURA"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODPROD" INTEGER NOT NULL,
"SEQEST" SMALLINT DEFAULT 0 NOT NULL,
"DESCEST" CHAR(50) CHARACTER SET NONE NOT NULL,
"QTDEST" "NUMERICDN" NOT NULL,
"REFPROD" CHAR(13) CHARACTER SET NONE NOT NULL,
"ATIVOEST" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"CODEMPML" INTEGER,
"CODFILIALML" SMALLINT,
"CODMODLOTE" INTEGER,
"NRODIASVALID" SMALLINT,
"GLOTEOPP" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "PPCUSTOPRODSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODPROD" INTEGER,
"DTESTOQ" DATE,
"CTIPOCUSTO" CHAR(1) CHARACTER SET NONE,
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER,
"CCOMSALDO" CHAR(10) CHARACTER SET NONE)
 RETURNS("CUSTOUNIT" NUMERIC(15,5),
"SLDPROD" NUMERIC(15,5))
 AS
DECLARE VARIABLE QTDITEST NUMERIC(15,5);
DECLARE VARIABLE SEQEST SMALLINT;
DECLARE VARIABLE TIPOPROD CHAR(1);
DECLARE VARIABLE CUSTOTOT NUMERIC(15,5);
DECLARE VARIABLE CODPRODPD INTEGER;
begin
  /* Retorna o custo unitrio do produto */
  IF (CTIPOCUSTO IS NULL) then
     CTIPOCUSTO = 'P';

  SELECT P.TIPOPROD
   FROM EQPRODUTO P
   WHERE P.CODEMP = :ICODEMP AND P.CODFILIAL = :SCODFILIAL AND
      P.CODPROD=:ICODPROD
   INTO :TIPOPROD;

  IF (TIPOPROD='F') THEN
  BEGIN
     SELECT SLDPROD FROM EQCUSTOPRODSP(:ICODEMP, :SCODFILIAL, :ICODPROD,
        :DTESTOQ, :CTIPOCUSTO,  :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, 'N')
     INTO :SLDPROD;

     CUSTOTOT = 0;

     SELECT FIRST 1 E.SEQEST FROM PPESTRUTURA E
       WHERE E.CODEMP=:ICODEMP AND E.CODFILIAL=:SCODFILIAL AND E.CODPROD=:ICODPROD
       ORDER BY E.SEQEST INTO :SEQEST;

     FOR SELECT I.CODPRODPD,I.QTDITEST FROM  PPITESTRUTURA I
        WHERE I.CODEMP=:ICODEMP AND I.CODFILIAL=:SCODFILIAL AND
          I.CODPROD=:ICODPROD AND I.SEQEST=:SEQEST
        INTO :CODPRODPD, :QTDITEST DO
     BEGIN
         SELECT CUSTOUNIT FROM PPCUSTOPRODSP(:ICODEMP, :SCODFILIAL, :CODPRODPD, :DTESTOQ,
            :CTIPOCUSTO, :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, :CCOMSALDO)
         INTO :CUSTOUNIT;
         CUSTOTOT = CUSTOTOT + ( CUSTOUNIT * QTDITEST)  ;
     END
  END
  ELSE
  BEGIN
     SELECT CUSTOUNIT,SLDPROD FROM EQCUSTOPRODSP(:ICODEMP, :SCODFILIAL, :ICODPROD,
        :DTESTOQ, :CTIPOCUSTO,  :ICODEMPAX, :SCODFILIALAX, :ICODALMOX, 'N')
     INTO :CUSTOTOT, :SLDPROD;
  END
  CUSTOUNIT = CUSTOTOT;
  SUSPEND;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "PPRECURSO"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODRECP" INTEGER NOT NULL,
"DESCRECP" CHAR(50) CHARACTER SET NONE NOT NULL,
"CODEMPTR" INTEGER NOT NULL,
"CODFILIALTR" SMALLINT NOT NULL,
"CODTPREC" INTEGER NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
CREATE TABLE "PPESTRUFASE"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODPROD" INTEGER NOT NULL,
"SEQEST" SMALLINT DEFAULT 0 NOT NULL,
"SEQEF" SMALLINT NOT NULL,
"CODEMPFS" INTEGER NOT NULL,
"CODFILIALFS" SMALLINT NOT NULL,
"CODFASE" INTEGER NOT NULL,
"CODEMPTR" INTEGER NOT NULL,
"CODFILIALTR" SMALLINT NOT NULL,
"CODTPREC" INTEGER NOT NULL,
"TEMPOEF" "NUMERICDN" DEFAULT 0 NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"FINALIZAOP" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"INSTRUCOES" VARCHAR(5000) CHARACTER SET NONE);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "PPITOPSP01"("ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT,
"ICODOP" INTEGER,
"ISEQOP" SMALLINT)
 AS
DECLARE VARIABLE ICODEMPPD INTEGER;
DECLARE VARIABLE ICODFILIALPD SMALLINT;
DECLARE VARIABLE GERARMA CHAR(1);
DECLARE VARIABLE CREFPROD CHAR(13);
DECLARE VARIABLE ISEQITEST SMALLINT;
DECLARE VARIABLE ICODPRODPD INTEGER;
DECLARE VARIABLE NQTDITOP NUMERIC(15,5);
DECLARE VARIABLE ICODEMPLE INTEGER;
DECLARE VARIABLE ICODFILIALLE SMALLINT;
DECLARE VARIABLE CCODLOTE CHAR(13);
DECLARE VARIABLE ICODEMPFS INTEGER;
DECLARE VARIABLE ICODFILIALFS SMALLINT;
DECLARE VARIABLE ICODFASE INTEGER;
DECLARE VARIABLE ICODEMPTR INTEGER;
DECLARE VARIABLE ICODFILIALTR SMALLINT;
DECLARE VARIABLE ICODTPREC INTEGER;
DECLARE VARIABLE ICODEMPRP INTEGER;
DECLARE VARIABLE ICODFILIALRP SMALLINT;
DECLARE VARIABLE ICODRECP INTEGER;
DECLARE VARIABLE DTEMPOOF NUMERIC(15,5);
DECLARE VARIABLE ISEQOF SMALLINT;
DECLARE VARIABLE ISEQPPITOP INTEGER;
BEGIN
   FOR SELECT EF.SEQEF, EF.CODEMPFS, EF.CODFILIALFS, EF.CODFASE,
      EF.CODEMPTR, EF.CODFILIALTR, EF.CODTPREC, EF.TEMPOEF
      FROM PPESTRUFASE EF, PPOP O, PPESTRUTURA E
      WHERE O.CODEMP=:iCodEmp AND O.CODFILIAL=:iCodFilial AND
       O.CODOP=:iCodOp AND O.SEQOP=:iSEQOP AND E.CODEMP=O.CODEMPPD AND
       E.CODFILIAL=O.CODFILIALPD AND
       E.CODPROD=O.CODPROD AND E.SEQEST=O.SEQEST AND
       EF.CODEMP=E.CODEMP AND EF.CODFILIAL=E.CODFILIAL AND
       EF.CODPROD=E.CODPROD AND EF.SEQEST=E.SEQEST
       INTO :iSeqOf, :iCodEmpFs, :iCodFilialFs, :iCodFase,
         :iCodEmpTr, :iCodFilialTr, :iCodTpRec, :dTempoOf
         DO
   BEGIN
       SELECT FIRST 1 CODEMP,CODFILIAL,CODRECP FROM PPRECURSO R
         WHERE R.CODEMP=:iCodEmpTr AND R.CODFILIAL=:iCodFilialTr AND
           R.CODTPREC=:iCodTpRec
         INTO :iCodEmpRp, :iCodFilialRp, :iCodRecP;

       INSERT INTO PPOPFASE (CODEMP,CODFILIAL,CODOP,SEQOP,SEQOF,CODEMPFS,
          CODFILIALFS,CODFASE,CODEMPRP,CODFILIALRP,CODRECP,TEMPOOF,
          CODEMPTR, CODFILIALTR, CODTPREC)
          VALUES (:iCodEmp,:iCodFilial,:iCodOp,:iSeqOp, :iSeqOf,:iCodEmpFs,
          :iCodFilialFs,:iCodFase,:iCodEmpRp,:iCodFilialRp,:iCodRecP,:dTempoOf,
          :iCodEmpTr, :iCodFilialTr, :iCodTpRec);
   END

   ISEQPPITOP = 0;

   FOR SELECT IE.CODEMPPD,IE.CODFILIALPD,IE.SEQITEST,IE.CODPRODPD,IE.REFPRODPD,
     IE.RMAAUTOITEST, IE.CODEMPFS,IE.CODFILIALFS,IE.CODFASE,
     CAST( IE.QTDITEST / E.QTDEST AS NUMERIC(15,5) )
     * CAST(O.QTDPREVPRODOP AS NUMERIC(15, 5)),
     (SELECT MIN(L.CODLOTE) FROM EQLOTE L WHERE
     L.CODEMP=E.CODEMP AND L.CODFILIAL=E.CODFILIAL AND
     L.CODPROD=E.CODPROD AND L.SLDLIQLOTE>0 AND L.VENCTOLOTE =
     ( SELECT MIN(LS.VENCTOLOTE) FROM EQLOTE LS WHERE LS.CODPROD=L.CODPROD
     AND LS.CODFILIAL=L.CODFILIAL AND LS.CODEMP=L.CODEMP AND LS.SLDLIQLOTE>0)) CODLOTE
     FROM PPITESTRUTURA IE, PPESTRUTURA E, PPOP O
     WHERE IE.CODEMP=E.CODEMP AND IE.CODFILIAL=E.CODFILIAL AND
     IE.CODPROD=E.CODPROD AND IE.SEQEST=E.SEQEST AND
     O.CODEMPPD=E.CODEMP AND O.CODFILIALPD=E.CODFILIAL AND
     O.CODPROD=E.CODPROD AND O.SEQEST=E.SEQEST AND
     O.CODEMP=:iCodEmp AND O.CODFILIAL=:iCodFilial AND
     O.CODOP=:iCodOp AND O.SEQOP=:iSeqOp
     ORDER BY CODFASE
     INTO :iCodEmpPd, :iCodFilialPd, :iSeqItEst, :iCodProdPd,:CREFPROD,
      :GERARMA, :iCodEmpFs, :iCodFilialFs, :iCodFase,
      :nQtdItOp, :cCodLote DO
   BEGIN
     IF (:cCodLote IS NULL ) then
     BEGIN
        iCodEmpLe = null;
        iCodFilialLe = null;
     END
     ELSE
     BEGIN
        iCodEmpLe = iCodEmpPd;
        iCodFilialLe = iCodFilialPd;
     END
     ISEQPPITOP = :ISEQPPITOP + 1;
     INSERT INTO PPITOP (CODEMP,CODFILIAL,CODOP,SEQOP,SEQITOP,CODEMPPD,CODFILIALPD,
        CODPROD,REFPROD,CODEMPFS,CODFILIALFS,CODFASE,QTDITOP,GERARMA)
        VALUES (:iCodEmp, :iCodFilial, :iCodOp, :iSeqOp, :ISEQPPITOP, :iCodEmpPd, :iCodFilialPd,
        :iCodProdPd, :CREFPROD,:iCodEmpFs, :iCodFilialFs, :iCodFase, :nQtdItOp,:GERARMA);

   END
   SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "PPRELCUSTOSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"DTESTOQ" DATE,
"ICODEMPMC" INTEGER,
"SCODFILIALMC" SMALLINT,
"CCODMARCA" CHAR(6) CHARACTER SET NONE,
"ICODEMPGP" INTEGER,
"SCODFILIALGP" SMALLINT,
"CCODGRUP" CHAR(14) CHARACTER SET NONE,
"CTIPOCUSTO" CHAR(1) CHARACTER SET NONE,
"ICODEMPAX" INTEGER,
"SCODFILIALAX" SMALLINT,
"ICODALMOX" INTEGER)
 RETURNS("CODPROD" INTEGER,
"REFPROD" CHAR(13) CHARACTER SET NONE,
"DESCPROD" CHAR(50) CHARACTER SET NONE,
"TIPOPROD" CHAR(1) CHARACTER SET NONE,
"SLDPROD" NUMERIC(15,5),
"CUSTOUNIT" NUMERIC(15,5),
"CUSTOTOT" NUMERIC(15,5))
 AS
begin
  /* Procedure Text */
  IF (ICODEMPGP IS NOT NULL) THEN
  BEGIN
    IF (STRLEN(RTRIM(CCODGRUP))<14) THEN
       CCODGRUP = RTRIM(CCODGRUP)||'%';
  END
  IF (CTIPOCUSTO IS NULL) then
     CTIPOCUSTO = 'P';

  FOR SELECT P.CODPROD,P.REFPROD,P.DESCPROD, P.TIPOPROD
   FROM EQPRODUTO P
   WHERE P.CODEMP = :ICODEMP AND P.CODFILIAL = :SCODFILIAL AND
   ( (:ICODEMPMC IS NULL) OR (P.CODEMPMC=:ICODEMPMC AND P.CODFILIALMC=:SCODFILIALMC AND
      P.CODMARCA=:CCODMARCA) ) AND
   ((:ICODEMPGP IS NULL) OR (P.CODEMPGP=:ICODEMPGP AND P.CODFILIALGP=:SCODFILIALGP AND
      P.CODGRUP LIKE :CCODGRUP) )
   INTO :CODPROD, :REFPROD, :DESCPROD, :TIPOPROD  DO
  BEGIN
     SELECT CUSTOUNIT,SLDPROD FROM PPCUSTOPRODSP(:ICODEMP,
        :SCODFILIAL, :CODPROD, :DTESTOQ, :CTIPOCUSTO, :ICODEMPAX,
        :SCODFILIALAX, :ICODALMOX, 'N')
       INTO :CUSTOUNIT, :SLDPROD;
     CUSTOTOT = CUSTOUNIT * SLDPROD;
     SUSPEND;
  END
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "PVMOVCAIXA"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODCAIXA" INTEGER NOT NULL,
"DTAMOV" DATE NOT NULL,
"NROMOV" INTEGER NOT NULL,
"TIPOMOV" CHAR(1) CHARACTER SET NONE NOT NULL,
"VLRMOV" "NUMERICDN" NOT NULL,
"VLRSLDMOV" "NUMERICDN",
"CODEMPUS" INTEGER NOT NULL,
"CODFILIALUS" SMALLINT NOT NULL,
"IDUSU" CHAR(8) CHARACTER SET NONE NOT NULL);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "PVABRECAIXASP"("ICODCAIXA" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODEMP" INTEGER,
"NVLRINICAIXA" NUMERIC(15,5),
"DDTAMOV" DATE,
"ICODFILIALUS" SMALLINT,
"CIDUSU" CHAR(8) CHARACTER SET NONE)
 AS
DECLARE VARIABLE INROMOV INTEGER;
BEGIN
    SELECT INROMOV FROM PVSEQMOVCAIXASP(:ICODEMP, :SCODFILIAL, :ICODCAIXA, :DDTAMOV) INTO :INROMOV;

    INSERT INTO PVMOVCAIXA (CODCAIXA,CODFILIAL,CODEMP,DTAMOV,NROMOV,TIPOMOV,VLRSLDMOV,VLRMOV,CODEMPUS,CODFILIALUS,IDUSU) VALUES
      (:iCodCaixa,:sCodFilial,:iCodEmp,:DDTAMOV,:INROMOV,'A',:nVlrIniCaixa,:nVlrIniCaixa,:iCodEmp,:iCodFilialUs,:cIdUsu);
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "PVADICMOVCAIXASP01"("ICODCAIXA" INTEGER,
"NVLRINICAIXA" NUMERIC(18,3),
"ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"DDTAMOV" DATE)
 AS
DECLARE VARIABLE ICODMOVCAIXA INTEGER;
BEGIN
  SELECT INROMOV FROM PVSEQMOVCAIXASP(:ICODEMP, :SCODFILIAL, :ICODCAIXA, :DDTAMOV) INTO :ICODMOVCAIXA;
  INSERT INTO PVMOVCAIXA (CODEMP,CODFILIAL,CODCAIXA,DTAMOV,NROMOV,TIPOMOV,VLRSLDMOV,VLRMOV)
         VALUES (
                :ICODEMP,:SCODFILIAL,:iCodCaixa,:DDTAMOV,
                :ICODMOVCAIXA,'A',:nVlrIniCaixa,:nVlrIniCaixa
         );
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "PVFECHACAIXASP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODCAIXA" INTEGER,
"DDTAMOV" DATE,
"REDUZ" CHAR(1) CHARACTER SET NONE,
"ICODFILIALUS" SMALLINT,
"CIDUSU" CHAR(8) CHARACTER SET NONE)
 AS
DECLARE VARIABLE ICODMOVCAIXA INTEGER;
DECLARE VARIABLE STATUSFECHA CHAR(1);
BEGIN
  SELECT INROMOV FROM PVSEQMOVCAIXASP(:ICODEMP, :SCODFILIAL, :ICODCAIXA, :DDTAMOV) INTO :ICODMOVCAIXA;

  IF (REDUZ = 'S') THEN
    STATUSFECHA = 'Z';
  ELSE
    STATUSFECHA = 'F';


  INSERT INTO PVMOVCAIXA (CODEMP,CODFILIAL,CODCAIXA,DTAMOV,NROMOV,TIPOMOV,
                          VLRMOV,CODEMPUS,CODFILIALUS,IDUSU) VALUES (
                         :ICODEMP,:SCODFILIAL,:ICODCAIXA,:DDTAMOV,
                         :ICODMOVCAIXA,:STATUSFECHA,0,:ICODEMP,:ICODFILIALUS,:CIDUSU
                         );
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "PVFECHAVENDASP"("ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT,
"NVALOR" NUMERIC(15,5),
"ITERM" INTEGER,
"DDTAMOV" DATE,
"CIDUSU" CHAR(8) CHARACTER SET NONE)
 AS
DECLARE VARIABLE ICODMOVCAIXA INTEGER;
DECLARE VARIABLE IFILIALUSU SMALLINT;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'SGUSUARIO') INTO IFILIALUSU;
  /*SELECT ISEQ FROM SPGERANUM(:ICODEMP,:ICODFILIAL,'MC') INTO ICODMOVCAIXA;*/
  SELECT INROMOV FROM PVSEQMOVCAIXASP(:ICODEMP, :ICODFILIAL, :ITERM , :DDTAMOV) INTO :ICODMOVCAIXA;
  INSERT INTO PVMOVCAIXA (CODEMP,CODFILIAL,CODCAIXA,DTAMOV,NROMOV,TIPOMOV,VLRMOV,CODEMPUS,CODFILIALUS,IDUSU)
         VALUES (
                :ICODEMP,:ICODFILIAL,:ITERM,:DDTAMOV,
                :ICODMOVCAIXA,'V',:NVALOR,:ICODEMP,:IFILIALUSU,:CIDUSU
         );
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "PVRETMOVCAIXASP"("ICODCAIXA" INTEGER,
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT,
"DDTAMOV" DATE)
 RETURNS("DDTAMOVRET" DATE,
"CTIPOMOV" CHAR(1) CHARACTER SET NONE,
"NVLRSLDMOV" NUMERIC(15,5),
"CIDUSU" CHAR(8) CHARACTER SET NONE)
 AS
BEGIN
  SELECT DTAMOV,TIPOMOV,VLRSLDMOV,IDUSU FROM PVMOVCAIXA WHERE
         NROMOV = (
                  SELECT MAX(NROMOV) FROM PVMOVCAIXA WHERE
                         CODCAIXA=:ICODCAIXA
                         AND DTAMOV =:DDTAMOV
                         AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
                  )
         AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL AND DTAMOV=:DDTAMOV AND CODCAIXA=:ICODCAIXA
         INTO :DDTAMOVRET, :CTIPOMOV, :NVLRSLDMOV, :CIDUSU;

  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "PVSANGRIASP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"NVALOR" NUMERIC(18,3),
"ICODCAIXA" INTEGER,
"DDTAMOV" DATE,
"CIDUSU" CHAR(8) CHARACTER SET NONE)
 AS
DECLARE VARIABLE ICODMOVCAIXA INTEGER;
DECLARE VARIABLE IFILIALUSU INTEGER;
BEGIN
  if (NVALOR IS NULL) then
     NVALOR = 0;
  SELECT INROMOV FROM PVSEQMOVCAIXASP(:ICODEMP, :SCODFILIAL, :ICODCAIXA, :DDTAMOV) INTO :ICODMOVCAIXA;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'SGUSUARIO') INTO IFILIALUSU;
  INSERT INTO PVMOVCAIXA (CODEMP,CODFILIAL,CODCAIXA,DTAMOV,NROMOV,TIPOMOV,VLRMOV,CODEMPUS,CODFILIALUS,IDUSU)
         VALUES (
                :ICODEMP,:SCODFILIAL,:ICODCAIXA,:DDTAMOV,
                :ICODMOVCAIXA,'S',:NVALOR*-1,:ICODEMP,:IFILIALUSU,:CIDUSU
         );
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "PVSEQMOVCAIXA"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODCAIXA" INTEGER NOT NULL,
"DTAMOV" DATE NOT NULL,
"NROMOV" INTEGER DEFAULT 0 NOT NULL,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" DATE DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "PVSEQMOVCAIXASP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODCAIXA" INTEGER,
"DDTAMOV" DATE)
 RETURNS("INROMOV" INTEGER)
 AS
begin
    SELECT NROMOV FROM PVSEQMOVCAIXA WHERE DTAMOV=:DDTAMOV AND CODCAIXA=:ICODCAIXA
          AND CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL INTO :INROMOV;
    IF (INROMOV IS NULL) THEN
    BEGIN
       INROMOV = 1;
       INSERT INTO PVSEQMOVCAIXA (DTAMOV,CODCAIXA,CODEMP,CODFILIAL,NROMOV)
          VALUES (:DDTAMOV, :ICODCAIXA, :ICODEMP, :SCODFILIAL, :INROMOV);
    END
    ELSE
    BEGIN
       INROMOV = INROMOV + 1;
       UPDATE PVSEQMOVCAIXA SET NROMOV=:INROMOV WHERE DTAMOV=:DDTAMOV AND CODCAIXA=:ICODCAIXA AND
            CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL;
    END

  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "PVSUPRIMENTOSP"("ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT,
"NVALOR" NUMERIC(18,3),
"ITERM" INTEGER,
"DDTAMOV" DATE,
"CIDUSU" CHAR(8) CHARACTER SET NONE)
 AS
DECLARE VARIABLE ICODMOVCAIXA INTEGER;
DECLARE VARIABLE IFILIALUSU INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'SGUSUARIO') INTO IFILIALUSU;
  SELECT INROMOV FROM PVSEQMOVCAIXASP(:ICODEMP, :IFILIALUSU, :ITERM, :DDTAMOV) INTO :ICODMOVCAIXA;
  INSERT INTO PVMOVCAIXA (CODEMP,CODFILIAL,CODCAIXA,DTAMOV,NROMOV,TIPOMOV,VLRMOV,CODEMPUS,CODFILIALUS,IDUSU)
         VALUES (
                :ICODEMP,:ICODFILIAL,:ITERM,:DDTAMOV,
                :ICODMOVCAIXA,'U',:NVALOR,:ICODEMP,:IFILIALUSU,:CIDUSU
         );
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "PVVALIDFAIXACAIXASP"("ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT,
"ICODCAIXA" INTEGER,
"NEWSEQINI" INTEGER,
"NEWSEQMAX" INTEGER)
 AS
DECLARE VARIABLE ISEQINI INTEGER;
DECLARE VARIABLE ISEQMAX INTEGER;
DECLARE VARIABLE VARCODCAIXA INTEGER;
begin
  /* Procedure Text */
  FOR SELECT CODCAIXA FROM PVCAIXA WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
     INTO :VARCODCAIXA DO
     BEGIN
        IF(:VARCODCAIXA<>:ICODCAIXA) THEN
           SELECT SEQINI,SEQMAX FROM PVCAIXA
              WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL AND CODCAIXA=:VARCODCAIXA
              INTO :ISEQINI, :ISEQMAX;
           IF (((NEWSEQINI >= :ISEQINI) and (NEWSEQINI <= :ISEQMAX))
                 or ((NEWSEQMAX >= :ISEQINI) and (NEWSEQMAX <= :ISEQMAX)) ) THEN
              EXCEPTION PVSEQCAIXA01 'FAIXA DE SEQUENCIA INVALIDA!';
     END
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;

SET TERM ^ ;
ALTER PROCEDURE "PVVERIFCAIXASP"("ICODCAIXA" INTEGER,
"ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"DDTAMOV" DATE,
"SCODFILIALUS" SMALLINT,
"CIDUSU" CHAR(8) CHARACTER SET NONE)
 RETURNS("IRETORNO" INTEGER)
 AS
DECLARE VARIABLE CTMP CHAR(1);
DECLARE VARIABLE CIDUSUANT CHAR(8);
DECLARE VARIABLE SCODFILIALANT SMALLINT;
DECLARE VARIABLE DULTMOV DATE;
DECLARE VARIABLE INROMOV INTEGER;
BEGIN
  iRetorno = -1;
  SELECT FIRST 1 MC.TIPOMOV, MC.IDUSU, MC.CODFILIALUS, MC.DTAMOV, MC.NROMOV
    FROM PVMOVCAIXA MC
    WHERE MC.CODCAIXA=:ICODCAIXA  AND
       MC.CODEMP=:ICODEMP AND MC.CODFILIAL=:SCODFILIAL
    ORDER BY MC.DTAMOV DESC, MC.NROMOV DESC
    INTO :cTMP, :cIDUSUANT, :SCodFilialAnt, :DULTMOV, :INROMOV;

  if ( (DULTMOV IS NULL) OR (DDTAMOV = DULTMOV) ) then
  BEGIN
     if ( (cTMP IS NULL) OR (cTMP = 'F') ) then
     BEGIN
       iRetorno = 0; /*Caixa OK*/
       SUSPEND;
       EXIT;
     END
     else if (cTMP = 'Z') then
     BEGIN
       iRetorno = 11; /*Jah foi realizada reduoZ neste dia*/
       SUSPEND;
       EXIT;
     END
     else if (cTMP in ('A','S','U','V')) then
     BEGIN
       if ( (cIDUSU=cIDUSUANT) AND (SCodFilialUs=SCodFilialAnt) )then
          iRetorno = 1; /*Caixa aberto*/
       else
          iRetorno = 12; /* Caixa aberto por outro usuatio */
       SUSPEND;
       EXIT;
     END
  END
  else if (DDTAMOV > DULTMOV) then
  BEGIN
     if ( cTMP = 'F' ) then /* Caixa anterior fechado sem reduo Z */
     BEGIN                  /* O usurio dever digitar a leitura da memria fiscal */
       iRetorno = 2;
       SUSPEND;
       EXIT;
     END
     else if (cTMP = 'Z') then
     BEGIN
       iRetorno = 0; /* Caixa anterior fechado corretamente */
       SUSPEND;
       EXIT;
     END
     else /* Caixa anterior dever ser fechado */
     BEGIN
       iRetorno = 3; /* devera fechar o caixa*/
       SUSPEND;
       EXIT;
     END
  END
  ELSE
  BEGIN /*Tentativa de abertura de caixa retroativo*/
     iRetorno = 13;
  END
  SUSPEND;
END
^
SET TERM ; ^
COMMIT WORK;
CREATE TABLE "SGAGENTE"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"TIPOAGE" CHAR(5) CHARACTER SET NONE NOT NULL,
"CODAGE" INTEGER NOT NULL,
"DESCAGE" CHAR(50) CHARACTER SET NONE NOT NULL,
"DTINS" DATE DEFAULT 'now',
"HINS" TIME DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT user,
"DTALT" DATE,
"HALT" TIME,
"IDUSUALT" CHAR(8) CHARACTER SET NONE);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "SGAGENTEISP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"CTIPOAGE" CHAR(5) CHARACTER SET NONE,
"CDESCAGE" CHAR(50) CHARACTER SET NONE)
 RETURNS("CODAGE" INTEGER)
 AS
begin
  /* Procedure para inserir agente */
  SELECT MAX(CODAGE) FROM SGAGENTE
     WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL AND
       TIPOAGE=:CTIPOAGE INTO :CODAGE;
  if (CODAGE IS NULL) then
     CODAGE = 1;
  else
     CODAGE = CODAGE+1;
  INSERT INTO SGAGENTE (CODEMP, CODFILIAL, TIPOAGE, CODAGE, DESCAGE)
     VALUES (:ICODEMP, :SCODFILIAL, :CTIPOAGE, :CODAGE, :CDESCAGE);
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "SGAGENTEUIDSP"("CIUD" CHAR(1) CHARACTER SET NONE,
"ICODEMP" INTEGER,
"CTIPOAGE" CHAR(5) CHARACTER SET NONE,
"ICODAGE" INTEGER,
"CDESCAGE" CHAR(50) CHARACTER SET NONE)
 RETURNS("CODEMP" INTEGER,
"CODFILIAL" SMALLINT,
"TIPOAGE" CHAR(5) CHARACTER SET NONE,
"CODAGE" INTEGER)
 AS
begin
  /* Procedure para inserir, atualizar e deletar AGENTES */
  CODEMP = ICODEMP;
  TIPOAGE = CTIPOAGE;
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP, 'SGAGENTE') INTO :CODFILIAL;
  if (CIUD='I') then
     SELECT CODAGE FROM SGAGENTEISP(:CODEMP, :CODFILIAL, :TIPOAGE, :CDESCAGE)
        INTO :CODAGE;
  else if (CIUD='U') then
     SELECT CODAGE FROM SGAGENTEUSP(:CODEMP, :CODFILIAL, :TIPOAGE, :ICODAGE, :CDESCAGE)
        INTO :CODAGE;
  else if (CIUD='D') then
  begin
     DELETE FROM SGAGENTE WHERE CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL AND
        TIPOAGE=:TIPOAGE AND CODAGE=:ICODAGE;
     CODAGE=:ICODAGE;
  end
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "SGAGENTEUSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"CTIPOAGE" CHAR(5) CHARACTER SET NONE,
"ICODAGE" INTEGER,
"CDESCAGE" CHAR(50) CHARACTER SET NONE)
 RETURNS("CODAGE" INTEGER)
 AS
DECLARE VARIABLE CDESCAGEOLD CHAR(50);
begin
  /* Procedure para atualizar AGENTE*/
  CODAGE = ICODAGE;
  SELECT DESCAGE FROM SGAGENTE WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL
     AND TIPOAGE=:CTIPOAGE AND CODAGE=:ICODAGE INTO :CDESCAGEOLD;
  IF ( (CDESCAGEOLD IS NOT NULL ) AND (CDESCAGEOLD!=CDESCAGE) ) THEN
     UPDATE SGAGENTE SET DESCAGE=:CDESCAGE WHERE
        CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL
           AND TIPOAGE=:CTIPOAGE AND CODAGE=:ICODAGE;
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "SGEMPRESA"("CODEMP" INTEGER NOT NULL,
"RAZEMP" CHAR(50) CHARACTER SET NONE,
"NOMEEMP" CHAR(50) CHARACTER SET NONE,
"CNPJEMP" CHAR(14) CHARACTER SET NONE,
"INSCEMP" CHAR(15) CHARACTER SET NONE,
"ENDEMP" CHAR(50) CHARACTER SET NONE,
"NUMEMP" INTEGER,
"COMPLEMP" CHAR(20) CHARACTER SET NONE,
"BAIREMP" CHAR(30) CHARACTER SET NONE,
"CEPEMP" CHAR(8) CHARACTER SET NONE,
"CIDEMP" CHAR(30) CHARACTER SET NONE,
"UFEMP" CHAR(2) CHARACTER SET NONE,
"FONEEMP" CHAR(12) CHARACTER SET NONE,
"FAXEMP" CHAR(8) CHARACTER SET NONE,
"EMAILEMP" CHAR(50) CHARACTER SET NONE,
"WWWEMP" CHAR(50) CHARACTER SET NONE,
"CODEANEMP" CHAR(6) CHARACTER SET NONE,
"CODPAISEMP" CHAR(3) CHARACTER SET NONE,
"PERCISSEMP" NUMERIC(6,2) DEFAULT 0,
"NOMECONTEMP" CHAR(40) CHARACTER SET NONE,
"MULTIALMOXEMP" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"FOTOEMP" BLOB SEGMENT SIZE 50,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "SGATUALIZABDSP"("ICODEMP" INTEGER)
 AS
DECLARE VARIABLE ICODEMPTMP INTEGER;
begin
  if (ICODEMP IS NULL) then
     ICODEMP = 99;
  /*CTEMP = printLog('Entrou no atualizabdsp '||cast(ICODEMP AS CHAR(10)));*/

  EXECUTE PROCEDURE SGDADOSINISP(:ICODEMP);
  EXECUTE PROCEDURE SGGRANTUSERSP ;
  FOR SELECT CODEMP FROM SGEMPRESA INTO :ICODEMPTMP DO
  BEGIN
     EXECUTE PROCEDURE SGOBJETOINSTBSP(:ICODEMPTMP);
     EXECUTE PROCEDURE SGGRANTADMSP(:ICODEMPTMP);
  END
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "SGUSUARIO"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"IDUSU" CHAR(8) CHARACTER SET NONE NOT NULL,
"NOMEUSU" CHAR(50) CHARACTER SET NONE NOT NULL,
"CODEMPIG" INTEGER,
"CODFILIALIG" SMALLINT,
"IDGRPUSU" CHAR(8) CHARACTER SET NONE,
"CODEMPCC" INTEGER,
"CODFILIALCC" SMALLINT,
"ANOCC" SMALLINT,
"CODCC" CHAR(19) CHARACTER SET NONE,
"PNOMEUSU" CHAR(20) CHARACTER SET NONE,
"UNOMEUSU" CHAR(20) CHARACTER SET NONE,
"COMENTUSU" VARCHAR(10000) CHARACTER SET NONE,
"BAIXOCUSTOUSU" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"CODALMOX" INTEGER,
"CODEMPAM" INTEGER,
"CODFILIALAM" SMALLINT,
"ABREGAVETAUSU" CHAR(1) CHARACTER SET NONE DEFAULT 'S',
"APROVCPSOLICITACAOUSU" CHAR(2) CHARACTER SET NONE DEFAULT 'ND',
"ALMOXARIFEUSU" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"CODEMPAE" INTEGER,
"CODFILIALAE" SMALLINT,
"TIPOAGE" CHAR(5) CHARACTER SET NONE,
"CODAGE" INTEGER,
"APROVRMAUSU" CHAR(2) CHARACTER SET NONE DEFAULT 'ND',
"COMPRASUSU" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"ALTPARCVENDA" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"APROVRECEITA" CHAR(1) CHARACTER SET NONE DEFAULT 'N');
COMMIT WORK;
CREATE TABLE "SGGRPUSU"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"IDGRPUSU" CHAR(8) CHARACTER SET NONE NOT NULL,
"NOMEGRPUSU" CHAR(50) CHARACTER SET NONE NOT NULL,
"COMENTGRPUSU" VARCHAR(10000) CHARACTER SET NONE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "SGDADOSINISP"("ICODEMP" INTEGER)
 AS
DECLARE VARIABLE CROLE_NAME CHAR(31);
DECLARE VARIABLE INUMEMP INTEGER;
DECLARE VARIABLE CIDGRPUSU CHAR(8);
DECLARE VARIABLE CIDUSU CHAR(8);
DECLARE VARIABLE CSQL VARCHAR(256);
begin
  /*CTEMP = printLog('Entrou em dados ini '||cast(ICODEMP AS CHAR(10)));*/
  SELECT CODEMP FROM SGEMPRESA WHERE CODEMP=:ICODEMP INTO :INUMEMP;
  IF (INUMEMP IS NULL) THEN
  BEGIN
   /* CTEMP = printLog('Empresa  nulo '||cast(ICODEMP AS CHAR(10))); */
     INSERT INTO SGEMPRESA (CODEMP,RAZEMP)
        VALUES (:ICODEMP,'EMPRESA '||CAST(:ICODEMP AS CHAR(10) ));
     INSERT INTO SGFILIAL (CODEMP, CODFILIAL, RAZFILIAL,
        NOMEFILIAL,MZFILIAL)
       VALUES (:ICODEMP,1,'EMPRESA'||CAST(:ICODEMP AS CHAR(10) )||' - MATRIZ',
        'EMPRESA'||CAST(:ICODEMP AS CHAR(10) )||' - MATRIZ' ,'S');
    /*CTEMP = printLog('Inseriu empresa e filial '||cast(ICODEMP AS CHAR(10)));*/
  END
  SELECT RDB$ROLE_NAME FROM RDB$ROLES
     WHERE RDB$ROLE_NAME='ADM'
       INTO :CROLE_NAME;
  IF (CROLE_NAME IS NULL) THEN
  BEGIN
     CSQL = 'CREATE ROLE ADM';
     EXECUTE STATEMENT CSQL;
  END
  /* CTEMP = printLog('cadastrou roles'); */
  FOR SELECT CODEMP FROM SGEMPRESA INTO :INUMEMP DO
  BEGIN
  /* CTEMP = printLog('LOOP DE EMPRESA PARA CADASTRAR GRUPO'||CAST(INUMEMP AS CHAR(10)));*/

     SELECT IDGRPUSU FROM SGGRPUSU
       WHERE CODEMP=:INUMEMP AND IDGRPUSU='ADM'
         INTO :CIDGRPUSU;
     IF (CIDGRPUSU IS NULL) THEN
        INSERT INTO SGGRPUSU ( CODEMP, CODFILIAL, IDGRPUSU, NOMEGRPUSU)
          VALUES ( :INUMEMP, 1, 'ADM', 'ADMINISTRADOR' );
     SELECT IDUSU FROM SGUSUARIO
       WHERE CODEMP=:INUMEMP AND IDUSU='sysdba' AND CODFILIAL=1
         INTO :CIDUSU;
     IF (CIDUSU IS NULL) THEN
        INSERT INTO SGUSUARIO (CODEMP, CODFILIAL, IDUSU, NOMEUSU, IDGRPUSU)
          VALUES (:INUMEMP, 1, 'sysdba', 'ADMINISTRADOR DBA', 'ADM');
  /* CTEMP = printLog('CADASTROU USUARIOS');*/

  END

  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "SGESTACAOIMP"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODEST" INTEGER NOT NULL,
"NROIMP" SMALLINT NOT NULL,
"CODEMPIP" INTEGER NOT NULL,
"CODFILIALIP" SMALLINT NOT NULL,
"CODIMP" INTEGER NOT NULL,
"CODEMPPP" INTEGER NOT NULL,
"CODFILIALPP" SMALLINT NOT NULL,
"CODPAPEL" CHAR(10) CHARACTER SET NONE NOT NULL,
"PORTAWIN" CHAR(50) CHARACTER SET NONE NOT NULL,
"PORTALIN" CHAR(50) CHARACTER SET NONE NOT NULL,
"IMPPAD" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"TIPOUSOIMP" CHAR(2) CHARACTER SET NONE NOT NULL,
"IMPGRAFICA" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT user,
"DTINS" DATE DEFAULT 'now',
"HINS" TIME DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE,
"DTALT" DATE,
"HALT" TIME);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "SGESTACAOIMPSP01"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODEST" INTEGER,
"SNROIMP" SMALLINT,
"CPADIMP" CHAR(1) CHARACTER SET NONE)
 AS
begin
  /* Procedure que ajusta impressora padro */
  IF ( (CPADIMP IS NOT NULL) AND (CPADIMP='S') ) THEN
     UPDATE SGESTACAOIMP SET IMPPAD='N' WHERE CODEMP=:ICODEMP AND
        CODFILIAL=:SCODFILIAL AND CODEST=:ICODEST AND NROIMP!=:SNROIMP;
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "SGFIMCONSP" AS
DECLARE VARIABLE ICONECTADO INTEGER;
begin
  /* Procedure Text */
  SELECT CONECTADO FROM SGCONEXAO WHERE NRCONEXAO=CURRENT_CONNECTION INTO iConectado;
  if (iConectado is not null) then
     UPDATE SGCONEXAO SET CONECTADO=0
        WHERE NRCONEXAO=CURRENT_CONNECTION;
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "SGOBJETO"("CODEMP" INTEGER NOT NULL,
"IDOBJ" CHAR(30) CHARACTER SET NONE NOT NULL,
"DESCOBJ" CHAR(50) CHARACTER SET NONE NOT NULL,
"TIPOOBJ" CHAR(2) CHARACTER SET NONE NOT NULL,
"COMENTOBJ" VARCHAR(10000) CHARACTER SET NONE,
"USOMEOBJ" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"SIGLAOBJ" CHAR(8) CHARACTER SET NONE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "SGGRANTADMSP"("ICODEMP" INTEGER)
 AS
DECLARE VARIABLE CSQL VARCHAR(200);
DECLARE VARIABLE CIDOBJ CHAR(30);
begin
  /* Procedure que d grant para o grupo ADM */
  FOR SELECT IDOBJ FROM SGOBJETO
    WHERE CODEMP=:ICODEMP AND TIPOOBJ='TB'
    INTO :CIDOBJ DO
  BEGIN
      CSQL = 'GRANT DELETE, INSERT, SELECT, UPDATE ON TABLE '||CIDOBJ||
        ' TO ROLE ADM';
      EXECUTE STATEMENT CSQL;
  END
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "SGGRANTUSERSP" AS
DECLARE VARIABLE CIDGRPUSU CHAR(8);
DECLARE VARIABLE CIDUSU CHAR(8);
DECLARE VARIABLE CSQL VARCHAR(200);
begin
  FOR SELECT DISTINCT IDGRPUSU, IDUSU FROM SGUSUARIO
     INTO :CIDGRPUSU, :CIDUSU DO
  BEGIN
      CSQL = 'GRANT '||RTRIM(CIDGRPUSU)||' TO USER '||RTRIM(CIDUSU);
      EXECUTE STATEMENT CSQL;
  END
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "SGINICONSP"("ICODEMP" INTEGER,
"CIDUSU" CHAR(8) CHARACTER SET NONE,
"ICODFILIALSEL" SMALLINT,
"ICODTERM" SMALLINT)
 RETURNS("SRET" SMALLINT)
 AS
DECLARE VARIABLE ICONECTADO INTEGER;
DECLARE VARIABLE ICODFILIALSELCX SMALLINT;
DECLARE VARIABLE ICODEMPTMP INTEGER;
DECLARE VARIABLE ICODFILIAL SMALLINT;
begin
  /* Procedure para inicializao da conexo com o banco de dados */
  SRET = 0;
  if (ICODEMP IS NULL) then
     ICODEMP = 99;
  /*CTEMP = printLog('Vai verificar o usurio');*/
  CIDUSU = lower(CIDUSU);
  IF ( CIDUSU='sysdba' ) THEN
  BEGIN
/*     CTEMP = printLog('Usurio sysdba');*/

     SELECT CODEMP FROM SGEMPRESA WHERE CODEMP=:ICODEMP INTO :ICODEMPTMP;
     IF (ICODEMPTMP IS NULL) THEN
        EXECUTE PROCEDURE SGATUALIZABDSP(:ICODEMP);
  END
  SELECT CODFILIAL FROM SGUSUARIO WHERE IDUSU=:cIdUsu AND
      CODEMP=:ICODEMP  INTO :iCodFilial;
/*  CTEMP = printLog('O usurio  = '||cIdUsu); */

/*  CTEMP = printLog('Contador de usurios '||cIdUsu); */

  if (iCodFilial is null) then
    EXCEPTION SGCONEXAOEX02;

  if (iCodFilialSel is not null) then
  begin
      SRET = 1;
      SELECT CONECTADO, CODFILIALSEL FROM SGCONEXAO
        WHERE NRCONEXAO=CURRENT_CONNECTION INTO :iConectado, iCodFilialSelCX;
      if (iConectado is null) then
          INSERT INTO SGCONEXAO (NRCONEXAO, CODEMP,CODFILIAL,IDUSU,CODFILIALSEL,CONECTADO,CODTERM)
            VALUES (CURRENT_CONNECTION, :iCodemp, :iCodfilial, :cIdusu, :iCodfilialSel, 1, :iCodTerm);
      else
      begin
          if (iConectado<=0) then
             UPDATE SGCONEXAO SET CONECTADO=1, CODFILIALSEL=:iCodfilialSel, CODTERM = :iCodTerm,
               CODEMP=:iCodemp, CODFILIAL=:iCodfilial , IDUSU=:cIdUsu
               WHERE NRCONEXAO=CURRENT_CONNECTION;
          else
          begin
             if (not (iCodfilialSelCX=iCodfilialSel) ) then
                EXCEPTION SGCONEXAOEX01;
             else
                UPDATE SGCONEXAO SET CONECTADO=CONECTADO+1, CODTERM = :iCodTerm,
                   CODEMP=:iCodemp, CODFILIAL=:iCodfilial, IDUSU=:cIdUsu
                WHERE NRCONEXAO=CURRENT_CONNECTION;
          end
      end 
  end
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "SGLOG"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODLOG" INTEGER NOT NULL,
"DATALOG" DATE DEFAULT 'now' NOT NULL,
"HORALOG" TIME DEFAULT 'now' NOT NULL,
"CODEMPUS" INTEGER NOT NULL,
"CODFILIALUS" SMALLINT NOT NULL,
"IDUSU" CHAR(8) CHARACTER SET NONE NOT NULL,
"CLASLOG" CHAR(2) CHARACTER SET NONE DEFAULT 01 NOT NULL,
"TIPOLOG" CHAR(3) CHARACTER SET NONE NOT NULL,
"CODEMPCX" INTEGER NOT NULL,
"CODFILIALCX" SMALLINT NOT NULL,
"CODCAIXA" INTEGER NOT NULL,
"DESCLOG" CHAR(60) CHARACTER SET NONE NOT NULL,
"OBSLOG" VARCHAR(1000) CHARACTER SET NONE);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "SGLOGSP01"("CLASLOG" CHAR(2) CHARACTER SET NONE,
"TIPOLOG" CHAR(3) CHARACTER SET NONE,
"DESCLOG" CHAR(60) CHARACTER SET NONE,
"OBSLOG" VARCHAR(1000) CHARACTER SET NONE)
 RETURNS("CODFILIAL" SMALLINT,
"CODLOG" INTEGER)
 AS
DECLARE VARIABLE IDUSU CHAR(8);
DECLARE VARIABLE CODEMP INTEGER;
DECLARE VARIABLE CODCAIXA INTEGER;
BEGIN
  SELECT CODEMP,CODFILIALSEL,CODTERM, IDUSU FROM SGCONEXAO WHERE NRCONEXAO=CURRENT_CONNECTION AND
    CONECTADO > 0 INTO CODEMP, CODFILIAL, CODCAIXA, IDUSU;
  SELECT ISEQ FROM SPGERANUM(:CODEMP,:CODFILIAL,'LG') INTO CODLOG;
  INSERT INTO SGLOG(CODEMP,CODFILIAL,CODLOG,CODEMPUS,CODFILIALUS,IDUSU,
               CLASLOG,TIPOLOG,CODEMPCX,CODFILIALCX,CODCAIXA,
        DESCLOG,OBSLOG) VALUES
              (:CODEMP,:CODFILIAL,:CODLOG,:CODEMP,:CODFILIAL,:IDUSU,
               :CLASLOG,:TIPOLOG,:CODEMP,:CODFILIAL,:CODCAIXA,
               :DESCLOG,:OBSLOG);
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "SGOBJETOINSTBSP"("ICODEMP" INTEGER)
 AS
begin

   INSERT INTO SGOBJETO (CODEMP,IDOBJ,DESCOBJ,TIPOOBJ,COMENTOBJ,USOMEOBJ,SIGLAOBJ)
       SELECT DISTINCT :ICODEMP, RC.RDB$RELATION_NAME, RC.RDB$RELATION_NAME,
        'TB', RC.RDB$RELATION_NAME /*CAST(R.RDB$DESCRIPTION AS VARCHAR(10000))*/, 'S', SUBSTRING(RC.RDB$RELATION_NAME FROM 1 FOR 8)
       FROM RDB$RELATION_CONSTRAINTS RC, RDB$RELATIONS R
       WHERE R.RDB$RELATION_NAME = RC.RDB$RELATION_NAME AND
       RC.RDB$RELATION_NAME NOT IN (SELECT IDOBJ FROM SGOBJETO O
       WHERE O.TIPOOBJ='TB' AND O.IDOBJ=RC.RDB$RELATION_NAME);

    suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "SGRETCAIXA" RETURNS("CODEMP" INTEGER,
"CODFILIAL" SMALLINT,
"CODTERM" INTEGER)
 AS
begin
  SELECT CODEMP, CODFILIALSEL, CODTERM FROM SGCONEXAO WHERE
    NRCONEXAO=CURRENT_CONNECTION AND CONECTADO > 0 INTO CODEMP, CODFILIAL,CODTERM;
  SUSPEND;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "SGRETFILIAL"("ICODEMP" INTEGER,
"SNOMETAB" CHAR(30) CHARACTER SET NONE)
 RETURNS("ICODFILIAL" SMALLINT)
 AS
DECLARE VARIABLE SEHME CHAR(1);
begin
  SELECT USOMEOBJ FROM SGOBJETO WHERE TIPOOBJ='TB' AND IDOBJ=:SNOMETAB
    INTO sEhME;
  IF (sEhME = 'N') THEN
  BEGIN
    SELECT CODFILIALSEL FROM SGCONEXAO WHERE CODEMP=:ICODEMP AND
      NRCONEXAO=CURRENT_CONNECTION AND CONECTADO > 0 INTO ICODFILIAL;
  END
  ELSE
  BEGIN
    SELECT FL.CODFILIAL FROM SGFILIAL FL WHERE
      FL.CODEMP = :ICODEMP AND FL.MZFILIAL='S'
      INTO ICODFILIAL;
    IF (ICODFILIAL IS NULL) THEN
      EXCEPTION SGFILIALEX01;
  END
  IF (ICODFILIAL IS NULL) THEN
  BEGIN
    EXCEPTION SGFILIALEX02;
  END
  SUSPEND;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "SGRETINFOUSU"("IDUSU" CHAR(8) CHARACTER SET NONE)
 RETURNS("ANOCCUSU" SMALLINT,
"CODFILIALCCUSU" SMALLINT,
"CODEMPUSU" INTEGER,
"CODFILIALUSU" SMALLINT,
"CODCCUSU" CHAR(19) CHARACTER SET NONE,
"IDUSUS" CHAR(8) CHARACTER SET NONE,
"ALMOXARIFE" CHAR(1) CHARACTER SET NONE,
"APROVARMA" CHAR(2) CHARACTER SET NONE)
 AS
begin
  SELECT CODEMP,CODFILIAL,CODFILIALCC,ANOCC,CODCC,IDUSU,ALMOXARIFEUSU,APROVRMAUSU
     FROM SGUSUARIO WHERE lower(IDUSU)=lower(:IDUSU)
    INTO :CODEMPUSU,:CODFILIALUSU,:CODFILIALCCUSU,:ANOCCUSU,:CODCCUSU,:IDUSUS,:ALMOXARIFE,:APROVARMA;
  SUSPEND;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "SGRETMULTIALMOXSP"("ICODEMP" INTEGER)
 RETURNS("CMULTIALMOX" CHAR(1) CHARACTER SET NONE)
 AS
DECLARE VARIABLE SCODFILIALPF SMALLINT;
begin
  /* Procedure Text */
  SELECT RF.ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'SGPREFERE1') RF
     INTO :SCODFILIALPF;
  SELECT MULTIALMOX FROM SGPREFERE1 WHERE CODEMP=:ICODEMP AND
     CODFILIAL=:SCODFILIALPF
     INTO :CMULTIALMOX;

/* Condio que evita null no valor do flag */
  CMULTIALMOX = coalesce(CMULTIALMOX,'N');

  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "SGAGENDA"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"TIPOAGE" CHAR(5) CHARACTER SET NONE NOT NULL,
"CODAGE" INTEGER NOT NULL,
"CODAGD" INTEGER NOT NULL,
"DATAAGD" DATE NOT NULL,
"DTAINIAGD" DATE NOT NULL,
"HRINIAGD" TIME NOT NULL,
"DTAFIMAGD" DATE NOT NULL,
"HRFIMAGD" TIME NOT NULL,
"ASSUNTOAGD" CHAR(50) CHARACTER SET NONE NOT NULL,
"DESCAGD" VARCHAR(10000) CHARACTER SET NONE NOT NULL,
"PRIORAGD" SMALLINT NOT NULL,
"SITAGD" CHAR(2) CHARACTER SET NONE NOT NULL,
"CODEMPAE" INTEGER NOT NULL,
"CODFILIALAE" SMALLINT NOT NULL,
"CODAGEEMIT" INTEGER NOT NULL,
"TIPOAGEEMIT" CHAR(5) CHARACTER SET NONE NOT NULL,
"CAAGD" CHAR(2) CHARACTER SET NONE DEFAULT 'PR' NOT NULL,
"CODEMPTA" INTEGER NOT NULL,
"CODFILIALTA" SMALLINT NOT NULL,
"CODTIPOAGD" INTEGER NOT NULL);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "SGSETAGENDASP"("CODAGD" INTEGER,
"CODEMP" INTEGER,
"DTAINIAGD" DATE,
"HRINIAGD" TIME,
"DTAFIMAGD" DATE,
"HRFIMAGD" TIME,
"ASSUNTOAGD" CHAR(50) CHARACTER SET NONE,
"DESCAGD" VARCHAR(10000) CHARACTER SET NONE,
"CODFILIALTA" SMALLINT,
"CODTIPOAGD" INTEGER,
"PRIORAGD" SMALLINT,
"CODAGE" INTEGER,
"TIPOAGE" CHAR(5) CHARACTER SET NONE,
"CODFILIALAE" SMALLINT,
"CODAGEEMIT" INTEGER,
"TIPOAGEEMIT" CHAR(5) CHARACTER SET NONE,
"CAAGD" CHAR(2) CHARACTER SET NONE)
 RETURNS("IRET" INTEGER)
 AS
DECLARE VARIABLE IFILIALAGD INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'SGAGENDA') INTO IFILIALAGD;
  IF (CODAGD = 0) THEN
  BEGIN
    SELECT ISEQ FROM SPGERANUM(:CODEMP,:IFILIALAGD,'AG') INTO CODAGD;
    INSERT INTO SGAGENDA(
      CODEMP,CODFILIAL,CODAGE,TIPOAGE,CODAGD,
      DATAAGD,DTAINIAGD,HRINIAGD,DTAFIMAGD,HRFIMAGD,
      ASSUNTOAGD,DESCAGD,CODEMPTA,CODFILIALTA,CODTIPOAGD,PRIORAGD,SITAGD,
      CODEMPAE,CODFILIALAE,CODAGEEMIT,TIPOAGEEMIT,CAAGD)
      VALUES (
      :CODEMP,:IFILIALAGD,:CODAGE,:TIPOAGE,:CODAGD,
      CAST('today' AS DATE),:DTAINIAGD,:HRINIAGD,:DTAFIMAGD,:HRFIMAGD,
      :ASSUNTOAGD,:DESCAGD,:CODEMP,:CODFILIALTA,:CODTIPOAGD,:PRIORAGD,'AI',
      :CODEMP,:CODFILIALAE,:CODAGEEMIT,:TIPOAGEEMIT,:CAAGD);
  END
  ELSE
    UPDATE SGAGENDA SET
      DTAINIAGD=:DTAINIAGD,HRINIAGD=:HRINIAGD,
      DTAFIMAGD=:DTAFIMAGD,HRFIMAGD=:HRFIMAGD,
      ASSUNTOAGD=:ASSUNTOAGD,DESCAGD=:DESCAGD,
      CODEMPTA=:CODEMP,CODFILIALTA=:CODFILIALTA,CODTIPOAGD=:CODTIPOAGD,
      PRIORAGD=:PRIORAGD,CAAGD=:CAAGD
      WHERE CODEMP=:CODEMP AND CODFILIAL=:IFILIALAGD
      AND CODAGD=:CODAGD AND CODAGE=:CODAGE AND TIPOAGE=:TIPOAGE;
  IRET = CODAGD;
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "SGACESSOMU"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"IDUSU" CHAR(8) CHARACTER SET NONE NOT NULL,
"CODSIS" INTEGER NOT NULL,
"CODMODU" INTEGER NOT NULL,
"CODMENU" INTEGER NOT NULL,
"TPACESSOMU" CHAR(1) CHARACTER SET NONE NOT NULL,
"PLANOMU" CHAR(1) CHARACTER SET NONE DEFAULT 'O' NOT NULL);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "SGUPACESSOMUSP"("ICODEMP" INTEGER,
"ICODFILIAL" INTEGER,
"SIDUSU" CHAR(8) CHARACTER SET NONE,
"ICODSIS" INTEGER,
"ICODMODU" INTEGER,
"ICODMENU" INTEGER,
"CTPACESSOMU" CHAR(1) CHARACTER SET NONE)
 AS
BEGIN
  DELETE FROM SGACESSOMU WHERE CODEMP = :ICODEMP
         AND CODFILIAL = :ICODFILIAL
         AND IDUSU = :SIDUSU
         AND CODSIS =:ICODSIS
         AND CODMODU =:ICODMODU
         AND CODMENU =:ICODMENU;
  INSERT INTO SGACESSOMU (CODEMP,CODFILIAL,IDUSU,CODSIS,CODMODU,CODMENU,TPACESSOMU)
         VALUES (
                :ICODEMP,
                :ICODFILIAL,
                :SIDUSU,
                :ICODSIS,
                :ICODMODU,
                :ICODMENU,
                :CTPACESSOMU
         );
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "SGMENU"("CODSIS" INTEGER NOT NULL,
"CODMODU" INTEGER NOT NULL,
"CODMENU" INTEGER NOT NULL,
"DESCMENU" "CHARMIDDLEDN" NOT NULL,
"NOMEMENU" "CHARMIDDLEDN" NOT NULL,
"PLANOMENU" CHAR(1) CHARACTER SET NONE DEFAULT 'O' NOT NULL,
"ACAOMENU" CHAR(100) CHARACTER SET NONE NOT NULL,
"CODSISPAI" INTEGER,
"CODMODUPAI" INTEGER,
"CODMENUPAI" INTEGER,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
CREATE TABLE "SGMODULO"("CODSIS" INTEGER NOT NULL,
"CODMODU" INTEGER NOT NULL,
"DESCMODU" CHAR(50) CHARACTER SET NONE NOT NULL,
"COMENTMODU" VARCHAR(10000) CHARACTER SET NONE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
CREATE TABLE "SGSISTEMA"("CODSIS" INTEGER NOT NULL,
"DESCSIS" CHAR(50) CHARACTER SET NONE NOT NULL,
"COMENTSIS" VARCHAR(10000) CHARACTER SET NONE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "SGUPMENUSP01"("ICODSIS" INTEGER,
"CDESCSIS" CHAR(50) CHARACTER SET NONE,
"ICODMODU" INTEGER,
"CDESCMODU" CHAR(50) CHARACTER SET NONE,
"ICODMENU" INTEGER,
"CDESCMENU" CHAR(50) CHARACTER SET NONE,
"CNOMEMENU" CHAR(50) CHARACTER SET NONE,
"CACAOMENU" CHAR(100) CHARACTER SET NONE,
"ICODSISPAI" INTEGER,
"ICODMODUPAI" INTEGER,
"ICODMENUPAI" INTEGER)
 AS
DECLARE VARIABLE ITMP INTEGER;
BEGIN
  SELECT COUNT(*) FROM SGSISTEMA WHERE CODSIS = :ICODSIS
     INTO :ITMP;
  IF ( (ITMP is null) OR (ITMP=0) ) THEN
      INSERT INTO SGSISTEMA(CODSIS, DESCSIS)
         VALUES(:ICODSIS, :CDESCSIS);

  SELECT COUNT(*) FROM SGMODULO WHERE CODSIS = :ICODSIS AND CODMODU = :ICODMODU
     INTO :ITMP;
  IF ( (ITMP is null) OR (ITMP=0) ) THEN
      INSERT INTO SGMODULO(CODSIS, CODMODU, DESCMODU)
         VALUES(:ICODSIS, :ICODMODU, :CDESCMODU);

  SELECT COUNT(*) FROM SGMENU WHERE CODSIS =:ICODSIS
         AND CODMODU =:ICODMODU
         AND CODMENU =:ICODMENU INTO :ITMP;
  IF ( (ITMP IS NOT NULL)  AND (ITMP > 0) ) THEN
  BEGIN
    UPDATE SGMENU
      SET
        DESCMENU = :CDESCMENU,
        CODSISPAI = :ICODSISPAI,
        CODMODUPAI = :ICODMODUPAI,
        CODMENUPAI = :ICODMENUPAI
      WHERE
        CODSIS = :ICODSIS AND
        CODMODU = :ICODMODU AND
        CODMENU = :ICODMENU;
  END
  ELSE
  BEGIN
    INSERT INTO SGMENU (CODSIS,CODMODU,CODMENU,DESCMENU,NOMEMENU,ACAOMENU,
      CODSISPAI,CODMODUPAI,CODMENUPAI)
     VALUES ( :ICODSIS, :ICODMODU, :ICODMENU, :CDESCMENU, :CNOMEMENU, :CACAOMENU,
      :ICODSISPAI,:ICODMODUPAI, :ICODMENUPAI );
  END
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "SGSEQUENCIA"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"SGTAB" CHAR(2) CHARACTER SET NONE NOT NULL,
"NROSEQ" INTEGER,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "SPGERANUM"("ICODEMP" INTEGER,
"ICODFILIAL" INTEGER,
"STAB" CHAR(2) CHARACTER SET NONE)
 RETURNS("ISEQ" INTEGER)
 AS
begin
  ISEQ = NULL;
  SELECT NROSEQ FROM SGSEQUENCIA
    WHERE CODEMP=:iCodEmp AND
      CODFILIAL=:iCodFilial AND
      SGTAB=:STAB INTO :ISEQ;
   IF (ISEQ IS NULL) THEN
   BEGIN
     INSERT INTO SGSEQUENCIA (CODEMP,CODFILIAL,SGTAB,NROSEQ)
            VALUES (:ICODEMP,:ICODFILIAL,:STAB,0);
     ISEQ = 1;
   END
   UPDATE SGSEQUENCIA SET NROSEQ=:ISEQ+1 WHERE
          CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
          AND SGTAB=:STAB;
  SUSPEND;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "PVSEQUENCIA"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODCAIXA" INTEGER NOT NULL,
"SEQCAIXA" INTEGER DEFAULT 1 NOT NULL);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "SPGERANUMPDV"("ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT,
"ICODCAIXA" INTEGER)
 RETURNS("ISEQ" INTEGER)
 AS
DECLARE VARIABLE ISEQINI INTEGER;
DECLARE VARIABLE ISEQMAX INTEGER;
begin
  /* Procedure Text */
  ISEQ = NULL;               
  SELECT SEQINI, SEQMAX FROM PVCAIXA
     WHERE CODEMP=:ICODEMP AND
        CODFILIAL=:ICODFILIAL AND
        CODCAIXA=:ICODCAIXA
        INTO :ISEQINI, :ISEQMAX;
  SELECT SEQCAIXA FROM PVSEQUENCIA
     WHERE CODEMP=:ICODEMP AND
        CODFILIAL=:ICODFILIAL AND
        CODCAIXA=:ICODCAIXA
        INTO :ISEQ;
  IF (ISEQ IS NULL) THEN
  BEGIN
     IF(ISEQINI IS NOT NULL AND ISEQMAX IS NOT NULL) THEN
     BEGIN
        INSERT INTO PVSEQUENCIA (CODEMP,CODFILIAL,CODCAIXA,SEQCAIXA)
           VALUES (:ICODEMP,:ICODFILIAL,:ICODCAIXA,:ISEQINI);
        ISEQ = :ISEQINI;
     END
     ELSE
        EXCEPTION PVSEQCAIXA01;
  END
  IF (ISEQ >=ISEQINI AND ISEQ < ISEQMAX)  THEN
     UPDATE PVSEQUENCIA SET SEQCAIXA=:ISEQ+1 WHERE
        CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
        AND CODCAIXA=:ICODCAIXA;
  ELSE
     EXCEPTION PVSEQCAIXA02;
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "TKCONTATO"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODCTO" INTEGER NOT NULL,
"RAZCTO" CHAR(50) CHARACTER SET NONE NOT NULL,
"CODEMPVD" INTEGER,
"CODFILIALVD" SMALLINT,
"CODVEND" INTEGER,
"CODEMPSR" INTEGER NOT NULL,
"CODFILIALSR" SMALLINT NOT NULL,
"CODSETOR" INTEGER NOT NULL,
"NOMECTO" CHAR(50) CHARACTER SET NONE NOT NULL,
"DATACTO" DATE DEFAULT 'today' NOT NULL,
"PESSOACTO" CHAR(1) CHARACTER SET NONE NOT NULL,
"ATIVOCTO" CHAR(1) CHARACTER SET NONE NOT NULL,
"CNPJCTO" CHAR(14) CHARACTER SET NONE,
"INSCCTO" CHAR(15) CHARACTER SET NONE,
"CPFCTO" CHAR(11) CHARACTER SET NONE,
"RGCTO" CHAR(10) CHARACTER SET NONE,
"ENDCTO" CHAR(50) CHARACTER SET NONE,
"NUMCTO" INTEGER,
"COMPLCTO" CHAR(20) CHARACTER SET NONE,
"BAIRCTO" CHAR(30) CHARACTER SET NONE,
"CIDCTO" CHAR(30) CHARACTER SET NONE,
"UFCTO" CHAR(2) CHARACTER SET NONE,
"CEPCTO" CHAR(8) CHARACTER SET NONE,
"FONECTO" CHAR(12) CHARACTER SET NONE,
"FAXCTO" CHAR(8) CHARACTER SET NONE,
"EMAILCTO" CHAR(50) CHARACTER SET NONE,
"CONTCTO" CHAR(40) CHARACTER SET NONE,
"CARGOCONTCTO" CHAR(30) CHARACTER SET NONE,
"OBSCTO" VARCHAR(10000) CHARACTER SET NONE,
"REMOVCTO" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"CODEMPTI" INTEGER,
"CODFILIALTI" SMALLINT,
"CODTPIMP" INTEGER,
"CODEMPSO" INTEGER,
"CODFILIALSO" SMALLINT,
"CODSETORCTO" INTEGER,
"NUMEMPCTO" INTEGER,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "TKCONTTOCLI"("CODEMP" INTEGER,
"CODFILIAL" INTEGER,
"CODCTO" INTEGER,
"CODFILIALTI" INTEGER,
"CODTIPOCLI" INTEGER,
"CODFILIALCC" INTEGER,
"CODCLASCLI" INTEGER,
"CODFILIALSR" INTEGER,
"CODSETOR" INTEGER)
 RETURNS("IRET" INTEGER)
 AS
DECLARE VARIABLE ICODCLI INTEGER;
DECLARE VARIABLE IFILIALCLI INTEGER;
BEGIN
  SELECT MAX(CODCLI)+1 FROM VDCLIENTE WHERE CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL INTO ICODCLI;
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP, 'VDCLIENTE') INTO IFILIALCLI;
  INSERT INTO VDCLIENTE (CODEMP,CODFILIAL,CODCLI,RAZCLI,CODEMPCC,CODFILIALCC,CODCLASCLI,
  CODEMPVD,CODFILIALVD,CODVEND,CODEMPSR,CODFILIALSR,CODSETOR,NOMECLI,CODEMPTI,CODFILIALTI,
  CODTIPOCLI,DATACLI,PESSOACLI,ATIVOCLI,CNPJCLI,INSCCLI,CPFCLI,RGCLI,ENDCLI,NUMCLI,
  COMPLCLI,BAIRCLI,CIDCLI,UFCLI,CEPCLI,FONECLI,FAXCLI,EMAILCLI,CONTCLI)
    SELECT :CODEMP,:IFILIALCLI,:ICODCLI,RAZCTO,:CODEMP,:CODFILIALCC,:CODCLASCLI,
    CODEMPVD,CODFILIALVD,CODVEND,:CODEMP,:CODFILIALSR,:CODSETOR,NOMECTO,:CODEMP,:CODFILIALTI,
    :CODTIPOCLI,DATACTO,PESSOACTO,ATIVOCTO,CNPJCTO,INSCCTO,CPFCTO,RGCTO,ENDCTO,NUMCTO,
    COMPLCTO,BAIRCTO,CIDCTO,UFCTO,CEPCTO,FONECTO,FAXCTO,EMAILCTO,CONTCTO FROM TKCONTATO WHERE
    CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL AND CODCTO=:CODCTO;

    IRET = ICODCLI;
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "TKSETHISTSP"("CODHISTTK" INTEGER,
"CODEMP" INTEGER,
"CODFILIALCO" INTEGER,
"CODCTO" INTEGER,
"CODFILIALCL" INTEGER,
"CODCLI" INTEGER,
"DESCHISTTK" VARCHAR(10000) CHARACTER SET NONE,
"CODFILIALAE" INTEGER,
"CODATEND" INTEGER,
"SITHISTTK" CHAR(2) CHARACTER SET NONE,
"DATAHISTTK" DATE,
"TIPOHISTTK" CHAR(1) CHARACTER SET NONE)
 RETURNS("IRET" INTEGER)
 AS
DECLARE VARIABLE IFILIALHIST INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'TKHISTORICO') INTO IFILIALHIST;
  IF (TIPOHISTTK = '') THEN
  BEGIN
    TIPOHISTTK = 'H';
  END
  IF (CODHISTTK = 0) THEN
  BEGIN
    SELECT ISEQ FROM SPGERANUM(:CODEMP,:IFILIALHIST,'HI') INTO CODHISTTK;
    INSERT INTO TKHISTORICO(CODEMP,CODFILIAL,CODHISTTK,DATAHISTTK,HORAHISTTK,CODEMPCO,CODFILIALCO,
      CODCTO,CODEMPCL,CODFILIALCL,CODCLI,DESCHISTTK,CODEMPAE,CODFILIALAE,CODATEND,SITHISTTK,TIPOHISTTK)
      VALUES (:CODEMP,:IFILIALHIST,:CODHISTTK,:DATAHISTTK,CAST('now' AS TIME),:CODEMP,:CODFILIALCO,
      :CODCTO,:CODEMP,:CODFILIALCL,:CODCLI,:DESCHISTTK,:CODEMP,:CODFILIALAE,:CODATEND,:SITHISTTK,:TIPOHISTTK);
  END
  ELSE
  BEGIN
    UPDATE TKHISTORICO SET DATAHISTTK=:DATAHISTTK,CODEMPCO=:CODEMP,CODFILIALCO=:CODFILIALCO,
      CODCTO=:CODCTO,CODEMPCL=:CODEMP,CODFILIALCL=:CODFILIALCL,
      CODCLI=:CODCLI,DESCHISTTK=:DESCHISTTK,CODEMPAE=:CODEMP,
      CODFILIALAE=:CODFILIALAE,CODATEND=:CODATEND,SITHISTTK=:SITHISTTK,TIPOHISTTK=:TIPOHISTTK
      WHERE CODEMP=:CODEMP AND CODFILIAL=:IFILIALHIST AND CODHISTTK=:CODHISTTK;
    /*IF (NOT SITHISTTK IN ('AG')) THEN
      DELETE FROM SGAGENDA WHERE OBJORIGAGD='HISTO' AND CODEMPCH=:CODEMP AND
        CODFILIALCH=:IFILIALHIST AND CODCHAVE=:CODHISTTK; */
  END
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "VDCOMISSAO"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODCOMI" INTEGER NOT NULL,
"TIPOCOMI" CHAR(1) CHARACTER SET NONE DEFAULT 'F' NOT NULL,
"CODEMPRC" INTEGER NOT NULL,
"CODFILIALRC" SMALLINT NOT NULL,
"CODREC" INTEGER NOT NULL,
"NPARCITREC" INTEGER NOT NULL,
"VLRVENDACOMI" "NUMERICDN" NOT NULL,
"VLRCOMI" "NUMERICDN" NOT NULL,
"VLRPAGOCOMI" "NUMERICDN" DEFAULT 0 NOT NULL,
"VLRAPAGCOMI" "NUMERICDN" DEFAULT 0 NOT NULL,
"DATACOMI" DATE NOT NULL,
"DTVENCCOMI" DATE NOT NULL,
"DTPAGTOCOMI" DATE,
"STATUSCOMI" CHAR(2) CHARACTER SET NONE NOT NULL,
"CODEMPCI" INTEGER,
"CODFILIALCI" SMALLINT,
"CODPCOMI" INTEGER,
"FLAG" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"CODEMPCT" INTEGER,
"CODFILIALCT" SMALLINT,
"CODPCOMIANT" INTEGER,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "VDADICCOMISSAOSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODREC" INTEGER,
"INPARCITREC" INTEGER,
"NVLRVENDACOMI" NUMERIC(15,5),
"NVLRCOMI" NUMERIC(15,5),
"DDATACOMI" DATE,
"DDTVENCCOMI" DATE,
"CTIPOCOMI" CHAR(1) CHARACTER SET NONE)
 AS
DECLARE VARIABLE SCODFILIALCS SMALLINT;
DECLARE VARIABLE ICODCOMI INTEGER;
DECLARE VARIABLE CSTATUSCOMI CHAR(2);
begin
  /* Adiciona comisso na tabela vdcomissao*/
  IF ( (nVlrComi is null) OR  (nVlrComi=0) ) THEN /* se o valor for zero */
  BEGIN
     /*  ento deleta a comisso gerada */
     DELETE FROM VDCOMISSAO WHERE CODEMPRC=:iCodEmp AND CODFILIALRC=:sCodFilial AND
        CODREC=:iCodRec AND NPARCITREC=:iNParcItRec AND TIPOCOMI=:cTipoComi;
  END
  ELSE IF (nVlrComi<0) THEN /* Caso seja um estorno de comisso */
  BEGIN
     SELECT MAX(CODCOMI) FROM VDCOMISSAO WHERE CODEMP=:ICODEMP AND
        CODFILIAL = :SCODFILIALCS INTO iCodComi;
     IF (:iCodComi IS NULL) THEN
        iCodComi = 1;
     ELSE
        iCodComi = iCodComi+1;
     INSERT INTO VDCOMISSAO (CODEMP,CODFILIAL,CODCOMI,CODEMPRC,CODFILIALRC,CODREC,STATUSCOMI,
               NPARCITREC,VLRVENDACOMI,VLRCOMI,DATACOMI,DTVENCCOMI,STATUSCOMI,TIPOCOMI)
              VALUES ( :iCodEmp,:sCodFilialCs,:iCodComi,:iCodEmp,:sCodFilial,:iCodRec,:cStatusComi,
              :iNParcItRec,:nVlrVendaComi,:nVlrComi,:dDataComi,:dDtVencComi,'CE',:cTipoComi);
     nVlrComi = nVlrComi * -1; /*  Transforma o valor da comisso em positivo e programa para o proximo pagto. */
     INSERT INTO VDCOMISSAO (CODEMP,CODFILIAL,CODCOMI,CODEMPRC,CODFILIALRC,CODREC,STATUSCOMI,
               NPARCITREC,VLRVENDACOMI,VLRCOMI,DATACOMI,DTVENCCOMI,STATUSCOMI,TIPOCOMI)
              VALUES ( :iCodEmp,:sCodFilialCs,:iCodComi,:iCodEmp,:sCodFilial,:iCodRec,:cStatusComi,
              :iNParcItRec,:nVlrVendaComi,:nVlrComi,:dDataComi,:dDtVencComi,'C1',:cTipoComi);
  END
  ELSE
  BEGIN
     IF (cTipoComi='F') THEN
        cStatusComi = 'C2';
     ELSE
        cStatusComi = 'C1';
     SELECT ICODFILIAL FROM sgretfilial(:ICODEMP,'VDCOMISSAO') INTO :SCODFILIALCS;
     SELECT CODCOMI FROM VDCOMISSAO WHERE CODEMP=:iCodEmp AND CODFILIALRC=:sCodFilial AND
        CODREC=:iCodRec AND NPARCITREC=:iNParcItRec AND TIPOCOMI=:cTipoComi
        INTO :iCodComi;
     IF (iCodComi IS NULL) THEN  /* se no encontrou a comisso */
     BEGIN /*-ento insere */
        SELECT MAX(CODCOMI) FROM VDCOMISSAO WHERE CODEMP=:ICODEMP AND
           CODFILIAL = :SCODFILIALCS INTO iCodComi;
        IF (:iCodComi IS NULL) THEN
          iCodComi = 1;
        ELSE
          iCodComi = iCodComi+1;
        INSERT INTO VDCOMISSAO (CODEMP,CODFILIAL,CODCOMI,CODEMPRC,CODFILIALRC,CODREC,STATUSCOMI,
               NPARCITREC,VLRVENDACOMI,VLRCOMI,DATACOMI,DTVENCCOMI,STATUSCOMI,TIPOCOMI)
              VALUES ( :iCodEmp,:sCodFilialCs,:iCodComi,:iCodEmp,:sCodFilial,:iCodRec,:cStatusComi,
              :iNParcItRec,:nVlrVendaComi,:nVlrComi,:dDataComi,:dDtVencComi,:cStatusComi,:cTipoComi);
     END
     ELSE /* se encontrou a comisso atualiza */
     BEGIN
        UPDATE VDCOMISSAO SET VLRVENDACOMI=:nVlrVendaComi, VLRCOMI=:nVlrComi,
            DATACOMI=:dDataComi, DTVENCCOMI=:dDtVencComi, STATUSCOMI=:cStatusComi
        WHERE CODEMP=:iCodEmp AND CODFILIAL=:sCodFilialCs AND CODCOMI=:iCodComi
            AND STATUSCOMI!='CP' ;
     END
  END
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "VDADICITEMPDVSP"("CODVENDA" INTEGER,
"CODEMP" INTEGER,
"CODFILIAL" CHAR(8) CHARACTER SET NONE,
"CODPROD" INTEGER,
"CODEMPPD" INTEGER,
"CODFILIALPD" INTEGER,
"QTDITVENDA" NUMERIC(9,5),
"VLRPRECOITVENDA" NUMERIC(18,5),
"VLRDESCITVENDA" NUMERIC(18,5),
"PERCDESCITVENDA" NUMERIC(15,5),
"VLRCOMISITVENDA" NUMERIC(15,5),
"PERCCOMISITVENDA" NUMERIC(15,5),
"SCODLOTE" CHAR(13) CHARACTER SET NONE,
"CODEMPLE" INTEGER,
"CODFILIALLE" SMALLINT,
"CODFILIALCV" SMALLINT,
"CODCONV" INTEGER)
 RETURNS("CODITVENDA" INTEGER,
"PERCICMSITVENDA" NUMERIC(9,2),
"VLRBASEICMSITVENDA" NUMERIC(18,3),
"VLRICMSITVENDA" NUMERIC(18,3),
"VLRLIQITVENDA" NUMERIC(18,3))
 AS
DECLARE VARIABLE ICODFILIALNT SMALLINT;
DECLARE VARIABLE ICODCLI INTEGER;
DECLARE VARIABLE ICODFILIALCL INTEGER;
DECLARE VARIABLE ICODTIPOMOV INTEGER;
DECLARE VARIABLE ICODFILIALTM INTEGER;
DECLARE VARIABLE SCODNAT CHAR(4);
DECLARE VARIABLE TIPOFISC CHAR(2);
DECLARE VARIABLE SORIGFISC CHAR(1);
DECLARE VARIABLE SCODTRATTRIB CHAR(2);
DECLARE VARIABLE ICODFILIALTT SMALLINT;
DECLARE VARIABLE ICODFILIALME SMALLINT;
DECLARE VARIABLE ICODMENS SMALLINT;
DECLARE VARIABLE PERCIPIITVENDA NUMERIC(9,2);
DECLARE VARIABLE VLRBASEIPIITVENDA NUMERIC(15,5);
DECLARE VARIABLE VLRIPIITVENDA NUMERIC(15,5);
DECLARE VARIABLE VLRPRODITVENDA NUMERIC(15,5);
DECLARE VARIABLE SREFPROD CHAR(13);
DECLARE VARIABLE OBSITORC VARCHAR(500);
DECLARE VARIABLE UFCLI CHAR(2);
DECLARE VARIABLE UFFLAG CHAR(1);
DECLARE VARIABLE PERCRED NUMERIC(9,2);
begin

  SELECT MAX(CODITVENDA)+1 FROM VDITVENDA WHERE CODVENDA=:CODVENDA
    AND CODFILIAL=:CODFILIAL AND CODEMP=:CODEMP INTO CODITVENDA;

  IF (CODITVENDA IS NULL) THEN
    CODITVENDA = 1;

/*Informaes da Venda.:*/

  SELECT V.CODCLI,V.CODFILIALCL,C.UFCLI,V.CODTIPOMOV,V.CODFILIALTM FROM VDVENDA V, VDCLIENTE C
    WHERE V.CODEMP=:CODEMP AND V.CODFILIAL=:CODFILIAL
    AND V.CODVENDA=:CODVENDA AND V.TIPOVENDA='E' AND
    C.CODCLI=V.CODCLI AND C.CODEMP=V.CODEMPCL AND
    C.CODFILIAL=V.CODFILIALCL INTO ICODCLI,ICODFILIALCL,UFCLI,ICODTIPOMOV,ICODFILIALTM;


  UFFLAG = 'N';

  SELECT 'S' FROM SGFILIAL  WHERE CODEMP=:CODEMP
    AND CODFILIAL=:CODFILIAL AND UFFILIAL=:UFCLI INTO UFFLAG;


  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'LFNATOPER') INTO ICODFILIALNT;
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'LFTRATTRIB') INTO ICODFILIALTT;
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP,'LFMENSAGEM') INTO ICODFILIALME;
  SELECT C.ALIQIPIFISC
      FROM EQPRODUTO P, LFCLFISCAL C
         WHERE P.CODPROD=:CODPROD AND P.CODFILIAL=:CODFILIALPD
         AND P.CODEMP=:CODEMPPD AND C.CODFISC=P.CODFISC AND C.CODFILIAL=P.CODFILIALFC
         AND C.CODEMP=P.CODEMPFC INTO PERCIPIITVENDA;

  SELECT CODNAT FROM
      LFBUSCANATSP(:CODFILIAL,:CODEMP,:CODFILIALPD,
                   :CODPROD,:CODEMP,:ICODFILIALCL,
                   :ICODCLI,NULL,NULL,NULL,:ICODFILIALTM,:ICODTIPOMOV)
      INTO SCODNAT;

  IF (SCODNAT IS NULL) THEN
      EXCEPTION VDITVENDAEX03;

  SELECT TIPOFISC,REDFISC,CODTRATTRIB,ORIGFISC,CODMENS,ALIQFISC FROM
      LFBUSCAFISCALSP(:CODFILIAL,:CODEMP,:CODFILIALPD,:CODPROD,:CODEMP,:ICODFILIALCL,:ICODCLI)
      INTO TIPOFISC,PERCRED,SCODTRATTRIB,SORIGFISC,ICODMENS,PERCICMSITVENDA;

  VLRPRODITVENDA = (QTDITVENDA*VLRPRECOITVENDA);
  VLRBASEIPIITVENDA = 0;
  VLRBASEICMSITVENDA = 0;
  VLRICMSITVENDA = 0;
  VLRIPIITVENDA = 0;
  IF (PERCIPIITVENDA IS NULL) THEN
     PERCIPIITVENDA = 0;

  IF ( TIPOFISC = 'II') THEN
  BEGIN
    PERCICMSITVENDA = 0;
    VLRICMSITVENDA = 0;
    VLRBASEICMSITVENDA = 0;
    PERCIPIITVENDA = 0;
    VLRIPIITVENDA = 0;
    VLRBASEIPIITVENDA = 0;
  END
  ELSE IF ( TIPOFISC = 'FF') THEN
  BEGIN
    PERCICMSITVENDA = 0;
    VLRICMSITVENDA = 0;
    VLRBASEICMSITVENDA = 0;
    PERCIPIITVENDA = 0;
    VLRIPIITVENDA = 0;
    VLRBASEIPIITVENDA = 0;
  END
  ELSE IF ( TIPOFISC = 'NN') THEN
  BEGIN
    PERCICMSITVENDA = 0;
    VLRICMSITVENDA = 0;
    VLRBASEICMSITVENDA = 0;
    PERCIPIITVENDA = 0;
    VLRIPIITVENDA = 0;
    VLRBASEIPIITVENDA = 0;
  END
  ELSE IF ( TIPOFISC = 'TT') THEN
  BEGIN
    IF (PERCICMSITVENDA = 0 OR PERCICMSITVENDA IS NULL) THEN
      SELECT PERCICMS FROM LFBUSCAICMSSP (:SCODNAT,:UFCLI,:CODEMP,:CODFILIAL) INTO PERCICMSITVENDA;
    IF (PERCRED IS NULL) THEN
      PERCRED = 0;
    VLRBASEICMSITVENDA = (VLRPRODITVENDA-VLRDESCITVENDA) - ((VLRPRODITVENDA-VLRDESCITVENDA)*(PERCRED/100));
    VLRBASEIPIITVENDA = VLRPRODITVENDA-VLRDESCITVENDA;
    VLRICMSITVENDA = VLRBASEICMSITVENDA*(PERCICMSITVENDA/100);
    VLRIPIITVENDA = VLRBASEIPIITVENDA*(PERCIPIITVENDA/100);
  END
  VLRLIQITVENDA= VLRPRODITVENDA+VLRIPIITVENDA-VLRDESCITVENDA;
  INSERT INTO VDITVENDA (
     CODEMP,CODFILIAL,TIPOVENDA,CODVENDA,CODITVENDA,
     CODEMPNT,CODFILIALNT,CODNAT,
     CODEMPPD,CODFILIALPD,CODPROD,
     CODEMPLE,CODFILIALLE,CODLOTE,
     QTDITVENDA,PRECOITVENDA,PERCDESCITVENDA,VLRDESCITVENDA,
     VLRCOMISITVENDA,PERCCOMISITVENDA,
     PERCICMSITVENDA,VLRBASEICMSITVENDA,VLRICMSITVENDA,
     PERCIPIITVENDA,VLRBASEIPIITVENDA,VLRIPIITVENDA,VLRLIQITVENDA,
     VLRPRODITVENDA,REFPROD,ORIGFISC,
     CODEMPTT,CODFILIALTT,CODTRATTRIB,TIPOFISC,
     CODEMPME,CODFILIALME,CODMENS,OBSITVENDA,
     CODEMPCV,CODFILIALCV,CODCONV) VALUES (
     :CODEMP,:CODFILIAL,'E',:CODVENDA,:CODITVENDA,
     :CODEMP,:ICODFILIALNT,:SCODNAT,
     :CODEMPPD,:CODFILIALPD,:CODPROD,
     :CODEMPLE,:CODFILIALLE,:SCODLOTE,
     :QTDITVENDA,:VLRPRECOITVENDA,:PERCDESCITVENDA,:VLRDESCITVENDA,
     :VLRCOMISITVENDA,:PERCCOMISITVENDA,
     :PERCICMSITVENDA,:VLRBASEICMSITVENDA,:VLRICMSITVENDA,
     :PERCIPIITVENDA,:VLRBASEIPIITVENDA,:VLRIPIITVENDA,:VLRLIQITVENDA,
     :VLRPRODITVENDA,:SREFPROD,:SORIGFISC,
     :CODEMP,:ICODFILIALTT,:SCODTRATTRIB,:TIPOFISC,
     :CODEMP,:ICODFILIALME,:ICODMENS,:OBSITORC,
     :CODEMP, :CODFILIALCV,:CODCONV);
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "VDITORCAMENTO"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"TIPOORC" CHAR(1) CHARACTER SET NONE DEFAULT 'O' NOT NULL,
"CODORC" INTEGER NOT NULL,
"CODITORC" INTEGER NOT NULL,
"CODEMPPD" INTEGER NOT NULL,
"CODFILIALPD" SMALLINT NOT NULL,
"CODPROD" INTEGER NOT NULL,
"CODEMPAX" INTEGER NOT NULL,
"CODFILIALAX" SMALLINT NOT NULL,
"CODALMOX" INTEGER NOT NULL,
"QTDITORC" "NUMERICDN" NOT NULL,
"PRECOITORC" "NUMERICDN" NOT NULL,
"PERCDESCITORC" NUMERIC(9,2),
"VLRDESCITORC" "NUMERICDN",
"VLRLIQITORC" "NUMERICDN",
"VLRPRODITORC" "NUMERICDN",
"REFPROD" CHAR(13) CHARACTER SET NONE,
"NUMAUTORIZORC" CHAR(15) CHARACTER SET NONE,
"ACEITEITORC" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"APROVITORC" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"EMITITORC" CHAR(1) CHARACTER SET NONE DEFAULT 'N' NOT NULL,
"VENCAUTORIZORC" DATE,
"STRDESCITORC" CHAR(50) CHARACTER SET NONE,
"OBSITORC" VARCHAR(502) CHARACTER SET NONE,
"STATUSITORC" CHAR(2) CHARACTER SET NONE,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"CODEMPPE" INTEGER,
"CODFILIALPE" SMALLINT,
"CODPE" INTEGER,
"DIASPE" SMALLINT,
"EMMANUT" CHAR(1) CHARACTER SET NONE,
"CODEMPLG" INTEGER,
"CODFILIALLG" INTEGER,
"CODLOG" INTEGER,
"CODEMPLE" INTEGER,
"CODFILIALLE" SMALLINT,
"CODLOTE" CHAR(13) CHARACTER SET NONE);
COMMIT WORK;

SET TERM ^ ;
ALTER PROCEDURE "VDADICITVENDAORCSP"("FILIALATUAL" INTEGER,
"ICODVENDA" INTEGER,
"ICODORC" INTEGER,
"ICODITORC" INTEGER,
"ICODFILIAL" SMALLINT,
"ICODEMP" INTEGER,
"STIPOVENDA" CHAR(10) CHARACTER SET NONE,
"TPAGRUP" CHAR(1) CHARACTER SET NONE,
"IQTDITVENDA" FLOAT)
 AS
DECLARE VARIABLE ICODITVENDA INTEGER;
DECLARE VARIABLE ICODFILIALIT SMALLINT;
DECLARE VARIABLE ICODFILIALNT SMALLINT;
DECLARE VARIABLE CODEMPAX INTEGER;
DECLARE VARIABLE CODFILIALAX INTEGER;
DECLARE VARIABLE CODALMOX INTEGER;
DECLARE VARIABLE ICODCLI INTEGER;
DECLARE VARIABLE ICODFILIALTM INTEGER;
DECLARE VARIABLE ICODTIPOMOV INTEGER;
DECLARE VARIABLE ICODFILIALCL INTEGER;
DECLARE VARIABLE SCODNAT CHAR(4);
DECLARE VARIABLE ICODFILIALLE SMALLINT;
DECLARE VARIABLE SCODLOTE CHAR(13);
DECLARE VARIABLE TIPOFISC CHAR(2);
DECLARE VARIABLE SORIGFISC CHAR(1);
DECLARE VARIABLE SCODTRATTRIB CHAR(2);
DECLARE VARIABLE ICODFILIALTT SMALLINT;
DECLARE VARIABLE ICODFILIALME SMALLINT;
DECLARE VARIABLE ICODMENS SMALLINT;
DECLARE VARIABLE PERCICMSITVENDA NUMERIC(9,2);
DECLARE VARIABLE VLRBASEICMSITVENDA NUMERIC(15,5);
DECLARE VARIABLE VLRICMSITVENDA NUMERIC(15,5);
DECLARE VARIABLE PERCIPIITVENDA NUMERIC(9,2);
DECLARE VARIABLE VLRBASEIPIITVENDA NUMERIC(15,5);
DECLARE VARIABLE VLRIPIITVENDA NUMERIC(15,5);
DECLARE VARIABLE ICODPROD INTEGER;
DECLARE VARIABLE ICODFILIALPD INTEGER;
DECLARE VARIABLE VLRPRECOITVENDA NUMERIC(15,5);
DECLARE VARIABLE PERCDESCITVENDA NUMERIC(9,2);
DECLARE VARIABLE VLRDESCITVENDA NUMERIC(15,5);
DECLARE VARIABLE VLRLIQITVENDA NUMERIC(15,5);
DECLARE VARIABLE VLRPRODITVENDA NUMERIC(15,5);
DECLARE VARIABLE SREFPROD CHAR(13);
DECLARE VARIABLE OBSITORC VARCHAR(500);
DECLARE VARIABLE UFCLI CHAR(2);
DECLARE VARIABLE UFFLAG CHAR(1);
DECLARE VARIABLE PERCRED NUMERIC(9,2);
DECLARE VARIABLE CLOTEPROD CHAR(1);
DECLARE VARIABLE ICONTA1 INTEGER;
DECLARE VARIABLE ICONTA2 INTEGER;
begin

  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'VDVENDA') INTO ICODFILIALIT;
  SELECT MAX(CODITVENDA)+1 FROM VDITVENDA WHERE CODVENDA=:ICODVENDA
    AND CODFILIAL=:ICODFILIALIT AND CODEMP=:ICODEMP AND TIPOVENDA=:STIPOVENDA INTO ICODITVENDA;

  IF (ICODITVENDA IS NULL) THEN
    ICODITVENDA = 1;

/*Informaes do Orcamento.:*/

  SELECT CODCLI,CODFILIALCL FROM VDORCAMENTO
    WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
    AND CODORC=:ICODORC INTO ICODCLI,ICODFILIALCL;

/*Informaes do ItOrcamento.:*/

  SELECT CODEMPPD,CODFILIALPD,CODPROD,PRECOITORC,PERCDESCITORC,VLRDESCITORC,
         VLRLIQITORC,VLRPRODITORC,REFPROD,OBSITORC,CODEMPAX,CODFILIALAX,CODALMOX FROM VDITORCAMENTO WHERE
         CODITORC=:ICODITORC AND CODORC=:ICODORC AND CODFILIAL=:ICODFILIAL AND CODEMP=:ICODEMP
         INTO ICODEMP,ICODFILIALPD,ICODPROD,VLRPRECOITVENDA,PERCDESCITVENDA,VLRDESCITVENDA,
           VLRLIQITVENDA,VLRPRODITVENDA,SREFPROD,OBSITORC,CODEMPAX,CODFILIALAX,CODALMOX;

/*Informaes fiscais.:*/

  SELECT C.UFCLI FROM VDORCAMENTO O, VDCLIENTE C WHERE
    O.CODORC=:ICODORC AND O.CODFILIAL=:ICODFILIAL AND O.CODEMP=:ICODEMP AND
    C.CODCLI=O.CODCLI AND C.CODFILIAL=O.CODFILIALCL AND C.CODEMP=O.CODEMPCL
    INTO UFCLI;

  UFFLAG = 'N';

  SELECT 'S' FROM SGFILIAL  WHERE CODEMP=:ICODEMP
    AND CODFILIAL=:ICODFILIAL AND UFFILIAL=:UFCLI INTO UFFLAG;

  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'VDVENDA') INTO ICODFILIALIT;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'LFNATOPER') INTO ICODFILIALNT;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'LFTRATTRIB') INTO ICODFILIALTT;
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'LFMENSAGEM') INTO ICODFILIALME;

  SELECT C.ALIQIPIFISC,P.CLOTEPROD
    FROM VDITORCAMENTO IT, EQPRODUTO P, LFCLFISCAL C WHERE
    IT.CODEMP=:ICODEMP AND IT.CODFILIAL=:ICODFILIAL AND IT.CODITORC=:ICODITORC AND
    IT.CODORC=:ICODORC AND P.CODPROD = IT.CODPROD AND P.CODFILIAL = IT.CODFILIALPD AND
    P.CODEMP = IT.CODEMPPD AND C.CODFISC = P.CODFISC AND C.CODFILIAL = P.CODFILIALFC AND
    C.CODEMP = P.CODEMPFC INTO PERCIPIITVENDA,CLOTEPROD;

  SELECT CODTIPOMOV,CODFILIALTM FROM VDVENDA WHERE
    CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
    AND CODVENDA=:ICODVENDA AND TIPOVENDA=:STIPOVENDA
  INTO ICODTIPOMOV,ICODFILIALTM;

  SELECT CODNAT FROM
    LFBUSCANATSP(:FILIALATUAL,:ICODEMP,:ICODFILIALPD,
      :ICODPROD,:ICODEMP,:ICODFILIALCL,:ICODCLI,
      NULL,NULL,NULL,:ICODFILIALTM,:ICODTIPOMOV)
    INTO SCODNAT;
    
  IF (SCODNAT IS NULL) THEN
    EXCEPTION VDITVENDAEX03;

  SELECT TIPOFISC,REDFISC,CODTRATTRIB,ORIGFISC,CODMENS,ALIQFISC FROM
    LFBUSCAFISCALSP(:FILIALATUAL,:ICODEMP,:ICODFILIALPD,:ICODPROD,:ICODEMP,:ICODFILIALCL,:ICODCLI)
    INTO TIPOFISC,PERCRED,SCODTRATTRIB,SORIGFISC,ICODMENS,PERCICMSITVENDA;

/*Cod Lote.:*/

  IF (CLOTEPROD = 'S') THEN
  BEGIN
    SELECT FIRST 1 L.CODLOTE FROM EQLOTE L WHERE
      L.CODPROD=:ICODPROD AND L.CODFILIAL=:ICODFILIALPD
       AND L.CODEMP=:ICODEMP AND L.VENCTOLOTE =
         (
           SELECT MIN(VENCTOLOTE) FROM EQLOTE LS WHERE LS.CODPROD=L.CODPROD AND LS.CODFILIAL=L.CODFILIAL
             AND LS.CODEMP=L.CODEMP AND LS.SLDLIQLOTE>=:IQTDITVENDA
         ) AND L.SLDLIQLOTE>=:IQTDITVENDA INTO SCODLOTE;
    ICODFILIALLE = ICODFILIALPD;
  END

  VLRLIQITVENDA = VLRPRODITVENDA - VLRDESCITVENDA;
  VLRBASEIPIITVENDA = 0;
  VLRBASEICMSITVENDA = 0;
  VLRICMSITVENDA = 0;
  VLRIPIITVENDA = 0;

  IF ( TIPOFISC = 'II') THEN
  BEGIN
    PERCICMSITVENDA = 0;
    VLRICMSITVENDA = 0;
    VLRBASEICMSITVENDA = 0;
    PERCIPIITVENDA = 0;
    VLRIPIITVENDA = 0;
    VLRBASEIPIITVENDA = 0;
  END
  ELSE IF ( TIPOFISC = 'FF') THEN
  BEGIN
    PERCICMSITVENDA = 0;
    VLRICMSITVENDA = 0;
    VLRBASEICMSITVENDA = 0;
    PERCIPIITVENDA = 0;
    VLRIPIITVENDA = 0;
    VLRBASEIPIITVENDA = 0;
  END
  ELSE IF ( TIPOFISC = 'NN') THEN
  BEGIN
    PERCICMSITVENDA = 0;
    VLRICMSITVENDA = 0;
    VLRBASEICMSITVENDA = 0;
    PERCIPIITVENDA = 0;
    VLRIPIITVENDA = 0;
    VLRBASEIPIITVENDA = 0;
  END
  ELSE IF ( TIPOFISC = 'TT') THEN
  BEGIN
    IF (PERCICMSITVENDA = 0 OR PERCICMSITVENDA IS NULL) THEN
      SELECT PERCICMS FROM LFBUSCAICMSSP (:SCODNAT,:UFCLI,:ICODEMP,:ICODFILIAL) INTO PERCICMSITVENDA;
    IF (PERCRED IS NULL) THEN
      PERCRED = 0;
    VLRBASEICMSITVENDA = VLRPRODITVENDA - (VLRPRODITVENDA*(PERCRED/100));
    VLRBASEIPIITVENDA = VLRPRODITVENDA;
    VLRICMSITVENDA = VLRBASEICMSITVENDA*(PERCICMSITVENDA/100);
    VLRIPIITVENDA = VLRBASEIPIITVENDA*(PERCIPIITVENDA/100);
  END

  IF ( (TPAGRUP <> 'F') ) THEN
  BEGIN
  INSERT INTO VDITVENDA (CODEMP,CODFILIAL,CODVENDA,TIPOVENDA,CODITVENDA,CODEMPNT,CODFILIALNT,CODNAT,CODEMPPD,
     CODFILIALPD,CODPROD,CODEMPLE,CODFILIALLE,CODLOTE,QTDITVENDA,PRECOITVENDA,PERCDESCITVENDA,VLRDESCITVENDA,
     PERCICMSITVENDA,VLRBASEICMSITVENDA,VLRICMSITVENDA,PERCIPIITVENDA,VLRBASEIPIITVENDA,VLRIPIITVENDA,
     VLRLIQITVENDA,VLRPRODITVENDA,REFPROD,ORIGFISC,CODEMPTT,CODFILIALTT,CODTRATTRIB,TIPOFISC,
     CODEMPME,CODFILIALME,CODMENS,OBSITVENDA,CODEMPAX,CODFILIALAX,CODALMOX)
     VALUES (:ICODEMP,:ICODFILIAL,:ICODVENDA,:STIPOVENDA,:ICODITVENDA,:ICODEMP,
     :ICODFILIALNT,:SCODNAT,:ICODEMP,:ICODFILIALPD,:ICODPROD,:ICODEMP,:ICODFILIALPD,:SCODLOTE,:IQTDITVENDA,
     :VLRPRECOITVENDA,:PERCDESCITVENDA,:VLRDESCITVENDA,:PERCICMSITVENDA,:VLRBASEICMSITVENDA,:VLRICMSITVENDA,
     :PERCIPIITVENDA,:VLRBASEIPIITVENDA,:VLRIPIITVENDA,:VLRLIQITVENDA,:VLRPRODITVENDA,:SREFPROD,:SORIGFISC,
     :ICODEMP,:ICODFILIALTT,:SCODTRATTRIB,:TIPOFISC,:ICODEMP,:ICODFILIALME,:ICODMENS,:OBSITORC,
     :CODEMPAX,:CODFILIALAX,:CODALMOX);
  END

  EXECUTE PROCEDURE VDUPVENDAORCSP(:ICODEMP,:ICODFILIAL,:ICODORC,:ICODITORC,
                    :ICODFILIAL,:ICODVENDA,:ICODITVENDA,:STIPOVENDA);
end
^

SET TERM ; ^

COMMIT WORK;


Update Rdb$Procedure_Parameters set Rdb$Description =
'Indica se deve gerar item de venda para o tem de oramento. (Usado em caso de agrupamento de tens de oramento).'
where Rdb$Procedure_Name='VDADICITVENDAORCSP' and Rdb$Parameter_Name='TPAGRUP';
Update Rdb$Procedure_Parameters set Rdb$Description =
'Quantidade do tem de venda.'
where Rdb$Procedure_Name='VDADICITVENDAORCSP' and Rdb$Parameter_Name='IQTDITVENDA';

COMMIT WORK;

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "VDVENDEDOR"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODVEND" INTEGER NOT NULL,
"NOMEVEND" CHAR(40) CHARACTER SET NONE,
"ENDVEND" CHAR(50) CHARACTER SET NONE,
"NUMVEND" INTEGER,
"COMPLVEND" CHAR(20) CHARACTER SET NONE,
"BAIRVEND" CHAR(30) CHARACTER SET NONE,
"CIDVEND" CHAR(30) CHARACTER SET NONE,
"CEPVEND" CHAR(8) CHARACTER SET NONE,
"UFVEND" CHAR(2) CHARACTER SET NONE,
"FONEVEND" CHAR(12) CHARACTER SET NONE,
"FAXVEND" CHAR(8) CHARACTER SET NONE,
"EMAILVEND" CHAR(50) CHARACTER SET NONE,
"PERCCOMVEND" NUMERIC(7,3),
"COMIPIVEND" CHAR(1) CHARACTER SET NONE,
"CODEMPPN" INTEGER,
"CODFILIALPN" SMALLINT,
"CODPLAN" CHAR(13) CHARACTER SET NONE,
"CPFVEND" CHAR(11) CHARACTER SET NONE,
"RGVEND" CHAR(10) CHARACTER SET NONE,
"CNPJVEND" CHAR(14) CHARACTER SET NONE,
"INSCVEND" CHAR(15) CHARACTER SET NONE,
"CELVEND" CHAR(12) CHARACTER SET NONE,
"CODEMPSE" INTEGER,
"CODFILIALSE" INTEGER,
"CODSETOR" INTEGER,
"CODEMPCM" INTEGER,
"CODFILIALCM" INTEGER,
"CODCLCOMIS" INTEGER,
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"CODFORNVEND" CHAR(13) CHARACTER SET NONE,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now',
"CODFUNC" INTEGER,
"CODEMPFU" INTEGER,
"CODFILIALFU" SMALLINT,
"DDDFONEVEND" CHAR(4) CHARACTER SET NONE,
"DDDFAXVEND" CHAR(4) CHARACTER SET NONE,
"DDDCELVEND" CHAR(4) CHARACTER SET NONE,
"SSPVEND" CHAR(10) CHARACTER SET NONE,
"OBSVEND" VARCHAR(500) CHARACTER SET NONE,
"ATIVOCOMIS" CHAR(1) CHARACTER SET NONE DEFAULT 'S' NOT NULL,
"IMGASSVEND" BLOB SEGMENT SIZE 50);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "VDADICVENDAORCSP"("ICODORC" INTEGER,
"ICODFILIAL" SMALLINT,
"ICODEMP" INTEGER,
"STIPOVENDA" CHAR(10) CHARACTER SET NONE,
"NEWCODVENDA" INTEGER)
 RETURNS("IRET" INTEGER)
 AS
DECLARE VARIABLE ICODVENDA INTEGER;
DECLARE VARIABLE IFILIALVD SMALLINT;
DECLARE VARIABLE ICODTIPOMOV INTEGER;
DECLARE VARIABLE IFILIALTM SMALLINT;
DECLARE VARIABLE SSERIE CHAR(4);
DECLARE VARIABLE IFILIALSE SMALLINT;
DECLARE VARIABLE SSTATUSVENDA CHAR(2);
DECLARE VARIABLE DPERCCOMVEND NUMERIC(9,2);
DECLARE VARIABLE ICODVEND INTEGER;
DECLARE VARIABLE ICODFILIALVD INTEGER;
DECLARE VARIABLE ICODCLI INTEGER;
DECLARE VARIABLE ICODFILIALCL INTEGER;
DECLARE VARIABLE ICODPLANOPAG INTEGER;
DECLARE VARIABLE ICODFILIALPG INTEGER;
DECLARE VARIABLE USAPEDSEQ CHAR(1);
DECLARE VARIABLE ICONTA INTEGER;
DECLARE VARIABLE ICODCLCOMIS INTEGER;
DECLARE VARIABLE ICODFILIALCM INTEGER;
BEGIN

/*Cod. Tipo Mov e Sequencia:*/
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'EQTIPOMOV') INTO IFILIALTM;
  SELECT COUNT(P.TIPOPROD) FROM EQPRODUTO P, VDITORCAMENTO I WHERE
    P.CODPROD=I.CODPROD AND P.CODFILIAL=I.CODFILIALPD AND P.CODEMP=I.CODEMPPD
    AND P.TIPOPROD = 'S' AND I.CODORC=:ICODORC
    AND I.CODFILIAL=:ICODFILIAL AND I.CODEMP=:ICODEMP INTO ICONTA;
    
  IF (ICONTA > 0) THEN
    SELECT CODTIPOMOV4,USAPEDSEQ FROM SGPREFERE1
      WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
      INTO ICODTIPOMOV,USAPEDSEQ;
  IF (ICODTIPOMOV IS NULL) THEN  /* CASO AINDA O IF DE CIMA NAO TENHA PREECHIDO... */
    SELECT CODTIPOMOV3,USAPEDSEQ FROM SGPREFERE1
      WHERE CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL
      INTO ICODTIPOMOV,USAPEDSEQ;

/*Informaes basicas:*/

  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'VDVENDA') INTO IFILIALVD;
  IF (USAPEDSEQ='S') THEN
    SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALVD,'VD') INTO ICODVENDA;
  ELSE
    IF ((:NEWCODVENDA > 0) AND (:NEWCODVENDA IS NOT NULL)) THEN
      ICODVENDA = :NEWCODVENDA;
    ELSE
      SELECT MAX(CODVENDA)+1 FROM VDVENDA
        WHERE CODEMP=:ICODEMP AND CODFILIAL=:IFILIALVD
        INTO ICODVENDA;

/*Serie:*/
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'LFSERIE') INTO IFILIALSE;
  SELECT SERIE FROM EQTIPOMOV WHERE CODEMP=:ICODEMP AND CODFILIAL=:IFILIALTM AND CODTIPOMOV=:ICODTIPOMOV INTO SSERIE;

/*Status:*/
  SSTATUSVENDA = 'P1';

/*Busca no oramento:*/
  SELECT O.CODFILIALVD,O.CODVEND,O.CODFILIALCL,O.CODCLI,O.CODFILIALPG,
    O.CODPLANOPAG,VE.PERCCOMVEND,O.CODCLCOMIS,O.CODFILIALCM
    FROM VDORCAMENTO O, VDVENDEDOR VE WHERE O.CODORC=:ICODORC
    AND O.CODFILIAL=:ICODFILIAL AND O.CODEMP=:ICODEMP
    AND VE.CODEMP=O.CODEMP AND VE.CODFILIAL=O.CODFILIALVD
    AND VE.CODVEND=O.CODVEND INTO
           :ICODFILIALVD,:ICODVEND,:ICODFILIALCL,:ICODCLI,
           :ICODFILIALPG,:ICODPLANOPAG,DPERCCOMVEND,:ICODCLCOMIS,:ICODFILIALCM;

  INSERT INTO VDVENDA (CODEMP,CODFILIAL,CODVENDA,TIPOVENDA,CODEMPVD,CODFILIALVD,CODVEND,CODEMPCL,CODFILIALCL,CODCLI,
                CODEMPPG,CODFILIALPG,CODPLANOPAG,CODEMPSE,CODFILIALSE,SERIE,CODEMPTM,CODFILIALTM,
                CODTIPOMOV,DTSAIDAVENDA,DTEMITVENDA,STATUSVENDA,PERCCOMISVENDA,CODCLCOMIS,CODFILIALCM,CODEMPCM)
                VALUES (:ICODEMP,:IFILIALVD,:ICODVENDA,:STIPOVENDA,:ICODEMP,:ICODFILIALVD,
                :ICODVEND,:ICODEMP,:ICODFILIALCL,:ICODCLI,:ICODEMP,:ICODFILIALPG,:ICODPLANOPAG,
                :ICODEMP,:IFILIALSE,:SSERIE,:ICODEMP,:IFILIALTM,:ICODTIPOMOV,
                CAST('today' AS DATE),CAST('today' AS DATE),:SSTATUSVENDA,:DPERCCOMVEND,:ICODCLCOMIS,:ICODFILIALCM,:ICODEMP);

  IRET = ICODVENDA;

  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "FNPAGTOCOMI"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" SMALLINT NOT NULL,
"CODPCOMI" INTEGER NOT NULL,
"CODEMPPN" INTEGER NOT NULL,
"CODFILIALPN" SMALLINT NOT NULL,
"CODPLAN" CHAR(13) CHARACTER SET NONE NOT NULL,
"CODEMPCA" INTEGER NOT NULL,
"CODFILIALCA" SMALLINT NOT NULL,
"NUMCONTA" CHAR(10) CHARACTER SET NONE NOT NULL,
"VLRPCOMI" "NUMERICDN" DEFAULT 0,
"DOCPCOMI" INTEGER NOT NULL,
"OBSPCOMI" VARCHAR(300) CHARACTER SET NONE,
"DATAPCOMI" DATE NOT NULL,
"FLAG" CHAR(1) CHARACTER SET NONE DEFAULT 'N',
"DTINS" DATE DEFAULT 'now',
"IDUSUINS" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"DTALT" DATE DEFAULT 'now',
"IDUSUALT" CHAR(8) CHARACTER SET NONE DEFAULT USER,
"HINS" TIME DEFAULT 'now',
"HALT" TIME DEFAULT 'now');
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "VDBAIXACOMISSAOSP"("STIPO" CHAR(1) CHARACTER SET NONE,
"DINI" DATE,
"DFIM" DATE,
"ICODVEND" INTEGER,
"ICODEMPVD" INTEGER,
"ICODFILIALVD" SMALLINT,
"SCODCONTA" CHAR(10) CHARACTER SET NONE,
"ICODEMPCA" INTEGER,
"ICODFILIALCA" SMALLINT,
"SCODPLAN" CHAR(13) CHARACTER SET NONE,
"ICODEMPPN" INTEGER,
"ICODFILIALPN" SMALLINT,
"DDATA" DATE,
"IDOC" INTEGER,
"DVLR" NUMERIC(15,5),
"SOBS" CHAR(50) CHARACTER SET NONE,
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT)
 AS
DECLARE VARIABLE ICODPCOMI INTEGER;
DECLARE VARIABLE ICODCOMI INTEGER;
DECLARE VARIABLE ICODEMPCOMI INTEGER;
DECLARE VARIABLE ICODFILIALCOMI INTEGER;
DECLARE VARIABLE CFLAG CHAR(1);
DECLARE VARIABLE IFILIALPCOMI INTEGER;
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:ICODEMP,'FNPAGTOCOMI') INTO IFILIALPCOMI;
  SELECT ISEQ FROM SPGERANUM(:ICODEMP,:IFILIALPCOMI,'CI') INTO ICODPCOMI;
  INSERT INTO FNPAGTOCOMI(CODEMP,CODFILIAL,CODPCOMI,CODEMPCA,CODFILIALCA,NUMCONTA,CODEMPPN,CODFILIALPN,CODPLAN,DATAPCOMI,DOCPCOMI,VLRPCOMI,OBSPCOMI)
         VALUES (
                :ICODEMP,:IFILIALPCOMI,:iCodPComi,:ICODEMPCA,:ICODFILIALCA,:sCodConta,:ICODEMPPN,:ICODFILIALPN,:sCodPlan,:dData,:iDoc,:dVlr,:sObs
         );
  FOR SELECT C.CODCOMI,C.CODEMP,C.CODFILIAL,C.FLAG FROM VDCOMISSAO C,FNRECEBER R WHERE R.CODVEND=:iCodVend
               AND R.CODEMPVD=:ICODEMPVD AND R.CODFILIALVD=:ICODFILIALVD
               AND C.CODREC=R.CODREC AND C.CODEMPRC=R.CODEMP AND C.CODFILIALRC=R.CODFILIAL
               AND ( (:STIPO='E') OR  (C.DTVENCCOMI BETWEEN :dIni AND :dFim) )
               AND ( (:STIPO='V') OR  (C.DATACOMI BETWEEN :dIni AND :dFim) )
               AND STATUSCOMI='C2'
               AND R.CODEMP=:ICODEMP AND R.CODFILIAL=:ICODFILIAL
               INTO :iCodComi,:iCodEmpComi,:iCodFilialComi,:cFLAG DO
  BEGIN
     UPDATE VDCOMISSAO SET VLRPAGOCOMI=VLRAPAGCOMI, CODPCOMI=:iCodPComi,CODEMPCI=:ICODEMP,
        CODFILIALCI=:IFILIALPCOMI,STATUSCOMI='CP',DTPAGTOCOMI=:dData,FLAG=:cFLAG
      WHERE CODCOMI=:iCodComi AND CODEMP=:iCodEmpComi AND CODFILIAL=:iCodFilialComi;
  END
END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "VDBLOQVENDASP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"CTIPOVENDA" CHAR(1) CHARACTER SET NONE,
"ICODVENDA" INTEGER,
"CBLOQVENDA" CHAR(1) CHARACTER SET NONE)
 AS
begin
  /* Stored procedure de bloqueio e desbloqueio de venda*/
  UPDATE VDVENDA SET EMMANUT='S', BLOQVENDA=:CBLOQVENDA WHERE CODEMP=:ICODEMP AND
     CODFILIAL=:SCODFILIAL AND TIPOVENDA=:CTIPOVENDA AND CODVENDA=:ICODVENDA;
  UPDATE VDVENDA SET EMMANUT='N' WHERE CODEMP=:ICODEMP AND
     CODFILIAL=:SCODFILIAL AND TIPOVENDA=:CTIPOVENDA AND CODVENDA=:ICODVENDA;
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "VDBUSCAPRECOSP"("ICODPROD" INTEGER,
"ICODCLI" INTEGER,
"ICODEMPCL" INTEGER,
"ICODFILIALCL" SMALLINT,
"ICODPLANOPAG" INTEGER,
"ICODEMPPG" INTEGER,
"ICODFILIALPG" SMALLINT,
"ICODTIPOMOV" INTEGER,
"ICODEMPTM" INTEGER,
"ICODFILIALTM" SMALLINT,
"ICODEMP" INTEGER,
"ICODFILIAL" SMALLINT)
 RETURNS("PRECO" NUMERIC(18,2))
 AS
DECLARE VARIABLE iCodTab INTEGER;
  DECLARE VARIABLE iCodEmpTab INTEGER;
  DECLARE VARIABLE iCodFilialTab SMALLINT;
  DECLARE VARIABLE iCodClasCli INTEGER;
  DECLARE VARIABLE iCodEmpClasCli INTEGER;
  DECLARE VARIABLE iCodFilialClasCli SMALLINT;
BEGIN
  SELECT CODTAB,CODEMPTB,CODFILIALTB FROM EQTIPOMOV WHERE CODTIPOMOV=:iCodTipoMov
         AND CODEMP=:ICODEMPTM AND CODFILIAL=:ICODFILIALTM INTO :iCodTab,:iCodEmpTab,:iCodFilialTab;
  SELECT CODCLASCLI,CODEMPCC,CODFILIALCC FROM VDCLIENTE WHERE CODCLI=:iCodCli
         AND CODEMP=:ICODEMPCL AND CODFILIAL=:ICODFILIALCL INTO :iCodClasCli,:iCodEmpClasCli,iCodFilialClasCli;
  SELECT PRECOPROD FROM VDPRECOPROD WHERE CODPROD=:iCodProd
         AND CODPLANOPAG=:iCodPlanoPag
         AND CODEMPPG=:ICODEMPPG
         AND CODFILIALPG=:ICODFILIALPG
         AND CODTAB=:iCodTab
         AND CODEMPTB=:iCodEmpTab
         AND CODFILIALTB=:iCodFilialTab
         AND CODCLASCLI=:iCodClasCli
         AND CODEMPCC=:iCodEmpClasCli
         AND CODFILIALCC=:iCodFilialClasCli
         AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO :Preco;
  if ((Preco IS NULL) OR (Preco = 0)) THEN
  BEGIN
    SELECT MAX(PRECOPROD) FROM VDPRECOPROD WHERE CODPROD=:iCodProd
         AND CODPLANOPAG=:iCodPlanoPag
         AND CODEMPPG=:ICODEMPPG
         AND CODFILIALPG=:ICODFILIALPG
         AND CODTAB=:iCodTab
         AND CODEMPTB=:iCodEmpTab
         AND CODFILIALTB=:iCodFilialTab
         AND CODCLASCLI IS NULL
         AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO :Preco;
  END
  /*Se ainda no conseguiu pagar o preco.*/
  if ((Preco IS NULL) OR (Preco = 0)) THEN
  BEGIN
    SELECT PRECOBASEPROD FROM EQPRODUTO WHERE CODPROD=:ICODPROD AND
      CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO :Preco;
  END
  SUSPEND;
END
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "VDCLIENTEATIVOSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODCLI" INTEGER)
 AS
DECLARE VARIABLE CATIVOCLI CHAR(1);
begin
  SELECT ATIVOCLI FROM VDCLIENTE WHERE CODEMP=:ICODEMP AND
    CODFILIAL=:SCODFILIAL AND CODCLI=:ICODCLI
    INTO :CATIVOCLI;
  IF ( (CATIVOCLI IS NOT NULL) AND (CATIVOCLI='N') ) then
     exception vdvendaex01 'CLIENTE INATIVO!';
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "VDCOPIAORCSP"("CODEMP" INTEGER,
"CODFILIAL" INTEGER,
"CODORC" INTEGER,
"CODFILIALCL" INTEGER,
"CODCLI" INTEGER)
 RETURNS("IRET" INTEGER)
 AS
DECLARE VARIABLE ICODORC INTEGER;
DECLARE VARIABLE ICODFILIALPF INTEGER;
DECLARE VARIABLE CUSAORCSEQ CHAR(1);
BEGIN
  SELECT ICODFILIAL FROM SGRETFILIAL(:CODEMP, 'SGPREFERE1')
    INTO :ICODFILIALPF;
  SELECT USAORCSEQ FROM SGPREFERE1 P
     WHERE P.CODEMP=:CODEMP AND P.CODFILIAL=:ICODFILIALPF
     INTO :CUSAORCSEQ;
  IF (CUSAORCSEQ='S') THEN
  BEGIN
     SELECT ISEQ FROM SPGERANUM(:CODEMP,:CODFILIAL,'OC') INTO ICODORC;
  END
  ELSE
  BEGIN
     SELECT COALESCE(MAX(O.CODORC),0)+1 FROM VDORCAMENTO O
       WHERE O.CODEMP=:CODEMP AND O.CODFILIAL=:CODFILIAL AND
       O.TIPOORC='O' INTO ICODORC;
  END

  INSERT INTO VDORCAMENTO (CODEMP,CODFILIAL,TIPOORC,CODORC,
    CODEMPAE,CODFILIALAE,CODATEND,CODEMPCV,CODFILIALCV,CODCONV,
    DTORC,DTVENCORC,VLRPRODORC,PERCDESCORC,VLRDESCORC,VLRADICORC,
    VLRDESCITORC,VLRLIQORC,STATUSORC,OBSORC,CODPLANOPAG,CODFILIALPG,
    CODEMPPG,TXT01,CODEMPVD,CODFILIALVD,CODVEND,CODEMPCL,CODFILIALCL,
    CODCLI,CODTPCONV,CODFILIALTC,CODEMPTC,PRAZOENTORC)
    SELECT CODEMP,CODFILIAL,'O',:ICODORC,CODEMPAE,CODFILIALAE,
      CODATEND,CODEMPCV,CODFILIALCV,CODCONV,DTORC,DTVENCORC,VLRPRODORC,
      PERCDESCORC,VLRDESCORC,VLRADICORC,VLRDESCITORC,VLRLIQORC,
      STATUSORC,OBSORC,CODPLANOPAG,CODFILIALPG,CODEMPPG,TXT01,CODEMPVD,
      CODFILIALVD,CODVEND,:CODEMP,:CODFILIALCL,:CODCLI,CODTPCONV,
      CODFILIALTC,CODEMPTC,PRAZOENTORC FROM VDORCAMENTO WHERE
      CODORC=:CODORC AND CODEMP=:CODEMP AND CODFILIAL=:CODFILIAL;

  INSERT INTO VDITORCAMENTO (CODEMP,CODFILIAL,TIPOORC,CODORC,CODITORC,
    CODEMPPD,CODFILIALPD,CODPROD,QTDITORC,PRECOITORC,PERCDESCITORC,
    VLRDESCITORC,VLRLIQITORC,VLRPRODITORC,REFPROD,NUMAUTORIZORC,ACEITEITORC,
    APROVITORC,EMITITORC,VENCAUTORIZORC,STRDESCITORC,OBSITORC,
    CODEMPAX, CODFILIALAX, CODALMOX)
    SELECT CODEMP,CODFILIAL,TIPOORC,:ICODORC,CODITORC,
      CODEMPPD,CODFILIALPD,CODPROD,QTDITORC,PRECOITORC,PERCDESCITORC,
      VLRDESCITORC,VLRLIQITORC,VLRPRODITORC,REFPROD,NUMAUTORIZORC,ACEITEITORC,
      APROVITORC,EMITITORC,VENCAUTORIZORC,STRDESCITORC,OBSITORC,
      CODEMPAX, CODFILIALAX, CODALMOX
      FROM VDITORCAMENTO WHERE CODORC=:CODORC AND CODEMP=:CODEMP
      AND CODFILIAL=:CODFILIAL;
  IRET = ICODORC;
  SUSPEND;
END^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "VDDESBAIXACOMISSAOSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODVEND" INTEGER,
"CORDEM" CHAR(1) CHARACTER SET NONE,
"DINI" DATE,
"DFIM" DATE)
 AS
DECLARE VARIABLE SCODFILIALCI SMALLINT;
DECLARE VARIABLE ICODPCOMI INTEGER;
DECLARE VARIABLE IQTD INTEGER;
begin
  /* Procedure Text */
  FOR SELECT CODFILIALCI,CODPCOMI,COUNT(*)
     FROM VDCOMISSAO C, FNRECEBER R
     WHERE R.CODEMPVD = :ICODEMP AND R.CODFILIALVD = :SCODFILIAL AND R.CODVEND = :ICODVEND AND
        C.CODREC = R.CODREC AND C.CODEMPRC = R.CODEMP AND C.CODFILIALRC = R.CODFILIAL AND
        C.STATUSCOMI = 'CP' AND C.CODPCOMI IS NOT NULL AND
         ( (:CORDEM = 'V')  OR (C.DATACOMI BETWEEN :DINI AND :DFIM) ) AND
         ( (:CORDEM = 'E')  OR (C.DTVENCCOMI BETWEEN :DINI AND :DFIM) )
         GROUP BY CODFILIALCI,CODPCOMI
         INTO  :SCODFILIALCI, :ICODPCOMI, :IQTD
         DO
     BEGIN
        UPDATE VDCOMISSAO SET STATUSCOMI='CD'
           WHERE CODEMPCI=:ICODEMP AND
             CODFILIALCI=:SCODFILIALCI AND
             CODPCOMI=:ICODPCOMI;
        DELETE FROM FNPAGTOCOMI
           WHERE CODEMP=:ICODEMP AND
             CODFILIAL=:SCODFILIALCI AND
             CODPCOMI=:ICODPCOMI;
     END
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "VDESTORNACOMISSAOSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODEMPVD" INTEGER,
"SCODFILIALVD" SMALLINT,
"ICODVEND" INTEGER,
"DINI" DATE,
"DFIM" DATE,
"CORDEM" CHAR(1) CHARACTER SET NONE)
 AS
DECLARE VARIABLE ICODCOMI INTEGER;
DECLARE VARIABLE ICODEMPRC INTEGER;
DECLARE VARIABLE SCODFILIALRC SMALLINT;
DECLARE VARIABLE ICODREC INTEGER;
DECLARE VARIABLE INPARCITREC INTEGER;
DECLARE VARIABLE NVLRVENDACOMI NUMERIC(15, 5);
DECLARE VARIABLE NVLRCOMI NUMERIC(15, 5);
DECLARE VARIABLE DDATACOMI DATE;
DECLARE VARIABLE DDTVENCCOMI DATE;
DECLARE VARIABLE CTIPOCOMI CHAR(1);
DECLARE VARIABLE CSTATUSCOMI CHAR(2);
DECLARE VARIABLE DATUAL DATE;
DECLARE VARIABLE CSTATUSITREC CHAR(2);
DECLARE VARIABLE DDTVENCITREC DATE;
begin
  /* Procedure Text */
  DATUAL = CAST( 'now' AS DATE);
  FOR SELECT C.CODCOMI,C.CODEMPRC, C.CODFILIALRC , C.CODREC, C.NPARCITREC,
      C.VLRVENDACOMI, C.VLRCOMI, C.DATACOMI , C.DTVENCCOMI,
      C.TIPOCOMI, C.STATUSCOMI , IR.STATUSITREC, IR.DTVENCITREC
    FROM VDCOMISSAO C, FNITRECEBER IR, FNRECEBER R
    WHERE C.CODEMP=:ICODEMP AND C.CODFILIAL=:SCODFILIAL AND
       IR.CODEMP=C.CODEMPRC AND IR.CODFILIAL=C.CODFILIALRC AND
       IR.CODREC=C.CODREC AND IR.NPARCITREC=C.NPARCITREC AND
       R.CODEMP=C.CODEMPRC AND R.CODFILIAL=C.CODFILIALRC AND
       R.CODREC=C.CODREC AND R.CODEMPVD=:ICODEMPVD AND
       R.CODFILIALVD=:SCODFILIALVD AND R.CODVEND=:ICODVEND AND
       ( (:CORDEM = 'V')  OR (C.DATACOMI BETWEEN :DINI AND :DFIM) ) AND
       ( (:CORDEM = 'E')  OR (C.DTVENCCOMI BETWEEN :DINI AND :DFIM) ) AND
       C.STATUSCOMI IN ('C2','CP') AND
       IR.STATUSITREC NOT IN ('RP') AND
       NOT EXISTS(SELECT * FROM VDCOMISSAO C2 /* Sub-select para verificar a */
          /* existencia de estorno anterior. */
         WHERE C2.CODEMPRC=C.CODEMPRC AND C2.CODFILIALRC=C.CODFILIALRC AND
         C2.CODREC=C.CODREC AND C2.NPARCITREC=C.NPARCITREC AND
         C2.TIPOCOMI=C.TIPOCOMI AND C2.STATUSCOMI IN ('CE') )
    INTO :ICODCOMI, :ICODEMPRC, :SCODFILIALRC, :ICODREC, :INPARCITREC, :NVLRVENDACOMI,
      :NVLRCOMI, :DDATACOMI, :DDTVENCCOMI, :CTIPOCOMI, :CSTATUSCOMI, :CSTATUSITREC,
      :DDTVENCITREC
  DO
  BEGIN
     IF ( (DATUAL>DDTVENCITREC) AND (CSTATUSCOMI='C2') ) THEN
     /* Caso a data atual seja maior que a data de vencimento e a */
     /* comisso no esteja paga, passa o status da comisso para no */
     /* liberada. */
     BEGIN
        UPDATE VDCOMISSAO SET STATUSCOMI='C1'
          WHERE CODEMP=:ICODEMP AND CODFILIAL=:SCODFILIAL AND
            CODCOMI=:ICODCOMI;
     END
     ELSE IF ( (DATUAL>DDTVENCITREC) AND (CSTATUSCOMI='CP') ) THEN
     /* Caso a comisso esteja paga e a parcela esteja vencida, */
     /* gera um estorno da comisso. */
     BEGIN
        NVLRCOMI = NVLRCOMI * -1; /* Transforma o valor da comisso em negativo */
        /* para gerar estorno */
        EXECUTE PROCEDURE vdadiccomissaosp(:ICODEMPRC,:SCODFILIALRC,:ICODREC,
          :INPARCITREC, :NVLRVENDACOMI, :NVLRCOMI, :DDATACOMI , :DDTVENCITREC,
          :CTIPOCOMI );
     END
  END
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "VDEVOLUVENDAS"("ICODEMP" SMALLINT,
"ICODFILIAL" SMALLINT,
"DATAINI" DATE,
"DATAFIM" DATE,
"ICODTIPOCLI" SMALLINT,
"ICODCLI" SMALLINT,
"FILTRAVENDAS" CHAR(1) CHARACTER SET NONE)
 RETURNS("VALOR" NUMERIC(15,5),
"MES" SMALLINT,
"ANO" SMALLINT)
 AS
DECLARE VARIABLE VALORTMP NUMERIC(15, 5);
DECLARE VARIABLE DATATMP DATE;
DECLARE VARIABLE MESTMP SMALLINT;
DECLARE VARIABLE ANOTMP SMALLINT;
DECLARE VARIABLE MESANT SMALLINT;
DECLARE VARIABLE ANOANT SMALLINT;
DECLARE VARIABLE VALORANT NUMERIC(15, 5);
DECLARE VARIABLE ENVIOU CHAR(1);
begin
  /* Retorna os valores de vendas por perodo */
  VALOR = 0;
  VALORANT = 0;
  ENVIOU = 'N';

  FOR select sum(v.vlrliqvenda),v.dtemitvenda from vdvenda v, vdcliente c, eqtipomov tm
             where c.codcli=v.codcli and c.codemp=v.codempcl and c.codfilial=v.codfilialcl
             and v.dtemitvenda between :DATAINI and :DATAFIM and v.codemp = :ICODEMP
             and v.codfilial = :ICODFILIAL
             and tm.codemp=v.codemptm and tm.codfilial=v.codfilialtm and tm.codtipomov=v.codtipomov
             and ( (c.codtipocli=:ICODTIPOCLI) or (:ICODTIPOCLI is null) )
             and ( (v.codcli=:ICODCLI) or (:ICODCLI is null) )
             and ( (tm.tipomov in(select tm2.tipomov from eqtipomov tm2 where tm2.codemp=v.codemptm and tm2.codfilial=v.codfilialtm and tm2.somavdtipomov='S')) or (:FILTRAVENDAS='N') )
             group by v.dtemitvenda order by v.dtemitvenda
      into VALORTMP,DATATMP do
      BEGIN
        MESTMP = extract(MONTH from DATATMP);
        ANOTMP = extract(YEAR from DATATMP);
        VALOR=VALOR+VALORANT;
        MES=MESANT;
        ANO=ANOANT;
        if ((not MESANT = MESTMP or not ANOANT = ANOTMP) AND not MESANT is null) then
        begin
          suspend;
          ENVIOU = 'S';
          VALOR = 0;
          MESANT=MESTMP;
          ANOANT=ANOTMP;
          VALORANT=VALORTMP;
        end
        ELSE
        BEGIN
          MESANT=MESTMP;
          ANOANT=ANOTMP;
          VALORANT=VALORTMP;
        END
      END

     VALOR=VALOR+VALORANT;
     MES=MESANT;
     ANO=ANOANT;
     suspend;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "VDCLCOMIS"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" INTEGER NOT NULL,
"CODCLCOMIS" INTEGER NOT NULL,
"DESCCLCOMIS" CHAR(50) CHARACTER SET NONE NOT NULL,
"PERCFATCLCOMIS" NUMERIC(9,2),
"PERCPGTOCLCOMIS" NUMERIC(9,2));
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "VDGERACOMISSAOSP"("ICODEMP" INTEGER,
"SCODFILIAL" SMALLINT,
"ICODREC" INTEGER,
"INPARCITREC" INTEGER,
"NVLRCOMIITREC" NUMERIC(15,5),
"DDTVENCITREC" DATE)
 AS
DECLARE VARIABLE ICODEMPVA INTEGER;
DECLARE VARIABLE SCODFILIALVA SMALLINT;
DECLARE VARIABLE CTIPOVENDA CHAR(3);
DECLARE VARIABLE ICODVENDA INTEGER;
DECLARE VARIABLE ICODEMPCM INTEGER;
DECLARE VARIABLE SCODFILIALCM SMALLINT;
DECLARE VARIABLE ICODCLCOMIS INTEGER;
DECLARE VARIABLE NVLRVENDACOMI NUMERIC(15, 5);
DECLARE VARIABLE DDATACOMI DATE;
DECLARE VARIABLE NPERCFATCLCOMIS NUMERIC(9,2);
DECLARE VARIABLE NPERCPGTOCLCOMIS NUMERIC(9,2);
DECLARE VARIABLE CTIPOCOMI CHAR(1);
DECLARE VARIABLE NVLRCOMI NUMERIC(15, 5);
DECLARE VARIABLE I INTEGER;
begin
  /* Gera as comisses a pagar na tabela VDCOMISSAO */
  SELECT R.CODEMPVA,R.CODFILIALVA,R.TIPOVENDA,R.CODVENDA,
         V.CODEMPCM, V.CODFILIALCM, V.CODCLCOMIS, ( V.VLRPRODVENDA - V.VLRDESCVENDA ),
         V.DTEMITVENDA, CM.PERCFATCLCOMIS, CM.PERCPGTOCLCOMIS
        FROM FNRECEBER R, VDVENDA V, VDCLCOMIS CM
        WHERE R.CODEMP=:iCodEmp AND R.CODFILIAL=:sCodFilial AND R.CODREC=:iCodRec AND
         V.CODEMP=R.CODEMPVA AND V.CODFILIAL=R.CODFILIALVA AND V.TIPOVENDA=R.TIPOVENDA AND
         V.CODVENDA=R.CODVENDA AND CM.CODEMP=V.CODEMPCM AND CM.CODFILIAL=V.CODFILIALCM AND
         CM.CODCLCOMIS=V.CODCLCOMIS
        INTO :ICODEMPVA, :SCODFILIALVA, :CTIPOVENDA, :ICODVENDA,
         :ICODEMPCM, :SCODFILIALCM, :ICODCLCOMIS, :NVLRVENDACOMI,
         :DDATACOMI, :NPERCFATCLCOMIS, :NPERCPGTOCLCOMIS ;
   I = 1;
   WHILE (:I<=2) DO
   BEGIN
       if (I=1) then
       begin
          CTIPOCOMI='F';
          NVLRCOMI = cast( (nVlrComiItRec * nPercFatClComis / 100 ) as NUMERIC(15, 5));
       end
       else
       begin
          CTIPOCOMI='R';
          NVLRCOMI = cast( (nVlrComiItRec * nPercPgtoClComis / 100 ) as NUMERIC(15, 5));
       end
       EXECUTE PROCEDURE vdadiccomissaosp(:iCodEmp, :sCodFilial, :iCodRec, :iNParcItRec,
         :nVlrVendaComi, :nVlrComi, :dDataComi, :dDtVencItRec, cTipoComi );
       I=I+1;
   END
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "VDGERAESTORNOCOMISP" AS
begin
  /* Procedure Text */

  suspend;
end
^

SET TERM ; ^
COMMIT WORK;
CREATE TABLE "VDVENDAORC"("CODEMP" INTEGER NOT NULL,
"CODFILIAL" INTEGER NOT NULL,
"TIPOVENDA" CHAR(1) CHARACTER SET NONE NOT NULL,
"CODVENDA" INTEGER NOT NULL,
"CODITVENDA" INTEGER NOT NULL,
"CODEMPOR" INTEGER NOT NULL,
"CODFILIALOR" INTEGER NOT NULL,
"TIPOORC" CHAR(1) CHARACTER SET NONE NOT NULL,
"CODORC" INTEGER NOT NULL,
"CODITORC" INTEGER NOT NULL);
COMMIT WORK;
SET TERM ^ ;
ALTER PROCEDURE "VDUPVENDAORCSP"("ICODEMP" INTEGER,
"ICODFILIAL" INTEGER,
"ICODORC" INTEGER,
"ICODITORC" INTEGER,
"ICODFILIALVD" INTEGER,
"ICODVENDA" INTEGER,
"ICODITVENDA" INTEGER,
"STIPOVENDA" CHAR(10) CHARACTER SET NONE)
 AS
DECLARE VARIABLE ICONTA1 INTEGER;
DECLARE VARIABLE ICONTA2 INTEGER;
begin
  /* Procedure Text */
  
  UPDATE VDITORCAMENTO SET EMITITORC='S' WHERE CODITORC=:ICODITORC AND CODORC=:ICODORC
    AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL;
    
  SELECT COUNT(*) FROM VDITORCAMENTO WHERE CODORC=:ICODORC
    AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL AND EMITITORC='S' INTO ICONTA1;
  SELECT COUNT(*) FROM VDITORCAMENTO WHERE CODORC=:ICODORC
    AND CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL INTO ICONTA2;

  IF (ICONTA1 = ICONTA2) THEN
  BEGIN
    UPDATE VDORCAMENTO SET STATUSORC='OV' WHERE
      CODEMP=:ICODEMP AND CODFILIAL=:ICODFILIAL AND
      CODORC=:ICODORC;
  END

  INSERT INTO VDVENDAORC (CODEMP,CODFILIAL,TIPOVENDA,CODVENDA,CODITVENDA,
                          CODEMPOR,CODFILIALOR,TIPOORC,CODORC,CODITORC) VALUES
                         (:ICODEMP,:ICODFILIALVD,:STIPOVENDA,:ICODVENDA,:ICODITVENDA,
                          :ICODEMP,:ICODFILIAL,'O',:ICODORC,:ICODITORC);
  suspend;
end
^

SET TERM ; ^
COMMIT WORK;

/* (c) 1998-2002 by Boris Loboda, barry@audit.kharkov.com */